

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>imaplib &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>imaplib</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for imaplib</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;IMAP4 client.</span>

<span class="sd">Based on RFC 2060.</span>

<span class="sd">Public class:           IMAP4</span>
<span class="sd">Public variable:        Debug</span>
<span class="sd">Public functions:       Internaldate2tuple</span>
<span class="sd">                        Int2AP</span>
<span class="sd">                        ParseFlags</span>
<span class="sd">                        Time2Internaldate</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Author: Piers Lauder &lt;piers@cs.su.oz.au&gt; December 1997.</span>
<span class="c">#</span>
<span class="c"># Authentication code contributed by Donn Cave &lt;donn@u.washington.edu&gt; June 1998.</span>
<span class="c"># String method conversion by ESR, February 2001.</span>
<span class="c"># GET/SETACL contributed by Anthony Baxter &lt;anthony@interlink.com.au&gt; April 2001.</span>
<span class="c"># IMAP4_SSL contributed by Tino Lange &lt;Tino.Lange@isg.de&gt; March 2002.</span>
<span class="c"># GET/SETQUOTA contributed by Andreas Zeidler &lt;az@kreativkombinat.de&gt; June 2002.</span>
<span class="c"># PROXYAUTH contributed by Rick Holbert &lt;holbert.13@osu.edu&gt; November 2002.</span>
<span class="c"># GET/SETANNOTATION contributed by Tomas Lindroos &lt;skitta@abo.fi&gt; June 2005.</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;2.58&quot;</span>

<span class="kn">import</span> <span class="nn">binascii</span><span class="o">,</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">DEFAULT_BUFFER_SIZE</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ssl</span>
    <span class="n">HAVE_SSL</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAVE_SSL</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;IMAP4&quot;</span><span class="p">,</span> <span class="s">&quot;IMAP4_stream&quot;</span><span class="p">,</span> <span class="s">&quot;Internaldate2tuple&quot;</span><span class="p">,</span>
           <span class="s">&quot;Int2AP&quot;</span><span class="p">,</span> <span class="s">&quot;ParseFlags&quot;</span><span class="p">,</span> <span class="s">&quot;Time2Internaldate&quot;</span><span class="p">]</span>

<span class="c">#       Globals</span>

<span class="n">CRLF</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
<span class="n">Debug</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">IMAP4_PORT</span> <span class="o">=</span> <span class="mi">143</span>
<span class="n">IMAP4_SSL_PORT</span> <span class="o">=</span> <span class="mi">993</span>
<span class="n">AllowedVersions</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;IMAP4REV1&#39;</span><span class="p">,</span> <span class="s">&#39;IMAP4&#39;</span><span class="p">)</span>        <span class="c"># Most recent first</span>

<span class="c"># Maximal line length when calling readline(). This is to prevent</span>
<span class="c"># reading arbitrary length lines. RFC 3501 and 2060 (IMAP 4rev1)</span>
<span class="c"># don&#39;t specify a line length. RFC 2683 however suggests limiting client</span>
<span class="c"># command lines to 1000 octets and server command lines to 8000 octets.</span>
<span class="c"># We have selected 10000 for some extra margin and since that is supposedly</span>
<span class="c"># also what UW and Panda IMAP does.</span>
<span class="n">_MAXLINE</span> <span class="o">=</span> <span class="mi">10000</span>


<span class="c">#       Commands</span>

<span class="n">Commands</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c"># name            valid states</span>
        <span class="s">&#39;APPEND&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;AUTHENTICATE&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NONAUTH&#39;</span><span class="p">,),</span>
        <span class="s">&#39;CAPABILITY&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="s">&#39;NONAUTH&#39;</span><span class="p">,</span> <span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">,</span> <span class="s">&#39;LOGOUT&#39;</span><span class="p">),</span>
        <span class="s">&#39;CHECK&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;CLOSE&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;COPY&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;CREATE&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;DELETE&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;DELETEACL&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;EXAMINE&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;EXPUNGE&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;FETCH&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;GETACL&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;GETANNOTATION&#39;</span><span class="p">:(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;GETQUOTA&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;GETQUOTAROOT&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;MYRIGHTS&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;LIST&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;LOGIN&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="s">&#39;NONAUTH&#39;</span><span class="p">,),</span>
        <span class="s">&#39;LOGOUT&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;NONAUTH&#39;</span><span class="p">,</span> <span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">,</span> <span class="s">&#39;LOGOUT&#39;</span><span class="p">),</span>
        <span class="s">&#39;LSUB&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;NAMESPACE&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;NOOP&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="s">&#39;NONAUTH&#39;</span><span class="p">,</span> <span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">,</span> <span class="s">&#39;LOGOUT&#39;</span><span class="p">),</span>
        <span class="s">&#39;PARTIAL&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>                                  <span class="c"># NB: obsolete</span>
        <span class="s">&#39;PROXYAUTH&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,),</span>
        <span class="s">&#39;RENAME&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;SEARCH&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;SELECT&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;SETACL&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;SETANNOTATION&#39;</span><span class="p">:(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;SETQUOTA&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;SORT&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;STARTTLS&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="s">&#39;NONAUTH&#39;</span><span class="p">,),</span>
        <span class="s">&#39;STATUS&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;STORE&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;SUBSCRIBE&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="s">&#39;THREAD&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;UID&#39;</span><span class="p">:</span>          <span class="p">(</span><span class="s">&#39;SELECTED&#39;</span><span class="p">,),</span>
        <span class="s">&#39;UNSUBSCRIBE&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s">&#39;AUTH&#39;</span><span class="p">,</span> <span class="s">&#39;SELECTED&#39;</span><span class="p">),</span>
        <span class="p">}</span>

<span class="c">#       Patterns to match server responses</span>

<span class="n">Continuation</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;\+( (?P&lt;data&gt;.*))?&#39;</span><span class="p">)</span>
<span class="n">Flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;.*FLAGS \((?P&lt;flags&gt;[^\)]*)\)&#39;</span><span class="p">)</span>
<span class="n">InternalDate</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;.*INTERNALDATE &quot;&#39;</span>
        <span class="n">br</span><span class="s">&#39;(?P&lt;day&gt;[ 0123][0-9])-(?P&lt;mon&gt;[A-Z][a-z][a-z])-(?P&lt;year&gt;[0-9][0-9][0-9][0-9])&#39;</span>
        <span class="n">br</span><span class="s">&#39; (?P&lt;hour&gt;[0-9][0-9]):(?P&lt;min&gt;[0-9][0-9]):(?P&lt;sec&gt;[0-9][0-9])&#39;</span>
        <span class="n">br</span><span class="s">&#39; (?P&lt;zonen&gt;[-+])(?P&lt;zoneh&gt;[0-9][0-9])(?P&lt;zonem&gt;[0-9][0-9])&#39;</span>
        <span class="n">br</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
<span class="n">Literal</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;.*{(?P&lt;size&gt;\d+)}$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">ASCII</span><span class="p">)</span>
<span class="n">MapCRLF</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">|</span><span class="se">\r</span><span class="s">|</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">Response_code</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;\[(?P&lt;type&gt;[A-Z-]+)( (?P&lt;data&gt;[^\]]*))?\]&#39;</span><span class="p">)</span>
<span class="n">Untagged_response</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;\* (?P&lt;type&gt;[A-Z-]+)( (?P&lt;data&gt;.*))?&#39;</span><span class="p">)</span>
<span class="n">Untagged_status</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">br</span><span class="s">&#39;\* (?P&lt;data&gt;\d+) (?P&lt;type&gt;[A-Z-]+)( (?P&lt;data2&gt;.*))?&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">ASCII</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">IMAP4</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;IMAP4 client class.</span>

<span class="sd">    Instantiate with: IMAP4([host[, port]])</span>

<span class="sd">            host - host&#39;s name (default: localhost);</span>
<span class="sd">            port - port number (default: standard IMAP4 port).</span>

<span class="sd">    All IMAP4rev1 commands are supported by methods of the same</span>
<span class="sd">    name (in lower-case).</span>

<span class="sd">    All arguments to commands are converted to strings, except for</span>
<span class="sd">    AUTHENTICATE, and the last argument to APPEND which is passed as</span>
<span class="sd">    an IMAP4 literal.  If necessary (the string contains any</span>
<span class="sd">    non-printing characters or white-space and isn&#39;t enclosed with</span>
<span class="sd">    either parentheses or double quotes) each string is quoted.</span>
<span class="sd">    However, the &#39;password&#39; argument to the LOGIN command is always</span>
<span class="sd">    quoted.  If you want to avoid having an argument string quoted</span>
<span class="sd">    (eg: the &#39;flags&#39; argument to STORE) then enclose the string in</span>
<span class="sd">    parentheses (eg: &quot;(\Deleted)&quot;).</span>

<span class="sd">    Each command returns a tuple: (type, [data, ...]) where &#39;type&#39;</span>
<span class="sd">    is usually &#39;OK&#39; or &#39;NO&#39;, and &#39;data&#39; is either the text from the</span>
<span class="sd">    tagged response, or untagged results from command. Each &#39;data&#39;</span>
<span class="sd">    is either a string, or a tuple. If a tuple, then the first part</span>
<span class="sd">    is the header of the response, and the second part contains</span>
<span class="sd">    the data (ie: &#39;literal&#39; value).</span>

<span class="sd">    Errors raise the exception class &lt;instance&gt;.error(&quot;&lt;reason&gt;&quot;).</span>
<span class="sd">    IMAP4 server errors raise &lt;instance&gt;.abort(&quot;&lt;reason&gt;&quot;),</span>
<span class="sd">    which is a sub-class of &#39;error&#39;. Mailbox status changes</span>
<span class="sd">    from READ-WRITE to READ-ONLY raise the exception class</span>
<span class="sd">    &lt;instance&gt;.readonly(&quot;&lt;reason&gt;&quot;), which is a sub-class of &#39;abort&#39;.</span>

<span class="sd">    &quot;error&quot; exceptions imply a program error.</span>
<span class="sd">    &quot;abort&quot; exceptions imply the connection should be reset, and</span>
<span class="sd">            the command re-tried.</span>
<span class="sd">    &quot;readonly&quot; exceptions imply the command should be re-tried.</span>

<span class="sd">    Note: to use this module, you must read the RFCs pertaining to the</span>
<span class="sd">    IMAP4 protocol, as the semantics of the arguments to each IMAP4</span>
<span class="sd">    command are left to the invoker, not to mention the results. Also,</span>
<span class="sd">    most IMAP servers implement a sub-set of the commands available here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>    <span class="c"># Logical errors - debug required</span>
    <span class="k">class</span> <span class="nc">abort</span><span class="p">(</span><span class="n">error</span><span class="p">):</span> <span class="k">pass</span>        <span class="c"># Service errors - close and retry</span>
    <span class="k">class</span> <span class="nc">readonly</span><span class="p">(</span><span class="n">abort</span><span class="p">):</span> <span class="k">pass</span>     <span class="c"># Mailbox status changed to READ-ONLY</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">IMAP4_PORT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">Debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;LOGOUT&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal</span> <span class="o">=</span> <span class="bp">None</span>             <span class="c"># A literal argument to a command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c"># Tagged commands awaiting response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c"># {typ: [data, ...], ...}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continuation_response</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># Last continuation response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_readonly</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c"># READ-ONLY desired state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagnum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tls_established</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Open socket to server.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">raise</span>


    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Create unique tag for this session,</span>
        <span class="c"># and compile tagged response matcher.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tagpre</span> <span class="o">=</span> <span class="n">Int2AP</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">65535</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">br</span><span class="s">&#39;(?P&lt;tag&gt;&#39;</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagpre</span>
                        <span class="o">+</span> <span class="n">br</span><span class="s">&#39;\d+) (?P&lt;type&gt;[A-Z]+) (?P&lt;data&gt;.*)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">ASCII</span><span class="p">)</span>

        <span class="c"># Get server welcome message,</span>
        <span class="c"># request and store CAPABILITY response.</span>

        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_len</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log</span> <span class="o">=</span> <span class="p">{}</span>           <span class="c"># Last `_cmd_log_len&#39; interactions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;imaplib version </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;new IMAP4 connection, tag=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagpre</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">welcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;PREAUTH&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;AUTH&#39;</span>
        <span class="k">elif</span> <span class="s">&#39;OK&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;NONAUTH&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">welcome</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_capabilities</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;CAPABILITIES: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">AllowedVersions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PROTOCOL_VERSION</span> <span class="o">=</span> <span class="n">version</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;server not IMAP4 compliant&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="c">#       Allow UPPERCASE variants of IMAP4 command methods.</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">Commands</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;Unknown IMAP4 command: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>



    <span class="c">#       Overridable methods</span>


    <span class="k">def</span> <span class="nf">_create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">IMAP4_PORT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup connection to remote server on &quot;host:port&quot;</span>
<span class="sd">            (default: localhost:standard IMAP4 port).</span>
<span class="sd">        This connection will be used by the routines:</span>
<span class="sd">            read, readline, send, shutdown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read &#39;size&#39; bytes from remote.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read line from remote.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">_MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAXLINE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;got more than </span><span class="si">%d</span><span class="s"> bytes&quot;</span> <span class="o">%</span> <span class="n">_MAXLINE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span>


    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send data to remote.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close I/O established in &quot;open&quot;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># The server might already have closed the connection</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTCONN</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">socket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return socket instance used to connect to IMAP4 server.</span>

<span class="sd">        socket = &lt;instance&gt;.socket()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span>



    <span class="c">#       Utility methods</span>


    <span class="k">def</span> <span class="nf">recent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return most recent &#39;RECENT&#39; responses if any exist,</span>
<span class="sd">        else prompt server for an update using the &#39;NOOP&#39; command.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.recent()</span>

<span class="sd">        &#39;data&#39; is None if no new messages,</span>
<span class="sd">        else list of RECENT responses, most recent last.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;RECENT&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">()</span>  <span class="c"># Prod server for response</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return data for response &#39;code&#39; if received, or None.</span>

<span class="sd">        Old value for response &#39;code&#39; is cleared.</span>

<span class="sd">        (code, [data]) = &lt;instance&gt;.response(code)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>



    <span class="c">#       IMAP4 commands</span>


    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">date_time</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append message to named mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.append(mailbox, flags, date_time, message)</span>

<span class="sd">                All args except `message&#39; can be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;APPEND&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mailbox</span><span class="p">:</span>
            <span class="n">mailbox</span> <span class="o">=</span> <span class="s">&#39;INBOX&#39;</span>
        <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">flags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">):</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">flags</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">date_time</span><span class="p">:</span>
            <span class="n">date_time</span> <span class="o">=</span> <span class="n">Time2Internaldate</span><span class="p">(</span><span class="n">date_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal</span> <span class="o">=</span> <span class="n">MapCRLF</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">CRLF</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">date_time</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mechanism</span><span class="p">,</span> <span class="n">authobject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Authenticate command - requires response processing.</span>

<span class="sd">        &#39;mechanism&#39; specifies which authentication mechanism is to</span>
<span class="sd">        be used - it must appear in &lt;instance&gt;.capabilities in the</span>
<span class="sd">        form AUTH=&lt;mechanism&gt;.</span>

<span class="sd">        &#39;authobject&#39; must be a callable object:</span>

<span class="sd">                data = authobject(response)</span>

<span class="sd">        It will be called to process server continuation responses; the</span>
<span class="sd">        response argument it is passed will be a bytes.  It should return bytes</span>
<span class="sd">        data that will be base64 encoded and sent to the server.  It should</span>
<span class="sd">        return None if the client abort response &#39;*&#39; should be sent instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mech</span> <span class="o">=</span> <span class="n">mechanism</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c"># XXX: shouldn&#39;t this code be removed, not commented out?</span>
        <span class="c">#cap = &#39;AUTH=%s&#39; % mech</span>
        <span class="c">#if not cap in self.capabilities:       # Let the server decide!</span>
        <span class="c">#    raise self.error(&quot;Server doesn&#39;t allow %s authentication.&quot; % mech)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal</span> <span class="o">=</span> <span class="n">_Authenticator</span><span class="p">(</span><span class="n">authobject</span><span class="p">)</span><span class="o">.</span><span class="n">process</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;AUTHENTICATE&#39;</span><span class="p">,</span> <span class="n">mech</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;AUTH&#39;</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>


    <span class="k">def</span> <span class="nf">capability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(typ, [data]) = &lt;instance&gt;.capability()</span>
<span class="sd">        Fetch capabilities list from server.&quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;CAPABILITY&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checkpoint mailbox on server.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.check()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;CHECK&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close currently selected mailbox.</span>

<span class="sd">        Deleted messages are removed from writable mailbox.</span>
<span class="sd">        This is the recommended command before &#39;LOGOUT&#39;.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;CLOSE&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;AUTH&#39;</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>


    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_set</span><span class="p">,</span> <span class="n">new_mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy &#39;message_set&#39; messages onto end of &#39;new_mailbox&#39;.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.copy(message_set, new_mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;COPY&#39;</span><span class="p">,</span> <span class="n">message_set</span><span class="p">,</span> <span class="n">new_mailbox</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.create(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;CREATE&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete old mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.delete(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deleteacl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the ACLs (remove any rights) set for who on mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.deleteacl(mailbox, who)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;DELETEACL&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expunge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Permanently remove deleted items from selected mailbox.</span>

<span class="sd">        Generates &#39;EXPUNGE&#39; response for each deleted message.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.expunge()</span>

<span class="sd">        &#39;data&#39; is list of &#39;EXPUNGE&#39;d message numbers in order received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;EXPUNGE&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_set</span><span class="p">,</span> <span class="n">message_parts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch (parts of) messages.</span>

<span class="sd">        (typ, [data, ...]) = &lt;instance&gt;.fetch(message_set, message_parts)</span>

<span class="sd">        &#39;message_parts&#39; should be a string of selected parts</span>
<span class="sd">        enclosed in parentheses, eg: &quot;(UID BODY[TEXT])&quot;.</span>

<span class="sd">        &#39;data&#39; are tuples of message part envelope and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;FETCH&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">message_set</span><span class="p">,</span> <span class="n">message_parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getacl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the ACLs for a mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.getacl(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;GETACL&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;ACL&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getannotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(typ, [data]) = &lt;instance&gt;.getannotation(mailbox, entry, attribute)</span>
<span class="sd">        Retrieve ANNOTATIONs.&quot;&quot;&quot;</span>

        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;GETANNOTATION&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;ANNOTATION&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getquota</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the quota root&#39;s resource usage and limits.</span>

<span class="sd">        Part of the IMAP4 QUOTA extension defined in rfc2087.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.getquota(root)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;GETQUOTA&#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;QUOTA&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getquotaroot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of quota roots for the named mailbox.</span>

<span class="sd">        (typ, [[QUOTAROOT responses...], [QUOTA responses]]) = &lt;instance&gt;.getquotaroot(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;GETQUOTAROOT&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">quota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;QUOTA&#39;</span><span class="p">)</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">quotaroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;QUOTAROOT&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="p">[</span><span class="n">quotaroot</span><span class="p">,</span> <span class="n">quota</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List mailbox names in directory matching pattern.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.list(directory=&#39;&quot;&quot;&#39;, pattern=&#39;*&#39;)</span>

<span class="sd">        &#39;data&#39; is list of LIST responses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;LIST&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify client using plaintext password.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.login(user, password)</span>

<span class="sd">        NB: &#39;password&#39; will be quoted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;LOGIN&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quote</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;AUTH&#39;</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>


    <span class="k">def</span> <span class="nf">login_cram_md5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Force use of CRAM-MD5 authentication.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.login_cram_md5(user, password)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s">&#39;CRAM-MD5&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CRAM_MD5_AUTH</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_CRAM_MD5_AUTH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">challenge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Authobject to use with CRAM-MD5 authentication. &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">hmac</span>
        <span class="n">pwd</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ASCII&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                                             <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span> <span class="s">&#39;md5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shutdown connection to server.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.logout()</span>

<span class="sd">        Returns server &#39;BYE&#39; response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;LOGOUT&#39;</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;LOGOUT&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="s">&#39;NO&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;BYE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;BYE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">[</span><span class="s">&#39;BYE&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>


    <span class="k">def</span> <span class="nf">lsub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List &#39;subscribed&#39; mailbox names in directory matching pattern.</span>

<span class="sd">        (typ, [data, ...]) = &lt;instance&gt;.lsub(directory=&#39;&quot;&quot;&#39;, pattern=&#39;*&#39;)</span>

<span class="sd">        &#39;data&#39; are tuples of message part envelope and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;LSUB&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">myrights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show my ACLs for a mailbox (i.e. the rights that I have on mailbox).</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.myrights(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span><span class="p">,</span><span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;MYRIGHTS&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;MYRIGHTS&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns IMAP namespaces ala rfc2342</span>

<span class="sd">        (typ, [data, ...]) = &lt;instance&gt;.namespace()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;NAMESPACE&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send NOOP command.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.noop()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dump_ur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;NOOP&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_num</span><span class="p">,</span> <span class="n">message_part</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch truncated part of a message.</span>

<span class="sd">        (typ, [data, ...]) = &lt;instance&gt;.partial(message_num, message_part, start, length)</span>

<span class="sd">        &#39;data&#39; is tuple of message part envelope and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;PARTIAL&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">message_num</span><span class="p">,</span> <span class="n">message_part</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;FETCH&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">proxyauth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assume authentication as &quot;user&quot;.</span>

<span class="sd">        Allows an authorised administrator to proxy into any user&#39;s</span>
<span class="sd">        mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.proxyauth(user)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;PROXYAUTH&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;PROXYAUTH&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldmailbox</span><span class="p">,</span> <span class="n">newmailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename old mailbox name to new.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.rename(oldmailbox, newmailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;RENAME&#39;</span><span class="p">,</span> <span class="n">oldmailbox</span><span class="p">,</span> <span class="n">newmailbox</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search mailbox for matching messages.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.search(charset, criterion, ...)</span>

<span class="sd">        &#39;data&#39; is space separated list of matching message numbers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;SEARCH&#39;</span>
        <span class="k">if</span> <span class="n">charset</span><span class="p">:</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;CHARSET&#39;</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="o">=</span><span class="s">&#39;INBOX&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select a mailbox.</span>

<span class="sd">        Flush all untagged responses.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.select(mailbox=&#39;INBOX&#39;, readonly=False)</span>

<span class="sd">        &#39;data&#39; is count of messages in mailbox (&#39;EXISTS&#39; response).</span>

<span class="sd">        Mandated responses are (&#39;FLAGS&#39;, &#39;EXISTS&#39;, &#39;RECENT&#39;, &#39;UIDVALIDITY&#39;), so</span>
<span class="sd">        other responses should be obtained via &lt;instance&gt;.response(&#39;FLAGS&#39;) etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c"># Flush old responses.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_readonly</span> <span class="o">=</span> <span class="n">readonly</span>
        <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;EXAMINE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;SELECT&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;AUTH&#39;</span>     <span class="c"># Might have been &#39;SELECTED&#39;</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">&#39;SELECTED&#39;</span>
        <span class="k">if</span> <span class="s">&#39;READ-ONLY&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_ur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">)</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is not writable&#39;</span> <span class="o">%</span> <span class="n">mailbox</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;EXISTS&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">setacl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">who</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a mailbox acl.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.setacl(mailbox, who, what)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;SETACL&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">who</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">setannotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(typ, [data]) = &lt;instance&gt;.setannotation(mailbox[, entry, attribute]+)</span>
<span class="sd">        Set ANNOTATIONs.&quot;&quot;&quot;</span>

        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;SETANNOTATION&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;ANNOTATION&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">setquota</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the quota root&#39;s resource limits.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.setquota(root, limits)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;SETQUOTA&#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;QUOTA&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_criteria</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">search_criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;IMAP4rev1 extension SORT command.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.sort(sort_criteria, charset, search_criteria, ...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;SORT&#39;</span>
        <span class="c">#if not name in self.capabilities:      # Let the server decide!</span>
        <span class="c">#       raise self.error(&#39;unimplemented extension command: %s&#39; % name)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sort_criteria</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sort_criteria</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">):</span>
            <span class="n">sort_criteria</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sort_criteria</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sort_criteria</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">search_criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">starttls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;STARTTLS&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SSL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;SSL support missing&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tls_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;TLS session already established&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;TLS not supported by server&#39;</span><span class="p">)</span>
        <span class="c"># Generate a default SSL context if none was passed.</span>
        <span class="k">if</span> <span class="n">ssl_context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">()</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
            <span class="n">server_hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">ssl_context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span>
                                                <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tls_established</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_capabilities</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t establish TLS session&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Request named status conditions for mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.status(mailbox, names)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;STATUS&#39;</span>
        <span class="c">#if self.PROTOCOL_VERSION == &#39;IMAP4&#39;:   # Let the server decide!</span>
        <span class="c">#    raise self.error(&#39;%s unimplemented in IMAP4 (obtain IMAP4rev1 server, or re-code)&#39; % name)</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_set</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alters flag dispositions for messages in mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.store(message_set, command, flags)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">flags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">flags</span>  <span class="c"># Avoid quoting the flags</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;STORE&#39;</span><span class="p">,</span> <span class="n">message_set</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="s">&#39;FETCH&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subscribe to new mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.subscribe(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;SUBSCRIBE&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threading_algorithm</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">search_criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;IMAPrev1 extension THREAD command.</span>

<span class="sd">        (type, [data]) = &lt;instance&gt;.thread(threading_algorithm, charset, search_criteria, ...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;THREAD&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">threading_algorithm</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">search_criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute &quot;command arg ...&quot; with messages identified by UID,</span>
<span class="sd">                rather than message number.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.uid(command, arg1, arg2, ...)</span>

<span class="sd">        Returns response appropriate to &#39;command&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">Commands</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unknown IMAP4 UID command: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Commands</span><span class="p">[</span><span class="n">command</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;command </span><span class="si">%s</span><span class="s"> illegal in state </span><span class="si">%s</span><span class="s">, &quot;</span>
                             <span class="s">&quot;only allowed in states </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                              <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Commands</span><span class="p">[</span><span class="n">command</span><span class="p">])))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;UID&#39;</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;SEARCH&#39;</span><span class="p">,</span> <span class="s">&#39;SORT&#39;</span><span class="p">,</span> <span class="s">&#39;THREAD&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;FETCH&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_untagged_response</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unsubscribe from old mailbox.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.unsubscribe(mailbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="s">&#39;UNSUBSCRIBE&#39;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">xatom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow simple extension commands</span>
<span class="sd">                notified by server in CAPABILITY response.</span>

<span class="sd">        Assumes command is legal in current state.</span>

<span class="sd">        (typ, [data]) = &lt;instance&gt;.xatom(name, arg, ...)</span>

<span class="sd">        Returns response appropriate to extension command `name&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c">#if not name in self.capabilities:      # Let the server decide!</span>
        <span class="c">#    raise self.error(&#39;unknown extension command: %s&#39; % name)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Commands</span><span class="p">:</span>
            <span class="n">Commands</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>



    <span class="c">#       Private methods</span>


    <span class="k">def</span> <span class="nf">_append_untagged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="n">ur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;untagged_responses[</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s"> += [&quot;</span><span class="si">%r</span><span class="s">&quot;]&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)),</span> <span class="n">dat</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">ur</span><span class="p">:</span>
            <span class="n">ur</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ur</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dat</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_check_bye</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bye</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;BYE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bye</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">bye</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Commands</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">literal</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;command </span><span class="si">%s</span><span class="s"> illegal in state </span><span class="si">%s</span><span class="s">, &quot;</span>
                             <span class="s">&quot;only allowed in states </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                              <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Commands</span><span class="p">[</span><span class="n">name</span><span class="p">])))</span>

        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;NO&#39;</span><span class="p">,</span> <span class="s">&#39;BAD&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>

        <span class="k">if</span> <span class="s">&#39;READ-ONLY&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span> \
        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">(</span><span class="s">&#39;mailbox status changed to READ-ONLY&#39;</span><span class="p">)</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_tag</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;ASCII&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;ASCII&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">arg</span>

        <span class="n">literal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">literal</span>
        <span class="k">if</span> <span class="n">literal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">literal</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">):</span>
                <span class="n">literator</span> <span class="o">=</span> <span class="n">literal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">literator</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="s">&#39; {</span><span class="si">%s</span><span class="s">}&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">literal</span><span class="p">),</span> <span class="s">&#39;ASCII&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&#39;&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;socket error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">literal</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tag</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># Wait for continuation response</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span><span class="p">[</span><span class="n">tag</span><span class="p">]:</span>   <span class="c"># BAD/NO?</span>
                    <span class="k">return</span> <span class="n">tag</span>

            <span class="c"># Send literal</span>

            <span class="k">if</span> <span class="n">literator</span><span class="p">:</span>
                <span class="n">literal</span> <span class="o">=</span> <span class="n">literator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continuation_response</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;write literal size </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">literal</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;socket error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">literator</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">tag</span>


    <span class="k">def</span> <span class="nf">_command_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="c"># BYE is expected after LOGOUT</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;LOGOUT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_bye</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tagged_response</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;command: </span><span class="si">%s</span><span class="s"> =&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;command: </span><span class="si">%s</span><span class="s"> =&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;LOGOUT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_bye</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;BAD&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> command error: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">data</span>


    <span class="k">def</span> <span class="nf">_get_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capability</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;no CAPABILITY response from server&#39;</span><span class="p">)</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;ASCII&quot;</span><span class="p">)</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Read response and store.</span>
        <span class="c">#</span>
        <span class="c"># Returns None for continuation responses,</span>
        <span class="c"># otherwise first response line received.</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line</span><span class="p">()</span>

        <span class="c"># Command completion response?</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagre</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;unexpected tagged response: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">resp</span><span class="p">)</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s">&#39;ASCII&#39;</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="p">[</span><span class="n">dat</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat2</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># &#39;*&#39; (untagged) responses?</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">Untagged_response</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">Untagged_status</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
                    <span class="n">dat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;data2&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Only other possibility is &#39;+&#39; (continuation) response...</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">Continuation</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">continuation_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>     <span class="c"># NB: indicates continuation</span>

                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&quot;unexpected response: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">resp</span><span class="p">)</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>        <span class="c"># Null untagged response</span>
            <span class="k">if</span> <span class="n">dat2</span><span class="p">:</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">dat2</span>

            <span class="c"># Is there a literal to come?</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">Literal</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>

                <span class="c"># Read literal direct from connection.</span>

                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;size&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;read literal size </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

                <span class="c"># Store response with literal as tuple</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_append_untagged</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="c"># Read trailer - possibly containing another literal</span>

                <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_append_untagged</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">)</span>

        <span class="c"># Bracketed response information?</span>

        <span class="k">if</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;NO&#39;</span><span class="p">,</span> <span class="s">&#39;BAD&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">Response_code</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s">&quot;ASCII&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_untagged</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;NO&#39;</span><span class="p">,</span> <span class="s">&#39;BAD&#39;</span><span class="p">,</span> <span class="s">&#39;BYE&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> response: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">resp</span>


    <span class="k">def</span> <span class="nf">_get_tagged_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c"># If we&#39;ve seen a BYE at this point, the socket will be</span>
            <span class="c"># closed, so report the BYE now.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_bye</span><span class="p">()</span>

            <span class="c"># Some have reported &quot;unexpected response&quot; exceptions.</span>
            <span class="c"># Note that ignoring them here causes loops.</span>
            <span class="c"># Instead, send me details of the unexpected response and</span>
            <span class="c"># I&#39;ll update the code in `_get_response()&#39;.</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">()</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_log</span><span class="p">()</span>
                <span class="k">raise</span>


    <span class="k">def</span> <span class="nf">_get_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;socket error: EOF&#39;</span><span class="p">)</span>

        <span class="c"># Protocol mandates all lines terminated by CRLF</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="s">&#39;socket error: unterminated line: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;&lt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&#39;&lt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span>


    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cre</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="c"># Run compiled regular expression match method on &#39;s&#39;.</span>
        <span class="c"># Save result, return success.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="n">cre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">matched r&#39;</span><span class="si">%r</span><span class="s">&#39; =&gt; </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cre</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">groups</span><span class="p">()))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">_new_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagpre</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagnum</span><span class="p">),</span> <span class="s">&#39;ASCII&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagnum</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagged_commands</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">tag</span>


    <span class="k">def</span> <span class="nf">_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>

        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&quot;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">arg</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span>


    <span class="k">def</span> <span class="nf">_simple_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_complete</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_untagged_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;NO&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">untagged_responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;untagged_responses[</span><span class="si">%s</span><span class="s">] =&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">typ</span><span class="p">,</span> <span class="n">data</span>


    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_mesg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">secs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">secs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">secs</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;  </span><span class="si">%s</span><span class="s">.</span><span class="si">%02d</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="p">(</span><span class="n">secs</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">%</span><span class="mi">100</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_dump_ur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c"># Dump untagged responses (in `dict&#39;).</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span> <span class="k">return</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n\t\t</span><span class="s">&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&#39;&quot; &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;untagged responses dump:</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="c"># Keep log of last `_cmd_log_len&#39; interactions for debugging.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_len</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">print_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;last </span><span class="si">%d</span><span class="s"> IMAP4 interactions:&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log</span><span class="p">))</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_len</span>
            <span class="k">while</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_log_len</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>


<span class="k">if</span> <span class="n">HAVE_SSL</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">IMAP4_SSL</span><span class="p">(</span><span class="n">IMAP4</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;IMAP4 client class over SSL connection</span>

<span class="sd">        Instantiate with: IMAP4_SSL([host[, port[, keyfile[, certfile[, ssl_context]]]]])</span>

<span class="sd">                host - host&#39;s name (default: localhost);</span>
<span class="sd">                port - port number (default: standard IMAP4 SSL port);</span>
<span class="sd">                keyfile - PEM formatted file that contains your private key (default: None);</span>
<span class="sd">                certfile - PEM formatted certificate chain file (default: None);</span>
<span class="sd">                ssl_context - a SSLContext object that contains your certificate chain</span>
<span class="sd">                              and private key (default: None)</span>
<span class="sd">                Note: if ssl_context is provided, then parameters keyfile or</span>
<span class="sd">                certfile should not be set otherwise ValueError is raised.</span>

<span class="sd">        for more documentation see the docstring of the parent class IMAP4.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">IMAP4_SSL_PORT</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ssl_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">keyfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;ssl_context and keyfile arguments are mutually &quot;</span>
                                 <span class="s">&quot;exclusive&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ssl_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">certfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;ssl_context and certfile arguments are mutually &quot;</span>
                                 <span class="s">&quot;exclusive&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">keyfile</span> <span class="o">=</span> <span class="n">keyfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">certfile</span> <span class="o">=</span> <span class="n">certfile</span>
            <span class="k">if</span> <span class="n">ssl_context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">certfile</span><span class="p">,</span>
                                                         <span class="n">keyfile</span><span class="o">=</span><span class="n">keyfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl_context</span>
            <span class="n">IMAP4</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">IMAP4</span><span class="o">.</span><span class="n">_create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">server_hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
                                                <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">IMAP4_SSL_PORT</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Setup connection to remote server on &quot;host:port&quot;.</span>
<span class="sd">                (default: localhost:standard IMAP4 SSL port).</span>
<span class="sd">            This connection will be used by the routines:</span>
<span class="sd">                read, readline, send, shutdown.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">IMAP4</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;IMAP4_SSL&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IMAP4_stream</span><span class="p">(</span><span class="n">IMAP4</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;IMAP4 client class over a stream</span>

<span class="sd">    Instantiate with: IMAP4_stream(command)</span>

<span class="sd">            where &quot;command&quot; is a string that can be passed to subprocess.Popen()</span>

<span class="sd">    for more documentation see the docstring of the parent class IMAP4.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="n">IMAP4</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup a stream connection.</span>
<span class="sd">        This connection will be used by the routines:</span>
<span class="sd">            read, readline, send, shutdown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">None</span>        <span class="c"># For compatibility with parent class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
            <span class="n">bufsize</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read &#39;size&#39; bytes from remote.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read line from remote.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send data to remote.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writefile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close I/O established in &quot;open&quot;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>



<span class="k">class</span> <span class="nc">_Authenticator</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Private class to provide en/decoding</span>
<span class="sd">            for base64-based authentication conversation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mechinst</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mech</span> <span class="o">=</span> <span class="n">mechinst</span>    <span class="c"># Callable object to provide/process data</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mech</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;*&#39;</span>      <span class="c"># Abort conversation</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="c">#</span>
        <span class="c">#  Invoke binascii.b2a_base64 iteratively with</span>
        <span class="c">#  short even length buffers, strip the trailing</span>
        <span class="c">#  line feed from the result and append.  &quot;Even&quot;</span>
        <span class="c">#  means a number that factors to both 6 and 8,</span>
        <span class="c">#  so when it gets to the end of the 8-bit input</span>
        <span class="c">#  there&#39;s no partial 6-bit output.</span>
        <span class="c">#</span>
        <span class="n">oup</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ASCII&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">inp</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">48</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[:</span><span class="mi">48</span><span class="p">]</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="mi">48</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">inp</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_base64</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">oup</span> <span class="o">=</span> <span class="n">oup</span> <span class="o">+</span> <span class="n">e</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">oup</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_base64</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

<span class="n">Months</span> <span class="o">=</span> <span class="s">&#39; Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
<span class="n">Mon2num</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">():</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Months</span><span class="p">[</span><span class="mi">1</span><span class="p">:])}</span>

<span class="k">def</span> <span class="nf">Internaldate2tuple</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse an IMAP4 INTERNALDATE string.</span>

<span class="sd">    Return corresponding local time.  The return value is a</span>
<span class="sd">    time.struct_time tuple or None if the string has wrong format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mo</span> <span class="o">=</span> <span class="n">InternalDate</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">mon</span> <span class="o">=</span> <span class="n">Mon2num</span><span class="p">[</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;mon&#39;</span><span class="p">)]</span>
    <span class="n">zonen</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;zonen&#39;</span><span class="p">)</span>

    <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;day&#39;</span><span class="p">))</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;year&#39;</span><span class="p">))</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;hour&#39;</span><span class="p">))</span>
    <span class="nb">min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;min&#39;</span><span class="p">))</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;sec&#39;</span><span class="p">))</span>
    <span class="n">zoneh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;zoneh&#39;</span><span class="p">))</span>
    <span class="n">zonem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;zonem&#39;</span><span class="p">))</span>

    <span class="c"># INTERNALDATE timezone must be subtracted to get UT</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="p">(</span><span class="n">zoneh</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">zonem</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">if</span> <span class="n">zonen</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="o">-</span><span class="n">zone</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">utc</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">-</span> <span class="n">zone</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">Int2AP</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Convert integer to A-P string representation.&quot;&quot;&quot;</span>

    <span class="n">val</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">;</span> <span class="n">AP</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;ABCDEFGHIJKLMNOP&#39;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">num</span><span class="p">:</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[</span><span class="n">mod</span><span class="p">:</span><span class="n">mod</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">val</span>



<span class="k">def</span> <span class="nf">ParseFlags</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Convert IMAP4 flags response to python tuple.&quot;&quot;&quot;</span>

    <span class="n">mo</span> <span class="o">=</span> <span class="n">Flags</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mo</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;flags&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">Time2Internaldate</span><span class="p">(</span><span class="n">date_time</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Convert date_time to IMAP4 INTERNALDATE representation.</span>

<span class="sd">    Return string in form: &#39;&quot;DD-Mmm-YYYY HH:MM:SS +HHMM&quot;&#39;.  The</span>
<span class="sd">    date_time argument can be a number (int or float) representing</span>
<span class="sd">    seconds since epoch (as returned by time.time()), a 9-tuple</span>
<span class="sd">    representing local time, an instance of time.struct_time (as</span>
<span class="sd">    returned by time.localtime()), an aware datetime instance or a</span>
<span class="sd">    double-quoted string.  In the last case, it is assumed to already</span>
<span class="sd">    be in the correct format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_time</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">date_time</span><span class="p">,</span>
                                    <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_time</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gmtoff</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">tm_gmtoff</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">daylight</span><span class="p">:</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">date_time</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dst</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date_time</span><span class="p">))[</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">gmtoff</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">timezone</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">altzone</span><span class="p">)[</span><span class="n">dst</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gmtoff</span> <span class="o">=</span> <span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">timezone</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">gmtoff</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">date_time</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_time</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">date_time</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;date_time must be aware&quot;</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">date_time</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_time</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">date_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">date_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">date_time</span>        <span class="c"># Assume in correct format</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;date_time not of a known type&quot;</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%d</span><span class="s">-{}-%Y %H:%M:%S %z&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Months</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c"># To test: invoke either as &#39;python imaplib.py [IMAP4_server_hostname]&#39;</span>
    <span class="c"># or &#39;python imaplib.py -s &quot;rsh IMAP4_server_hostname exec /etc/rimapd&quot;&#39;</span>
    <span class="c"># to test the IMAP4_stream class</span>

    <span class="kn">import</span> <span class="nn">getopt</span><span class="o">,</span> <span class="nn">getpass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">optlist</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&#39;d:s:&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">getopt</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">optlist</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(),</span> <span class="p">()</span>

    <span class="n">stream_command</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">opt</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">optlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-d&#39;</span><span class="p">:</span>
            <span class="n">Debug</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;-s&#39;</span><span class="p">:</span>
            <span class="n">stream_command</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_command</span><span class="p">,)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,)</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">USER</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="n">PASSWD</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s">&quot;IMAP password for </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">USER</span><span class="p">,</span> <span class="n">host</span> <span class="ow">or</span> <span class="s">&quot;localhost&quot;</span><span class="p">))</span>

    <span class="n">test_mesg</span> <span class="o">=</span> <span class="s">&#39;From: </span><span class="si">%(user)s</span><span class="s">@localhost</span><span class="si">%(lf)s</span><span class="s">Subject: IMAP4 test</span><span class="si">%(lf)s%(lf)s</span><span class="s">data...</span><span class="si">%(lf)s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">:</span><span class="n">USER</span><span class="p">,</span> <span class="s">&#39;lf&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">}</span>
    <span class="n">test_seq1</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">USER</span><span class="p">,</span> <span class="n">PASSWD</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp/xxx 1&#39;</span><span class="p">,)),</span>
    <span class="p">(</span><span class="s">&#39;rename&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp/xxx 1&#39;</span><span class="p">,</span> <span class="s">&#39;/tmp/yyy&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;CREATE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp/yyz 2&#39;</span><span class="p">,)),</span>
    <span class="p">(</span><span class="s">&#39;append&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp/yyz 2&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">test_mesg</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp&#39;</span><span class="p">,</span> <span class="s">&#39;yy*&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;select&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp/yyz 2&#39;</span><span class="p">,)),</span>
    <span class="p">(</span><span class="s">&#39;search&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;SUBJECT&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;fetch&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;(FLAGS INTERNALDATE RFC822)&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;FLAGS&#39;</span><span class="p">,</span> <span class="s">&#39;(\Deleted)&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;namespace&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">(</span><span class="s">&#39;expunge&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">(</span><span class="s">&#39;recent&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">(</span><span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">)</span>

    <span class="n">test_seq2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;select&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">(</span><span class="s">&#39;response&#39;</span><span class="p">,(</span><span class="s">&#39;UIDVALIDITY&#39;</span><span class="p">,)),</span>
    <span class="p">(</span><span class="s">&#39;uid&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;SEARCH&#39;</span><span class="p">,</span> <span class="s">&#39;ALL&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;response&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;EXISTS&#39;</span><span class="p">,)),</span>
    <span class="p">(</span><span class="s">&#39;append&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">test_mesg</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;recent&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">(</span><span class="s">&#39;logout&#39;</span><span class="p">,</span> <span class="p">()),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">M</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> =&gt; </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">dat</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;NO&#39;</span><span class="p">:</span> <span class="k">raise</span> <span class="n">dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dat</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stream_command</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">IMAP4_stream</span><span class="p">(</span><span class="n">stream_command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">IMAP4</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;AUTH&#39;</span><span class="p">:</span>
            <span class="n">test_seq1</span> <span class="o">=</span> <span class="n">test_seq1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>   <span class="c"># Login not needed</span>
        <span class="n">M</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;PROTOCOL_VERSION = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">M</span><span class="o">.</span><span class="n">PROTOCOL_VERSION</span><span class="p">)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">_mesg</span><span class="p">(</span><span class="s">&#39;CAPABILITIES = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">capabilities</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span><span class="n">args</span> <span class="ow">in</span> <span class="n">test_seq1</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ml</span> <span class="ow">in</span> <span class="n">run</span><span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;/tmp/&#39;</span><span class="p">,</span> <span class="s">&#39;yy%&#39;</span><span class="p">)):</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;.*&quot;([^&quot;]+)&quot;$&#39;</span><span class="p">,</span> <span class="n">ml</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span><span class="n">args</span> <span class="ow">in</span> <span class="n">test_seq2</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="s">&#39;uid&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;SEARCH&#39;</span><span class="p">,</span> <span class="s">&#39;ALL&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="n">uid</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uid</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&#39;uid&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;FETCH&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">uid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s">&#39;(FLAGS INTERNALDATE RFC822.SIZE RFC822.HEADER RFC822.TEXT)&#39;</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">All tests OK.&#39;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Tests failed.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Debug</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">If you would like to see debugging output,</span>
<span class="s">try: </span><span class="si">%s</span><span class="s"> -d5</span>
<span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">raise</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>