

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mailbox &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>mailbox</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for mailbox</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Read/write support for Maildir, mbox, MH, Babyl, and MMDF mailboxes.&quot;&quot;&quot;</span>

<span class="c"># Notes for authors of new mailbox subclasses:</span>
<span class="c">#</span>
<span class="c"># Remember to fsync() changes to disk before closing a modified file</span>
<span class="c"># or returning from a flush() method.  See functions _sync_flush() and</span>
<span class="c"># _sync_close().</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">email.message</span>
<span class="kn">import</span> <span class="nn">email.generator</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;Mailbox&#39;</span><span class="p">,</span> <span class="s">&#39;Maildir&#39;</span><span class="p">,</span> <span class="s">&#39;mbox&#39;</span><span class="p">,</span> <span class="s">&#39;MH&#39;</span><span class="p">,</span> <span class="s">&#39;Babyl&#39;</span><span class="p">,</span> <span class="s">&#39;MMDF&#39;</span><span class="p">,</span>
            <span class="s">&#39;Message&#39;</span><span class="p">,</span> <span class="s">&#39;MaildirMessage&#39;</span><span class="p">,</span> <span class="s">&#39;mboxMessage&#39;</span><span class="p">,</span> <span class="s">&#39;MHMessage&#39;</span><span class="p">,</span>
            <span class="s">&#39;BabylMessage&#39;</span><span class="p">,</span> <span class="s">&#39;MMDFMessage&#39;</span><span class="p">]</span>

<span class="n">linesep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Mailbox"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox">[docs]</a><span class="k">class</span> <span class="nc">Mailbox</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A group of messages in a particular place.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Mailbox instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span> <span class="o">=</span> <span class="n">factory</span>

<div class="viewcode-block" id="Mailbox.add"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add message and return assigned key.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.remove"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="Mailbox.discard"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the keyed message exists, remove it.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Mailbox.get"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the keyed message, or default if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
</div>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_message</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

<div class="viewcode-block" id="Mailbox.get_message"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.get_message">[docs]</a>    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Message representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.get_string"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.get_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation or raise a KeyError.</span>

<span class="sd">        Uses email.message.Message to create a 7bit clean string</span>
<span class="sd">        representation of the message.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Mailbox.get_bytes"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.get_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a byte string representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.get_file"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a file-like representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.iterkeys"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.iterkeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over keys.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.keys"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of keys.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Mailbox.itervalues"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.itervalues">[docs]</a>    <span class="k">def</span> <span class="nf">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over all messages.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">value</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>

<div class="viewcode-block" id="Mailbox.values"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of messages. Memory intensive.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Mailbox.iteritems"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over (key, message) tuples.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.items"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of (key, message) tuples. Memory intensive.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the keyed message exists, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a count of messages in the mailbox.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Mailbox.clear"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all messages.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.pop"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the keyed message and return it, or default.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Mailbox.popitem"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.popitem">[docs]</a>    <span class="k">def</span> <span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an arbitrary (key, message) pair and return it.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>     <span class="c"># This is only run once.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No messages in mailbox&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.update"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the messages that correspond to certain keys.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;iteritems&#39;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="n">bad_key</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">bad_key</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">bad_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key(s)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.flush"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write any pending changes to the disk.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.lock"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.lock">[docs]</a>    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lock the mailbox.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.unlock"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.unlock">[docs]</a>    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unlock the mailbox if it is locked.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Mailbox.close"><a class="viewcode-back" href="../mailbox.html#mailbox.Mailbox.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush and close the mailbox.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Method must be implemented by subclass&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_string_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="c"># If a message is not 7bit clean, we refuse to handle it since it</span>
        <span class="c"># likely came from reading invalid messages in text mode, and that way</span>
        <span class="c"># lies mojibake.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;String input must be ASCII-only; &quot;</span>
                <span class="s">&quot;use bytes or a Message instead&quot;</span><span class="p">)</span>

    <span class="c"># Whether each message must end in a newline</span>
    <span class="n">_append_newline</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_dump_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mangle_from_</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c"># This assumes the target file is open in binary mode.</span>
        <span class="sd">&quot;&quot;&quot;Dump message contents to target file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="nb">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">BytesGenerator</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">mangle_from_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">)</span>
            <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_newline</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">linesep</span><span class="p">):</span>
                <span class="c"># Make sure the message ends with a newline</span>
                <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Use of StringIO input is deprecated, &quot;</span>
                    <span class="s">&quot;use BytesIO instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_to_bytes</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mangle_from_</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">From &#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&gt;From &#39;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">)</span>
            <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_newline</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">linesep</span><span class="p">):</span>
                <span class="c"># Make sure the message ends with a newline</span>
                <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&#39;buffer&#39;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Use of text mode files is deprecated, &quot;</span>
                    <span class="s">&quot;use a binary mode file instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">buffer</span>
            <span class="n">lastline</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="c"># Universal newline support.</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">mangle_from_</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;From &#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&gt;From &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">)</span>
                <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">lastline</span> <span class="o">=</span> <span class="n">line</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_newline</span> <span class="ow">and</span> <span class="n">lastline</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lastline</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">linesep</span><span class="p">):</span>
                <span class="c"># Make sure the message ends with a newline</span>
                <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Invalid message type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="Maildir"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir">[docs]</a><span class="k">class</span> <span class="nc">Maildir</span><span class="p">(</span><span class="n">Mailbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A qmail-style Maildir mailbox.&quot;&quot;&quot;</span>

    <span class="n">colon</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Maildir instance.&quot;&quot;&quot;</span>
        <span class="n">Mailbox</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tmp&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;tmp&#39;</span><span class="p">),</span>
            <span class="s">&#39;new&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;new&#39;</span><span class="p">),</span>
            <span class="s">&#39;cur&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;cur&#39;</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoSuchMailboxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc_mtimes</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;cur&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;new&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_read</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c"># Records last time we read cur/new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skewfactor</span> <span class="o">=</span> <span class="mf">0.1</span>      <span class="c"># Adjust if os/fs clocks are skewing</span>

<div class="viewcode-block" id="Maildir.add"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add message and return assigned key.&quot;&quot;&quot;</span>
        <span class="n">tmp_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_tmp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">tmp_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">_sync_close</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">subdir</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_subdir</span><span class="p">()</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colon</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">colon</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subdir</span> <span class="o">=</span> <span class="s">&#39;new&#39;</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">uniq</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">uniq</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getatime</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">message</span><span class="o">.</span><span class="n">get_date</span><span class="p">()))</span>
        <span class="c"># No file modification should be done after the file is moved to its</span>
        <span class="c"># final position in order to prevent race conditions with changes</span>
        <span class="c"># from other programs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;link&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExternalClashError</span><span class="p">(</span><span class="s">&#39;Name clash with existing message: </span><span class="si">%s</span><span class="s">&#39;</span>
                                         <span class="o">%</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">uniq</span>
</div>
<div class="viewcode-block" id="Maildir.remove"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Maildir.discard"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the keyed message exists, remove it.&quot;&quot;&quot;</span>
        <span class="c"># This overrides an inapplicable implementation in the superclass.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">FileNotFoundError</span><span class="p">):</span>
            <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">old_subpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">temp_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">temp_subpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">temp_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="c"># temp&#39;s subdir and suffix were specified by message.</span>
            <span class="n">dominant_subpath</span> <span class="o">=</span> <span class="n">temp_subpath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># temp&#39;s subdir and suffix were defaults from add().</span>
            <span class="n">dominant_subpath</span> <span class="o">=</span> <span class="n">old_subpath</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dominant_subpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colon</span> <span class="ow">in</span> <span class="n">dominant_subpath</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colon</span> <span class="o">+</span> <span class="n">dominant_subpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colon</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">temp_subpath</span><span class="p">)</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getatime</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">),</span> <span class="n">message</span><span class="o">.</span><span class="n">get_date</span><span class="p">()))</span>
        <span class="c"># No file modification should be done after the file is moved to its</span>
        <span class="c"># final position in order to prevent race conditions with changes</span>
        <span class="c"># from other programs</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>

<div class="viewcode-block" id="Maildir.get_message"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.get_message">[docs]</a>    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Message representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">subpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">subpath</span><span class="p">),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">MaildirMessage</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">subdir</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="n">subdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colon</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">set_info</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colon</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">set_date</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">subpath</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="Maildir.get_bytes"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.get_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a bytes representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Maildir.get_file"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a file-like representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_ProxyFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Maildir.iterkeys"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.iterkeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over keys.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">key</span>
</div>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the keyed message exists, False otherwise.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a count of messages in the mailbox.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">)</span>

<div class="viewcode-block" id="Maildir.flush"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write any pending changes to disk.&quot;&quot;&quot;</span>
        <span class="c"># Maildir changes are always written immediately, so there&#39;s nothing</span>
        <span class="c"># to do.</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Maildir.lock"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.lock">[docs]</a>    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lock the mailbox.&quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Maildir.unlock"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.unlock">[docs]</a>    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unlock the mailbox if it is locked.&quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Maildir.close"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush and close the mailbox.&quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Maildir.list_folders"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.list_folders">[docs]</a>    <span class="k">def</span> <span class="nf">list_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of folder names.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span> <span class="ow">and</span> \
               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Maildir.get_folder"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.get_folder">[docs]</a>    <span class="k">def</span> <span class="nf">get_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Maildir instance for the named folder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Maildir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">folder</span><span class="p">),</span>
                       <span class="n">factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">,</span>
                       <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Maildir.add_folder"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.add_folder">[docs]</a>    <span class="k">def</span> <span class="nf">add_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a folder and return a Maildir instance representing it.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">folder</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Maildir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">)</span>
        <span class="n">maildirfolder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;maildirfolder&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maildirfolder_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">maildirfolder_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">,</span>
                <span class="mi">0</span><span class="n">o666</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Maildir.remove_folder"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.remove_folder">[docs]</a>    <span class="k">def</span> <span class="nf">remove_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the named folder, which must be empty.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">folder</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;new&#39;</span><span class="p">))</span> <span class="o">+</span> \
                     <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;cur&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotEmptyError</span><span class="p">(</span><span class="s">&#39;Folder contains message(s): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">folder</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="o">!=</span> <span class="s">&#39;new&#39;</span> <span class="ow">and</span> <span class="n">entry</span> <span class="o">!=</span> <span class="s">&#39;cur&#39;</span> <span class="ow">and</span> <span class="n">entry</span> <span class="o">!=</span> <span class="s">&#39;tmp&#39;</span> <span class="ow">and</span> \
               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">NotEmptyError</span><span class="p">(</span><span class="s">&quot;Folder contains subdirectory &#39;</span><span class="si">%s</span><span class="s">&#39;: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                    <span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Maildir.clean"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete old files in &quot;tmp&quot;.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;tmp&#39;</span><span class="p">)):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getatime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">129600</span><span class="p">:</span>   <span class="c"># 60 * 60 * 36</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
    <span class="n">_count</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># This is used to generate unique file names.</span>

    <span class="k">def</span> <span class="nf">_create_tmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a file in the tmp subdirectory and open and return it.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">r&#39;\057&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="s">r&#39;\072&#39;</span><span class="p">)</span>
        <span class="n">uniq</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.M</span><span class="si">%s</span><span class="s">P</span><span class="si">%s</span><span class="s">Q</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
                                    <span class="n">Maildir</span><span class="o">.</span><span class="n">_count</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">uniq</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
            <span class="n">Maildir</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_create_carefully</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c"># Fall through to here if stat succeeded or open raised EEXIST.</span>
        <span class="k">raise</span> <span class="n">ExternalClashError</span><span class="p">(</span><span class="s">&#39;Name clash prevented file creation: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                 <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update table of contents mapping.&quot;&quot;&quot;</span>
        <span class="c"># If it has been less than two seconds since the last _refresh() call,</span>
        <span class="c"># we have to unconditionally re-read the mailbox just in case it has</span>
        <span class="c"># been modified, because os.path.mtime() has a 2 sec resolution in the</span>
        <span class="c"># most common worst case (FAT) and a 1 sec resolution typically.  This</span>
        <span class="c"># results in a few unnecessary re-reads when _refresh() is called</span>
        <span class="c"># multiple times in that interval, but once the clock ticks over, we</span>
        <span class="c"># will only re-read as needed.  Because the filesystem might be being</span>
        <span class="c"># served by an independent system with its own clock, we record and</span>
        <span class="c"># compare with the mtimes from the filesystem.  Because the other</span>
        <span class="c"># system&#39;s clock might be skewing relative to our clock, we add an</span>
        <span class="c"># extra delta to our wait.  The default is one tenth second, but is an</span>
        <span class="c"># instance variable and so can be adjusted if dealing with a</span>
        <span class="c"># particularly skewed or irregular system.</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_read</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skewfactor</span><span class="p">:</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc_mtimes</span><span class="p">:</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">subdir</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">mtime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc_mtimes</span><span class="p">[</span><span class="n">subdir</span><span class="p">]:</span>
                    <span class="n">refresh</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_toc_mtimes</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="c"># Refresh toc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc_mtimes</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paths</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">uniq</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">uniq</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_read</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use TOC to return subpath for given key, or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="c"># This method is for backward compatibility only.</span>
<div class="viewcode-block" id="Maildir.next"><a class="viewcode-back" href="../mailbox.html#mailbox.Maildir.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the next message in a one-time iteration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_onetime_keys&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_onetime_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_onetime_keys</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

</div></div>
<span class="k">class</span> <span class="nc">_singlefileMailbox</span><span class="p">(</span><span class="n">Mailbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A single-file mailbox.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a single-file mailbox.&quot;&quot;&quot;</span>
        <span class="n">Mailbox</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;wb+&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NoSuchMailboxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EROFS</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="bp">False</span>       <span class="c"># No changes require rewriting the file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_sync</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># No need to sync the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span> <span class="o">=</span> <span class="bp">None</span>    <span class="c"># Used to record mailbox size</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add message and return assigned key.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c"># _append_message appends the message to the mailbox file. We</span>
        <span class="c"># don&#39;t need a full rewrite + rename, sync is enough.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_sync</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over keys.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">()</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the keyed message exists, False otherwise.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a count of messages in the mailbox.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lock the mailbox.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="n">_lock_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unlock the mailbox if it is locked.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="n">_unlock_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write any pending changes to disk.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_sync</span><span class="p">:</span>
                <span class="c"># Messages have only been added, so syncing the file</span>
                <span class="c"># is enough.</span>
                <span class="n">_sync_flush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pending_sync</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>

        <span class="c"># In order to be writing anything out at all, self._toc must</span>
        <span class="c"># already have been generated (and presumably has been modified</span>
        <span class="c"># by adding or deleting an item).</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="c"># Check length of self._file; if it&#39;s changed, some other process</span>
        <span class="c"># has modified the mailbox since we scanned it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cur_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur_len</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExternalClashError</span><span class="p">(</span><span class="s">&#39;Size of mailbox file changed &#39;</span>
                                     <span class="s">&#39;(expected </span><span class="si">%i</span><span class="s">, found </span><span class="si">%i</span><span class="s">)&#39;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">))</span>

        <span class="n">new_file</span> <span class="o">=</span> <span class="n">_create_temporary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_toc</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_mailbox_hook</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pre_message_hook</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
                <span class="n">new_start</span> <span class="o">=</span> <span class="n">new_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="nb">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span>
                                                 <span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">buffer</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">new_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
                <span class="n">new_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_start</span><span class="p">,</span> <span class="n">new_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_post_message_hook</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span> <span class="o">=</span> <span class="n">new_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">new_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">_sync_close</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
        <span class="c"># self._file is about to get replaced, so no need to sync.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># Make sure the new file&#39;s mode is the same as the old file&#39;s</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="n">new_toc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_sync</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="n">_lock_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">dotlock</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pre_mailbox_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called before writing the mailbox to file f.&quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_pre_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called before writing each message to file f.&quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_post_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after writing each message to file f.&quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush and close the mailbox.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c"># Sync has been done by self.flush() above.</span>

    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (start, stop) or raise KeyError.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_toc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_append_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append message to mailbox and return (start, stop) offsets.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span><span class="p">:</span>
            <span class="c"># This is the first message, and the _pre_mailbox_hook</span>
            <span class="c"># hasn&#39;t yet been called. If self._pending is True,</span>
            <span class="c"># messages have been removed, so _pre_mailbox_hook must</span>
            <span class="c"># have been called already.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_mailbox_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>  <span class="c"># Record current length of mailbox</span>
        <span class="k">return</span> <span class="n">offsets</span>



<span class="k">class</span> <span class="nc">_mboxMMDF</span><span class="p">(</span><span class="n">_singlefileMailbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An mbox or MMDF mailbox.&quot;&quot;&quot;</span>

    <span class="n">_mangle_from_</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Message representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">from_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_factory</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">set_from</span><span class="p">(</span><span class="n">from_line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">get_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_bytes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">as_string</span><span class="p">(</span><span class="n">unixfrom</span><span class="o">=</span><span class="n">from_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a file-like representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_PartialFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">stop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_install_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format a message and blindly write to self._file.&quot;&quot;&quot;</span>
        <span class="n">from_line</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_to_bytes</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;From &#39;</span><span class="p">):</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newline</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">from_line</span> <span class="o">=</span> <span class="n">message</span><span class="p">[:</span><span class="n">newline</span><span class="p">]</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">newline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">from_line</span> <span class="o">=</span> <span class="n">message</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">_mboxMMDFMessage</span><span class="p">):</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_from</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">from_line</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;From &#39;</span> <span class="o">+</span> <span class="n">author</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="n">from_line</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_unixfrom</span><span class="p">()</span>  <span class="c"># May be None.</span>
            <span class="k">if</span> <span class="n">from_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">from_line</span> <span class="o">=</span> <span class="n">from_line</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_line</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_line</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;From MAILER-DAEMON &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">from_line</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dump_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>


<div class="viewcode-block" id="mbox"><a class="viewcode-back" href="../mailbox.html#mailbox.mbox">[docs]</a><span class="k">class</span> <span class="nc">mbox</span><span class="p">(</span><span class="n">_mboxMMDF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A classic mbox mailbox.&quot;&quot;&quot;</span>

    <span class="n">_mangle_from_</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># All messages must end in a newline character, and</span>
    <span class="c"># _post_message_hooks outputs an empty line between messages.</span>
    <span class="n">_append_newline</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an mbox mailbox.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_factory</span> <span class="o">=</span> <span class="n">mboxMessage</span>
        <span class="n">_mboxMMDF</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after writing each message to file f.&quot;&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate key-to-(start, stop) table of contents.&quot;&quot;&quot;</span>
        <span class="n">starts</span><span class="p">,</span> <span class="n">stops</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">last_was_empty</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;From &#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">last_was_empty</span><span class="p">:</span>
                        <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesep</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># The last line before the &quot;From &quot; line wasn&#39;t</span>
                        <span class="c"># blank, but we consider it a start of a</span>
                        <span class="c"># message anyway.</span>
                        <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span><span class="p">)</span>
                <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span><span class="p">)</span>
                <span class="n">last_was_empty</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_was_empty</span><span class="p">:</span>
                    <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesep</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="n">linesep</span><span class="p">:</span>
                <span class="n">last_was_empty</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_was_empty</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">stops</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="MMDF"><a class="viewcode-back" href="../mailbox.html#mailbox.MMDF">[docs]</a><span class="k">class</span> <span class="nc">MMDF</span><span class="p">(</span><span class="n">_mboxMMDF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An MMDF mailbox.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an MMDF mailbox.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_factory</span> <span class="o">=</span> <span class="n">MMDFMessage</span>
        <span class="n">_mboxMMDF</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pre_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called before writing each message to file f.&quot;&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\001\001\001\001</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after writing each message to file f.&quot;&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\001\001\001\001</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate key-to-(start, stop) table of contents.&quot;&quot;&quot;</span>
        <span class="n">starts</span><span class="p">,</span> <span class="n">stops</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line_pos</span> <span class="o">=</span> <span class="n">next_pos</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">next_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\001\001\001\001</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">):</span>
                <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_pos</span><span class="p">)</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">line_pos</span> <span class="o">=</span> <span class="n">next_pos</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">next_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\001\001\001\001</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">:</span>
                        <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesep</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">stops</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="MH"><a class="viewcode-back" href="../mailbox.html#mailbox.MH">[docs]</a><span class="k">class</span> <span class="nc">MH</span><span class="p">(</span><span class="n">Mailbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An MH mailbox.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an MH instance.&quot;&quot;&quot;</span>
        <span class="n">Mailbox</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.mh_sequences&#39;</span><span class="p">),</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">,</span> <span class="mi">0</span><span class="n">o600</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoSuchMailboxError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="MH.add"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add message and return assigned key.&quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_key</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">_create_carefully</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                <span class="n">_lock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="c"># Unlock and close so it can be deleted on Windows</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                        <span class="n">_unlock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">_sync_close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MHMessage</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_sequences</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                    <span class="n">_unlock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">closed</span><span class="p">:</span>
                <span class="n">_sync_close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_key</span>
</div>
<div class="viewcode-block" id="MH.remove"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                <span class="n">_lock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dump_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MHMessage</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_sequences</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                    <span class="n">_unlock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_sync_close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<div class="viewcode-block" id="MH.get_message"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.get_message">[docs]</a>    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Message representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">with</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                <span class="n">_lock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">MHMessage</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                    <span class="n">_unlock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="MH.get_bytes"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.get_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a bytes representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">with</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                <span class="n">_lock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
                    <span class="n">_unlock_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MH.get_file"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a file-like representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No message with key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">_ProxyFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MH.iterkeys"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.iterkeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over keys.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
                                      <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()))</span>
</div>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the keyed message exists, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a count of messages in the mailbox.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()))</span>

<div class="viewcode-block" id="MH.lock"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.lock">[docs]</a>    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lock the mailbox.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.mh_sequences&#39;</span><span class="p">),</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
            <span class="n">_lock_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MH.unlock"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.unlock">[docs]</a>    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unlock the mailbox if it is locked.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="n">_unlock_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="n">_sync_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="MH.flush"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write any pending changes to the disk.&quot;&quot;&quot;</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="MH.close"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush and close the mailbox.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MH.list_folders"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.list_folders">[docs]</a>    <span class="k">def</span> <span class="nf">list_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of folder names.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="MH.get_folder"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.get_folder">[docs]</a>    <span class="k">def</span> <span class="nf">get_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an MH instance for the named folder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MH</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span>
                  <span class="n">factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MH.add_folder"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.add_folder">[docs]</a>    <span class="k">def</span> <span class="nf">add_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a folder and return an MH instance representing it.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MH</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span>
                  <span class="n">factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MH.remove_folder"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.remove_folder">[docs]</a>    <span class="k">def</span> <span class="nf">remove_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the named folder, which must be empty.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entries</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;.mh_sequences&#39;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;.mh_sequences&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">entries</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotEmptyError</span><span class="p">(</span><span class="s">&#39;Folder not empty: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MH.get_sequences"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.get_sequences">[docs]</a>    <span class="k">def</span> <span class="nf">get_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a name-to-key-list dictionary to define each sequence.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.mh_sequences&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ASCII&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">))</span>
                            <span class="n">keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> \
                                         <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&#39;Invalid sequence specification: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                      <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="MH.set_sequences"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.set_sequences">[docs]</a>    <span class="k">def</span> <span class="nf">set_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set sequences using the given name-to-key-list dictionary.&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s">&#39;.mh_sequences&#39;</span><span class="p">),</span> <span class="s">&#39;r+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ASCII&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">completing</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">prev</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">completing</span><span class="p">:</span>
                            <span class="n">completing</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">completing</span><span class="p">:</span>
                        <span class="n">completing</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">if</span> <span class="n">completing</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_sync_close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MH.pack"><a class="viewcode-back" href="../mailbox.html#mailbox.MH.pack">[docs]</a>    <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-name messages to eliminate numbering gaps. Invalidates keys.&quot;&quot;&quot;</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">()</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">prev</span><span class="p">:</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">prev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;link&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">prev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">prev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">prev</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key_list</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
                    <span class="n">key_list</span><span class="p">[</span><span class="n">key_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sequences</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_dump_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inspect a new MHMessage and update sequences appropriately.&quot;&quot;&quot;</span>
        <span class="n">pending_sequences</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">()</span>
        <span class="n">all_sequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key_list</span> <span class="ow">in</span> <span class="n">all_sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pending_sequences</span><span class="p">:</span>
                <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">key_list</span><span class="p">[</span><span class="n">key_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">pending_sequences</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sequence</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_sequences</span><span class="p">:</span>
                <span class="n">all_sequences</span><span class="p">[</span><span class="n">sequence</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sequences</span><span class="p">(</span><span class="n">all_sequences</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Babyl"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl">[docs]</a><span class="k">class</span> <span class="nc">Babyl</span><span class="p">(</span><span class="n">_singlefileMailbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Rmail-style Babyl mailbox.&quot;&quot;&quot;</span>

    <span class="n">_special_labels</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;unseen&#39;</span><span class="p">,</span> <span class="s">&#39;deleted&#39;</span><span class="p">,</span> <span class="s">&#39;filed&#39;</span><span class="p">,</span> <span class="s">&#39;answered&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;forwarded&#39;</span><span class="p">,</span> <span class="s">&#39;edited&#39;</span><span class="p">,</span> <span class="s">&#39;resent&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Babyl mailbox.&quot;&quot;&quot;</span>
        <span class="n">_singlefileMailbox</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Babyl.add"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add message and return assigned key.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_singlefileMailbox</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_labels</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">key</span>
</div>
<div class="viewcode-block" id="Babyl.remove"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">_singlefileMailbox</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the keyed message; raise KeyError if it doesn&#39;t exist.&quot;&quot;&quot;</span>
        <span class="n">_singlefileMailbox</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_labels</span><span class="p">()</span>

<div class="viewcode-block" id="Babyl.get_message"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl.get_message">[docs]</a>    <span class="k">def</span> <span class="nf">get_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Message representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>   <span class="c"># Skip b&#39;1,&#39; line specifying labels.</span>
        <span class="n">original_headers</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;*** EOOH ***&#39;</span> <span class="o">+</span> <span class="n">linesep</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">original_headers</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">visible_headers</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">linesep</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">visible_headers</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="c"># Read up to the stop, or to the end</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">BabylMessage</span><span class="p">(</span><span class="n">original_headers</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="o">+</span> <span class="n">body</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">visible_headers</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">set_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="Babyl.get_bytes"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl.get_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>   <span class="c"># Skip b&#39;1,&#39; line specifying labels.</span>
        <span class="n">original_headers</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;*** EOOH ***&#39;</span> <span class="o">+</span> <span class="n">linesep</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">original_headers</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">linesep</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">original_headers</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">linesep</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">headers</span> <span class="o">+</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="Babyl.get_file"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a file-like representation or raise a KeyError.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Babyl.get_labels"><a class="viewcode-back" href="../mailbox.html#mailbox.Babyl.get_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of user-defined labels in the mailbox.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_special_labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_generate_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate key-to-(start, stop) table of contents.&quot;&quot;&quot;</span>
        <span class="n">starts</span><span class="p">,</span> <span class="n">stops</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">label_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line_pos</span> <span class="o">=</span> <span class="n">next_pos</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">next_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\037\014</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">):</span>
                    <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesep</span><span class="p">))</span>
                <span class="n">starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_pos</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span>
                                        <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="n">label_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\037</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\037</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">):</span>
                    <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesep</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesep</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">stops</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">label_lists</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_pre_mailbox_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called before writing the mailbox to file f.&quot;&quot;&quot;</span>
        <span class="n">babyl</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;BABYL OPTIONS:&#39;</span> <span class="o">+</span> <span class="n">linesep</span>
        <span class="n">babyl</span> <span class="o">+=</span> <span class="n">b</span><span class="s">&#39;Version: 5&#39;</span> <span class="o">+</span> <span class="n">linesep</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">babyl</span> <span class="o">+=</span> <span class="n">b</span><span class="s">&#39;Labels:&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="n">linesep</span>
        <span class="n">babyl</span> <span class="o">+=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\037</span><span class="s">&#39;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">babyl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pre_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called before writing each message to file f.&quot;&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\014</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after writing each message to file f.&quot;&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\037</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_install_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write message contents and return (start, stop).&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="n">special_labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get_labels</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_labels</span><span class="p">:</span>
                    <span class="n">special_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">special_labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;, &#39;</span> <span class="o">+</span> <span class="n">label</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">label</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;1,,&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="n">orig_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">orig_generator</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">BytesGenerator</span><span class="p">(</span><span class="n">orig_buffer</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">orig_generator</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">orig_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">orig_buffer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;*** EOOH ***&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
                <span class="n">vis_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">vis_generator</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">BytesGenerator</span><span class="p">(</span><span class="n">vis_buffer</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">vis_generator</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_visible</span><span class="p">())</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">vis_buffer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">orig_buffer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="nb">buffer</span> <span class="o">=</span> <span class="n">orig_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span> <span class="c"># Buffer size is arbitrary.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">buffer</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">buffer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Use of StringIO input is deprecated, &quot;</span>
                    <span class="s">&quot;use BytesIO instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_to_bytes</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">body_start</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">body_start</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[:</span><span class="n">body_start</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;*** EOOH ***&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[:</span><span class="n">body_start</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">body_start</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;*** EOOH ***&#39;</span> <span class="o">+</span> <span class="n">linesep</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&#39;readline&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&#39;buffer&#39;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Use of text mode files is deprecated, &quot;</span>
                    <span class="s">&quot;use a binary mode file instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">buffer</span>
            <span class="n">original_pos</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">first_pass</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="c"># Universal newline support.</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">linesep</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">first_pass</span><span class="p">:</span>
                        <span class="n">first_pass</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;*** EOOH ***&#39;</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span>
                        <span class="n">message</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">original_pos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c"># Universal newline support.</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">linesep</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">linesep</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">linesep</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Invalid message type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Message"><a class="viewcode-back" href="../mailbox.html#mailbox.Message">[docs]</a><span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with mailbox-format-specific properties.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Message instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_become_message</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
                <span class="n">message</span><span class="o">.</span><span class="n">_explain_to</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_become_message</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message_from_bytes</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_become_message</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_become_message</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message_from_file</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_become_message</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message_from_binary_file</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">message</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Invalid message type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_become_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assume the non-format-specific state of message.&quot;&quot;&quot;</span>
        <span class="n">type_specific</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&#39;_type_specific_attributes&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">type_specific</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_explain_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy format-specific state to message insofar as possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c"># There&#39;s nothing format-specific to explain.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to specified type&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MaildirMessage"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage">[docs]</a><span class="k">class</span> <span class="nc">MaildirMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with Maildir-specific properties.&quot;&quot;&quot;</span>

    <span class="n">_type_specific_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_subdir&#39;</span><span class="p">,</span> <span class="s">&#39;_info&#39;</span><span class="p">,</span> <span class="s">&#39;_date&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a MaildirMessage instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subdir</span> <span class="o">=</span> <span class="s">&#39;new&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="MaildirMessage.get_subdir"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.get_subdir">[docs]</a>    <span class="k">def</span> <span class="nf">get_subdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return &#39;new&#39; or &#39;cur&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subdir</span>
</div>
<div class="viewcode-block" id="MaildirMessage.set_subdir"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.set_subdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_subdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set subdir to &#39;new&#39; or &#39;cur&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s">&#39;new&#39;</span> <span class="ow">or</span> <span class="n">subdir</span> <span class="o">==</span> <span class="s">&#39;cur&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subdir</span> <span class="o">=</span> <span class="n">subdir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;subdir must be &#39;new&#39; or &#39;cur&#39;: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">subdir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MaildirMessage.get_flags"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.get_flags">[docs]</a>    <span class="k">def</span> <span class="nf">get_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return as a string the flags that are set.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;2,&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="MaildirMessage.set_flags"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.set_flags">[docs]</a>    <span class="k">def</span> <span class="nf">set_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given flags and unset all others.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="s">&#39;2,&#39;</span> <span class="o">+</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MaildirMessage.add_flag"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.add_flag">[docs]</a>    <span class="k">def</span> <span class="nf">add_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given flag(s) without changing others.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="MaildirMessage.remove_flag"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.remove_flag">[docs]</a>    <span class="k">def</span> <span class="nf">remove_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unset the given string flag(s) without changing others.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="MaildirMessage.get_date"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.get_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return delivery date of message, in seconds since the epoch.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date</span>
</div>
<div class="viewcode-block" id="MaildirMessage.set_date"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.set_date">[docs]</a>    <span class="k">def</span> <span class="nf">set_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set delivery date of message, in seconds since the epoch.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_date</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;can&#39;t convert to float: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MaildirMessage.get_info"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the message&#39;s &quot;info&quot; as a string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
</div>
<div class="viewcode-block" id="MaildirMessage.set_info"><a class="viewcode-back" href="../mailbox.html#mailbox.MaildirMessage.set_info">[docs]</a>    <span class="k">def</span> <span class="nf">set_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the message&#39;s &quot;info&quot; string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;info must be a string: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_explain_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy Maildir-specific state to message insofar as possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subdir</span><span class="p">())</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_date</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">_mboxMMDFMessage</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subdir</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cur&#39;</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;O&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_from</span><span class="p">(</span><span class="s">&#39;MAILER-DAEMON&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_date</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MHMessage</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;unseen&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;replied&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;flagged&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;unseen&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;deleted&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;answered&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;P&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;forwarded&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to specified type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

</div>
<span class="k">class</span> <span class="nc">_mboxMMDFMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with mbox- or MMDF-specific properties.&quot;&quot;&quot;</span>

    <span class="n">_type_specific_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_from&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an mboxMMDFMessage instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_from</span><span class="p">(</span><span class="s">&#39;MAILER-DAEMON&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="n">unixfrom</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_unixfrom</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">unixfrom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">unixfrom</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;From &#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_from</span><span class="p">(</span><span class="n">unixfrom</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_from</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return contents of &quot;From &quot; line.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from</span>

    <span class="k">def</span> <span class="nf">set_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_</span><span class="p">,</span> <span class="n">time_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set &quot;From &quot; line, formatting and appending time_ if specified.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">time_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time_</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">time_</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()</span>
            <span class="n">from_</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from</span> <span class="o">=</span> <span class="n">from_</span>

    <span class="k">def</span> <span class="nf">get_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return as a string the flags that are set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Status&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-Status&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given flags and unset all others.&quot;&quot;&quot;</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">status_flags</span><span class="p">,</span> <span class="n">xstatus_flags</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;O&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">status_flags</span> <span class="o">+=</span> <span class="n">flag</span>
                <span class="n">flags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">,</span> <span class="s">&#39;F&#39;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">xstatus_flags</span> <span class="o">+=</span> <span class="n">flag</span>
                <span class="n">flags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="n">xstatus_flags</span> <span class="o">+=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="s">&#39;Status&#39;</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;Status&#39;</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="s">&#39;X-Status&#39;</span><span class="p">,</span> <span class="n">xstatus_flags</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;X-Status&#39;</span><span class="p">,</span> <span class="n">xstatus_flags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given flag(s) without changing others.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">remove_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unset the given string flag(s) without changing others.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;Status&#39;</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">or</span> <span class="s">&#39;X-Status&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_explain_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy mbox- or MMDF-specific state to message insofar as possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="s">&#39;cur&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;S&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;x-status&#39;</span><span class="p">]</span>
            <span class="n">maybe_date</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_from</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">set_date</span><span class="p">(</span><span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">maybe_date</span><span class="p">,</span>
                                                      <span class="s">&#39;%a %b </span><span class="si">%d</span><span class="s"> %H:%M:%S %Y&#39;</span><span class="p">)))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">_mboxMMDFMessage</span><span class="p">):</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_from</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MHMessage</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;unseen&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;replied&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;flagged&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;x-status&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flags</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;unseen&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;deleted&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;answered&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">message</span><span class="p">[</span><span class="s">&#39;x-status&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to specified type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>


<div class="viewcode-block" id="mboxMessage"><a class="viewcode-back" href="../mailbox.html#mailbox.mboxMessage">[docs]</a><span class="k">class</span> <span class="nc">mboxMessage</span><span class="p">(</span><span class="n">_mboxMMDFMessage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with mbox-specific properties.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="MHMessage"><a class="viewcode-back" href="../mailbox.html#mailbox.MHMessage">[docs]</a><span class="k">class</span> <span class="nc">MHMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with MH-specific properties.&quot;&quot;&quot;</span>

    <span class="n">_type_specific_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_sequences&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an MHMessage instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="MHMessage.get_sequences"><a class="viewcode-back" href="../mailbox.html#mailbox.MHMessage.get_sequences">[docs]</a>    <span class="k">def</span> <span class="nf">get_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of sequences that include the message.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="p">[:]</span>
</div>
<div class="viewcode-block" id="MHMessage.set_sequences"><a class="viewcode-back" href="../mailbox.html#mailbox.MHMessage.set_sequences">[docs]</a>    <span class="k">def</span> <span class="nf">set_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the list of sequences that include the message.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MHMessage.add_sequence"><a class="viewcode-back" href="../mailbox.html#mailbox.MHMessage.add_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">add_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add sequence to list of sequences including the message.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;sequence type must be str: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MHMessage.remove_sequence"><a class="viewcode-back" href="../mailbox.html#mailbox.MHMessage.remove_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">remove_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove sequence from the list of sequences including the message.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">_explain_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy MH-specific state to message insofar as possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;unseen&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="s">&#39;cur&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="s">&#39;cur&#39;</span><span class="p">)</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;S&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;flagged&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;replied&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">_mboxMMDFMessage</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;unseen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;RO&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;O&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;flagged&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;replied&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MHMessage</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">():</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;unseen&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;unseen&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;replied&#39;</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="s">&#39;answered&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to specified type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="BabylMessage"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage">[docs]</a><span class="k">class</span> <span class="nc">BabylMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with Babyl-specific properties.&quot;&quot;&quot;</span>

    <span class="n">_type_specific_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_labels&#39;</span><span class="p">,</span> <span class="s">&#39;_visible&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an BabylMessage instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>
        <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="BabylMessage.get_labels"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.get_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of labels on the message.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[:]</span>
</div>
<div class="viewcode-block" id="BabylMessage.set_labels"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.set_labels">[docs]</a>    <span class="k">def</span> <span class="nf">set_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the list of labels on the message.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BabylMessage.add_label"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.add_label">[docs]</a>    <span class="k">def</span> <span class="nf">add_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add label to list of labels on the message.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;label must be a string: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BabylMessage.remove_label"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.remove_label">[docs]</a>    <span class="k">def</span> <span class="nf">remove_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove label from the list of labels on the message.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="BabylMessage.get_visible"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.get_visible">[docs]</a>    <span class="k">def</span> <span class="nf">get_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Message representation of visible headers.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_visible</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BabylMessage.set_visible"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.set_visible">[docs]</a>    <span class="k">def</span> <span class="nf">set_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visible</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Message representation of visible headers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">visible</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BabylMessage.update_visible"><a class="viewcode-back" href="../mailbox.html#mailbox.BabylMessage.update_visible">[docs]</a>    <span class="k">def</span> <span class="nf">update_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update and/or sensibly generate a set of visible headers.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">header</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Date&#39;</span><span class="p">,</span> <span class="s">&#39;From&#39;</span><span class="p">,</span> <span class="s">&#39;Reply-To&#39;</span><span class="p">,</span> <span class="s">&#39;To&#39;</span><span class="p">,</span> <span class="s">&#39;CC&#39;</span><span class="p">,</span> <span class="s">&#39;Subject&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_visible</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_explain_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy Babyl-specific state to message insofar as possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MaildirMessage</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;unseen&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="s">&#39;cur&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="s">&#39;cur&#39;</span><span class="p">)</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;S&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;forwarded&#39;</span> <span class="ow">in</span> <span class="n">labels</span> <span class="ow">or</span> <span class="s">&#39;resent&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;answered&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;deleted&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">_mboxMMDFMessage</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;unseen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;RO&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;O&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;deleted&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;answered&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">MHMessage</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">())</span>
            <span class="k">if</span> <span class="s">&#39;unseen&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;unseen&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;answered&#39;</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_sequence</span><span class="p">(</span><span class="s">&#39;replied&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">BabylMessage</span><span class="p">):</span>
            <span class="n">message</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_visible</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">():</span>
                <span class="n">message</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to specified type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="MMDFMessage"><a class="viewcode-back" href="../mailbox.html#mailbox.MMDFMessage">[docs]</a><span class="k">class</span> <span class="nc">MMDFMessage</span><span class="p">(</span><span class="n">_mboxMMDFMessage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message with MMDF-specific properties.&quot;&quot;&quot;</span>

</div>
<span class="k">class</span> <span class="nc">_ProxyFile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A read-only wrapper of a file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a _ProxyFile.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read bytes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read bytes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a line.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read multiple lines.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sizehint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">sizehint</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over lines.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">yield</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the position.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_file&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">read_method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read size bytes using read_method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">read_method</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context management protocol support.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">readable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">writable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">seekable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_file&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="s">&#39;closed&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">closed</span>


<span class="k">class</span> <span class="nc">_PartialFile</span><span class="p">(</span><span class="n">_ProxyFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A read-only wrapper of part of a file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a _PartialFile.&quot;&quot;&quot;</span>
        <span class="n">_ProxyFile</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="n">stop</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the position with respect to start.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_ProxyFile</span><span class="o">.</span><span class="n">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change position, possibly with respect to start or stop.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
            <span class="n">whence</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span>
            <span class="n">whence</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">_ProxyFile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">read_method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read size bytes using read_method, honoring start and stop.&quot;&quot;&quot;</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span>
        <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">remaining</span>
        <span class="k">return</span> <span class="n">_ProxyFile</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">read_method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># do *not* close the underlying file object for partial files,</span>
        <span class="c"># since it&#39;s global to the mailbox object</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_file&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>


<span class="k">def</span> <span class="nf">_lock_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dotlock</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lock file f using lockf and dot locking.&quot;&quot;&quot;</span>
    <span class="n">dotlock_done</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EROFS</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ExternalClashError</span><span class="p">(</span><span class="s">&#39;lockf: lock unavailable: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                             <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">if</span> <span class="n">dotlock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pre_lock</span> <span class="o">=</span> <span class="n">_create_temporary</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.lock&#39;</span><span class="p">)</span>
                <span class="n">pre_lock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EROFS</span><span class="p">):</span>
                    <span class="k">return</span>  <span class="c"># Without write access, just skip dotlocking.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;link&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">pre_lock</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.lock&#39;</span><span class="p">)</span>
                    <span class="n">dotlock_done</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">pre_lock</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">pre_lock</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.lock&#39;</span><span class="p">)</span>
                    <span class="n">dotlock_done</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pre_lock</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ExternalClashError</span><span class="p">(</span><span class="s">&#39;dot lock unavailable: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                         <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dotlock_done</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.lock&#39;</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unlock file f using lockf and dot locking.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
        <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.lock&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.lock&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_carefully</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a file if it doesn&#39;t exist and open for reading and writing.&quot;&quot;&quot;</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0</span><span class="n">o666</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rb+&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_temporary</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a temp file based on path and open for reading and writing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_create_carefully</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
                                              <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">_sync_flush</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure changes to file f are physically on disk.&quot;&quot;&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;fsync&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">_sync_close</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Close file f, ensuring all changes are physically on disk.&quot;&quot;&quot;</span>
    <span class="n">_sync_flush</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised for module-specific errors.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">NoSuchMailboxError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The specified mailbox does not exist and won&#39;t be created.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">NotEmptyError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The specified mailbox is not empty and deletion was requested.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">ExternalClashError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Another process caused an action to fail.&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">FormatError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A file appears to have an invalid format.&quot;&quot;&quot;</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>