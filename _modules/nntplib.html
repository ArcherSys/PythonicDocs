

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>nntplib &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>nntplib</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for nntplib</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;An NNTP client class based on:</span>
<span class="sd">- RFC 977: Network News Transfer Protocol</span>
<span class="sd">- RFC 2980: Common NNTP Extensions</span>
<span class="sd">- RFC 3977: Network News Transfer Protocol (version 2)</span>

<span class="sd">Example:</span>

<span class="sd">&gt;&gt;&gt; from nntplib import NNTP</span>
<span class="sd">&gt;&gt;&gt; s = NNTP(&#39;news&#39;)</span>
<span class="sd">&gt;&gt;&gt; resp, count, first, last, name = s.group(&#39;comp.lang.python&#39;)</span>
<span class="sd">&gt;&gt;&gt; print(&#39;Group&#39;, name, &#39;has&#39;, count, &#39;articles, range&#39;, first, &#39;to&#39;, last)</span>
<span class="sd">Group comp.lang.python has 51 articles, range 5770 to 5821</span>
<span class="sd">&gt;&gt;&gt; resp, subs = s.xhdr(&#39;subject&#39;, &#39;{0}-{1}&#39;.format(first, last))</span>
<span class="sd">&gt;&gt;&gt; resp = s.quit()</span>
<span class="sd">&gt;&gt;&gt;</span>

<span class="sd">Here &#39;resp&#39; is the server response line.</span>
<span class="sd">Error responses are turned into exceptions.</span>

<span class="sd">To post an article from a file:</span>
<span class="sd">&gt;&gt;&gt; f = open(filename, &#39;rb&#39;) # file containing article, including header</span>
<span class="sd">&gt;&gt;&gt; resp = s.post(f)</span>
<span class="sd">&gt;&gt;&gt;</span>

<span class="sd">For descriptions of all methods, read the comments in the code below.</span>
<span class="sd">Note that all arguments and return values representing article numbers</span>
<span class="sd">are strings, not numbers, since they are rarely used for calculations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># RFC 977 by Brian Kantor and Phil Lapsley.</span>
<span class="c"># xover, xgtitle, xpath, date methods by Kevan Heydon</span>

<span class="c"># Incompatible changes from the 2.x nntplib:</span>
<span class="c"># - all commands are encoded as UTF-8 data (using the &quot;surrogateescape&quot;</span>
<span class="c">#   error handler), except for raw message data (POST, IHAVE)</span>
<span class="c"># - all responses are decoded as UTF-8 data (using the &quot;surrogateescape&quot;</span>
<span class="c">#   error handler), except for raw message data (ARTICLE, HEAD, BODY)</span>
<span class="c"># - the `file` argument to various methods is keyword-only</span>
<span class="c">#</span>
<span class="c"># - NNTP.date() returns a datetime object</span>
<span class="c"># - NNTP.newgroups() and NNTP.newnews() take a datetime (or date) object,</span>
<span class="c">#   rather than a pair of (date, time) strings.</span>
<span class="c"># - NNTP.newgroups() and NNTP.list() return a list of GroupInfo named tuples</span>
<span class="c"># - NNTP.descriptions() returns a dict mapping group names to descriptions</span>
<span class="c"># - NNTP.xover() returns a list of dicts mapping field names (header or metadata)</span>
<span class="c">#   to field values; each dict representing a message overview.</span>
<span class="c"># - NNTP.article(), NNTP.head() and NNTP.body() return a (response, ArticleInfo)</span>
<span class="c">#   tuple.</span>
<span class="c"># - the &quot;internal&quot; methods have been marked private (they now start with</span>
<span class="c">#   an underscore)</span>

<span class="c"># Other changes from the 2.x/3.1 nntplib:</span>
<span class="c"># - automatic querying of capabilities at connect</span>
<span class="c"># - New method NNTP.getcapabilities()</span>
<span class="c"># - New method NNTP.over()</span>
<span class="c"># - New helper function decode_header()</span>
<span class="c"># - NNTP.post() and NNTP.ihave() accept file objects, bytes-like objects and</span>
<span class="c">#   arbitrary iterables yielding lines.</span>
<span class="c"># - An extensive test suite :-)</span>

<span class="c"># TODO:</span>
<span class="c"># - return structured data (GroupInfo etc.) everywhere</span>
<span class="c"># - support HDR</span>

<span class="c"># Imports</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ssl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_have_ssl</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_have_ssl</span> <span class="o">=</span> <span class="bp">True</span>

<span class="kn">from</span> <span class="nn">email.header</span> <span class="kn">import</span> <span class="n">decode_header</span> <span class="k">as</span> <span class="n">_email_decode_header</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">_GLOBAL_DEFAULT_TIMEOUT</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;NNTP&quot;</span><span class="p">,</span>
           <span class="s">&quot;NNTPError&quot;</span><span class="p">,</span> <span class="s">&quot;NNTPReplyError&quot;</span><span class="p">,</span> <span class="s">&quot;NNTPTemporaryError&quot;</span><span class="p">,</span>
           <span class="s">&quot;NNTPPermanentError&quot;</span><span class="p">,</span> <span class="s">&quot;NNTPProtocolError&quot;</span><span class="p">,</span> <span class="s">&quot;NNTPDataError&quot;</span><span class="p">,</span>
           <span class="s">&quot;decode_header&quot;</span><span class="p">,</span>
           <span class="p">]</span>

<span class="c"># maximal line length when calling readline(). This is to prevent</span>
<span class="c"># reading arbitrary length lines. RFC 3977 limits NNTP line length to</span>
<span class="c"># 512 characters, including CRLF. We have selected 2048 just to be on</span>
<span class="c"># the safe side.</span>
<span class="n">_MAXLINE</span> <span class="o">=</span> <span class="mi">2048</span>


<span class="c"># Exceptions raised when an error or invalid response is received</span>
<div class="viewcode-block" id="NNTPError"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTPError">[docs]</a><span class="k">class</span> <span class="nc">NNTPError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all nntplib exceptions&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="s">&#39;No response given&#39;</span>
</div>
<div class="viewcode-block" id="NNTPReplyError"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTPReplyError">[docs]</a><span class="k">class</span> <span class="nc">NNTPReplyError</span><span class="p">(</span><span class="n">NNTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unexpected [123]xx reply&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NNTPTemporaryError"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTPTemporaryError">[docs]</a><span class="k">class</span> <span class="nc">NNTPTemporaryError</span><span class="p">(</span><span class="n">NNTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;4xx errors&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NNTPPermanentError"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTPPermanentError">[docs]</a><span class="k">class</span> <span class="nc">NNTPPermanentError</span><span class="p">(</span><span class="n">NNTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;5xx errors&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NNTPProtocolError"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTPProtocolError">[docs]</a><span class="k">class</span> <span class="nc">NNTPProtocolError</span><span class="p">(</span><span class="n">NNTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Response does not begin with [1-5]&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NNTPDataError"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTPDataError">[docs]</a><span class="k">class</span> <span class="nc">NNTPDataError</span><span class="p">(</span><span class="n">NNTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error in response data&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="c"># Standard port used by NNTP servers</span></div>
<span class="n">NNTP_PORT</span> <span class="o">=</span> <span class="mi">119</span>
<span class="n">NNTP_SSL_PORT</span> <span class="o">=</span> <span class="mi">563</span>

<span class="c"># Response numbers that are followed by additional text (e.g. article)</span>
<span class="n">_LONGRESP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;100&#39;</span><span class="p">,</span>   <span class="c"># HELP</span>
    <span class="s">&#39;101&#39;</span><span class="p">,</span>   <span class="c"># CAPABILITIES</span>
    <span class="s">&#39;211&#39;</span><span class="p">,</span>   <span class="c"># LISTGROUP   (also not multi-line with GROUP)</span>
    <span class="s">&#39;215&#39;</span><span class="p">,</span>   <span class="c"># LIST</span>
    <span class="s">&#39;220&#39;</span><span class="p">,</span>   <span class="c"># ARTICLE</span>
    <span class="s">&#39;221&#39;</span><span class="p">,</span>   <span class="c"># HEAD, XHDR</span>
    <span class="s">&#39;222&#39;</span><span class="p">,</span>   <span class="c"># BODY</span>
    <span class="s">&#39;224&#39;</span><span class="p">,</span>   <span class="c"># OVER, XOVER</span>
    <span class="s">&#39;225&#39;</span><span class="p">,</span>   <span class="c"># HDR</span>
    <span class="s">&#39;230&#39;</span><span class="p">,</span>   <span class="c"># NEWNEWS</span>
    <span class="s">&#39;231&#39;</span><span class="p">,</span>   <span class="c"># NEWGROUPS</span>
    <span class="s">&#39;282&#39;</span><span class="p">,</span>   <span class="c"># XGTITLE</span>
<span class="p">}</span>

<span class="c"># Default decoded value for LIST OVERVIEW.FMT if not supported</span>
<span class="n">_DEFAULT_OVERVIEW_FMT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;subject&quot;</span><span class="p">,</span> <span class="s">&quot;from&quot;</span><span class="p">,</span> <span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="s">&quot;message-id&quot;</span><span class="p">,</span> <span class="s">&quot;references&quot;</span><span class="p">,</span> <span class="s">&quot;:bytes&quot;</span><span class="p">,</span> <span class="s">&quot;:lines&quot;</span><span class="p">]</span>

<span class="c"># Alternative names allowed in LIST OVERVIEW.FMT response</span>
<span class="n">_OVERVIEW_FMT_ALTERNATIVES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;bytes&#39;</span><span class="p">:</span> <span class="s">&#39;:bytes&#39;</span><span class="p">,</span>
    <span class="s">&#39;lines&#39;</span><span class="p">:</span> <span class="s">&#39;:lines&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># Line terminators (we always output CRLF, but accept any of CRLF, CR, LF)</span>
<span class="n">_CRLF</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>

<span class="n">GroupInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;GroupInfo&#39;</span><span class="p">,</span>
                                   <span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">,</span> <span class="s">&#39;last&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;flag&#39;</span><span class="p">])</span>

<span class="n">ArticleInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;ArticleInfo&#39;</span><span class="p">,</span>
                                     <span class="p">[</span><span class="s">&#39;number&#39;</span><span class="p">,</span> <span class="s">&#39;message_id&#39;</span><span class="p">,</span> <span class="s">&#39;lines&#39;</span><span class="p">])</span>


<span class="c"># Helper function(s)</span>
<div class="viewcode-block" id="decode_header"><a class="viewcode-back" href="../nntplib.html#nntplib.decode_header">[docs]</a><span class="k">def</span> <span class="nf">decode_header</span><span class="p">(</span><span class="n">header_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes an unicode string representing a munged header value</span>
<span class="sd">    and decodes it as a (possibly non-ASCII) readable value.&quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">_email_decode_header</span><span class="p">(</span><span class="n">header_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span> <span class="ow">or</span> <span class="s">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">_parse_overview_fmt</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a list of string representing the response to LIST OVERVIEW.FMT</span>
<span class="sd">    and return a list of header/metadata names.</span>
<span class="sd">    Raises NNTPDataError if the response is not compliant</span>
<span class="sd">    (cf. RFC 3977, section 8.4).&quot;&quot;&quot;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;:&#39;</span><span class="p">:</span>
            <span class="c"># Metadata name (e.g. &quot;:bytes&quot;)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Header name (e.g. &quot;Subject:&quot; or &quot;Xref:full&quot;)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_OVERVIEW_FMT_ALTERNATIVES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c"># Should we do something with the suffix?</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">_DEFAULT_OVERVIEW_FMT</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NNTPDataError</span><span class="p">(</span><span class="s">&quot;LIST OVERVIEW.FMT response too short&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fmt</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">defaults</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NNTPDataError</span><span class="p">(</span><span class="s">&quot;LIST OVERVIEW.FMT redefines default fields&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fmt</span>

<span class="k">def</span> <span class="nf">_parse_overview</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">data_process_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the response to a OVER or XOVER command according to the</span>
<span class="sd">    overview format `fmt`.&quot;&quot;&quot;</span>
    <span class="n">n_defaults</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_DEFAULT_OVERVIEW_FMT</span><span class="p">)</span>
    <span class="n">overview</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">article_number</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">article_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">article_number</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
                <span class="c"># XXX should we raise an error? Some servers might not</span>
                <span class="c"># support LIST OVERVIEW.FMT and still return additional</span>
                <span class="c"># headers.</span>
                <span class="k">continue</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">is_metadata</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n_defaults</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_metadata</span><span class="p">:</span>
                <span class="c"># Non-default header names are included in full in the response</span>
                <span class="c"># (unless the field is totally empty)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">token</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">h</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NNTPDataError</span><span class="p">(</span><span class="s">&quot;OVER/XOVER response doesn&#39;t include &quot;</span>
                                        <span class="s">&quot;names of additional headers&quot;</span><span class="p">)</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">):]</span> <span class="k">if</span> <span class="n">token</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">fields</span><span class="p">[</span><span class="n">fmt</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="n">overview</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">article_number</span><span class="p">,</span> <span class="n">fields</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">overview</span>

<span class="k">def</span> <span class="nf">_parse_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a pair of (date, time) strings, and return a datetime object.</span>
<span class="sd">    If only the date is given, it is assumed to be date and time</span>
<span class="sd">    concatenated together (e.g. response to the DATE command).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_str</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">date_str</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="n">date_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_str</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_str</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_str</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_str</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="c"># RFC 3977 doesn&#39;t say how to interpret 2-char years.  Assume that</span>
    <span class="c"># there are no dates before 1970 on Usenet.</span>
    <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">+=</span> <span class="mi">2000</span>
    <span class="k">elif</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">+=</span> <span class="mi">1900</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_unparse_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format a date or datetime object as a pair of (date, time) strings</span>
<span class="sd">    in the format required by the NEWNEWS and NEWGROUPS commands.  If a</span>
<span class="sd">    date object is passed, the time is assumed to be midnight (00h00).</span>

<span class="sd">    The returned representation depends on the legacy flag:</span>
<span class="sd">    * if legacy is False (the default):</span>
<span class="sd">      date has the YYYYMMDD format and time the HHMMSS format</span>
<span class="sd">    * if legacy is True:</span>
<span class="sd">      date has the YYMMDD format and time the HHMMSS format.</span>
<span class="sd">    RFC 3977 compliant servers should understand both formats; therefore,</span>
<span class="sd">    legacy is only needed when talking to old servers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="s">&quot;000000&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="s">&quot;{0.hour:02d}{0.minute:02d}{0.second:02d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="k">if</span> <span class="n">legacy</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="s">&quot;{0:02d}{1.month:02d}{1.day:02d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="s">&quot;{0:04d}{1.month:02d}{1.day:02d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span>


<span class="k">if</span> <span class="n">_have_ssl</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_encrypt_on</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrap a socket in SSL/TLS. Arguments:</span>
<span class="sd">        - sock: Socket to wrap</span>
<span class="sd">        - context: SSL context to use for the encrypted connection</span>
<span class="sd">        Returns:</span>
<span class="sd">        - sock: New, encrypted socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Generate a default SSL context if none was passed.</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">()</span>
        <span class="n">server_hostname</span> <span class="o">=</span> <span class="n">hostname</span> <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">)</span>


<span class="c"># The classes themselves</span>
<span class="k">class</span> <span class="nc">_NNTPBase</span><span class="p">:</span>
    <span class="c"># UTF-8 is the character set for all NNTP commands and responses: they</span>
    <span class="c"># are automatically encoded (when sending) and decoded (and receiving)</span>
    <span class="c"># by this class.</span>
    <span class="c"># However, some multi-line data blocks can contain arbitrary bytes (for</span>
    <span class="c"># example, latin-1 or utf-16 data in the body of a message). Commands</span>
    <span class="c"># taking (POST, IHAVE) or returning (HEAD, BODY, ARTICLE) raw message</span>
    <span class="c"># data will therefore only accept and produce bytes objects.</span>
    <span class="c"># Furthermore, since there could be non-compliant servers out there,</span>
    <span class="c"># we use &#39;surrogateescape&#39; as the error handler for fault tolerance</span>
    <span class="c"># and easy round-tripping. This could be useful for some applications</span>
    <span class="c"># (e.g. NNTP gateways).</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;surrogateescape&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
                 <span class="n">readermode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">_GLOBAL_DEFAULT_TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an instance.  Arguments:</span>
<span class="sd">        - file: file-like object (open for read/write in binary mode)</span>
<span class="sd">        - host: hostname of the server</span>
<span class="sd">        - readermode: if true, send &#39;mode reader&#39; command after</span>
<span class="sd">                      connecting.</span>
<span class="sd">        - timeout: timeout (in seconds) used for socket connections</span>

<span class="sd">        readermode is sometimes necessary if you are connecting to an</span>
<span class="sd">        NNTP server on the local machine and intend to call</span>
<span class="sd">        reader-specific commands, such as `group&#39;.  If you get</span>
<span class="sd">        unexpected NNTPPermanentErrors, you might need to set</span>
<span class="sd">        readermode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">welcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getresp</span><span class="p">()</span>

        <span class="c"># Inquire about capabilities (RFC 3977).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getcapabilities</span><span class="p">()</span>

        <span class="c"># &#39;MODE READER&#39; is sometimes necessary to enable &#39;reader&#39; mode.</span>
        <span class="c"># However, the order in which &#39;MODE READER&#39; and &#39;AUTHINFO&#39; need to</span>
        <span class="c"># arrive differs between some NNTP servers. If _setreadermode() fails</span>
        <span class="c"># with an authorization failed error, it will set this to True;</span>
        <span class="c"># the login() routine will interpret that as a request to try again</span>
        <span class="c"># after performing its normal function.</span>
        <span class="c"># Enable only if we&#39;re not already in READER mode anyway.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readermode_afterauth</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">readermode</span> <span class="ow">and</span> <span class="s">&#39;READER&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setreadermode</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readermode_afterauth</span><span class="p">:</span>
                <span class="c"># Capabilities might have changed after MODE READER</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getcapabilities</span><span class="p">()</span>

        <span class="c"># RFC 4642 2.2.2: Both the client and the server MUST know if there is</span>
        <span class="c"># a TLS session active.  A client MUST NOT attempt to start a TLS</span>
        <span class="c"># session if a TLS session is already active.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls_on</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Log in and encryption setup order is left to subclasses.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">is_connected</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_connected</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_connected</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getwelcome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the welcome message from the server</span>
<span class="sd">        (this is read and squirreled away by __init__()).</span>
<span class="sd">        If the response code is 200, posting is allowed;</span>
<span class="sd">        if it 201, posting is not allowed.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;*welcome*&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">welcome</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">welcome</span>

    <span class="k">def</span> <span class="nf">getcapabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the server capabilities, as read by __init__().</span>
<span class="sd">        If the CAPABILITIES command is not supported, an empty dict is</span>
<span class="sd">        returned.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nntp_version</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nntp_implementation</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span><span class="p">,</span> <span class="n">caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">NNTPPermanentError</span><span class="p">,</span> <span class="n">NNTPTemporaryError</span><span class="p">):</span>
                <span class="c"># Server doesn&#39;t support capabilities</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="n">caps</span>
                <span class="k">if</span> <span class="s">&#39;VERSION&#39;</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">:</span>
                    <span class="c"># The server can advertise several supported versions,</span>
                    <span class="c"># choose the highest.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nntp_version</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">caps</span><span class="p">[</span><span class="s">&#39;VERSION&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s">&#39;IMPLEMENTATION&#39;</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nntp_implementation</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="s">&#39;IMPLEMENTATION&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span>

    <span class="k">def</span> <span class="nf">set_debuglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the debugging level.  Argument &#39;level&#39; means:</span>
<span class="sd">        0: no debugging output (default)</span>
<span class="sd">        1: print commands and responses but not body text etc.</span>
<span class="sd">        2: also print raw lines read and sent before stripping CR/LF&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span> <span class="o">=</span> <span class="n">level</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">set_debuglevel</span>

    <span class="k">def</span> <span class="nf">_putline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: send one line to the server, appending CRLF.</span>
<span class="sd">        The `line` must be a bytes-like object.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">_CRLF</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;*put*&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_putcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: send one command to the server (through _putline()).</span>
<span class="sd">        The `line` must be an unicode string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;*cmd*&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_putline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip_crlf</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: return one line from the server, stripping _CRLF.</span>
<span class="sd">        Raise EOFError if the connection is closed.</span>
<span class="sd">        Returns a bytes object.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">_MAXLINE</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAXLINE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPDataError</span><span class="p">(</span><span class="s">&#39;line too long&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;*get*&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">EOFError</span>
        <span class="k">if</span> <span class="n">strip_crlf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="n">_CRLF</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">_CRLF</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">_getresp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: get a response from the server.</span>
<span class="sd">        Raise various errors if the response indicates an error.</span>
<span class="sd">        Returns an unicode string.&quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getline</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;*resp*&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;4&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPTemporaryError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;5&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPPermanentError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;123&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPProtocolError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">_getlongresp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: get a response plus following text from the server.</span>
<span class="sd">        Raise various errors if the response indicates an error.</span>

<span class="sd">        Returns a (response, lines) tuple where `response` is an unicode</span>
<span class="sd">        string and `lines` is a list of bytes objects.</span>
<span class="sd">        If `file` is a file-like object, it must be open in binary mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">openedFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># If a string was passed then open a file with that name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">openedFile</span> <span class="o">=</span> <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getresp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">resp</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_LONGRESP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># XXX lines = None instead?</span>
                <span class="n">terminators</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">_CRLF</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getline</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">terminators</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;..&#39;</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">terminator</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;.&#39;</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">terminator</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;..&#39;</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c"># If this method created the file, then it must close it</span>
            <span class="k">if</span> <span class="n">openedFile</span><span class="p">:</span>
                <span class="n">openedFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">_shortcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: send a command and get the response.</span>
<span class="sd">        Same return value as _getresp().&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_putcmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getresp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_longcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: send a command and get the response plus following text.</span>
<span class="sd">        Same return value as _getlongresp().&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_putcmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getlongresp</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_longcmdstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: send a command and get the response plus following text.</span>
<span class="sd">        Same as _longcmd() and _getlongresp(), except that the returned `lines`</span>
<span class="sd">        are unicode strings rather than bytes objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_putcmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">,</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getlongresp</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_getoverviewfmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: get the overview format. Queries the server if not</span>
<span class="sd">        already done, else returns the cached value.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedoverviewfmt</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&quot;LIST OVERVIEW.FMT&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NNTPPermanentError</span><span class="p">:</span>
            <span class="c"># Not supported by server?</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">_DEFAULT_OVERVIEW_FMT</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">_parse_overview_fmt</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachedoverviewfmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="k">return</span> <span class="n">fmt</span>

    <span class="k">def</span> <span class="nf">_grouplist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="c"># Parse lines into &quot;group last first flag&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">GroupInfo</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a CAPABILITIES command.  Not supported by all servers.</span>
<span class="sd">        Return:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - caps: a dictionary mapping capability names to lists of tokens</span>
<span class="sd">        (for example {&#39;VERSION&#39;: [&#39;2&#39;], &#39;OVER&#39;: [], LIST: [&#39;ACTIVE&#39;, &#39;HEADERS&#39;] })</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&quot;CAPABILITIES&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">caps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">caps</span>

    <span class="k">def</span> <span class="nf">newgroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a NEWGROUPS command.  Arguments:</span>
<span class="sd">        - date: a date or datetime object</span>
<span class="sd">        Return:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of newsgroup names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s">&quot;the date parameter must be a date or datetime object, &quot;</span>
                <span class="s">&quot;not &#39;{:40}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span> <span class="o">=</span> <span class="n">_unparse_datetime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nntp_version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;NEWGROUPS {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplist</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">newnews</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a NEWNEWS command.  Arguments:</span>
<span class="sd">        - group: group name or &#39;*&#39;</span>
<span class="sd">        - date: a date or datetime object</span>
<span class="sd">        Return:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of message ids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s">&quot;the date parameter must be a date or datetime object, &quot;</span>
                <span class="s">&quot;not &#39;{:40}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span> <span class="o">=</span> <span class="n">_unparse_datetime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nntp_version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;NEWNEWS {0} {1} {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">date_str</span><span class="p">,</span> <span class="n">time_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_pattern</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a LIST or LIST ACTIVE command. Arguments:</span>
<span class="sd">        - group_pattern: a pattern indicating which groups to query</span>
<span class="sd">        - file: Filename string or file object to store the result in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of (group, last, first, flag) (strings)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;LIST ACTIVE &#39;</span> <span class="o">+</span> <span class="n">group_pattern</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;LIST&#39;</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplist</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getdescriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_pattern</span><span class="p">,</span> <span class="n">return_all</span><span class="p">):</span>
        <span class="n">line_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^(?P&lt;group&gt;[^ </span><span class="se">\t</span><span class="s">]+)[ </span><span class="se">\t</span><span class="s">]+(.*)$&#39;</span><span class="p">)</span>
        <span class="c"># Try the more std (acc. to RFC2980) LIST NEWSGROUPS first</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&#39;LIST NEWSGROUPS &#39;</span> <span class="o">+</span> <span class="n">group_pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;215&#39;</span><span class="p">):</span>
            <span class="c"># Now the deprecated XGTITLE.  This either raises an error</span>
            <span class="c"># or succeeds with the same output structure as LIST</span>
            <span class="c"># NEWSGROUPS.</span>
            <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&#39;XGTITLE &#39;</span> <span class="o">+</span> <span class="n">group_pattern</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">raw_line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">line_pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">raw_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_all</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">desc</span>
                <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">groups</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Nothing found</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a description for a single group.  If more than one</span>
<span class="sd">        group matches (&#39;group&#39; is a pattern), return the first.  If no</span>
<span class="sd">        group matches, return an empty string.</span>

<span class="sd">        This elides the response code from the server, since it can</span>
<span class="sd">        only be &#39;215&#39; or &#39;285&#39; (for xgtitle) anyway.  If the response</span>
<span class="sd">        code is needed, use the &#39;descriptions&#39; method.</span>

<span class="sd">        NOTE: This neither checks for a wildcard in &#39;group&#39; nor does</span>
<span class="sd">        it check whether the group actually exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdescriptions</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get descriptions for a range of groups.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdescriptions</span><span class="p">(</span><span class="n">group_pattern</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a GROUP command.  Argument:</span>
<span class="sd">        - group: the group name</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - count: number of articles</span>
<span class="sd">        - first: first article number</span>
<span class="sd">        - last: last article number</span>
<span class="sd">        - name: the group name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;GROUP &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;211&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">first</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">),</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a HELP command. Argument:</span>
<span class="sd">        - file: Filename string or file object to store the result in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of strings returned by the server in response to the</span>
<span class="sd">                HELP command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&#39;HELP&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_statparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: parse the response line of a STAT, NEXT, LAST,</span>
<span class="sd">        ARTICLE, HEAD or BODY command.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;22&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">art_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">art_num</span><span class="p">,</span> <span class="n">message_id</span>

    <span class="k">def</span> <span class="nf">_statcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: process a STAT, NEXT or LAST command.&quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statparse</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a STAT command.  Argument:</span>
<span class="sd">        - message_spec: article number or message id (if not specified,</span>
<span class="sd">          the current article is selected)</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - art_num: the article number</span>
<span class="sd">        - message_id: the message id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message_spec</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statcmd</span><span class="p">(</span><span class="s">&#39;STAT {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_spec</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statcmd</span><span class="p">(</span><span class="s">&#39;STAT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a NEXT command.  No arguments.  Return as for STAT.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statcmd</span><span class="p">(</span><span class="s">&#39;NEXT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a LAST command.  No arguments.  Return as for STAT.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statcmd</span><span class="p">(</span><span class="s">&#39;LAST&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_artcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: process a HEAD, BODY or ARTICLE command.&quot;&quot;&quot;</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmd</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">art_num</span><span class="p">,</span> <span class="n">message_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statparse</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">ArticleInfo</span><span class="p">(</span><span class="n">art_num</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a HEAD command.  Argument:</span>
<span class="sd">        - message_spec: article number or message id</span>
<span class="sd">        - file: filename string or file object to store the headers in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - ArticleInfo: (article number, message id, list of header lines)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;HEAD {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;HEAD&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_artcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a BODY command.  Argument:</span>
<span class="sd">        - message_spec: article number or message id</span>
<span class="sd">        - file: filename string or file object to store the body in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - ArticleInfo: (article number, message id, list of body lines)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;BODY {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;BODY&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_artcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">article</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an ARTICLE command.  Argument:</span>
<span class="sd">        - message_spec: article number or message id</span>
<span class="sd">        - file: filename string or file object to store the article in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - ArticleInfo: (article number, message id, list of article lines)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;ARTICLE {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;ARTICLE&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_artcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">slave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a SLAVE command.  Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;SLAVE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xhdr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an XHDR command (optional server extension).  Arguments:</span>
<span class="sd">        - hdr: the header type (e.g. &#39;subject&#39;)</span>
<span class="sd">        - str: an article nr, a message id, or a range nr1-nr2</span>
<span class="sd">        - file: Filename string or file object to store the result in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of (nr, value) strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^([0-9]+) ?(.*)</span><span class="se">\n</span><span class="s">?&#39;</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&#39;XHDR {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">remove_number</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="p">[</span><span class="n">remove_number</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">xover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an XOVER command (optional server extension) Arguments:</span>
<span class="sd">        - start: start of range</span>
<span class="sd">        - end: end of range</span>
<span class="sd">        - file: Filename string or file object to store the result in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of dicts containing the response fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&#39;XOVER {0}-{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span>
                                          <span class="nb">file</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getoverviewfmt</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">_parse_overview</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">over</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_spec</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an OVER command.  If the command isn&#39;t supported, fall</span>
<span class="sd">        back to XOVER. Arguments:</span>
<span class="sd">        - message_spec:</span>
<span class="sd">            - either a message id, indicating the article to fetch</span>
<span class="sd">              information about</span>
<span class="sd">            - or a (start, end) tuple, indicating a range of article numbers;</span>
<span class="sd">              if end is None, information up to the newest message will be</span>
<span class="sd">              retrieved</span>
<span class="sd">            - or None, indicating the current article number must be used</span>
<span class="sd">        - file: Filename string or file object to store the result in</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of dicts containing the response fields</span>

<span class="sd">        NOTE: the &quot;message id&quot; form isn&#39;t supported by XOVER</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;OVER&#39;</span> <span class="k">if</span> <span class="s">&#39;OVER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="k">else</span> <span class="s">&#39;XOVER&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_spec</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">message_spec</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s">&#39; {0}-{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">message_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">message_spec</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getoverviewfmt</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">_parse_overview</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xgtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an XGTITLE command (optional server extension) Arguments:</span>
<span class="sd">        - group: group name wildcard (i.e. news.*)</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - list: list of (name,title) strings&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;The XGTITLE extension is not actively used, &quot;</span>
                      <span class="s">&quot;use descriptions() instead&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">line_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^([^ </span><span class="se">\t</span><span class="s">]+)[ </span><span class="se">\t</span><span class="s">]+(.*)$&#39;</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">raw_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_longcmdstring</span><span class="p">(</span><span class="s">&#39;XGTITLE &#39;</span> <span class="o">+</span> <span class="n">group</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">raw_line</span> <span class="ow">in</span> <span class="n">raw_lines</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">line_pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">raw_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">xpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an XPATH command (optional server extension) Arguments:</span>
<span class="sd">        - id: Message id of article</span>
<span class="sd">        Returns:</span>
<span class="sd">        resp: server response if successful</span>
<span class="sd">        path: directory path to article</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;The XPATH extension is not actively used&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;XPATH {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;223&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">[</span><span class="n">resp_num</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the DATE command.</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        - date: datetime object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&quot;DATE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;111&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPDataError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">14</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NNTPDataError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="n">_parse_datetime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="c"># Raises a specific exception if posting is not allowed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="c"># We don&#39;t use _putline() because:</span>
        <span class="c"># - we don&#39;t want additional CRLF if the file or iterable is already</span>
        <span class="c">#   in the right format</span>
        <span class="c"># - we don&#39;t want a spurious flush() after each line is written</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">_CRLF</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_CRLF</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getresp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a POST command.  Arguments:</span>
<span class="sd">        - data: bytes object, iterable or file containing the article</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ihave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an IHAVE command.  Arguments:</span>
<span class="sd">        - message_id: message-id of the article</span>
<span class="sd">        - data: file containing the article</span>
<span class="sd">        Returns:</span>
<span class="sd">        - resp: server response if successful</span>
<span class="sd">        Note that if the server refuses the article an exception is raised.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="s">&#39;IHAVE {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_id</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>

    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a QUIT command and close the socket.  Returns:</span>
<span class="sd">        - resp: server response if successful&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;QUIT&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">usenetrc</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Already logged in.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">usenetrc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;At least one of `user` and `usenetrc` must be specified&quot;</span><span class="p">)</span>
        <span class="c"># If no login/password was specified but netrc was requested,</span>
        <span class="c"># try to get them from ~/.netrc</span>
        <span class="c"># Presume that if .netrc has an entry, NNRP authentication is required.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">usenetrc</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">netrc</span>
                <span class="n">credentials</span> <span class="o">=</span> <span class="n">netrc</span><span class="o">.</span><span class="n">netrc</span><span class="p">()</span>
                <span class="n">auth</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">authenticators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">auth</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">password</span> <span class="o">=</span> <span class="n">auth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c"># Perform NNTP authentication if needed.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;authinfo user &#39;</span> <span class="o">+</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;381&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NNTPReplyError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;authinfo pass &#39;</span> <span class="o">+</span> <span class="n">password</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;281&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">NNTPPermanentError</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="c"># Capabilities might have changed after login</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getcapabilities</span><span class="p">()</span>
        <span class="c"># Attempt to send mode reader if it was requested after login.</span>
        <span class="c"># Only do so if we&#39;re not in reader mode already.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readermode_afterauth</span> <span class="ow">and</span> <span class="s">&#39;READER&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setreadermode</span><span class="p">()</span>
            <span class="c"># Capabilities might have changed after MODE READER</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getcapabilities</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setreadermode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">welcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;mode reader&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NNTPPermanentError</span><span class="p">:</span>
            <span class="c"># Error 5xx, probably &#39;not implemented&#39;</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">NNTPTemporaryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;480&#39;</span><span class="p">):</span>
                <span class="c"># Need authorization before &#39;mode reader&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">readermode_afterauth</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">if</span> <span class="n">_have_ssl</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">starttls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Process a STARTTLS command. Arguments:</span>
<span class="sd">            - context: SSL context to use for the encrypted connection</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c"># Per RFC 4642, STARTTLS MUST NOT be sent after authentication or if</span>
            <span class="c"># a TLS session already exists.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls_on</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;TLS is already enabled.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticated</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;TLS cannot be started after authentication.&quot;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcmd</span><span class="p">(</span><span class="s">&#39;STARTTLS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;382&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">_encrypt_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;rwb&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tls_on</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># Capabilities may change after TLS starts up, so ask for them</span>
                <span class="c"># again.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getcapabilities</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NNTPError</span><span class="p">(</span><span class="s">&quot;TLS failed to start.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="NNTP"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTP">[docs]</a><span class="k">class</span> <span class="nc">NNTP</span><span class="p">(</span><span class="n">_NNTPBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">NNTP_PORT</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">readermode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">usenetrc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="n">_GLOBAL_DEFAULT_TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an instance.  Arguments:</span>
<span class="sd">        - host: hostname to connect to</span>
<span class="sd">        - port: port to connect to (default the standard NNTP port)</span>
<span class="sd">        - user: username to authenticate with</span>
<span class="sd">        - password: password to use with username</span>
<span class="sd">        - readermode: if true, send &#39;mode reader&#39; command after</span>
<span class="sd">                      connecting.</span>
<span class="sd">        - usenetrc: allow loading username and password from ~/.netrc file</span>
<span class="sd">                    if not specified explicitly</span>
<span class="sd">        - timeout: timeout (in seconds) used for socket connections</span>

<span class="sd">        readermode is sometimes necessary if you are connecting to an</span>
<span class="sd">        NNTP server on the local machine and intend to call</span>
<span class="sd">        reader-specific commands, such as `group&#39;.  If you get</span>
<span class="sd">        unexpected NNTPPermanentErrors, you might need to set</span>
<span class="sd">        readermode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;rwb&quot;</span><span class="p">)</span>
        <span class="n">_NNTPBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
                           <span class="n">readermode</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">usenetrc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">usenetrc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_NNTPBase</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div>
<span class="k">if</span> <span class="n">_have_ssl</span><span class="p">:</span>
<div class="viewcode-block" id="NNTP_SSL"><a class="viewcode-back" href="../nntplib.html#nntplib.NNTP_SSL">[docs]</a>    <span class="k">class</span> <span class="nc">NNTP_SSL</span><span class="p">(</span><span class="n">_NNTPBase</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">NNTP_SSL_PORT</span><span class="p">,</span>
                    <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">readermode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">usenetrc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">_GLOBAL_DEFAULT_TIMEOUT</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;This works identically to NNTP.__init__, except for the change</span>
<span class="sd">            in default port and the `ssl_context` argument for SSL connections.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">_encrypt_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;rwb&quot;</span><span class="p">)</span>
            <span class="n">_NNTPBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
                               <span class="n">readermode</span><span class="o">=</span><span class="n">readermode</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">usenetrc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">usenetrc</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_NNTPBase</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;NNTP_SSL&quot;</span><span class="p">)</span>


<span class="c"># Test retrieval when run as a script.</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">        nntplib built-in demo - display the latest articles in a newsgroup&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-g&#39;</span><span class="p">,</span> <span class="s">&#39;--group&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;gmane.comp.python.general&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;group to fetch messages from (default: </span><span class="si">%(default)s</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--server&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;news.gmane.org&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;NNTP server hostname (default: </span><span class="si">%(default)s</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--port&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;NNTP port number (default: </span><span class="si">%s</span><span class="s"> / </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NNTP_PORT</span><span class="p">,</span> <span class="n">NNTP_SSL_PORT</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--nb-articles&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of articles to fetch (default: </span><span class="si">%(default)s</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-S&#39;</span><span class="p">,</span> <span class="s">&#39;--ssl&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;use NNTP over SSL&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ssl</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">port</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">NNTP_PORT</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">NNTP</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">port</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">NNTP_SSL_PORT</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">NNTP_SSL</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

    <span class="n">caps</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getcapabilities</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;STARTTLS&#39;</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Group&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&#39;has&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="s">&#39;articles, range&#39;</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="s">&#39;to&#39;</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">lim</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">lim</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;...&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">first</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">-</span> <span class="n">args</span><span class="o">.</span><span class="n">nb_articles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">overviews</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xover</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">artnum</span><span class="p">,</span> <span class="n">over</span> <span class="ow">in</span> <span class="n">overviews</span><span class="p">:</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">decode_header</span><span class="p">(</span><span class="n">over</span><span class="p">[</span><span class="s">&#39;from&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">decode_header</span><span class="p">(</span><span class="n">over</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">over</span><span class="p">[</span><span class="s">&#39;:lines&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{:7} {:20} {:42} ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">artnum</span><span class="p">,</span> <span class="n">cut</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">cut</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span> <span class="n">lines</span><span class="p">)</span>
              <span class="p">)</span>

    <span class="n">s</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>