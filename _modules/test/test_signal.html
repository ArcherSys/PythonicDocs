

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_signal &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_signal</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_signal</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">errno</span>
<span class="kn">from</span> <span class="nn">test.script_helper</span> <span class="kn">import</span> <span class="n">assert_python_ok</span><span class="p">,</span> <span class="n">spawn_python</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>


<div class="viewcode-block" id="HandlerBCalled"><a class="viewcode-back" href="../../test.html#test.test_signal.HandlerBCalled">[docs]</a><span class="k">class</span> <span class="nc">HandlerBCalled</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="exit_subprocess"><a class="viewcode-back" href="../../test.html#test.test_signal.exit_subprocess">[docs]</a><span class="k">def</span> <span class="nf">exit_subprocess</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Use os._exit(0) to exit the current subprocess.</span>

<span class="sd">    Otherwise, the test catches the SystemExit and continues executing</span>
<span class="sd">    in parallel with the original test, so you wind up with an</span>
<span class="sd">    exponential number of tests running concurrently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ignoring_eintr"><a class="viewcode-back" href="../../test.html#test.test_signal.ignoring_eintr">[docs]</a><span class="k">def</span> <span class="nf">ignoring_eintr</span><span class="p">(</span><span class="n">__func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">__func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="bp">None</span>

</div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Not valid on Windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InterProcessSignalTests"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests">[docs]</a><span class="k">class</span> <span class="nc">InterProcessSignalTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">MAX_DURATION</span> <span class="o">=</span> <span class="mi">20</span>   <span class="c"># Entire test should last at most 20 sec.</span>

<div class="viewcode-block" id="InterProcessSignalTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">using_gc</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="InterProcessSignalTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_gc</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="InterProcessSignalTests.format_frame"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.format_frame">[docs]</a>    <span class="k">def</span> <span class="nf">format_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="InterProcessSignalTests.handlerA"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.handlerA">[docs]</a>    <span class="k">def</span> <span class="nf">handlerA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_called</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="InterProcessSignalTests.handlerB"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.handlerB">[docs]</a>    <span class="k">def</span> <span class="nf">handlerB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_called</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">raise</span> <span class="n">HandlerBCalled</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="InterProcessSignalTests.wait"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait for child to finish, ignoring EINTR.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                    <span class="k">raise</span>
</div>
<div class="viewcode-block" id="InterProcessSignalTests.run_test"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.run_test">[docs]</a>    <span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Install handlers. This function runs in a sub-process, so we</span>
        <span class="c"># don&#39;t worry about re-setting the default handlers.</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlerA</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlerB</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">default_int_handler</span><span class="p">)</span>

        <span class="c"># Variables the signals will modify:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_called</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_called</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Let the sub-processes know who to send signals to.</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">ignoring_eintr</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;-HUP&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_called</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># Give the signal time to be delivered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_called</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Make sure the signal isn&#39;t delivered while the previous</span>
        <span class="c"># Popen object is being destroyed, because __del__ swallows</span>
        <span class="c"># exceptions.</span>
        <span class="k">del</span> <span class="n">child</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;-USR1&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)])</span>
            <span class="c"># This wait should be interrupted by the signal&#39;s exception.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># Give the signal time to be delivered.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;HandlerBCalled exception not raised&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HandlerBCalled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_called</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_called</span><span class="p">)</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">ignoring_eintr</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;-USR2&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>  <span class="c"># Nothing should happen.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># The race condition in pause doesn&#39;t matter in this case,</span>
            <span class="c"># since alarm is going to raise a KeyboardException, which</span>
            <span class="c"># will skip the call.</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
            <span class="c"># But if another signal arrives before the alarm, pause</span>
            <span class="c"># may return early.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Some other exception woke us from pause: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                      <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;pause returned of its own accord, and the signal&quot;</span>
                      <span class="s">&quot; didn&#39;t arrive after another second.&quot;</span><span class="p">)</span>

    <span class="c"># Issue 3864, unknown if this affects earlier versions of freebsd also</span></div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s">&#39;freebsd6&#39;</span><span class="p">,</span>
        <span class="s">&#39;inter process signals not reliable (do not mix well with threading) &#39;</span>
        <span class="s">&#39;on freebsd6&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="InterProcessSignalTests.test_main"><a class="viewcode-back" href="../../test.html#test.test_signal.InterProcessSignalTests.test_main">[docs]</a>    <span class="k">def</span> <span class="nf">test_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This function spawns a child process to insulate the main</span>
        <span class="c"># test-running process from all the signals. It then</span>
        <span class="c"># communicates with that child process over a pipe and</span>
        <span class="c"># re-raises information about any exceptions the child</span>
        <span class="c"># raises. The real work happens in self.run_test().</span>
        <span class="n">os_done_r</span><span class="p">,</span> <span class="n">os_done_w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os_done_r</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">done_r</span><span class="p">,</span> \
             <span class="n">closing</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os_done_w</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">done_w</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># In the child process; run the test and report results</span>
                <span class="c"># through the pipe.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">done_r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="c"># Have to close done_w again here because</span>
                    <span class="c"># exit_subprocess() will skip the enclosing with block.</span>
                    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">done_w</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_test</span><span class="p">()</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">done_w</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">done_w</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Uh oh, raised from pickle.&#39;</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">exit_subprocess</span><span class="p">()</span>

            <span class="n">done_w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># Block for up to MAX_DURATION seconds for the test to finish.</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">done_r</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_DURATION</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">done_r</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">done_r</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tb</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Test deadlocked after </span><span class="si">%d</span><span class="s"> seconds.&#39;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">MAX_DURATION</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Not valid on Windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixTests"><a class="viewcode-back" href="../../test.html#test.test_signal.PosixTests">[docs]</a><span class="k">class</span> <span class="nc">PosixTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="PosixTests.trivial_signal_handler"><a class="viewcode-back" href="../../test.html#test.test_signal.PosixTests.trivial_signal_handler">[docs]</a>    <span class="k">def</span> <span class="nf">trivial_signal_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PosixTests.test_out_of_range_signal_number_raises_error"><a class="viewcode-back" href="../../test.html#test.test_signal.PosixTests.test_out_of_range_signal_number_raises_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_out_of_range_signal_number_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">,</span> <span class="mi">4242</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">,</span> <span class="mi">4242</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">trivial_signal_handler</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PosixTests.test_setting_signal_handler_to_none_raises_error"><a class="viewcode-back" href="../../test.html#test.test_signal.PosixTests.test_setting_signal_handler_to_none_raises_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_setting_signal_handler_to_none_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">,</span>
                          <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PosixTests.test_getsignal"><a class="viewcode-back" href="../../test.html#test.test_signal.PosixTests.test_getsignal">[docs]</a>    <span class="k">def</span> <span class="nf">test_getsignal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hup</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trivial_signal_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">trivial_signal_handler</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">hup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">),</span> <span class="n">hup</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Windows specific&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WindowsSignalTests"><a class="viewcode-back" href="../../test.html#test.test_signal.WindowsSignalTests">[docs]</a><span class="k">class</span> <span class="nc">WindowsSignalTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="WindowsSignalTests.test_issue9324"><a class="viewcode-back" href="../../test.html#test.test_signal.WindowsSignalTests.test_issue9324">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue9324</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Updated for issue #10003, adding SIGBREAK</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">None</span>
        <span class="n">checked</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGBREAK</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGFPE</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span><span class="p">,</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">):</span>
            <span class="c"># Set and then reset a handler for signals that work on windows.</span>
            <span class="c"># Issue #18396, only for signals without a C-level handler.</span>
            <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
                <span class="n">checked</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="c"># Issue #18396: Ensure the above loop at least tested *something*</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="WakeupFDTests"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupFDTests">[docs]</a><span class="k">class</span> <span class="nc">WakeupFDTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="WakeupFDTests.test_invalid_fd"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupFDTests.test_invalid_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">make_bad_fd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">set_wakeup_fd</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Not valid on Windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="WakeupSignalTests"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests">[docs]</a><span class="k">class</span> <span class="nc">WakeupSignalTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="WakeupSignalTests.check_wakeup"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests.check_wakeup">[docs]</a>    <span class="k">def</span> <span class="nf">check_wakeup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_body</span><span class="p">,</span> <span class="o">*</span><span class="n">signals</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c"># use a subprocess to have only one thread</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">        import fcntl</span>
<span class="s">        import os</span>
<span class="s">        import signal</span>
<span class="s">        import struct</span>

<span class="s">        signals = {!r}</span>

<span class="s">        def handler(signum, frame):</span>
<span class="s">            pass</span>

<span class="s">        def check_signum(signals):</span>
<span class="s">            data = os.read(read, len(signals)+1)</span>
<span class="s">            raised = struct.unpack(&#39;</span><span class="si">%u</span><span class="s">B&#39; </span><span class="si">% le</span><span class="s">n(data), data)</span>
<span class="s">            if not {!r}:</span>
<span class="s">                raised = set(raised)</span>
<span class="s">                signals = set(signals)</span>
<span class="s">            if raised != signals:</span>
<span class="s">                raise Exception(&quot;</span><span class="si">%r</span><span class="s"> != </span><span class="si">%r</span><span class="s">&quot; % (raised, signals))</span>

<span class="s">        {}</span>

<span class="s">        signal.signal(signal.SIGALRM, handler)</span>
<span class="s">        read, write = os.pipe()</span>
<span class="s">        for fd in (read, write):</span>
<span class="s">            flags = fcntl.fcntl(fd, fcntl.F_GETFL, 0)</span>
<span class="s">            flags = flags | os.O_NONBLOCK</span>
<span class="s">            fcntl.fcntl(fd, fcntl.F_SETFL, flags)</span>
<span class="s">        signal.set_wakeup_fd(write)</span>

<span class="s">        test()</span>
<span class="s">        check_signum(signals)</span>

<span class="s">        os.close(read)</span>
<span class="s">        os.close(write)</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">test_body</span><span class="p">)</span>

        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WakeupSignalTests.test_wakeup_write_error"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests.test_wakeup_write_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_wakeup_write_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #16105: write() errors in the C signal handler should not</span>
        <span class="c"># pass silently.</span>
        <span class="c"># Use a subprocess to have only one thread.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">        import errno</span>
<span class="s">        import fcntl</span>
<span class="s">        import os</span>
<span class="s">        import signal</span>
<span class="s">        import sys</span>
<span class="s">        import time</span>
<span class="s">        from test.support import captured_stderr</span>

<span class="s">        def handler(signum, frame):</span>
<span class="s">            1/0</span>

<span class="s">        signal.signal(signal.SIGALRM, handler)</span>
<span class="s">        r, w = os.pipe()</span>
<span class="s">        flags = fcntl.fcntl(r, fcntl.F_GETFL, 0)</span>
<span class="s">        fcntl.fcntl(r, fcntl.F_SETFL, flags | os.O_NONBLOCK)</span>

<span class="s">        # Set wakeup_fd a read-only file descriptor to trigger the error</span>
<span class="s">        signal.set_wakeup_fd(r)</span>
<span class="s">        try:</span>
<span class="s">            with captured_stderr() as err:</span>
<span class="s">                signal.alarm(1)</span>
<span class="s">                time.sleep(5.0)</span>
<span class="s">        except ZeroDivisionError:</span>
<span class="s">            # An ignored exception should have been printed out on stderr</span>
<span class="s">            err = err.getvalue()</span>
<span class="s">            if (&#39;Exception ignored when trying to write to the signal wakeup fd&#39;</span>
<span class="s">                not in err):</span>
<span class="s">                raise AssertionError(err)</span>
<span class="s">            if (&#39;OSError: [Errno </span><span class="si">%d</span><span class="s">]&#39; </span><span class="si">% e</span><span class="s">rrno.EBADF) not in err:</span>
<span class="s">                raise AssertionError(err)</span>
<span class="s">        else:</span>
<span class="s">            raise AssertionError(&quot;ZeroDivisionError not raised&quot;)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;OS doesn&#39;t report write() error on the read end of a pipe&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WakeupSignalTests.test_wakeup_fd_early"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests.test_wakeup_fd_early">[docs]</a>    <span class="k">def</span> <span class="nf">test_wakeup_fd_early</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_wakeup</span><span class="p">(</span><span class="s">&quot;&quot;&quot;def test():</span>
<span class="s">            import select</span>
<span class="s">            import time</span>

<span class="s">            TIMEOUT_FULL = 10</span>
<span class="s">            TIMEOUT_HALF = 5</span>

<span class="s">            signal.alarm(1)</span>
<span class="s">            before_time = time.time()</span>
<span class="s">            # We attempt to get a signal during the sleep,</span>
<span class="s">            # before select is called</span>
<span class="s">            time.sleep(TIMEOUT_FULL)</span>
<span class="s">            mid_time = time.time()</span>
<span class="s">            dt = mid_time - before_time</span>
<span class="s">            if dt &gt;= TIMEOUT_HALF:</span>
<span class="s">                raise Exception(&quot;</span><span class="si">%s</span><span class="s"> &gt;= </span><span class="si">%s</span><span class="s">&quot; % (dt, TIMEOUT_HALF))</span>
<span class="s">            select.select([read], [], [], TIMEOUT_FULL)</span>
<span class="s">            after_time = time.time()</span>
<span class="s">            dt = after_time - mid_time</span>
<span class="s">            if dt &gt;= TIMEOUT_HALF:</span>
<span class="s">                raise Exception(&quot;</span><span class="si">%s</span><span class="s"> &gt;= </span><span class="si">%s</span><span class="s">&quot; % (dt, TIMEOUT_HALF))</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WakeupSignalTests.test_wakeup_fd_during"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests.test_wakeup_fd_during">[docs]</a>    <span class="k">def</span> <span class="nf">test_wakeup_fd_during</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_wakeup</span><span class="p">(</span><span class="s">&quot;&quot;&quot;def test():</span>
<span class="s">            import select</span>
<span class="s">            import time</span>

<span class="s">            TIMEOUT_FULL = 10</span>
<span class="s">            TIMEOUT_HALF = 5</span>

<span class="s">            signal.alarm(1)</span>
<span class="s">            before_time = time.time()</span>
<span class="s">            # We attempt to get a signal during the select call</span>
<span class="s">            try:</span>
<span class="s">                select.select([read], [], [], TIMEOUT_FULL)</span>
<span class="s">            except OSError:</span>
<span class="s">                pass</span>
<span class="s">            else:</span>
<span class="s">                raise Exception(&quot;OSError not raised&quot;)</span>
<span class="s">            after_time = time.time()</span>
<span class="s">            dt = after_time - before_time</span>
<span class="s">            if dt &gt;= TIMEOUT_HALF:</span>
<span class="s">                raise Exception(&quot;</span><span class="si">%s</span><span class="s"> &gt;= </span><span class="si">%s</span><span class="s">&quot; % (dt, TIMEOUT_HALF))</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WakeupSignalTests.test_signum"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests.test_signum">[docs]</a>    <span class="k">def</span> <span class="nf">test_signum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_wakeup</span><span class="p">(</span><span class="s">&quot;&quot;&quot;def test():</span>
<span class="s">            signal.signal(signal.SIGUSR1, handler)</span>
<span class="s">            os.kill(os.getpid(), signal.SIGUSR1)</span>
<span class="s">            os.kill(os.getpid(), signal.SIGALRM)</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_sigmask()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="WakeupSignalTests.test_pending"><a class="viewcode-back" href="../../test.html#test.test_signal.WakeupSignalTests.test_pending">[docs]</a>    <span class="k">def</span> <span class="nf">test_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_wakeup</span><span class="p">(</span><span class="s">&quot;&quot;&quot;def test():</span>
<span class="s">            signum1 = signal.SIGUSR1</span>
<span class="s">            signum2 = signal.SIGUSR2</span>

<span class="s">            signal.signal(signum1, handler)</span>
<span class="s">            signal.signal(signum2, handler)</span>

<span class="s">            signal.pthread_sigmask(signal.SIG_BLOCK, (signum1, signum2))</span>
<span class="s">            os.kill(os.getpid(), signum1)</span>
<span class="s">            os.kill(os.getpid(), signum2)</span>
<span class="s">            # Unblocking the 2 signals calls the C signal handler twice</span>
<span class="s">            signal.pthread_sigmask(signal.SIG_UNBLOCK, (signum1, signum2))</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">,</span>  <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Not valid on Windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SiginterruptTest"><a class="viewcode-back" href="../../test.html#test.test_signal.SiginterruptTest">[docs]</a><span class="k">class</span> <span class="nc">SiginterruptTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="SiginterruptTest.readpipe_interrupted"><a class="viewcode-back" href="../../test.html#test.test_signal.SiginterruptTest.readpipe_interrupted">[docs]</a>    <span class="k">def</span> <span class="nf">readpipe_interrupted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a read during which a signal will arrive.  Return True if the</span>
<span class="sd">        read is interrupted by the signal and raises an exception.  Return False</span>
<span class="sd">        if it returns normally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># use a subprocess to have only one thread, to have a timeout on the</span>
        <span class="c"># blocking read and to not touch signal handling in this process</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import errno</span>
<span class="s">            import os</span>
<span class="s">            import signal</span>
<span class="s">            import sys</span>

<span class="s">            interrupt = </span><span class="si">%r</span><span class="s"></span>
<span class="s">            r, w = os.pipe()</span>

<span class="s">            def handler(signum, frame):</span>
<span class="s">                pass</span>

<span class="s">            signal.signal(signal.SIGALRM, handler)</span>
<span class="s">            if interrupt is not None:</span>
<span class="s">                signal.siginterrupt(signal.SIGALRM, interrupt)</span>

<span class="s">            print(&quot;ready&quot;)</span>
<span class="s">            sys.stdout.flush()</span>

<span class="s">            # run the test twice</span>
<span class="s">            for loop in range(2):</span>
<span class="s">                # send a SIGALRM in a second (during the read)</span>
<span class="s">                signal.alarm(1)</span>
<span class="s">                try:</span>
<span class="s">                    # blocking call: read from a pipe without data</span>
<span class="s">                    os.read(r, 1)</span>
<span class="s">                except OSError as err:</span>
<span class="s">                    if err.errno != errno.EINTR:</span>
<span class="s">                        raise</span>
<span class="s">                else:</span>
<span class="s">                    sys.exit(2)</span>
<span class="s">            sys.exit(3)</span>
<span class="s">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">interrupt</span><span class="p">,)</span>
        <span class="k">with</span> <span class="n">spawn_python</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="k">as</span> <span class="n">process</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># wait until the child process is loaded and has started</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">first_line</span> <span class="o">+</span> <span class="n">stdout</span>
                <span class="n">exitcode</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exitcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Child error (exit code </span><span class="si">%s</span><span class="s">): </span><span class="si">%r</span><span class="s">&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">exitcode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiginterruptTest.test_without_siginterrupt"><a class="viewcode-back" href="../../test.html#test.test_signal.SiginterruptTest.test_without_siginterrupt">[docs]</a>    <span class="k">def</span> <span class="nf">test_without_siginterrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># If a signal handler is installed and siginterrupt is not called</span>
        <span class="c"># at all, when that signal arrives, it interrupts a syscall that&#39;s in</span>
        <span class="c"># progress.</span>
        <span class="n">interrupted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readpipe_interrupted</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">interrupted</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiginterruptTest.test_siginterrupt_on"><a class="viewcode-back" href="../../test.html#test.test_signal.SiginterruptTest.test_siginterrupt_on">[docs]</a>    <span class="k">def</span> <span class="nf">test_siginterrupt_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># If a signal handler is installed and siginterrupt is called with</span>
        <span class="c"># a true value for the second argument, when that signal arrives, it</span>
        <span class="c"># interrupts a syscall that&#39;s in progress.</span>
        <span class="n">interrupted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readpipe_interrupted</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">interrupted</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiginterruptTest.test_siginterrupt_off"><a class="viewcode-back" href="../../test.html#test.test_signal.SiginterruptTest.test_siginterrupt_off">[docs]</a>    <span class="k">def</span> <span class="nf">test_siginterrupt_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># If a signal handler is installed and siginterrupt is called with</span>
        <span class="c"># a false value for the second argument, when that signal arrives, it</span>
        <span class="c"># does not interrupt a syscall that&#39;s in progress.</span>
        <span class="n">interrupted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readpipe_interrupted</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">interrupted</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Not valid on Windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ItimerTest"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest">[docs]</a><span class="k">class</span> <span class="nc">ItimerTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ItimerTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hndl_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itimer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_alarm</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_alrm</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ItimerTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_alarm</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itimer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># test_itimer_exc doesn&#39;t change this attr</span>
            <span class="c"># just ensure that itimer is stopped</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ItimerTest.sig_alrm"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.sig_alrm">[docs]</a>    <span class="k">def</span> <span class="nf">sig_alrm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="ItimerTest.sig_vtalrm"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.sig_vtalrm">[docs]</a>    <span class="k">def</span> <span class="nf">sig_vtalrm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hndl_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c"># it shouldn&#39;t be here, because it should have been disabled.</span>
            <span class="k">raise</span> <span class="n">signal</span><span class="o">.</span><span class="n">ItimerError</span><span class="p">(</span><span class="s">&quot;setitimer didn&#39;t disable ITIMER_VIRTUAL &quot;</span>
                <span class="s">&quot;timer.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hndl_count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c"># disable ITIMER_VIRTUAL, this function shouldn&#39;t be called anymore</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_VIRTUAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hndl_count</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="ItimerTest.sig_prof"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.sig_prof">[docs]</a>    <span class="k">def</span> <span class="nf">sig_prof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_PROF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ItimerTest.test_itimer_exc"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.test_itimer_exc">[docs]</a>    <span class="k">def</span> <span class="nf">test_itimer_exc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># XXX I&#39;m assuming -1 is an invalid itimer, but maybe some platform</span>
        <span class="c"># defines it ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ItimerError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># Negative times are treated as zero on some platforms.</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ItimerError</span><span class="p">,</span>
                              <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ItimerTest.test_itimer_real"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.test_itimer_real">[docs]</a>    <span class="k">def</span> <span class="nf">test_itimer_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itimer</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_REAL</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># Issue 3864, unknown if this affects earlier versions of freebsd also</span></div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;freebsd6&#39;</span><span class="p">,</span> <span class="s">&#39;netbsd5&#39;</span><span class="p">),</span>
        <span class="s">&#39;itimer not reliable (does not mix well with threading) on some BSDs.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ItimerTest.test_itimer_virtual"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.test_itimer_virtual">[docs]</a>    <span class="k">def</span> <span class="nf">test_itimer_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itimer</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_VIRTUAL</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGVTALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_vtalrm</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="mf">60.0</span><span class="p">:</span>
            <span class="c"># use up some virtual time by doing real work</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">12345</span><span class="p">,</span> <span class="mi">67890</span><span class="p">,</span> <span class="mi">10000019</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">getitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="k">break</span> <span class="c"># sig_vtalrm handler stopped this itimer</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Issue 8424</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;timeout: likely cause: machine too slow or load too &quot;</span>
                          <span class="s">&quot;high&quot;</span><span class="p">)</span>

        <span class="c"># virtual itimer should be (0.0, 0.0) now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">getitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="c"># and the handler should have been called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># Issue 3864, unknown if this affects earlier versions of freebsd also</span></div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s">&#39;freebsd6&#39;</span><span class="p">,</span>
        <span class="s">&#39;itimer not reliable (does not mix well with threading) on freebsd6&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ItimerTest.test_itimer_prof"><a class="viewcode-back" href="../../test.html#test.test_signal.ItimerTest.test_itimer_prof">[docs]</a>    <span class="k">def</span> <span class="nf">test_itimer_prof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itimer</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_PROF</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGPROF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_prof</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="mf">60.0</span><span class="p">:</span>
            <span class="c"># do some work</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">12345</span><span class="p">,</span> <span class="mi">67890</span><span class="p">,</span> <span class="mi">10000019</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">getitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="k">break</span> <span class="c"># sig_prof handler stopped this itimer</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Issue 8424</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;timeout: likely cause: machine too slow or load too &quot;</span>
                          <span class="s">&quot;high&quot;</span><span class="p">)</span>

        <span class="c"># profiling itimer should be (0.0, 0.0) now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">getitimer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itimer</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="c"># and the handler should have been called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hndl_called</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PendingSignalsTests"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests">[docs]</a><span class="k">class</span> <span class="nc">PendingSignalsTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test pthread_sigmask(), pthread_kill(), sigpending() and sigwait()</span>
<span class="sd">    functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigpending&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigpending()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigpending_empty"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigpending_empty">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigpending_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">sigpending</span><span class="p">(),</span> <span class="nb">set</span><span class="p">())</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_sigmask()&#39;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigpending&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigpending()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigpending"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigpending">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigpending</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import os</span>
<span class="s">            import signal</span>

<span class="s">            def handler(signum, frame):</span>
<span class="s">                1/0</span>

<span class="s">            signum = signal.SIGUSR1</span>
<span class="s">            signal.signal(signum, handler)</span>

<span class="s">            signal.pthread_sigmask(signal.SIG_BLOCK, [signum])</span>
<span class="s">            os.kill(os.getpid(), signum)</span>
<span class="s">            pending = signal.sigpending()</span>
<span class="s">            if pending != {signum}:</span>
<span class="s">                raise Exception(&#39;</span><span class="si">%s</span><span class="s"> != {</span><span class="si">%s</span><span class="s">}&#39; % (pending, signum))</span>
<span class="s">            try:</span>
<span class="s">                signal.pthread_sigmask(signal.SIG_UNBLOCK, [signum])</span>
<span class="s">            except ZeroDivisionError:</span>
<span class="s">                pass</span>
<span class="s">            else:</span>
<span class="s">                raise Exception(&quot;ZeroDivisionError not raised&quot;)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_kill&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_kill()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_pthread_kill"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_pthread_kill">[docs]</a>    <span class="k">def</span> <span class="nf">test_pthread_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import signal</span>
<span class="s">            import threading</span>
<span class="s">            import sys</span>

<span class="s">            signum = signal.SIGUSR1</span>

<span class="s">            def handler(signum, frame):</span>
<span class="s">                1/0</span>

<span class="s">            signal.signal(signum, handler)</span>

<span class="s">            if sys.platform == &#39;freebsd6&#39;:</span>
<span class="s">                # Issue #12392 and #12469: send a signal to the main thread</span>
<span class="s">                # doesn&#39;t work before the creation of the first thread on</span>
<span class="s">                # FreeBSD 6</span>
<span class="s">                def noop():</span>
<span class="s">                    pass</span>
<span class="s">                thread = threading.Thread(target=noop)</span>
<span class="s">                thread.start()</span>
<span class="s">                thread.join()</span>

<span class="s">            tid = threading.get_ident()</span>
<span class="s">            try:</span>
<span class="s">                signal.pthread_kill(tid, signum)</span>
<span class="s">            except ZeroDivisionError:</span>
<span class="s">                pass</span>
<span class="s">            else:</span>
<span class="s">                raise Exception(&quot;ZeroDivisionError not raised&quot;)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_sigmask()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.wait_helper"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.wait_helper">[docs]</a>    <span class="k">def</span> <span class="nf">wait_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocked</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test: body of the &quot;def test(signum):&quot; function.</span>
<span class="sd">        blocked: number of the blocked signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;if 1:</span>
<span class="s">        import signal</span>
<span class="s">        import sys</span>

<span class="s">        def handler(signum, frame):</span>
<span class="s">            1/0</span>

<span class="s">        </span><span class="si">%s</span><span class="s"></span>

<span class="s">        blocked = </span><span class="si">%s</span><span class="s"></span>
<span class="s">        signum = signal.SIGALRM</span>

<span class="s">        # child: block and wait the signal</span>
<span class="s">        try:</span>
<span class="s">            signal.signal(signum, handler)</span>
<span class="s">            signal.pthread_sigmask(signal.SIG_BLOCK, [blocked])</span>

<span class="s">            # Do the tests</span>
<span class="s">            test(signum)</span>

<span class="s">            # The handler must not be called on unblock</span>
<span class="s">            try:</span>
<span class="s">                signal.pthread_sigmask(signal.SIG_UNBLOCK, [blocked])</span>
<span class="s">            except ZeroDivisionError:</span>
<span class="s">                print(&quot;the signal handler has been called&quot;,</span>
<span class="s">                      file=sys.stderr)</span>
<span class="s">                sys.exit(1)</span>
<span class="s">        except BaseException as err:</span>
<span class="s">            print(&quot;error: {}&quot;.format(err), file=sys.stderr)</span>
<span class="s">            sys.stderr.flush()</span>
<span class="s">            sys.exit(1)</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">blocked</span><span class="p">)</span>

        <span class="c"># sig*wait* must be called with the signal blocked: since the current</span>
        <span class="c"># process might have several threads running, use a subprocess to have</span>
        <span class="c"># a single thread.</span>
        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigwait&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigwait()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigwait"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigwait">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigwait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_helper</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        def test(signum):</span>
<span class="s">            signal.alarm(1)</span>
<span class="s">            received = signal.sigwait([signum])</span>
<span class="s">            if received != signum:</span>
<span class="s">                raise Exception(&#39;received </span><span class="si">%s</span><span class="s">, not </span><span class="si">%s</span><span class="s">&#39; % (received, signum))</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigwaitinfo&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigwaitinfo()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigwaitinfo"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigwaitinfo">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigwaitinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_helper</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        def test(signum):</span>
<span class="s">            signal.alarm(1)</span>
<span class="s">            info = signal.sigwaitinfo([signum])</span>
<span class="s">            if info.si_signo != signum:</span>
<span class="s">                raise Exception(&quot;info.si_signo != </span><span class="si">%s</span><span class="s">&quot; </span><span class="si">% s</span><span class="s">ignum)</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigtimedwait&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigtimedwait()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigtimedwait"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigtimedwait">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigtimedwait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_helper</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        def test(signum):</span>
<span class="s">            signal.alarm(1)</span>
<span class="s">            info = signal.sigtimedwait([signum], 10.1000)</span>
<span class="s">            if info.si_signo != signum:</span>
<span class="s">                raise Exception(&#39;info.si_signo != </span><span class="si">%s</span><span class="s">&#39; </span><span class="si">% s</span><span class="s">ignum)</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigtimedwait&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigtimedwait()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigtimedwait_poll"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigtimedwait_poll">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigtimedwait_poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check that polling with sigtimedwait works</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_helper</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        def test(signum):</span>
<span class="s">            import os</span>
<span class="s">            os.kill(os.getpid(), signum)</span>
<span class="s">            info = signal.sigtimedwait([signum], 0)</span>
<span class="s">            if info.si_signo != signum:</span>
<span class="s">                raise Exception(&#39;info.si_signo != </span><span class="si">%s</span><span class="s">&#39; </span><span class="si">% s</span><span class="s">ignum)</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigtimedwait&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigtimedwait()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigtimedwait_timeout"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigtimedwait_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigtimedwait_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_helper</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        def test(signum):</span>
<span class="s">            received = signal.sigtimedwait([signum], 1.0)</span>
<span class="s">            if received is not None:</span>
<span class="s">                raise Exception(&quot;received=</span><span class="si">%r</span><span class="s">&quot; % (received,))</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigtimedwait&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigtimedwait()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigtimedwait_negative_timeout"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigtimedwait_negative_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigtimedwait_negative_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">signum</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">sigtimedwait</span><span class="p">,</span> <span class="p">[</span><span class="n">signum</span><span class="p">],</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigwaitinfo&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigwaitinfo()&#39;</span><span class="p">)</span>
    <span class="c"># Issue #18238: sigwaitinfo() can be interrupted on Linux (raises</span>
    <span class="c"># InterruptedError), but not on AIX</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;aix&quot;</span><span class="p">),</span>
                     <span class="s">&#39;signal.sigwaitinfo() cannot be interrupted on AIX&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigwaitinfo_interrupted"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigwaitinfo_interrupted">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigwaitinfo_interrupted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_helper</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        def test(signum):</span>
<span class="s">            import errno</span>

<span class="s">            hndl_called = True</span>
<span class="s">            def alarm_handler(signum, frame):</span>
<span class="s">                hndl_called = False</span>

<span class="s">            signal.signal(signal.SIGALRM, alarm_handler)</span>
<span class="s">            signal.alarm(1)</span>
<span class="s">            try:</span>
<span class="s">                signal.sigwaitinfo([signal.SIGUSR1])</span>
<span class="s">            except OSError as e:</span>
<span class="s">                if e.errno == errno.EINTR:</span>
<span class="s">                    if not hndl_called:</span>
<span class="s">                        raise Exception(&quot;SIGALRM handler not called&quot;)</span>
<span class="s">                else:</span>
<span class="s">                    raise Exception(&quot;Expected EINTR to be raised by sigwaitinfo&quot;)</span>
<span class="s">            else:</span>
<span class="s">                raise Exception(&quot;Expected EINTR to be raised by sigwaitinfo&quot;)</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;sigwait&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.sigwait()&#39;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_sigmask()&#39;</span><span class="p">)</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">threading</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;test needs threading module&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_sigwait_thread"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_sigwait_thread">[docs]</a>    <span class="k">def</span> <span class="nf">test_sigwait_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that calling sigwait() from a thread doesn&#39;t suspend the whole</span>
        <span class="c"># process. A new interpreter is spawned to avoid problems when mixing</span>
        <span class="c"># threads and fork(): only async-safe functions are allowed between</span>
        <span class="c"># fork() and exec().</span>
        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;if True:</span>
<span class="s">            import os, threading, sys, time, signal</span>

<span class="s">            # the default handler terminates the process</span>
<span class="s">            signum = signal.SIGUSR1</span>

<span class="s">            def kill_later():</span>
<span class="s">                # wait until the main thread is waiting in sigwait()</span>
<span class="s">                time.sleep(1)</span>
<span class="s">                os.kill(os.getpid(), signum)</span>

<span class="s">            # the signal must be blocked by all the threads</span>
<span class="s">            signal.pthread_sigmask(signal.SIG_BLOCK, [signum])</span>
<span class="s">            killer = threading.Thread(target=kill_later)</span>
<span class="s">            killer.start()</span>
<span class="s">            received = signal.sigwait([signum])</span>
<span class="s">            if received != signum:</span>
<span class="s">                print(&quot;sigwait() received </span><span class="si">%s</span><span class="s">, not </span><span class="si">%s</span><span class="s">&quot; % (received, signum),</span>
<span class="s">                      file=sys.stderr)</span>
<span class="s">                sys.exit(1)</span>
<span class="s">            killer.join()</span>
<span class="s">            # unblock the signal, which should have been cleared by sigwait()</span>
<span class="s">            signal.pthread_sigmask(signal.SIG_UNBLOCK, [signum])</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_sigmask()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_pthread_sigmask_arguments"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_pthread_sigmask_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">test_pthread_sigmask_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="p">,</span> <span class="mi">1700</span><span class="p">,</span> <span class="p">[])</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_sigmask()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_pthread_sigmask"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_pthread_sigmask">[docs]</a>    <span class="k">def</span> <span class="nf">test_pthread_sigmask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">        import signal</span>
<span class="s">        import os; import threading</span>

<span class="s">        def handler(signum, frame):</span>
<span class="s">            1/0</span>

<span class="s">        def kill(signum):</span>
<span class="s">            os.kill(os.getpid(), signum)</span>

<span class="s">        def read_sigmask():</span>
<span class="s">            return signal.pthread_sigmask(signal.SIG_BLOCK, [])</span>

<span class="s">        signum = signal.SIGUSR1</span>

<span class="s">        # Install our signal handler</span>
<span class="s">        old_handler = signal.signal(signum, handler)</span>

<span class="s">        # Unblock SIGUSR1 (and copy the old mask) to test our signal handler</span>
<span class="s">        old_mask = signal.pthread_sigmask(signal.SIG_UNBLOCK, [signum])</span>
<span class="s">        try:</span>
<span class="s">            kill(signum)</span>
<span class="s">        except ZeroDivisionError:</span>
<span class="s">            pass</span>
<span class="s">        else:</span>
<span class="s">            raise Exception(&quot;ZeroDivisionError not raised&quot;)</span>

<span class="s">        # Block and then raise SIGUSR1. The signal is blocked: the signal</span>
<span class="s">        # handler is not called, and the signal is now pending</span>
<span class="s">        signal.pthread_sigmask(signal.SIG_BLOCK, [signum])</span>
<span class="s">        kill(signum)</span>

<span class="s">        # Check the new mask</span>
<span class="s">        blocked = read_sigmask()</span>
<span class="s">        if signum not in blocked:</span>
<span class="s">            raise Exception(&quot;</span><span class="si">%s</span><span class="s"> not in </span><span class="si">%s</span><span class="s">&quot; % (signum, blocked))</span>
<span class="s">        if old_mask ^ blocked != {signum}:</span>
<span class="s">            raise Exception(&quot;</span><span class="si">%s</span><span class="s"> ^ </span><span class="si">%s</span><span class="s"> != {</span><span class="si">%s</span><span class="s">}&quot; % (old_mask, blocked, signum))</span>

<span class="s">        # Unblock SIGUSR1</span>
<span class="s">        try:</span>
<span class="s">            # unblock the pending signal calls immediately the signal handler</span>
<span class="s">            signal.pthread_sigmask(signal.SIG_UNBLOCK, [signum])</span>
<span class="s">        except ZeroDivisionError:</span>
<span class="s">            pass</span>
<span class="s">        else:</span>
<span class="s">            raise Exception(&quot;ZeroDivisionError not raised&quot;)</span>
<span class="s">        try:</span>
<span class="s">            kill(signum)</span>
<span class="s">        except ZeroDivisionError:</span>
<span class="s">            pass</span>
<span class="s">        else:</span>
<span class="s">            raise Exception(&quot;ZeroDivisionError not raised&quot;)</span>

<span class="s">        # Check the new mask</span>
<span class="s">        unblocked = read_sigmask()</span>
<span class="s">        if signum in unblocked:</span>
<span class="s">            raise Exception(&quot;</span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot; % (signum, unblocked))</span>
<span class="s">        if blocked ^ unblocked != {signum}:</span>
<span class="s">            raise Exception(&quot;</span><span class="si">%s</span><span class="s"> ^ </span><span class="si">%s</span><span class="s"> != {</span><span class="si">%s</span><span class="s">}&quot; % (blocked, unblocked, signum))</span>
<span class="s">        if old_mask != unblocked:</span>
<span class="s">            raise Exception(&quot;</span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot; % (old_mask, unblocked))</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;freebsd6&#39;</span><span class="p">,</span>
        <span class="s">&quot;issue #12392: send a signal to the main thread doesn&#39;t work &quot;</span>
        <span class="s">&quot;before the creation of the first thread on FreeBSD 6&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_kill&#39;</span><span class="p">),</span>
                         <span class="s">&#39;need signal.pthread_kill()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PendingSignalsTests.test_pthread_kill_main_thread"><a class="viewcode-back" href="../../test.html#test.test_signal.PendingSignalsTests.test_pthread_kill_main_thread">[docs]</a>    <span class="k">def</span> <span class="nf">test_pthread_kill_main_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test that a signal can be sent to the main thread with pthread_kill()</span>
        <span class="c"># before any other thread has been created (see issue #12392).</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if True:</span>
<span class="s">            import threading</span>
<span class="s">            import signal</span>
<span class="s">            import sys</span>

<span class="s">            def handler(signum, frame):</span>
<span class="s">                sys.exit(3)</span>

<span class="s">            signal.signal(signal.SIGUSR1, handler)</span>
<span class="s">            signal.pthread_kill(threading.get_ident(), signal.SIGUSR1)</span>
<span class="s">            sys.exit(2)</span>
<span class="s">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">spawn_python</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="k">as</span> <span class="n">process</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">exitcode</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Child error (exit code </span><span class="si">%s</span><span class="s">): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_signal.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="n">PosixTests</span><span class="p">,</span> <span class="n">InterProcessSignalTests</span><span class="p">,</span>
                             <span class="n">WakeupFDTests</span><span class="p">,</span> <span class="n">WakeupSignalTests</span><span class="p">,</span>
                             <span class="n">SiginterruptTest</span><span class="p">,</span> <span class="n">ItimerTest</span><span class="p">,</span> <span class="n">WindowsSignalTests</span><span class="p">,</span>
                             <span class="n">PendingSignalsTests</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">reap_children</span><span class="p">()</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>