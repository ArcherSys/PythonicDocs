

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_weakref &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_weakref</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_weakref</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span><span class="p">,</span> <span class="n">script_helper</span>

<span class="c"># Used in ReferencesTestCase.test_ref_created_during_del() .</span>
<span class="n">ref_from_del</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># Used by FinalizeTestCase as a global that may be replaced by None</span>
<span class="c"># when the interpreter shuts down.</span>
<span class="n">_global_var</span> <span class="o">=</span> <span class="s">&#39;foobar&#39;</span>

<div class="viewcode-block" id="C"><a class="viewcode-back" href="../../test.html#test.test_weakref.C">[docs]</a><span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
<div class="viewcode-block" id="C.method"><a class="viewcode-back" href="../../test.html#test.test_weakref.C.method">[docs]</a>    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

</div></div>
<div class="viewcode-block" id="Callable"><a class="viewcode-back" href="../../test.html#test.test_weakref.Callable">[docs]</a><span class="k">class</span> <span class="nc">Callable</span><span class="p">:</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="n">x</span>

</div>
<div class="viewcode-block" id="create_function"><a class="viewcode-back" href="../../test.html#test.test_weakref.create_function">[docs]</a><span class="k">def</span> <span class="nf">create_function</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">():</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="create_bound_method"><a class="viewcode-back" href="../../test.html#test.test_weakref.create_bound_method">[docs]</a><span class="k">def</span> <span class="nf">create_bound_method</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">()</span><span class="o">.</span><span class="n">method</span>

</div>
<div class="viewcode-block" id="Object"><a class="viewcode-back" href="../../test.html#test.test_weakref.Object">[docs]</a><span class="k">class</span> <span class="nc">Object</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Object </span><span class="si">%r</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Object</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Object</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
<div class="viewcode-block" id="Object.some_method"><a class="viewcode-back" href="../../test.html#test.test_weakref.Object.some_method">[docs]</a>    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">4</span></div>
<div class="viewcode-block" id="Object.other_method"><a class="viewcode-back" href="../../test.html#test.test_weakref.Object.other_method">[docs]</a>    <span class="k">def</span> <span class="nf">other_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">5</span>

</div></div>
<div class="viewcode-block" id="RefCycle"><a class="viewcode-back" href="../../test.html#test.test_weakref.RefCycle">[docs]</a><span class="k">class</span> <span class="nc">RefCycle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span>

</div>
<div class="viewcode-block" id="TestBase"><a class="viewcode-back" href="../../test.html#test.test_weakref.TestBase">[docs]</a><span class="k">class</span> <span class="nc">TestBase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_weakref.TestBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="TestBase.callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.TestBase.callback">[docs]</a>    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span> <span class="o">+=</span> <span class="mi">1</span>

</div></div>
<div class="viewcode-block" id="ReferencesTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase">[docs]</a><span class="k">class</span> <span class="nc">ReferencesTestCase</span><span class="p">(</span><span class="n">TestBase</span><span class="p">):</span>

<div class="viewcode-block" id="ReferencesTestCase.test_basic_ref"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_basic_ref">[docs]</a>    <span class="k">def</span> <span class="nf">test_basic_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_ref</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_ref</span><span class="p">(</span><span class="n">create_function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_ref</span><span class="p">(</span><span class="n">create_bound_method</span><span class="p">)</span>

        <span class="c"># Just make sure the tp_repr handler doesn&#39;t raise an exception.</span>
        <span class="c"># Live reference:</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="nb">repr</span><span class="p">(</span><span class="n">wr</span><span class="p">)</span>
        <span class="c"># Dead reference:</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="nb">repr</span><span class="p">(</span><span class="n">wr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_basic_callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_basic_callback">[docs]</a>    <span class="k">def</span> <span class="nf">test_basic_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_callback</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_callback</span><span class="p">(</span><span class="n">create_function</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_callback</span><span class="p">(</span><span class="n">create_bound_method</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_multiple_callbacks"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_multiple_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ref1</span><span class="p">(),</span> <span class="s">&quot;expected reference to be invalidated&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ref2</span><span class="p">(),</span> <span class="s">&quot;expected reference to be invalidated&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="s">&quot;callback not called the right number of times&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_multiple_selfref_callbacks"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_multiple_selfref_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_selfref_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Make sure all references are invalidated before callbacks are called</span>
        <span class="c">#</span>
        <span class="c"># What&#39;s important here is that we&#39;re using the first</span>
        <span class="c"># reference in the callback invoked on the second reference</span>
        <span class="c"># (the most recently created ref is cleaned up first).  This</span>
        <span class="c"># tests that all references to the object are invalidated</span>
        <span class="c"># before any of the callbacks are invoked, so that we only</span>
        <span class="c"># have one invocation of _weakref.c:cleanup_helper() active</span>
        <span class="c"># for a particular object at a time.</span>
        <span class="c">#</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_ref"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_ref">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">o</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span>

        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">proxy</span><span class="p">):</span>
            <span class="n">proxy</span><span class="o">.</span><span class="n">bar</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ReferenceError</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">ref1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ReferenceError</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">ref2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ReferenceError</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">C</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.check_basic_ref"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.check_basic_ref">[docs]</a>    <span class="k">def</span> <span class="nf">check_basic_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">factory</span><span class="p">()</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">ref</span><span class="p">(),</span>
                     <span class="s">&quot;weak reference to live object should be live&quot;</span><span class="p">)</span>
        <span class="n">o2</span> <span class="o">=</span> <span class="n">ref</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span>
                     <span class="s">&quot;&lt;ref&gt;() should return original object if live&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.check_basic_callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.check_basic_callback">[docs]</a>    <span class="k">def</span> <span class="nf">check_basic_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">factory</span><span class="p">()</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s">&quot;callback did not properly set &#39;cbcalled&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ref</span><span class="p">(),</span>
                     <span class="s">&quot;ref2 should be dead after deleting object reference&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_ref_reuse"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_ref_reuse">[docs]</a>    <span class="k">def</span> <span class="nf">test_ref_reuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="c"># create a proxy to make sure that there&#39;s an intervening creation</span>
        <span class="c"># between these two; it should make no difference</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">,</span>
                     <span class="s">&quot;reference object w/out callback should be re-used&quot;</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">,</span>
                     <span class="s">&quot;reference object w/out callback should be re-used&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="s">&quot;wrong weak ref count for object&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s">&quot;wrong weak ref count for object after deleting proxy&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_reuse"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_reuse">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_reuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">proxy1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">proxy2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">proxy1</span><span class="p">,</span> <span class="n">proxy2</span><span class="p">,</span>
                     <span class="s">&quot;proxy object w/out callback should have been re-used&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_basic_proxy"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_basic_proxy">[docs]</a>    <span class="k">def</span> <span class="nf">test_basic_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_proxy</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;proxy for empty UserList should be false&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;proxy for non-empty UserList should be true&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;proxy didn&#39;t support __contains__() properly&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">L2</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
        <span class="c">## self.assertEqual(repr(L2), repr(p2))</span>
        <span class="n">L3</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">UserList</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">p3</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">L3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">L3</span><span class="p">[:],</span> <span class="n">p3</span><span class="p">[:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">L3</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">L3</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">p3</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">L3</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">p3</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_unicode"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_unicode">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># See bug 5037</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="s">&quot;string&quot;</span>
            <span class="k">def</span> <span class="nf">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">b</span><span class="s">&quot;bytes&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;__bytes__&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">instance</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">instance</span><span class="p">)),</span> <span class="n">b</span><span class="s">&quot;bytes&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_index"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_index">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__index__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">10</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_div"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_div">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_div</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">42</span>
            <span class="k">def</span> <span class="nf">__ifloordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">21</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">//=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>

    <span class="c"># The PyWeakref_* C API is documented as allowing either NULL or</span>
    <span class="c"># None as the value for the callback, where either means &quot;no</span>
    <span class="c"># callback&quot;.  The &quot;no callback&quot; ref and proxy objects are supposed</span>
    <span class="c"># to be shared so long as they exist by all callers so long as</span>
    <span class="c"># they are active.  In Python 2.3.3 and earlier, this guarantee</span>
    <span class="c"># was not honored, and was broken in different ways for</span>
    <span class="c"># PyWeakref_NewRef() and PyWeakref_NewProxy().  (Two tests.)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_shared_ref_without_callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_shared_ref_without_callback">[docs]</a>    <span class="k">def</span> <span class="nf">test_shared_ref_without_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_shared_without_callback</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_shared_proxy_without_callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_shared_proxy_without_callback">[docs]</a>    <span class="k">def</span> <span class="nf">test_shared_proxy_without_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_shared_without_callback</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.check_shared_without_callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.check_shared_without_callback">[docs]</a>    <span class="k">def</span> <span class="nf">check_shared_without_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">makeref</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s">&quot;both callbacks were None in the C API&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s">&quot;callbacks were NULL, None in the C API&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s">&quot;both callbacks were NULL in the C API&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="s">&quot;callbacks were None, NULL in the C API&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callable_proxy"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callable_proxy">[docs]</a>    <span class="k">def</span> <span class="nf">test_callable_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">()</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_proxy</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">ref1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ref1</span><span class="p">),</span> <span class="n">weakref</span><span class="o">.</span><span class="n">CallableProxyType</span><span class="p">,</span>
                     <span class="s">&quot;proxy is not of callable type&quot;</span><span class="p">)</span>
        <span class="n">ref1</span><span class="p">(</span><span class="s">&#39;twinkies!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s">&#39;twinkies!&#39;</span><span class="p">,</span>
                     <span class="s">&quot;call through proxy not passed through to original&quot;</span><span class="p">)</span>
        <span class="n">ref1</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&#39;Splat.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s">&#39;Splat.&#39;</span><span class="p">,</span>
                     <span class="s">&quot;call through proxy not passed through to original&quot;</span><span class="p">)</span>

        <span class="c"># expect due to too few args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ref1</span><span class="p">)</span>

        <span class="c"># expect due to too many args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ref1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.check_proxy"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.check_proxy">[docs]</a>    <span class="k">def</span> <span class="nf">check_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s">&quot;proxy does not reflect attribute addition&quot;</span><span class="p">)</span>
        <span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="s">&quot;proxy does not reflect attribute modification&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span><span class="o">.</span><span class="n">foo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">),</span>
                     <span class="s">&quot;proxy does not reflect attribute removal&quot;</span><span class="p">)</span>

        <span class="n">proxy</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s">&quot;object does not reflect attribute addition via proxy&quot;</span><span class="p">)</span>
        <span class="n">proxy</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">&quot;object does not reflect attribute modification via proxy&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">proxy</span><span class="o">.</span><span class="n">foo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">),</span>
                     <span class="s">&quot;object does not reflect attribute removal via proxy&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_deletion"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_deletion">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test clearing of SF bug #762891</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accessor</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">accessor</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_proxy_bool"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_proxy_bool">[docs]</a>    <span class="k">def</span> <span class="nf">test_proxy_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test clearing of SF bug #1170766</span>
        <span class="k">class</span> <span class="nc">List</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">lyst</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">lyst</span><span class="p">)),</span> <span class="nb">bool</span><span class="p">(</span><span class="n">lyst</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_getweakrefcount"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_getweakrefcount">[docs]</a>    <span class="k">def</span> <span class="nf">test_getweakrefcount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="s">&quot;got wrong number of weak reference objects&quot;</span><span class="p">)</span>

        <span class="n">proxy1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">proxy2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
                     <span class="s">&quot;got wrong number of weak reference objects&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">,</span> <span class="n">proxy1</span><span class="p">,</span> <span class="n">proxy2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s">&quot;weak reference objects not unlinked from&quot;</span>
                     <span class="s">&quot; referent when discarded.&quot;</span><span class="p">)</span>

        <span class="c"># assumes ints do not support weakrefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s">&quot;got wrong number of weak reference objects for int&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_getweakrefs"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_getweakrefs">[docs]</a>    <span class="k">def</span> <span class="nf">test_getweakrefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">ref1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="p">[</span><span class="n">ref2</span><span class="p">],</span>
                     <span class="s">&quot;list of refs does not match&quot;</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">ref2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="p">[</span><span class="n">ref1</span><span class="p">],</span>
                     <span class="s">&quot;list of refs does not match&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">ref1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="p">[],</span>
                     <span class="s">&quot;list of refs not cleared&quot;</span><span class="p">)</span>

        <span class="c"># assumes ints do not support weakrefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[],</span>
                     <span class="s">&quot;list of refs does not match for int&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_newstyle_number_ops"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_newstyle_number_ops">[docs]</a>    <span class="k">def</span> <span class="nf">test_newstyle_number_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">F</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>  <span class="c"># this used to SEGV</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callbacks_protected"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callbacks_protected">[docs]</a>    <span class="k">def</span> <span class="nf">test_callbacks_protected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Callbacks protected from already-set exceptions?</span>
        <span class="c"># Regression test for SF bug #478534.</span>
        <span class="k">class</span> <span class="nc">BogusError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">encapsulate</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">remove</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">raise</span> <span class="n">BogusError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encapsulate</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BogusError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;exception not properly restored&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">encapsulate</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BogusError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;exception not properly restored&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_sf_bug_840829"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_sf_bug_840829">[docs]</a>    <span class="k">def</span> <span class="nf">test_sf_bug_840829</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># &quot;weakref callbacks and gc corrupt memory&quot;</span>
        <span class="c"># subtype_dealloc erroneously exposed a new-style instance</span>
        <span class="c"># already in the process of getting deallocated to gc,</span>
        <span class="c"># causing double-deallocation if the instance had a weakref</span>
        <span class="c"># callback that triggered gc.</span>
        <span class="c"># If the bug exists, there probably won&#39;t be an obvious symptom</span>
        <span class="c"># in a release build.  In a debug build, a segfault will occur</span>
        <span class="c"># when the second attempt to remove the instance from the &quot;list</span>
        <span class="c"># of all objects&quot; occurs.</span>

        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ignore</span><span class="p">:</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">c</span>

        <span class="c"># There endeth the first part.  It gets worse.</span>
        <span class="k">del</span> <span class="n">wr</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ignore</span><span class="p">:</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>

        <span class="n">c2</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span>
        <span class="k">del</span> <span class="n">c1</span>  <span class="c"># still alive because c2 points to it</span>

        <span class="c"># Now when subtype_dealloc gets called on c2, it&#39;s not enough just</span>
        <span class="c"># that c2 is immune from gc while the weakref callbacks associated</span>
        <span class="c"># with c2 execute (there are none in this 2nd half of the test, btw).</span>
        <span class="c"># subtype_dealloc goes on to call the base classes&#39; deallocs too,</span>
        <span class="c"># so any gc triggered by weakref callbacks associated with anything</span>
        <span class="c"># torn down by a base class dealloc can also trigger double</span>
        <span class="c"># deallocation of c2.</span>
        <span class="k">del</span> <span class="n">c2</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_in_cycle_1"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_in_cycle_1">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_in_cycle_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="k">class</span> <span class="nc">J</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">II</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">acallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">J</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">II</span><span class="p">()</span>
        <span class="n">I</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">J</span>
        <span class="n">I</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">acallback</span><span class="p">)</span>

        <span class="c"># Now J and II are each in a self-cycle (as all new-style class</span>
        <span class="c"># objects are, since their __mro__ points back to them).  I holds</span>
        <span class="c"># both a weak reference (I.wr) and a strong reference (I.J) to class</span>
        <span class="c"># J.  I is also in a cycle (I.wr points to a weakref that references</span>
        <span class="c"># I.acallback).  When we del these three, they all become trash, but</span>
        <span class="c"># the cycles prevent any of them from getting cleaned up immediately.</span>
        <span class="c"># Instead they have to wait for cyclic gc to deduce that they&#39;re</span>
        <span class="c"># trash.</span>
        <span class="c">#</span>
        <span class="c"># gc used to call tp_clear on all of them, and the order in which</span>
        <span class="c"># it does that is pretty accidental.  The exact order in which we</span>
        <span class="c"># built up these things manages to provoke gc into running tp_clear</span>
        <span class="c"># in just the right order (I last).  Calling tp_clear on II leaves</span>
        <span class="c"># behind an insane class object (its __mro__ becomes NULL).  Calling</span>
        <span class="c"># tp_clear on J breaks its self-cycle, but J doesn&#39;t get deleted</span>
        <span class="c"># just then because of the strong reference from I.J.  Calling</span>
        <span class="c"># tp_clear on I starts to clear I&#39;s __dict__, and just happens to</span>
        <span class="c"># clear I.J first -- I.wr is still intact.  That removes the last</span>
        <span class="c"># reference to J, which triggers the weakref callback.  The callback</span>
        <span class="c"># tries to do &quot;self.J&quot;, and instances of new-style classes look up</span>
        <span class="c"># attributes (&quot;J&quot;) in the class dict first.  The class (II) wants to</span>
        <span class="c"># search II.__mro__, but that&#39;s NULL.   The result was a segfault in</span>
        <span class="c"># a release build, and an assert failure in a debug build.</span>
        <span class="k">del</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">II</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_in_cycle_2"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_in_cycle_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_in_cycle_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="c"># This is just like test_callback_in_cycle_1, except that II is an</span>
        <span class="c"># old-style class.  The symptom is different then:  an instance of an</span>
        <span class="c"># old-style class looks in its own __dict__ first.  &#39;J&#39; happens to</span>
        <span class="c"># get cleared from I.__dict__ before &#39;wr&#39;, and &#39;J&#39; was never in II&#39;s</span>
        <span class="c"># __dict__, so the attribute isn&#39;t found.  The difference is that</span>
        <span class="c"># the old-style II doesn&#39;t have a NULL __mro__ (it doesn&#39;t have any</span>
        <span class="c"># __mro__), so no segfault occurs.  Instead it got:</span>
        <span class="c">#    test_callback_in_cycle_2 (__main__.ReferencesTestCase) ...</span>
        <span class="c">#    Exception exceptions.AttributeError:</span>
        <span class="c">#   &quot;II instance has no attribute &#39;J&#39;&quot; in &lt;bound method II.acallback</span>
        <span class="c">#       of &lt;?.II instance at 0x00B9B4B8&gt;&gt; ignored</span>

        <span class="k">class</span> <span class="nc">J</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">II</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">acallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">J</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">II</span><span class="p">()</span>
        <span class="n">I</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">J</span>
        <span class="n">I</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">acallback</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">II</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_in_cycle_3"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_in_cycle_3">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_in_cycle_3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="c"># This one broke the first patch that fixed the last two.  In this</span>
        <span class="c"># case, the objects reachable from the callback aren&#39;t also reachable</span>
        <span class="c"># from the object (c1) *triggering* the callback:  you can get to</span>
        <span class="c"># c1 from c2, but not vice-versa.  The result was that c2&#39;s __dict__</span>
        <span class="c"># got tp_clear&#39;ed by the time the c2.cb callback got invoked.</span>

        <span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">me</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wr</span>

        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(),</span> <span class="n">C</span><span class="p">()</span>

        <span class="n">c2</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">c2</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">cb</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_in_cycle_4"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_in_cycle_4">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_in_cycle_4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="c"># Like test_callback_in_cycle_3, except c2 and c1 have different</span>
        <span class="c"># classes.  c2&#39;s class (C) isn&#39;t reachable from c1 then, so protecting</span>
        <span class="c"># objects reachable from the dying object (c1) isn&#39;t enough to stop</span>
        <span class="c"># c2&#39;s class (C) from getting tp_clear&#39;ed before c2.cb is invoked.</span>
        <span class="c"># The result was a segfault (C.__mro__ was NULL when the callback</span>
        <span class="c"># tried to look up self.me).</span>

        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">me</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wr</span>

        <span class="k">class</span> <span class="nc">D</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">D</span><span class="p">(),</span> <span class="n">C</span><span class="p">()</span>

        <span class="n">c2</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">c2</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">cb</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_in_cycle_resurrection"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_in_cycle_resurrection">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_in_cycle_resurrection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="c"># Do something nasty in a weakref callback:  resurrect objects</span>
        <span class="c"># from dead cycles.  For this to be attempted, the weakref and</span>
        <span class="c"># its callback must also be part of the cyclic trash (else the</span>
        <span class="c"># objects reachable via the callback couldn&#39;t be in cyclic trash</span>
        <span class="c"># to begin with -- the callback would act like an external root).</span>
        <span class="c"># But gc clears trash weakrefs with callbacks early now, which</span>
        <span class="c"># disables the callbacks, so the callbacks shouldn&#39;t get called</span>
        <span class="c"># at all (and so nothing actually gets resurrected).</span>

        <span class="n">alist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">def</span> <span class="nf">acallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
                <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c2</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c1</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c1</span><span class="o">.</span><span class="n">acallback</span><span class="p">)</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">acallback</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">C_went_away</span><span class="p">(</span><span class="n">ignore</span><span class="p">):</span>
            <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;C went away&quot;</span><span class="p">)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C_went_away</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">C</span>   <span class="c"># make them all trash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="p">[])</span>  <span class="c"># del isn&#39;t enough to reclaim anything</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="c"># c1.wr and c2.wr were part of the cyclic trash, so should have</span>
        <span class="c"># been cleared without their callbacks executing.  OTOH, the weakref</span>
        <span class="c"># to C is bound to a function local (wr), and wasn&#39;t trash, so that</span>
        <span class="c"># callback should have been invoked when C went away.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;C went away&quot;</span><span class="p">])</span>
        <span class="c"># The remaining weakref should be dead now (its callback ran).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wr</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">alist</span><span class="p">[:]</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callbacks_on_callback"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callbacks_on_callback">[docs]</a>    <span class="k">def</span> <span class="nf">test_callbacks_on_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>

        <span class="c"># Set up weakref callbacks *on* weakref callbacks.</span>
        <span class="n">alist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">safe_callback</span><span class="p">(</span><span class="n">ignore</span><span class="p">):</span>
            <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;safe_callback called&quot;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
                <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;cb called&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">C</span><span class="p">(),</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">d</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">cb</span>
        <span class="n">c</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>     <span class="c"># this won&#39;t trigger</span>
        <span class="n">d</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">cb</span><span class="p">)</span>  <span class="c"># ditto</span>
        <span class="n">external_wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">safe_callback</span><span class="p">)</span>  <span class="c"># but this will</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">external_wr</span><span class="p">(),</span> <span class="n">callback</span><span class="p">)</span>

        <span class="c"># The weakrefs attached to c and d should get cleared, so that</span>
        <span class="c"># C.cb is never called.  But external_wr isn&#39;t part of the cyclic</span>
        <span class="c"># trash, and no cyclic trash is reachable from it, so safe_callback</span>
        <span class="c"># should get invoked when the bound method object callback (c.cb)</span>
        <span class="c"># -- which is itself a callback, and also part of the cyclic trash --</span>
        <span class="c"># gets reclaimed at the end of gc.</span>

        <span class="k">del</span> <span class="n">callback</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="p">[])</span>  <span class="c"># del isn&#39;t enough to clean up cycles</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;safe_callback called&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">external_wr</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">alist</span><span class="p">[:]</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_gc_during_ref_creation"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_gc_during_ref_creation">[docs]</a>    <span class="k">def</span> <span class="nf">test_gc_during_ref_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_gc_during_creation</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_gc_during_proxy_creation"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_gc_during_proxy_creation">[docs]</a>    <span class="k">def</span> <span class="nf">test_gc_during_proxy_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_gc_during_creation</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.check_gc_during_creation"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.check_gc_during_creation">[docs]</a>    <span class="k">def</span> <span class="nf">check_gc_during_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">makeref</span><span class="p">):</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_threshold</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">referenced</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">a</span><span class="o">.</span><span class="n">wr</span> <span class="o">=</span> <span class="n">makeref</span><span class="p">(</span><span class="n">referenced</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># now make sure the object and the ref get labeled as</span>
            <span class="c"># cyclic trash:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
            <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">referenced</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">(</span><span class="o">*</span><span class="n">thresholds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_ref_created_during_del"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_ref_created_during_del">[docs]</a>    <span class="k">def</span> <span class="nf">test_ref_created_during_del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Bug #1377858</span>
        <span class="c"># A weakref created in an object&#39;s __del__() would crash the</span>
        <span class="c"># interpreter when the weakref was cleaned up since it would refer to</span>
        <span class="c"># non-existent memory.  This test should not segfault the interpreter.</span>
        <span class="k">class</span> <span class="nc">Target</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">global</span> <span class="n">ref_from_del</span>
                <span class="n">ref_from_del</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">Target</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_init"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_init">[docs]</a>    <span class="k">def</span> <span class="nf">test_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 3634</span>
        <span class="c"># &lt;weakref to class&gt;.__init__() doesn&#39;t check errors correctly</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># No exception should be raised here</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_classes"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_classes">[docs]</a>    <span class="k">def</span> <span class="nf">test_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that classes are weakrefable.</span>
        <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_equality"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_equality">[docs]</a>    <span class="k">def</span> <span class="nf">test_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Alive weakrefs defer equality testing to their underlying object.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c"># Note how we directly test the operators here, to stress both</span>
        <span class="c"># __eq__ and __ne__.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span>
            <span class="c"># Sanity check</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">r</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># Dead weakrefs compare by identity: whether `a` and `d` are the</span>
        <span class="c"># same weakref object is an implementation detail, since they pointed</span>
        <span class="c"># to the same original object and didn&#39;t have a callback.</span>
        <span class="c"># (see issue #16453).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">d</span><span class="p">,</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_ordering"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_ordering">[docs]</a>    <span class="k">def</span> <span class="nf">test_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># weakrefs cannot be ordered, even if the underlying objects can.</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="c"># Same when dead.</span>
        <span class="k">del</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_hashing"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_hashing">[docs]</a>    <span class="k">def</span> <span class="nf">test_hashing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Alive weakrefs hash the same as the underlying object</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="c"># Dead weakrefs:</span>
        <span class="c"># - retain their hash is they were hashed when alive;</span>
        <span class="c"># - otherwise, cannot be hashed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_trashcan_16602"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_trashcan_16602">[docs]</a>    <span class="k">def</span> <span class="nf">test_trashcan_16602</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #16602: when a weakref&#39;s target was part of a long</span>
        <span class="c"># deallocation chain, the trashcan mechanism could delay clearing</span>
        <span class="c"># of the weakref and make the target object visible from outside</span>
        <span class="c"># code even though its refcount had dropped to 0.  A crash ensued.</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">wself</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">wparent</span><span class="p">):</span>
                    <span class="n">o</span> <span class="o">=</span> <span class="n">wself</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wparent</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">root</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_attribute"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ref</span><span class="p">:</span> <span class="bp">None</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ref1</span><span class="o">.</span><span class="n">__callback__</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

        <span class="n">ref2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ref2</span><span class="o">.</span><span class="n">__callback__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_callback_attribute_after_deletion"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_callback_attribute_after_deletion">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_attribute_after_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">__callback__</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">x</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">__callback__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReferencesTestCase.test_set_callback_attribute"><a class="viewcode-back" href="../../test.html#test.test_weakref.ReferencesTestCase.test_set_callback_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_callback_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ref</span><span class="p">:</span> <span class="bp">None</span>
        <span class="n">ref1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">ref1</span><span class="o">.</span><span class="n">__callback__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ref</span><span class="p">:</span> <span class="bp">None</span>

</div></div>
<div class="viewcode-block" id="SubclassableWeakrefTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.SubclassableWeakrefTestCase">[docs]</a><span class="k">class</span> <span class="nc">SubclassableWeakrefTestCase</span><span class="p">(</span><span class="n">TestBase</span><span class="p">):</span>

<div class="viewcode-block" id="SubclassableWeakrefTestCase.test_subclass_refs"><a class="viewcode-back" href="../../test.html#test.test_weakref.SubclassableWeakrefTestCase.test_subclass_refs">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclass_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">MyRef</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__call__</span><span class="p">()</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">mr</span><span class="p">(),</span> <span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mr</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">mr</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mr</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SubclassableWeakrefTestCase.test_subclass_refs_dont_replace_standard_refs"><a class="viewcode-back" href="../../test.html#test.test_weakref.SubclassableWeakrefTestCase.test_subclass_refs_dont_replace_standard_refs">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclass_refs_dont_replace_standard_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">MyRef</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNot</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">r3</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refs</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">refs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">refs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span> <span class="n">refs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</div>
<div class="viewcode-block" id="SubclassableWeakrefTestCase.test_subclass_refs_dont_conflate_callbacks"><a class="viewcode-back" href="../../test.html#test.test_weakref.SubclassableWeakrefTestCase.test_subclass_refs_dont_conflate_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclass_refs_dont_conflate_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">MyRef</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNot</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefs</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">refs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">refs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SubclassableWeakrefTestCase.test_subclass_refs_with_slots"><a class="viewcode-back" href="../../test.html#test.test_weakref.SubclassableWeakrefTestCase.test_subclass_refs_with_slots">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclass_refs_with_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">MyRef</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">):</span>
            <span class="n">__slots__</span> <span class="o">=</span> <span class="s">&quot;slot1&quot;</span><span class="p">,</span> <span class="s">&quot;slot2&quot;</span>
            <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">slot1</span><span class="p">,</span> <span class="n">slot2</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">slot1</span><span class="p">,</span> <span class="n">slot2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slot1</span> <span class="o">=</span> <span class="n">slot1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slot2</span> <span class="o">=</span> <span class="n">slot2</span>
            <span class="k">def</span> <span class="nf">meth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot2</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="s">&quot;def&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">slot1</span><span class="p">,</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">slot2</span><span class="p">,</span> <span class="s">&quot;def&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">meth</span><span class="p">(),</span> <span class="s">&quot;abcdef&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;__dict__&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="SubclassableWeakrefTestCase.test_subclass_refs_with_cycle"><a class="viewcode-back" href="../../test.html#test.test_weakref.SubclassableWeakrefTestCase.test_subclass_refs_with_cycle">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclass_refs_with_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Bug #3110</span>
        <span class="c"># An instance of a weakref subclass can have attributes.</span>
        <span class="c"># If such a weakref holds the only strong reference to the object,</span>
        <span class="c"># deleting the weakref will delete the object. In this case,</span>
        <span class="c"># the callback must not be called, because the ref object is</span>
        <span class="c"># being deleted.</span>
        <span class="k">class</span> <span class="nc">MyRef</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c"># Use a local callback, for &quot;regrtest -R::&quot;</span>
        <span class="c"># to detect refcounting problems</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="n">r1</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">del</span> <span class="n">o</span>

        <span class="k">del</span> <span class="n">r1</span> <span class="c"># Used to crash here</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># Same test, with two weakrefs to the same object</span>
        <span class="c"># (since code paths are different)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">MyRef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="n">r1</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r2</span>
        <span class="n">r2</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="k">del</span> <span class="n">r2</span>

        <span class="k">del</span> <span class="n">r1</span> <span class="c"># Used to crash here</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbcalled</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="WeakMethodTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase">[docs]</a><span class="k">class</span> <span class="nc">WeakMethodTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_subclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Object subclass overriding `some_method`.&quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">6</span>
        <span class="k">return</span> <span class="n">C</span>

<div class="viewcode-block" id="WeakMethodTestCase.test_alive"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_alive">[docs]</a>    <span class="k">def</span> <span class="nf">test_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ReferenceType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">r</span><span class="p">(),</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">__self__</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">r</span><span class="p">()</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="o">.</span><span class="n">__func__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="p">()(),</span> <span class="mi">4</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WeakMethodTestCase.test_object_dead"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_object_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">r</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WeakMethodTestCase.test_method_dead"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_method_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_method_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclass</span><span class="p">()</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">C</span><span class="o">.</span><span class="n">some_method</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">r</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WeakMethodTestCase.test_callback_when_object_dead"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_callback_when_object_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_when_object_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test callback behaviour when object dies first.</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclass</span><span class="p">()</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="c"># Callback is only called once.</span>
        <span class="n">C</span><span class="o">.</span><span class="n">some_method</span> <span class="o">=</span> <span class="n">Object</span><span class="o">.</span><span class="n">some_method</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="WeakMethodTestCase.test_callback_when_method_dead"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_callback_when_method_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_callback_when_method_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test callback behaviour when method dies first.</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclass</span><span class="p">()</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">C</span><span class="o">.</span><span class="n">some_method</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="c"># Callback is only called once.</span>
        <span class="k">del</span> <span class="n">o</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">])</span>
</div>
    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="WeakMethodTestCase.test_no_cycles"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_no_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># A WeakMethod doesn&#39;t create any reference cycle to itself.</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">some_method</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">wr</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WeakMethodTestCase.test_equality"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_equality">[docs]</a>    <span class="k">def</span> <span class="nf">test_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_ne</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">other_method</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">other_method</span><span class="p">)</span>
        <span class="c"># Objects equal, same method</span>
        <span class="n">_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">_eq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="c"># Objects equal, different method</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="c"># Objects unequal, same or different method</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">other_method</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">_ne</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="c"># Dead WeakMethods compare by identity</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span> <span class="ow">is</span> <span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">q</span> <span class="o">!=</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">r</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WeakMethodTestCase.test_hashing"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakMethodTestCase.test_hashing">[docs]</a>    <span class="k">def</span> <span class="nf">test_hashing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Alive WeakMethods are hashable if the underlying object is</span>
        <span class="c"># hashable.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">some_method</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakMethod</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">other_method</span><span class="p">)</span>
        <span class="c"># Since WeakMethod objects are equal, the hashes should be equal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">ha</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c"># Dead WeakMethods retain their old hash value</span>
        <span class="k">del</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">ha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">ha</span><span class="p">)</span>
        <span class="c"># If it wasn&#39;t hashed when alive, a dead WeakMethod cannot be hashed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="MappingTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase">[docs]</a><span class="k">class</span> <span class="nc">MappingTestCase</span><span class="p">(</span><span class="n">TestBase</span><span class="p">):</span>

    <span class="n">COUNT</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="MappingTestCase.check_len_cycles"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_len_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">check_len_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_type</span><span class="p">,</span> <span class="n">cons</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">RefCycle</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">dict_type</span><span class="p">(</span><span class="n">cons</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
        <span class="c"># Keep an iterator alive</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">del</span> <span class="n">items</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">it</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
        <span class="c"># one item may be kept alive inside the iterator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_len_cycles"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_len_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_len_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_len_cycles</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_len_cycles"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_len_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_len_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_len_cycles</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_len_race"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_len_race">[docs]</a>    <span class="k">def</span> <span class="nf">check_len_race</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_type</span><span class="p">,</span> <span class="n">cons</span><span class="p">):</span>
        <span class="c"># Extended sanity checks for len() in the face of cyclic collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">,</span> <span class="o">*</span><span class="n">gc</span><span class="o">.</span><span class="n">get_threshold</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">RefCycle</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="n">dict_type</span><span class="p">(</span><span class="n">cons</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">items</span>
            <span class="c"># All items will be collected at next garbage collection pass</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">it</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_len_race"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_len_race">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_len_race</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_len_race</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_len_race"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_len_race">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_len_race</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_len_race</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_values"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_values">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#</span>
        <span class="c">#  This exercises d.copy(), d.items(), d[], del d[], len(d).</span>
        <span class="c">#</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_valued_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">arg</span><span class="p">],</span>
                         <span class="s">&quot;wrong object returned by weak dict!&quot;</span><span class="p">)</span>
        <span class="n">items1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">items2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">items1</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">items2</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">items1</span><span class="p">,</span> <span class="n">items2</span><span class="p">,</span>
                     <span class="s">&quot;cloning of weak-valued dictionary did not work!&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">items1</span><span class="p">,</span> <span class="n">items2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s">&quot;deleting object did not cause dictionary update&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">objects</span><span class="p">,</span> <span class="n">o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s">&quot;deleting the values did not clear the dictionary&quot;</span><span class="p">)</span>
        <span class="c"># regression on SF bug #447152:</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keys"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keys">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#</span>
        <span class="c">#  This exercises d.copy(), d.items(), d[] = v, d[], del d[],</span>
        <span class="c">#  len(d), k in d.</span>
        <span class="c">#</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_keyed_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">getweakrefcount</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s">&quot;wrong number of weak references to </span><span class="si">%r</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="p">],</span>
                         <span class="s">&quot;wrong object returned by weak dict!&quot;</span><span class="p">)</span>
        <span class="n">items1</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">items2</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">items1</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">items2</span><span class="p">),</span>
                     <span class="s">&quot;cloning of weak-keyed dictionary did not work!&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">items1</span><span class="p">,</span> <span class="n">items2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                     <span class="s">&quot;deleting object did not cause dictionary update&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">objects</span><span class="p">,</span> <span class="n">o</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s">&quot;deleting the keys did not clear the dictionary&quot;</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;What is the meaning of the universe?&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_iters"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_iters">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_keyed_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_iters</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="c"># Test keyrefs()</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">keyrefs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
        <span class="n">objects2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wr</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">wr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span>
            <span class="n">objects2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># Test iterkeyrefs()</span>
        <span class="n">objects2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keyrefs</span><span class="p">())),</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">wr</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">keyrefs</span><span class="p">():</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">wr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span>
            <span class="n">objects2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_iters"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_iters">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_valued_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_iters</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="c"># Test valuerefs()</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">valuerefs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
        <span class="n">objects2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wr</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">wr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">objects2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># Test itervaluerefs()</span>
        <span class="n">objects2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">itervaluerefs</span><span class="p">())),</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">wr</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">itervaluerefs</span><span class="p">():</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">wr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">objects2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_iters"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_iters">[docs]</a>    <span class="k">def</span> <span class="nf">check_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c"># item iterator:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="s">&quot;items() did not touch all items&quot;</span><span class="p">)</span>

        <span class="c"># key iterator, via __iter__():</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="s">&quot;__iter__() did not touch all keys&quot;</span><span class="p">)</span>

        <span class="c"># key iterator, via iterkeys():</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="s">&quot;iterkeys() did not touch all keys&quot;</span><span class="p">)</span>

        <span class="c"># value iterator:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">values</span><span class="p">,</span>
                     <span class="s">&quot;itervalues() did not touch all values&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_weak_destroy_while_iterating"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_weak_destroy_while_iterating">[docs]</a>    <span class="k">def</span> <span class="nf">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">iter_name</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">iter_name</span><span class="p">)())</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>             <span class="c"># Trigger internal iteration</span>
        <span class="c"># Destroy an object</span>
        <span class="k">del</span> <span class="n">objects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>    <span class="c"># just in case</span>
        <span class="c"># We have removed either the first consumed object, or another one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="p">)),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">it</span>
        <span class="c"># The removal has been committed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_weak_destroy_and_mutate_while_iterating"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_weak_destroy_and_mutate_while_iterating">[docs]</a>    <span class="k">def</span> <span class="nf">check_weak_destroy_and_mutate_while_iterating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">testcontext</span><span class="p">):</span>
        <span class="c"># Check that we can explicitly mutate the weak dict without</span>
        <span class="c"># interfering with delayed removal.</span>
        <span class="c"># `testcontext` should create an iterator, destroy one of the</span>
        <span class="c"># weakref&#39;ed objects and then return a new key/value pair corresponding</span>
        <span class="c"># to the destroyed object.</span>
        <span class="k">with</span> <span class="n">testcontext</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">testcontext</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">testcontext</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">testcontext</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">ddict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">testcontext</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="nb">dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ddict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">ddict</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">testcontext</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="nb">dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keys_destroy_while_iterating"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keys_destroy_while_iterating">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keys_destroy_while_iterating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #7105: iterators shouldn&#39;t crash when a key is implicitly removed</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_keyed_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;keys&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;values&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;keyrefs&#39;</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_keyed_dict</span><span class="p">()</span>
        <span class="nd">@contextlib.contextmanager</span>
        <span class="k">def</span> <span class="nf">testcontext</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                <span class="c"># Schedule a key/value for removal and recreate it</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">arg</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>      <span class="c"># just in case</span>
                <span class="k">yield</span> <span class="n">Object</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">v</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="bp">None</span>           <span class="c"># should commit all removals</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_and_mutate_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">testcontext</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_values_destroy_while_iterating"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_values_destroy_while_iterating">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_values_destroy_while_iterating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #7105: iterators shouldn&#39;t crash when a key is implicitly removed</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_valued_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;keys&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;values&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;itervaluerefs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="s">&#39;valuerefs&#39;</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_weak_valued_dict</span><span class="p">()</span>
        <span class="nd">@contextlib.contextmanager</span>
        <span class="k">def</span> <span class="nf">testcontext</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                <span class="c"># Schedule a key/value for removal and recreate it</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">arg</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>      <span class="c"># just in case</span>
                <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">Object</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">it</span> <span class="o">=</span> <span class="bp">None</span>           <span class="c"># should commit all removals</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_weak_destroy_and_mutate_while_iterating</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">testcontext</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_make_weak_keyed_dict_from_dict"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_make_weak_keyed_dict_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">test_make_weak_keyed_dict_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">({</span><span class="n">o</span><span class="p">:</span><span class="mi">364</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="mi">364</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_make_weak_keyed_dict_from_weak_keyed_dict"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_make_weak_keyed_dict_from_weak_keyed_dict">[docs]</a>    <span class="k">def</span> <span class="nf">test_make_weak_keyed_dict_from_weak_keyed_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">({</span><span class="n">o</span><span class="p">:</span><span class="mi">364</span><span class="p">})</span>
        <span class="n">dict2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="mi">364</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.make_weak_keyed_dict"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.make_weak_keyed_dict">[docs]</a>    <span class="k">def</span> <span class="nf">make_weak_keyed_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_make_weak_valued_dict_from_dict"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_make_weak_valued_dict_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">test_make_weak_valued_dict_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">({</span><span class="mi">364</span><span class="p">:</span><span class="n">o</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="mi">364</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_make_weak_valued_dict_from_weak_valued_dict"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_make_weak_valued_dict_from_weak_valued_dict">[docs]</a>    <span class="k">def</span> <span class="nf">test_make_weak_valued_dict_from_weak_valued_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">({</span><span class="mi">364</span><span class="p">:</span><span class="n">o</span><span class="p">})</span>
        <span class="n">dict2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="mi">364</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.make_weak_valued_dict"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.make_weak_valued_dict">[docs]</a>    <span class="k">def</span> <span class="nf">make_weak_valued_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">objects</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_popitem"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_popitem">[docs]</a>    <span class="k">def</span> <span class="nf">check_popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">value1</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span><span class="p">):</span>
        <span class="n">weakdict</span> <span class="o">=</span> <span class="n">klass</span><span class="p">()</span>
        <span class="n">weakdict</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value1</span>
        <span class="n">weakdict</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weakdict</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weakdict</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="n">key1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weakdict</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="n">key1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_dict_popitem"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_dict_popitem">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_dict_popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_popitem</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">,</span>
                           <span class="s">&quot;key1&quot;</span><span class="p">,</span> <span class="n">C</span><span class="p">(),</span> <span class="s">&quot;key2&quot;</span><span class="p">,</span> <span class="n">C</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_dict_popitem"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_dict_popitem">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_dict_popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_popitem</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">,</span>
                           <span class="n">C</span><span class="p">(),</span> <span class="s">&quot;value 1&quot;</span><span class="p">,</span> <span class="n">C</span><span class="p">(),</span> <span class="s">&quot;value 2&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_setdefault"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_setdefault">[docs]</a>    <span class="k">def</span> <span class="nf">check_setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNot</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span>
                     <span class="s">&quot;invalid test&quot;</span>
                     <span class="s">&quot; -- value parameters must be distinct objects&quot;</span><span class="p">)</span>
        <span class="n">weakdict</span> <span class="o">=</span> <span class="n">klass</span><span class="p">()</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">weakdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">weakdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">weakdict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value1</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">weakdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">weakdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">weakdict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_dict_setdefault"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_dict_setdefault">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_dict_setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_setdefault</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">,</span>
                              <span class="s">&quot;key&quot;</span><span class="p">,</span> <span class="n">C</span><span class="p">(),</span> <span class="n">C</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_dict_setdefault"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_dict_setdefault">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_dict_setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_setdefault</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">,</span>
                              <span class="n">C</span><span class="p">(),</span> <span class="s">&quot;value 1&quot;</span><span class="p">,</span> <span class="s">&quot;value 2&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.check_update"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.check_update">[docs]</a>    <span class="k">def</span> <span class="nf">check_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c">#</span>
        <span class="c">#  This exercises d.update(), len(d), d.keys(), k in d,</span>
        <span class="c">#  d.get(), d[].</span>
        <span class="c">#</span>
        <span class="n">weakdict</span> <span class="o">=</span> <span class="n">klass</span><span class="p">()</span>
        <span class="n">weakdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weakdict</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="s">&quot;mysterious new key appeared in weak dict&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weakdict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">weakdict</span><span class="p">,</span> <span class="s">&quot;original key disappeared in weak dict&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weakdict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weakdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_dict_update"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_dict_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_dict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_update</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">,</span>
                          <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">C</span><span class="p">(),</span> <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">(),</span> <span class="n">C</span><span class="p">():</span> <span class="n">C</span><span class="p">()})</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_dict_update"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_dict_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_dict_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_update</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">,</span>
                          <span class="p">{</span><span class="n">C</span><span class="p">():</span> <span class="mi">1</span><span class="p">,</span> <span class="n">C</span><span class="p">():</span> <span class="mi">2</span><span class="p">,</span> <span class="n">C</span><span class="p">():</span> <span class="mi">3</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_delitem"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_delitem">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_delitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="n">o1</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">o2</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;something&#39;</span>
        <span class="n">d</span><span class="p">[</span><span class="n">o2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;something&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">[</span><span class="n">o2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_valued_delitem"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_valued_delitem">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_valued_delitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="n">o1</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">o2</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;something&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o1</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;something else&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">o2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;something&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="p">[(</span><span class="s">&#39;something else&#39;</span><span class="p">,</span> <span class="n">o2</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_bad_delitem"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_bad_delitem">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_bad_delitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Object</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
        <span class="c"># An attempt to delete an object that isn&#39;t there should raise</span>
        <span class="c"># KeyError.  It didn&#39;t before 2.3.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>

        <span class="c"># If a key isn&#39;t of a weakly referencable type, __getitem__ and</span>
        <span class="c"># __setitem__ raise TypeError.  __delitem__ should too.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">,</span>  <span class="mi">13</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span>  <span class="mi">13</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MappingTestCase.test_weak_keyed_cascading_deletes"><a class="viewcode-back" href="../../test.html#test.test_weakref.MappingTestCase.test_weak_keyed_cascading_deletes">[docs]</a>    <span class="k">def</span> <span class="nf">test_weak_keyed_cascading_deletes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># SF bug 742860.  For some reason, before 2.3 __delitem__ iterated</span>
        <span class="c"># over the keys via self.data.iterkeys().  If things vanished from</span>
        <span class="c"># the dict during this (or got added), that caused a RuntimeError.</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="n">mutate</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mutate</span><span class="p">:</span>
                    <span class="c"># Side effect that mutates the dict, by removing the</span>
                    <span class="c"># last strong reference to a key.</span>
                    <span class="k">del</span> <span class="n">objs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span>

        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">value</span>
        <span class="k">del</span> <span class="n">o</span>   <span class="c"># now the only strong references to keys are in objs</span>
        <span class="c"># Find the order in which iterkeys sees the keys.</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c"># Reverse it, so that the iteration implementation of __delitem__</span>
        <span class="c"># has to keep looping to find the first object we delete.</span>
        <span class="n">objs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="c"># Turn on mutation in C.__eq__.  The first time thru the loop,</span>
        <span class="c"># under the iterkeys() business the first comparison will delete</span>
        <span class="c"># the last item iterkeys() would see, and that causes a</span>
        <span class="c">#     RuntimeError: dictionary changed size during iteration</span>
        <span class="c"># when the iterkeys() loop goes around to try comparing the next</span>
        <span class="c"># key.  After this was fixed, it just deletes the last object *our*</span>
        <span class="c"># &quot;for o in obj&quot; loop would have gotten to.</span>
        <span class="n">mutate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</div></div>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">mapping_tests</span>

<div class="viewcode-block" id="WeakValueDictionaryTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakValueDictionaryTestCase">[docs]</a><span class="k">class</span> <span class="nc">WeakValueDictionaryTestCase</span><span class="p">(</span><span class="n">mapping_tests</span><span class="o">.</span><span class="n">BasicTestMappingProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that WeakValueDictionary conforms to the mapping protocol&quot;&quot;&quot;</span>
    <span class="n">__ref</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;key1&quot;</span><span class="p">:</span><span class="n">Object</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;key2&quot;</span><span class="p">:</span><span class="n">Object</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s">&quot;key3&quot;</span><span class="p">:</span><span class="n">Object</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>
    <span class="n">type2test</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span>
    <span class="k">def</span> <span class="nf">_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="WeakKeyDictionaryTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.WeakKeyDictionaryTestCase">[docs]</a><span class="k">class</span> <span class="nc">WeakKeyDictionaryTestCase</span><span class="p">(</span><span class="n">mapping_tests</span><span class="o">.</span><span class="n">BasicTestMappingProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that WeakKeyDictionary conforms to the mapping protocol&quot;&quot;&quot;</span>
    <span class="n">__ref</span> <span class="o">=</span> <span class="p">{</span><span class="n">Object</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span> <span class="n">Object</span><span class="p">(</span><span class="s">&quot;key2&quot;</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span> <span class="n">Object</span><span class="p">(</span><span class="s">&quot;key3&quot;</span><span class="p">):</span><span class="mi">3</span><span class="p">}</span>
    <span class="n">type2test</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span>
    <span class="k">def</span> <span class="nf">_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="FinalizeTestCase"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase">[docs]</a><span class="k">class</span> <span class="nc">FinalizeTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="FinalizeTestCase.A"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase.A">[docs]</a>    <span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
        <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">_collect_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># we create no ref-cycles so in CPython no gc should be needed</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">implementation</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;cpython&#39;</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>

<div class="viewcode-block" id="FinalizeTestCase.test_finalize"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase.test_finalize">[docs]</a>    <span class="k">def</span> <span class="nf">test_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">89</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">alive</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">(),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">43</span><span class="p">),</span> <span class="p">{</span><span class="s">&#39;z&#39;</span><span class="p">:</span><span class="mi">89</span><span class="p">}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="mi">199</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">alive</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="mi">199</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">89</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">(),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">89</span><span class="p">),</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">89</span><span class="p">),</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">alive</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">67</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">43</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">89</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_if_necessary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">alive</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="mi">199</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="FinalizeTestCase.test_order"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase.test_order">[docs]</a>    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="s">&#39;f1&#39;</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="s">&#39;f2&#39;</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="s">&#39;f3&#39;</span><span class="p">)</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">)</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="s">&#39;f5&#39;</span><span class="p">)</span>

        <span class="c"># make sure finalizers can keep themselves alive</span>
        <span class="k">del</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">alive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f3</span><span class="o">.</span><span class="n">alive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f5</span><span class="o">.</span><span class="n">alive</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f5</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">f5</span><span class="o">.</span><span class="n">alive</span><span class="p">)</span>

        <span class="n">f5</span><span class="p">()</span>                       <span class="c"># nothing because previously unregistered</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">f3</span><span class="p">()</span>                       <span class="c"># =&gt; res.append(&#39;f3&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">f3</span><span class="o">.</span><span class="n">alive</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">f3</span><span class="p">()</span>                       <span class="c"># nothing because previously called</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_if_necessary</span><span class="p">()</span>
                                   <span class="c"># =&gt; res.append(&#39;f4&#39;)</span>
                                   <span class="c"># =&gt; res.append(&#39;f2&#39;)</span>
                                   <span class="c"># =&gt; res.append(&#39;f1&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">alive</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">)</span>
        <span class="n">f2</span><span class="p">()</span>                       <span class="c"># nothing because previously called by gc</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;f3&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">,</span> <span class="s">&#39;f2&#39;</span><span class="p">,</span> <span class="s">&#39;f1&#39;</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FinalizeTestCase.test_all_freed"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase.test_all_freed">[docs]</a>    <span class="k">def</span> <span class="nf">test_all_freed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># we want a weakrefable subclass of weakref.finalize</span>
        <span class="k">class</span> <span class="nc">MyFinalizer</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">MyFinalizer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

        <span class="n">wr_callback</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">wr_f</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">callback</span><span class="p">,</span> <span class="n">f</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">wr_callback</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">wr_f</span><span class="p">())</span>

        <span class="k">del</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_if_necessary</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">wr_callback</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">wr_f</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="mi">123</span><span class="p">])</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="FinalizeTestCase.run_in_child"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase.run_in_child">[docs]</a>    <span class="k">def</span> <span class="nf">run_in_child</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">error</span><span class="p">():</span>
            <span class="c"># Create an atexit finalizer from inside a finalizer called</span>
            <span class="c"># at exit.  This should be the next to be run.</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="k">print</span><span class="p">,</span> <span class="s">&#39;g1&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;f3 error&#39;</span><span class="p">)</span>
            <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>

        <span class="c"># cls should stay alive till atexit callbacks run</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="k">print</span><span class="p">,</span> <span class="s">&#39;f1&#39;</span><span class="p">,</span> <span class="n">_global_var</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="k">print</span><span class="p">,</span> <span class="s">&#39;f2&#39;</span><span class="p">,</span> <span class="n">_global_var</span><span class="p">)</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="k">print</span><span class="p">,</span> <span class="s">&#39;f4&#39;</span><span class="p">,</span> <span class="n">_global_var</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">f1</span><span class="o">.</span><span class="n">atexit</span> <span class="o">==</span> <span class="bp">True</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">atexit</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">f3</span><span class="o">.</span><span class="n">atexit</span> <span class="o">==</span> <span class="bp">True</span>
        <span class="k">assert</span> <span class="n">f4</span><span class="o">.</span><span class="n">atexit</span> <span class="o">==</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="FinalizeTestCase.test_atexit"><a class="viewcode-back" href="../../test.html#test.test_weakref.FinalizeTestCase.test_atexit">[docs]</a>    <span class="k">def</span> <span class="nf">test_atexit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;from test.test_weakref import FinalizeTestCase;&#39;</span><span class="o">+</span>
                <span class="s">&#39;FinalizeTestCase.run_in_child()&#39;</span><span class="p">)</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">script_helper</span><span class="o">.</span><span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">prog</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;f4 foobar&#39;</span><span class="p">,</span> <span class="s">&#39;f3 error&#39;</span><span class="p">,</span> <span class="s">&#39;g1&#39;</span><span class="p">,</span> <span class="s">&#39;f1 foobar&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;ZeroDivisionError&#39;</span> <span class="ow">in</span> <span class="n">err</span><span class="p">)</span>

</div></div>
<span class="n">libreftest</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot; Doctest for examples in the library reference: weakref.rst</span>

<span class="s">&gt;&gt;&gt; import weakref</span>
<span class="s">&gt;&gt;&gt; class Dict(dict):</span>
<span class="s">...     pass</span>
<span class="s">...</span>
<span class="s">&gt;&gt;&gt; obj = Dict(red=1, green=2, blue=3)   # this object is weak referencable</span>
<span class="s">&gt;&gt;&gt; r = weakref.ref(obj)</span>
<span class="s">&gt;&gt;&gt; print(r() is obj)</span>
<span class="s">True</span>

<span class="s">&gt;&gt;&gt; import weakref</span>
<span class="s">&gt;&gt;&gt; class Object:</span>
<span class="s">...     pass</span>
<span class="s">...</span>
<span class="s">&gt;&gt;&gt; o = Object()</span>
<span class="s">&gt;&gt;&gt; r = weakref.ref(o)</span>
<span class="s">&gt;&gt;&gt; o2 = r()</span>
<span class="s">&gt;&gt;&gt; o is o2</span>
<span class="s">True</span>
<span class="s">&gt;&gt;&gt; del o, o2</span>
<span class="s">&gt;&gt;&gt; print(r())</span>
<span class="s">None</span>

<span class="s">&gt;&gt;&gt; import weakref</span>
<span class="s">&gt;&gt;&gt; class ExtendedRef(weakref.ref):</span>
<span class="s">...     def __init__(self, ob, callback=None, **annotations):</span>
<span class="s">...         super().__init__(ob, callback)</span>
<span class="s">...         self.__counter = 0</span>
<span class="s">...         for k, v in annotations.items():</span>
<span class="s">...             setattr(self, k, v)</span>
<span class="s">...     def __call__(self):</span>
<span class="s">...         &#39;&#39;&#39;Return a pair containing the referent and the number of</span>
<span class="s">...         times the reference has been called.</span>
<span class="s">...         &#39;&#39;&#39;</span>
<span class="s">...         ob = super().__call__()</span>
<span class="s">...         if ob is not None:</span>
<span class="s">...             self.__counter += 1</span>
<span class="s">...             ob = (ob, self.__counter)</span>
<span class="s">...         return ob</span>
<span class="s">...</span>
<span class="s">&gt;&gt;&gt; class A:   # not in docs from here, just testing the ExtendedRef</span>
<span class="s">...     pass</span>
<span class="s">...</span>
<span class="s">&gt;&gt;&gt; a = A()</span>
<span class="s">&gt;&gt;&gt; r = ExtendedRef(a, foo=1, bar=&quot;baz&quot;)</span>
<span class="s">&gt;&gt;&gt; r.foo</span>
<span class="s">1</span>
<span class="s">&gt;&gt;&gt; r.bar</span>
<span class="s">&#39;baz&#39;</span>
<span class="s">&gt;&gt;&gt; r()[1]</span>
<span class="s">1</span>
<span class="s">&gt;&gt;&gt; r()[1]</span>
<span class="s">2</span>
<span class="s">&gt;&gt;&gt; r()[0] is a</span>
<span class="s">True</span>


<span class="s">&gt;&gt;&gt; import weakref</span>
<span class="s">&gt;&gt;&gt; _id2obj_dict = weakref.WeakValueDictionary()</span>
<span class="s">&gt;&gt;&gt; def remember(obj):</span>
<span class="s">...     oid = id(obj)</span>
<span class="s">...     _id2obj_dict[oid] = obj</span>
<span class="s">...     return oid</span>
<span class="s">...</span>
<span class="s">&gt;&gt;&gt; def id2obj(oid):</span>
<span class="s">...     return _id2obj_dict[oid]</span>
<span class="s">...</span>
<span class="s">&gt;&gt;&gt; a = A()             # from here, just testing</span>
<span class="s">&gt;&gt;&gt; a_id = remember(a)</span>
<span class="s">&gt;&gt;&gt; id2obj(a_id) is a</span>
<span class="s">True</span>
<span class="s">&gt;&gt;&gt; del a</span>
<span class="s">&gt;&gt;&gt; try:</span>
<span class="s">...     id2obj(a_id)</span>
<span class="s">... except KeyError:</span>
<span class="s">...     print(&#39;OK&#39;)</span>
<span class="s">... else:</span>
<span class="s">...     print(&#39;WeakValueDictionary error&#39;)</span>
<span class="s">OK</span>

<span class="s">&quot;&quot;&quot;</span>

<span class="n">__test__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;libreftest&#39;</span> <span class="p">:</span> <span class="n">libreftest</span><span class="p">}</span>

<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_weakref.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span>
        <span class="n">ReferencesTestCase</span><span class="p">,</span>
        <span class="n">WeakMethodTestCase</span><span class="p">,</span>
        <span class="n">MappingTestCase</span><span class="p">,</span>
        <span class="n">WeakValueDictionaryTestCase</span><span class="p">,</span>
        <span class="n">WeakKeyDictionaryTestCase</span><span class="p">,</span>
        <span class="n">SubclassableWeakrefTestCase</span><span class="p">,</span>
        <span class="n">FinalizeTestCase</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">support</span><span class="o">.</span><span class="n">run_doctest</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">__name__</span><span class="p">])</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>