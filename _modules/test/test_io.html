

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_io &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_io</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_io</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Unit tests for the io module.&quot;&quot;&quot;</span>

<span class="c"># Tests of io are scattered over the test suite:</span>
<span class="c"># * test_bufio - tests file buffering</span>
<span class="c"># * test_memoryio - tests BytesIO and StringIO</span>
<span class="c"># * test_fileio - tests FileIO</span>
<span class="c"># * test_file - tests the file interface</span>
<span class="c"># * test_io - tests everything else in the io module</span>
<span class="c"># * test_univnewlines - tests universal newline support</span>
<span class="c"># * test_largefile - tests operations on a file greater than 2**32 bytes</span>
<span class="c">#     (only enabled with -ulargefile)</span>

<span class="c">################################################################################</span>
<span class="c"># ATTENTION TEST WRITERS!!!</span>
<span class="c">################################################################################</span>
<span class="c"># When writing tests for io, it&#39;s important to test both the C and Python</span>
<span class="c"># implementations. This is usually done by writing a base test that refers to</span>
<span class="c"># the type it is testing as a attribute. Then it provides custom subclasses to</span>
<span class="c"># test both implementations. This file has lots of examples.</span>
<span class="c">################################################################################</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">UserList</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">count</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">from</span> <span class="nn">test.script_helper</span> <span class="kn">import</span> <span class="n">assert_python_ok</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">io</span>  <span class="c"># C implementation of io</span>
<span class="kn">import</span> <span class="nn">_pyio</span> <span class="kn">as</span> <span class="nn">pyio</span> <span class="c"># Python implementation of io</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_default_chunk_size</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the default TextIOWrapper chunk size&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span>


<div class="viewcode-block" id="MockRawIOWithoutRead"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead">[docs]</a><span class="k">class</span> <span class="nc">MockRawIOWithoutRead</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A RawIO implementation without read(), so as to exercise the default</span>
<span class="sd">    RawIO.read() which calls readinto().&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_stack</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">read_stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reads</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extraneous_reads</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="MockRawIOWithoutRead.write"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.writable"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.writable">[docs]</a>    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.fileno"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.fileno">[docs]</a>    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.readable"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.readable">[docs]</a>    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.seekable"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.seekable">[docs]</a>    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.seek"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.seek">[docs]</a>    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">whence</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>   <span class="c"># wrong but we gotta return something</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.tell"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.tell">[docs]</a>    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>   <span class="c"># same comment as above</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.readinto"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.readinto">[docs]</a>    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reads</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extraneous_reads</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_len</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">buf</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">max_len</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">max_len</span>
</div>
<div class="viewcode-block" id="MockRawIOWithoutRead.truncate"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIOWithoutRead.truncate">[docs]</a>    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pos</span>
</div></div>
<div class="viewcode-block" id="CMockRawIOWithoutRead"><a class="viewcode-back" href="../../test.html#test.test_io.CMockRawIOWithoutRead">[docs]</a><span class="k">class</span> <span class="nc">CMockRawIOWithoutRead</span><span class="p">(</span><span class="n">MockRawIOWithoutRead</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PyMockRawIOWithoutRead"><a class="viewcode-back" href="../../test.html#test.test_io.PyMockRawIOWithoutRead">[docs]</a><span class="k">class</span> <span class="nc">PyMockRawIOWithoutRead</span><span class="p">(</span><span class="n">MockRawIOWithoutRead</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="MockRawIO"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIO">[docs]</a><span class="k">class</span> <span class="nc">MockRawIO</span><span class="p">(</span><span class="n">MockRawIOWithoutRead</span><span class="p">):</span>

<div class="viewcode-block" id="MockRawIO.read"><a class="viewcode-back" href="../../test.html#test.test_io.MockRawIO.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reads</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extraneous_reads</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">b</span><span class="s">&quot;&quot;</span>
</div></div>
<div class="viewcode-block" id="CMockRawIO"><a class="viewcode-back" href="../../test.html#test.test_io.CMockRawIO">[docs]</a><span class="k">class</span> <span class="nc">CMockRawIO</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PyMockRawIO"><a class="viewcode-back" href="../../test.html#test.test_io.PyMockRawIO">[docs]</a><span class="k">class</span> <span class="nc">PyMockRawIO</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="MisbehavedRawIO"><a class="viewcode-back" href="../../test.html#test.test_io.MisbehavedRawIO">[docs]</a><span class="k">class</span> <span class="nc">MisbehavedRawIO</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">):</span>
<div class="viewcode-block" id="MisbehavedRawIO.write"><a class="viewcode-back" href="../../test.html#test.test_io.MisbehavedRawIO.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</div>
<div class="viewcode-block" id="MisbehavedRawIO.read"><a class="viewcode-back" href="../../test.html#test.test_io.MisbehavedRawIO.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</div>
<div class="viewcode-block" id="MisbehavedRawIO.seek"><a class="viewcode-back" href="../../test.html#test.test_io.MisbehavedRawIO.seek">[docs]</a>    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">whence</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">123</span>
</div>
<div class="viewcode-block" id="MisbehavedRawIO.tell"><a class="viewcode-back" href="../../test.html#test.test_io.MisbehavedRawIO.tell">[docs]</a>    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">456</span>
</div>
<div class="viewcode-block" id="MisbehavedRawIO.readinto"><a class="viewcode-back" href="../../test.html#test.test_io.MisbehavedRawIO.readinto">[docs]</a>    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
</div></div>
<div class="viewcode-block" id="CMisbehavedRawIO"><a class="viewcode-back" href="../../test.html#test.test_io.CMisbehavedRawIO">[docs]</a><span class="k">class</span> <span class="nc">CMisbehavedRawIO</span><span class="p">(</span><span class="n">MisbehavedRawIO</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PyMisbehavedRawIO"><a class="viewcode-back" href="../../test.html#test.test_io.PyMisbehavedRawIO">[docs]</a><span class="k">class</span> <span class="nc">PyMisbehavedRawIO</span><span class="p">(</span><span class="n">MisbehavedRawIO</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CloseFailureIO"><a class="viewcode-back" href="../../test.html#test.test_io.CloseFailureIO">[docs]</a><span class="k">class</span> <span class="nc">CloseFailureIO</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">):</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="CloseFailureIO.close"><a class="viewcode-back" href="../../test.html#test.test_io.CloseFailureIO.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">raise</span> <span class="ne">OSError</span>
</div></div>
<div class="viewcode-block" id="CCloseFailureIO"><a class="viewcode-back" href="../../test.html#test.test_io.CCloseFailureIO">[docs]</a><span class="k">class</span> <span class="nc">CCloseFailureIO</span><span class="p">(</span><span class="n">CloseFailureIO</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PyCloseFailureIO"><a class="viewcode-back" href="../../test.html#test.test_io.PyCloseFailureIO">[docs]</a><span class="k">class</span> <span class="nc">PyCloseFailureIO</span><span class="p">(</span><span class="n">CloseFailureIO</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="MockFileIO"><a class="viewcode-back" href="../../test.html#test.test_io.MockFileIO">[docs]</a><span class="k">class</span> <span class="nc">MockFileIO</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="MockFileIO.read"><a class="viewcode-back" href="../../test.html#test.test_io.MockFileIO.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span> <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="MockFileIO.readinto"><a class="viewcode-back" href="../../test.html#test.test_io.MockFileIO.readinto">[docs]</a>    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</div></div>
<div class="viewcode-block" id="CMockFileIO"><a class="viewcode-back" href="../../test.html#test.test_io.CMockFileIO">[docs]</a><span class="k">class</span> <span class="nc">CMockFileIO</span><span class="p">(</span><span class="n">MockFileIO</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PyMockFileIO"><a class="viewcode-back" href="../../test.html#test.test_io.PyMockFileIO">[docs]</a><span class="k">class</span> <span class="nc">PyMockFileIO</span><span class="p">(</span><span class="n">MockFileIO</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="MockUnseekableIO"><a class="viewcode-back" href="../../test.html#test.test_io.MockUnseekableIO">[docs]</a><span class="k">class</span> <span class="nc">MockUnseekableIO</span><span class="p">:</span>
<div class="viewcode-block" id="MockUnseekableIO.seekable"><a class="viewcode-back" href="../../test.html#test.test_io.MockUnseekableIO.seekable">[docs]</a>    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="MockUnseekableIO.seek"><a class="viewcode-back" href="../../test.html#test.test_io.MockUnseekableIO.seek">[docs]</a>    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s">&quot;not seekable&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MockUnseekableIO.tell"><a class="viewcode-back" href="../../test.html#test.test_io.MockUnseekableIO.tell">[docs]</a>    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s">&quot;not seekable&quot;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="CMockUnseekableIO"><a class="viewcode-back" href="../../test.html#test.test_io.CMockUnseekableIO">[docs]</a><span class="k">class</span> <span class="nc">CMockUnseekableIO</span><span class="p">(</span><span class="n">MockUnseekableIO</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
    <span class="n">UnsupportedOperation</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">UnsupportedOperation</span>
</div>
<div class="viewcode-block" id="PyMockUnseekableIO"><a class="viewcode-back" href="../../test.html#test.test_io.PyMockUnseekableIO">[docs]</a><span class="k">class</span> <span class="nc">PyMockUnseekableIO</span><span class="p">(</span><span class="n">MockUnseekableIO</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
    <span class="n">UnsupportedOperation</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">UnsupportedOperation</span>

</div>
<div class="viewcode-block" id="MockNonBlockWriterIO"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO">[docs]</a><span class="k">class</span> <span class="nc">MockNonBlockWriterIO</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocker_char</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="MockNonBlockWriterIO.pop_written"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO.pop_written">[docs]</a>    <span class="k">def</span> <span class="nf">pop_written</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="MockNonBlockWriterIO.block_on"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO.block_on">[docs]</a>    <span class="k">def</span> <span class="nf">block_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block when a given char is encountered.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocker_char</span> <span class="o">=</span> <span class="n">char</span>
</div>
<div class="viewcode-block" id="MockNonBlockWriterIO.readable"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO.readable">[docs]</a>    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MockNonBlockWriterIO.seekable"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO.seekable">[docs]</a>    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MockNonBlockWriterIO.writable"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO.writable">[docs]</a>    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MockNonBlockWriterIO.write"><a class="viewcode-back" href="../../test.html#test.test_io.MockNonBlockWriterIO.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocker_char</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocker_char</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># write data up to the first blocker</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">n</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># cancel blocker and indicate would block</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_blocker_char</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="CMockNonBlockWriterIO"><a class="viewcode-back" href="../../test.html#test.test_io.CMockNonBlockWriterIO">[docs]</a><span class="k">class</span> <span class="nc">CMockNonBlockWriterIO</span><span class="p">(</span><span class="n">MockNonBlockWriterIO</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="n">BlockingIOError</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BlockingIOError</span>
</div>
<div class="viewcode-block" id="PyMockNonBlockWriterIO"><a class="viewcode-back" href="../../test.html#test.test_io.PyMockNonBlockWriterIO">[docs]</a><span class="k">class</span> <span class="nc">PyMockNonBlockWriterIO</span><span class="p">(</span><span class="n">MockNonBlockWriterIO</span><span class="p">,</span> <span class="n">pyio</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="n">BlockingIOError</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BlockingIOError</span>

</div>
<div class="viewcode-block" id="IOTest"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest">[docs]</a><span class="k">class</span> <span class="nc">IOTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="IOTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.write_ops"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.write_ops">[docs]</a>    <span class="k">def</span> <span class="nf">write_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;blah.&quot;</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;blah.&quot;</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;Hello.&quot;</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot; world</span><span class="se">\n\n\n</span><span class="s">&quot;</span><span class="p">)),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;h&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">13</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">13</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.read_ops"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.read_ops">[docs]</a>    <span class="k">def</span> <span class="nf">read_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">buffered</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot; worl&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span><span class="s">&quot;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;hello world</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;x&quot;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;world&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot; worl&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buffered</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;hello world</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;world</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
    <span class="n">LARGE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span>

<div class="viewcode-block" id="IOTest.large_file_ops"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.large_file_ops">[docs]</a>    <span class="k">def</span> <span class="nf">large_file_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">readable</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">writable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_invalid_operations"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_invalid_operations">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try writing on a file opened in read mode and vice-versa.</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;blah&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;blah</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;blah&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;blah</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="s">&quot;blah&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;blah</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">])</span>
            <span class="c"># Non-zero seeking from current or end pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_open_handles_NUL_chars"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_open_handles_NUL_chars">[docs]</a>    <span class="k">def</span> <span class="nf">test_open_handles_NUL_chars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn_with_NUL</span> <span class="o">=</span> <span class="s">&#39;foo</span><span class="se">\0</span><span class="s">bar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">fn_with_NUL</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">fn_with_NUL</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_raw_file_io"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_raw_file_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_raw_file_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">writable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seekable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_ops</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">writable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seekable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_ops</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_buffered_file_io"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_buffered_file_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_buffered_file_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">writable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seekable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_ops</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">writable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seekable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_ops</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_readline"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_readline">[docs]</a>    <span class="k">def</span> <span class="nf">test_readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">def</span><span class="se">\n</span><span class="s">xyzzy</span><span class="se">\n</span><span class="s">foo</span><span class="se">\x00</span><span class="s">bar</span><span class="se">\n</span><span class="s">another line&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;zzy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;foo</span><span class="se">\x00</span><span class="s">bar</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;another line&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="mf">5.3</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="mf">5.3</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_raw_bytes_io"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_raw_bytes_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_raw_bytes_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_ops</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;hello world</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_ops</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_large_file_ops"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_large_file_ops">[docs]</a>    <span class="k">def</span> <span class="nf">test_large_file_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># On Windows and Mac OSX this test comsumes large resources; It takes</span>
        <span class="c"># a long time to build the &gt;2GB file and takes &gt;2GB of disk space</span>
        <span class="c"># therefore the resource must be enabled to run this test.</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;win&#39;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">requires</span><span class="p">(</span>
                <span class="s">&#39;largefile&#39;</span><span class="p">,</span>
                <span class="s">&#39;test requires </span><span class="si">%s</span><span class="s"> bytes and a long time to run&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+b&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large_file_ops</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large_file_ops</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_with_open"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_with_open">[docs]</a>    <span class="k">def</span> <span class="nf">test_with_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bufsize</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;1/0 didn&#39;t raise an exception&quot;</span><span class="p">)</span>

    <span class="c"># issue 5008</span></div>
<div class="viewcode-block" id="IOTest.test_append_mode_tell"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_append_mode_tell">[docs]</a>    <span class="k">def</span> <span class="nf">test_append_mode_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;ab&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">class</span> <span class="nc">MyFileIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FileIO</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__del__</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">MyFileIO</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">f</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_base_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">class</span> <span class="nc">MyIO</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c"># This exercises the availability of attributes on object</span>
                <span class="c"># destruction.</span>
                <span class="c"># (in the C version, close() is called by the tp_dealloc</span>
                <span class="c"># function, not by __del__)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_del</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_close</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_flush</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_del</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__del__</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_close</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_flush</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">MyIO</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">f</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<div class="viewcode-block" id="IOTest.test_IOBase_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_IOBase_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_IOBase_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_base_destructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_RawIOBase_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_RawIOBase_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_RawIOBase_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_base_destructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_BufferedIOBase_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_BufferedIOBase_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_BufferedIOBase_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_base_destructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_TextIOBase_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_TextIOBase_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_TextIOBase_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_base_destructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_close_flushes"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_close_flushes">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_flushes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_array_writes"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_array_writes">[docs]</a>    <span class="k">def</span> <span class="nf">test_array_writes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_closefd"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_closefd">[docs]</a>    <span class="k">def</span> <span class="nf">test_closefd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
                          <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_read_closed"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_read_closed">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;egg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;egg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_no_closefd_with_filename"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_no_closefd_with_filename">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_closefd_with_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># can&#39;t use closefd in combination with a file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_closefd_attr"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_closefd_attr">[docs]</a>    <span class="k">def</span> <span class="nf">test_closefd_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;egg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">closefd</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">closefd</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_garbage_collection"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_garbage_collection">[docs]</a>    <span class="k">def</span> <span class="nf">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># FileIO objects are collected, and collecting them flushes</span>
        <span class="c"># all data to disk.</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcxxx&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">f</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wr</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">wr</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;abcxxx&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_unbounded_file"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_unbounded_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_unbounded_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #1174606: reading from an unbounded stream such as /dev/zero.</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="s">&quot;/dev/zero&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zero</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;{0} does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zero</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;test can only run in a 32-bit address space&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">real_max_memuse</span> <span class="o">&lt;</span> <span class="n">support</span><span class="o">.</span><span class="n">_2G</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;test requires at least 2GB of memory&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_flush_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_flush_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">)</span> <span class="c"># exception not swallowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_multi_close"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_multi_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_multi_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_RawIOBase_read"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_RawIOBase_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_RawIOBase_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Exercise the default RawIOBase.read() implementation (which calls</span>
        <span class="c"># readinto() internally).</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIOWithoutRead</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;ab&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;c&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;g&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_types_have_dict"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_types_have_dict">[docs]</a>    <span class="k">def</span> <span class="nf">test_types_have_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">test</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IOBase</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;__dict__&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="IOTest.test_opener"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_opener">[docs]</a>    <span class="k">def</span> <span class="nf">test_opener</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;egg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">opener</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fd</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;non-existent&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">opener</span><span class="o">=</span><span class="n">opener</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;egg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IOTest.test_fileio_closefd"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_fileio_closefd">[docs]</a>    <span class="k">def</span> <span class="nf">test_fileio_closefd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #4841</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">,</span> \
             <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
            <span class="n">fileio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># .__init__() must not close f1</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">f1</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="c"># .close() must not close f2</span>
            <span class="n">fileio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="IOTest.test_nonbuffered_textio"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_nonbuffered_textio">[docs]</a>    <span class="k">def</span> <span class="nf">test_nonbuffered_textio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">recorded</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">recorded</span><span class="p">,</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="IOTest.test_invalid_newline"><a class="viewcode-back" href="../../test.html#test.test_io.IOTest.test_invalid_newline">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">recorded</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&#39;invalid&#39;</span><span class="p">)</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">recorded</span><span class="p">,</span> <span class="p">[])</span>

</div></div>
<div class="viewcode-block" id="CIOTest"><a class="viewcode-back" href="../../test.html#test.test_io.CIOTest">[docs]</a><span class="k">class</span> <span class="nc">CIOTest</span><span class="p">(</span><span class="n">IOTest</span><span class="p">):</span>

<div class="viewcode-block" id="CIOTest.test_IOBase_finalize"><a class="viewcode-back" href="../../test.html#test.test_io.CIOTest.test_IOBase_finalize">[docs]</a>    <span class="k">def</span> <span class="nf">test_IOBase_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12149: segmentation fault on _PyIOBase_finalize when both a</span>
        <span class="c"># class which inherits IOBase and an object of this class are caught</span>
        <span class="c"># in a reference cycle and close() is already in the method cache.</span>
        <span class="k">class</span> <span class="nc">MyIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="c"># create an instance to populate the method cache</span>
        <span class="n">MyIO</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">MyIO</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">MyIO</span>
        <span class="k">del</span> <span class="n">obj</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wr</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">wr</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="PyIOTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyIOTest">[docs]</a><span class="k">class</span> <span class="nc">PyIOTest</span><span class="p">(</span><span class="n">IOTest</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CommonBufferedTests"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests">[docs]</a><span class="k">class</span> <span class="nc">CommonBufferedTests</span><span class="p">:</span>
    <span class="c"># Tests common to BufferedReader, BufferedWriter and BufferedRandom</span>

<div class="viewcode-block" id="CommonBufferedTests.test_detach"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_detach">[docs]</a>    <span class="k">def</span> <span class="nf">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">detach</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_fileno"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_fileno">[docs]</a>    <span class="k">def</span> <span class="nf">test_fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</div>
    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&#39;test having existential crisis&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="CommonBufferedTests.test_no_fileno"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_no_fileno">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># XXX will we always have fileno() function? If so, kill</span>
        <span class="c"># this test. Else, write it.</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_invalid_args"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_invalid_args">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="c"># Invalid whence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_override_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_override_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_override_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">class</span> <span class="nc">MyBufferedIO</span><span class="p">(</span><span class="n">tp</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__del__</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="n">MyBufferedIO</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="n">writable</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">writable</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">bufio</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">writable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_context_manager"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_context_manager">[docs]</a>    <span class="k">def</span> <span class="nf">test_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test usability as a context manager</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_with</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">bufio</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">_with</span><span class="p">()</span>
        <span class="c"># bufio should now be closed, and using it a second time should raise</span>
        <span class="c"># a ValueError.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">_with</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_error_through_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_error_through_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_error_through_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test that the exception state is not modified by a destructor,</span>
        <span class="c"># even if close() fails.</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CloseFailureIO</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span><span class="o">.</span><span class="n">xyzzy</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">captured_output</span><span class="p">(</span><span class="s">&quot;stderr&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="c"># The destructor *may* have printed an unraisable error, check it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Exception OSError: &quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot; ignored&quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_repr"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">clsname</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">clsname</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dummy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> name=&#39;dummy&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">clsname</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;dummy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> name=b&#39;dummy&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">clsname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_flush_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_flush_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">)</span> <span class="c"># exception not swallowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_close_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_close_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s">&#39;flush&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bad_close</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s">&#39;close&#39;</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">bad_close</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c"># exception not swallowed</span>
            <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;close&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;flush&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_nonnormalized_close_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_nonnormalized_close_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_nonnormalized_close_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #21677</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">non_existing_flush</span>
        <span class="k">def</span> <span class="nf">bad_close</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">non_existing_close</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">bad_close</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NameError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c"># exception not swallowed</span>
            <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;non_existing_close&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;non_existing_flush&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_multi_close"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_multi_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_multi_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_unseekable"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_unseekable">[docs]</a>    <span class="k">def</span> <span class="nf">test_unseekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockUnseekableIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommonBufferedTests.test_readonly_attributes"><a class="viewcode-back" href="../../test.html#test.test_io.CommonBufferedTests.test_readonly_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_readonly_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">x</span>

</div></div>
<div class="viewcode-block" id="SizeofTest"><a class="viewcode-back" href="../../test.html#test.test_io.SizeofTest">[docs]</a><span class="k">class</span> <span class="nc">SizeofTest</span><span class="p">:</span>

    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="SizeofTest.test_sizeof"><a class="viewcode-back" href="../../test.html#test.test_io.SizeofTest.test_sizeof">[docs]</a>    <span class="k">def</span> <span class="nf">test_sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bufsize1</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">bufsize2</span> <span class="o">=</span> <span class="mi">8192</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="n">bufsize1</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">bufio</span><span class="p">)</span> <span class="o">-</span> <span class="n">bufsize1</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="n">bufsize2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">bufio</span><span class="p">),</span> <span class="n">size</span> <span class="o">+</span> <span class="n">bufsize2</span><span class="p">)</span>
</div>
    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="SizeofTest.test_buffer_freeing"><a class="viewcode-back" href="../../test.html#test.test_io.SizeofTest.test_buffer_freeing">[docs]</a>    <span class="k">def</span> <span class="nf">test_buffer_freeing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">bufio</span><span class="p">)</span> <span class="o">-</span> <span class="n">bufsize</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">bufio</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="BufferedReaderTest"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest">[docs]</a><span class="k">class</span> <span class="nc">BufferedReaderTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">CommonBufferedTests</span><span class="p">):</span>
    <span class="n">read_mode</span> <span class="o">=</span> <span class="s">&quot;rb&quot;</span>

<div class="viewcode-block" id="BufferedReaderTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">])</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">])</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_uninitialized"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_uninitialized">[docs]</a>    <span class="k">def</span> <span class="nf">test_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bufio</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">((</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
                               <span class="s">&#39;uninitialized|has no attribute&#39;</span><span class="p">,</span>
                               <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_read"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdefg&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
        <span class="c"># Invalid args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_read1"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_read1">[docs]</a>    <span class="k">def</span> <span class="nf">test_read1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_reads</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_reads</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_reads</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_reads</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_reads</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c"># Invalid args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_readinto"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_readinto">[docs]</a>    <span class="k">def</span> <span class="nf">test_readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ab&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;cd&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;gf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;gf&quot;</span><span class="p">)</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ab&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;cb&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_readlines"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_readlines">[docs]</a>    <span class="k">def</span> <span class="nf">test_readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">bufio</span><span class="p">():</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="p">()</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="p">()</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="p">()</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_buffering"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_buffering">[docs]</a>    <span class="k">def</span> <span class="nf">test_buffering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;abcdefghi&quot;</span>
        <span class="n">dlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span> <span class="mi">100</span><span class="p">,</span> <span class="p">[</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span> <span class="p">],</span> <span class="p">[</span> <span class="n">dlen</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">],</span>
            <span class="p">[</span> <span class="mi">100</span><span class="p">,</span> <span class="p">[</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>     <span class="p">[</span> <span class="n">dlen</span> <span class="p">]</span>    <span class="p">],</span>
            <span class="p">[</span>   <span class="mi">4</span><span class="p">,</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span> <span class="p">[</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">],</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">buf_read_sizes</span><span class="p">,</span> <span class="n">raw_read_sizes</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockFileIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">nbytes</span> <span class="ow">in</span> <span class="n">buf_read_sizes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nbytes</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="n">nbytes</span><span class="p">])</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">nbytes</span>
            <span class="c"># this is mildly implementation-dependent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">read_history</span><span class="p">,</span> <span class="n">raw_read_sizes</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_read_non_blocking"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_read_non_blocking">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_non_blocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Inject some None&#39;s in there to simulate EWOULDBLOCK</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcd&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;fg&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">rawio</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_read_past_eof"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_read_past_eof">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_past_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdefg&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">9000</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_read_all"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_read_all">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdefg&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">threading</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
    <span class="nd">@support.requires_resource</span><span class="p">(</span><span class="s">&#39;cpu&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BufferedReaderTest.test_threads"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_threads">[docs]</a>    <span class="k">def</span> <span class="nf">test_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Write out many bytes with exactly the same number of 0&#39;s,</span>
            <span class="c"># 1&#39;s... 255&#39;s. This will help us check that concurrent reading</span>
            <span class="c"># doesn&#39;t duplicate or forget contents.</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">*</span> <span class="n">N</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># Intra-buffer read then buffer-flushing read</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">]):</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="c"># list.append() is atomic</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">raise</span>
                <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span> <span class="c"># yield</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span>
                    <span class="s">&quot;the following exceptions were caught: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_unseekable"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_unseekable">[docs]</a>    <span class="k">def</span> <span class="nf">test_unseekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockUnseekableIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_misbehaved_io"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_misbehaved_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_misbehaved_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MisbehavedRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedReaderTest.test_no_extraneous_read"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedReaderTest.test_no_extraneous_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_extraneous_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #9550; when the raw IO object has satisfied the read request,</span>
        <span class="c"># we should not issue any additional reads, otherwise it may block</span>
        <span class="c"># (e.g. socket).</span>
        <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">bufsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bufsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="n">n</span><span class="p">])</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
            <span class="c"># Simple case: one raw read is enough to satisfy the request.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_extraneous_reads</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="s">&quot;failed for {}: {} != 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rawio</span><span class="o">.</span><span class="n">_extraneous_reads</span><span class="p">))</span>
            <span class="c"># A more complex case where two raw reads are needed to satisfy</span>
            <span class="c"># the request.</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_extraneous_reads</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="s">&quot;failed for {}: {} != 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rawio</span><span class="o">.</span><span class="n">_extraneous_reads</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="CBufferedReaderTest"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedReaderTest">[docs]</a><span class="k">class</span> <span class="nc">CBufferedReaderTest</span><span class="p">(</span><span class="n">BufferedReaderTest</span><span class="p">,</span> <span class="n">SizeofTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span>

<div class="viewcode-block" id="CBufferedReaderTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedReaderTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedReaderTest</span><span class="o">.</span><span class="n">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c"># The allocation can succeed on 32-bit builds, e.g. with more</span>
        <span class="c"># than 2GB RAM and a 64-bit kernel.</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFF</span><span class="p">:</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span>
                <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedReaderTest.test_initialization"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedReaderTest.test_initialization">[docs]</a>    <span class="k">def</span> <span class="nf">test_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">])</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedReaderTest.test_misbehaved_io_read"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedReaderTest.test_misbehaved_io_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_misbehaved_io_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MisbehavedRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;efg&quot;</span><span class="p">))</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="c"># _pyio.BufferedReader seems to implement reading different, so that</span>
        <span class="c"># checking this is not so easy.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedReaderTest.test_garbage_collection"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedReaderTest.test_garbage_collection">[docs]</a>    <span class="k">def</span> <span class="nf">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># C BufferedReader objects are collected.</span>
        <span class="c"># The Python version has __del__, so it ends into gc.garbage instead</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)):</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+b&quot;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">f</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wr</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">wr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedReaderTest.test_args_error"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedReaderTest.test_args_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_args_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #17275</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s">&quot;BufferedReader&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PyBufferedReaderTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyBufferedReaderTest">[docs]</a><span class="k">class</span> <span class="nc">PyBufferedReaderTest</span><span class="p">(</span><span class="n">BufferedReaderTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BufferedReader</span>

</div>
<div class="viewcode-block" id="BufferedWriterTest"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest">[docs]</a><span class="k">class</span> <span class="nc">BufferedWriterTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">CommonBufferedTests</span><span class="p">):</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s">&quot;wb&quot;</span>

<div class="viewcode-block" id="BufferedWriterTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">))</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ghi&quot;</span><span class="p">))</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;abcghi&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_uninitialized"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_uninitialized">[docs]</a>    <span class="k">def</span> <span class="nf">test_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bufio</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">((</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
                               <span class="s">&#39;uninitialized|has no attribute&#39;</span><span class="p">,</span>
                               <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_detach_flush"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_detach_flush">[docs]</a>    <span class="k">def</span> <span class="nf">test_detach_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;howdy!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;howdy!&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Write to the buffered IO but don&#39;t overflow the buffer.</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_write_overflow"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_write_overflow">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;abcdefghijklmnop&quot;</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">flushed</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">)</span>
        <span class="c"># At least (total - 8) bytes were implicitly flushed, perhaps more</span>
        <span class="c"># depending on the implementation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">flushed</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">contents</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]),</span> <span class="n">flushed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.check_writes"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.check_writes">[docs]</a>    <span class="k">def</span> <span class="nf">check_writes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_func</span><span class="p">):</span>
        <span class="c"># Lots of writes, test the flushed output is as expected.</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
        <span class="c"># Generator of write sizes: repeat each N 15 times then proceed to N+1</span>
        <span class="k">def</span> <span class="nf">gen_sizes</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">size</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="n">gen_sizes</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">sizes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">size</span><span class="p">]),</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">intermediate_func</span><span class="p">(</span><span class="n">bufio</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">size</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writes"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writes">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bufio</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writes_and_flushes"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writes_and_flushes">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_flushes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bufio</span><span class="p">:</span> <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writes_and_seeks"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writes_and_seeks">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_seeks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_seekabs</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_seekabs</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_seekrel</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_seekrel</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writes_and_truncates"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writes_and_truncates">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_truncates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bufio</span><span class="p">:</span> <span class="n">bufio</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_write_non_blocking"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_write_non_blocking">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_non_blocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockNonBlockWriterIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcd&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;efghi&quot;</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c"># 1 byte will be written, the rest will be buffered</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">block_on</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;k&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;jklmn&quot;</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c"># 8 bytes will be written, 8 will be buffered and the rest will be lost</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">block_on</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;opqrwxyz0123456789&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">BlockingIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">written</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">characters_written</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;BlockingIOError should have been raised&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">written</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">pop_written</span><span class="p">(),</span>
            <span class="n">b</span><span class="s">&quot;abcdefghijklmnopqrwxyz&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ABCDEFGHI&quot;</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">pop_written</span><span class="p">()</span>
        <span class="c"># Previously buffered bytes were flushed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;01234567A&quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_write_and_rewind"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_write_and_rewind">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_and_rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;XY&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;XYcdef&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;123456&quot;</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;XYcdef123456&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_flush"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_flush">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writelines"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writelines">[docs]</a>    <span class="k">def</span> <span class="nf">test_writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;cd&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;ef&#39;</span><span class="p">]</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;abcdef&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writelines_userlist"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writelines_userlist">[docs]</a>    <span class="k">def</span> <span class="nf">test_writelines_userlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">UserList</span><span class="p">([</span><span class="n">b</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;cd&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;ef&#39;</span><span class="p">])</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;abcdef&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_writelines_error"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_writelines_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_writelines_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="s">&#39;abc&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bufio</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">writer</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_truncate"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_truncate">[docs]</a>    <span class="k">def</span> <span class="nf">test_truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Truncate implicitly flushes the buffer.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mode</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">threading</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
    <span class="nd">@support.requires_resource</span><span class="p">(</span><span class="s">&#39;cpu&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BufferedWriterTest.test_threads"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_threads">[docs]</a>    <span class="k">def</span> <span class="nf">test_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Write out many bytes from many threads and test they were</span>
            <span class="c"># all flushed.</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">*</span> <span class="n">N</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">size</span><span class="p">])</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">del</span> <span class="n">contents</span>
            <span class="c"># We use a real file object because it allows us to</span>
            <span class="c"># exercise situations where the GIL is released before</span>
            <span class="c"># writing the buffer to the raw streams. This is in addition</span>
            <span class="c"># to concurrency issues due to switching threads in the middle</span>
            <span class="c"># of Python code.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mode</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                                <span class="k">return</span>
                            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">raise</span>
                <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span> <span class="c"># yield</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span>
                    <span class="s">&quot;the following exceptions were caught: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
                <span class="n">bufio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">])),</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_misbehaved_io"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_misbehaved_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_misbehaved_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MisbehavedRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_max_buffer_size_removal"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_max_buffer_size_removal">[docs]</a>    <span class="k">def</span> <span class="nf">test_max_buffer_size_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedWriterTest.test_write_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedWriterTest.test_write_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">bad_write</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">bad_write</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;spam&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">)</span> <span class="c"># exception not swallowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="CBufferedWriterTest"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedWriterTest">[docs]</a><span class="k">class</span> <span class="nc">CBufferedWriterTest</span><span class="p">(</span><span class="n">BufferedWriterTest</span><span class="p">,</span> <span class="n">SizeofTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedWriter</span>

<div class="viewcode-block" id="CBufferedWriterTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedWriterTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedWriterTest</span><span class="o">.</span><span class="n">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c"># The allocation can succeed on 32-bit builds, e.g. with more</span>
        <span class="c"># than 2GB RAM and a 64-bit kernel.</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFF</span><span class="p">:</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span>
                <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedWriterTest.test_initialization"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedWriterTest.test_initialization">[docs]</a>    <span class="k">def</span> <span class="nf">test_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedWriterTest.test_garbage_collection"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedWriterTest.test_garbage_collection">[docs]</a>    <span class="k">def</span> <span class="nf">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># C BufferedWriter objects are collected, and collecting them flushes</span>
        <span class="c"># all data to disk.</span>
        <span class="c"># The Python version has __del__, so it ends into gc.garbage instead</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)):</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+b&quot;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;123xxx&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">f</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wr</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">wr</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;123xxx&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedWriterTest.test_args_error"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedWriterTest.test_args_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_args_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #17275</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s">&quot;BufferedWriter&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PyBufferedWriterTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyBufferedWriterTest">[docs]</a><span class="k">class</span> <span class="nc">PyBufferedWriterTest</span><span class="p">(</span><span class="n">BufferedWriterTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BufferedWriter</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest">[docs]</a><span class="k">class</span> <span class="nc">BufferedRWPairTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="BufferedRWPairTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_uninitialized"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_uninitialized">[docs]</a>    <span class="k">def</span> <span class="nf">test_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">pair</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">((</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
                               <span class="s">&#39;uninitialized|has no attribute&#39;</span><span class="p">,</span>
                               <span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">((</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
                               <span class="s">&#39;uninitialized|has no attribute&#39;</span><span class="p">,</span>
                               <span class="n">pair</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">pair</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_detach"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_detach">[docs]</a>    <span class="k">def</span> <span class="nf">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">detach</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_constructor_max_buffer_size_removal"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_constructor_max_buffer_size_removal">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor_max_buffer_size_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_constructor_with_not_readable"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_constructor_with_not_readable">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor_with_not_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">NotReadable</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span> <span class="n">NotReadable</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_constructor_with_not_writeable"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_constructor_with_not_writeable">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor_with_not_writeable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">NotWriteable</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="n">NotWriteable</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_read"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;d&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">)</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_readlines"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_readlines">[docs]</a>    <span class="k">def</span> <span class="nf">test_readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">def</span><span class="se">\n</span><span class="s">h&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="p">()</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;h&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="p">()</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;h&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="p">()</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_read1"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_read1">[docs]</a>    <span class="k">def</span> <span class="nf">test_read1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># .read1() is delegated to the underlying reader object, so this test</span>
        <span class="c"># can be shallow.</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_readinto"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_readinto">[docs]</a>    <span class="k">def</span> <span class="nf">test_readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;abcde&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="n">w</span><span class="p">)</span>

        <span class="n">pair</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="n">pair</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">pair</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;def&quot;</span><span class="p">)</span>
        <span class="n">pair</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;def&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_peek"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_peek">[docs]</a>    <span class="k">def</span> <span class="nf">test_peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdef&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_readable"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_readable">[docs]</a>    <span class="k">def</span> <span class="nf">test_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">readable</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_writeable"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_writeable">[docs]</a>    <span class="k">def</span> <span class="nf">test_writeable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">writable</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_seekable"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_seekable">[docs]</a>    <span class="k">def</span> <span class="nf">test_seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># BufferedRWPairs are never seekable, even if their readers and writers</span>
        <span class="c"># are.</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">seekable</span><span class="p">())</span>

    <span class="c"># .flush() is delegated to the underlying writer object and has been</span>
    <span class="c"># tested in the test_write method.</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_close_and_closed"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_close_and_closed">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_and_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="n">pair</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRWPairTest.test_isatty"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRWPairTest.test_isatty">[docs]</a>    <span class="k">def</span> <span class="nf">test_isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">SelectableIsAtty</span><span class="p">(</span><span class="n">MockRawIO</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isatty</span><span class="p">):</span>
                <span class="n">MockRawIO</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_isatty</span> <span class="o">=</span> <span class="n">isatty</span>

            <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isatty</span>

        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span> <span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span>

        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">True</span><span class="p">),</span> <span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span>

        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span> <span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span>

        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">True</span><span class="p">),</span> <span class="n">SelectableIsAtty</span><span class="p">(</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span>
</div></div>
<div class="viewcode-block" id="CBufferedRWPairTest"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedRWPairTest">[docs]</a><span class="k">class</span> <span class="nc">CBufferedRWPairTest</span><span class="p">(</span><span class="n">BufferedRWPairTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedRWPair</span>
</div>
<div class="viewcode-block" id="PyBufferedRWPairTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyBufferedRWPairTest">[docs]</a><span class="k">class</span> <span class="nc">PyBufferedRWPairTest</span><span class="p">(</span><span class="n">BufferedRWPairTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BufferedRWPair</span>

</div>
<div class="viewcode-block" id="BufferedRandomTest"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest">[docs]</a><span class="k">class</span> <span class="nc">BufferedRandomTest</span><span class="p">(</span><span class="n">BufferedReaderTest</span><span class="p">,</span> <span class="n">BufferedWriterTest</span><span class="p">):</span>
    <span class="n">read_mode</span> <span class="o">=</span> <span class="s">&quot;rb+&quot;</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s">&quot;wb+&quot;</span>

<div class="viewcode-block" id="BufferedRandomTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedReaderTest</span><span class="o">.</span><span class="n">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BufferedWriterTest</span><span class="o">.</span><span class="n">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_uninitialized"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_uninitialized">[docs]</a>    <span class="k">def</span> <span class="nf">test_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedReaderTest</span><span class="o">.</span><span class="n">test_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BufferedWriterTest</span><span class="o">.</span><span class="n">test_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_read_and_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_read_and_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_and_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">((</span><span class="n">b</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ghjk&quot;</span><span class="p">))</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;as&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ddd&quot;</span><span class="p">)</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;eee&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">)</span> <span class="c"># Buffer writes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ghjk&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;dddeee&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_seek_and_tell"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_seek_and_tell">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_and_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;asdfghjkl&quot;</span><span class="p">)</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;as&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;asdf&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">rw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;123f&quot;</span><span class="p">)</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;asdf123fl&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;fl&quot;</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;asdf123fl&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.check_flush_and_read"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.check_flush_and_read">[docs]</a>    <span class="k">def</span> <span class="nf">check_flush_and_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_func</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdefghi&quot;</span><span class="p">)</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ab&quot;</span><span class="p">,</span> <span class="n">read_func</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;12&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ef&quot;</span><span class="p">,</span> <span class="n">read_func</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ghi&quot;</span><span class="p">,</span> <span class="n">read_func</span><span class="p">(</span><span class="n">bufio</span><span class="p">))</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;XYZ&quot;</span><span class="p">)</span>
        <span class="c"># flush() resets the read buffer</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;XYZ&quot;</span><span class="p">,</span> <span class="n">read_func</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_flush_and_read"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_flush_and_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_and_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_flush_and_read</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bufio</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_flush_and_readinto"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_flush_and_readinto">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_and_readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_readinto</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">9999</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_flush_and_read</span><span class="p">(</span><span class="n">_readinto</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_flush_and_peek"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_flush_and_peek">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_and_peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_peek</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c"># This relies on the fact that the buffer can contain the whole</span>
            <span class="c"># raw stream, otherwise peek() can return less.</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_flush_and_read</span><span class="p">(</span><span class="n">_peek</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_flush_and_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_flush_and_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_and_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abcdefghi&quot;</span><span class="p">)</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

        <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;123&quot;</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;45&quot;</span><span class="p">)</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;12345fghi&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;12345fghi&quot;</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_threads"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_threads">[docs]</a>    <span class="k">def</span> <span class="nf">test_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedReaderTest</span><span class="o">.</span><span class="n">test_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BufferedWriterTest</span><span class="o">.</span><span class="n">test_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_writes_and_peek"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_writes_and_peek">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_peek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_peek</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_peek</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_peek</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_peek</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_writes_and_reads"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_writes_and_reads">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_reads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_writes_and_read1s"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_writes_and_read1s">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_read1s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_read1</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_read1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_writes_and_readintos"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_writes_and_readintos">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_and_readintos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">bufio</span><span class="p">):</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_writes</span><span class="p">(</span><span class="n">_read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_write_after_readahead"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_write_after_readahead">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_after_readahead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #6629: writing after the buffer was filled by readahead should</span>
        <span class="c"># first rewind the raw stream.</span>
        <span class="k">for</span> <span class="n">overwrite_size</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="c"># Trigger readahead</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;A&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c"># Overwriting should rewind the raw stream if it needs so</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;B&quot;</span> <span class="o">*</span> <span class="n">overwrite_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">overwrite_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c"># If the write size was smaller than the buffer size, flush() and</span>
            <span class="c"># check that rewind happens.</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">overwrite_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
                <span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;B&quot;</span> <span class="o">*</span> <span class="n">overwrite_size</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="n">overwrite_size</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_write_rewind_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_write_rewind_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_rewind_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Various combinations of reading / writing / seeking backwards / writing again</span>
        <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">pos2</span> <span class="o">&gt;=</span> <span class="n">pos1</span>
            <span class="c"># Fill the buffer</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pos2</span> <span class="o">-</span> <span class="n">pos1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x02</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="c"># This writes earlier than the previous write, but still inside</span>
            <span class="c"># the buffer.</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
            <span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x80\x81\x82\x83\x84</span><span class="s">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">mutate</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="n">bufio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">expected</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">expected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">expected</span><span class="p">,</span>
                                 <span class="s">&quot;failed result for i=</span><span class="si">%d</span><span class="s">, j=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_truncate_after_read_or_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_truncate_after_read_or_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_truncate_after_read_or_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;AA&quot;</span><span class="p">)</span> <span class="c"># the read buffer gets filled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">truncate</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;BB&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c"># the write buffer increases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bufio</span><span class="o">.</span><span class="n">truncate</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_misbehaved_io"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_misbehaved_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_misbehaved_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedReaderTest</span><span class="o">.</span><span class="n">test_misbehaved_io</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">BufferedWriterTest</span><span class="o">.</span><span class="n">test_misbehaved_io</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_interleaved_read_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_interleaved_read_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_interleaved_read_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test for issue #12213</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;abcdefgh&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;2&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;4&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;h&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;1b2d3f4h&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;2&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;a2c&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BufferedRandomTest.test_interleaved_readline_write"><a class="viewcode-back" href="../../test.html#test.test_io.BufferedRandomTest.test_interleaved_readline_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_interleaved_readline_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;ab</span><span class="se">\n</span><span class="s">cdef</span><span class="se">\n</span><span class="s">g</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;b</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;2&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;def</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;1b</span><span class="se">\n</span><span class="s">2def</span><span class="se">\n</span><span class="s">3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># You can&#39;t construct a BufferedRandom over a non-seekable stream.</span></div>
    <span class="n">test_unseekable</span> <span class="o">=</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="CBufferedRandomTest"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedRandomTest">[docs]</a><span class="k">class</span> <span class="nc">CBufferedRandomTest</span><span class="p">(</span><span class="n">BufferedRandomTest</span><span class="p">,</span> <span class="n">SizeofTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedRandom</span>

<div class="viewcode-block" id="CBufferedRandomTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedRandomTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BufferedRandomTest</span><span class="o">.</span><span class="n">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c"># The allocation can succeed on 32-bit builds, e.g. with more</span>
        <span class="c"># than 2GB RAM and a 64-bit kernel.</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFF</span><span class="p">:</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">()</span>
            <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="ne">MemoryError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span>
                <span class="n">bufio</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">rawio</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedRandomTest.test_garbage_collection"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedRandomTest.test_garbage_collection">[docs]</a>    <span class="k">def</span> <span class="nf">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">CBufferedReaderTest</span><span class="o">.</span><span class="n">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">CBufferedWriterTest</span><span class="o">.</span><span class="n">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CBufferedRandomTest.test_args_error"><a class="viewcode-back" href="../../test.html#test.test_io.CBufferedRandomTest.test_args_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_args_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #17275</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s">&quot;BufferedRandom&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PyBufferedRandomTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyBufferedRandomTest">[docs]</a><span class="k">class</span> <span class="nc">PyBufferedRandomTest</span><span class="p">(</span><span class="n">BufferedRandomTest</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">BufferedRandom</span>


<span class="c"># To fully exercise seek/tell, the StatefulIncrementalDecoder has these</span>
<span class="c"># properties:</span>
<span class="c">#   - A single output character can correspond to many bytes of input.</span>
<span class="c">#   - The number of input bytes to complete the character can be</span>
<span class="c">#     undetermined until the last input byte is received.</span>
<span class="c">#   - The number of input bytes can vary depending on previous input.</span>
<span class="c">#   - A single input byte can correspond to many characters of output.</span>
<span class="c">#   - The number of output characters can be undetermined until the</span>
<span class="c">#     last input byte is received.</span>
<span class="c">#   - The number of output characters can vary depending on previous input.</span>
</div>
<div class="viewcode-block" id="StatefulIncrementalDecoder"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder">[docs]</a><span class="k">class</span> <span class="nc">StatefulIncrementalDecoder</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">IncrementalDecoder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For testing seek/tell behavior with a stateful, buffering decoder.</span>

<span class="sd">    Input is a sequence of words.  Words may be fixed-length (length set</span>
<span class="sd">    by input) or variable-length (period-terminated).  In variable-length</span>
<span class="sd">    mode, extra periods are ignored.  Possible words are:</span>
<span class="sd">      - &#39;i&#39; followed by a number sets the input length, I (maximum 99).</span>
<span class="sd">        When I is set to 0, words are space-terminated.</span>
<span class="sd">      - &#39;o&#39; followed by a number sets the output length, O (maximum 99).</span>
<span class="sd">      - Any other word is converted into a word followed by a period on</span>
<span class="sd">        the output.  The output word consists of the input word truncated</span>
<span class="sd">        or padded out with hyphens to make its length equal to O.  If O</span>
<span class="sd">        is 0, the word is output verbatim without truncating or padding.</span>
<span class="sd">    I and O are initially set to 1.  When I changes, any buffered input is</span>
<span class="sd">    re-scanned according to the new I.  EOF also terminates the last word.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">):</span>
        <span class="n">codecs</span><span class="o">.</span><span class="n">IncrementalDecoder</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;SID </span><span class="si">%x</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="StatefulIncrementalDecoder.reset"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="StatefulIncrementalDecoder.getstate"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder.getstate">[docs]</a>    <span class="k">def</span> <span class="nf">getstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">^</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">^</span> <span class="mi">1</span> <span class="c"># so that flags = 0 after reset()</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">),</span> <span class="n">i</span><span class="o">*</span><span class="mi">100</span> <span class="o">+</span> <span class="n">o</span>
</div>
<div class="viewcode-block" id="StatefulIncrementalDecoder.setstate"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder.setstate">[docs]</a>    <span class="k">def</span> <span class="nf">setstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">buffer</span><span class="p">,</span> <span class="n">io</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">i</span> <span class="o">^</span> <span class="mi">1</span><span class="p">,</span> <span class="n">o</span> <span class="o">^</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="StatefulIncrementalDecoder.decode"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder.decode">[docs]</a>    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># variable-length, terminated with period</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_word</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># fixed-length, terminate after self.i bytes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_word</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">final</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span> <span class="c"># EOF terminates the last word</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_word</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
</div>
<div class="viewcode-block" id="StatefulIncrementalDecoder.process_word"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder.process_word">[docs]</a>    <span class="k">def</span> <span class="nf">process_word</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span> <span class="c"># set input length</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;o&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span> <span class="c"># set output length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="s">&#39;-&#39;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="c"># pad out with hyphens</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">]</span> <span class="c"># truncate to output length</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s">&#39;.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
</div>
    <span class="n">codecEnabled</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="StatefulIncrementalDecoder.lookupTestDecoder"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoder.lookupTestDecoder">[docs]</a>    <span class="k">def</span> <span class="nf">lookupTestDecoder</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">codecEnabled</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;test_decoder&#39;</span><span class="p">:</span>
            <span class="n">latin1</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s">&#39;latin-1&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">CodecInfo</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">&#39;test_decoder&#39;</span><span class="p">,</span> <span class="n">encode</span><span class="o">=</span><span class="n">latin1</span><span class="o">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">incrementalencoder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">streamreader</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">streamwriter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">incrementaldecoder</span><span class="o">=</span><span class="n">cls</span><span class="p">)</span>

<span class="c"># Register the previous decoder for testing.</span>
<span class="c"># Disabled by default, tests will enable it.</span></div></div>
<span class="n">codecs</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">StatefulIncrementalDecoder</span><span class="o">.</span><span class="n">lookupTestDecoder</span><span class="p">)</span>


<div class="viewcode-block" id="StatefulIncrementalDecoderTest"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoderTest">[docs]</a><span class="k">class</span> <span class="nc">StatefulIncrementalDecoderTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure the StatefulIncrementalDecoder actually works.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># I=1, O=1 (fixed-length input == fixed-length output)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;abcd&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;a.b.c.d.&#39;</span><span class="p">),</span>
        <span class="c"># I=0, O=0 (variable-length input, variable-length output)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;oiabcd&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;abcd.&#39;</span><span class="p">),</span>
        <span class="c"># I=0, O=0 (should ignore extra periods)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;oi...abcd...&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;abcd.&#39;</span><span class="p">),</span>
        <span class="c"># I=0, O=6 (variable-length input, fixed-length output)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;i.o6.x.xyz.toolongtofit.&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;x-----.xyz---.toolon.&#39;</span><span class="p">),</span>
        <span class="c"># I=2, O=6 (fixed-length input &lt; fixed-length output)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;i.i2.o6xyz&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;xy----.z-----.&#39;</span><span class="p">),</span>
        <span class="c"># I=6, O=3 (fixed-length input &gt; fixed-length output)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;i.o3.i6.abcdefghijklmnop&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;abc.ghi.mno.&#39;</span><span class="p">),</span>
        <span class="c"># I=0, then 3; O=29, then 15 (with longer output)</span>
        <span class="p">(</span><span class="n">b</span><span class="s">&#39;i.o29.a.b.cde.o15.abcdefghijabcdefghij.i3.a.b.c.d.ei00k.l.m&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
         <span class="s">&#39;a----------------------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;b----------------------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;cde--------------------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;abcdefghijabcde.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;a.b------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;.c.------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;d.e------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;k--------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;l--------------.&#39;</span> <span class="o">+</span>
         <span class="s">&#39;m--------------.&#39;</span><span class="p">)</span>
    <span class="p">]</span>

<div class="viewcode-block" id="StatefulIncrementalDecoderTest.test_decoder"><a class="viewcode-back" href="../../test.html#test.test_io.StatefulIncrementalDecoderTest.test_decoder">[docs]</a>    <span class="k">def</span> <span class="nf">test_decoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try a few one-shot test cases.</span>
        <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">eof</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_cases</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">StatefulIncrementalDecoder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">eof</span><span class="p">),</span> <span class="n">output</span><span class="p">)</span>

        <span class="c"># Also test an unfinished decode, followed by forcing EOF.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">StatefulIncrementalDecoder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;oiabcd&#39;</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&#39;abcd.&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TextIOWrapperTest"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest">[docs]</a><span class="k">class</span> <span class="nc">TextIOWrapperTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TextIOWrapperTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testdata</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\r\n</span><span class="s">BBB</span><span class="se">\r</span><span class="s">CCC</span><span class="se">\r\n</span><span class="s">DDD</span><span class="se">\n</span><span class="s">EEE</span><span class="se">\r\n</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">BBB</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\n</span><span class="s">DDD</span><span class="se">\n</span><span class="s">EEE</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\xc3\xa9\n\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;latin-1&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s">&quot;latin-1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">line_buffering</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">line_buffering</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\xe9\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&#39;xyzzy&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_non_text_encoding_codecs_are_rejected"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_non_text_encoding_codecs_are_rejected">[docs]</a>    <span class="k">def</span> <span class="nf">test_non_text_encoding_codecs_are_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Ensure the constructor complains if passed a codec that isn&#39;t</span>
        <span class="c"># marked as a text encoding</span>
        <span class="c"># http://bugs.python.org/issue20404</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">LookupError</span><span class="p">,</span> <span class="s">&quot;is not a text encoding&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;hex&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_detach"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_detach">[docs]</a>    <span class="k">def</span> <span class="nf">test_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;howdy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">t</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;howdy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">detach</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_repr"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="o">.</span><span class="n">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                         <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">.TextIOWrapper encoding=&#39;utf-8&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">modname</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dummy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                         <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">.TextIOWrapper name=&#39;dummy&#39; encoding=&#39;utf-8&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">modname</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                         <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">.TextIOWrapper name=&#39;dummy&#39; mode=&#39;r&#39; encoding=&#39;utf-8&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">modname</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;dummy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                         <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">.TextIOWrapper name=b&#39;dummy&#39; mode=&#39;r&#39; encoding=&#39;utf-8&#39;&gt;&quot;</span> <span class="o">%</span> <span class="n">modname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_line_buffering"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_line_buffering">[docs]</a>    <span class="k">def</span> <span class="nf">test_line_buffering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>  <span class="c"># No flush happened</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Y</span><span class="se">\n</span><span class="s">Z&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;XY</span><span class="se">\n</span><span class="s">Z&quot;</span><span class="p">)</span>  <span class="c"># All got flushed</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;A</span><span class="se">\r</span><span class="s">B&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;XY</span><span class="se">\n</span><span class="s">ZA</span><span class="se">\r</span><span class="s">B&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_default_encoding"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_default_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">test_default_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">old_environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># try to get a user preferred encoding different than the current</span>
            <span class="c"># locale encoding to check that TextIOWrapper() uses the current</span>
            <span class="c"># locale encoding and not the user preferred encoding</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;LC_ALL&#39;</span><span class="p">,</span> <span class="s">&#39;LANG&#39;</span><span class="p">,</span> <span class="s">&#39;LC_CTYPE&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">current_locale_encoding</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">current_locale_encoding</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_environ</span><span class="p">)</span>
</div>
    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="TextIOWrapperTest.test_device_encoding"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_device_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">test_device_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 15989</span>
        <span class="kn">import</span> <span class="nn">_testcapi</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">fileno</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">INT_MAX</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">fileno</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">UINT_MAX</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_encoding"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">test_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check the encoding attribute is always set, and valid</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_encoding_errors_reading"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_encoding_errors_reading">[docs]</a>    <span class="k">def</span> <span class="nf">test_encoding_errors_reading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># (1) default</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">UnicodeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="c"># (2) explicit strict</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">UnicodeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="c"># (3) ignore</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;abc</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c"># (4) replace</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;abc</span><span class="se">\n\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;replace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;abc</span><span class="se">\n\ufffd\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_encoding_errors_writing"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_encoding_errors_writing">[docs]</a>    <span class="k">def</span> <span class="nf">test_encoding_errors_writing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># (1) default</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">UnicodeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\xff</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c"># (2) explicit strict</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">UnicodeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\xff</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c"># (3) ignore</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span>
                             <span class="n">newline</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;abc</span><span class="se">\xff</span><span class="s">def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;abcdef</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c"># (4) replace</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;replace&quot;</span><span class="p">,</span>
                             <span class="n">newline</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;abc</span><span class="se">\xff</span><span class="s">def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;abc?def</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_newlines"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_newlines">[docs]</a>    <span class="k">def</span> <span class="nf">test_newlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">input_lines</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;unix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;windows</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;os9</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;last</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nonl&quot;</span> <span class="p">]</span>

        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span> <span class="s">&#39;unix</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;windows</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;os9</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;last</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;nonl&#39;</span> <span class="p">]</span> <span class="p">],</span>
            <span class="p">[</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">input_lines</span> <span class="p">],</span>
            <span class="p">[</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&quot;unix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;windows</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;os9</span><span class="se">\r</span><span class="s">last</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nonl&quot;</span> <span class="p">]</span> <span class="p">],</span>
            <span class="p">[</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&quot;unix</span><span class="se">\n</span><span class="s">windows</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;os9</span><span class="se">\r</span><span class="s">last</span><span class="se">\n</span><span class="s">nonl&quot;</span> <span class="p">]</span> <span class="p">],</span>
            <span class="p">[</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&quot;unix</span><span class="se">\n</span><span class="s">windows</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">os9</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;last</span><span class="se">\n</span><span class="s">nonl&quot;</span> <span class="p">]</span> <span class="p">],</span>
        <span class="p">]</span>
        <span class="n">encodings</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;latin-1&#39;</span><span class="p">,</span>
            <span class="s">&#39;utf-16&#39;</span><span class="p">,</span> <span class="s">&#39;utf-16-le&#39;</span><span class="p">,</span> <span class="s">&#39;utf-16-be&#39;</span><span class="p">,</span>
            <span class="s">&#39;utf-32&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32-le&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32-be&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Try a range of buffer sizes to test the case where \r is the last</span>
        <span class="c"># character in TextIOWrapper._pending_line.</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="n">encodings</span><span class="p">:</span>
            <span class="c"># XXX: str.encode() should return bytes</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_lines</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">do_reads</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">bufsize</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">newline</span><span class="p">,</span> <span class="n">exp_lines</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
                        <span class="n">bufio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">bufsize</span><span class="p">)</span>
                        <span class="n">textio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">,</span>
                                                  <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">do_reads</span><span class="p">:</span>
                            <span class="n">got_lines</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                                <span class="n">c2</span> <span class="o">=</span> <span class="n">textio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">c2</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c2</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="n">got_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2</span> <span class="o">+</span> <span class="n">textio</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">got_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">textio</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">got_line</span><span class="p">,</span> <span class="n">exp_line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">got_lines</span><span class="p">,</span> <span class="n">exp_lines</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">got_line</span><span class="p">,</span> <span class="n">exp_line</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">got_lines</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_lines</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_newlines_input"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_newlines_input">[docs]</a>    <span class="k">def</span> <span class="nf">test_newlines_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">testdata</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">BB</span><span class="se">\x00</span><span class="s">B</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\r</span><span class="s">DDD</span><span class="se">\r</span><span class="s">EEE</span><span class="se">\r\n</span><span class="s">FFF</span><span class="se">\r\n</span><span class="s">GGG&quot;</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">testdata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newline</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">normalized</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">testdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;BB</span><span class="se">\x00</span><span class="s">B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;CCC</span><span class="se">\r</span><span class="s">DDD</span><span class="se">\r</span><span class="s">EEE</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;FFF</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;GGG&quot;</span><span class="p">]),</span>
            <span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">BB</span><span class="se">\x00</span><span class="s">B</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\r</span><span class="s">DDD</span><span class="se">\r</span><span class="s">EEE</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;FFF</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;GGG&quot;</span><span class="p">]),</span>
            <span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">BB</span><span class="se">\x00</span><span class="s">B</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;DDD</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;EEE</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">FFF</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">GGG&quot;</span><span class="p">]),</span>
            <span class="p">]:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">testdata</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span> <span class="n">expected</span><span class="p">)</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_newlines_output"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_newlines_output">[docs]</a>    <span class="k">def</span> <span class="nf">test_newlines_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">testdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;&quot;</span><span class="p">:</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">BBB</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\n</span><span class="s">X</span><span class="se">\r</span><span class="s">Y</span><span class="se">\r\n</span><span class="s">Z&quot;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">BBB</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\n</span><span class="s">X</span><span class="se">\r</span><span class="s">Y</span><span class="se">\r\n</span><span class="s">Z&quot;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">:</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\r</span><span class="s">BBB</span><span class="se">\r</span><span class="s">CCC</span><span class="se">\r</span><span class="s">X</span><span class="se">\r</span><span class="s">Y</span><span class="se">\r\r</span><span class="s">Z&quot;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">:</span> <span class="n">b</span><span class="s">&quot;AAA</span><span class="se">\r\n</span><span class="s">BBB</span><span class="se">\r\n</span><span class="s">CCC</span><span class="se">\r\n</span><span class="s">X</span><span class="se">\r</span><span class="s">Y</span><span class="se">\r\r\n</span><span class="s">Z&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">None</span><span class="p">,</span> <span class="n">testdict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">])]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">testdict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">newline</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;AAA</span><span class="se">\n</span><span class="s">B&quot;</span><span class="p">)</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;BB</span><span class="se">\n</span><span class="s">CCC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;X</span><span class="se">\r</span><span class="s">Y</span><span class="se">\r\n</span><span class="s">Z&quot;</span><span class="p">)</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">expected</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span>
        <span class="k">class</span> <span class="nc">MyBytesIO</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                <span class="n">base</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">MyBytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">t</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;abc&quot;</span><span class="p">],</span> <span class="n">l</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_override_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_override_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_override_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">class</span> <span class="nc">MyTextIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__del__</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MyTextIO</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">t</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_error_through_destructor"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_error_through_destructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_error_through_destructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test that the exception state is not modified by a destructor,</span>
        <span class="c"># even if close() fails.</span>
        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CloseFailureIO</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span><span class="o">.</span><span class="n">xyzzy</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">captured_output</span><span class="p">(</span><span class="s">&quot;stderr&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="c"># The destructor *may* have printed an unraisable error, check it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Exception OSError: &quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot; ignored&quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>

    <span class="c"># Systematic tests of the text I/O API</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_basic_io"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_basic_io">[docs]</a>    <span class="k">def</span> <span class="nf">test_basic_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">chunksize</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="s">&quot;latin-1&quot;</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span> <span class="p">:</span><span class="c"># , &quot;utf-16-be&quot;, &quot;utf-16-le&quot;:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="n">chunksize</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="n">chunksize</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
                <span class="n">cookie</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s">&quot;ab&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;c&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">cookie</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">cookie</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;def&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">cookie</span><span class="p">),</span> <span class="n">cookie</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;def&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">enc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;utf&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">multi_line_test</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">enc</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.multi_line_test"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.multi_line_test">[docs]</a>    <span class="k">def</span> <span class="nf">multi_line_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">enc</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="s">&quot;s</span><span class="se">\xff\u0fff\uffff</span><span class="s">&quot;</span>
        <span class="n">wlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">wlines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">line</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">rlines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rlines</span><span class="p">,</span> <span class="n">wlines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_telling"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_telling">[docs]</a>    <span class="k">def</span> <span class="nf">test_telling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">p0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="s">&quot;</span><span class="se">\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">p1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="s">&quot;</span><span class="se">\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">p2</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\xff\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">p2</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_seeking"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_seeking">[docs]</a>    <span class="k">def</span> <span class="nf">test_seeking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">_default_chunk_size</span><span class="p">()</span>
        <span class="n">prefix_size</span> <span class="o">=</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">u_prefix</span> <span class="o">=</span> <span class="s">&quot;a&quot;</span> <span class="o">*</span> <span class="n">prefix_size</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">u_prefix</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u_prefix</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">u_suffix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\u8888\n</span><span class="s">&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">u_suffix</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">prefix_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s">&quot;ascii&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">prefix_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">u_suffix</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_seeking_too"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_seeking_too">[docs]</a>    <span class="k">def</span> <span class="nf">test_seeking_too</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Regression test for a specific bug</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xe0\xbf\xbf\n</span><span class="s">&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span>  <span class="c"># Just test that it exists</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_seek_and_tell"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_seek_and_tell">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_and_tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#Test seek/tell using the StatefulIncrementalDecoder.</span>
        <span class="c"># Make test faster by doing smaller seeks</span>
        <span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">128</span>

        <span class="k">def</span> <span class="nf">test_seek_and_tell_with_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Tell/seek to various points within a data stream and ensure</span>
<span class="sd">            that the decoded data returned by read() is consistent.&quot;&quot;&quot;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;test_decoder&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="n">CHUNK_SIZE</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_pos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="c"># seek positions</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">]:</span> <span class="c"># read lengths</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;test_decoder&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">decoded</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">cookie</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">decoded</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">decoded</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Enable the test decoder.</span>
        <span class="n">StatefulIncrementalDecoder</span><span class="o">.</span><span class="n">codecEnabled</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># Run the tests.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Try each test case.</span>
            <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">StatefulIncrementalDecoderTest</span><span class="o">.</span><span class="n">test_cases</span><span class="p">:</span>
                <span class="n">test_seek_and_tell_with_data</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

            <span class="c"># Position each test case so that it crosses a chunk boundary.</span>
            <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">StatefulIncrementalDecoderTest</span><span class="o">.</span><span class="n">test_cases</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">CHUNK_SIZE</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;.&#39;</span><span class="o">*</span><span class="n">offset</span>
                <span class="c"># Don&#39;t bother seeking into the prefix (takes too long).</span>
                <span class="n">min_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="o">*</span><span class="mi">2</span>
                <span class="n">test_seek_and_tell_with_data</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="nb">input</span><span class="p">,</span> <span class="n">min_pos</span><span class="p">)</span>

        <span class="c"># Ensure our test decoder won&#39;t interfere with subsequent tests.</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">StatefulIncrementalDecoder</span><span class="o">.</span><span class="n">codecEnabled</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_encoded_writes"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_encoded_writes">[docs]</a>    <span class="k">def</span> <span class="nf">test_encoded_writes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;1234567890&quot;</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;utf-16&quot;</span><span class="p">,</span>
                 <span class="s">&quot;utf-16-le&quot;</span><span class="p">,</span>
                 <span class="s">&quot;utf-16-be&quot;</span><span class="p">,</span>
                 <span class="s">&quot;utf-32&quot;</span><span class="p">,</span>
                 <span class="s">&quot;utf-32-le&quot;</span><span class="p">,</span>
                 <span class="s">&quot;utf-32-be&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="c"># Check if the BOM is written only once (see issue1753).</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_unreadable"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_unreadable">[docs]</a>    <span class="k">def</span> <span class="nf">test_unreadable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">UnReadable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">UnReadable</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_read_one_by_one"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_read_one_by_one">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_one_by_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;AA</span><span class="se">\r\n</span><span class="s">BB&quot;</span><span class="p">))</span>
        <span class="n">reads</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">reads</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="s">&quot;AA</span><span class="se">\n</span><span class="s">BB&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_readlines"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_readlines">[docs]</a>    <span class="k">def</span> <span class="nf">test_readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;AA</span><span class="se">\n</span><span class="s">BB</span><span class="se">\n</span><span class="s">CC&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span> <span class="p">[</span><span class="s">&quot;AA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;BB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;CC&quot;</span><span class="p">])</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="p">[</span><span class="s">&quot;AA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;BB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;CC&quot;</span><span class="p">])</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="s">&quot;AA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;BB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">])</span>

    <span class="c"># read in amounts equal to TextIOWrapper._CHUNK_SIZE which is 128.</span></div>
<div class="viewcode-block" id="TextIOWrapperTest.test_read_by_chunk"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_read_by_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_by_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># make sure &quot;\r\n&quot; straddles 128 char boundary.</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">127</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">B&quot;</span><span class="p">))</span>
        <span class="n">reads</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">reads</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">127</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">B&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_writelines"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_writelines">[docs]</a>    <span class="k">def</span> <span class="nf">test_writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="s">&#39;cd&#39;</span><span class="p">,</span> <span class="s">&#39;ef&#39;</span><span class="p">]</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;abcdef&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_writelines_userlist"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_writelines_userlist">[docs]</a>    <span class="k">def</span> <span class="nf">test_writelines_userlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">UserList</span><span class="p">([</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="s">&#39;cd&#39;</span><span class="p">,</span> <span class="s">&#39;ef&#39;</span><span class="p">])</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;abcdef&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_writelines_error"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_writelines_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_writelines_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_issue1395_1"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_issue1395_1">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue1395_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>

        <span class="c"># read one char at a time</span>
        <span class="n">reads</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">reads</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_issue1395_2"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_issue1395_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue1395_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">reads</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">reads</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_issue1395_3"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_issue1395_3">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue1395_3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">reads</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">reads</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">reads</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">reads</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">reads</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_issue1395_4"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_issue1395_4">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue1395_4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">reads</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">reads</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_issue1395_5"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_issue1395_5">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue1395_5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">reads</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;BBB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_issue2282"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_issue2282">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue2282</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">buffer</span><span class="o">.</span><span class="n">seekable</span><span class="p">(),</span> <span class="n">txt</span><span class="o">.</span><span class="n">seekable</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_append_bom"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_append_bom">[docs]</a>    <span class="k">def</span> <span class="nf">test_append_bom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The BOM is not written again when appending to a non-empty file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="k">for</span> <span class="n">charset</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;utf-8-sig&#39;</span><span class="p">,</span> <span class="s">&#39;utf-16&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;aaa&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&#39;aaa&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;xxx&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&#39;aaaxxx&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_seek_bom"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_seek_bom">[docs]</a>    <span class="k">def</span> <span class="nf">test_seek_bom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Same test, but when seeking manually</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="k">for</span> <span class="n">charset</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;utf-8-sig&#39;</span><span class="p">,</span> <span class="s">&#39;utf-16&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;aaa&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;zzz&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;bbb&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&#39;bbbzzz&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_errors_property"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_errors_property">[docs]</a>    <span class="k">def</span> <span class="nf">test_errors_property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="s">&quot;strict&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="s">&quot;replace&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@support.no_tracing</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">threading</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TextIOWrapperTest.test_threads_write"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_threads_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_threads_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue6750: concurrent writes could duplicate data</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Thread</span><span class="si">%03d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">n</span>
                <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="o">=</span><span class="n">x</span><span class="p">:</span> <span class="n">run</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;Thread</span><span class="si">%03d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_flush_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_flush_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_flush_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">()</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">)</span> <span class="c"># exception not swallowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_close_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_close_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s">&#39;flush&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bad_close</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s">&#39;close&#39;</span><span class="p">)</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">bad_close</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c"># exception not swallowed</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;close&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;flush&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_nonnormalized_close_error_on_close"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_nonnormalized_close_error_on_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_nonnormalized_close_error_on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #21677</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bad_flush</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">non_existing_flush</span>
        <span class="k">def</span> <span class="nf">bad_close</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">non_existing_close</span>
        <span class="nb">buffer</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">bad_close</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">bad_flush</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NameError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c"># exception not swallowed</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;non_existing_close&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;non_existing_flush&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__context__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_multi_close"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_multi_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_multi_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_unseekable"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_unseekable">[docs]</a>    <span class="k">def</span> <span class="nf">test_unseekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockUnseekableIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_readonly_attributes"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_readonly_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_readonly_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buf</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_rawio"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_rawio">[docs]</a>    <span class="k">def</span> <span class="nf">test_rawio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12591: TextIOWrapper must work with raw I/O objects, so</span>
        <span class="c"># that subprocess.Popen() can have the required unbuffered</span>
        <span class="c"># semantics with universal_newlines=True.</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;def&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;ghi</span><span class="se">\n</span><span class="s">jkl</span><span class="se">\n</span><span class="s">opq</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">])</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="c"># Reads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="s">&#39;abcd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="s">&#39;efghi</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="p">[</span><span class="s">&#39;jkl</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;opq</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_rawio_write_through"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_rawio_write_through">[docs]</a>    <span class="k">def</span> <span class="nf">test_rawio_write_through</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12591: with write_through=True, writes don&#39;t need a flush</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">([</span><span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;def&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;ghi</span><span class="se">\n</span><span class="s">jkl</span><span class="se">\n</span><span class="s">opq</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">])</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                                 <span class="n">write_through</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;23</span><span class="se">\n</span><span class="s">4&#39;</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">_write_stack</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;123</span><span class="se">\n</span><span class="s">45&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_bufio_write_through"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_bufio_write_through">[docs]</a>    <span class="k">def</span> <span class="nf">test_bufio_write_through</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #21396: write_through=True doesn&#39;t force a flush()</span>
        <span class="c"># on the underlying binary buffered object.</span>
        <span class="n">flush_called</span><span class="p">,</span> <span class="n">write_called</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">class</span> <span class="nc">BufferedWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">flush_called</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">write_called</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">rawio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;a&quot;</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="n">BufferedWriter</span><span class="p">(</span><span class="n">rawio</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">textio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">bufio</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span>
                                    <span class="n">write_through</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># write to the buffered io but don&#39;t overflow the buffer</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="n">textio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c"># buffer.flush is not called with write_through=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">flush_called</span><span class="p">)</span>
        <span class="c"># buffer.write *is* called with write_through=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">write_called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="c"># no flush</span>

        <span class="n">write_called</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># reset</span>
        <span class="n">textio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="c"># total content is larger than bufio buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">write_called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rawio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">data</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span> <span class="c"># all flushed</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_read_nonbytes"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_read_nonbytes">[docs]</a>    <span class="k">def</span> <span class="nf">test_read_nonbytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #17106</span>
        <span class="c"># Crash when underlying read() returns non-bytes</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_illegal_decoder"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_illegal_decoder">[docs]</a>    <span class="k">def</span> <span class="nf">test_illegal_decoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #17106</span>
        <span class="c"># Bypass the early encoding check added in issue 20404</span>
        <span class="k">def</span> <span class="nf">_make_illegal_wrapper</span><span class="p">():</span>
            <span class="n">quopri</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s">&quot;quopri&quot;</span><span class="p">)</span>
            <span class="n">quopri</span><span class="o">.</span><span class="n">_is_text_encoding</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;aaaaaa&#39;</span><span class="p">),</span>
                                       <span class="n">newline</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;quopri&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">quopri</span><span class="o">.</span><span class="n">_is_text_encoding</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">t</span>
        <span class="c"># Crash when decoder returns non-string</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_make_illegal_wrapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_make_illegal_wrapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_make_illegal_wrapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_create_at_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Issue #20037: creating a TextIOWrapper at shutdown</span>
        <span class="c"># shouldn&#39;t crash the interpreter.</span>
        <span class="n">iomod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import codecs</span>
<span class="s">            import {iomod} as io</span>

<span class="s">            # Avoid looking up codecs at shutdown</span>
<span class="s">            codecs.lookup(&#39;utf-8&#39;)</span>

<span class="s">            class C:</span>
<span class="s">                def __init__(self):</span>
<span class="s">                    self.buf = io.BytesIO()</span>
<span class="s">                def __del__(self):</span>
<span class="s">                    io.TextIOWrapper(self.buf, **{kwargs})</span>
<span class="s">                    print(&quot;ok&quot;)</span>
<span class="s">            c = C()</span>
<span class="s">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iomod</span><span class="o">=</span><span class="n">iomod</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

<div class="viewcode-block" id="TextIOWrapperTest.test_create_at_shutdown_without_encoding"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_create_at_shutdown_without_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_at_shutdown_without_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_create_at_shutdown</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="c"># Can error out with a RuntimeError if the module state</span>
            <span class="c"># isn&#39;t found.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown_error</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="TextIOWrapperTest.test_create_at_shutdown_with_encoding"><a class="viewcode-back" href="../../test.html#test.test_io.TextIOWrapperTest.test_create_at_shutdown_with_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_at_shutdown_with_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_create_at_shutdown</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span>
                                                      <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

</div></div>
<div class="viewcode-block" id="CTextIOWrapperTest"><a class="viewcode-back" href="../../test.html#test.test_io.CTextIOWrapperTest">[docs]</a><span class="k">class</span> <span class="nc">CTextIOWrapperTest</span><span class="p">(</span><span class="n">TextIOWrapperTest</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
    <span class="n">shutdown_error</span> <span class="o">=</span> <span class="s">&quot;RuntimeError: could not find io module state&quot;</span>

<div class="viewcode-block" id="CTextIOWrapperTest.test_initialization"><a class="viewcode-back" href="../../test.html#test.test_io.CTextIOWrapperTest.test_initialization">[docs]</a>    <span class="k">def</span> <span class="nf">test_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\xc3\xa9\n\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">__init__</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">&#39;xyzzy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CTextIOWrapperTest.test_garbage_collection"><a class="viewcode-back" href="../../test.html#test.test_io.CTextIOWrapperTest.test_garbage_collection">[docs]</a>    <span class="k">def</span> <span class="nf">test_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># C TextIOWrapper objects are collected, and collecting them flushes</span>
        <span class="c"># all data to disk.</span>
        <span class="c"># The Python version has __del__, so it ends in gc.garbage instead.</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)):</span>
            <span class="n">rawio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">(</span><span class="n">rawio</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;456def&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">t</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wr</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">wr</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;456def&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CTextIOWrapperTest.test_rwpair_cleared_before_textio"><a class="viewcode-back" href="../../test.html#test.test_io.CTextIOWrapperTest.test_rwpair_cleared_before_textio">[docs]</a>    <span class="k">def</span> <span class="nf">test_rwpair_cleared_before_textio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 13070: TextIOWrapper&#39;s finalization would crash when called</span>
        <span class="c"># after the reference to the underlying BufferedRWPair&#39;s writer got</span>
        <span class="c"># cleared by the GC.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedRWPair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BufferedRWPair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockRawIO</span><span class="p">())</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="c"># circular references</span>
            <span class="n">t1</span><span class="o">.</span><span class="n">buddy</span> <span class="o">=</span> <span class="n">t2</span>
            <span class="n">t2</span><span class="o">.</span><span class="n">buddy</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="PyTextIOWrapperTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyTextIOWrapperTest">[docs]</a><span class="k">class</span> <span class="nc">PyTextIOWrapperTest</span><span class="p">(</span><span class="n">TextIOWrapperTest</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">pyio</span>
    <span class="c">#shutdown_error = &quot;LookupError: unknown encoding: ascii&quot;</span>
    <span class="n">shutdown_error</span> <span class="o">=</span> <span class="s">&quot;TypeError: &#39;NoneType&#39; object is not iterable&quot;</span>

</div>
<div class="viewcode-block" id="IncrementalNewlineDecoderTest"><a class="viewcode-back" href="../../test.html#test.test_io.IncrementalNewlineDecoderTest">[docs]</a><span class="k">class</span> <span class="nc">IncrementalNewlineDecoderTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="IncrementalNewlineDecoderTest.check_newline_decoding_utf8"><a class="viewcode-back" href="../../test.html#test.test_io.IncrementalNewlineDecoderTest.check_newline_decoding_utf8">[docs]</a>    <span class="k">def</span> <span class="nf">check_newline_decoding_utf8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decoder</span><span class="p">):</span>
        <span class="c"># UTF-8 specific tests for a newline decoder</span>
        <span class="k">def</span> <span class="nf">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c"># We exercise getstate() / setstate() as well as decode()</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">getstate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">decoder</span><span class="o">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8\xa2\x88</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\u8888</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xa2</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x88</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\u8888</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xa2</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x88</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\u8888</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">decoder</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">a&quot;</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">a&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">a&quot;</span><span class="p">)</span>

        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8\xa2\x88\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\u8888\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8\xa2\x88</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\u8888</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xe8\xa2\x88\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\u8888</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">_check_decode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IncrementalNewlineDecoderTest.check_newline_decoding"><a class="viewcode-back" href="../../test.html#test.test_io.IncrementalNewlineDecoderTest.check_newline_decoding">[docs]</a>    <span class="k">def</span> <span class="nf">check_newline_decoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getincrementalencoder</span><span class="p">(</span><span class="n">encoding</span><span class="p">)()</span>
            <span class="k">def</span> <span class="nf">_decode_bytewise</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c"># Decode one byte at a time</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">b</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">def</span> <span class="nf">_decode_bytewise</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c"># Decode one char at a time</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">_decode_bytewise</span><span class="p">(</span><span class="s">&quot;abc</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">_decode_bytewise</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">abc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">_decode_bytewise</span><span class="p">(</span><span class="s">&quot;abc</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">_decode_bytewise</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">_decode_bytewise</span><span class="p">(</span><span class="s">&quot;abc</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="s">&quot;abc</span><span class="se">\n\n</span><span class="s">abcabc</span><span class="se">\n</span><span class="s">abcabc&quot;</span><span class="p">)</span>
        <span class="n">decoder</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s">&quot;abc&quot;</span>
        <span class="k">if</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">encoder</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="s">&quot;abc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IncrementalNewlineDecoderTest.test_newline_decoder"><a class="viewcode-back" href="../../test.html#test.test_io.IncrementalNewlineDecoderTest.test_newline_decoder">[docs]</a>    <span class="k">def</span> <span class="nf">test_newline_decoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">encodings</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c"># None meaning the IncrementalNewlineDecoder takes unicode input</span>
            <span class="c"># rather than bytes input</span>
            <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;latin-1&#39;</span><span class="p">,</span>
            <span class="s">&#39;utf-16&#39;</span><span class="p">,</span> <span class="s">&#39;utf-16-le&#39;</span><span class="p">,</span> <span class="s">&#39;utf-16-be&#39;</span><span class="p">,</span>
            <span class="s">&#39;utf-32&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32-le&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32-be&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encodings</span><span class="p">:</span>
            <span class="n">decoder</span> <span class="o">=</span> <span class="n">enc</span> <span class="ow">and</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getincrementaldecoder</span><span class="p">(</span><span class="n">enc</span><span class="p">)()</span>
            <span class="n">decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IncrementalNewlineDecoder</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_newline_decoding</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">enc</span><span class="p">)</span>
        <span class="n">decoder</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getincrementaldecoder</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)()</span>
        <span class="n">decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IncrementalNewlineDecoder</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_newline_decoding_utf8</span><span class="p">(</span><span class="n">decoder</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IncrementalNewlineDecoderTest.test_newline_bytes"><a class="viewcode-back" href="../../test.html#test.test_io.IncrementalNewlineDecoderTest.test_newline_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">test_newline_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 5433: Excessive optimization in IncrementalNewlineDecoder</span>
        <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">dec</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\u0D00</span><span class="s">&quot;</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\u0D00</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\u0A00</span><span class="s">&quot;</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\u0A00</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IncrementalNewlineDecoder</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">_check</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IncrementalNewlineDecoder</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_check</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="CIncrementalNewlineDecoderTest"><a class="viewcode-back" href="../../test.html#test.test_io.CIncrementalNewlineDecoderTest">[docs]</a><span class="k">class</span> <span class="nc">CIncrementalNewlineDecoderTest</span><span class="p">(</span><span class="n">IncrementalNewlineDecoderTest</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PyIncrementalNewlineDecoderTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyIncrementalNewlineDecoderTest">[docs]</a><span class="k">class</span> <span class="nc">PyIncrementalNewlineDecoderTest</span><span class="p">(</span><span class="n">IncrementalNewlineDecoderTest</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c"># XXX Tests for open()</span>
</div>
<div class="viewcode-block" id="MiscIOTest"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest">[docs]</a><span class="k">class</span> <span class="nc">MiscIOTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="MiscIOTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test___all__"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test___all__">[docs]</a>    <span class="k">def</span> <span class="nf">test___all__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;open&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="s">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;UnsupportedOperation&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SEEK_&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IOBase</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_attributes"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>            <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>     <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>            <span class="s">&quot;U&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>     <span class="s">&quot;rb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>            <span class="s">&quot;w+&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>     <span class="s">&quot;rb+&quot;</span><span class="p">)</span> <span class="c"># Does it really matter?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;rb+&quot;</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>     <span class="s">&quot;wb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>     <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_io_after_close"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_io_after_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_io_after_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;wb&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;r&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;rb&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+b&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+b&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">]:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">isatty</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">__iter__</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;peek&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">peek</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;read1&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;readall&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readall</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;readinto&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">,</span>
                              <span class="n">b</span><span class="s">&quot;&quot;</span> <span class="k">if</span> <span class="s">&quot;b&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_blockingioerror"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_blockingioerror">[docs]</a>    <span class="k">def</span> <span class="nf">test_blockingioerror</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Various BlockingIOError issues</span>
        <span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BlockingIOError</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">b</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">c</span><span class="p">,</span> <span class="n">b</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wr</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">wr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_abcs"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_abcs">[docs]</a>    <span class="k">def</span> <span class="nf">test_abcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test the visible base classes are ABCs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IOBase</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_abc_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abcmodule</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">abcmodule</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">)</span>

<div class="viewcode-block" id="MiscIOTest.test_abc_inheritance"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_abc_inheritance">[docs]</a>    <span class="k">def</span> <span class="nf">test_abc_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test implementations inherit from their respective ABCs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abc_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_abc_inheritance_official"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_abc_inheritance_official">[docs]</a>    <span class="k">def</span> <span class="nf">test_abc_inheritance_official</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test implementations inherit from the official ABCs of the</span>
        <span class="c"># baseline &quot;io&quot; module.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_abc_inheritance</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_warn_on_dealloc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="n">ResourceWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<div class="viewcode-block" id="MiscIOTest.test_warn_on_dealloc"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_warn_on_dealloc">[docs]</a>    <span class="k">def</span> <span class="nf">test_warn_on_dealloc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_warn_on_dealloc_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">cleanup_fds</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">fds</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">:</span>
                        <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">cleanup_fds</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">fds</span> <span class="o">+=</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># When using closefd=False, there&#39;s no warning</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">fds</span> <span class="o">+=</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">recorded</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">recorded</span><span class="p">,</span> <span class="p">[])</span>

<div class="viewcode-block" id="MiscIOTest.test_warn_on_dealloc_fd"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_warn_on_dealloc_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_warn_on_dealloc_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc_fd</span><span class="p">(</span><span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc_fd</span><span class="p">(</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_warn_on_dealloc_fd</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MiscIOTest.test_pickling"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_pickling">[docs]</a>    <span class="k">def</span> <span class="nf">test_pickling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Pickling file objects is forbidden</span>
        <span class="k">for</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;wb&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;r&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;rb&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+b&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;w+b&quot;</span><span class="p">,</span> <span class="s">&quot;buffering&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">]:</span>
            <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">fcntl</span><span class="p">,</span> <span class="s">&#39;fcntl required for this test&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MiscIOTest.test_nonblock_pipe_write_bigbuf"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_nonblock_pipe_write_bigbuf">[docs]</a>    <span class="k">def</span> <span class="nf">test_nonblock_pipe_write_bigbuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_nonblock_pipe_write</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">fcntl</span><span class="p">,</span> <span class="s">&#39;fcntl required for this test&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MiscIOTest.test_nonblock_pipe_write_smallbuf"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_nonblock_pipe_write_smallbuf">[docs]</a>    <span class="k">def</span> <span class="nf">test_nonblock_pipe_write_smallbuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_nonblock_pipe_write</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_set_non_blocking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_test_nonblock_pipe_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">):</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">received</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_non_blocking</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_non_blocking</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="c"># To exercise all code paths in the C implementation we need</span>
        <span class="c"># to play with buffer sizes.  For instance, if we choose a</span>
        <span class="c"># buffer size less than or equal to _PIPE_BUF (4096 on Linux)</span>
        <span class="c"># then we will never get a partial write of the buffer.</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="n">bufsize</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rf</span><span class="p">,</span> <span class="n">wf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="mi">9999</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">7574</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">i</span> <span class="o">%</span> <span class="mi">26</span> <span class="o">+</span> <span class="mi">97</span><span class="p">])</span> <span class="o">*</span> <span class="n">N</span>
                        <span class="n">sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">wf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">BlockingIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">characters_written</span><span class="p">)</span>
                    <span class="n">sent</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sent</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">e</span><span class="o">.</span><span class="n">characters_written</span><span class="p">]</span>
                    <span class="n">received</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;BLOCKED&#39;</span>
                    <span class="n">wf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">BlockingIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">characters_written</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">characters_written</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">received</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

            <span class="n">received</span> <span class="o">+=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">sent</span><span class="p">,</span> <span class="n">received</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sent</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">received</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sent</span> <span class="o">==</span> <span class="n">received</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

<div class="viewcode-block" id="MiscIOTest.test_create_fail"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_create_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># &#39;x&#39; mode fails if file is existing</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileExistsError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_create_writes"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_create_writes">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_writes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># &#39;x&#39; mode opens for writing</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;xb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;spam&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;spam&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="MiscIOTest.test_open_allargs"><a class="viewcode-back" href="../../test.html#test.test_io.MiscIOTest.test_open_allargs">[docs]</a>    <span class="k">def</span> <span class="nf">test_open_allargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># there used to be a buffer overflow in the parser for rawmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;rwax+&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="CMiscIOTest"><a class="viewcode-back" href="../../test.html#test.test_io.CMiscIOTest">[docs]</a><span class="k">class</span> <span class="nc">CMiscIOTest</span><span class="p">(</span><span class="n">MiscIOTest</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">io</span>

<div class="viewcode-block" id="CMiscIOTest.test_readinto_buffer_overflow"><a class="viewcode-back" href="../../test.html#test.test_io.CMiscIOTest.test_readinto_buffer_overflow">[docs]</a>    <span class="k">def</span> <span class="nf">test_readinto_buffer_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #18025</span>
        <span class="k">class</span> <span class="nc">BadReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">b</span><span class="s">&#39;x&#39;</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="n">bufio</span> <span class="o">=</span> <span class="n">BadReader</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">bufio</span><span class="o">.</span><span class="n">readinto</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="PyMiscIOTest"><a class="viewcode-back" href="../../test.html#test.test_io.PyMiscIOTest">[docs]</a><span class="k">class</span> <span class="nc">PyMiscIOTest</span><span class="p">(</span><span class="n">MiscIOTest</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">pyio</span>

</div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">,</span> <span class="s">&#39;POSIX signals required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SignalsTest"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest">[docs]</a><span class="k">class</span> <span class="nc">SignalsTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="SignalsTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldalrm</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm_interrupt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldalrm</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.alarm_interrupt"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.alarm_interrupt">[docs]</a>    <span class="k">def</span> <span class="nf">alarm_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">threading</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SignalsTest.check_interrupted_write"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.check_interrupted_write">[docs]</a>    <span class="k">def</span> <span class="nf">check_interrupted_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that a partial write, when it gets interrupted, properly</span>
<span class="sd">        invokes the signal handler, and bubbles up the exception raised</span>
<span class="sd">        in the latter.&quot;&quot;&quot;</span>
        <span class="n">read_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">_read</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;pthread_sigmask&#39;</span><span class="p">):</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">read_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_read</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">fdopen_kwargs</span><span class="p">[</span><span class="s">&quot;closefd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c"># Fill the pipe enough that the write will be blocking.</span>
            <span class="c"># It will be interrupted by the timer armed above.  Since the</span>
            <span class="c"># other thread has read one byte, the low-level write will</span>
            <span class="c"># return with a successful (partial) result rather than an EINTR.</span>
            <span class="c"># The buffered IO layer must check for pending signal</span>
            <span class="c"># handlers, which in this case will invoke alarm_interrupt().</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">,</span>
                            <span class="n">wio</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">item</span> <span class="o">*</span> <span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">PIPE_MAX_SIZE</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="c"># We got one byte, get another one and check that it isn&#39;t a</span>
            <span class="c"># repeat of the first one.</span>
            <span class="n">read_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">read_results</span><span class="p">,</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="c"># This is deliberate. If we didn&#39;t close the file descriptor</span>
            <span class="c"># before closing wio, wio would try to flush its internal</span>
            <span class="c"># buffer, and block again.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">:</span>
                    <span class="k">raise</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_interrupted_write_unbuffered"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_write_unbuffered">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_write_unbuffered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_interrupted_write_buffered"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_write_buffered">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_write_buffered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>

    <span class="c"># Issue #22331: The test hangs on FreeBSD 7.2</span></div>
    <span class="nd">@support.requires_freebsd_version</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<div class="viewcode-block" id="SignalsTest.test_interrupted_write_text"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_write_text">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_write_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_write</span><span class="p">(</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@support.no_tracing</span>
<div class="viewcode-block" id="SignalsTest.check_reentrant_write"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.check_reentrant_write">[docs]</a>    <span class="k">def</span> <span class="nf">check_reentrant_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">on_alarm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="c"># Will be called reentrantly from the same thread</span>
            <span class="n">wio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">on_alarm</span><span class="p">)</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">wio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># Either the reentrant call to wio.write() fails with RuntimeError,</span>
            <span class="c"># or the signal handler raises ZeroDivisionError.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="ne">ZeroDivisionError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">))</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                        <span class="n">wio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">wio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="c"># Make sure the buffer doesn&#39;t fill up and block further writes</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">exception</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;reentrant call&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">wio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_reentrant_write_buffered"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_reentrant_write_buffered">[docs]</a>    <span class="k">def</span> <span class="nf">test_reentrant_write_buffered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_reentrant_write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_reentrant_write_text"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_reentrant_write_text">[docs]</a>    <span class="k">def</span> <span class="nf">test_reentrant_write_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_reentrant_write</span><span class="p">(</span><span class="s">&quot;xy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.check_interrupted_read_retry"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.check_interrupted_read_retry">[docs]</a>    <span class="k">def</span> <span class="nf">check_interrupted_read_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decode</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that a buffered read, when it gets interrupted (either</span>
<span class="sd">        returning a partial result or EINTR), properly invokes the signal</span>
<span class="sd">        handler and retries if the latter returned successfully.&quot;&quot;&quot;</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">fdopen_kwargs</span><span class="p">[</span><span class="s">&quot;closefd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">def</span> <span class="nf">alarm_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;bar&quot;</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">alarm_handler</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># Expected behaviour:</span>
            <span class="c"># - first raw read() returns partial b&quot;foo&quot;</span>
            <span class="c"># - second raw read() returns EINTR</span>
            <span class="c"># - third raw read() returns b&quot;bar&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">decode</span><span class="p">(</span><span class="n">rio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span> <span class="s">&quot;foobar&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">rio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_interrupted_read_retry_buffered"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_read_retry_buffered">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_read_retry_buffered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_read_retry</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;latin1&#39;</span><span class="p">),</span>
                                          <span class="n">mode</span><span class="o">=</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_interrupted_read_retry_text"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_read_retry_text">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_read_retry_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_read_retry</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                                          <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">threading</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SignalsTest.check_interrupted_write_retry"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.check_interrupted_write_retry">[docs]</a>    <span class="k">def</span> <span class="nf">check_interrupted_write_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that a buffered write, when it gets interrupted (either</span>
<span class="sd">        returning a partial result or EINTR), properly invokes the signal</span>
<span class="sd">        handler and retries if the latter returned successfully.&quot;&quot;&quot;</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s">&quot;select&quot;</span><span class="p">)</span>
        <span class="c"># A quantity that exceeds the buffer size of an anonymous pipe&#39;s</span>
        <span class="c"># write end.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">PIPE_MAX_SIZE</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">fdopen_kwargs</span><span class="p">[</span><span class="s">&quot;closefd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># We need a separate thread to read from the pipe and allow the</span>
        <span class="c"># write() to finish.  This thread is started after the SIGALRM is</span>
        <span class="c"># received (forcing a first EINTR in write()).</span>
        <span class="n">read_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">write_finished</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">def</span> <span class="nf">_read</span><span class="p">():</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">write_finished</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">r</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                    <span class="n">read_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_read</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">alarm1</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">alarm2</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">alarm2</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">alarm1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">**</span><span class="n">fdopen_kwargs</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># Expected behaviour:</span>
            <span class="c"># - first raw write() is partial (because of the limited pipe buffer</span>
            <span class="c">#   and the first alarm)</span>
            <span class="c"># - second raw write() returns EINTR (because of the second alarm)</span>
            <span class="c"># - subsequent write()s are successful (either partial or complete)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">wio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span> <span class="o">*</span> <span class="n">N</span><span class="p">))</span>
            <span class="n">wio</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">write_finished</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">read_results</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">write_finished</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="c"># This is deliberate. If we didn&#39;t close the file descriptor</span>
            <span class="c"># before closing wio, wio would try to flush its internal</span>
            <span class="c"># buffer, and could block (in case of failure).</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">:</span>
                    <span class="k">raise</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_interrupted_write_retry_buffered"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_write_retry_buffered">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_write_retry_buffered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_write_retry</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SignalsTest.test_interrupted_write_retry_text"><a class="viewcode-back" href="../../test.html#test.test_io.SignalsTest.test_interrupted_write_retry_text">[docs]</a>    <span class="k">def</span> <span class="nf">test_interrupted_write_retry_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_interrupted_write_retry</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;latin1&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="CSignalsTest"><a class="viewcode-back" href="../../test.html#test.test_io.CSignalsTest">[docs]</a><span class="k">class</span> <span class="nc">CSignalsTest</span><span class="p">(</span><span class="n">SignalsTest</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
</div>
<div class="viewcode-block" id="PySignalsTest"><a class="viewcode-back" href="../../test.html#test.test_io.PySignalsTest">[docs]</a><span class="k">class</span> <span class="nc">PySignalsTest</span><span class="p">(</span><span class="n">SignalsTest</span><span class="p">):</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">pyio</span>

    <span class="c"># Handling reentrancy issues would slow down _pyio even more, so the</span>
    <span class="c"># tests are disabled.</span>
    <span class="n">test_reentrant_write_buffered</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">test_reentrant_write_text</span> <span class="o">=</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="load_tests"><a class="viewcode-back" href="../../test.html#test.test_io.load_tests">[docs]</a><span class="k">def</span> <span class="nf">load_tests</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="p">(</span><span class="n">CIOTest</span><span class="p">,</span> <span class="n">PyIOTest</span><span class="p">,</span>
             <span class="n">CBufferedReaderTest</span><span class="p">,</span> <span class="n">PyBufferedReaderTest</span><span class="p">,</span>
             <span class="n">CBufferedWriterTest</span><span class="p">,</span> <span class="n">PyBufferedWriterTest</span><span class="p">,</span>
             <span class="n">CBufferedRWPairTest</span><span class="p">,</span> <span class="n">PyBufferedRWPairTest</span><span class="p">,</span>
             <span class="n">CBufferedRandomTest</span><span class="p">,</span> <span class="n">PyBufferedRandomTest</span><span class="p">,</span>
             <span class="n">StatefulIncrementalDecoderTest</span><span class="p">,</span>
             <span class="n">CIncrementalNewlineDecoderTest</span><span class="p">,</span> <span class="n">PyIncrementalNewlineDecoderTest</span><span class="p">,</span>
             <span class="n">CTextIOWrapperTest</span><span class="p">,</span> <span class="n">PyTextIOWrapperTest</span><span class="p">,</span>
             <span class="n">CMiscIOTest</span><span class="p">,</span> <span class="n">PyMiscIOTest</span><span class="p">,</span>
             <span class="n">CSignalsTest</span><span class="p">,</span> <span class="n">PySignalsTest</span><span class="p">,</span>
             <span class="p">)</span>

    <span class="c"># Put the namespaces of the IO module we are testing and some useful mock</span>
    <span class="c"># classes in the __dict__ of each test.</span>
    <span class="n">mocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">MockRawIO</span><span class="p">,</span> <span class="n">MisbehavedRawIO</span><span class="p">,</span> <span class="n">MockFileIO</span><span class="p">,</span> <span class="n">CloseFailureIO</span><span class="p">,</span>
             <span class="n">MockNonBlockWriterIO</span><span class="p">,</span> <span class="n">MockUnseekableIO</span><span class="p">,</span> <span class="n">MockRawIOWithoutRead</span><span class="p">)</span>
    <span class="n">all_members</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">__all__</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;IncrementalNewlineDecoder&quot;</span><span class="p">]</span>
    <span class="n">c_io_ns</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_members</span><span class="p">}</span>
    <span class="n">py_io_ns</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pyio</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_members</span><span class="p">}</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
    <span class="n">c_io_ns</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">globs</span><span class="p">[</span><span class="s">&quot;C&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mocks</span><span class="p">)</span>
    <span class="n">py_io_ns</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">globs</span><span class="p">[</span><span class="s">&quot;Py&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mocks</span><span class="p">)</span>
    <span class="c"># Avoid turning open into a bound method.</span>
    <span class="n">py_io_ns</span><span class="p">[</span><span class="s">&quot;open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyio</span><span class="o">.</span><span class="n">OpenWrapper</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">c_io_ns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">test</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Py&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">py_io_ns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">([</span><span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">suite</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>