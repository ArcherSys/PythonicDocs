

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.regrtest &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.regrtest</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.regrtest</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python3</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to run Python regression tests.</span>

<span class="sd">Run this script with -h or --help for documentation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">USAGE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">python -m test [options] [test_name1 [test_name2 ...]]</span>
<span class="s">python path/to/Lib/test/regrtest.py [options] [test_name1 [test_name2 ...]]</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">Run Python regression tests.</span>

<span class="s">If no arguments or options are provided, finds all files matching</span>
<span class="s">the pattern &quot;test_*&quot; in the Lib/test subdirectory and runs</span>
<span class="s">them in alphabetical order (but see -M and -u, below, for exceptions).</span>

<span class="s">For more rigorous testing, it is useful to use the following</span>
<span class="s">command line:</span>

<span class="s">python -E -Wd -m test [options] [test_name1 ...]</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">EPILOG</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">Additional option details:</span>

<span class="s">-r randomizes test execution order. You can use --randseed=int to provide a</span>
<span class="s">int seed value for the randomizer; this is useful for reproducing troublesome</span>
<span class="s">test orders.</span>

<span class="s">-s On the first invocation of regrtest using -s, the first test file found</span>
<span class="s">or the first test file given on the command line is run, and the name of</span>
<span class="s">the next test is recorded in a file named pynexttest.  If run from the</span>
<span class="s">Python build directory, pynexttest is located in the &#39;build&#39; subdirectory,</span>
<span class="s">otherwise it is located in tempfile.gettempdir().  On subsequent runs,</span>
<span class="s">the test in pynexttest is run, and the next test is written to pynexttest.</span>
<span class="s">When the last test has been run, pynexttest is deleted.  In this way it</span>
<span class="s">is possible to single step through the test files.  This is useful when</span>
<span class="s">doing memory analysis on the Python interpreter, which process tends to</span>
<span class="s">consume too many resources to run the full regression test non-stop.</span>

<span class="s">-S is used to continue running tests after an aborted run.  It will</span>
<span class="s">maintain the order a standard run (ie, this assumes -r is not used).</span>
<span class="s">This is useful after the tests have prematurely stopped for some external</span>
<span class="s">reason and you want to start running from where you left off rather</span>
<span class="s">than starting from the beginning.</span>

<span class="s">-f reads the names of tests from the file given as f&#39;s argument, one</span>
<span class="s">or more test names per line.  Whitespace is ignored.  Blank lines and</span>
<span class="s">lines beginning with &#39;#&#39; are ignored.  This is especially useful for</span>
<span class="s">whittling down failures involving interactions among tests.</span>

<span class="s">-L causes the leaks(1) command to be run just before exit if it exists.</span>
<span class="s">leaks(1) is available on Mac OS X and presumably on some other</span>
<span class="s">FreeBSD-derived systems.</span>

<span class="s">-R runs each test several times and examines sys.gettotalrefcount() to</span>
<span class="s">see if the test appears to be leaking references.  The argument should</span>
<span class="s">be of the form stab:run:fname where &#39;stab&#39; is the number of times the</span>
<span class="s">test is run to let gettotalrefcount settle down, &#39;run&#39; is the number</span>
<span class="s">of times further it is run and &#39;fname&#39; is the name of the file the</span>
<span class="s">reports are written to.  These parameters all have defaults (5, 4 and</span>
<span class="s">&quot;reflog.txt&quot; respectively), and the minimal invocation is &#39;-R :&#39;.</span>

<span class="s">-M runs tests that require an exorbitant amount of memory. These tests</span>
<span class="s">typically try to ascertain containers keep working when containing more than</span>
<span class="s">2 billion objects, which only works on 64-bit systems. There are also some</span>
<span class="s">tests that try to exhaust the address space of the process, which only makes</span>
<span class="s">sense on 32-bit systems with at least 2Gb of memory. The passed-in memlimit,</span>
<span class="s">which is a string in the form of &#39;2.5Gb&#39;, determines howmuch memory the</span>
<span class="s">tests will limit themselves to (but they may go slightly over.) The number</span>
<span class="s">shouldn&#39;t be more memory than the machine has (including swap memory). You</span>
<span class="s">should also keep in mind that swap memory is generally much, much slower</span>
<span class="s">than RAM, and setting memlimit to all available RAM or higher will heavily</span>
<span class="s">tax the machine. On the other hand, it is no use running these tests with a</span>
<span class="s">limit of less than 2.5Gb, and many require more than 20Gb. Tests that expect</span>
<span class="s">to use more than memlimit memory will be skipped. The big-memory tests</span>
<span class="s">generally run very, very long.</span>

<span class="s">-u is used to specify which special resource intensive tests to run,</span>
<span class="s">such as those requiring large file support or network connectivity.</span>
<span class="s">The argument is a comma-separated list of words indicating the</span>
<span class="s">resources to test.  Currently only the following are defined:</span>

<span class="s">    all -       Enable all special resources.</span>

<span class="s">    none -      Disable all special resources (this is the default).</span>

<span class="s">    audio -     Tests that use the audio device.  (There are known</span>
<span class="s">                cases of broken audio drivers that can crash Python or</span>
<span class="s">                even the Linux kernel.)</span>

<span class="s">    curses -    Tests that use curses and will modify the terminal&#39;s</span>
<span class="s">                state and output modes.</span>

<span class="s">    largefile - It is okay to run some test that may create huge</span>
<span class="s">                files.  These tests can take a long time and may</span>
<span class="s">                consume &gt;2GB of disk space temporarily.</span>

<span class="s">    network -   It is okay to run tests that use external network</span>
<span class="s">                resource, e.g. testing SSL support for sockets.</span>

<span class="s">    decimal -   Test the decimal module against a large suite that</span>
<span class="s">                verifies compliance with standards.</span>

<span class="s">    cpu -       Used for certain CPU-heavy tests.</span>

<span class="s">    subprocess  Run all tests for the subprocess module.</span>

<span class="s">    urlfetch -  It is okay to download files required on testing.</span>

<span class="s">    gui -       Run tests that require a running GUI.</span>

<span class="s">To enable all resources except one, use &#39;-uall,-&lt;resource&gt;&#39;.  For</span>
<span class="s">example, to run all the tests except for the gui tests, give the</span>
<span class="s">option &#39;-uall,-gui&#39;.</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="c"># We import importlib *ASAP* in order to test #15386</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">faulthandler</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sysconfig</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isabstract</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_multiprocessing</span><span class="o">,</span> <span class="nn">multiprocessing.process</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">multiprocessing</span> <span class="o">=</span> <span class="bp">None</span>


<span class="c"># Some times __path__ and __file__ are not absolute (e.g. while running from</span>
<span class="c"># Lib/) and, if we change the CWD to run the tests in a temporary dir, some</span>
<span class="c"># imports might fail.  This affects only the modules imported before os.chdir().</span>
<span class="c"># These modules are searched first in sys.path[0] (so &#39;&#39; -- the CWD) and if</span>
<span class="c"># they are found in the CWD their __file__ and __path__ will be relative (this</span>
<span class="c"># happens before the chdir).  All the modules imported after the chdir, are</span>
<span class="c"># not found in the CWD, and since the other paths in sys.path[1:] are absolute</span>
<span class="c"># (site.py absolutize them), the __file__ and __path__ will be absolute too.</span>
<span class="c"># Therefore it is necessary to absolutize manually the __file__ and __path__ of</span>
<span class="c"># the packages to prevent later imports to fail when the CWD is different.</span>
<span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;__path__&#39;</span><span class="p">):</span>
        <span class="n">module</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;__file__&#39;</span><span class="p">):</span>
        <span class="n">module</span><span class="o">.</span><span class="n">__file__</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>


<span class="c"># MacOSX (a.k.a. Darwin) has a default stack size that is too small</span>
<span class="c"># for deeply recursive regular expressions.  We see this as crashes in</span>
<span class="c"># the Python test suite when running test_re.py and test_sre.py.  The</span>
<span class="c"># fix is to set the stack limit to 2048.</span>
<span class="c"># This approach may also be useful for other Unixy platforms that</span>
<span class="c"># suffer from small default stack limits.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">resource</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">soft</span><span class="p">,</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_STACK</span><span class="p">)</span>
        <span class="n">newsoft</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hard</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">2048</span><span class="p">))</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_STACK</span><span class="p">,</span> <span class="p">(</span><span class="n">newsoft</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span>

<span class="c"># Test result constants.</span>
<span class="n">PASSED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FAILED</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ENV_CHANGED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">SKIPPED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">RESOURCE_DENIED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
<span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
<span class="n">CHILD_ERROR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>   <span class="c"># error in a child process</span>

<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>

<span class="n">RESOURCE_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;audio&#39;</span><span class="p">,</span> <span class="s">&#39;curses&#39;</span><span class="p">,</span> <span class="s">&#39;largefile&#39;</span><span class="p">,</span> <span class="s">&#39;network&#39;</span><span class="p">,</span>
                  <span class="s">&#39;decimal&#39;</span><span class="p">,</span> <span class="s">&#39;cpu&#39;</span><span class="p">,</span> <span class="s">&#39;subprocess&#39;</span><span class="p">,</span> <span class="s">&#39;urlfetch&#39;</span><span class="p">,</span> <span class="s">&#39;gui&#39;</span><span class="p">)</span>

<span class="c"># When tests are run from the Python build directory, it is best practice</span>
<span class="c"># to keep the test files in a subfolder.  This eases the cleanup of leftover</span>
<span class="c"># files using the &quot;make distclean&quot; command.</span>
<span class="k">if</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">is_python_build</span><span class="p">():</span>
    <span class="n">TEMPDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s">&#39;srcdir&#39;</span><span class="p">),</span> <span class="s">&#39;build&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">TEMPDIR</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
<span class="n">TEMPDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_ArgParser</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Pass -h or --help for complete help.&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_parser</span><span class="p">():</span>
    <span class="c"># Set prog to prevent the uninformative &quot;__main__.py&quot; from displaying in</span>
    <span class="c"># error messages when using &quot;python -m test ...&quot;.</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">_ArgParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s">&#39;regrtest.py&#39;</span><span class="p">,</span>
                        <span class="n">usage</span><span class="o">=</span><span class="n">USAGE</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">DESCRIPTION</span><span class="p">,</span>
                        <span class="n">epilog</span><span class="o">=</span><span class="n">EPILOG</span><span class="p">,</span>
                        <span class="n">add_help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>

    <span class="c"># Arguments with this clause added to its help are described further in</span>
    <span class="c"># the epilog&#39;s &quot;Additional option details&quot; section.</span>
    <span class="n">more_details</span> <span class="o">=</span> <span class="s">&#39;  See the section at bottom for more details.&#39;</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;General options&#39;</span><span class="p">)</span>
    <span class="c"># We add help explicitly to control what argument group it renders under.</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-h&#39;</span><span class="p">,</span> <span class="s">&#39;--help&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;help&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;show this help message and exit&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--timeout&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TIMEOUT&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;dump the traceback and exit if a test takes &#39;</span>
                             <span class="s">&#39;more than TIMEOUT seconds; disabled if TIMEOUT &#39;</span>
                             <span class="s">&#39;is negative or equals to zero&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--wait&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;wait for user input, e.g., allow a debugger &#39;</span>
                            <span class="s">&#39;to be attached&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--slaveargs&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;ARGS&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-S&#39;</span><span class="p">,</span> <span class="s">&#39;--start&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;START&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;the name of the test at which to start.&#39;</span> <span class="o">+</span>
                            <span class="n">more_details</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;Verbosity&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;count&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;run tests in verbose mode with output to stdout&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-w&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose2&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;re-run failed tests in verbose mode&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-W&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose3&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;display test output on failure&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;no output unless one or more tests fail&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--slow&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;print_slow&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;print the slowest 10 tests&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--header&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;print header with interpreter info&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;Selecting tests&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="s">&#39;--randomize&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;randomize test execution order.&#39;</span> <span class="o">+</span> <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--randseed&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;SEED&#39;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s">&#39;random_seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;pass a random seed to reproduce a previous &#39;</span>
                            <span class="s">&#39;random run&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--fromfile&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;FILE&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;read names of tests to run from a file.&#39;</span> <span class="o">+</span>
                            <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-x&#39;</span><span class="p">,</span> <span class="s">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;arguments are tests to *exclude*&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--single&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;single step through a set of tests.&#39;</span> <span class="o">+</span>
                            <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--match&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PAT&#39;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s">&#39;match_tests&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;match test cases and methods with glob pattern PAT&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-G&#39;</span><span class="p">,</span> <span class="s">&#39;--failfast&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;fail as soon as a test fails (only with -v or -W)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="s">&#39;--use&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;RES1,RES2,...&#39;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s">&#39;append&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">resources_list</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;specify which special resource intensive tests &#39;</span>
                            <span class="s">&#39;to run.&#39;</span> <span class="o">+</span> <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-M&#39;</span><span class="p">,</span> <span class="s">&#39;--memlimit&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;LIMIT&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;run very large memory-consuming tests.&#39;</span> <span class="o">+</span>
                            <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--testdir&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;DIR&#39;</span><span class="p">,</span>
                       <span class="nb">type</span><span class="o">=</span><span class="n">relative_filename</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;execute test files in the specified directory &#39;</span>
                            <span class="s">&#39;(instead of the Python stdlib test suite)&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s">&#39;Special runs&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-l&#39;</span><span class="p">,</span> <span class="s">&#39;--findleaks&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;if GC is available detect tests that leak memory&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-L&#39;</span><span class="p">,</span> <span class="s">&#39;--runleaks&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;run the leaks(1) command just before exit.&#39;</span> <span class="o">+</span>
                            <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-R&#39;</span><span class="p">,</span> <span class="s">&#39;--huntrleaks&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;RUNCOUNTS&#39;</span><span class="p">,</span>
                       <span class="nb">type</span><span class="o">=</span><span class="n">huntrleaks</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;search for reference leaks (needs debug build, &#39;</span>
                            <span class="s">&#39;very slow).&#39;</span> <span class="o">+</span> <span class="n">more_details</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-j&#39;</span><span class="p">,</span> <span class="s">&#39;--multiprocess&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PROCESSES&#39;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s">&#39;use_mp&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;run PROCESSES processes at once&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-T&#39;</span><span class="p">,</span> <span class="s">&#39;--coverage&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s">&#39;trace&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;turn on code coverage tracing using the trace &#39;</span>
                            <span class="s">&#39;module&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-D&#39;</span><span class="p">,</span> <span class="s">&#39;--coverdir&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;DIR&#39;</span><span class="p">,</span>
                       <span class="nb">type</span><span class="o">=</span><span class="n">relative_filename</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;directory where coverage files are put&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-N&#39;</span><span class="p">,</span> <span class="s">&#39;--nocoverdir&#39;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_const&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;coverdir&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;put coverage files alongside modules&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--threshold&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;THRESHOLD&#39;</span><span class="p">,</span>
                       <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;call gc.set_threshold(THRESHOLD)&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--nowindows&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;suppress error message boxes on Windows&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-F&#39;</span><span class="p">,</span> <span class="s">&#39;--forever&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">&#39;run the specified tests in a loop, until an &#39;</span>
                            <span class="s">&#39;error happens&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>

<div class="viewcode-block" id="relative_filename"><a class="viewcode-back" href="../../test.html#test.regrtest.relative_filename">[docs]</a><span class="k">def</span> <span class="nf">relative_filename</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="c"># CWD is replaced with a temporary dir before calling main(), so we</span>
    <span class="c"># join it with the saved CWD so it ends up where the user expects.</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">SAVEDCWD</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="huntrleaks"><a class="viewcode-back" href="../../test.html#test.regrtest.huntrleaks">[docs]</a><span class="k">def</span> <span class="nf">huntrleaks</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span>
            <span class="s">&#39;needs 2 or 3 colon-separated arguments&#39;</span><span class="p">)</span>
    <span class="n">nwarmup</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">5</span>
    <span class="n">ntracked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">4</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s">&#39;reflog.txt&#39;</span>
    <span class="k">return</span> <span class="n">nwarmup</span><span class="p">,</span> <span class="n">ntracked</span><span class="p">,</span> <span class="n">fname</span>
</div>
<div class="viewcode-block" id="resources_list"><a class="viewcode-back" href="../../test.html#test.regrtest.resources_list">[docs]</a><span class="k">def</span> <span class="nf">resources_list</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&#39;none&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RESOURCE_NAMES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s">&#39;invalid resource: &#39;</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span>
</div>
<span class="k">def</span> <span class="nf">_parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c"># Defaults</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="n">testdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
         <span class="n">exclude</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fromfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
         <span class="n">findleaks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_resources</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">coverdir</span><span class="o">=</span><span class="s">&#39;coverage&#39;</span><span class="p">,</span>
         <span class="n">runleaks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">huntrleaks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose2</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">print_slow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
         <span class="n">random_seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_mp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose3</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">forever</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
         <span class="n">header</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">failfast</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">match_tests</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> is an invalid keyword argument &#39;</span>
                            <span class="s">&#39;for this function&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">_create_parser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">single</span> <span class="ow">and</span> <span class="n">ns</span><span class="o">.</span><span class="n">fromfile</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;-s and -f don&#39;t go together!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="ow">and</span> <span class="n">ns</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;-T and -j don&#39;t go together!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="ow">and</span> <span class="n">ns</span><span class="o">.</span><span class="n">findleaks</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;-l and -j don&#39;t go together!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="ow">and</span> <span class="n">ns</span><span class="o">.</span><span class="n">memlimit</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;-M and -j don&#39;t go together!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">failfast</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">ns</span><span class="o">.</span><span class="n">verbose3</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;-G/--failfast needs either -v or -W&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">faulthandler</span><span class="p">,</span> <span class="s">&#39;dump_traceback_later&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Warning: The timeout option requires &quot;</span>
                  <span class="s">&quot;faulthandler.dump_traceback_later&quot;</span><span class="p">)</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Use all cores + extras for tests that like to sleep</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">use</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">RESOURCE_NAMES</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&#39;none&#39;</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="p">[:]</span>
                    <span class="k">continue</span>
                <span class="n">remove</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">remove</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="p">:</span>
                        <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="p">:</span>
                    <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">randomize</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">ns</span>


<div class="viewcode-block" id="run_test_in_subprocess"><a class="viewcode-back" href="../../test.html#test.regrtest.run_test_in_subprocess">[docs]</a><span class="k">def</span> <span class="nf">run_test_in_subprocess</span><span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run the given test in a subprocess with --slaveargs.</span>

<span class="sd">    ns is the option Namespace parsed from command-line arguments. regrtest</span>
<span class="sd">    is invoked in a subprocess with the --slaveargs argument; when the</span>
<span class="sd">    subprocess exits, its return code, stdout and stderr are returned as a</span>
<span class="sd">    3-tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
    <span class="n">base_cmd</span> <span class="o">=</span> <span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span> <span class="o">+</span> <span class="n">support</span><span class="o">.</span><span class="n">args_from_interpreter_flags</span><span class="p">()</span> <span class="o">+</span>
                <span class="p">[</span><span class="s">&#39;-X&#39;</span><span class="p">,</span> <span class="s">&#39;faulthandler&#39;</span><span class="p">,</span> <span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;test.regrtest&#39;</span><span class="p">])</span>

    <span class="n">slaveargs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">huntrleaks</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">huntrleaks</span><span class="p">,</span>
                 <span class="n">use_resources</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span><span class="p">,</span>
                 <span class="n">output_on_failure</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">verbose3</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">failfast</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">failfast</span><span class="p">,</span>
                 <span class="n">match_tests</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">match_tests</span><span class="p">))</span>
    <span class="c"># Running the child from the same working directory as regrtest&#39;s original</span>
    <span class="c"># invocation ensures that TEMPDIR for the child is the same when</span>
    <span class="c"># sysconfig.is_python_build() is true. See issue 15300.</span>
    <span class="n">popen</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">base_cmd</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;--slaveargs&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">slaveargs</span><span class="p">)],</span>
                  <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
                  <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">close_fds</span><span class="o">=</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;nt&#39;</span><span class="p">),</span>
                  <span class="n">cwd</span><span class="o">=</span><span class="n">support</span><span class="o">.</span><span class="n">SAVEDCWD</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">popen</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="n">retcode</span> <span class="o">=</span> <span class="n">popen</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../test.html#test.regrtest.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute a test suite.</span>

<span class="sd">    This also parses command-line options and modifies its behavior</span>
<span class="sd">    accordingly.</span>

<span class="sd">    tests -- a list of strings containing test names (optional)</span>
<span class="sd">    testdir -- the directory in which to look for tests (optional)</span>

<span class="sd">    Users other than the Python test suite will certainly want to</span>
<span class="sd">    specify testdir; if it&#39;s omitted, the directory containing the</span>
<span class="sd">    Python test suite is searched for.</span>

<span class="sd">    If the tests argument is omitted, the tests listed on the</span>
<span class="sd">    command-line will be used.  If that&#39;s empty, too, then all *.py</span>
<span class="sd">    files beginning with test_ will be used.</span>

<span class="sd">    The other default arguments (verbose, quiet, exclude,</span>
<span class="sd">    single, randomize, findleaks, use_resources, trace, coverdir,</span>
<span class="sd">    print_slow, and random_seed) allow programmers calling main()</span>
<span class="sd">    directly to set the values that would normally be set by flags</span>
<span class="sd">    on the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Display the Python traceback on fatal errors (e.g. segfault)</span>
    <span class="n">faulthandler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">all_threads</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># Display the Python traceback on SIGALRM or SIGUSR1 signal</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;SIGALRM&#39;</span><span class="p">):</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;SIGUSR1&#39;</span><span class="p">):</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">signum</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
        <span class="n">faulthandler</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">replace_stdout</span><span class="p">()</span>

    <span class="n">support</span><span class="o">.</span><span class="n">record_original_stdout</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="n">ns</span> <span class="o">=</span> <span class="n">_parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">huntrleaks</span><span class="p">:</span>
        <span class="c"># Avoid false positives due to various caches</span>
        <span class="c"># filling slowly with random data:</span>
        <span class="n">warm_caches</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">memlimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">set_memlimit</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">memlimit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">gc</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">nowindows</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">msvcrt</span>
        <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_FAILCRITICALERRORS</span><span class="o">|</span>
                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOALIGNMENTFAULTEXCEPT</span><span class="o">|</span>
                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOGPFAULTERRORBOX</span><span class="o">|</span>
                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOOPENFILEERRORBOX</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># release build</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">]:</span>
                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_MODE_FILE</span><span class="p">)</span>
                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportFile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_FILE_STDERR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
        <span class="nb">input</span><span class="p">(</span><span class="s">&quot;Press any key to continue...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">slaveargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">slaveargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;huntrleaks&#39;</span><span class="p">):</span>
            <span class="n">unittest</span><span class="o">.</span><span class="n">BaseTestSuite</span><span class="o">.</span><span class="n">_cleanup</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">runtest</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">INTERRUPTED</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">CHILD_ERROR</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">print</span><span class="p">()</span>   <span class="c"># Force a newline (just in case)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">good</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resource_denieds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">environment_changed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interrupted</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">findleaks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gc</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;No GC available, disabling findleaks.&#39;</span><span class="p">)</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">findleaks</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Uncomment the line below to report garbage that is not</span>
            <span class="c"># freeable by reference counting alone.  By default only</span>
            <span class="c"># garbage that is not collectable by the GC is reported.</span>
            <span class="c">#gc.set_debug(gc.DEBUG_SAVEALL)</span>
            <span class="n">found_garbage</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">huntrleaks</span><span class="p">:</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">BaseTestSuite</span><span class="o">.</span><span class="n">_cleanup</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s">&#39;pynexttest&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">next_test</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">next_test</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">fromfile</span><span class="p">:</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">SAVEDCWD</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">fromfile</span><span class="p">))</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">count_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\[\s*\d+/\s*\d+\]&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">count_pat</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">guts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="c"># assuming no test has whitespace in its name</span>
                <span class="k">if</span> <span class="n">guts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">guts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="n">tests</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">guts</span><span class="p">)</span>

    <span class="c"># Strip .py extensions.</span>
    <span class="n">removepy</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">removepy</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>

    <span class="n">stdtests</span> <span class="o">=</span> <span class="n">STDTESTS</span><span class="p">[:]</span>
    <span class="n">nottests</span> <span class="o">=</span> <span class="n">NOTTESTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">stdtests</span><span class="p">:</span>
                <span class="n">stdtests</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">nottests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># For a partial run, we do not need to clutter the output.</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">ns</span><span class="o">.</span><span class="n">header</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">or</span> <span class="n">ns</span><span class="o">.</span><span class="n">single</span> <span class="ow">or</span> <span class="n">tests</span> <span class="ow">or</span> <span class="n">ns</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># Print basic platform information</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">(),</span> <span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;==  &quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">(</span><span class="n">aliased</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                      <span class="s">&quot;</span><span class="si">%s</span><span class="s">-endian&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;==  &quot;</span><span class="p">,</span> <span class="s">&quot;hash algorithm:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">hash_info</span><span class="o">.</span><span class="n">algorithm</span><span class="p">,</span>
              <span class="s">&quot;64bit&quot;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="k">else</span> <span class="s">&quot;32bit&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;==  &quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Testing with flags:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>

    <span class="c"># if testdir is set, then we are not running the python tests suite, so</span>
    <span class="c"># don&#39;t add default tests to be executed or skipped (pass empty values)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">testdir</span><span class="p">:</span>
        <span class="n">alltests</span> <span class="o">=</span> <span class="n">findtests</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">set</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alltests</span> <span class="o">=</span> <span class="n">findtests</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">stdtests</span><span class="p">,</span> <span class="n">nottests</span><span class="p">)</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="n">tests</span> <span class="ow">or</span> <span class="n">ns</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="n">alltests</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_single_test</span> <span class="o">=</span> <span class="n">alltests</span><span class="p">[</span><span class="n">alltests</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">selected</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">next_single_test</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Remove all the selected tests that precede start if it&#39;s set.</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">selected</span><span class="p">[:</span><span class="n">selected</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find starting test (</span><span class="si">%s</span><span class="s">), using all tests&quot;</span> <span class="o">%</span> <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">randomize</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Using random seed&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">trace</span><span class="o">,</span> <span class="nn">tempfile</span>
        <span class="n">tracer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">ignoredirs</span><span class="o">=</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">base_prefix</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">base_exec_prefix</span><span class="p">,</span>
                                         <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()],</span>
                             <span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">test_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">verbose</span>      <span class="c"># Tell tests to be moderately quiet</span>
    <span class="n">support</span><span class="o">.</span><span class="n">use_resources</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_resources</span>
    <span class="n">save_modules</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">accumulate_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">test_time</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">test_times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">test_time</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">PASSED</span><span class="p">:</span>
            <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">:</span>
            <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">ENV_CHANGED</span><span class="p">:</span>
            <span class="n">environment_changed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">SKIPPED</span><span class="p">:</span>
            <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">RESOURCE_DENIED</span><span class="p">:</span>
            <span class="n">skipped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="n">resource_denieds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">forever</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">test_forever</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">selected</span><span class="p">)):</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">test</span>
                    <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                        <span class="k">return</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="n">test_forever</span><span class="p">()</span>
        <span class="n">test_count</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">test_count_width</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>
        <span class="n">test_count</span> <span class="o">=</span> <span class="s">&#39;/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">))</span>
        <span class="n">test_count_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Multiprocess option requires thread support&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
        <span class="n">debug_output_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;\[\d+ refs, \d+ blocks\]$&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">pending</span> <span class="o">=</span> <span class="n">MultiprocessTests</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">work</span><span class="p">():</span>
            <span class="c"># A worker thread.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">run_test_in_subprocess</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
                    <span class="c"># Strip last refcount output line if it exists, since it</span>
                    <span class="c"># comes from the shutdown of the interpreter in the subcommand.</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="n">debug_output_pat</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
                    <span class="n">stdout</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">retcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHILD_ERROR</span><span class="p">,</span> <span class="s">&quot;Exit code </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">retcode</span><span class="p">)</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">test</span><span class="p">,</span> <span class="n">stdout</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">stderr</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">result</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">test</span><span class="p">,</span> <span class="n">stdout</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">stderr</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">result</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
                <span class="k">raise</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">work</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">test_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">finished</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="o">.</span><span class="n">use_mp</span><span class="p">:</span>
                <span class="n">test</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">finished</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="n">accumulate_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;[{1:{0}}{2}/{3}] {4}&quot;</span> <span class="k">if</span> <span class="n">bad</span> <span class="k">else</span> <span class="s">&quot;[{1:{0}}{2}] {4}&quot;</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">test_count_width</span><span class="p">,</span> <span class="n">test_index</span><span class="p">,</span> <span class="n">test_count</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">),</span> <span class="n">test</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INTERRUPTED</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CHILD_ERROR</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Child error on {}: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">test_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">interrupted</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">interrupted</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">test_index</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;[{1:{0}}{2}/{3}] {4}&quot;</span> <span class="k">if</span> <span class="n">bad</span> <span class="k">else</span> <span class="s">&quot;[{1:{0}}{2}] {4}&quot;</span>
                <span class="k">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">test_count_width</span><span class="p">,</span> <span class="n">test_index</span><span class="p">,</span> <span class="n">test_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">),</span> <span class="n">test</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                <span class="c"># If we&#39;re tracing code coverage, then we don&#39;t exit with status</span>
                <span class="c"># if on a false return value from main.</span>
                <span class="n">tracer</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s">&#39;runtest(test, ns.verbose, ns.quiet, timeout=ns.timeout)&#39;</span><span class="p">,</span>
                              <span class="nb">globals</span><span class="o">=</span><span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="o">=</span><span class="nb">vars</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">runtest</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">,</span>
                                     <span class="n">ns</span><span class="o">.</span><span class="n">huntrleaks</span><span class="p">,</span>
                                     <span class="n">output_on_failure</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">verbose3</span><span class="p">,</span>
                                     <span class="n">timeout</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">failfast</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">failfast</span><span class="p">,</span>
                                     <span class="n">match_tests</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">match_tests</span><span class="p">)</span>
                    <span class="n">accumulate_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="n">interrupted</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">findleaks</span><span class="p">:</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Warning: test created&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;uncollectable object(s).&quot;</span><span class="p">)</span>
                    <span class="c"># move the uncollectable objects somewhere so we don&#39;t see</span>
                    <span class="c"># them again</span>
                    <span class="n">found_garbage</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">[:]</span>
            <span class="c"># Unload the newly imported modules (best effort finalization)</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save_modules</span> <span class="ow">and</span> <span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;test.&quot;</span><span class="p">):</span>
                    <span class="n">support</span><span class="o">.</span><span class="n">unload</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interrupted</span><span class="p">:</span>
        <span class="c"># print a newline after ^C</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Test suite interrupted by signal SIGINT.&quot;</span><span class="p">)</span>
        <span class="n">omitted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">omitted</span><span class="p">),</span> <span class="s">&quot;test&quot;</span><span class="p">),</span> <span class="s">&quot;omitted:&quot;</span><span class="p">)</span>
        <span class="n">printlist</span><span class="p">(</span><span class="n">omitted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">good</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bad</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skipped</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;All&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">),</span> <span class="s">&quot;test&quot;</span><span class="p">),</span> <span class="s">&quot;OK.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">print_slow</span><span class="p">:</span>
        <span class="n">test_times</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;10 slowest tests:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">test_times</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%.1f</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">environment_changed</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">),</span> <span class="s">&quot;test&quot;</span><span class="p">),</span> <span class="s">&quot;failed:&quot;</span><span class="p">)</span>
            <span class="n">printlist</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">environment_changed</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} altered the execution environment:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                 <span class="n">count</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">environment_changed</span><span class="p">),</span> <span class="s">&quot;test&quot;</span><span class="p">)))</span>
        <span class="n">printlist</span><span class="p">(</span><span class="n">environment_changed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skipped</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skipped</span><span class="p">),</span> <span class="s">&quot;test&quot;</span><span class="p">),</span> <span class="s">&quot;skipped:&quot;</span><span class="p">)</span>
        <span class="n">printlist</span><span class="p">(</span><span class="n">skipped</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">verbose2</span> <span class="ow">and</span> <span class="n">bad</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Re-running failed tests in verbose mode&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Re-running test </span><span class="si">%r</span><span class="s"> in verbose mode&quot;</span> <span class="o">%</span> <span class="n">test</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">runtest</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">quiet</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">huntrleaks</span><span class="p">,</span>
                             <span class="n">timeout</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="c"># print a newline separate from the ^C</span>
                <span class="k">print</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">next_single_test</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_single_test</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">write_results</span><span class="p">(</span><span class="n">show_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">coverdir</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">coverdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">runleaks</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;leaks </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">interrupted</span><span class="p">)</span>


<span class="c"># small set of tests to determine if we have a basically functioning interpreter</span>
<span class="c"># (i.e. if any of these fail, then anything else is likely to follow)</span></div>
<span class="n">STDTESTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;test_grammar&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_opcodes&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_dict&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_builtin&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_exceptions&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_types&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_unittest&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_doctest&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_doctest2&#39;</span><span class="p">,</span>
    <span class="s">&#39;test_support&#39;</span>
<span class="p">]</span>

<span class="c"># set of tests that we don&#39;t want to be executed when using regrtest</span>
<span class="n">NOTTESTS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="findtests"><a class="viewcode-back" href="../../test.html#test.regrtest.findtests">[docs]</a><span class="k">def</span> <span class="nf">findtests</span><span class="p">(</span><span class="n">testdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdtests</span><span class="o">=</span><span class="n">STDTESTS</span><span class="p">,</span> <span class="n">nottests</span><span class="o">=</span><span class="n">NOTTESTS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of all applicable test modules.&quot;&quot;&quot;</span>
    <span class="n">testdir</span> <span class="o">=</span> <span class="n">findtestdir</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">others</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stdtests</span><span class="p">)</span> <span class="o">|</span> <span class="n">nottests</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mod</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;test_&quot;</span> <span class="ow">and</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;.py&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stdtests</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>

<span class="c"># We do not use a generator so multiple threads can call next().</span></div>
<div class="viewcode-block" id="MultiprocessTests"><a class="viewcode-back" href="../../test.html#test.regrtest.MultiprocessTests">[docs]</a><span class="k">class</span> <span class="nc">MultiprocessTests</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A thread-safe iterator over tests for multiprocess mode.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tests</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="n">tests</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupted</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s">&#39;tests interrupted&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="replace_stdout"><a class="viewcode-back" href="../../test.html#test.regrtest.replace_stdout">[docs]</a><span class="k">def</span> <span class="nf">replace_stdout</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Set stdout encoder error handler to backslashreplace (as stderr error</span>
<span class="sd">    handler) to avoid UnicodeEncodeError when printing a traceback&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">atexit</span>

    <span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s">&#39;w&#39;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
        <span class="n">errors</span><span class="o">=</span><span class="s">&quot;backslashreplace&quot;</span><span class="p">,</span>
        <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">newline</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore_stdout</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">restore_stdout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="runtest"><a class="viewcode-back" href="../../test.html#test.regrtest.runtest">[docs]</a><span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">quiet</span><span class="p">,</span>
            <span class="n">huntrleaks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_resources</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">output_on_failure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">failfast</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">match_tests</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a single test.</span>

<span class="sd">    test -- the name of the test</span>
<span class="sd">    verbose -- if true, print more messages</span>
<span class="sd">    quiet -- if true, don&#39;t print &#39;skipped&#39; messages (probably redundant)</span>
<span class="sd">    huntrleaks -- run multiple times to test for leaks; requires a debug</span>
<span class="sd">                  build; a triple corresponding to -R&#39;s three arguments</span>
<span class="sd">    use_resources -- list of extra resources to use</span>
<span class="sd">    output_on_failure -- if true, display test output on failure</span>
<span class="sd">    timeout -- dump the traceback and exit if a test takes more than</span>
<span class="sd">               timeout seconds</span>
<span class="sd">    failfast, match_tests -- See regrtest command-line flags for these.</span>

<span class="sd">    Returns the tuple result, test_time, where result is one of the constants:</span>
<span class="sd">        INTERRUPTED      KeyboardInterrupt when run under -j</span>
<span class="sd">        RESOURCE_DENIED  test skipped because resource denied</span>
<span class="sd">        SKIPPED          test skipped for some other reason</span>
<span class="sd">        ENV_CHANGED      test failed because it changed the execution environment</span>
<span class="sd">        FAILED           test failed</span>
<span class="sd">        PASSED           test passed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">use_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">use_resources</span> <span class="o">=</span> <span class="n">use_resources</span>
    <span class="n">use_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_timeout</span><span class="p">:</span>
        <span class="n">faulthandler</span><span class="o">.</span><span class="n">dump_traceback_later</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nb">exit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">match_tests</span> <span class="o">=</span> <span class="n">match_tests</span>
        <span class="k">if</span> <span class="n">failfast</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">failfast</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">output_on_failure</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Reuse the same instance to all calls to runtest(). Some</span>
            <span class="c"># tests keep a reference to sys.stdout or sys.stderr</span>
            <span class="c"># (eg. test_argparse).</span>
            <span class="k">if</span> <span class="n">runtest</span><span class="o">.</span><span class="n">stringio</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="n">runtest</span><span class="o">.</span><span class="n">stringio</span> <span class="o">=</span> <span class="n">stream</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="n">runtest</span><span class="o">.</span><span class="n">stringio</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>

            <span class="n">orig_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="n">orig_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stream</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stream</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">runtest_inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">quiet</span><span class="p">,</span> <span class="n">huntrleaks</span><span class="p">,</span>
                                       <span class="n">display_failure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                    <span class="n">orig_stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="n">orig_stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">orig_stdout</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">orig_stderr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>  <span class="c"># Tell tests to be moderately quiet</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">runtest_inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">quiet</span><span class="p">,</span> <span class="n">huntrleaks</span><span class="p">,</span>
                                   <span class="n">display_failure</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_timeout</span><span class="p">:</span>
            <span class="n">faulthandler</span><span class="o">.</span><span class="n">cancel_dump_traceback_later</span><span class="p">()</span>
        <span class="n">cleanup_test_droppings</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span></div>
<span class="n">runtest</span><span class="o">.</span><span class="n">stringio</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># Unit tests are supposed to leave the execution environment unchanged</span>
<span class="c"># once they complete.  But sometimes tests have bugs, especially when</span>
<span class="c"># tests fail, and the changes to environment go on to mess up other</span>
<span class="c"># tests.  This can cause issues with buildbot stability, since tests</span>
<span class="c"># are run in random order and so problems may appear to come and go.</span>
<span class="c"># There are a few things we can save and restore to mitigate this, and</span>
<span class="c"># the following context manager handles this task.</span>

<div class="viewcode-block" id="saved_test_environment"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment">[docs]</a><span class="k">class</span> <span class="nc">saved_test_environment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Save bits of the test environment and restore them at block exit.</span>

<span class="sd">        with saved_test_environment(testname, verbose, quiet):</span>
<span class="sd">            #stuff</span>

<span class="sd">    Unless quiet is True, a warning is printed to stderr if any of</span>
<span class="sd">    the saved items was changed by the test.  The attribute &#39;changed&#39;</span>
<span class="sd">    is initially False, but is set to True if a change is detected.</span>

<span class="sd">    If verbose is more than 1, the before and after state of changed</span>
<span class="sd">    items is also printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testname</span> <span class="o">=</span> <span class="n">testname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

    <span class="c"># To add things to save and restore, add a name XXX to the resources list</span>
    <span class="c"># and add corresponding get_XXX/restore_XXX functions.  get_XXX should</span>
    <span class="c"># return the value to be saved and compared against a second call to the</span>
    <span class="c"># get function when test execution completes.  restore_XXX should accept</span>
    <span class="c"># the saved value and restore the resource using it.  It will be called if</span>
    <span class="c"># and only if a change in the value is detected.</span>
    <span class="c">#</span>
    <span class="c"># Note: XXX will have any &#39;.&#39; replaced with &#39;_&#39; characters when determining</span>
    <span class="c"># the corresponding method names.</span>

    <span class="n">resources</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;sys.argv&#39;</span><span class="p">,</span> <span class="s">&#39;cwd&#39;</span><span class="p">,</span> <span class="s">&#39;sys.stdin&#39;</span><span class="p">,</span> <span class="s">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="s">&#39;sys.stderr&#39;</span><span class="p">,</span>
                 <span class="s">&#39;os.environ&#39;</span><span class="p">,</span> <span class="s">&#39;sys.path&#39;</span><span class="p">,</span> <span class="s">&#39;sys.path_hooks&#39;</span><span class="p">,</span> <span class="s">&#39;__import__&#39;</span><span class="p">,</span>
                 <span class="s">&#39;warnings.filters&#39;</span><span class="p">,</span> <span class="s">&#39;asyncore.socket_map&#39;</span><span class="p">,</span>
                 <span class="s">&#39;logging._handlers&#39;</span><span class="p">,</span> <span class="s">&#39;logging._handlerList&#39;</span><span class="p">,</span> <span class="s">&#39;sys.gettrace&#39;</span><span class="p">,</span>
                 <span class="s">&#39;sys.warnoptions&#39;</span><span class="p">,</span>
                 <span class="c"># multiprocessing.process._cleanup() may release ref</span>
                 <span class="c"># to a thread, so check processes first.</span>
                 <span class="s">&#39;multiprocessing.process._dangling&#39;</span><span class="p">,</span> <span class="s">&#39;threading._dangling&#39;</span><span class="p">,</span>
                 <span class="s">&#39;sysconfig._CONFIG_VARS&#39;</span><span class="p">,</span> <span class="s">&#39;sysconfig._INSTALL_SCHEMES&#39;</span><span class="p">,</span>
                 <span class="s">&#39;support.TESTFN&#39;</span><span class="p">,</span> <span class="s">&#39;locale&#39;</span><span class="p">,</span> <span class="s">&#39;warnings.showwarning&#39;</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="saved_test_environment.get_sys_argv"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_argv">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_argv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_argv"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_argv">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_argv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_argv</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">saved_argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">saved_argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_cwd"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_cwd">[docs]</a>    <span class="k">def</span> <span class="nf">get_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_cwd"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_cwd">[docs]</a>    <span class="k">def</span> <span class="nf">restore_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_cwd</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">saved_cwd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_stdout"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_stdout"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_stdout</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">saved_stdout</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_stderr"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_stderr"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_stderr</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">saved_stderr</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_stdin"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_stdin"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_stdin</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">saved_stdin</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_os_environ"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_os_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_os_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_os_environ"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_os_environ">[docs]</a>    <span class="k">def</span> <span class="nf">restore_os_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_environ</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">saved_environ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved_environ</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_path"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_path"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_path">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_path</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">saved_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">saved_path</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_path_hooks"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_path_hooks">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_path_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_path_hooks"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_path_hooks">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_path_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_hooks</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span> <span class="o">=</span> <span class="n">saved_hooks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">saved_hooks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_gettrace"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_gettrace">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_gettrace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_gettrace"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_gettrace">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_gettrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace_fxn</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace_fxn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get___import__"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get___import__">[docs]</a>    <span class="k">def</span> <span class="nf">get___import__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builtins</span><span class="o">.</span><span class="n">__import__</span></div>
<div class="viewcode-block" id="saved_test_environment.restore___import__"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore___import__">[docs]</a>    <span class="k">def</span> <span class="nf">restore___import__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_</span><span class="p">):</span>
        <span class="n">builtins</span><span class="o">.</span><span class="n">__import__</span> <span class="o">=</span> <span class="n">import_</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_warnings_filters"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_warnings_filters">[docs]</a>    <span class="k">def</span> <span class="nf">get_warnings_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">),</span> <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_warnings_filters"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_warnings_filters">[docs]</a>    <span class="k">def</span> <span class="nf">restore_warnings_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_filters</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">saved_filters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">saved_filters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_asyncore_socket_map"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_asyncore_socket_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_asyncore_socket_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">asyncore</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;asyncore&#39;</span><span class="p">)</span>
        <span class="c"># XXX Making a copy keeps objects alive until __exit__ gets called.</span>
        <span class="k">return</span> <span class="n">asyncore</span> <span class="ow">and</span> <span class="n">asyncore</span><span class="o">.</span><span class="n">socket_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_asyncore_socket_map"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_asyncore_socket_map">[docs]</a>    <span class="k">def</span> <span class="nf">restore_asyncore_socket_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_map</span><span class="p">):</span>
        <span class="n">asyncore</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;asyncore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asyncore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">asyncore</span><span class="o">.</span><span class="n">close_all</span><span class="p">(</span><span class="n">ignore_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">asyncore</span><span class="o">.</span><span class="n">socket_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved_map</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_shutil_archive_formats"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_shutil_archive_formats">[docs]</a>    <span class="k">def</span> <span class="nf">get_shutil_archive_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># we could call get_archives_formats() but that only returns the</span>
        <span class="c"># registry keys; we want to check the values too (the functions that</span>
        <span class="c"># are registered)</span>
        <span class="k">return</span> <span class="n">shutil</span><span class="o">.</span><span class="n">_ARCHIVE_FORMATS</span><span class="p">,</span> <span class="n">shutil</span><span class="o">.</span><span class="n">_ARCHIVE_FORMATS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_shutil_archive_formats"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_shutil_archive_formats">[docs]</a>    <span class="k">def</span> <span class="nf">restore_shutil_archive_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">_ARCHIVE_FORMATS</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">_ARCHIVE_FORMATS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">_ARCHIVE_FORMATS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_shutil_unpack_formats"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_shutil_unpack_formats">[docs]</a>    <span class="k">def</span> <span class="nf">get_shutil_unpack_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shutil</span><span class="o">.</span><span class="n">_UNPACK_FORMATS</span><span class="p">,</span> <span class="n">shutil</span><span class="o">.</span><span class="n">_UNPACK_FORMATS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_shutil_unpack_formats"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_shutil_unpack_formats">[docs]</a>    <span class="k">def</span> <span class="nf">restore_shutil_unpack_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">_UNPACK_FORMATS</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">_UNPACK_FORMATS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">_UNPACK_FORMATS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_logging__handlers"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_logging__handlers">[docs]</a>    <span class="k">def</span> <span class="nf">get_logging__handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># _handlers is a WeakValueDictionary</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">_handlers</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">_handlers</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_logging__handlers"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_logging__handlers">[docs]</a>    <span class="k">def</span> <span class="nf">restore_logging__handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_handlers</span><span class="p">):</span>
        <span class="c"># Can&#39;t easily revert the logging state</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_logging__handlerList"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_logging__handlerList">[docs]</a>    <span class="k">def</span> <span class="nf">get_logging__handlerList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># _handlerList is a list of weakrefs to handlers</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">_handlerList</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">_handlerList</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">_handlerList</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_logging__handlerList"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_logging__handlerList">[docs]</a>    <span class="k">def</span> <span class="nf">restore_logging__handlerList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_handlerList</span><span class="p">):</span>
        <span class="c"># Can&#39;t easily revert the logging state</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sys_warnoptions"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sys_warnoptions">[docs]</a>    <span class="k">def</span> <span class="nf">get_sys_warnoptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">warnoptions</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">warnoptions</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">warnoptions</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sys_warnoptions"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sys_warnoptions">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sys_warnoptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_options</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">warnoptions</span> <span class="o">=</span> <span class="n">saved_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">warnoptions</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">saved_options</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c"># Controlling dangling references to Thread objects can make it easier</span>
    <span class="c"># to track reference leaks.</span></div>
<div class="viewcode-block" id="saved_test_environment.get_threading__dangling"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_threading__dangling">[docs]</a>    <span class="k">def</span> <span class="nf">get_threading__dangling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">threading</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># This copies the weakrefs without making any strong reference</span>
        <span class="k">return</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_threading__dangling"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_threading__dangling">[docs]</a>    <span class="k">def</span> <span class="nf">restore_threading__dangling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">threading</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved</span><span class="p">)</span>

    <span class="c"># Same for Process objects</span></div>
<div class="viewcode-block" id="saved_test_environment.get_multiprocessing_process__dangling"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_multiprocessing_process__dangling">[docs]</a>    <span class="k">def</span> <span class="nf">get_multiprocessing_process__dangling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multiprocessing</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Unjoined process objects can survive after process exits</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>
        <span class="c"># This copies the weakrefs without making any strong reference</span>
        <span class="k">return</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_multiprocessing_process__dangling"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_multiprocessing_process__dangling">[docs]</a>    <span class="k">def</span> <span class="nf">restore_multiprocessing_process__dangling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multiprocessing</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sysconfig__CONFIG_VARS"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sysconfig__CONFIG_VARS">[docs]</a>    <span class="k">def</span> <span class="nf">get_sysconfig__CONFIG_VARS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># make sure the dict is initialized</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s">&#39;prefix&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">_CONFIG_VARS</span><span class="p">),</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">_CONFIG_VARS</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">_CONFIG_VARS</span><span class="p">))</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sysconfig__CONFIG_VARS"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sysconfig__CONFIG_VARS">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sysconfig__CONFIG_VARS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">_CONFIG_VARS</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">_CONFIG_VARS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">_CONFIG_VARS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_sysconfig__INSTALL_SCHEMES"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_sysconfig__INSTALL_SCHEMES">[docs]</a>    <span class="k">def</span> <span class="nf">get_sysconfig__INSTALL_SCHEMES</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">_INSTALL_SCHEMES</span><span class="p">),</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">_INSTALL_SCHEMES</span><span class="p">,</span>
                <span class="n">sysconfig</span><span class="o">.</span><span class="n">_INSTALL_SCHEMES</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_sysconfig__INSTALL_SCHEMES"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_sysconfig__INSTALL_SCHEMES">[docs]</a>    <span class="k">def</span> <span class="nf">restore_sysconfig__INSTALL_SCHEMES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">_INSTALL_SCHEMES</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">_INSTALL_SCHEMES</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">sysconfig</span><span class="o">.</span><span class="n">_INSTALL_SCHEMES</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_support_TESTFN"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_support_TESTFN">[docs]</a>    <span class="k">def</span> <span class="nf">get_support_TESTFN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;f&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;d&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">result</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_support_TESTFN"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_support_TESTFN">[docs]</a>    <span class="k">def</span> <span class="nf">restore_support_TESTFN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">saved_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
    <span class="n">_lc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span> <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">lc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;LC_&#39;</span><span class="p">)]</span>
<div class="viewcode-block" id="saved_test_environment.get_locale"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_locale">[docs]</a>    <span class="k">def</span> <span class="nf">get_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pairings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pairings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lc</span><span class="p">,</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">pairings</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_locale"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_locale">[docs]</a>    <span class="k">def</span> <span class="nf">restore_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">saved</span><span class="p">:</span>
            <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saved_test_environment.get_warnings_showwarning"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.get_warnings_showwarning">[docs]</a>    <span class="k">def</span> <span class="nf">get_warnings_showwarning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span></div>
<div class="viewcode-block" id="saved_test_environment.restore_warnings_showwarning"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.restore_warnings_showwarning">[docs]</a>    <span class="k">def</span> <span class="nf">restore_warnings_showwarning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fxn</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="n">fxn</span>
</div>
<div class="viewcode-block" id="saved_test_environment.resource_info"><a class="viewcode-back" href="../../test.html#test.regrtest.saved_test_environment.resource_info">[docs]</a>    <span class="k">def</span> <span class="nf">resource_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
            <span class="n">method_suffix</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">get_name</span> <span class="o">=</span> <span class="s">&#39;get_&#39;</span> <span class="o">+</span> <span class="n">method_suffix</span>
            <span class="n">restore_name</span> <span class="o">=</span> <span class="s">&#39;restore_&#39;</span> <span class="o">+</span> <span class="n">method_suffix</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_name</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restore_name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">get</span><span class="p">())</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">restore</span>
                                                   <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_info</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">saved_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_values</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_values</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">restore</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_info</span><span class="p">():</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">get</span><span class="p">()</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">saved_values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c"># Check for changes to the resource&#39;s value</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">original</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">restore</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Warning -- {} was modified by {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                 <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testname</span><span class="p">),</span>
                                                 <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;  Before: {}</span><span class="se">\n</span><span class="s">  After:  {} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                  <span class="n">original</span><span class="p">,</span> <span class="n">current</span><span class="p">),</span>
                                                  <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="runtest_inner"><a class="viewcode-back" href="../../test.html#test.regrtest.runtest_inner">[docs]</a><span class="k">def</span> <span class="nf">runtest_inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">quiet</span><span class="p">,</span>
                  <span class="n">huntrleaks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">display_failure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">support</span><span class="o">.</span><span class="n">unload</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

    <span class="n">test_time</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">refleak</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># True if the test leaked references.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;test.&#39;</span><span class="p">):</span>
            <span class="n">abstest</span> <span class="o">=</span> <span class="n">test</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Always import it from the test package</span>
            <span class="n">abstest</span> <span class="o">=</span> <span class="s">&#39;test.&#39;</span> <span class="o">+</span> <span class="n">test</span>
        <span class="k">with</span> <span class="n">saved_test_environment</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">environment</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">the_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">abstest</span><span class="p">)</span>
            <span class="c"># If the test has a test_main, that will run the appropriate</span>
            <span class="c"># tests.  If not, use normal unittest test loading.</span>
            <span class="n">test_runner</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">the_module</span><span class="p">,</span> <span class="s">&quot;test_main&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">test_runner</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">test_runner</span><span class="p">():</span>
                    <span class="n">loader</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span>
                    <span class="n">tests</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadTestsFromModule</span><span class="p">(</span><span class="n">the_module</span><span class="p">)</span>
                    <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
            <span class="n">test_runner</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">huntrleaks</span><span class="p">:</span>
                <span class="n">refleak</span> <span class="o">=</span> <span class="n">dash_R</span><span class="p">(</span><span class="n">the_module</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">test_runner</span><span class="p">,</span> <span class="n">huntrleaks</span><span class="p">)</span>
            <span class="n">test_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="k">except</span> <span class="n">support</span><span class="o">.</span><span class="n">ResourceDenied</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s">&quot;skipped --&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">RESOURCE_DENIED</span><span class="p">,</span> <span class="n">test_time</span>
    <span class="k">except</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s">&quot;skipped --&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">SKIPPED</span><span class="p">,</span> <span class="n">test_time</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">support</span><span class="o">.</span><span class="n">TestFailed</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">display_failure</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="s">&quot;failed --&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="s">&quot;failed&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">test_time</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="s">&quot;crashed --&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">test_time</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">refleak</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">test_time</span>
        <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ENV_CHANGED</span><span class="p">,</span> <span class="n">test_time</span>
        <span class="k">return</span> <span class="n">PASSED</span><span class="p">,</span> <span class="n">test_time</span>
</div>
<div class="viewcode-block" id="cleanup_test_droppings"><a class="viewcode-back" href="../../test.html#test.regrtest.cleanup_test_droppings">[docs]</a><span class="k">def</span> <span class="nf">cleanup_test_droppings</span><span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="kn">import</span> <span class="nn">stat</span>
    <span class="kn">import</span> <span class="nn">gc</span>

    <span class="c"># First kill any dangling references to open files etc.</span>
    <span class="c"># This can also issue some ResourceWarnings which would otherwise get</span>
    <span class="c"># triggered during the following test run, and possibly produce failures.</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c"># Try to clean up junk commonly left behind.  While tests shouldn&#39;t leave</span>
    <span class="c"># any files or directories behind, when a test fails that can be tedious</span>
    <span class="c"># for it to arrange.  The consequences can be especially nasty on Windows,</span>
    <span class="c"># since if a test leaves a file open, it cannot be deleted by name (while</span>
    <span class="c"># there&#39;s nothing we can do about that here either, we can display the</span>
    <span class="c"># name of the offending test, which is a real help).</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span>
                 <span class="s">&quot;db_home&quot;</span><span class="p">,</span>
                <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">kind</span><span class="p">,</span> <span class="n">nuker</span> <span class="o">=</span> <span class="s">&quot;directory&quot;</span><span class="p">,</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">kind</span><span class="p">,</span> <span class="n">nuker</span> <span class="o">=</span> <span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s">&quot;os.path says </span><span class="si">%r</span><span class="s"> exists but is neither &quot;</span>
                              <span class="s">&quot;directory nor file&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> left behind </span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># if we have chmod, fix possible permissions problems</span>
            <span class="c"># that might prevent cleanup</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;chmod&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXG</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXO</span><span class="p">)</span>
            <span class="n">nuker</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">print</span><span class="p">((</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> left behind </span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s"> and it couldn&#39;t be &quot;</span>
                <span class="s">&quot;removed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">)),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="dash_R"><a class="viewcode-back" href="../../test.html#test.regrtest.dash_R">[docs]</a><span class="k">def</span> <span class="nf">dash_R</span><span class="p">(</span><span class="n">the_module</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">indirect_test</span><span class="p">,</span> <span class="n">huntrleaks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a test multiple times, looking for reference leaks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        False if the test didn&#39;t leak references; True if we detected refleaks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># This code is hackish and inelegant, but it seems to do the job.</span>
    <span class="kn">import</span> <span class="nn">copyreg</span>
    <span class="kn">import</span> <span class="nn">collections.abc</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&#39;gettotalrefcount&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Tracking reference leaks requires a debug build &quot;</span>
                        <span class="s">&quot;of Python&quot;</span><span class="p">)</span>

    <span class="c"># Save current values for dash_R_cleanup() to restore.</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">copyreg</span><span class="o">.</span><span class="n">dispatch_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pic</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path_importer_cache</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">zipimport</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">zdc</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Run unmodified on platforms without zipimport support</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zdc</span> <span class="o">=</span> <span class="n">zipimport</span><span class="o">.</span><span class="n">_zip_directory_cache</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">abcs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">abc</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">__all__</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isabstract</span><span class="p">(</span><span class="n">abc</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">abc</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">abc</span><span class="p">]:</span>
            <span class="n">abcs</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_abc_registry</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">nwarmup</span><span class="p">,</span> <span class="n">ntracked</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">huntrleaks</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">SAVEDCWD</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">repcount</span> <span class="o">=</span> <span class="n">nwarmup</span> <span class="o">+</span> <span class="n">ntracked</span>
    <span class="n">rc_deltas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">repcount</span>
    <span class="n">alloc_deltas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">repcount</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&quot;beginning&quot;</span><span class="p">,</span> <span class="n">repcount</span><span class="p">,</span> <span class="s">&quot;repetitions&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">print</span><span class="p">((</span><span class="s">&quot;1234567890&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">repcount</span><span class="o">//</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="n">repcount</span><span class="p">],</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repcount</span><span class="p">):</span>
        <span class="n">indirect_test</span><span class="p">()</span>
        <span class="n">alloc_after</span><span class="p">,</span> <span class="n">rc_after</span> <span class="o">=</span> <span class="n">dash_R_cleanup</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">pic</span><span class="p">,</span> <span class="n">zdc</span><span class="p">,</span> <span class="n">abcs</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nwarmup</span><span class="p">:</span>
            <span class="n">rc_deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc_after</span> <span class="o">-</span> <span class="n">rc_before</span>
            <span class="n">alloc_deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_after</span> <span class="o">-</span> <span class="n">alloc_before</span>
        <span class="n">alloc_before</span><span class="p">,</span> <span class="n">rc_before</span> <span class="o">=</span> <span class="n">alloc_after</span><span class="p">,</span> <span class="n">rc_after</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="c"># These checkers return False on success, True on failure</span>
    <span class="k">def</span> <span class="nf">check_rc_deltas</span><span class="p">(</span><span class="n">deltas</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check_alloc_deltas</span><span class="p">(</span><span class="n">deltas</span><span class="p">):</span>
        <span class="c"># At least 1/3rd of 0s</span>
        <span class="k">if</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">deltas</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">deltas</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="c"># Nothing else than 1s, 0s and -1s</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">}:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">deltas</span><span class="p">,</span> <span class="n">item_name</span><span class="p">,</span> <span class="n">checker</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">rc_deltas</span><span class="p">,</span> <span class="s">&#39;references&#39;</span><span class="p">,</span> <span class="n">check_rc_deltas</span><span class="p">),</span>
        <span class="p">(</span><span class="n">alloc_deltas</span><span class="p">,</span> <span class="s">&#39;memory blocks&#39;</span><span class="p">,</span> <span class="n">check_alloc_deltas</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">checker</span><span class="p">(</span><span class="n">deltas</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> leaked </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">, sum=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">test</span><span class="p">,</span> <span class="n">deltas</span><span class="p">[</span><span class="n">nwarmup</span><span class="p">:],</span> <span class="n">item_name</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">deltas</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">refrep</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">refrep</span><span class="p">)</span>
                <span class="n">refrep</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">failed</span>
</div>
<div class="viewcode-block" id="dash_R_cleanup"><a class="viewcode-back" href="../../test.html#test.regrtest.dash_R_cleanup">[docs]</a><span class="k">def</span> <span class="nf">dash_R_cleanup</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">pic</span><span class="p">,</span> <span class="n">zdc</span><span class="p">,</span> <span class="n">abcs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">copyreg</span>
    <span class="kn">import</span> <span class="nn">_strptime</span><span class="o">,</span> <span class="nn">linecache</span>
    <span class="kn">import</span> <span class="nn">urllib.parse</span><span class="o">,</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">mimetypes</span><span class="o">,</span> <span class="nn">doctest</span>
    <span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">filecmp</span><span class="o">,</span> <span class="nn">collections.abc</span>
    <span class="kn">from</span> <span class="nn">distutils.dir_util</span> <span class="kn">import</span> <span class="n">_path_created</span>
    <span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">WeakSet</span>

    <span class="c"># Clear the warnings registry, so they can be displayed again</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s">&#39;__warningregistry__&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">mod</span><span class="o">.</span><span class="n">__warningregistry__</span>

    <span class="c"># Restore some original values.</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">fs</span>
    <span class="n">copyreg</span><span class="o">.</span><span class="n">dispatch_table</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">copyreg</span><span class="o">.</span><span class="n">dispatch_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path_importer_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path_importer_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">zipimport</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c"># Run unmodified on platforms without zipimport support</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zipimport</span><span class="o">.</span><span class="n">_zip_directory_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">zipimport</span><span class="o">.</span><span class="n">_zip_directory_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">zdc</span><span class="p">)</span>

    <span class="c"># clear type cache</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">_clear_type_cache</span><span class="p">()</span>

    <span class="c"># Clear ABC registries, restoring previously saved ABC registries.</span>
    <span class="k">for</span> <span class="n">abc</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">__all__</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isabstract</span><span class="p">(</span><span class="n">abc</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">abc</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">abc</span><span class="p">]:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_abc_registry</span> <span class="o">=</span> <span class="n">abcs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">WeakSet</span><span class="p">())</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_abc_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_abc_negative_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c"># Flush standard output, so that buffered data is sent to the OS and</span>
    <span class="c"># associated Python objects are reclaimed.</span>
    <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c"># Clear assorted module caches.</span>
    <span class="n">_path_created</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">re</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
    <span class="n">_strptime</span><span class="o">.</span><span class="n">_regex_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlcleanup</span><span class="p">()</span>
    <span class="n">linecache</span><span class="o">.</span><span class="n">clearcache</span><span class="p">()</span>
    <span class="n">mimetypes</span><span class="o">.</span><span class="n">_default_mime_types</span><span class="p">()</span>
    <span class="n">filecmp</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">_clearcache</span><span class="p">()</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ctypes</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c"># Don&#39;t worry about resetting the cache if ctypes is not supported</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">_reset_cache</span><span class="p">()</span>

    <span class="c"># Collect cyclic trash and read memory statistics immediately after.</span>
    <span class="n">func1</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getallocatedblocks</span>
    <span class="n">func2</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettotalrefcount</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">func1</span><span class="p">(),</span> <span class="n">func2</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="warm_caches"><a class="viewcode-back" href="../../test.html#test.regrtest.warm_caches">[docs]</a><span class="k">def</span> <span class="nf">warm_caches</span><span class="p">():</span>
    <span class="c"># char cache</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="c"># unicode cache</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
    <span class="c"># int cache</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">257</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="findtestdir"><a class="viewcode-back" href="../../test.html#test.regrtest.findtestdir">[docs]</a><span class="k">def</span> <span class="nf">findtestdir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span>
</div>
<div class="viewcode-block" id="removepy"><a class="viewcode-back" href="../../test.html#test.regrtest.removepy">[docs]</a><span class="k">def</span> <span class="nf">removepy</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.py&#39;</span><span class="p">:</span>
            <span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">basename</span>
</div>
<div class="viewcode-block" id="count"><a class="viewcode-back" href="../../test.html#test.regrtest.count">[docs]</a><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="printlist"><a class="viewcode-back" href="../../test.html#test.regrtest.printlist">[docs]</a><span class="k">def</span> <span class="nf">printlist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the elements of iterable x to stdout.</span>

<span class="sd">    Optional arg width (default 70) is the maximum line length.</span>
<span class="sd">    Optional arg indent (default 4) is the number of blanks with which to</span>
<span class="sd">    begin each line.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">fill</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent</span>
    <span class="c"># Print the sorted list: &#39;x&#39; may be a &#39;--random&#39; list or a set()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">fill</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">width</span><span class="p">,</span>
               <span class="n">initial_indent</span><span class="o">=</span><span class="n">blanks</span><span class="p">,</span> <span class="n">subsequent_indent</span><span class="o">=</span><span class="n">blanks</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="main_in_temp_cwd"><a class="viewcode-back" href="../../test.html#test.regrtest.main_in_temp_cwd">[docs]</a><span class="k">def</span> <span class="nf">main_in_temp_cwd</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run main() in a temporary working directory.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">is_python_build</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c"># Define a writable temp dir that will be used as cwd while running</span>
    <span class="c"># the tests. The name of the dir includes the pid to allow parallel</span>
    <span class="c"># testing (see the -j option).</span>
    <span class="n">test_cwd</span> <span class="o">=</span> <span class="s">&#39;test_python_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="n">test_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">test_cwd</span><span class="p">)</span>

    <span class="c"># Run the tests in a context manager that temporarily changes the CWD to a</span>
    <span class="c"># temporary and writable directory.  If it&#39;s not possible to create or</span>
    <span class="c"># change the CWD, the original CWD will be used.  The original CWD is</span>
    <span class="c"># available from support.SAVEDCWD.</span>
    <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">temp_cwd</span><span class="p">(</span><span class="n">test_cwd</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">main</span><span class="p">()</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># Remove regrtest.py&#39;s own directory from the module search path. Despite</span>
    <span class="c"># the elimination of implicit relative imports, this is still needed to</span>
    <span class="c"># ensure that submodules of the test package do not inappropriately appear</span>
    <span class="c"># as top-level modules even when people (or buildbots!) invoke regrtest.py</span>
    <span class="c"># directly instead of using the -m switch</span>
    <span class="n">mydir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">==</span> <span class="n">mydir</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c"># findtestdir() gets the dirname out of __file__, so we have to make it</span>
    <span class="c"># absolute before changing the working directory.</span>
    <span class="c"># For example __file__ may be relative when running trace or profile.</span>
    <span class="c"># See issue #9323.</span>
    <span class="n">__file__</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>

    <span class="c"># sanity check</span>
    <span class="k">assert</span> <span class="n">__file__</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">main_in_temp_cwd</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>