

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_ssl &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_ssl</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_ssl</h1><div class="highlight"><pre>
<span class="c"># Test the support for SSL and sockets</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="n">ssl</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s">&quot;ssl&quot;</span><span class="p">)</span>

<span class="n">PROTOCOLS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">_PROTOCOL_NAMES</span><span class="p">)</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">HOST</span>

<div class="viewcode-block" id="data_file"><a class="viewcode-back" href="../../test.html#test.test_ssl.data_file">[docs]</a><span class="k">def</span> <span class="nf">data_file</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>

<span class="c"># The custom key and certificate files used in test_ssl are generated</span>
<span class="c"># using Lib/test/make_ssl_certs.py.</span>
<span class="c"># Other certificates are simply fetched from the Internet servers they</span>
<span class="c"># are meant to authenticate.</span>
</div>
<span class="n">CERTFILE</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;keycert.pem&quot;</span><span class="p">)</span>
<span class="n">BYTES_CERTFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
<span class="n">ONLYCERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;ssl_cert.pem&quot;</span><span class="p">)</span>
<span class="n">ONLYKEY</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;ssl_key.pem&quot;</span><span class="p">)</span>
<span class="n">BYTES_ONLYCERT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">ONLYCERT</span><span class="p">)</span>
<span class="n">BYTES_ONLYKEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">ONLYKEY</span><span class="p">)</span>
<span class="n">CERTFILE_PROTECTED</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;keycert.passwd.pem&quot;</span><span class="p">)</span>
<span class="n">ONLYKEY_PROTECTED</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;ssl_key.passwd.pem&quot;</span><span class="p">)</span>
<span class="n">KEY_PASSWORD</span> <span class="o">=</span> <span class="s">&quot;somepass&quot;</span>
<span class="n">CAPATH</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;capath&quot;</span><span class="p">)</span>
<span class="n">BYTES_CAPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">CAPATH</span><span class="p">)</span>
<span class="n">CAFILE_NEURONIO</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;capath&quot;</span><span class="p">,</span> <span class="s">&quot;4e1295a3.0&quot;</span><span class="p">)</span>
<span class="n">CAFILE_CACERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;capath&quot;</span><span class="p">,</span> <span class="s">&quot;5ed36f99.0&quot;</span><span class="p">)</span>


<span class="c"># empty CRL</span>
<span class="n">CRLFILE</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;revocation.crl&quot;</span><span class="p">)</span>

<span class="c"># Two keys and certs signed by the same CA (for SNI tests)</span>
<span class="n">SIGNED_CERTFILE</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;keycert3.pem&quot;</span><span class="p">)</span>
<span class="n">SIGNED_CERTFILE2</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;keycert4.pem&quot;</span><span class="p">)</span>
<span class="n">SIGNING_CA</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;pycacert.pem&quot;</span><span class="p">)</span>

<span class="n">SVN_PYTHON_ORG_ROOT_CERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;https_svn_python_org_root.pem&quot;</span><span class="p">)</span>

<span class="n">EMPTYCERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;nullcert.pem&quot;</span><span class="p">)</span>
<span class="n">BADCERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;badcert.pem&quot;</span><span class="p">)</span>
<span class="n">WRONGCERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;XXXnonexisting.pem&quot;</span><span class="p">)</span>
<span class="n">BADKEY</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;badkey.pem&quot;</span><span class="p">)</span>
<span class="n">NOKIACERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;nokia.pem&quot;</span><span class="p">)</span>
<span class="n">NULLBYTECERT</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;nullbytecert.pem&quot;</span><span class="p">)</span>

<span class="n">DHFILE</span> <span class="o">=</span> <span class="n">data_file</span><span class="p">(</span><span class="s">&quot;dh512.pem&quot;</span><span class="p">)</span>
<span class="n">BYTES_DHFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">DHFILE</span><span class="p">)</span>


<div class="viewcode-block" id="handle_error"><a class="viewcode-back" href="../../test.html#test.test_ssl.handle_error">[docs]</a><span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="n">exc_format</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">exc_format</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="can_clear_options"><a class="viewcode-back" href="../../test.html#test.test_ssl.can_clear_options">[docs]</a><span class="k">def</span> <span class="nf">can_clear_options</span><span class="p">():</span>
    <span class="c"># 0.9.8m or higher</span>
    <span class="k">return</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_OPENSSL_API_VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="no_sslv2_implies_sslv3_hello"><a class="viewcode-back" href="../../test.html#test.test_ssl.no_sslv2_implies_sslv3_hello">[docs]</a><span class="k">def</span> <span class="nf">no_sslv2_implies_sslv3_hello</span><span class="p">():</span>
    <span class="c"># 0.9.7h or higher</span>
    <span class="k">return</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="have_verify_flags"><a class="viewcode-back" href="../../test.html#test.test_ssl.have_verify_flags">[docs]</a><span class="k">def</span> <span class="nf">have_verify_flags</span><span class="p">():</span>
    <span class="c"># 0.9.8 or higher</span>
    <span class="k">return</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="asn1time"><a class="viewcode-back" href="../../test.html#test.test_ssl.asn1time">[docs]</a><span class="k">def</span> <span class="nf">asn1time</span><span class="p">(</span><span class="n">cert_time</span><span class="p">):</span>
    <span class="c"># Some versions of OpenSSL ignore seconds, see #18207</span>
    <span class="c"># 0.9.8.i</span>
    <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_OPENSSL_API_VERSION</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%b </span><span class="si">%d</span><span class="s"> %H:%M:%S %Y GMT&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">cert_time</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cert_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="c"># %d adds leading zero but ASN1_TIME_print() uses leading space</span>
        <span class="k">if</span> <span class="n">cert_time</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span><span class="p">:</span>
            <span class="n">cert_time</span> <span class="o">=</span> <span class="n">cert_time</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">cert_time</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">cert_time</span>

<span class="c"># Issue #9415: Ubuntu hijacks their OpenSSL and forcefully disables SSLv2</span></div>
<div class="viewcode-block" id="skip_if_broken_ubuntu_ssl"><a class="viewcode-back" href="../../test.html#test.test_ssl.skip_if_broken_ubuntu_ssl">[docs]</a><span class="k">def</span> <span class="nf">skip_if_broken_ubuntu_ssl</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="s">&#39;debian&#39;</span><span class="p">,</span> <span class="s">&#39;squeeze/sid&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&quot;Patched Ubuntu OpenSSL breaks behaviour&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span>
</div>
<span class="n">needs_sni</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span><span class="p">,</span> <span class="s">&quot;SNI support needed for this test&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="BasicSocketTests"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests">[docs]</a><span class="k">class</span> <span class="nc">BasicSocketTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="BasicSocketTests.test_constants"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_constants">[docs]</a>    <span class="k">def</span> <span class="nf">test_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span>
        <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
        <span class="n">ssl</span><span class="o">.</span><span class="n">OP_CIPHER_SERVER_PREFERENCE</span>
        <span class="n">ssl</span><span class="o">.</span><span class="n">OP_SINGLE_DH_USE</span>
        <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_ECDH</span><span class="p">:</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">OP_SINGLE_ECDH_USE</span>
        <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span><span class="p">,</span> <span class="p">{</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">HAS_ECDH</span><span class="p">,</span> <span class="p">{</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_random"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_random">[docs]</a>    <span class="k">def</span> <span class="nf">test_random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> RAND_status is </span><span class="si">%d</span><span class="s"> (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span> <span class="ow">and</span> <span class="s">&quot;sufficient randomness&quot;</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="s">&quot;insufficient randomness&quot;</span><span class="p">))</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">is_cryptographic</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_pseudo_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">is_cryptographic</span><span class="p">,</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_bytes</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c"># negative num is invalid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_bytes</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_pseudo_bytes</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_egd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_egd</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_add</span><span class="p">(</span><span class="s">&quot;this is a random string&quot;</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span><span class="p">,</span> <span class="s">&#39;requires posix&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicSocketTests.test_random_fork"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_random_fork">[docs]</a>    <span class="k">def</span> <span class="nf">test_random_fork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;OpenSSL&#39;s PRNG has insufficient randomness&quot;</span><span class="p">)</span>

        <span class="n">rfd</span><span class="p">,</span> <span class="n">wfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">rfd</span><span class="p">)</span>
                <span class="n">child_random</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_pseudo_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">child_random</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">wfd</span><span class="p">,</span> <span class="n">child_random</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">wfd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">wfd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">rfd</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">child_random</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rfd</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">child_random</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">parent_random</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">RAND_pseudo_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_random</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">child_random</span><span class="p">,</span> <span class="n">parent_random</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_parse_cert"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_parse_cert">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># note that this uses an &#39;unofficial&#39; function in _ssl.c,</span>
        <span class="c"># provided solely for this test, to exercise the certificate</span>
        <span class="c"># parsing code</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ssl</span><span class="o">.</span><span class="n">_test_decode_cert</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;issuer&#39;</span><span class="p">],</span>
                         <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;XY&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Castle Anthrax&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Python Software Foundation&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">),))</span>
                        <span class="p">)</span>
        <span class="c"># Note the next three asserts will fail if the keys are regenerated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;notAfter&#39;</span><span class="p">],</span> <span class="n">asn1time</span><span class="p">(</span><span class="s">&#39;Oct  5 23:01:56 2020 GMT&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;notBefore&#39;</span><span class="p">],</span> <span class="n">asn1time</span><span class="p">(</span><span class="s">&#39;Oct  8 23:01:56 2010 GMT&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;serialNumber&#39;</span><span class="p">],</span> <span class="s">&#39;D7C7381919AFC24E&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">],</span>
                         <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;XY&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Castle Anthrax&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Python Software Foundation&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">),))</span>
                        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;subjectAltName&#39;</span><span class="p">],</span> <span class="p">((</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">),))</span>
        <span class="c"># Issue #13034: the subjectAltName in some certificates</span>
        <span class="c"># (notably projects.developer.nokia.com:443) wasn&#39;t parsed</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ssl</span><span class="o">.</span><span class="n">_test_decode_cert</span><span class="p">(</span><span class="n">NOKIACERT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;subjectAltName&#39;</span><span class="p">],</span>
                         <span class="p">((</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;projects.developer.nokia.com&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;projects.forum.nokia.com&#39;</span><span class="p">))</span>
                        <span class="p">)</span>
        <span class="c"># extra OCSP and AIA fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;OCSP&#39;</span><span class="p">],</span> <span class="p">(</span><span class="s">&#39;http://ocsp.verisign.com&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;caIssuers&#39;</span><span class="p">],</span>
                         <span class="p">(</span><span class="s">&#39;http://SVRIntl-G3-aia.verisign.com/SVRIntlG3.cer&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;crlDistributionPoints&#39;</span><span class="p">],</span>
                         <span class="p">(</span><span class="s">&#39;http://SVRIntl-G3-crl.verisign.com/SVRIntlG3.crl&#39;</span><span class="p">,))</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_parse_cert_CVE_2013_4238"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_parse_cert_CVE_2013_4238">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_cert_CVE_2013_4238</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ssl</span><span class="o">.</span><span class="n">_test_decode_cert</span><span class="p">(</span><span class="n">NULLBYTECERT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;US&#39;</span><span class="p">),),</span>
                   <span class="p">((</span><span class="s">&#39;stateOrProvinceName&#39;</span><span class="p">,</span> <span class="s">&#39;Oregon&#39;</span><span class="p">),),</span>
                   <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Beaverton&#39;</span><span class="p">),),</span>
                   <span class="p">((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Python Software Foundation&#39;</span><span class="p">),),</span>
                   <span class="p">((</span><span class="s">&#39;organizationalUnitName&#39;</span><span class="p">,</span> <span class="s">&#39;Python Core Development&#39;</span><span class="p">),),</span>
                   <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;null.python.org</span><span class="se">\x00</span><span class="s">example.org&#39;</span><span class="p">),),</span>
                   <span class="p">((</span><span class="s">&#39;emailAddress&#39;</span><span class="p">,</span> <span class="s">&#39;python-dev@python.org&#39;</span><span class="p">),))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;issuer&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_OPENSSL_API_VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">san</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;altnull.python.org</span><span class="se">\x00</span><span class="s">example.com&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;null@python.org</span><span class="se">\x00</span><span class="s">user@example.org&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;URI&#39;</span><span class="p">,</span> <span class="s">&#39;http://null.python.org</span><span class="se">\x00</span><span class="s">http://example.org&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;IP Address&#39;</span><span class="p">,</span> <span class="s">&#39;192.0.2.1&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;IP Address&#39;</span><span class="p">,</span> <span class="s">&#39;2001:DB8:0:0:0:0:0:1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># OpenSSL 0.9.7 doesn&#39;t support IPv6 addresses in subjectAltName</span>
            <span class="n">san</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;altnull.python.org</span><span class="se">\x00</span><span class="s">example.com&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;null@python.org</span><span class="se">\x00</span><span class="s">user@example.org&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;URI&#39;</span><span class="p">,</span> <span class="s">&#39;http://null.python.org</span><span class="se">\x00</span><span class="s">http://example.org&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;IP Address&#39;</span><span class="p">,</span> <span class="s">&#39;192.0.2.1&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s">&#39;IP Address&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;invalid&gt;&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;subjectAltName&#39;</span><span class="p">],</span> <span class="n">san</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_DER_to_PEM"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_DER_to_PEM">[docs]</a>    <span class="k">def</span> <span class="nf">test_DER_to_PEM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_cert_to_DER_cert</span><span class="p">(</span><span class="n">pem</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">DER_cert_to_PEM_cert</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_cert_to_DER_cert</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PEM_HEADER</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;DER-to-PEM didn&#39;t include correct header:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">p2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p2</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_FOOTER</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;DER-to-PEM didn&#39;t include correct footer:</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">p2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_openssl_version"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_openssl_version">[docs]</a>    <span class="k">def</span> <span class="nf">test_openssl_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_NUMBER</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="c"># Some sanity checks follow</span>
        <span class="c"># &gt;= 0.9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mh">0x900000</span><span class="p">)</span>
        <span class="c"># &lt; 3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mh">0x30000000</span><span class="p">)</span>
        <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">fix</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="c"># Version string as returned by {Open,Libre}SSL, the format might change</span>
        <span class="k">if</span> <span class="s">&quot;LibreSSL&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;LibreSSL {:d}.{:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;OpenSSL {:d}.{:d}.{:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">fix</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</div>
    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="BasicSocketTests.test_refcycle"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_refcycle">[docs]</a>    <span class="k">def</span> <span class="nf">test_refcycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #7943: an SSL object doesn&#39;t create reference cycles with</span>
        <span class="c"># itself.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">check_warnings</span><span class="p">((</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)):</span>
            <span class="k">del</span> <span class="n">ss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wr</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_wrapped_unconnected"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_wrapped_unconnected">[docs]</a>    <span class="k">def</span> <span class="nf">test_wrapped_unconnected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Methods on an unconnected SSLSocket propagate the original</span>
        <span class="c"># OSError raise by the underlying socket object.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">as</span> <span class="n">ss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">recv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">recv_into</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;x&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;x&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">sendto</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_timeout"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #8524: when creating an SSL socket, the timeout of the</span>
        <span class="c"># original socket should be retained.</span>
        <span class="k">for</span> <span class="n">timeout</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">as</span> <span class="n">ss</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_errors"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_errors">[docs]</a>    <span class="k">def</span> <span class="nf">test_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span>
                        <span class="s">&quot;certfile must be specified&quot;</span><span class="p">,</span>
                        <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span>
                        <span class="s">&quot;certfile must be specified for server-side operations&quot;</span><span class="p">,</span>
                        <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span>
                        <span class="s">&quot;certfile must be specified for server-side operations&quot;</span><span class="p">,</span>
                        <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;can&#39;t connect in server-side mode&quot;</span><span class="p">,</span>
                                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">8080</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">WRONGCERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">WRONGCERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">WRONGCERT</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">WRONGCERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_match_hostname"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_match_hostname">[docs]</a>    <span class="k">def</span> <span class="nf">test_match_hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">CertificateError</span><span class="p">,</span>
                              <span class="n">ssl</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>

        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;example.com&#39;</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;example.com&#39;</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;ExAmple.cOm&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;www.example.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;.example.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;example.org&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;exampleXcom&#39;</span><span class="p">)</span>

        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;*.a.com&#39;</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;foo.a.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;bar.foo.a.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;a.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;Xa.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;.a.com&#39;</span><span class="p">)</span>

        <span class="c"># only match one left-most wildcard</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;f*.com&#39;</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;foo.com&#39;</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;f.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;bar.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;foo.a.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;bar.foo.com&#39;</span><span class="p">)</span>

        <span class="c"># NULL bytes are bad, CVE-2013-4073</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span>
                              <span class="s">&#39;null.python.org</span><span class="se">\x00</span><span class="s">example.org&#39;</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;null.python.org</span><span class="se">\x00</span><span class="s">example.org&#39;</span><span class="p">)</span> <span class="c"># or raise an error?</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;example.org&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;null.python.org&#39;</span><span class="p">)</span>

        <span class="c"># error cases with wildcards</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;*.*.a.com&#39;</span><span class="p">),),)}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;bar.foo.a.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;a.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;Xa.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;.a.com&#39;</span><span class="p">)</span>

        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;a.*.com&#39;</span><span class="p">),),)}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;a.foo.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;a..com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;a.com&#39;</span><span class="p">)</span>

        <span class="c"># wildcard doesn&#39;t match IDNA prefix &#39;xn--&#39;</span>
        <span class="n">idna</span> <span class="o">=</span> <span class="s">&#39;pthon.python.org&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;idna&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="n">idna</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">idna</span><span class="p">)</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;x*.python.org&#39;</span><span class="p">),),)}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">idna</span><span class="p">)</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;xn--p*.python.org&#39;</span><span class="p">),),)}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">idna</span><span class="p">)</span>

        <span class="c"># wildcard in first fragment and  IDNA A-labels in sequent fragments</span>
        <span class="c"># are supported.</span>
        <span class="n">idna</span> <span class="o">=</span> <span class="s">&#39;www*.pythn.org&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;idna&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="n">idna</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;www.pythn.org&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;idna&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">))</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;www1.pythn.org&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;idna&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">))</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;ftp.pythn.org&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;idna&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">))</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;pythn.org&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;idna&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">))</span>

        <span class="c"># Slightly fake real-world example</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notAfter&#39;</span><span class="p">:</span> <span class="s">&#39;Jun 26 21:41:46 2011 GMT&#39;</span><span class="p">,</span>
                <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;linuxfrz.org&#39;</span><span class="p">),),),</span>
                <span class="s">&#39;subjectAltName&#39;</span><span class="p">:</span> <span class="p">((</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;linuxfr.org&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s">&#39;DNS&#39;</span><span class="p">,</span> <span class="s">&#39;linuxfr.com&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s">&#39;othername&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;unsupported&gt;&#39;</span><span class="p">))}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;linuxfr.org&#39;</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;linuxfr.com&#39;</span><span class="p">)</span>
        <span class="c"># Not a &quot;DNS&quot; entry</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;&lt;unsupported&gt;&#39;</span><span class="p">)</span>
        <span class="c"># When there is a subjectAltName, commonName isn&#39;t used</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;linuxfrz.org&#39;</span><span class="p">)</span>

        <span class="c"># A pristine real-world example</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notAfter&#39;</span><span class="p">:</span> <span class="s">&#39;Dec 18 23:59:59 2011 GMT&#39;</span><span class="p">,</span>
                <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;US&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;stateOrProvinceName&#39;</span><span class="p">,</span> <span class="s">&#39;California&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Mountain View&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Google Inc&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;mail.google.com&#39;</span><span class="p">),))}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;mail.google.com&#39;</span><span class="p">)</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;gmail.com&#39;</span><span class="p">)</span>
        <span class="c"># Only commonName is considered</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;California&#39;</span><span class="p">)</span>

        <span class="c"># Neither commonName nor subjectAltName</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notAfter&#39;</span><span class="p">:</span> <span class="s">&#39;Dec 18 23:59:59 2011 GMT&#39;</span><span class="p">,</span>
                <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;US&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;stateOrProvinceName&#39;</span><span class="p">,</span> <span class="s">&#39;California&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Mountain View&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Google Inc&#39;</span><span class="p">),))}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;mail.google.com&#39;</span><span class="p">)</span>

        <span class="c"># No DNS entry in subjectAltName but a commonName</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notAfter&#39;</span><span class="p">:</span> <span class="s">&#39;Dec 18 23:59:59 2099 GMT&#39;</span><span class="p">,</span>
                <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;US&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;stateOrProvinceName&#39;</span><span class="p">,</span> <span class="s">&#39;California&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Mountain View&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;mail.google.com&#39;</span><span class="p">),)),</span>
                <span class="s">&#39;subjectAltName&#39;</span><span class="p">:</span> <span class="p">((</span><span class="s">&#39;othername&#39;</span><span class="p">,</span> <span class="s">&#39;blabla&#39;</span><span class="p">),</span> <span class="p">)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;mail.google.com&#39;</span><span class="p">)</span>

        <span class="c"># No DNS entry subjectAltName and no commonName</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notAfter&#39;</span><span class="p">:</span> <span class="s">&#39;Dec 18 23:59:59 2099 GMT&#39;</span><span class="p">,</span>
                <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;countryName&#39;</span><span class="p">,</span> <span class="s">&#39;US&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;stateOrProvinceName&#39;</span><span class="p">,</span> <span class="s">&#39;California&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;localityName&#39;</span><span class="p">,</span> <span class="s">&#39;Mountain View&#39;</span><span class="p">),),</span>
                            <span class="p">((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Google Inc&#39;</span><span class="p">),)),</span>
                <span class="s">&#39;subjectAltName&#39;</span><span class="p">:</span> <span class="p">((</span><span class="s">&#39;othername&#39;</span><span class="p">,</span> <span class="s">&#39;blabla&#39;</span><span class="p">),)}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;google.com&#39;</span><span class="p">)</span>

        <span class="c"># Empty cert / no cert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">,</span> <span class="p">{},</span> <span class="s">&#39;example.com&#39;</span><span class="p">)</span>

        <span class="c"># Issue #17980: avoid denials of service by refusing more than one</span>
        <span class="c"># wildcard per fragment.</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;a*b.com&#39;</span><span class="p">),),)}</span>
        <span class="n">ok</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;axxb.com&#39;</span><span class="p">)</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;a*b.co*&#39;</span><span class="p">),),)}</span>
        <span class="n">fail</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;axxb.com&#39;</span><span class="p">)</span>
        <span class="n">cert</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;a*b*.com&#39;</span><span class="p">),),)}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">CertificateError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&#39;axxbxxc.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;too many wildcards&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_server_side"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_server_side">[docs]</a>    <span class="k">def</span> <span class="nf">test_server_side</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># server_hostname doesn&#39;t work for server sockets</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="n">server_hostname</span><span class="o">=</span><span class="s">&quot;some.hostname&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_unknown_channel_binding"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_unknown_channel_binding">[docs]</a>    <span class="k">def</span> <span class="nf">test_unknown_channel_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># should raise ValueError for unknown type</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">as</span> <span class="n">ss</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">get_channel_binding</span><span class="p">(</span><span class="s">&quot;unknown-type&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span> <span class="ow">in</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CHANNEL_BINDING_TYPES</span><span class="p">,</span>
                         <span class="s">&quot;&#39;tls-unique&#39; channel binding not available&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicSocketTests.test_tls_unique_channel_binding"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_tls_unique_channel_binding">[docs]</a>    <span class="k">def</span> <span class="nf">test_tls_unique_channel_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># unconnected should return None for known type</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">as</span> <span class="n">ss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">get_channel_binding</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span><span class="p">))</span>
        <span class="c"># the same for server-side</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span> <span class="k">as</span> <span class="n">ss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">get_channel_binding</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_dealloc_warn"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_dealloc_warn">[docs]</a>    <span class="k">def</span> <span class="nf">test_dealloc_warn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="n">ResourceWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_get_default_verify_paths"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_get_default_verify_paths">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_default_verify_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">get_default_verify_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">DefaultVerifyPaths</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">EnvironmentVarGuard</span><span class="p">()</span> <span class="k">as</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;SSL_CERT_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAPATH</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;SSL_CERT_FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CERTFILE</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">get_default_verify_paths</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">cafile</span><span class="p">,</span> <span class="n">CERTFILE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">capath</span><span class="p">,</span> <span class="n">CAPATH</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Windows specific&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicSocketTests.test_enum_certificates"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_enum_certificates">[docs]</a>    <span class="k">def</span> <span class="nf">test_enum_certificates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">enum_certificates</span><span class="p">(</span><span class="s">&quot;CA&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">enum_certificates</span><span class="p">(</span><span class="s">&quot;ROOT&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">enum_certificates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">WindowsError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">enum_certificates</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="n">trust_oids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">storename</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;CA&quot;</span><span class="p">,</span> <span class="s">&quot;ROOT&quot;</span><span class="p">):</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">enum_certificates</span><span class="p">(</span><span class="n">storename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">cert</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">trust</span> <span class="o">=</span> <span class="n">element</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;x509_asn&quot;</span><span class="p">,</span> <span class="s">&quot;pkcs_7_asn&quot;</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">trust</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trust</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                    <span class="n">trust_oids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">trust</span><span class="p">)</span>

        <span class="n">serverAuth</span> <span class="o">=</span> <span class="s">&quot;1.3.6.1.5.5.7.3.1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">serverAuth</span><span class="p">,</span> <span class="n">trust_oids</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Windows specific&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicSocketTests.test_enum_crls"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_enum_crls">[docs]</a>    <span class="k">def</span> <span class="nf">test_enum_crls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">enum_crls</span><span class="p">(</span><span class="s">&quot;CA&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">enum_crls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">WindowsError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">enum_crls</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="n">crls</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">enum_crls</span><span class="p">(</span><span class="s">&quot;CA&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">crls</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">crls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;x509_asn&quot;</span><span class="p">,</span> <span class="s">&quot;pkcs_7_asn&quot;</span><span class="p">})</span>

</div>
<div class="viewcode-block" id="BasicSocketTests.test_asn1object"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_asn1object">[docs]</a>    <span class="k">def</span> <span class="nf">test_asn1object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="mi">129</span><span class="p">,</span> <span class="s">&#39;serverAuth&#39;</span><span class="p">,</span> <span class="s">&#39;TLS Web Server Authentication&#39;</span><span class="p">,</span>
                    <span class="s">&#39;1.3.6.1.5.5.7.3.1&#39;</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">(</span><span class="s">&#39;1.3.6.1.5.5.7.3.1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span> <span class="mi">129</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&#39;serverAuth&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">longname</span><span class="p">,</span> <span class="s">&#39;TLS Web Server Authentication&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span> <span class="s">&#39;1.3.6.1.5.5.7.3.1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">,</span> <span class="s">&#39;serverAuth&#39;</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromnid</span><span class="p">(</span><span class="mi">129</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromnid</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;unknown NID 100000&quot;</span><span class="p">):</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromnid</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromnid</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">longname</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">)))</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromname</span><span class="p">(</span><span class="s">&#39;TLS Web Server Authentication&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromname</span><span class="p">(</span><span class="s">&#39;serverAuth&#39;</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromname</span><span class="p">(</span><span class="s">&#39;1.3.6.1.5.5.7.3.1&#39;</span><span class="p">),</span>
                         <span class="n">expected</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;unknown object &#39;serverauth&#39;&quot;</span><span class="p">):</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="o">.</span><span class="n">fromname</span><span class="p">(</span><span class="s">&#39;serverauth&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_purpose_enum"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_purpose_enum">[docs]</a>    <span class="k">def</span> <span class="nf">test_purpose_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">(</span><span class="s">&#39;1.3.6.1.5.5.7.3.1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span> <span class="mi">129</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&#39;serverAuth&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span>
                              <span class="s">&#39;1.3.6.1.5.5.7.3.1&#39;</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">(</span><span class="s">&#39;1.3.6.1.5.5.7.3.2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_ASN1Object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&#39;clientAuth&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span>
                              <span class="s">&#39;1.3.6.1.5.5.7.3.2&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketTests.test_unsupported_dtls"><a class="viewcode-back" href="../../test.html#test.test_ssl.BasicSocketTests.test_unsupported_dtls">[docs]</a>    <span class="k">def</span> <span class="nf">test_unsupported_dtls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cx</span><span class="p">:</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span> <span class="s">&quot;only stream sockets are supported&quot;</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cx</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cx</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span> <span class="s">&quot;only stream sockets are supported&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ContextTests"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests">[docs]</a><span class="k">class</span> <span class="nc">ContextTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ContextTests.test_constructor"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">PROTOCOLS</span><span class="p">:</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
</div>
    <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ContextTests.test_protocol"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_protocol">[docs]</a>    <span class="k">def</span> <span class="nf">test_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">PROTOCOLS</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test_ciphers"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_ciphers">[docs]</a>    <span class="k">def</span> <span class="nf">test_ciphers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;ALL&quot;</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;DEFAULT&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;No cipher can be selected&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;^$:,;?*&#39;dorothyx&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ContextTests.test_options"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_options">[docs]</a>    <span class="k">def</span> <span class="nf">test_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="c"># OP_ALL | OP_NO_SSLv2 is the default value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_ALL</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span>
                         <span class="n">ctx</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_ALL</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="p">,</span>
                         <span class="n">ctx</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">can_clear_options</span><span class="p">():</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_ALL</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="p">,</span>
                             <span class="n">ctx</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="ContextTests.test_verify_mode"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_verify_mode">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="c"># Default value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="mi">42</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">have_verify_flags</span><span class="p">(),</span>
                         <span class="s">&quot;verify_flags need OpenSSL &gt; 0.9.8&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ContextTests.test_verify_flags"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_verify_flags">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="c"># default value by OpenSSL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_DEFAULT</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_LEAF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_LEAF</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_CHAIN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_CHAIN</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_DEFAULT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_DEFAULT</span><span class="p">)</span>
        <span class="c"># supports any value</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_LEAF</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_X509_STRICT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span><span class="p">,</span>
                         <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_LEAF</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_X509_STRICT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_flags</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="ContextTests.test_load_cert_chain"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_load_cert_chain">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cert_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="c"># Combined key and cert in a single file</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">WRONGCERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;PEM lib&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">BADCERT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;PEM lib&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">EMPTYCERT</span><span class="p">)</span>
        <span class="c"># Separate key and cert</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">ONLYCERT</span><span class="p">,</span> <span class="n">ONLYKEY</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">ONLYCERT</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">ONLYKEY</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">BYTES_ONLYCERT</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">BYTES_ONLYKEY</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;PEM lib&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">ONLYCERT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;PEM lib&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">ONLYKEY</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;PEM lib&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">ONLYKEY</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">ONLYCERT</span><span class="p">)</span>
        <span class="c"># Mismatching key and cert</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;key values mismatch&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">,</span> <span class="n">ONLYKEY</span><span class="p">)</span>
        <span class="c"># Password protected key and cert</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">KEY_PASSWORD</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">KEY_PASSWORD</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span>
                            <span class="n">password</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">KEY_PASSWORD</span><span class="o">.</span><span class="n">encode</span><span class="p">()))</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">ONLYCERT</span><span class="p">,</span> <span class="n">ONLYKEY_PROTECTED</span><span class="p">,</span> <span class="n">KEY_PASSWORD</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">ONLYCERT</span><span class="p">,</span> <span class="n">ONLYKEY_PROTECTED</span><span class="p">,</span> <span class="n">KEY_PASSWORD</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">ONLYCERT</span><span class="p">,</span> <span class="n">ONLYKEY_PROTECTED</span><span class="p">,</span>
                            <span class="nb">bytearray</span><span class="p">(</span><span class="n">KEY_PASSWORD</span><span class="o">.</span><span class="n">encode</span><span class="p">()))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s">&quot;should be a string&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;badpass&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;cannot be longer&quot;</span><span class="p">):</span>
            <span class="c"># openssl has a fixed limit on the password buffer.</span>
            <span class="c"># PEM_BUFSIZE is generally set to 1kb.</span>
            <span class="c"># Return a string larger than this.</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">b</span><span class="s">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">102400</span><span class="p">)</span>
        <span class="c"># Password callback</span>
        <span class="k">def</span> <span class="nf">getpass_unicode</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">KEY_PASSWORD</span>
        <span class="k">def</span> <span class="nf">getpass_bytes</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">KEY_PASSWORD</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">getpass_bytearray</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">KEY_PASSWORD</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">getpass_badpass</span><span class="p">():</span>
            <span class="k">return</span> <span class="s">&quot;badpass&quot;</span>
        <span class="k">def</span> <span class="nf">getpass_huge</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">b</span><span class="s">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">getpass_bad_type</span><span class="p">():</span>
            <span class="k">return</span> <span class="mi">9</span>
        <span class="k">def</span> <span class="nf">getpass_exception</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;getpass error&#39;</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">GetPassCallable</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">KEY_PASSWORD</span>
            <span class="k">def</span> <span class="nf">getpass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">KEY_PASSWORD</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_unicode</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_bytes</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_bytearray</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">GetPassCallable</span><span class="p">())</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span>
                            <span class="n">password</span><span class="o">=</span><span class="n">GetPassCallable</span><span class="p">()</span><span class="o">.</span><span class="n">getpass</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_badpass</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;cannot be longer&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_huge</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s">&quot;must return a string&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_bad_type</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="s">&quot;getpass error&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE_PROTECTED</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_exception</span><span class="p">)</span>
        <span class="c"># Make sure the password function isn&#39;t called if it isn&#39;t needed</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">getpass_exception</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test_load_verify_locations"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_load_verify_locations">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_verify_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">capath</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">BYTES_CERTFILE</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">BYTES_CERTFILE</span><span class="p">,</span> <span class="n">capath</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">WRONGCERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;PEM lib&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">BADCERT</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">CAPATH</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">capath</span><span class="o">=</span><span class="n">BYTES_CAPATH</span><span class="p">)</span>

        <span class="c"># Issue #10989: crash if the second argument type is invalid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test_load_verify_cadata"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_load_verify_cadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_verify_cadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># test cadata</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CAFILE_CACERT</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cacert_pem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">cacert_der</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_cert_to_DER_cert</span><span class="p">(</span><span class="n">cacert_pem</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CAFILE_NEURONIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">neuronio_pem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">neuronio_der</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_cert_to_DER_cert</span><span class="p">(</span><span class="n">neuronio_pem</span><span class="p">)</span>

        <span class="c"># test PEM</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">cacert_pem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">neuronio_pem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c"># cert already in hash table</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">neuronio_pem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># combined</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">cacert_pem</span><span class="p">,</span> <span class="n">neuronio_pem</span><span class="p">))</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">combined</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># with junk around the certs</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;head&quot;</span><span class="p">,</span> <span class="n">cacert_pem</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">,</span> <span class="n">neuronio_pem</span><span class="p">,</span> <span class="s">&quot;again&quot;</span><span class="p">,</span>
                    <span class="n">neuronio_pem</span><span class="p">,</span> <span class="s">&quot;tail&quot;</span><span class="p">]</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># test DER</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">cacert_der</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">neuronio_der</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c"># cert already in hash table</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">cacert_der</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># combined</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">cacert_der</span><span class="p">,</span> <span class="n">neuronio_der</span><span class="p">))</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">combined</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">()[</span><span class="s">&quot;x509_ca&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># error cases</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">,</span> <span class="n">cadata</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;no start line&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="s">&quot;broken&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;not enough data&quot;</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">b</span><span class="s">&quot;broken&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ContextTests.test_load_dh_params"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_load_dh_params">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_dh_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">(</span><span class="n">DHFILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;nt&#39;</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">(</span><span class="n">BYTES_DHFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">(</span><span class="n">WRONGCERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
</div>
    <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ContextTests.test_session_stats"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_session_stats">[docs]</a>    <span class="k">def</span> <span class="nf">test_session_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">PROTOCOLS</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">session_stats</span><span class="p">(),</span> <span class="p">{</span>
                <span class="s">&#39;number&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;connect&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;connect_good&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;connect_renegotiate&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;accept&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;accept_good&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;accept_renegotiate&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;hits&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;misses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;timeouts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;cache_full&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">})</span>
</div>
<div class="viewcode-block" id="ContextTests.test_set_default_verify_paths"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_set_default_verify_paths">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_default_verify_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># There&#39;s not much we can do to test that it acts as expected,</span>
        <span class="c"># so just check it doesn&#39;t crash or raise an exception.</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_default_verify_paths</span><span class="p">()</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">HAS_ECDH</span><span class="p">,</span> <span class="s">&quot;ECDH disabled on this OpenSSL build&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ContextTests.test_set_ecdh_curve"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_set_ecdh_curve">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_ecdh_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_ecdh_curve</span><span class="p">(</span><span class="s">&quot;prime256v1&quot;</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_ecdh_curve</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;prime256v1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_ecdh_curve</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_ecdh_curve</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_ecdh_curve</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_ecdh_curve</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ContextTests.test_sni_callback"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_sni_callback">[docs]</a>    <span class="k">def</span> <span class="nf">test_sni_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>

        <span class="c"># set_servername_callback expects a callable, or None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">dummycallback</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="n">dummycallback</span><span class="p">)</span>
</div>
    <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ContextTests.test_sni_callback_refcycle"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_sni_callback_refcycle">[docs]</a>    <span class="k">def</span> <span class="nf">test_sni_callback_refcycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Reference cycles through the servername callback are detected</span>
        <span class="c"># and cleared.</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">dummycallback</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="n">ctx</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="n">dummycallback</span><span class="p">)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">dummycallback</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">wr</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test_cert_store_stats"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_cert_store_stats">[docs]</a>    <span class="k">def</span> <span class="nf">test_cert_store_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">(),</span>
            <span class="p">{</span><span class="s">&#39;x509_ca&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;crl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;x509&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">(),</span>
            <span class="p">{</span><span class="s">&#39;x509_ca&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;crl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;x509&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">(),</span>
            <span class="p">{</span><span class="s">&#39;x509_ca&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;crl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;x509&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">cert_store_stats</span><span class="p">(),</span>
            <span class="p">{</span><span class="s">&#39;x509_ca&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;crl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;x509&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="ContextTests.test_get_ca_certs"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_get_ca_certs">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_ca_certs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_ca_certs</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="c"># CERTFILE is not flagged as X509v3 Basic Constraints: CA:TRUE</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_ca_certs</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="c"># but SVN_PYTHON_ORG_ROOT_CERT is a CA cert</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_ca_certs</span><span class="p">(),</span>
            <span class="p">[{</span><span class="s">&#39;issuer&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Root CA&#39;</span><span class="p">),),</span>
                         <span class="p">((</span><span class="s">&#39;organizationalUnitName&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.cacert.org&#39;</span><span class="p">),),</span>
                         <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;CA Cert Signing Authority&#39;</span><span class="p">),),</span>
                         <span class="p">((</span><span class="s">&#39;emailAddress&#39;</span><span class="p">,</span> <span class="s">&#39;support@cacert.org&#39;</span><span class="p">),)),</span>
              <span class="s">&#39;notAfter&#39;</span><span class="p">:</span> <span class="n">asn1time</span><span class="p">(</span><span class="s">&#39;Mar 29 12:29:49 2033 GMT&#39;</span><span class="p">),</span>
              <span class="s">&#39;notBefore&#39;</span><span class="p">:</span> <span class="n">asn1time</span><span class="p">(</span><span class="s">&#39;Mar 30 12:29:49 2003 GMT&#39;</span><span class="p">),</span>
              <span class="s">&#39;serialNumber&#39;</span><span class="p">:</span> <span class="s">&#39;00&#39;</span><span class="p">,</span>
              <span class="s">&#39;crlDistributionPoints&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;https://www.cacert.org/revoke.crl&#39;</span><span class="p">,),</span>
              <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">(((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Root CA&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;organizationalUnitName&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.cacert.org&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="s">&#39;CA Cert Signing Authority&#39;</span><span class="p">),),</span>
                          <span class="p">((</span><span class="s">&#39;emailAddress&#39;</span><span class="p">,</span> <span class="s">&#39;support@cacert.org&#39;</span><span class="p">),)),</span>
              <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_cert_to_DER_cert</span><span class="p">(</span><span class="n">pem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_ca_certs</span><span class="p">(</span><span class="bp">True</span><span class="p">),</span> <span class="p">[</span><span class="n">der</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ContextTests.test_load_default_certs"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_load_default_certs">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_default_certs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">()</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">()</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">load_default_certs</span><span class="p">,</span> <span class="s">&#39;SERVER_AUTH&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test_create_default_context"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_create_default_context">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_default_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SIGNING_CA</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cadata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">SIGNING_CA</span><span class="p">,</span> <span class="n">capath</span><span class="o">=</span><span class="n">CAPATH</span><span class="p">,</span>
                                         <span class="n">cadata</span><span class="o">=</span><span class="n">cadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_SINGLE_DH_USE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_SINGLE_DH_USE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_SINGLE_ECDH_USE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;OP_SINGLE_ECDH_USE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test__create_stdlib_context"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test__create_stdlib_context">[docs]</a>    <span class="k">def</span> <span class="nf">test__create_stdlib_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span>
                                         <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                         <span class="n">check_hostname</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_stdlib_context</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextTests.test_check_hostname"><a class="viewcode-back" href="../../test.html#test.test_ssl.ContextTests.test_check_hostname">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>

        <span class="c"># Requires CERT_REQUIRED or CERT_OPTIONAL</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>

        <span class="c"># Cannot set CERT_NONE with check_hostname enabled</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">check_hostname</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SSLErrorTests"><a class="viewcode-back" href="../../test.html#test.test_ssl.SSLErrorTests">[docs]</a><span class="k">class</span> <span class="nc">SSLErrorTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="SSLErrorTests.test_str"><a class="viewcode-back" href="../../test.html#test.test_ssl.SSLErrorTests.test_str">[docs]</a>    <span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The str() of a SSLError doesn&#39;t include the errno</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># Same for a subclass</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLZeroReturnError</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SSLErrorTests.test_lib_reason"><a class="viewcode-back" href="../../test.html#test.test_ssl.SSLErrorTests.test_lib_reason">[docs]</a>    <span class="k">def</span> <span class="nf">test_lib_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test the library and reason attributes</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="s">&#39;PEM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="s">&#39;NO_START_LINE&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;[PEM: NO_START_LINE] no start line&quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SSLErrorTests.test_subclass"><a class="viewcode-back" href="../../test.html#test.test_ssl.SSLErrorTests.test_subclass">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that the appropriate SSLError subclass is raised</span>
        <span class="c"># (this only tests one of them)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantReadError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;The operation did not complete (read)&quot;</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
                <span class="c"># For compatibility</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSL_ERROR_WANT_READ</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="NetworkedTests"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests">[docs]</a><span class="k">class</span> <span class="nc">NetworkedTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="NetworkedTests.test_connect"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_connect">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># this should fail because we have no verification certs</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;certificate verify failed&quot;</span><span class="p">,</span>
                                   <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c"># this should succeed because we specify the root cert</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_connect_ex"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_connect_ex">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect_ex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #11326: check connect_ex() implementation</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_non_blocking_connect_ex"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_non_blocking_connect_ex">[docs]</a>    <span class="k">def</span> <span class="nf">test_non_blocking_connect_ex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #11326: non-blocking connect_ex() should allow handshake</span>
        <span class="c"># to proceed after the socket gets ready.</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">,</span>
                                <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s">&#39;svn.python.org&#39;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="c"># EWOULDBLOCK under Windows, EINPROGRESS elsewhere</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINPROGRESS</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EWOULDBLOCK</span><span class="p">))</span>
                <span class="c"># Wait for connect to finish</span>
                <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="p">[],</span> <span class="mf">5.0</span><span class="p">)</span>
                <span class="c"># Non-blocking handshake</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantReadError</span><span class="p">:</span>
                        <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">s</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">5.0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantWriteError</span><span class="p">:</span>
                        <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="p">[],</span> <span class="mf">5.0</span><span class="p">)</span>
                <span class="c"># SSL established</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_timeout_connect_ex"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_timeout_connect_ex">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout_connect_ex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12065: on a timeout, connect_ex() should return the original</span>
        <span class="c"># errno (mimicking the behaviour of non-SSL sockets).</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">,</span>
                                <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.0000001</span><span class="p">)</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s">&#39;svn.python.org&#39;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;svn.python.org responded too quickly&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EWOULDBLOCK</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_connect_ex_error"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_connect_ex_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect_ex_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">444</span><span class="p">))</span>
                <span class="c"># Issue #19919: Windows machines or VMs hosted on Windows</span>
                <span class="c"># machines sometimes return EWOULDBLOCK.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EWOULDBLOCK</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_connect_with_context"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_connect_with_context">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect_with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="c"># Same as test_connect, but with a separately created context</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># Same with a server hostname</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">server_hostname</span><span class="o">=</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="c"># This should fail because we have no verification certs</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;certificate verify failed&quot;</span><span class="p">,</span>
                                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># This should succeed because we specify the root cert</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_connect_capath"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_connect_capath">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect_capath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Verify server certificates using the `capath` argument</span>
        <span class="c"># NOTE: the subject hashing algorithm has been changed between</span>
        <span class="c"># OpenSSL 0.9.8n and 1.0.0, as a result the capath directory must</span>
        <span class="c"># contain both versions of each certificate (same content, different</span>
        <span class="c"># filename) for this test to be portable across OpenSSL releases.</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">capath</span><span class="o">=</span><span class="n">CAPATH</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># Same with a bytes `capath` argument</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">capath</span><span class="o">=</span><span class="n">BYTES_CAPATH</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_connect_cadata"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_connect_cadata">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect_cadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CAFILE_CACERT</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">der</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PEM_cert_to_DER_cert</span><span class="p">(</span><span class="n">pem</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">pem</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>

            <span class="c"># same with DER</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">der</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;nt&quot;</span><span class="p">,</span> <span class="s">&quot;Can&#39;t use a socket as a file under Windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="NetworkedTests.test_makefile_close"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_makefile_close">[docs]</a>    <span class="k">def</span> <span class="nf">test_makefile_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #5238: creating a file-like object with makefile() shouldn&#39;t</span>
        <span class="c"># delay closing the underlying &quot;real socket&quot; (here tested with its</span>
        <span class="c"># file descriptor, hence skipping the test under Windows).</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">makefile</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># The fd is still open</span>
            <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c"># Closing the SSL socket should close the fd too</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_non_blocking_handshake"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_non_blocking_handshake">[docs]</a>    <span class="k">def</span> <span class="nf">test_non_blocking_handshake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
                                <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
                                <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantReadError</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">s</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
                <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantWriteError</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([],</span> <span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Needed </span><span class="si">%d</span><span class="s"> calls to do_handshake() to establish session.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_get_server_certificate"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_get_server_certificate">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_server_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_test_get_server_certificate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">cert</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
                <span class="n">pem</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">get_server_certificate</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                                                 <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pem</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No server certificate on </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pem</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">get_server_certificate</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                                                     <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span>
                                                     <span class="n">ca_certs</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
                    <span class="c">#should fail</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Got server certificate </span><span class="si">%s</span><span class="s"> for </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pem</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

                <span class="n">pem</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">get_server_certificate</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                                                 <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span>
                                                 <span class="n">ca_certs</span><span class="o">=</span><span class="n">cert</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pem</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No server certificate on </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Verified certificate for </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> is</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="p">,</span><span class="n">pem</span><span class="p">))</span>

        <span class="n">_test_get_server_certificate</span><span class="p">(</span><span class="s">&#39;svn.python.org&#39;</span><span class="p">,</span> <span class="mi">443</span><span class="p">,</span> <span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">:</span>
            <span class="n">_test_get_server_certificate</span><span class="p">(</span><span class="s">&#39;ipv6.google.com&#39;</span><span class="p">,</span> <span class="mi">443</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_ciphers"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_ciphers">[docs]</a>    <span class="k">def</span> <span class="nf">test_ciphers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="n">remote</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                 <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span> <span class="n">ciphers</span><span class="o">=</span><span class="s">&quot;ALL&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                 <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span> <span class="n">ciphers</span><span class="o">=</span><span class="s">&quot;DEFAULT&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
            <span class="c"># Error checking can happen at instantiation or when connecting</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="s">&quot;No cipher can be selected&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
                                        <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span> <span class="n">ciphers</span><span class="o">=</span><span class="s">&quot;^$:,;?*&#39;dorothyx&quot;</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_algorithms"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_algorithms">[docs]</a>    <span class="k">def</span> <span class="nf">test_algorithms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #8484: all algorithms should be available when verifying a</span>
        <span class="c"># certificate.</span>
        <span class="c"># SHA256 was added in OpenSSL 0.9.8</span>
        <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;SHA256 not available on </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION</span><span class="p">)</span>
        <span class="c"># sha256.tbs-internet.com needs SNI to use the correct certificate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;SNI needed for this test&quot;</span><span class="p">)</span>
        <span class="c"># https://sha2.hboeck.de/ was used until 2011-01-08 (no route to host)</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;sha256.tbs-internet.com&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">)</span>
        <span class="n">sha256_cert</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;sha256.pem&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;sha256.tbs-internet.com&quot;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">sha256_cert</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">),</span>
                                <span class="n">server_hostname</span><span class="o">=</span><span class="s">&quot;sha256.tbs-internet.com&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Cipher with </span><span class="si">%r</span><span class="s"> is </span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">cipher</span><span class="p">()))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Certificate is:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkedTests.test_get_ca_certs_capath"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_get_ca_certs_capath">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_ca_certs_capath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># capath certs are loaded on request</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">capath</span><span class="o">=</span><span class="n">CAPATH</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_ca_certs</span><span class="p">(),</span> <span class="p">[])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">get_ca_certs</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="NetworkedTests.test_context_setget"><a class="viewcode-back" href="../../test.html#test.test_ssl.NetworkedTests.test_context_setget">[docs]</a>    <span class="k">def</span> <span class="nf">test_context_setget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that the context of a connected socket can be replaced.</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">transient_internet</span><span class="p">(</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">):</span>
            <span class="n">ctx1</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">ctx2</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ctx1</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">as</span> <span class="n">ss</span><span class="p">:</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;svn.python.org&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">ctx1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">ctx1</span><span class="p">)</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ctx2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">ctx2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">ctx2</span><span class="p">)</span>
</div></div>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_have_threads</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_have_threads</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="kn">from</span> <span class="nn">test.ssl_servers</span> <span class="kn">import</span> <span class="n">make_https_server</span>

<div class="viewcode-block" id="ThreadedEchoServer"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer">[docs]</a>    <span class="k">class</span> <span class="nc">ThreadedEchoServer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

<div class="viewcode-block" id="ThreadedEchoServer.ConnectionHandler"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.ConnectionHandler">[docs]</a>        <span class="k">class</span> <span class="nc">ConnectionHandler</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;A mildly complicated class, because we want it to work both</span>
<span class="sd">            with and without the SSL wrapper around the socket connection, so</span>
<span class="sd">            that we can test the STARTTLS functionality.&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">connsock</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">connsock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="ThreadedEchoServer.ConnectionHandler.wrap_conn"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.ConnectionHandler.wrap_conn">[docs]</a>            <span class="k">def</span> <span class="nf">wrap_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">selected_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">selected_npn_protocol</span><span class="p">())</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="n">ConnectionResetError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c"># We treat ConnectionResetError as though it were an</span>
                    <span class="c"># SSLError - OpenSSL on Ubuntu abruptly closes the</span>
                    <span class="c"># connection when asked to use an unsupported protocol.</span>
                    <span class="c">#</span>
                    <span class="c"># XXX Various errors can have happened here, for example</span>
                    <span class="c"># a mismatching protocol version, an invalid certificate,</span>
                    <span class="c"># or a low-level bug. This should be made more discriminating.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">conn_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                        <span class="n">handle_error</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> server:  bad connection attempt from &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">==</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">:</span>
                        <span class="n">cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client cert is &quot;</span> <span class="o">+</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="n">cert_binary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; cert binary is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cert_binary</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">cipher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">cipher</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: connection cipher is now &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: selected protocol is now &quot;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">selected_npn_protocol</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="ThreadedEchoServer.ConnectionHandler.read"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.ConnectionHandler.read">[docs]</a>            <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedEchoServer.ConnectionHandler.write"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.ConnectionHandler.write">[docs]</a>            <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedEchoServer.ConnectionHandler.close"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.ConnectionHandler.close">[docs]</a>            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedEchoServer.ConnectionHandler.run"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.ConnectionHandler.run">[docs]</a>            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">starttls_server</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_conn</span><span class="p">():</span>
                        <span class="k">return</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">stripped</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span><span class="p">:</span>
                            <span class="c"># eof, so quit this handler</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">stripped</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;over&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connectionchatty</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: client closed connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">return</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">starttls_server</span> <span class="ow">and</span>
                              <span class="n">stripped</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;STARTTLS&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connectionchatty</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: read STARTTLS from client, sending OK...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_conn</span><span class="p">():</span>
                                <span class="k">return</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">starttls_server</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span>
                              <span class="ow">and</span> <span class="n">stripped</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;ENDTLS&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connectionchatty</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: read ENDTLS from client, sending OK...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connectionchatty</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: connection is now unencrypted...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">stripped</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;CB tls-unique&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connectionchatty</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: read CB tls-unique from client, sending our CB data...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span><span class="o">.</span><span class="n">get_channel_binding</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;us-ascii&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connectionchatty</span><span class="p">):</span>
                                <span class="n">ctype</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sslconn</span> <span class="ow">and</span> <span class="s">&quot;encrypted&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;unencrypted&quot;</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server: read </span><span class="si">%r</span><span class="s"> (</span><span class="si">%s</span><span class="s">), sending back </span><span class="si">%r</span><span class="s"> (</span><span class="si">%s</span><span class="s">)...</span><span class="se">\n</span><span class="s">&quot;</span>
                                                 <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">ctype</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                            <span class="n">handle_error</span><span class="p">(</span><span class="s">&quot;Test server failure:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="c"># normally, we&#39;d just stop here, but for the test</span>
                        <span class="c"># harness, we want to stop the server</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div></div>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">certreqs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cacerts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">starttls_server</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">npn_protocols</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ciphers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl_version</span>
                                              <span class="k">if</span> <span class="n">ssl_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                                              <span class="k">else</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">certreqs</span> <span class="k">if</span> <span class="n">certreqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                                            <span class="k">else</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cacerts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cacerts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">certificate</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">npn_protocols</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_npn_protocols</span><span class="p">(</span><span class="n">npn_protocols</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ciphers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="n">ciphers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connectionchatty</span> <span class="o">=</span> <span class="n">connectionchatty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">starttls_server</span> <span class="o">=</span> <span class="n">starttls_server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_protocols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn_errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<div class="viewcode-block" id="ThreadedEchoServer.start"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.start">[docs]</a>        <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedEchoServer.run"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.run">[docs]</a>        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
                <span class="c"># signal an event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newconn</span><span class="p">,</span> <span class="n">connaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; server:  new connection from &#39;</span>
                                         <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">connaddr</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConnectionHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newconn</span><span class="p">,</span> <span class="n">connaddr</span><span class="p">)</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedEchoServer.stop"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedEchoServer.stop">[docs]</a>        <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
</div></div>
<div class="viewcode-block" id="AsyncoreEchoServer"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer">[docs]</a>    <span class="k">class</span> <span class="nc">AsyncoreEchoServer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

        <span class="c"># this one&#39;s based on asyncore.dispatcher</span>

<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer">[docs]</a>        <span class="k">class</span> <span class="nc">EchoServer</span> <span class="p">(</span><span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">):</span>

<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.ConnectionHandler"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.ConnectionHandler">[docs]</a>            <span class="k">class</span> <span class="nc">ConnectionHandler</span> <span class="p">(</span><span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher_with_send</span><span class="p">):</span>

                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">certfile</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                  <span class="n">certfile</span><span class="o">=</span><span class="n">certfile</span><span class="p">,</span>
                                                  <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher_with_send</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_accepting</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_do_ssl_handshake</span><span class="p">()</span>

<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.ConnectionHandler.readable"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.ConnectionHandler.readable">[docs]</a>                <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLSocket</span><span class="p">):</span>
                        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">pending</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">handle_read_event</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">True</span>
</div>
                <span class="k">def</span> <span class="nf">_do_ssl_handshake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantReadError</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantWriteError</span><span class="p">):</span>
                        <span class="k">return</span>
                    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLEOFError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_close</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNABORTED</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_close</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_accepting</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.ConnectionHandler.handle_read"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.ConnectionHandler.handle_read">[docs]</a>                <span class="k">def</span> <span class="nf">handle_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_accepting</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_do_ssl_handshake</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server:  read </span><span class="si">%s</span><span class="s"> from client</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.ConnectionHandler.handle_close"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.ConnectionHandler.handle_close">[docs]</a>                <span class="k">def</span> <span class="nf">handle_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server:  closed connection </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.ConnectionHandler.handle_error"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.ConnectionHandler.handle_error">[docs]</a>                <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">raise</span>
</div></div>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certfile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">certfile</span> <span class="o">=</span> <span class="n">certfile</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.handle_accepted"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.handle_accepted">[docs]</a>            <span class="k">def</span> <span class="nf">handle_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock_obj</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; server:  new connection from </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span><span class="n">addr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ConnectionHandler</span><span class="p">(</span><span class="n">sock_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">certfile</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AsyncoreEchoServer.EchoServer.handle_error"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.EchoServer.handle_error">[docs]</a>            <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">raise</span>
</div></div>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EchoServer</span><span class="p">(</span><span class="n">certfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">port</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; cleanup: stopping server.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; cleanup: joining server thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; cleanup: successfully joined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AsyncoreEchoServer.start"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.start">[docs]</a>        <span class="k">def</span> <span class="nf">start</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AsyncoreEchoServer.run"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.run">[docs]</a>        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="AsyncoreEchoServer.stop"><a class="viewcode-back" href="../../test.html#test.test_ssl.AsyncoreEchoServer.stop">[docs]</a>        <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="bad_cert_test"><a class="viewcode-back" href="../../test.html#test.test_ssl.bad_cert_test">[docs]</a>    <span class="k">def</span> <span class="nf">bad_cert_test</span><span class="p">(</span><span class="n">certfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch a server with CERT_REQUIRED, and check that trying to</span>
<span class="sd">        connect to it with the given client certificate fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">certreqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">,</span>
                                    <span class="n">cacerts</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                    <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
                                        <span class="n">certfile</span><span class="o">=</span><span class="n">certfile</span><span class="p">,</span>
                                        <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SSLError is </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">OSError is </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;\OSError is </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;Use of invalid cert should have failed!&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="server_params_test"><a class="viewcode-back" href="../../test.html#test.test_ssl.server_params_test">[docs]</a>    <span class="k">def</span> <span class="nf">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span> <span class="n">indata</span><span class="o">=</span><span class="n">b</span><span class="s">&quot;FOO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">sni_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch a server, connect a client to it and try various reads</span>
<span class="sd">        and writes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span>
                                    <span class="n">chatty</span><span class="o">=</span><span class="n">chatty</span><span class="p">,</span>
                                    <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">client_context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                    <span class="n">server_hostname</span><span class="o">=</span><span class="n">sni_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">[</span><span class="n">indata</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">indata</span><span class="p">),</span> <span class="n">memoryview</span><span class="p">(</span><span class="n">indata</span><span class="p">)]:</span>
                    <span class="k">if</span> <span class="n">connectionchatty</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s">&quot; client:  sending </span><span class="si">%r</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">indata</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">outdata</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">connectionchatty</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client:  read </span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outdata</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">outdata</span> <span class="o">!=</span> <span class="n">indata</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                            <span class="s">&quot;bad data &lt;&lt;</span><span class="si">%r</span><span class="s">&gt;&gt; (</span><span class="si">%d</span><span class="s">) received; expected &lt;&lt;</span><span class="si">%r</span><span class="s">&gt;&gt; (</span><span class="si">%d</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">outdata</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">outdata</span><span class="p">),</span>
                               <span class="n">indata</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">indata</span><span class="p">)))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">connectionchatty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client:  closing connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s">&#39;compression&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">compression</span><span class="p">(),</span>
                    <span class="s">&#39;cipher&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">cipher</span><span class="p">(),</span>
                    <span class="s">&#39;peercert&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(),</span>
                    <span class="s">&#39;client_npn_protocol&#39;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">selected_npn_protocol</span><span class="p">()</span>
                <span class="p">})</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">stats</span><span class="p">[</span><span class="s">&#39;server_npn_protocols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">selected_protocols</span>
        <span class="k">return</span> <span class="n">stats</span>
</div>
<div class="viewcode-block" id="try_protocol_combo"><a class="viewcode-back" href="../../test.html#test.test_ssl.try_protocol_combo">[docs]</a>    <span class="k">def</span> <span class="nf">try_protocol_combo</span><span class="p">(</span><span class="n">server_protocol</span><span class="p">,</span> <span class="n">client_protocol</span><span class="p">,</span> <span class="n">expect_success</span><span class="p">,</span>
                           <span class="n">certsreqs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">server_options</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">client_options</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">certsreqs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">certsreqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="n">certtype</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">:</span> <span class="s">&quot;CERT_NONE&quot;</span><span class="p">,</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">:</span> <span class="s">&quot;CERT_OPTIONAL&quot;</span><span class="p">,</span>
            <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">:</span> <span class="s">&quot;CERT_REQUIRED&quot;</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">certsreqs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">formatstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">expect_success</span> <span class="ow">and</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">-&gt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot; {</span><span class="si">%s</span><span class="s">-&gt;</span><span class="si">%s</span><span class="s">} </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">formatstr</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">get_protocol_name</span><span class="p">(</span><span class="n">client_protocol</span><span class="p">),</span>
                              <span class="n">ssl</span><span class="o">.</span><span class="n">get_protocol_name</span><span class="p">(</span><span class="n">server_protocol</span><span class="p">),</span>
                              <span class="n">certtype</span><span class="p">))</span>
        <span class="n">client_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">client_protocol</span><span class="p">)</span>
        <span class="n">client_context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">client_options</span>
        <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">server_protocol</span><span class="p">)</span>
        <span class="n">server_context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">server_options</span>

        <span class="c"># NOTE: we must enable &quot;ALL&quot; ciphers on the client, otherwise an</span>
        <span class="c"># SSLv23 client will send an SSLv3 hello (rather than SSLv2)</span>
        <span class="c"># starting from OpenSSL 1.0.0 (see issue #8322).</span>
        <span class="k">if</span> <span class="n">client_context</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">:</span>
            <span class="n">client_context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;ALL&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">certsreqs</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                               <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># Protocol mismatch can result in either an SSLError, or a</span>
        <span class="c"># &quot;Connection reset by peer&quot; error.</span>
        <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expect_success</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expect_success</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expect_success</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s">&quot;Client protocol </span><span class="si">%s</span><span class="s"> succeeded with server protocol </span><span class="si">%s</span><span class="s">!&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">get_protocol_name</span><span class="p">(</span><span class="n">client_protocol</span><span class="p">),</span>
                       <span class="n">ssl</span><span class="o">.</span><span class="n">get_protocol_name</span><span class="p">(</span><span class="n">server_protocol</span><span class="p">)))</span>

</div>
<div class="viewcode-block" id="ThreadedTests"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests">[docs]</a>    <span class="k">class</span> <span class="nc">ThreadedTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ThreadedTests.test_echo"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_echo">[docs]</a>        <span class="k">def</span> <span class="nf">test_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Basic test of an SSL client connecting to a server&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">PROTOCOLS</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">_PROTOCOL_NAMES</span><span class="p">[</span><span class="n">protocol</span><span class="p">]):</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
                    <span class="n">server_params_test</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_getpeercert"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_getpeercert">[docs]</a>        <span class="k">def</span> <span class="nf">test_getpeercert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                                        <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="c"># getpeercert() raise ValueError while the handshake isn&#39;t</span>
                <span class="c"># done.</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
                <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get peer certificate.&quot;</span><span class="p">)</span>
                <span class="n">cipher</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cipher</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Connection cipher is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;subject&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No subject field in certificate: </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span>
                              <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">cert</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(((</span><span class="s">&#39;organizationName&#39;</span><span class="p">,</span> <span class="s">&#39;Python Software Foundation&#39;</span><span class="p">),)</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                        <span class="s">&quot;Missing or invalid &#39;organizationName&#39; field in certificate subject; &quot;</span>
                        <span class="s">&quot;should be &#39;Python Software Foundation&#39;.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;notBefore&#39;</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;notAfter&#39;</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">cert_time_to_seconds</span><span class="p">(</span><span class="n">cert</span><span class="p">[</span><span class="s">&#39;notBefore&#39;</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">cert_time_to_seconds</span><span class="p">(</span><span class="n">cert</span><span class="p">[</span><span class="s">&#39;notAfter&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">have_verify_flags</span><span class="p">(),</span>
                            <span class="s">&quot;verify_flags need OpenSSL &gt; 0.9.8&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_crl_check"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_crl_check">[docs]</a>        <span class="k">def</span> <span class="nf">test_crl_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">SIGNED_CERTFILE</span><span class="p">)</span>

            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">SIGNING_CA</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">verify_flags</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_DEFAULT</span><span class="p">)</span>

            <span class="c"># VERIFY_DEFAULT should pass</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                    <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get peer certificate.&quot;</span><span class="p">)</span>

            <span class="c"># VERIFY_CRL_CHECK_LEAF without a loaded CRL file fails</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_flags</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">VERIFY_CRL_CHECK_LEAF</span>

            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span>
                                                <span class="s">&quot;certificate verify failed&quot;</span><span class="p">):</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

            <span class="c"># now load a CRL file. The CRL file is signed by the CA.</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CRLFILE</span><span class="p">)</span>

            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                    <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get peer certificate.&quot;</span><span class="p">)</span>
</div>
        <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ThreadedTests.test_check_hostname"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_check_hostname">[docs]</a>        <span class="k">def</span> <span class="nf">test_check_hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">SIGNED_CERTFILE</span><span class="p">)</span>

            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">SIGNING_CA</span><span class="p">)</span>

            <span class="c"># correct hostname should verify</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                                         <span class="n">server_hostname</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                    <span class="n">cert</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get peer certificate.&quot;</span><span class="p">)</span>

            <span class="c"># incorrect hostname should raise an exception</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                                         <span class="n">server_hostname</span><span class="o">=</span><span class="s">&quot;invalid&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">CertificateError</span><span class="p">,</span>
                                                <span class="s">&quot;hostname &#39;invalid&#39; doesn&#39;t match &#39;localhost&#39;&quot;</span><span class="p">):</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

            <span class="c"># missing server_hostname arg should cause an exception, too</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">server_context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span>
                                                <span class="s">&quot;check_hostname requires server_hostname&quot;</span><span class="p">):</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_empty_cert"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_empty_cert">[docs]</a>        <span class="k">def</span> <span class="nf">test_empty_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting with an empty cert file&quot;&quot;&quot;</span>
            <span class="n">bad_cert_test</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span>
                                      <span class="s">&quot;nullcert.pem&quot;</span><span class="p">))</span></div>
<div class="viewcode-block" id="ThreadedTests.test_malformed_cert"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_malformed_cert">[docs]</a>        <span class="k">def</span> <span class="nf">test_malformed_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting with a badly formatted certificate (syntax error)&quot;&quot;&quot;</span>
            <span class="n">bad_cert_test</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span>
                                       <span class="s">&quot;badcert.pem&quot;</span><span class="p">))</span></div>
<div class="viewcode-block" id="ThreadedTests.test_nonexisting_cert"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_nonexisting_cert">[docs]</a>        <span class="k">def</span> <span class="nf">test_nonexisting_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting with a non-existing cert file&quot;&quot;&quot;</span>
            <span class="n">bad_cert_test</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span>
                                       <span class="s">&quot;wrongcert.pem&quot;</span><span class="p">))</span></div>
<div class="viewcode-block" id="ThreadedTests.test_malformed_key"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_malformed_key">[docs]</a>        <span class="k">def</span> <span class="nf">test_malformed_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting with a badly formatted key (syntax error)&quot;&quot;&quot;</span>
            <span class="n">bad_cert_test</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span>
                                       <span class="s">&quot;badkey.pem&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_rude_shutdown"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_rude_shutdown">[docs]</a>        <span class="k">def</span> <span class="nf">test_rude_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;A brutal shutdown of an SSL server should raise an OSError</span>
<span class="sd">            in the client when attempting handshake.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">listener_ready</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">listener_gone</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HOST</span><span class="p">)</span>

            <span class="c"># `listener` runs in a thread.  It sits in an accept() until</span>
            <span class="c"># the main thread connects.  Then it rudely closes the socket,</span>
            <span class="c"># and sets Event `listener_gone` to let the main thread know</span>
            <span class="c"># the socket is gone.</span>
            <span class="k">def</span> <span class="nf">listener</span><span class="p">():</span>
                <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">listener_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">newsock</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                <span class="n">newsock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">listener_gone</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">connector</span><span class="p">():</span>
                <span class="n">listener_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                    <span class="n">listener_gone</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ssl_sock</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;connecting to closed SSL socket should have failed&#39;</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connector</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</div>
        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">),</span>
                             <span class="s">&quot;OpenSSL is compiled without SSLv2 support&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_protocol_sslv2"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_protocol_sslv2">[docs]</a>        <span class="k">def</span> <span class="nf">test_protocol_sslv2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting to an SSLv2 server with various client options&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="c"># SSLv23 client with specific SSL options</span>
            <span class="k">if</span> <span class="n">no_sslv2_implies_sslv3_hello</span><span class="p">():</span>
                <span class="c"># No SSLv2 =&gt; client will use an SSLv3 hello on recent OpenSSLs</span>
                <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                                   <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1</span><span class="p">)</span>
</div>
        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ThreadedTests.test_protocol_sslv23"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_protocol_sslv23">[docs]</a>        <span class="k">def</span> <span class="nf">test_protocol_sslv23</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting to an SSLv23 server with various client options&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
                    <span class="c"># this fails on some older versions of OpenSSL (0.9.7l, for instance)</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s">&quot; SSL2 client to SSL23 server test unexpectedly failed:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>

            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>

            <span class="c"># Server with specific SSL options</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">server_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="p">)</span>
            <span class="c"># Will choose TLSv1</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                               <span class="n">server_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span> <span class="o">|</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">server_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1</span><span class="p">)</span>

</div>
        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ThreadedTests.test_protocol_sslv3"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_protocol_sslv3">[docs]</a>        <span class="k">def</span> <span class="nf">test_protocol_sslv3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting to an SSLv3 server with various client options&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">):</span>
                <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_sslv2_implies_sslv3_hello</span><span class="p">():</span>
                <span class="c"># No SSLv2 =&gt; client will use an SSLv3 hello on recent OpenSSLs</span>
                <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                                   <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">)</span>
</div>
        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
<div class="viewcode-block" id="ThreadedTests.test_protocol_tlsv1"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_protocol_tlsv1">[docs]</a>        <span class="k">def</span> <span class="nf">test_protocol_tlsv1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting to a TLSv1 server with various client options&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">):</span>
                <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1</span><span class="p">)</span>
</div>
        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;PROTOCOL_TLSv1_1&quot;</span><span class="p">),</span>
                             <span class="s">&quot;TLS version 1.1 not supported.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_protocol_tlsv1_1"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_protocol_tlsv1_1">[docs]</a>        <span class="k">def</span> <span class="nf">test_protocol_tlsv1_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting to a TLSv1.1 server with various client options.</span>
<span class="sd">               Testing against older TLS versions.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">):</span>
                <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1_1</span><span class="p">)</span>

            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

</div>
        <span class="nd">@skip_if_broken_ubuntu_ssl</span>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&quot;PROTOCOL_TLSv1_2&quot;</span><span class="p">),</span>
                             <span class="s">&quot;TLS version 1.2 not supported.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_protocol_tlsv1_2"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_protocol_tlsv1_2">[docs]</a>        <span class="k">def</span> <span class="nf">test_protocol_tlsv1_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Connecting to a TLSv1.2 server with various client options.</span>
<span class="sd">               Testing against older TLS versions.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                               <span class="n">server_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="o">|</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv3</span><span class="o">|</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_SSLv2</span><span class="p">,)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;PROTOCOL_SSLv2&#39;</span><span class="p">):</span>
                <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv2</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv3</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                               <span class="n">client_options</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1_2</span><span class="p">)</span>

            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">try_protocol_combo</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_1</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1_2</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_starttls"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_starttls">[docs]</a>        <span class="k">def</span> <span class="nf">test_starttls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Switching from clear text to encrypted and back again.&quot;&quot;&quot;</span>
            <span class="n">msgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="s">&quot;msg 1&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;MSG 2&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;STARTTLS&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;MSG 3&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;msg 4&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;ENDTLS&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;msg 5&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;msg 6&quot;</span><span class="p">)</span>

            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span>
                                        <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span>
                                        <span class="n">starttls_server</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">indata</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s">&quot; client:  sending </span><span class="si">%r</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">indata</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">wrapped</span><span class="p">:</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
                        <span class="n">outdata</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
                        <span class="n">outdata</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">outdata</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">indata</span> <span class="o">==</span> <span class="n">b</span><span class="s">&quot;STARTTLS&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ok&quot;</span><span class="p">):</span>
                        <span class="c"># STARTTLS ok, switch to secure mode</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s">&quot; client:  read </span><span class="si">%r</span><span class="s"> from server, starting TLS...</span><span class="se">\n</span><span class="s">&quot;</span>
                                <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="n">conn</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">elif</span> <span class="n">indata</span> <span class="o">==</span> <span class="n">b</span><span class="s">&quot;ENDTLS&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ok&quot;</span><span class="p">):</span>
                        <span class="c"># ENDTLS ok, switch back to clear text</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s">&quot; client:  read </span><span class="si">%r</span><span class="s"> from server, ending TLS...</span><span class="se">\n</span><span class="s">&quot;</span>
                                <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
                        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s">&quot; client:  read </span><span class="si">%r</span><span class="s"> from server</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client:  closing connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wrapped</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wrapped</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_socketserver"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_socketserver">[docs]</a>        <span class="k">def</span> <span class="nf">test_socketserver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Using a SocketServer to create and manage SSL connections.&quot;&quot;&quot;</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">make_https_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="c"># try to connect</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># now fetch the same data from the HTTPS server</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dlen</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-length&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlen</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dlen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dlen</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s">&quot; client: read </span><span class="si">%d</span><span class="s"> bytes from remote server &#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d2</span><span class="p">),</span> <span class="n">server</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_asyncore_server"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_asyncore_server">[docs]</a>        <span class="k">def</span> <span class="nf">test_asyncore_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Check the example asyncore integration.&quot;&quot;&quot;</span>
            <span class="n">indata</span> <span class="o">=</span> <span class="s">&quot;TEST MESSAGE of mixed case</span><span class="se">\n</span><span class="s">&quot;</span>

            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="n">indata</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;FOO</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">AsyncoreEchoServer</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s">&quot; client:  sending </span><span class="si">%r</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">indata</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
                <span class="n">outdata</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client:  read </span><span class="si">%r</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outdata</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">outdata</span> <span class="o">!=</span> <span class="n">indata</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                        <span class="s">&quot;bad data &lt;&lt;</span><span class="si">%r</span><span class="s">&gt;&gt; (</span><span class="si">%d</span><span class="s">) received; expected &lt;&lt;</span><span class="si">%r</span><span class="s">&gt;&gt; (</span><span class="si">%d</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">outdata</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">outdata</span><span class="p">),</span>
                           <span class="n">indata</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">indata</span><span class="p">)))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client:  closing connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; client:  connection closed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_recv_send"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_recv_send">[docs]</a>        <span class="k">def</span> <span class="nf">test_recv_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Test recv(), send() and friends.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span>
                                        <span class="n">certreqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
                                        <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span>
                                        <span class="n">cacerts</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                        <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                                    <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                    <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">ca_certs</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
                                    <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="c"># helper methods for standardising recv* method signatures</span>
                <span class="k">def</span> <span class="nf">_recv_into</span><span class="p">():</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">b</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>

                <span class="k">def</span> <span class="nf">_recvfrom_into</span><span class="p">():</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">count</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">b</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>

                <span class="c"># (name, method, whether to expect success, *args)</span>
                <span class="n">send_methods</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s">&#39;send&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">(</span><span class="s">&#39;sendto&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;some.address&quot;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s">&#39;sendall&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="p">]</span>
                <span class="n">recv_methods</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s">&#39;recv&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">(</span><span class="s">&#39;recvfrom&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;some.address&quot;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s">&#39;recv_into&#39;</span><span class="p">,</span> <span class="n">_recv_into</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">(</span><span class="s">&#39;recvfrom_into&#39;</span><span class="p">,</span> <span class="n">_recvfrom_into</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="p">]</span>
                <span class="n">data_prefix</span> <span class="o">=</span> <span class="s">&quot;PREFIX_&quot;</span>

                <span class="k">for</span> <span class="n">meth_name</span><span class="p">,</span> <span class="n">send_meth</span><span class="p">,</span> <span class="n">expect_success</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">send_methods</span><span class="p">:</span>
                    <span class="n">indata</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_prefix</span> <span class="o">+</span> <span class="n">meth_name</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">send_meth</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">outdata</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">outdata</span> <span class="o">!=</span> <span class="n">indata</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                                <span class="s">&quot;While sending with &lt;&lt;{name:s}&gt;&gt; bad data &quot;</span>
                                <span class="s">&quot;&lt;&lt;{outdata:r}&gt;&gt; ({nout:d}) received; &quot;</span>
                                <span class="s">&quot;expected &lt;&lt;{indata:r}&gt;&gt; ({nin:d})</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">meth_name</span><span class="p">,</span> <span class="n">outdata</span><span class="o">=</span><span class="n">outdata</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span>
                                    <span class="n">nout</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">outdata</span><span class="p">),</span>
                                    <span class="n">indata</span><span class="o">=</span><span class="n">indata</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="n">nin</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">expect_success</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                                <span class="s">&quot;Failed to send with method &lt;&lt;{name:s}&gt;&gt;; &quot;</span>
                                <span class="s">&quot;expected to succeed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">meth_name</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">meth_name</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                                <span class="s">&quot;Method &lt;&lt;{name:s}&gt;&gt; failed with unexpected &quot;</span>
                                <span class="s">&quot;exception message: {exp:s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">meth_name</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">e</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                <span class="k">for</span> <span class="n">meth_name</span><span class="p">,</span> <span class="n">recv_meth</span><span class="p">,</span> <span class="n">expect_success</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">recv_methods</span><span class="p">:</span>
                    <span class="n">indata</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_prefix</span> <span class="o">+</span> <span class="n">meth_name</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
                        <span class="n">outdata</span> <span class="o">=</span> <span class="n">recv_meth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">outdata</span> <span class="o">!=</span> <span class="n">indata</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                                <span class="s">&quot;While receiving with &lt;&lt;{name:s}&gt;&gt; bad data &quot;</span>
                                <span class="s">&quot;&lt;&lt;{outdata:r}&gt;&gt; ({nout:d}) received; &quot;</span>
                                <span class="s">&quot;expected &lt;&lt;{indata:r}&gt;&gt; ({nin:d})</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">meth_name</span><span class="p">,</span> <span class="n">outdata</span><span class="o">=</span><span class="n">outdata</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span>
                                    <span class="n">nout</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">outdata</span><span class="p">),</span>
                                    <span class="n">indata</span><span class="o">=</span><span class="n">indata</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="n">nin</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">expect_success</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                                <span class="s">&quot;Failed to receive with method &lt;&lt;{name:s}&gt;&gt;; &quot;</span>
                                <span class="s">&quot;expected to succeed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">meth_name</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">meth_name</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                                <span class="s">&quot;Method &lt;&lt;{name:s}&gt;&gt; failed with unexpected &quot;</span>
                                <span class="s">&quot;exception message: {exp:s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">meth_name</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">e</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c"># consume data</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="c"># Make sure sendmsg et al are disallowed to avoid</span>
                <span class="c"># inadvertent disclosure of data and/or corruption</span>
                <span class="c"># of the encrypted data stream</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;data&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span>
                                  <span class="n">s</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_handshake_timeout"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_handshake_timeout">[docs]</a>        <span class="k">def</span> <span class="nf">test_handshake_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Issue #5103: SSL handshake must respect the socket timeout</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
            <span class="n">started</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">finish</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
                <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">started</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">conns</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">finish</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">server</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                        <span class="c"># Let the socket hang around rather than having</span>
                        <span class="c"># it closed by garbage collection.</span>
                        <span class="n">conns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">accept</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">serve</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">started</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                    <span class="c"># Will attempt handshake and time out</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="s">&quot;timed out&quot;</span><span class="p">,</span>
                                           <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="c"># Will attempt handshake and time out</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="s">&quot;timed out&quot;</span><span class="p">,</span>
                                           <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">finish</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_server_accept"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_server_accept">[docs]</a>        <span class="k">def</span> <span class="nf">test_server_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Issue #16357: accept() on a SSLSocket created through</span>
            <span class="c"># SSLContext.wrap_socket().</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">evt</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">remote</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">peer</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">def</span> <span class="nf">serve</span><span class="p">():</span>
                <span class="n">nonlocal</span> <span class="n">remote</span><span class="p">,</span> <span class="n">peer</span>
                <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="c"># Block on the accept and wait on the connection to close.</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">remote</span><span class="p">,</span> <span class="n">peer</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                <span class="n">remote</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">serve</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c"># Client wait until server setup and perform a connect.</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span>
            <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="n">client_addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># Sanity checks.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLSocket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_getpeercert_enotconn"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_getpeercert_enotconn">[docs]</a>        <span class="k">def</span> <span class="nf">test_getpeercert_enotconn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTCONN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_do_handshake_enotconn"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_do_handshake_enotconn">[docs]</a>        <span class="k">def</span> <span class="nf">test_do_handshake_enotconn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTCONN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_default_ciphers"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_default_ciphers">[docs]</a>        <span class="k">def</span> <span class="nf">test_default_ciphers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># Force a set of weak ciphers on our client context</span>
                <span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;DES&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;no DES cipher available&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">,</span>
                                    <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;no shared cipher&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">conn_errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</div>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">HAS_ECDH</span><span class="p">,</span> <span class="s">&quot;test requires ECDH-enabled OpenSSL&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_default_ecdh_curve"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_default_ecdh_curve">[docs]</a>        <span class="k">def</span> <span class="nf">test_default_ecdh_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Issue #21015: elliptic curve-based Diffie Hellman key exchange</span>
            <span class="c"># should be enabled by default on SSL contexts.</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="c"># Prior to OpenSSL 1.0.0, ECDH ciphers have to be enabled</span>
            <span class="c"># explicitly using the &#39;ECCdraft&#39; cipher alias.  Otherwise,</span>
            <span class="c"># our default cipher list should prefer ECDH-based ciphers</span>
            <span class="c"># automatically.</span>
            <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;ECCdraft:ECDH&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span> <span class="k">as</span> <span class="n">server</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;ECDH&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">cipher</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</div>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span> <span class="ow">in</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CHANNEL_BINDING_TYPES</span><span class="p">,</span>
                             <span class="s">&quot;&#39;tls-unique&#39; channel binding not available&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_tls_unique_channel_binding"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_tls_unique_channel_binding">[docs]</a>        <span class="k">def</span> <span class="nf">test_tls_unique_channel_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Test tls-unique channel binding.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">,</span>
                                        <span class="n">certreqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
                                        <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">,</span>
                                        <span class="n">cacerts</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                        <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                                    <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                    <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">ca_certs</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
                                    <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="c"># get the data</span>
                <span class="n">cb_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_channel_binding</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; got channel binding data: {0!r}</span><span class="se">\n</span><span class="s">&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cb_data</span><span class="p">))</span>

                <span class="c"># check if it is sane</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">cb_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cb_data</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span> <span class="c"># True for TLSv1</span>

                <span class="c"># and compare with the peers version</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;CB tls-unique</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">peer_data_repr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">peer_data_repr</span><span class="p">,</span>
                                 <span class="nb">repr</span><span class="p">(</span><span class="n">cb_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;us-ascii&quot;</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c"># now, again</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(),</span>
                                    <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                    <span class="n">certfile</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">ca_certs</span><span class="o">=</span><span class="n">CERTFILE</span><span class="p">,</span>
                                    <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
                                    <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="n">new_cb_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_channel_binding</span><span class="p">(</span><span class="s">&quot;tls-unique&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; got another channel binding data: {0!r}</span><span class="se">\n</span><span class="s">&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_cb_data</span><span class="p">))</span>
                <span class="c"># is it really unique</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">cb_data</span><span class="p">,</span> <span class="n">new_cb_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">cb_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cb_data</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span> <span class="c"># True for TLSv1</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;CB tls-unique</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">peer_data_repr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">peer_data_repr</span><span class="p">,</span>
                                 <span class="nb">repr</span><span class="p">(</span><span class="n">new_cb_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;us-ascii&quot;</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_compression"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_compression">[docs]</a>        <span class="k">def</span> <span class="nf">test_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; got compression: {!r}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;compression&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;compression&#39;</span><span class="p">],</span> <span class="p">{</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;ZLIB&#39;</span><span class="p">,</span> <span class="s">&#39;RLE&#39;</span> <span class="p">})</span>
</div>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s">&#39;OP_NO_COMPRESSION&#39;</span><span class="p">),</span>
                             <span class="s">&quot;ssl.OP_NO_COMPRESSION needed for this test&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_compression_disabled"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_compression_disabled">[docs]</a>        <span class="k">def</span> <span class="nf">test_compression_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;compression&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_dh_params"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_dh_params">[docs]</a>        <span class="k">def</span> <span class="nf">test_dh_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Check we can get a connection with ephemeral Diffie-Hellman</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_dh_params</span><span class="p">(</span><span class="n">DHFILE</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="s">&quot;kEDH&quot;</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">cipher</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&quot;cipher&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&quot;ADH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parts</span> <span class="ow">and</span> <span class="s">&quot;EDH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parts</span> <span class="ow">and</span> <span class="s">&quot;DHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Non-DH cipher: &quot;</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_selected_npn_protocol"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_selected_npn_protocol">[docs]</a>        <span class="k">def</span> <span class="nf">test_selected_npn_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># selected_npn_protocol() is None unless NPN is used</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;client_npn_protocol&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
</div>
        <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">HAS_NPN</span><span class="p">,</span> <span class="s">&quot;NPN support needed for this test&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ThreadedTests.test_npn_protocols"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_npn_protocols">[docs]</a>        <span class="k">def</span> <span class="nf">test_npn_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">server_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;http/1.1&#39;</span><span class="p">,</span> <span class="s">&#39;spdy/2&#39;</span><span class="p">]</span>
            <span class="n">protocol_tests</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">([</span><span class="s">&#39;http/1.1&#39;</span><span class="p">,</span> <span class="s">&#39;spdy/2&#39;</span><span class="p">],</span> <span class="s">&#39;http/1.1&#39;</span><span class="p">),</span>
                <span class="p">([</span><span class="s">&#39;spdy/2&#39;</span><span class="p">,</span> <span class="s">&#39;http/1.1&#39;</span><span class="p">],</span> <span class="s">&#39;http/1.1&#39;</span><span class="p">),</span>
                <span class="p">([</span><span class="s">&#39;spdy/2&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">],</span> <span class="s">&#39;spdy/2&#39;</span><span class="p">),</span>
                <span class="p">([</span><span class="s">&#39;abc&#39;</span><span class="p">,</span> <span class="s">&#39;def&#39;</span><span class="p">],</span> <span class="s">&#39;abc&#39;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">client_protocols</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">protocol_tests</span><span class="p">:</span>
                <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                <span class="n">server_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
                <span class="n">server_context</span><span class="o">.</span><span class="n">set_npn_protocols</span><span class="p">(</span><span class="n">server_protocols</span><span class="p">)</span>
                <span class="n">client_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
                <span class="n">client_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
                <span class="n">client_context</span><span class="o">.</span><span class="n">set_npn_protocols</span><span class="p">(</span><span class="n">client_protocols</span><span class="p">)</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                           <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connectionchatty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;failed trying </span><span class="si">%s</span><span class="s"> (s) and </span><span class="si">%s</span><span class="s"> (c).</span><span class="se">\n</span><span class="s">&quot;</span> \
                      <span class="s">&quot;was expecting </span><span class="si">%s</span><span class="s">, but got </span><span class="si">%%</span><span class="s">s from the </span><span class="si">%%</span><span class="s">s&quot;</span> \
                          <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">server_protocols</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_protocols</span><span class="p">),</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>
                <span class="n">client_result</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;client_npn_protocol&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">client_result</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_result</span><span class="p">,</span> <span class="s">&quot;client&quot;</span><span class="p">))</span>
                <span class="n">server_result</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;server_npn_protocols&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;server_npn_protocols&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s">&#39;nothing&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">server_result</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">server_result</span><span class="p">,</span> <span class="s">&quot;server&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ThreadedTests.sni_contexts"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.sni_contexts">[docs]</a>        <span class="k">def</span> <span class="nf">sni_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">SIGNED_CERTFILE</span><span class="p">)</span>
            <span class="n">other_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">other_context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">SIGNED_CERTFILE2</span><span class="p">)</span>
            <span class="n">client_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span><span class="p">)</span>
            <span class="n">client_context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">client_context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">SIGNING_CA</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">server_context</span><span class="p">,</span> <span class="n">other_context</span><span class="p">,</span> <span class="n">client_context</span>
</div>
<div class="viewcode-block" id="ThreadedTests.check_common_name"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.check_common_name">[docs]</a>        <span class="k">def</span> <span class="nf">check_common_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">cert</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;peercert&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(((</span><span class="s">&#39;commonName&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">),),</span> <span class="n">cert</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">])</span>
</div>
        <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ThreadedTests.test_sni_callback"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_sni_callback">[docs]</a>        <span class="k">def</span> <span class="nf">test_sni_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">server_context</span><span class="p">,</span> <span class="n">other_context</span><span class="p">,</span> <span class="n">client_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sni_contexts</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">servername_cb</span><span class="p">(</span><span class="n">ssl_sock</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">initial_context</span><span class="p">):</span>
                <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">server_name</span><span class="p">,</span> <span class="n">initial_context</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">server_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">ssl_sock</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">other_context</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="n">servername_cb</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                       <span class="n">sni_name</span><span class="o">=</span><span class="s">&#39;supermessage&#39;</span><span class="p">)</span>
            <span class="c"># The hostname was fetched properly, and the certificate was</span>
            <span class="c"># changed for the connection.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[(</span><span class="s">&quot;supermessage&quot;</span><span class="p">,</span> <span class="n">server_context</span><span class="p">)])</span>
            <span class="c"># CERTFILE4 was selected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_common_name</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="s">&#39;fakehostname&#39;</span><span class="p">)</span>

            <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># The callback is called with server_name=None</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                       <span class="n">sni_name</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[(</span><span class="bp">None</span><span class="p">,</span> <span class="n">server_context</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_common_name</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">)</span>

            <span class="c"># Check disabling the callback</span>
            <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                       <span class="n">chatty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                       <span class="n">sni_name</span><span class="o">=</span><span class="s">&#39;notfunny&#39;</span><span class="p">)</span>
            <span class="c"># Certificate didn&#39;t change</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_common_name</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">,</span> <span class="p">[])</span>
</div>
        <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ThreadedTests.test_sni_callback_alert"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_sni_callback_alert">[docs]</a>        <span class="k">def</span> <span class="nf">test_sni_callback_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Returning a TLS alert is reflected to the connecting client</span>
            <span class="n">server_context</span><span class="p">,</span> <span class="n">other_context</span><span class="p">,</span> <span class="n">client_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sni_contexts</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">cb_returning_alert</span><span class="p">(</span><span class="n">ssl_sock</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">initial_context</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ssl</span><span class="o">.</span><span class="n">ALERT_DESCRIPTION_ACCESS_DENIED</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="n">cb_returning_alert</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                           <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">sni_name</span><span class="o">=</span><span class="s">&#39;supermessage&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="s">&#39;TLSV1_ALERT_ACCESS_DENIED&#39;</span><span class="p">)</span>
</div>
        <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ThreadedTests.test_sni_callback_raising"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_sni_callback_raising">[docs]</a>        <span class="k">def</span> <span class="nf">test_sni_callback_raising</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Raising fails the connection with a TLS handshake failure alert.</span>
            <span class="n">server_context</span><span class="p">,</span> <span class="n">other_context</span><span class="p">,</span> <span class="n">client_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sni_contexts</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">cb_raising</span><span class="p">(</span><span class="n">ssl_sock</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">initial_context</span><span class="p">):</span>
                <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="n">cb_raising</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">,</span> \
                 <span class="n">support</span><span class="o">.</span><span class="n">captured_stderr</span><span class="p">()</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                           <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">sni_name</span><span class="o">=</span><span class="s">&#39;supermessage&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="s">&#39;SSLV3_ALERT_HANDSHAKE_FAILURE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;ZeroDivisionError&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</div>
        <span class="nd">@needs_sni</span>
<div class="viewcode-block" id="ThreadedTests.test_sni_callback_wrong_return_type"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_sni_callback_wrong_return_type">[docs]</a>        <span class="k">def</span> <span class="nf">test_sni_callback_wrong_return_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># Returning the wrong return type terminates the TLS connection</span>
            <span class="c"># with an internal error alert.</span>
            <span class="n">server_context</span><span class="p">,</span> <span class="n">other_context</span><span class="p">,</span> <span class="n">client_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sni_contexts</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">cb_wrong_return_type</span><span class="p">(</span><span class="n">ssl_sock</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">initial_context</span><span class="p">):</span>
                <span class="k">return</span> <span class="s">&quot;foo&quot;</span>
            <span class="n">server_context</span><span class="o">.</span><span class="n">set_servername_callback</span><span class="p">(</span><span class="n">cb_wrong_return_type</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">,</span> \
                 <span class="n">support</span><span class="o">.</span><span class="n">captured_stderr</span><span class="p">()</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">server_params_test</span><span class="p">(</span><span class="n">client_context</span><span class="p">,</span> <span class="n">server_context</span><span class="p">,</span>
                                           <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">sni_name</span><span class="o">=</span><span class="s">&#39;supermessage&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="s">&#39;TLSV1_ALERT_INTERNAL_ERROR&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;TypeError&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="ThreadedTests.test_read_write_after_close_raises_valuerror"><a class="viewcode-back" href="../../test.html#test.test_ssl.ThreadedTests.test_read_write_after_close_raises_valuerror">[docs]</a>        <span class="k">def</span> <span class="nf">test_read_write_after_close_raises_valuerror</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">CERTFILE</span><span class="p">)</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedEchoServer</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">())</span>
                <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_ssl.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">plats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;Linux&#39;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">,</span>
            <span class="s">&#39;Mac&#39;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">mac_ver</span><span class="p">,</span>
            <span class="s">&#39;Windows&#39;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">win32_ver</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">plats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plat</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">plat</span> <span class="ow">and</span> <span class="n">plat</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">plat</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">plat</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plat</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;test_ssl: testing with </span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OPENSSL_VERSION_INFO</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;          under </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">plat</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;          HAS_SNI = </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;          OP_ALL = 0x</span><span class="si">%8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_ALL</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;          OP_NO_TLSv1_1 = 0x</span><span class="si">%8x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_TLSv1_1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">CERTFILE</span><span class="p">,</span> <span class="n">SVN_PYTHON_ORG_ROOT_CERT</span><span class="p">,</span> <span class="n">BYTES_CERTFILE</span><span class="p">,</span>
        <span class="n">ONLYCERT</span><span class="p">,</span> <span class="n">ONLYKEY</span><span class="p">,</span> <span class="n">BYTES_ONLYCERT</span><span class="p">,</span> <span class="n">BYTES_ONLYKEY</span><span class="p">,</span>
        <span class="n">SIGNED_CERTFILE</span><span class="p">,</span> <span class="n">SIGNED_CERTFILE2</span><span class="p">,</span> <span class="n">SIGNING_CA</span><span class="p">,</span>
        <span class="n">BADCERT</span><span class="p">,</span> <span class="n">BADKEY</span><span class="p">,</span> <span class="n">EMPTYCERT</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">support</span><span class="o">.</span><span class="n">TestFailed</span><span class="p">(</span><span class="s">&quot;Can&#39;t read certificate file </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">ContextTests</span><span class="p">,</span> <span class="n">BasicSocketTests</span><span class="p">,</span> <span class="n">SSLErrorTests</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">is_resource_enabled</span><span class="p">(</span><span class="s">&#39;network&#39;</span><span class="p">):</span>
        <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NetworkedTests</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_have_threads</span><span class="p">:</span>
        <span class="n">thread_info</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">threading_setup</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">thread_info</span><span class="p">:</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ThreadedTests</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">tests</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_have_threads</span><span class="p">:</span>
            <span class="n">support</span><span class="o">.</span><span class="n">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">thread_info</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>