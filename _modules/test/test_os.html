

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_os &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_os</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_os</h1><div class="highlight"><pre>
<span class="c"># As a test suite for the os module, this is woefully inadequate, but this</span>
<span class="c"># does add tests for a few functions which have been determined to be more</span>
<span class="c"># portable than they had been thought to be.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">mmap</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">asynchat</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">fractions</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">resource</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">from</span> <span class="nn">test.script_helper</span> <span class="kn">import</span> <span class="n">assert_python_ok</span>

<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">stat_float_times</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
<span class="n">stat_supports_subsecond</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c"># check if float and int timestamps are different</span>
    <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_atime</span> <span class="o">!=</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
    <span class="ow">or</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">!=</span> <span class="n">st</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
    <span class="ow">or</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_ctime</span> <span class="o">!=</span> <span class="n">st</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>

<span class="c"># Detect whether we&#39;re on a Linux system that uses the (now outdated</span>
<span class="c"># and unmaintained) linuxthreads threading library.  There&#39;s an issue</span>
<span class="c"># when combining linuxthreads with a failed execv call: see</span>
<span class="c"># http://bugs.python.org/issue4970.</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&#39;thread_info&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">thread_info</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
    <span class="n">USING_LINUXTHREADS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">thread_info</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;linuxthreads&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">USING_LINUXTHREADS</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># Issue #14110: Some tests fail on FreeBSD if the user is in the wheel group.</span>
<span class="n">HAVE_WHEEL_GROUP</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;freebsd&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c"># Tests creating TESTFN</span>
<div class="viewcode-block" id="FileTests"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests">[docs]</a><span class="k">class</span> <span class="nc">FileTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="FileTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span></div>
    <span class="n">tearDown</span> <span class="o">=</span> <span class="n">setUp</span>

<div class="viewcode-block" id="FileTests.test_access"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_access">[docs]</a>    <span class="k">def</span> <span class="nf">test_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="FileTests.test_closerange"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_closerange">[docs]</a>    <span class="k">def</span> <span class="nf">test_closerange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
        <span class="c"># We must allocate two consecutive file descriptors, otherwise</span>
        <span class="c"># it will mess up other file descriptors (perhaps even the three</span>
        <span class="c"># standard ones).</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">second</span> <span class="o">!=</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="c"># XXX test skipped</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;couldn&#39;t allocate two consecutive fds&quot;</span><span class="p">)</span>
                <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">second</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="c"># close a fd that is open, and one that isn&#39;t</span>
        <span class="n">os</span><span class="o">.</span><span class="n">closerange</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">first</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="FileTests.test_rename"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_rename">[docs]</a>    <span class="k">def</span> <span class="nf">test_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileTests.test_read"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="n">fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;spam&quot;</span><span class="p">)</span>
            <span class="n">fobj</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;spam&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileTests.test_write"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># os.write() accepts bytes- and buffer-like objects but not strings</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="s">&quot;beans&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;bacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;eggs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">memoryview</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;spam</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                <span class="p">[</span><span class="n">b</span><span class="s">&quot;bacon&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;eggs&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;spam&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="FileTests.write_windows_console"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.write_windows_console">[docs]</a>    <span class="k">def</span> <span class="nf">write_windows_console</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">retcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
            <span class="c"># use a new console to not flood the test output</span>
            <span class="n">creationflags</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span>
            <span class="c"># use a shell to hide the console window (SW_HIDE)</span>
            <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">,</span>
                         <span class="s">&#39;test specific to the Windows console&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="FileTests.test_write_windows_console"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_write_windows_console">[docs]</a>    <span class="k">def</span> <span class="nf">test_write_windows_console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #11395: the Windows console returns an error (12: not enough</span>
        <span class="c"># space error) on writing into stdout if stdout mode is binary and the</span>
        <span class="c"># length is greater than 66,000 bytes (or less, depending on heap</span>
        <span class="c"># usage).</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;print(&#39;x&#39; * 100000)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_windows_console</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_windows_console</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-u&quot;</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileTests.fdopen_helper"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.fdopen_helper">[docs]</a>    <span class="k">def</span> <span class="nf">fdopen_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="FileTests.test_fdopen"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_fdopen">[docs]</a>    <span class="k">def</span> <span class="nf">test_fdopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fdopen_helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdopen_helper</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdopen_helper</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileTests.test_replace"><a class="viewcode-back" href="../../test.html#test.test_os.FileTests.test_replace">[docs]</a>    <span class="k">def</span> <span class="nf">test_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">TESTFN2</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&quot;.2&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN2</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">TESTFN2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">TESTFN2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN2</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;1&quot;</span><span class="p">)</span>


<span class="c"># Test attributes on return values from os.*stat* family.</span></div></div>
<div class="viewcode-block" id="StatAttributeTests"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests">[docs]</a><span class="k">class</span> <span class="nc">StatAttributeTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="StatAttributeTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;f1&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;ABC&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="StatAttributeTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;stat&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.stat()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.check_stat_attributes"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.check_stat_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">check_stat_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="c"># Make sure direct access works</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_SIZE</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c"># Make sure all the attributes are there</span>
        <span class="n">members</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">stat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ST_&#39;</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;TIME&quot;</span><span class="p">):</span>
                    <span class="k">def</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">trunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">trunc</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">attr</span><span class="p">)),</span>
                                  <span class="n">result</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">name</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">members</span><span class="p">)</span>

        <span class="c"># Make sure that the st_?time and st_?time_ns fields roughly agree</span>
        <span class="c"># (they should always agree up to around tens-of-microseconds)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s">&#39;st_atime st_mtime st_ctime&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">floaty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">)</span>
            <span class="n">nanosecondy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_ns&quot;</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">floaty</span><span class="p">,</span> <span class="n">nanosecondy</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Make sure that assignment fails</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">st_rdev</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">parrot</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Use the stat_result constructor with a too-short tuple.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat_result</span><span class="p">((</span><span class="mi">10</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Use the constructor with a too-long tuple.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat_result</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="StatAttributeTests.test_stat_attributes"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_stat_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_stat_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_stat_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="StatAttributeTests.test_stat_attributes_bytes"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_stat_attributes_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">test_stat_attributes_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;cannot encode %a for the filesystem&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_stat_attributes</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="StatAttributeTests.test_stat_result_pickle"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_stat_result_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">test_stat_result_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x03</span><span class="s">cos</span><span class="se">\n</span><span class="s">stat_result</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">unpickled</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">unpickled</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;statvfs&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.statvfs()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.test_statvfs_attributes"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_statvfs_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_statvfs_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># On AtheOS, glibc always returns ENOSYS</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSYS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;os.statvfs() failed with ENOSYS&#39;</span><span class="p">)</span>

        <span class="c"># Make sure direct access works</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">f_bfree</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="c"># Make sure all the attributes are there.</span>
        <span class="n">members</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;bsize&#39;</span><span class="p">,</span> <span class="s">&#39;frsize&#39;</span><span class="p">,</span> <span class="s">&#39;blocks&#39;</span><span class="p">,</span> <span class="s">&#39;bfree&#39;</span><span class="p">,</span> <span class="s">&#39;bavail&#39;</span><span class="p">,</span> <span class="s">&#39;files&#39;</span><span class="p">,</span>
                    <span class="s">&#39;ffree&#39;</span><span class="p">,</span> <span class="s">&#39;favail&#39;</span><span class="p">,</span> <span class="s">&#39;flag&#39;</span><span class="p">,</span> <span class="s">&#39;namemax&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">members</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;f_&#39;</span> <span class="o">+</span> <span class="n">member</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>

        <span class="c"># Make sure that assignment really fails</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">parrot</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Use the constructor with a too-short tuple.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs_result</span><span class="p">((</span><span class="mi">10</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception raised&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Use the constructor with a too-long tuple.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs_result</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;statvfs&#39;</span><span class="p">),</span>
                         <span class="s">&quot;need os.statvfs()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.test_statvfs_result_pickle"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_statvfs_result_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">test_statvfs_result_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># On AtheOS, glibc always returns ENOSYS</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOSYS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;os.statvfs() failed with ENOSYS&#39;</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x03</span><span class="s">cos</span><span class="se">\n</span><span class="s">statvfs_result</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">unpickled</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">unpickled</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="StatAttributeTests.test_utime_dir"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_utime_dir">[docs]</a>    <span class="k">def</span> <span class="nf">test_utime_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="c"># round to int, because some systems may support sub-second</span>
        <span class="c"># time stamps in stat, but not in utime.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_atime</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="o">-</span><span class="n">delta</span><span class="p">)))</span>
        <span class="n">st2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">st2</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="o">-</span><span class="n">delta</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_test_utime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">utime</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="c"># Issue #13327 removed the requirement to pass None as the</span>
        <span class="c"># second argument. Check that the previous methods of passing</span>
        <span class="c"># a time tuple or None work in addition to no argument.</span>
        <span class="n">st0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c"># Doesn&#39;t set anything new, but sets the time tuple way</span>
        <span class="n">utime</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span> <span class="s">&quot;st_atime&quot;</span><span class="p">),</span> <span class="n">attr</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span> <span class="s">&quot;st_mtime&quot;</span><span class="p">)))</span>
        <span class="c"># Setting the time to the time you just read, then reading again,</span>
        <span class="c"># should always return exactly the same times.</span>
        <span class="n">st1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span> <span class="s">&quot;st_mtime&quot;</span><span class="p">),</span> <span class="n">attr</span><span class="p">(</span><span class="n">st1</span><span class="p">,</span> <span class="s">&quot;st_mtime&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span> <span class="s">&quot;st_atime&quot;</span><span class="p">),</span> <span class="n">attr</span><span class="p">(</span><span class="n">st1</span><span class="p">,</span> <span class="s">&quot;st_atime&quot;</span><span class="p">))</span>
        <span class="c"># Set to the current time in the old explicit way.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">st2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="c"># Set to the current time in the new way</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">st3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="n">st2</span><span class="p">,</span> <span class="s">&quot;st_mtime&quot;</span><span class="p">),</span> <span class="n">attr</span><span class="p">(</span><span class="n">st3</span><span class="p">,</span> <span class="s">&quot;st_mtime&quot;</span><span class="p">),</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>

<div class="viewcode-block" id="StatAttributeTests.test_utime"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_utime">[docs]</a>    <span class="k">def</span> <span class="nf">test_utime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">utime</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">,</span> <span class="n">utime</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">,</span> <span class="n">utime</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">_test_utime_ns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_times_ns</span><span class="p">,</span> <span class="n">test_dir</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">getattr_ns</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">attr</span> <span class="o">+</span> <span class="s">&quot;_ns&quot;</span><span class="p">)</span>
        <span class="n">ten_s</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="n">getattr_ns</span><span class="p">,</span> <span class="n">set_times_ns</span><span class="p">,</span> <span class="n">ten_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">getattr_ns</span><span class="p">,</span> <span class="n">set_times_ns</span><span class="p">,</span> <span class="n">ten_s</span><span class="p">)</span>

<div class="viewcode-block" id="StatAttributeTests.test_utime_ns"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_utime_ns">[docs]</a>    <span class="k">def</span> <span class="nf">test_utime_ns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">utime_ns</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_ns</span><span class="p">(</span><span class="n">utime_ns</span><span class="p">)</span>
</div>
    <span class="n">requires_utime_dir_fd</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">utime</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">supports_dir_fd</span><span class="p">,</span>
                                <span class="s">&quot;dir_fd support for utime required for this test.&quot;</span><span class="p">)</span>
    <span class="n">requires_utime_fd</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">utime</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">supports_fd</span><span class="p">,</span>
                                <span class="s">&quot;fd support for utime required for this test.&quot;</span><span class="p">)</span>
    <span class="n">requires_utime_nofollow_symlinks</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">utime</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">supports_follow_symlinks</span><span class="p">,</span>
                                <span class="s">&quot;follow_symlinks support for utime required for this test.&quot;</span><span class="p">)</span>

    <span class="nd">@requires_utime_nofollow_symlinks</span>
<div class="viewcode-block" id="StatAttributeTests.test_lutimes_ns"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_lutimes_ns">[docs]</a>    <span class="k">def</span> <span class="nf">test_lutimes_ns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">lutimes_ns</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_ns</span><span class="p">(</span><span class="n">lutimes_ns</span><span class="p">)</span>
</div>
    <span class="nd">@requires_utime_fd</span>
<div class="viewcode-block" id="StatAttributeTests.test_futimes_ns"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_futimes_ns">[docs]</a>    <span class="k">def</span> <span class="nf">test_futimes_ns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">futimes_ns</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">ns</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_ns</span><span class="p">(</span><span class="n">futimes_ns</span><span class="p">,</span> <span class="n">test_dir</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_utime_invalid_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ns</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<div class="viewcode-block" id="StatAttributeTests.test_utime_invalid_arguments"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_utime_invalid_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">test_utime_invalid_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_utime_invalid_arguments</span><span class="p">(</span><span class="s">&#39;utime&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>

</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">stat_supports_subsecond</span><span class="p">,</span>
                         <span class="s">&quot;os.stat() doesn&#39;t has a subsecond resolution&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_utime_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_time_func</span><span class="p">):</span>
        <span class="n">asec</span><span class="p">,</span> <span class="n">amsec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">901</span>
        <span class="n">atime</span> <span class="o">=</span> <span class="n">asec</span> <span class="o">+</span> <span class="n">amsec</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="n">msec</span><span class="p">,</span> <span class="n">mmsec</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">901</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">msec</span> <span class="o">+</span> <span class="n">mmsec</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">set_time_func</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat_float_times</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_atime</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<div class="viewcode-block" id="StatAttributeTests.test_utime_subsecond"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_utime_subsecond">[docs]</a>    <span class="k">def</span> <span class="nf">test_utime_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_subsecond</span><span class="p">(</span><span class="n">set_time</span><span class="p">)</span>
</div>
    <span class="nd">@requires_utime_fd</span>
<div class="viewcode-block" id="StatAttributeTests.test_futimes_subsecond"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_futimes_subsecond">[docs]</a>    <span class="k">def</span> <span class="nf">test_futimes_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">times</span><span class="o">=</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_subsecond</span><span class="p">(</span><span class="n">set_time</span><span class="p">)</span>
</div>
    <span class="nd">@requires_utime_fd</span>
<div class="viewcode-block" id="StatAttributeTests.test_futimens_subsecond"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_futimens_subsecond">[docs]</a>    <span class="k">def</span> <span class="nf">test_futimens_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">times</span><span class="o">=</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_subsecond</span><span class="p">(</span><span class="n">set_time</span><span class="p">)</span>
</div>
    <span class="nd">@requires_utime_dir_fd</span>
<div class="viewcode-block" id="StatAttributeTests.test_futimesat_subsecond"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_futimesat_subsecond">[docs]</a>    <span class="k">def</span> <span class="nf">test_futimesat_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">dirfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">dir_fd</span><span class="o">=</span><span class="n">dirfd</span><span class="p">,</span>
                             <span class="n">times</span><span class="o">=</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">dirfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_subsecond</span><span class="p">(</span><span class="n">set_time</span><span class="p">)</span>
</div>
    <span class="nd">@requires_utime_nofollow_symlinks</span>
<div class="viewcode-block" id="StatAttributeTests.test_lutimes_subsecond"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_lutimes_subsecond">[docs]</a>    <span class="k">def</span> <span class="nf">test_lutimes_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">),</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_subsecond</span><span class="p">(</span><span class="n">set_time</span><span class="p">)</span>
</div>
    <span class="nd">@requires_utime_dir_fd</span>
<div class="viewcode-block" id="StatAttributeTests.test_utimensat_subsecond"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_utimensat_subsecond">[docs]</a>    <span class="k">def</span> <span class="nf">test_utimensat_subsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">set_time</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">dirfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">dir_fd</span><span class="o">=</span><span class="n">dirfd</span><span class="p">,</span>
                             <span class="n">times</span><span class="o">=</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">dirfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_utime_subsecond</span><span class="p">(</span><span class="n">set_time</span><span class="p">)</span>

    <span class="c"># Restrict tests to Win32, since there is no guarantee other</span>
    <span class="c"># systems support centiseconds</span></div>
<div class="viewcode-block" id="StatAttributeTests.get_file_system"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.get_file_system">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_system</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span>
            <span class="kn">import</span> <span class="nn">ctypes</span>
            <span class="n">kernel32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_unicode_buffer</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetVolumeInformationW</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">get_file_system</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;NTFS&quot;</span><span class="p">,</span>
                         <span class="s">&quot;requires NTFS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.test_1565150"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_1565150">[docs]</a>    <span class="k">def</span> <span class="nf">test_1565150</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="mf">1159195039.25</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">get_file_system</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;NTFS&quot;</span><span class="p">,</span>
                         <span class="s">&quot;requires NTFS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.test_large_time"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_large_time">[docs]</a>    <span class="k">def</span> <span class="nf">test_large_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="mi">5000000000</span> <span class="c"># some day in 2128</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.test_1686475"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_1686475">[docs]</a>    <span class="k">def</span> <span class="nf">test_1686475</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Verify that an open file can be stat&#39;ed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">r&quot;c:\pagefile.sys&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">r&#39;c:\pagefile.sys does not exist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Could not stat pagefile.sys&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;pipe&quot;</span><span class="p">),</span> <span class="s">&quot;requires os.pipe()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="StatAttributeTests.test_15261"><a class="viewcode-back" href="../../test.html#test.test_os.StatAttributeTests.test_15261">[docs]</a>    <span class="k">def</span> <span class="nf">test_15261</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Verify that stat&#39;ing a closed fd does not cause crash</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>          <span class="c"># should not raise error</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">)</span>
</div></div>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">mapping_tests</span>

<div class="viewcode-block" id="EnvironTests"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests">[docs]</a><span class="k">class</span> <span class="nc">EnvironTests</span><span class="p">(</span><span class="n">mapping_tests</span><span class="o">.</span><span class="n">BasicTestMappingProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check that os.environ object conform to mapping protocol&quot;&quot;&quot;</span>
    <span class="n">type2test</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="EnvironTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__save</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">supports_bytes_environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__saveb</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</div>
<div class="viewcode-block" id="EnvironTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__save</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">supports_bytes_environ</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__saveb</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;KEY1&quot;</span><span class="p">:</span><span class="s">&quot;VALUE1&quot;</span><span class="p">,</span> <span class="s">&quot;KEY2&quot;</span><span class="p">:</span><span class="s">&quot;VALUE2&quot;</span><span class="p">,</span> <span class="s">&quot;KEY3&quot;</span><span class="p">:</span><span class="s">&quot;VALUE3&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_empty_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

    <span class="c"># Bug 1110478</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;/bin/sh&#39;</span><span class="p">),</span> <span class="s">&#39;requires /bin/sh&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="EnvironTests.test_update2"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_update2">[docs]</a>    <span class="k">def</span> <span class="nf">test_update2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">HELLO</span><span class="o">=</span><span class="s">&quot;World&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;/bin/sh -c &#39;echo $HELLO&#39;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">popen</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">popen</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;World&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;/bin/sh&#39;</span><span class="p">),</span> <span class="s">&#39;requires /bin/sh&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="EnvironTests.test_os_popen_iter"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_os_popen_iter">[docs]</a>    <span class="k">def</span> <span class="nf">test_os_popen_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span>
            <span class="s">&quot;/bin/sh -c &#39;echo </span><span class="se">\&quot;</span><span class="s">line1</span><span class="se">\n</span><span class="s">line2</span><span class="se">\n</span><span class="s">line3</span><span class="se">\&quot;</span><span class="s">&#39;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">popen</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">popen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="s">&quot;line1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="s">&quot;line2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="s">&quot;line3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">StopIteration</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>

    <span class="c"># Verify environ keys and values from the OS are of the</span>
    <span class="c"># correct str type.</span></div>
<div class="viewcode-block" id="EnvironTests.test_keyvalue_types"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_keyvalue_types">[docs]</a>    <span class="k">def</span> <span class="nf">test_keyvalue_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EnvironTests.test_items"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_items">[docs]</a>    <span class="k">def</span> <span class="nf">test_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

    <span class="c"># Issue 7310</span></div>
<div class="viewcode-block" id="EnvironTests.test___repr__"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test___repr__">[docs]</a>    <span class="k">def</span> <span class="nf">test___repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the repr() of os.environ looks like environ({...}).&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">env</span><span class="p">),</span> <span class="s">&#39;environ({{{}}})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s">&#39;{!r}: {!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
</div>
<div class="viewcode-block" id="EnvironTests.test_get_exec_path"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_get_exec_path">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_exec_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">defpath_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">defpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
        <span class="n">test_path</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/monty&#39;</span><span class="p">,</span> <span class="s">&#39;/python&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;/flying/circus&#39;</span><span class="p">]</span>
        <span class="n">test_env</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_path</span><span class="p">)}</span>

        <span class="n">saved_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">test_env</span><span class="p">)</span>
            <span class="c"># Test that defaulting to os.environ works.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">saved_environ</span>

        <span class="c"># No PATH environment variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">defpath_list</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">({}))</span>
        <span class="c"># Empty PATH environment variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,),</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">({</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}))</span>
        <span class="c"># Supplied PATH environment variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">(</span><span class="n">test_env</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">supports_bytes_environ</span><span class="p">:</span>
            <span class="c"># env cannot contain &#39;PATH&#39; and b&#39;PATH&#39; keys</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># ignore BytesWarning warning</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                    <span class="n">mixed_env</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;2&#39;</span><span class="p">}</span>
            <span class="k">except</span> <span class="n">BytesWarning</span><span class="p">:</span>
                <span class="c"># mixed_env cannot be created with python -bb</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">,</span> <span class="n">mixed_env</span><span class="p">)</span>

            <span class="c"># bytes key and/or value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">({</span><span class="n">b</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">}),</span>
                <span class="p">[</span><span class="s">&#39;abc&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">({</span><span class="n">b</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span> <span class="s">&#39;abc&#39;</span><span class="p">}),</span>
                <span class="p">[</span><span class="s">&#39;abc&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">({</span><span class="s">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">}),</span>
                <span class="p">[</span><span class="s">&#39;abc&#39;</span><span class="p">])</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">supports_bytes_environ</span><span class="p">,</span>
                         <span class="s">&quot;os.environb required for this test.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="EnvironTests.test_environb"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_environb">[docs]</a>    <span class="k">def</span> <span class="nf">test_environb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># os.environ -&gt; os.environb</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;euro</span><span class="se">\u20ac</span><span class="s">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value_bytes</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">(),</span>
                                       <span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;U+20AC character is not encodable to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">(),)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;unicode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;unicode&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;unicode&#39;</span><span class="p">],</span> <span class="n">value_bytes</span><span class="p">)</span>

        <span class="c"># os.environb -&gt; os.environ</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;bytes&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value_str</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">(),</span> <span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;bytes&#39;</span><span class="p">],</span> <span class="n">value_str</span><span class="p">)</span>

    <span class="c"># On FreeBSD &lt; 7 and OS X &lt; 10.6, unsetenv() doesn&#39;t return a value (issue</span>
    <span class="c"># #13415).</span></div>
    <span class="nd">@support.requires_freebsd_version</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="nd">@support.requires_mac_ver</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<div class="viewcode-block" id="EnvironTests.test_unset_error"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_unset_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_unset_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
            <span class="c"># an environment variable is limited to 32,767 characters</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;x&#39;</span> <span class="o">*</span> <span class="mi">50000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># &quot;=&quot; is not allowed in a variable name</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;key=&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EnvironTests.test_key_type"><a class="viewcode-back" href="../../test.html#test.test_os.EnvironTests.test_key_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_key_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="s">&#39;missingkey&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">missing</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">missing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__suppress_context__</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">missing</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">missing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">__suppress_context__</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="WalkTests"><a class="viewcode-back" href="../../test.html#test.test_os.WalkTests">[docs]</a><span class="k">class</span> <span class="nc">WalkTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for os.walk().&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WalkTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.WalkTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>

        <span class="c"># Build:</span>
        <span class="c">#     TESTFN/</span>
        <span class="c">#       TEST1/              a file kid and two directory kids</span>
        <span class="c">#         tmp1</span>
        <span class="c">#         SUB1/             a file kid and a directory kid</span>
        <span class="c">#           tmp2</span>
        <span class="c">#           SUB11/          no kids</span>
        <span class="c">#         SUB2/             a file kid and a dirsymlink kid</span>
        <span class="c">#           tmp3</span>
        <span class="c">#           link/           a symlink to TESTFN.2</span>
        <span class="c">#           broken_link</span>
        <span class="c">#       TEST2/</span>
        <span class="c">#         tmp4              a lone file</span>
        <span class="n">walk_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;TEST1&quot;</span><span class="p">)</span>
        <span class="n">sub1_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="s">&quot;SUB1&quot;</span><span class="p">)</span>
        <span class="n">sub11_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sub1_path</span><span class="p">,</span> <span class="s">&quot;SUB11&quot;</span><span class="p">)</span>
        <span class="n">sub2_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="s">&quot;SUB2&quot;</span><span class="p">)</span>
        <span class="n">tmp1_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="s">&quot;tmp1&quot;</span><span class="p">)</span>
        <span class="n">tmp2_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sub1_path</span><span class="p">,</span> <span class="s">&quot;tmp2&quot;</span><span class="p">)</span>
        <span class="n">tmp3_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sub2_path</span><span class="p">,</span> <span class="s">&quot;tmp3&quot;</span><span class="p">)</span>
        <span class="n">link_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sub2_path</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">)</span>
        <span class="n">t2_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;TEST2&quot;</span><span class="p">)</span>
        <span class="n">tmp4_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;TEST2&quot;</span><span class="p">,</span> <span class="s">&quot;tmp4&quot;</span><span class="p">)</span>
        <span class="n">link_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sub2_path</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">)</span>
        <span class="n">broken_link_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sub2_path</span><span class="p">,</span> <span class="s">&quot;broken_link&quot;</span><span class="p">)</span>

        <span class="c"># Create stuff.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sub11_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sub2_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">t2_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tmp1_path</span><span class="p">,</span> <span class="n">tmp2_path</span><span class="p">,</span> <span class="n">tmp3_path</span><span class="p">,</span> <span class="n">tmp4_path</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;I&#39;m &quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&quot; and proud of it.  Blame test_os.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">can_symlink</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">t2_path</span><span class="p">),</span> <span class="n">link_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="s">&#39;broken&#39;</span><span class="p">,</span> <span class="n">broken_link_path</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">sub2_tree</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub2_path</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;link&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;broken_link&quot;</span><span class="p">,</span> <span class="s">&quot;tmp3&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sub2_tree</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub2_path</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="s">&quot;tmp3&quot;</span><span class="p">])</span>

        <span class="c"># Walk top-down.</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">walk_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">all</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c"># We can&#39;t know which order SUB1 and SUB2 will appear in.</span>
        <span class="c"># Not flipped:  TESTFN, SUB1, SUB11, SUB2</span>
        <span class="c">#     flipped:  TESTFN, SUB2, SUB1, SUB11</span>
        <span class="n">flipped</span> <span class="o">=</span> <span class="nb">all</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;SUB1&quot;</span>
        <span class="nb">all</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="nb">all</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">flipped</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SUB1&quot;</span><span class="p">,</span> <span class="s">&quot;SUB2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;tmp1&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">flipped</span><span class="p">],</span> <span class="p">(</span><span class="n">sub1_path</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SUB11&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;tmp2&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">flipped</span><span class="p">],</span> <span class="p">(</span><span class="n">sub11_path</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">flipped</span><span class="p">],</span> <span class="n">sub2_tree</span><span class="p">)</span>

        <span class="c"># Prune the search.</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">walk_path</span><span class="p">):</span>
            <span class="nb">all</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>
            <span class="c"># Don&#39;t descend into SUB1.</span>
            <span class="k">if</span> <span class="s">&#39;SUB1&#39;</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="c"># Note that this also mutates the dirs we appended to all!</span>
                <span class="n">dirs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;SUB1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">all</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SUB2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;tmp1&quot;</span><span class="p">]))</span>
        <span class="nb">all</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sub2_tree</span><span class="p">)</span>

        <span class="c"># Walk bottom-up.</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">all</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c"># We can&#39;t know which order SUB1 and SUB2 will appear in.</span>
        <span class="c"># Not flipped:  SUB11, SUB1, SUB2, TESTFN</span>
        <span class="c">#     flipped:  SUB2, SUB11, SUB1, TESTFN</span>
        <span class="n">flipped</span> <span class="o">=</span> <span class="nb">all</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;SUB1&quot;</span>
        <span class="nb">all</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="nb">all</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">flipped</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SUB1&quot;</span><span class="p">,</span> <span class="s">&quot;SUB2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;tmp1&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="n">flipped</span><span class="p">],</span> <span class="p">(</span><span class="n">sub11_path</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="n">flipped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">sub1_path</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;SUB11&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;tmp2&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">flipped</span><span class="p">],</span> <span class="n">sub2_tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">can_symlink</span><span class="p">():</span>
            <span class="c"># Walk, following symlinks.</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">walk_path</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="n">link_path</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dirs</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;tmp4&quot;</span><span class="p">])</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Didn&#39;t follow symlink with followlinks=True&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WalkTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.WalkTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Tear everything down.  This is a decent use for bottom-up on</span>
        <span class="c"># Windows, which doesn&#39;t have a recursive delete command.  The</span>
        <span class="c"># (not so) subtlety is that rmdir will fail unless the dir&#39;s</span>
        <span class="c"># kids are removed first, so bottom up is essential.</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;fwalk&#39;</span><span class="p">),</span> <span class="s">&quot;Test needs os.fwalk()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FwalkTests"><a class="viewcode-back" href="../../test.html#test.test_os.FwalkTests">[docs]</a><span class="k">class</span> <span class="nc">FwalkTests</span><span class="p">(</span><span class="n">WalkTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for os.fwalk().&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_compare_to_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">walk_kwargs</span><span class="p">,</span> <span class="n">fwalk_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compare with walk() results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">walk_kwargs</span> <span class="o">=</span> <span class="n">walk_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fwalk_kwargs</span> <span class="o">=</span> <span class="n">fwalk_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">topdown</span><span class="p">,</span> <span class="n">follow_symlinks</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">walk_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">topdown</span><span class="o">=</span><span class="n">topdown</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
            <span class="n">fwalk_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">topdown</span><span class="o">=</span><span class="n">topdown</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>

            <span class="n">expected</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="o">**</span><span class="n">walk_kwargs</span><span class="p">):</span>
                <span class="n">expected</span><span class="p">[</span><span class="n">root</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dirs</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">rootfd</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">fwalk</span><span class="p">(</span><span class="o">**</span><span class="n">fwalk_kwargs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">root</span><span class="p">],</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dirs</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>

<div class="viewcode-block" id="FwalkTests.test_compare_to_walk"><a class="viewcode-back" href="../../test.html#test.test_os.FwalkTests.test_compare_to_walk">[docs]</a>    <span class="k">def</span> <span class="nf">test_compare_to_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;top&#39;</span><span class="p">:</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compare_to_walk</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FwalkTests.test_dir_fd"><a class="viewcode-back" href="../../test.html#test.test_os.FwalkTests.test_dir_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_dir_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
            <span class="n">walk_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;top&#39;</span><span class="p">:</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">}</span>
            <span class="n">fwalk_kwargs</span> <span class="o">=</span> <span class="n">walk_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">fwalk_kwargs</span><span class="p">[</span><span class="s">&#39;dir_fd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compare_to_walk</span><span class="p">(</span><span class="n">walk_kwargs</span><span class="p">,</span> <span class="n">fwalk_kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FwalkTests.test_yields_correct_dir_fd"><a class="viewcode-back" href="../../test.html#test.test_os.FwalkTests.test_yields_correct_dir_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_yields_correct_dir_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check returned file descriptors</span>
        <span class="k">for</span> <span class="n">topdown</span><span class="p">,</span> <span class="n">follow_symlinks</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">topdown</span><span class="p">,</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">rootfd</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">fwalk</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                <span class="c"># check that the FD is valid</span>
                <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">rootfd</span><span class="p">)</span>
                <span class="c"># redundant check</span>
                <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">rootfd</span><span class="p">)</span>
                <span class="c"># check that listdir() returns consistent information</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rootfd</span><span class="p">)),</span> <span class="nb">set</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="FwalkTests.test_fd_leak"><a class="viewcode-back" href="../../test.html#test.test_os.FwalkTests.test_fd_leak">[docs]</a>    <span class="k">def</span> <span class="nf">test_fd_leak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Since we&#39;re opening a lot of FDs, we must be careful to avoid leaks:</span>
        <span class="c"># we both check that calling fwalk() a large number of times doesn&#39;t</span>
        <span class="c"># yield EMFILE, and that the minimum allocated FD hasn&#39;t changed.</span>
        <span class="n">minfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">minfd</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">fwalk</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="n">newfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">newfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">newfd</span><span class="p">,</span> <span class="n">minfd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FwalkTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.FwalkTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># cleanup</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">rootfd</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">fwalk</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dir_fd</span><span class="o">=</span><span class="n">rootfd</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dir_fd</span><span class="o">=</span><span class="n">rootfd</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dir_fd</span><span class="o">=</span><span class="n">rootfd</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dir_fd</span><span class="o">=</span><span class="n">rootfd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="MakedirTests"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests">[docs]</a><span class="k">class</span> <span class="nc">MakedirTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="MakedirTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakedirTests.test_makedir"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.test_makedir">[docs]</a>    <span class="k">def</span> <span class="nf">test_makedir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">,</span> <span class="s">&#39;dir2&#39;</span><span class="p">,</span> <span class="s">&#39;dir3&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>             <span class="c"># Should work</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">,</span> <span class="s">&#39;dir2&#39;</span><span class="p">,</span> <span class="s">&#39;dir3&#39;</span><span class="p">,</span> <span class="s">&#39;dir4&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># Try paths with a &#39;.&#39; in them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">,</span> <span class="s">&#39;dir2&#39;</span><span class="p">,</span> <span class="s">&#39;dir3&#39;</span><span class="p">,</span> <span class="s">&#39;dir4&#39;</span><span class="p">,</span> <span class="s">&#39;dir5&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s">&#39;dir2&#39;</span><span class="p">,</span> <span class="s">&#39;dir3&#39;</span><span class="p">,</span> <span class="s">&#39;dir4&#39;</span><span class="p">,</span>
                            <span class="s">&#39;dir5&#39;</span><span class="p">,</span> <span class="s">&#39;dir6&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakedirTests.test_exist_ok_existing_directory"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.test_exist_ok_existing_directory">[docs]</a>    <span class="k">def</span> <span class="nf">test_exist_ok_existing_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o777</span>
        <span class="n">old_mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="n">o022</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o776</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">old_mask</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;chown&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.chown&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MakedirTests.test_chown_uid_gid_arguments_must_be_index"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.test_chown_uid_gid_arguments_must_be_index">[docs]</a>    <span class="k">def</span> <span class="nf">test_chown_uid_gid_arguments_must_be_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_uid</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_gid</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1j</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MakedirTests.test_exist_ok_s_isgid_directory"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.test_exist_ok_s_isgid_directory">[docs]</a>    <span class="k">def</span> <span class="nf">test_exist_ok_s_isgid_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">)</span>
        <span class="n">S_ISGID</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISGID</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o777</span>
        <span class="n">old_mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="n">o022</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_testfn_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">existing_testfn_mode</span> <span class="o">|</span> <span class="n">S_ISGID</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&#39;Cannot set S_ISGID for dir.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_ISGID</span> <span class="o">!=</span> <span class="n">S_ISGID</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&#39;No support for S_ISGID dir mode.&#39;</span><span class="p">)</span>
            <span class="c"># The os should apply S_ISGID from the parent dir for us, but</span>
            <span class="c"># this test need not depend on that behavior.  Be explicit.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">S_ISGID</span><span class="p">)</span>
            <span class="c"># http://bugs.python.org/issue14992</span>
            <span class="c"># Should not fail when the bit is already set.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># remove the bit.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S_ISGID</span><span class="p">)</span>
            <span class="c"># May work even when the bit is not already set when demanded.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">S_ISGID</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">old_mask</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakedirTests.test_exist_ok_existing_regular_file"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.test_exist_ok_existing_regular_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_exist_ok_existing_regular_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;abc&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakedirTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.MakedirTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dir1&#39;</span><span class="p">,</span> <span class="s">&#39;dir2&#39;</span><span class="p">,</span> <span class="s">&#39;dir3&#39;</span><span class="p">,</span>
                            <span class="s">&#39;dir4&#39;</span><span class="p">,</span> <span class="s">&#39;dir5&#39;</span><span class="p">,</span> <span class="s">&#39;dir6&#39;</span><span class="p">)</span>
        <span class="c"># If the tests failed, the bottom-most directory (&#39;../dir6&#39;)</span>
        <span class="c"># may not have been created, so we look for the outermost directory</span>
        <span class="c"># that exists.</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span> <span class="o">!=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">removedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="RemoveDirsTests"><a class="viewcode-back" href="../../test.html#test.test_os.RemoveDirsTests">[docs]</a><span class="k">class</span> <span class="nc">RemoveDirsTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="RemoveDirsTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.RemoveDirsTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RemoveDirsTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.RemoveDirsTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RemoveDirsTests.test_remove_all"><a class="viewcode-back" href="../../test.html#test.test_os.RemoveDirsTests.test_remove_all">[docs]</a>    <span class="k">def</span> <span class="nf">test_remove_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dira</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dira&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dira</span><span class="p">)</span>
        <span class="n">dirb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dira</span><span class="p">,</span> <span class="s">&#39;dirb&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirb</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">removedirs</span><span class="p">(</span><span class="n">dirb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirb</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dira</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RemoveDirsTests.test_remove_partial"><a class="viewcode-back" href="../../test.html#test.test_os.RemoveDirsTests.test_remove_partial">[docs]</a>    <span class="k">def</span> <span class="nf">test_remove_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dira</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dira&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dira</span><span class="p">)</span>
        <span class="n">dirb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dira</span><span class="p">,</span> <span class="s">&#39;dirb&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirb</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dira</span><span class="p">,</span> <span class="s">&#39;file.txt&#39;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">removedirs</span><span class="p">(</span><span class="n">dirb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirb</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dira</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RemoveDirsTests.test_remove_nothing"><a class="viewcode-back" href="../../test.html#test.test_os.RemoveDirsTests.test_remove_nothing">[docs]</a>    <span class="k">def</span> <span class="nf">test_remove_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dira</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;dira&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dira</span><span class="p">)</span>
        <span class="n">dirb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dira</span><span class="p">,</span> <span class="s">&#39;dirb&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirb</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirb</span><span class="p">,</span> <span class="s">&#39;file.txt&#39;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">removedirs</span><span class="p">(</span><span class="n">dirb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirb</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dira</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="DevNullTests"><a class="viewcode-back" href="../../test.html#test.test_os.DevNullTests">[docs]</a><span class="k">class</span> <span class="nc">DevNullTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DevNullTests.test_devnull"><a class="viewcode-back" href="../../test.html#test.test_os.DevNullTests.test_devnull">[docs]</a>    <span class="k">def</span> <span class="nf">test_devnull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="URandomTests"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests">[docs]</a><span class="k">class</span> <span class="nc">URandomTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="URandomTests.test_urandom_length"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.test_urandom_length">[docs]</a>    <span class="k">def</span> <span class="nf">test_urandom_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">1000</span><span class="p">)),</span> <span class="mi">1000</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="URandomTests.test_urandom_value"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.test_urandom_value">[docs]</a>    <span class="k">def</span> <span class="nf">test_urandom_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="URandomTests.get_urandom_subprocess"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.get_urandom_subprocess">[docs]</a>    <span class="k">def</span> <span class="nf">get_urandom_subprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s">&#39;import os, sys&#39;</span><span class="p">,</span>
            <span class="s">&#39;data = os.urandom(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span>
            <span class="s">&#39;sys.stdout.buffer.write(data)&#39;</span><span class="p">,</span>
            <span class="s">&#39;sys.stdout.buffer.flush()&#39;</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stdout</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span>
</div>
<div class="viewcode-block" id="URandomTests.test_urandom_subprocess"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.test_urandom_subprocess">[docs]</a>    <span class="k">def</span> <span class="nf">test_urandom_subprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_urandom_subprocess</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_urandom_subprocess</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="s">&quot;test requires the resource module&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="URandomTests.test_urandom_failure"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.test_urandom_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test_urandom_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check urandom() failing when it is not able to open /dev/random.</span>
        <span class="c"># We spawn a new process to make the test more robust (if getrlimit()</span>
        <span class="c"># failed to restore the file descriptor limit after this, the whole</span>
        <span class="c"># test suite would crash; this actually happened on the OS X Tiger</span>
        <span class="c"># buildbot).</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import errno</span>
<span class="s">            import os</span>
<span class="s">            import resource</span>

<span class="s">            soft_limit, hard_limit = resource.getrlimit(resource.RLIMIT_NOFILE)</span>
<span class="s">            resource.setrlimit(resource.RLIMIT_NOFILE, (1, hard_limit))</span>
<span class="s">            try:</span>
<span class="s">                os.urandom(16)</span>
<span class="s">            except OSError as e:</span>
<span class="s">                assert e.errno == errno.EMFILE, e.errno</span>
<span class="s">            else:</span>
<span class="s">                raise AssertionError(&quot;OSError not raised&quot;)</span>
<span class="s">            &quot;&quot;&quot;</span>
        <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="URandomTests.test_urandom_fd_closed"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.test_urandom_fd_closed">[docs]</a>    <span class="k">def</span> <span class="nf">test_urandom_fd_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #21207: urandom() should reopen its fd to /dev/urandom if</span>
        <span class="c"># closed.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import os</span>
<span class="s">            import sys</span>
<span class="s">            os.urandom(4)</span>
<span class="s">            os.closerange(3, 256)</span>
<span class="s">            sys.stdout.buffer.write(os.urandom(4))</span>
<span class="s">            &quot;&quot;&quot;</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-Sc&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="URandomTests.test_urandom_fd_reopened"><a class="viewcode-back" href="../../test.html#test.test_os.URandomTests.test_urandom_fd_reopened">[docs]</a>    <span class="k">def</span> <span class="nf">test_urandom_fd_reopened</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #21207: urandom() should detect its fd to /dev/urandom</span>
        <span class="c"># changed to something else, and reopen it.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">            import os</span>
<span class="s">            import sys</span>
<span class="s">            os.urandom(4)</span>
<span class="s">            for fd in range(3, 256):</span>
<span class="s">                try:</span>
<span class="s">                    os.close(fd)</span>
<span class="s">                except OSError:</span>
<span class="s">                    pass</span>
<span class="s">                else:</span>
<span class="s">                    # Found the urandom fd (XXX hopefully)</span>
<span class="s">                    break</span>
<span class="s">            os.closerange(3, 256)</span>
<span class="s">            with open({TESTFN!r}, &#39;rb&#39;) as f:</span>
<span class="s">                os.dup2(f.fileno(), fd)</span>
<span class="s">                sys.stdout.buffer.write(os.urandom(4))</span>
<span class="s">                sys.stdout.buffer.write(os.urandom(4))</span>
<span class="s">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESTFN</span><span class="o">=</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-Sc&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out2</span><span class="p">,</span> <span class="n">err2</span> <span class="o">=</span> <span class="n">assert_python_ok</span><span class="p">(</span><span class="s">&#39;-Sc&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out2</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

</div></div>
<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">_execvpe_mockup</span><span class="p">(</span><span class="n">defpath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stubs out execv and execve functions when used as context manager.</span>
<span class="sd">    Records exec calls. The mock execv and execve functions always raise an</span>
<span class="sd">    exception as they would normally never return.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># A list of tuples containing (function name, first arg, args)</span>
    <span class="c"># of calls to execv or execve that have been made.</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">mock_execv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;execv&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;execv called&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mock_execve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">calls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;execve&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOTDIR</span><span class="p">,</span> <span class="s">&quot;execve called&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">orig_execv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">execv</span>
        <span class="n">orig_execve</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">execve</span>
        <span class="n">orig_defpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">defpath</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execv</span> <span class="o">=</span> <span class="n">mock_execv</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execve</span> <span class="o">=</span> <span class="n">mock_execve</span>
        <span class="k">if</span> <span class="n">defpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">defpath</span> <span class="o">=</span> <span class="n">defpath</span>
        <span class="k">yield</span> <span class="n">calls</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execv</span> <span class="o">=</span> <span class="n">orig_execv</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execve</span> <span class="o">=</span> <span class="n">orig_execve</span>
        <span class="n">os</span><span class="o">.</span><span class="n">defpath</span> <span class="o">=</span> <span class="n">orig_defpath</span>

<div class="viewcode-block" id="ExecTests"><a class="viewcode-back" href="../../test.html#test.test_os.ExecTests">[docs]</a><span class="k">class</span> <span class="nc">ExecTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">USING_LINUXTHREADS</span><span class="p">,</span>
                     <span class="s">&quot;avoid triggering a linuxthreads bug: see issue #4970&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ExecTests.test_execvpe_with_bad_program"><a class="viewcode-back" href="../../test.html#test.test_os.ExecTests.test_execvpe_with_bad_program">[docs]</a>    <span class="k">def</span> <span class="nf">test_execvpe_with_bad_program</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">,</span> <span class="s">&#39;no such app-&#39;</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;no such app-&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ExecTests.test_execvpe_with_bad_arglist"><a class="viewcode-back" href="../../test.html#test.test_os.ExecTests.test_execvpe_with_bad_arglist">[docs]</a>    <span class="k">def</span> <span class="nf">test_execvpe_with_bad_arglist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">,</span> <span class="s">&#39;notepad&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">None</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;_execvpe&#39;</span><span class="p">),</span>
                         <span class="s">&quot;No internal os._execvpe function to test.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_internal_execvpe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_type</span><span class="p">):</span>
        <span class="n">program_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&#39;absolutepath&#39;</span>
        <span class="k">if</span> <span class="n">test_type</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">program</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;executable&#39;</span>
            <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">program_path</span><span class="p">),</span> <span class="n">program</span><span class="p">)</span>
            <span class="n">native_fullpath</span> <span class="o">=</span> <span class="n">fullpath</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;progname&#39;</span><span class="p">,</span> <span class="s">&#39;arg1&#39;</span><span class="p">,</span> <span class="s">&#39;arg2&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">program</span> <span class="o">=</span> <span class="s">&#39;executable&#39;</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;progname&#39;</span><span class="p">,</span> <span class="s">&#39;arg1&#39;</span><span class="p">,</span> <span class="s">&#39;arg2&#39;</span><span class="p">]</span>
            <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">program_path</span><span class="p">,</span> <span class="n">program</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&quot;nt&quot;</span><span class="p">:</span>
                <span class="n">native_fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">native_fullpath</span> <span class="o">=</span> <span class="n">fullpath</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;spam&#39;</span><span class="p">:</span> <span class="s">&#39;beans&#39;</span><span class="p">}</span>

        <span class="c"># test os._execvpe() with an absolute path</span>
        <span class="k">with</span> <span class="n">_execvpe_mockup</span><span class="p">()</span> <span class="k">as</span> <span class="n">calls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_execvpe</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="s">&#39;execv&#39;</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">,</span> <span class="p">(</span><span class="n">arguments</span><span class="p">,)))</span>

        <span class="c"># test os._execvpe() with a relative path:</span>
        <span class="c"># os.get_exec_path() returns defpath</span>
        <span class="k">with</span> <span class="n">_execvpe_mockup</span><span class="p">(</span><span class="n">defpath</span><span class="o">=</span><span class="n">program_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">calls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_execvpe</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">(</span><span class="s">&#39;execve&#39;</span><span class="p">,</span> <span class="n">native_fullpath</span><span class="p">,</span> <span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">env</span><span class="p">)))</span>

        <span class="c"># test os._execvpe() with a relative path:</span>
        <span class="c"># os.get_exec_path() reads the &#39;PATH&#39; variable</span>
        <span class="k">with</span> <span class="n">_execvpe_mockup</span><span class="p">()</span> <span class="k">as</span> <span class="n">calls</span><span class="p">:</span>
            <span class="n">env_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">test_type</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="n">env_path</span><span class="p">[</span><span class="n">b</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">program_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">env_path</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">program_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_execvpe</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">(</span><span class="s">&#39;execve&#39;</span><span class="p">,</span> <span class="n">native_fullpath</span><span class="p">,</span> <span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">env_path</span><span class="p">)))</span>

<div class="viewcode-block" id="ExecTests.test_internal_execvpe_str"><a class="viewcode-back" href="../../test.html#test.test_os.ExecTests.test_internal_execvpe_str">[docs]</a>    <span class="k">def</span> <span class="nf">test_internal_execvpe_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_internal_execvpe</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&quot;nt&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_internal_execvpe</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32ErrorTests"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests">[docs]</a><span class="k">class</span> <span class="nc">Win32ErrorTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="Win32ErrorTests.test_rename"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests.test_rename">[docs]</a>    <span class="k">def</span> <span class="nf">test_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="o">+</span><span class="s">&quot;.bak&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ErrorTests.test_remove"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests.test_remove">[docs]</a>    <span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ErrorTests.test_chdir"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests.test_chdir">[docs]</a>    <span class="k">def</span> <span class="nf">test_chdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ErrorTests.test_mkdir"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests.test_mkdir">[docs]</a>    <span class="k">def</span> <span class="nf">test_mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ErrorTests.test_utime"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests.test_utime">[docs]</a>    <span class="k">def</span> <span class="nf">test_utime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ErrorTests.test_chmod"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ErrorTests.test_chmod">[docs]</a>    <span class="k">def</span> <span class="nf">test_chmod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TestInvalidFD"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD">[docs]</a><span class="k">class</span> <span class="nc">TestInvalidFD</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">singles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;fchdir&quot;</span><span class="p">,</span> <span class="s">&quot;dup&quot;</span><span class="p">,</span> <span class="s">&quot;fdopen&quot;</span><span class="p">,</span> <span class="s">&quot;fdatasync&quot;</span><span class="p">,</span> <span class="s">&quot;fstat&quot;</span><span class="p">,</span>
               <span class="s">&quot;fstatvfs&quot;</span><span class="p">,</span> <span class="s">&quot;fsync&quot;</span><span class="p">,</span> <span class="s">&quot;tcgetpgrp&quot;</span><span class="p">,</span> <span class="s">&quot;ttyname&quot;</span><span class="p">]</span>
    <span class="c">#singles.append(&quot;close&quot;)</span>
    <span class="c">#We omit close because it doesn&#39;r raise an exception on some platforms</span>
<div class="viewcode-block" id="TestInvalidFD.get_single"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.get_single">[docs]</a>    <span class="k">def</span> <span class="nf">get_single</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">helper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span>  <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">helper</span></div>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">singles</span><span class="p">:</span>
        <span class="nb">locals</span><span class="p">()[</span><span class="s">&quot;test_&quot;</span><span class="o">+</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_single</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<div class="viewcode-block" id="TestInvalidFD.check"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">make_bad_fd</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> didn&#39;t raise a OSError with a bad file descriptor&quot;</span>
                      <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;isatty&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.isatty()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_isatty"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_isatty">[docs]</a>    <span class="k">def</span> <span class="nf">test_isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">make_bad_fd</span><span class="p">()),</span> <span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;closerange&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.closerange()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_closerange"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_closerange">[docs]</a>    <span class="k">def</span> <span class="nf">test_closerange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">make_bad_fd</span><span class="p">()</span>
        <span class="c"># Make sure none of the descriptors we are about to close are</span>
        <span class="c"># currently valid (issue 6542).</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
                <span class="s">&quot;Unable to acquire a range of invalid file descriptors&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">closerange</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fd</span> <span class="o">+</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;dup2&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.dup2()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_dup2"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_dup2">[docs]</a>    <span class="k">def</span> <span class="nf">test_dup2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;fchmod&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.fchmod()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_fchmod"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_fchmod">[docs]</a>    <span class="k">def</span> <span class="nf">test_fchmod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fchmod</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;fchown&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.fchown()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_fchown"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_fchown">[docs]</a>    <span class="k">def</span> <span class="nf">test_fchown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fchown</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;fpathconf&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.fpathconf()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_fpathconf"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_fpathconf">[docs]</a>    <span class="k">def</span> <span class="nf">test_fpathconf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathconf</span><span class="p">,</span> <span class="s">&quot;PC_NAME_MAX&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fpathconf</span><span class="p">,</span> <span class="s">&quot;PC_NAME_MAX&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;ftruncate&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.ftruncate()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_ftruncate"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_ftruncate">[docs]</a>    <span class="k">def</span> <span class="nf">test_ftruncate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">truncate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">ftruncate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;lseek&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.lseek()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_lseek"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_lseek">[docs]</a>    <span class="k">def</span> <span class="nf">test_lseek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.read()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_read"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_read">[docs]</a>    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;readv&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.readv()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_readv"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_readv">[docs]</a>    <span class="k">def</span> <span class="nf">test_readv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">readv</span><span class="p">,</span> <span class="p">[</span><span class="n">buf</span><span class="p">])</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;tcsetpgrp&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.tcsetpgrp()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_tcsetpgrpt"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_tcsetpgrpt">[docs]</a>    <span class="k">def</span> <span class="nf">test_tcsetpgrpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">tcsetpgrp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.write()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_write"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_write">[docs]</a>    <span class="k">def</span> <span class="nf">test_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot; &quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;writev&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.writev()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestInvalidFD.test_writev"><a class="viewcode-back" href="../../test.html#test.test_os.TestInvalidFD.test_writev">[docs]</a>    <span class="k">def</span> <span class="nf">test_writev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">writev</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&#39;abc&#39;</span><span class="p">])</span>

</div></div>
<div class="viewcode-block" id="LinkTests"><a class="viewcode-back" href="../../test.html#test.test_os.LinkTests">[docs]</a><span class="k">class</span> <span class="nc">LinkTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="LinkTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.LinkTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file1</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&quot;2&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LinkTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.LinkTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_test_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">:</span>
            <span class="n">f1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sameopenfile</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">f2</span><span class="o">.</span><span class="n">fileno</span><span class="p">()))</span>

<div class="viewcode-block" id="LinkTests.test_link"><a class="viewcode-back" href="../../test.html#test.test_os.LinkTests.test_link">[docs]</a>    <span class="k">def</span> <span class="nf">test_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LinkTests.test_link_bytes"><a class="viewcode-back" href="../../test.html#test.test_os.LinkTests.test_link_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">test_link_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_link</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()),</span>
                        <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="LinkTests.test_unicode_name"><a class="viewcode-back" href="../../test.html#test.test_os.LinkTests.test_unicode_name">[docs]</a>    <span class="k">def</span> <span class="nf">test_unicode_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\xf1</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&quot;Unable to encode for this platform.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file1</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xf1</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span> <span class="o">+</span> <span class="s">&quot;2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Posix specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests">[docs]</a><span class="k">class</span> <span class="nc">PosixUidGidTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setuid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setuid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setuid"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setuid">[docs]</a>    <span class="k">def</span> <span class="nf">test_setuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setgid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setgid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setgid"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setgid">[docs]</a>    <span class="k">def</span> <span class="nf">test_setgid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">HAVE_WHEEL_GROUP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;seteuid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.seteuid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_seteuid"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_seteuid">[docs]</a>    <span class="k">def</span> <span class="nf">test_seteuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">seteuid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">seteuid</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setegid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setegid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setegid"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setegid">[docs]</a>    <span class="k">def</span> <span class="nf">test_setegid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">HAVE_WHEEL_GROUP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setegid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setegid</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setreuid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setreuid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setreuid"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setreuid">[docs]</a>    <span class="k">def</span> <span class="nf">test_setreuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setreuid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setreuid</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setreuid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setreuid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setreuid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setreuid_neg1"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setreuid_neg1">[docs]</a>    <span class="k">def</span> <span class="nf">test_setreuid_neg1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Needs to accept -1.  We run this in a subprocess to avoid</span>
        <span class="c"># altering the test runner&#39;s process state (issue8045).</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span>
                <span class="s">&#39;import os,sys;os.setreuid(-1,-1);sys.exit(0)&#39;</span><span class="p">])</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setregid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setregid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setregid"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setregid">[docs]</a>    <span class="k">def</span> <span class="nf">test_setregid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">HAVE_WHEEL_GROUP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setregid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setregid</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setregid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setregid&#39;</span><span class="p">),</span> <span class="s">&#39;test needs os.setregid()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PosixUidGidTests.test_setregid_neg1"><a class="viewcode-back" href="../../test.html#test.test_os.PosixUidGidTests.test_setregid_neg1">[docs]</a>    <span class="k">def</span> <span class="nf">test_setregid_neg1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Needs to accept -1.  We run this in a subprocess to avoid</span>
        <span class="c"># altering the test runner&#39;s process state (issue8045).</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span>
                <span class="s">&#39;import os,sys;os.setregid(-1,-1);sys.exit(0)&#39;</span><span class="p">])</span>
</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Posix specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Pep383Tests"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests">[docs]</a><span class="k">class</span> <span class="nc">Pep383Tests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="Pep383Tests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span>
        <span class="k">elif</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_NONASCII</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_NONASCII</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>

        <span class="n">bytesfn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">add_filename</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">bytesfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">add_filename</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNICODE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span><span class="p">:</span>
            <span class="n">add_filename</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_NONASCII</span><span class="p">:</span>
            <span class="n">add_filename</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN_NONASCII</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bytesfn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;couldn&#39;t create any non-ascii filename&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">bytesfn</span><span class="p">:</span>
                <span class="n">support</span><span class="o">.</span><span class="n">create_empty_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bdir</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsdecode</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;duplicate filename&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
<div class="viewcode-block" id="Pep383Tests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pep383Tests.test_listdir"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests.test_listdir">[docs]</a>    <span class="k">def</span> <span class="nf">test_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="c"># test listdir without arguments</span>
        <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_directory</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pep383Tests.test_open"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests.test_open">[docs]</a>    <span class="k">def</span> <span class="nf">test_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;statvfs&#39;</span><span class="p">),</span>
                            <span class="s">&quot;need os.statvfs()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Pep383Tests.test_statvfs"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests.test_statvfs">[docs]</a>    <span class="k">def</span> <span class="nf">test_statvfs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># issue #9645</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span><span class="p">:</span>
            <span class="c"># should not fail with file not found error</span>
            <span class="n">fullname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pep383Tests.test_stat"><a class="viewcode-back" href="../../test.html#test.test_os.Pep383Tests.test_stat">[docs]</a>    <span class="k">def</span> <span class="nf">test_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodefn</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32KillTests"><a class="viewcode-back" href="../../test.html#test.test_os.Win32KillTests">[docs]</a><span class="k">class</span> <span class="nc">Win32KillTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="c"># Start sys.executable as a subprocess and communicate from the</span>
        <span class="c"># subprocess to the parent that the interpreter is ready. When it</span>
        <span class="c"># becomes ready, send *sig* via os.kill to the subprocess and check</span>
        <span class="c"># that the return code is equal to *sig*.</span>
        <span class="kn">import</span> <span class="nn">ctypes</span>
        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">wintypes</span>
        <span class="kn">import</span> <span class="nn">msvcrt</span>

        <span class="c"># Since we can&#39;t access the contents of the process&#39; stdout until the</span>
        <span class="c"># process has exited, use PeekNamedPipe to see what&#39;s inside stdout</span>
        <span class="c"># without waiting. This is done so we can tell that the interpreter</span>
        <span class="c"># is started and running at a point where it could handle a signal.</span>
        <span class="n">PeekNamedPipe</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">PeekNamedPipe</span>
        <span class="n">PeekNamedPipe</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>
        <span class="n">PeekNamedPipe</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">,</span> <span class="c"># Pipe handle</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span><span class="p">),</span> <span class="c"># stdout buf</span>
                                  <span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">,</span> <span class="c"># Buffer size</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">),</span> <span class="c"># bytes read</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">),</span> <span class="c"># bytes avail</span>
                                  <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">))</span> <span class="c"># bytes left</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;running&quot;</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                                 <span class="s">&quot;import sys;&quot;</span>
                                 <span class="s">&quot;sys.stdout.write(&#39;{}&#39;);&quot;</span>
                                 <span class="s">&quot;sys.stdout.flush();&quot;</span>
                                 <span class="s">&quot;input()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">)],</span>
                                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

        <span class="n">count</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
        <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="nb">max</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Create a string buffer to store the result of stdout from the pipe</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="c"># Obtain the text currently in proc.stdout</span>
            <span class="c"># Bytes read/avail/left are left as NULL and unused</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="n">PeekNamedPipe</span><span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span>
                                 <span class="n">buf</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">rslt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PeekNamedPipe failed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Did not receive communication from the subprocess&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">sig</span><span class="p">)</span>

<div class="viewcode-block" id="Win32KillTests.test_kill_sigterm"><a class="viewcode-back" href="../../test.html#test.test_os.Win32KillTests.test_kill_sigterm">[docs]</a>    <span class="k">def</span> <span class="nf">test_kill_sigterm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># SIGTERM doesn&#39;t mean anything special, but make sure it works</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32KillTests.test_kill_int"><a class="viewcode-back" href="../../test.html#test.test_os.Win32KillTests.test_kill_int">[docs]</a>    <span class="k">def</span> <span class="nf">test_kill_int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># os.kill on Windows can take an int which gets set as the exit code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_kill_with_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">tagname</span> <span class="o">=</span> <span class="s">&quot;test_os_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tagname</span><span class="p">)</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># Run a script which has console control handling enabled.</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span>
                                <span class="s">&quot;win_console_handler.py&quot;</span><span class="p">),</span> <span class="n">tagname</span><span class="p">],</span>
                   <span class="n">creationflags</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span><span class="p">)</span>
        <span class="c"># Let the interpreter startup before we send signals. See #3137.</span>
        <span class="n">count</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
        <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="nb">max</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Forcefully kill the process if we weren&#39;t able to signal it.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Subprocess didn&#39;t finish initialization&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="c"># proc.send_signal(event) could also be done here.</span>
        <span class="c"># Allow time for the signal to be passed and the process to exit.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
            <span class="c"># Forcefully kill the process if we weren&#39;t able to signal it.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;subprocess did not stop on {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;subprocesses aren&#39;t inheriting CTRL+C property&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32KillTests.test_CTRL_C_EVENT"><a class="viewcode-back" href="../../test.html#test.test_os.Win32KillTests.test_CTRL_C_EVENT">[docs]</a>    <span class="k">def</span> <span class="nf">test_CTRL_C_EVENT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">wintypes</span>
        <span class="kn">import</span> <span class="nn">ctypes</span>

        <span class="c"># Make a NULL value by creating a pointer with no argument.</span>
        <span class="n">NULL</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)()</span>
        <span class="n">SetConsoleCtrlHandler</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">SetConsoleCtrlHandler</span>
        <span class="n">SetConsoleCtrlHandler</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                                          <span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span><span class="p">)</span>
        <span class="n">SetConsoleCtrlHandler</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>

        <span class="c"># Calling this with NULL and FALSE causes the calling process to</span>
        <span class="c"># handle CTRL+C, rather than ignore it. This property is inherited</span>
        <span class="c"># by subprocesses.</span>
        <span class="n">SetConsoleCtrlHandler</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_with_event</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">CTRL_C_EVENT</span><span class="p">,</span> <span class="s">&quot;CTRL_C_EVENT&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32KillTests.test_CTRL_BREAK_EVENT"><a class="viewcode-back" href="../../test.html#test.test_os.Win32KillTests.test_CTRL_BREAK_EVENT">[docs]</a>    <span class="k">def</span> <span class="nf">test_CTRL_BREAK_EVENT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_with_event</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">,</span> <span class="s">&quot;CTRL_BREAK_EVENT&quot;</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32ListdirTests"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ListdirTests">[docs]</a><span class="k">class</span> <span class="nc">Win32ListdirTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test listdir on Windows.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Win32ListdirTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ListdirTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">dir_name</span> <span class="o">=</span> <span class="s">&#39;SUB</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s">&#39;FILE</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;I&#39;m </span><span class="si">%s</span><span class="s"> and proud of it. Blame test_os.</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Win32ListdirTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ListdirTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ListdirTests.test_listdir_no_extended_path"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ListdirTests.test_listdir_no_extended_path">[docs]</a>    <span class="k">def</span> <span class="nf">test_listdir_no_extended_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test when the path is not an &quot;extended&quot; path.&quot;&quot;&quot;</span>
        <span class="c"># unicode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span><span class="p">)</span>
        <span class="c"># bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">))),</span>
                <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Win32ListdirTests.test_listdir_extended_path"><a class="viewcode-back" href="../../test.html#test.test_os.Win32ListdirTests.test_listdir_extended_path">[docs]</a>    <span class="k">def</span> <span class="nf">test_listdir_extended_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test when the path starts with &#39;\\\\?\\&#39;.&quot;&quot;&quot;</span>
        <span class="c"># See: http://msdn.microsoft.com/en-us/library/windows/desktop/aa365247(v=vs.85).aspx#maxpath</span>
        <span class="c"># unicode</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">?</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span><span class="p">)</span>
        <span class="c"># bytes</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">?</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span>
                <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_paths</span><span class="p">])</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
<span class="nd">@support.skip_unless_symlink</span>
<div class="viewcode-block" id="Win32SymlinkTests"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests">[docs]</a><span class="k">class</span> <span class="nc">Win32SymlinkTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">filelink</span> <span class="o">=</span> <span class="s">&#39;filelinktest&#39;</span>
    <span class="n">filelink_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="n">dirlink</span> <span class="o">=</span> <span class="s">&#39;dirlinktest&#39;</span>
    <span class="n">dirlink_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filelink_target</span><span class="p">)</span>
    <span class="n">missing_link</span> <span class="o">=</span> <span class="s">&#39;missing link&#39;</span>

<div class="viewcode-block" id="Win32SymlinkTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink_target</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink_target</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32SymlinkTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32SymlinkTests.test_directory_link"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.test_directory_link">[docs]</a>    <span class="k">def</span> <span class="nf">test_directory_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirlink</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirlink_target</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32SymlinkTests.test_file_link"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.test_file_link">[docs]</a>    <span class="k">def</span> <span class="nf">test_file_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelink</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelink_target</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_create_missing_dir_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&#39;Create a &quot;directory&quot; link to a non-existent target&#39;</span>
        <span class="n">linkname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">linkname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">linkname</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="s">r&#39;c:</span><span class="se">\\</span><span class="s">target does not exist.29r3c740&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">target_is_dir</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">linkname</span><span class="p">,</span> <span class="n">target_is_dir</span><span class="p">)</span>

<div class="viewcode-block" id="Win32SymlinkTests.test_remove_directory_link_to_missing_target"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.test_remove_directory_link_to_missing_target">[docs]</a>    <span class="k">def</span> <span class="nf">test_remove_directory_link_to_missing_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_missing_dir_link</span><span class="p">()</span>
        <span class="c"># For compatibility with Unix, os.remove will check the</span>
        <span class="c">#  directory status and call RemoveDirectory if the symlink</span>
        <span class="c">#  was created with target_is_dir==True.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;currently fails; consider for improvement&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32SymlinkTests.test_isdir_on_directory_link_to_missing_target"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.test_isdir_on_directory_link_to_missing_target">[docs]</a>    <span class="k">def</span> <span class="nf">test_isdir_on_directory_link_to_missing_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_missing_dir_link</span><span class="p">()</span>
        <span class="c"># consider having isdir return true for directory links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span><span class="p">))</span>
</div>
    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;currently fails; consider for improvement&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32SymlinkTests.test_rmdir_on_directory_link_to_missing_target"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.test_rmdir_on_directory_link_to_missing_target">[docs]</a>    <span class="k">def</span> <span class="nf">test_rmdir_on_directory_link_to_missing_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_missing_dir_link</span><span class="p">()</span>
        <span class="c"># consider allowing rmdir to remove directory links</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_link</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32SymlinkTests.check_stat"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.check_stat">[docs]</a>    <span class="k">def</span> <span class="nf">check_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">link</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">link</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>

        <span class="n">bytes_link</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">bytes_link</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">bytes_link</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">bytes_link</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Win32SymlinkTests.test_12084"><a class="viewcode-back" href="../../test.html#test.test_os.Win32SymlinkTests.test_12084">[docs]</a>    <span class="k">def</span> <span class="nf">test_12084</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">level1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="n">level2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">level1</span><span class="p">,</span> <span class="s">&quot;level2&quot;</span><span class="p">)</span>
        <span class="n">level3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">level2</span><span class="p">,</span> <span class="s">&quot;level3&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">level1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">level2</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">level3</span><span class="p">)</span>

            <span class="n">file1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">level1</span><span class="p">,</span> <span class="s">&quot;file1&quot;</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;file1&quot;</span><span class="p">)</span>

            <span class="n">orig_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">level2</span><span class="p">)</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">level2</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="s">&quot;link&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;link&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>

                <span class="c"># Check os.stat calls from the same dir as the link</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&quot;link&quot;</span><span class="p">))</span>

                <span class="c"># Check os.stat calls from a dir below the link</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">level1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span>

                <span class="c"># Check os.stat calls from a dir above the link</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">level3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">orig_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file1</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">level1</span><span class="p">)</span>

</div></div>
<span class="nd">@support.skip_unless_symlink</span>
<div class="viewcode-block" id="NonLocalSymlinkTests"><a class="viewcode-back" href="../../test.html#test.test_os.NonLocalSymlinkTests">[docs]</a><span class="k">class</span> <span class="nc">NonLocalSymlinkTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="NonLocalSymlinkTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.NonLocalSymlinkTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create this structure:</span>

<span class="sd">        base</span>
<span class="sd">         \___ some_dir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s">&#39;base/some_dir&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NonLocalSymlinkTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.NonLocalSymlinkTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s">&#39;base&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NonLocalSymlinkTests.test_directory_link_nonlocal"><a class="viewcode-back" href="../../test.html#test.test_os.NonLocalSymlinkTests.test_directory_link_nonlocal">[docs]</a>    <span class="k">def</span> <span class="nf">test_directory_link_nonlocal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The symlink target should resolve relative to the link, not relative</span>
<span class="sd">        to the current directory.</span>

<span class="sd">        Then, link base/some_link -&gt; base/some_dir and ensure that some_link</span>
<span class="sd">        is resolved as a directory.</span>

<span class="sd">        In issue13772, it was discovered that directory detection failed if</span>
<span class="sd">        the symlink target was not specified relative to the current</span>
<span class="sd">        directory, which was a defect in the implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;base&#39;</span><span class="p">,</span> <span class="s">&#39;some_link&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="s">&#39;some_dir&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="FSEncodingTests"><a class="viewcode-back" href="../../test.html#test.test_os.FSEncodingTests">[docs]</a><span class="k">class</span> <span class="nc">FSEncodingTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="FSEncodingTests.test_nop"><a class="viewcode-back" href="../../test.html#test.test_os.FSEncodingTests.test_nop">[docs]</a>    <span class="k">def</span> <span class="nf">test_nop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;abc</span><span class="se">\xff</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;abc</span><span class="se">\xff</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsdecode</span><span class="p">(</span><span class="s">&#39;abc</span><span class="se">\u0141</span><span class="s">&#39;</span><span class="p">),</span> <span class="s">&#39;abc</span><span class="se">\u0141</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FSEncodingTests.test_identity"><a class="viewcode-back" href="../../test.html#test.test_os.FSEncodingTests.test_identity">[docs]</a>    <span class="k">def</span> <span class="nf">test_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># assert fsdecode(fsencode(x)) == x</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;unicode</span><span class="se">\u0141</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;latin</span><span class="se">\xe9</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bytesfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsdecode</span><span class="p">(</span><span class="n">bytesfn</span><span class="p">),</span> <span class="n">fn</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="DeviceEncodingTests"><a class="viewcode-back" href="../../test.html#test.test_os.DeviceEncodingTests">[docs]</a><span class="k">class</span> <span class="nc">DeviceEncodingTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="DeviceEncodingTests.test_bad_fd"><a class="viewcode-back" href="../../test.html#test.test_os.DeviceEncodingTests.test_bad_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_bad_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Return None when an fd doesn&#39;t actually exist.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">device_encoding</span><span class="p">(</span><span class="mi">123456</span><span class="p">))</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="s">&#39;nl_langinfo&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="s">&#39;CODESET&#39;</span><span class="p">))),</span>
            <span class="s">&#39;test requires a tty and either Windows or nl_langinfo(CODESET)&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DeviceEncodingTests.test_device_encoding"><a class="viewcode-back" href="../../test.html#test.test_os.DeviceEncodingTests.test_device_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">test_device_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">device_encoding</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="PidTests"><a class="viewcode-back" href="../../test.html#test.test_os.PidTests">[docs]</a><span class="k">class</span> <span class="nc">PidTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;getppid&#39;</span><span class="p">),</span> <span class="s">&quot;test needs os.getppid&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PidTests.test_getppid"><a class="viewcode-back" href="../../test.html#test.test_os.PidTests.test_getppid">[docs]</a>    <span class="k">def</span> <span class="nf">test_getppid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span>
                              <span class="s">&#39;import os; print(os.getppid())&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="c"># We are the parent of our subprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">stdout</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>


<span class="c"># The introduction of this TestCase caused at least two different errors on</span>
<span class="c"># *nix buildbots. Temporarily skip this to let the buildbots move along.</span></div></div>
<span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;Skip due to platform/environment differences on *NIX buildbots&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;getlogin&#39;</span><span class="p">),</span> <span class="s">&quot;test needs os.getlogin&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="LoginTests"><a class="viewcode-back" href="../../test.html#test.test_os.LoginTests">[docs]</a><span class="k">class</span> <span class="nc">LoginTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="LoginTests.test_getlogin"><a class="viewcode-back" href="../../test.html#test.test_os.LoginTests.test_getlogin">[docs]</a>    <span class="k">def</span> <span class="nf">test_getlogin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_name</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;getpriority&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;setpriority&#39;</span><span class="p">),</span>
                     <span class="s">&quot;needs os.getpriority and os.setpriority&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProgramPriorityTests"><a class="viewcode-back" href="../../test.html#test.test_os.ProgramPriorityTests">[docs]</a><span class="k">class</span> <span class="nc">ProgramPriorityTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for os.getpriority() and os.setpriority().&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ProgramPriorityTests.test_set_get_priority"><a class="viewcode-back" href="../../test.html#test.test_os.ProgramPriorityTests.test_set_get_priority">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_get_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpriority</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">PRIO_PROCESS</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setpriority</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">PRIO_PROCESS</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_prio</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpriority</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">PRIO_PROCESS</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">base</span> <span class="o">&gt;=</span> <span class="mi">19</span> <span class="ow">and</span> <span class="n">new_prio</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
      <span class="s">&quot;unable to reliably test setpriority at current nice level of </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_prio</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">setpriority</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">PRIO_PROCESS</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">:</span>
                    <span class="k">raise</span>

</div></div>
<span class="k">if</span> <span class="n">threading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<div class="viewcode-block" id="SendfileTestServer"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer">[docs]</a>    <span class="k">class</span> <span class="nc">SendfileTestServer</span><span class="p">(</span><span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

<div class="viewcode-block" id="SendfileTestServer.Handler"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.Handler">[docs]</a>        <span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
                <span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;220 ready</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SendfileTestServer.Handler.handle_read"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.Handler.handle_read">[docs]</a>            <span class="k">def</span> <span class="nf">handle_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.Handler.get_data"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.Handler.get_data">[docs]</a>            <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_buffer</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.Handler.handle_close"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.Handler.handle_close">[docs]</a>            <span class="k">def</span> <span class="nf">handle_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.Handler.handle_error"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.Handler.handle_error">[docs]</a>            <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">raise</span>
</div></div>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler_instance</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="c"># --- public API</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span>

<div class="viewcode-block" id="SendfileTestServer.start"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.start">[docs]</a>        <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__flag</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__flag</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.stop"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.stop">[docs]</a>        <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.wait"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.wait">[docs]</a>        <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># wait for handler connection to be closed, then stop the server</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler_instance</span><span class="p">,</span> <span class="s">&quot;closed&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c"># --- internals</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.run"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.run">[docs]</a>        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__flag</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="ow">and</span> <span class="n">asyncore</span><span class="o">.</span><span class="n">socket_map</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">asyncore</span><span class="o">.</span><span class="n">close_all</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.handle_accept"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.handle_accept">[docs]</a>        <span class="k">def</span> <span class="nf">handle_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Handler</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.handle_connect"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.handle_connect">[docs]</a>        <span class="k">def</span> <span class="nf">handle_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        <span class="n">handle_read</span> <span class="o">=</span> <span class="n">handle_connect</span>

<div class="viewcode-block" id="SendfileTestServer.writable"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.writable">[docs]</a>        <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="SendfileTestServer.handle_error"><a class="viewcode-back" href="../../test.html#test.test_os.SendfileTestServer.handle_error">[docs]</a>        <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">threading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;test needs threading module&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;sendfile&#39;</span><span class="p">),</span> <span class="s">&quot;test needs os.sendfile()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="TestSendfile"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile">[docs]</a><span class="k">class</span> <span class="nc">TestSendfile</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="n">DATA</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;12345abcde&quot;</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c"># 160 KB</span>
    <span class="n">SUPPORT_HEADERS_TRAILERS</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;linux&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                               <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;solaris&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                               <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;sunos&quot;</span><span class="p">)</span>
    <span class="n">requires_headers_trailers</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">SUPPORT_HEADERS_TRAILERS</span><span class="p">,</span>
            <span class="s">&#39;requires headers and trailers support&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestSendfile.setUpClass"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.setUpClass">[docs]</a>    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestSendfile.tearDownClass"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.tearDownClass">[docs]</a>    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestSendfile.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">SendfileTestServer</span><span class="p">((</span><span class="n">support</span><span class="o">.</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># synchronize by waiting for &quot;220 ready&quot; response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sockno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TestSendfile.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TestSendfile.sendfile_wrapper"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.sendfile_wrapper">[docs]</a>    <span class="k">def</span> <span class="nf">sendfile_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[],</span> <span class="n">trailers</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;A higher level wrapper representing how an application is</span>
<span class="sd">        supposed to use sendfile().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORT_HEADERS_TRAILERS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span>
                                       <span class="n">trailers</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">:</span>
                    <span class="c"># disconnected</span>
                    <span class="k">raise</span>
                <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBUSY</span><span class="p">):</span>
                    <span class="c"># we have to retry send data</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
</div>
<div class="viewcode-block" id="TestSendfile.test_send_whole_file"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_send_whole_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_whole_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># normal send</span>
        <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="k">while</span> <span class="n">total_sent</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">):</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendfile_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sent</span>
            <span class="n">total_sent</span> <span class="o">+=</span> <span class="n">sent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sent</span> <span class="o">&lt;=</span> <span class="n">nbytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">total_sent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">handler_instance</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestSendfile.test_send_at_certain_offset"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_send_at_certain_offset">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_at_certain_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># start sending a file at a certain offset</span>
        <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">must_send</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="k">while</span> <span class="n">total_sent</span> <span class="o">&lt;</span> <span class="n">must_send</span><span class="p">:</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendfile_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sent</span>
            <span class="n">total_sent</span> <span class="o">+=</span> <span class="n">sent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sent</span> <span class="o">&lt;=</span> <span class="n">nbytes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">handler_instance</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestSendfile.test_offset_overflow"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_offset_overflow">[docs]</a>    <span class="k">def</span> <span class="nf">test_offset_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># specify an offset &gt; file size</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4096</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Solaris can raise EINVAL if offset &gt;= file length, ignore.</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINVAL</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">handler_instance</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestSendfile.test_invalid_offset"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_invalid_offset">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINVAL</span><span class="p">)</span>

    <span class="c"># --- headers / trailers tests</span>
</div>
    <span class="nd">@requires_headers_trailers</span>
<div class="viewcode-block" id="TestSendfile.test_headers"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_headers">[docs]</a>    <span class="k">def</span> <span class="nf">test_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_sent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">512</span><span class="p">])</span>
        <span class="n">total_sent</span> <span class="o">+=</span> <span class="n">sent</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendfile_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span>
                                                    <span class="n">offset</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">total_sent</span> <span class="o">+=</span> <span class="n">sent</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">sent</span>

        <span class="n">expected_data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">total_sent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">handler_instance</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">expected_data</span><span class="p">))</span>
</div>
    <span class="nd">@requires_headers_trailers</span>
<div class="viewcode-block" id="TestSendfile.test_trailers"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_trailers">[docs]</a>    <span class="k">def</span> <span class="nf">test_trailers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">TESTFN2</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&quot;2&quot;</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;abcdef&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN2</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN2</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span><span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">,</span> <span class="n">TESTFN2</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">),</span>
                        <span class="n">trailers</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="s">&quot;1234&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">handler_instance</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;abcdef1234&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@requires_headers_trailers</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;SF_NODISKIO&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs os.SF_NODISKIO&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestSendfile.test_flags"><a class="viewcode-back" href="../../test.html#test.test_os.TestSendfile.test_flags">[docs]</a>    <span class="k">def</span> <span class="nf">test_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span>
                        <span class="n">flags</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">SF_NODISKIO</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EBUSY</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">):</span>
                <span class="k">raise</span>

</div></div>
<div class="viewcode-block" id="supports_extended_attributes"><a class="viewcode-back" href="../../test.html#test.test_os.supports_extended_attributes">[docs]</a><span class="k">def</span> <span class="nf">supports_extended_attributes</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;setxattr&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;user.test&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
    <span class="c"># Kernels &lt; 2.6.39 don&#39;t respect setxattr flags.</span>
    <span class="n">kernel_version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;2.6.(\d{1,2})&quot;</span><span class="p">,</span> <span class="n">kernel_version</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">39</span>

</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">supports_extended_attributes</span><span class="p">(),</span>
                     <span class="s">&quot;no non-broken extended attribute support&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ExtendedAttributeTests"><a class="viewcode-back" href="../../test.html#test.test_os.ExtendedAttributeTests">[docs]</a><span class="k">class</span> <span class="nc">ExtendedAttributeTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ExtendedAttributeTests.tearDown"><a class="viewcode-back" href="../../test.html#test.test_os.ExtendedAttributeTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_xattrs_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">getxattr</span><span class="p">,</span> <span class="n">setxattr</span><span class="p">,</span> <span class="n">removexattr</span><span class="p">,</span> <span class="n">listxattr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">getxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENODATA</span><span class="p">)</span>
        <span class="n">init_xattr</span> <span class="o">=</span> <span class="n">listxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">init_xattr</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">xattr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">init_xattr</span><span class="p">)</span>
        <span class="n">xattr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">listxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">)),</span> <span class="n">xattr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">getxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;user.test&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">XATTR_REPLACE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">getxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;user.test&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;bye&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">XATTR_CREATE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test2&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;bye&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">XATTR_REPLACE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENODATA</span><span class="p">)</span>
        <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test2&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">XATTR_CREATE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">xattr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;user.test2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">listxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">)),</span> <span class="n">xattr</span><span class="p">)</span>
        <span class="n">removexattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">getxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENODATA</span><span class="p">)</span>
        <span class="n">xattr</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">listxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">)),</span> <span class="n">xattr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">getxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test2&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">getxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">removexattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;user.test&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">many</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="s">&quot;user.test{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">many</span><span class="p">:</span>
            <span class="n">setxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">listxattr</span><span class="p">(</span><span class="n">fn</span><span class="p">)),</span> <span class="nb">set</span><span class="p">(</span><span class="n">init_xattr</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">many</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_xattrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">make_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_xattrs_str</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_xattrs_str</span><span class="p">(</span><span class="n">make_bytes</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ExtendedAttributeTests.test_simple"><a class="viewcode-back" href="../../test.html#test.test_os.ExtendedAttributeTests.test_simple">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_xattrs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getxattr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">removexattr</span><span class="p">,</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">listxattr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ExtendedAttributeTests.test_lpath"><a class="viewcode-back" href="../../test.html#test.test_os.ExtendedAttributeTests.test_lpath">[docs]</a>    <span class="k">def</span> <span class="nf">test_lpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_xattrs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getxattr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">removexattr</span><span class="p">,</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">listxattr</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ExtendedAttributeTests.test_fds"><a class="viewcode-back" href="../../test.html#test.test_os.ExtendedAttributeTests.test_fds">[docs]</a>    <span class="k">def</span> <span class="nf">test_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">getxattr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getxattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">setxattr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">removexattr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">removexattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">listxattr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listxattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_xattrs</span><span class="p">(</span><span class="n">getxattr</span><span class="p">,</span> <span class="n">setxattr</span><span class="p">,</span> <span class="n">removexattr</span><span class="p">,</span> <span class="n">listxattr</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;Win32 specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32DeprecatedBytesAPI"><a class="viewcode-back" href="../../test.html#test.test_os.Win32DeprecatedBytesAPI">[docs]</a><span class="k">class</span> <span class="nc">Win32DeprecatedBytesAPI</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="Win32DeprecatedBytesAPI.test_deprecated"><a class="viewcode-back" href="../../test.html#test.test_os.Win32DeprecatedBytesAPI.test_deprecated">[docs]</a>    <span class="k">def</span> <span class="nf">test_deprecated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">nt</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">_getfullpathname</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">_isdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="n">o777</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwdb</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</div>
    <span class="nd">@support.skip_unless_symlink</span>
<div class="viewcode-block" id="Win32DeprecatedBytesAPI.test_symlink"><a class="viewcode-back" href="../../test.html#test.test_os.Win32DeprecatedBytesAPI.test_symlink">[docs]</a>    <span class="k">def</span> <span class="nf">test_symlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">,</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;get_terminal_size&#39;</span><span class="p">),</span> <span class="s">&quot;requires os.get_terminal_size&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="TermsizeTests"><a class="viewcode-back" href="../../test.html#test.test_os.TermsizeTests">[docs]</a><span class="k">class</span> <span class="nc">TermsizeTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TermsizeTests.test_does_not_crash"><a class="viewcode-back" href="../../test.html#test.test_os.TermsizeTests.test_does_not_crash">[docs]</a>    <span class="k">def</span> <span class="nf">test_does_not_crash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if get_terminal_size() returns a meaningful value.</span>

<span class="sd">        There&#39;s no easy portable way to actually check the size of the</span>
<span class="sd">        terminal, so let&#39;s check if it returns something sensible instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTTY</span><span class="p">):</span>
                <span class="c"># Under win32 a generic OSError can be thrown if the</span>
                <span class="c"># handle cannot be retrieved</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;failed to query terminal size&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TermsizeTests.test_stty_match"><a class="viewcode-back" href="../../test.html#test.test_os.TermsizeTests.test_stty_match">[docs]</a>    <span class="k">def</span> <span class="nf">test_stty_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if stty returns the same results</span>

<span class="sd">        stty actually tests stdin, so get_terminal_size is invoked on</span>
<span class="sd">        stdin explicitly. If stty succeeded, then get_terminal_size()</span>
<span class="sd">        should work too.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">&#39;stty&#39;</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;stty invocation failed&quot;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c"># reversed order</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTTY</span><span class="p">):</span>
                <span class="c"># Under win32 a generic OSError can be thrown if the</span>
                <span class="c"># handle cannot be retrieved</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;failed to query terminal size&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OSErrorTests"><a class="viewcode-back" href="../../test.html#test.test_os.OSErrorTests">[docs]</a><span class="k">class</span> <span class="nc">OSErrorTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="OSErrorTests.setUp"><a class="viewcode-back" href="../../test.html#test.test_os.OSErrorTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Str</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Str</span><span class="p">(</span><span class="n">decoded</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNDECODABLE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNDECODABLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memoryview</span><span class="p">(</span><span class="n">encoded</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span>
</div>
<div class="viewcode-block" id="OSErrorTests.test_oserror_filename"><a class="viewcode-back" href="../../test.html#test.test_os.OSErrorTests.test_oserror_filename">[docs]</a>    <span class="k">def</span> <span class="nf">test_oserror_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">,),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">,</span> <span class="mi">0</span><span class="n">o777</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">,),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">,),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;dst&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;dst&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">),</span>
                <span class="c"># Issue #16414: Don&#39;t test undecodable names with listdir()</span>
                <span class="c"># because of a Windows bug.</span>
                <span class="c">#</span>
                <span class="c"># With the ANSI code page 932, os.listdir(b&#39;\xe7&#39;) return an</span>
                <span class="c"># empty list (instead of failing), whereas os.listdir(b&#39;\xff&#39;)</span>
                <span class="c"># raises a FileNotFoundError. It looks like a Windows bug:</span>
                <span class="c"># b&#39;\xe7&#39; directory does not exist, FindFirstFileA(b&#39;\xe7&#39;)</span>
                <span class="c"># fails with ERROR_FILE_NOT_FOUND (2), instead of</span>
                <span class="c"># ERROR_PATH_NOT_FOUND (3).</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">,),</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">,),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">),</span>
            <span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;chown&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;lchown&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">lchown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;truncate&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">truncate</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;chflags&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chflags</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;lchflags&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">lchflags</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;chroot&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">chroot</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;dst&quot;</span><span class="p">))</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;dst&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;listxattr&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listxattr</span><span class="p">,),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getxattr</span><span class="p">,</span> <span class="s">&quot;user.test&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">,</span> <span class="s">&quot;user.test&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;user&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">removexattr</span><span class="p">,</span> <span class="s">&quot;user.test&quot;</span><span class="p">),</span>
            <span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;lchmod&quot;</span><span class="p">):</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">lchmod</span><span class="p">,</span> <span class="mi">0</span><span class="n">o777</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;readlink&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">unicode_filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">func_args</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">func_args</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;No exception thrown by {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
</div></div>
<div class="viewcode-block" id="CPUCountTests"><a class="viewcode-back" href="../../test.html#test.test_os.CPUCountTests">[docs]</a><span class="k">class</span> <span class="nc">CPUCountTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="CPUCountTests.test_cpu_count"><a class="viewcode-back" href="../../test.html#test.test_os.CPUCountTests.test_cpu_count">[docs]</a>    <span class="k">def</span> <span class="nf">test_cpu_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cpus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">cpus</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">cpus</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;Could not determine the number of CPUs&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="FDInheritanceTests"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests">[docs]</a><span class="k">class</span> <span class="nc">FDInheritanceTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="FDInheritanceTests.test_get_set_inheritable"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_get_set_inheritable">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_set_inheritable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">fcntl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;need fcntl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FDInheritanceTests.test_get_inheritable_cloexec"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_get_inheritable_cloexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_inheritable_cloexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

        <span class="c"># clear FD_CLOEXEC flag</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span>
        <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">fcntl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;need fcntl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FDInheritanceTests.test_set_inheritable_cloexec"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_set_inheritable_cloexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_inheritable_cloexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">,</span>
                         <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">,</span>
                         <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FDInheritanceTests.test_open"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_open">[docs]</a>    <span class="k">def</span> <span class="nf">test_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;pipe&#39;</span><span class="p">),</span> <span class="s">&quot;need os.pipe()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FDInheritanceTests.test_pipe"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rfd</span><span class="p">,</span> <span class="n">wfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">rfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">wfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">rfd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">wfd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FDInheritanceTests.test_dup"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_dup">[docs]</a>    <span class="k">def</span> <span class="nf">test_dup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd1</span><span class="p">)</span>

        <span class="n">fd2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">fd1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd2</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;dup2&#39;</span><span class="p">),</span> <span class="s">&quot;need os.dup2()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FDInheritanceTests.test_dup2"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_dup2">[docs]</a>    <span class="k">def</span> <span class="nf">test_dup2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

        <span class="c"># inheritable by default</span>
        <span class="n">fd2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fd2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd2</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd2</span><span class="p">)</span>

        <span class="c"># force non-inheritable</span>
        <span class="n">fd3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fd3</span><span class="p">,</span> <span class="n">inheritable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd3</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd3</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;openpty&#39;</span><span class="p">),</span> <span class="s">&quot;need os.openpty()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FDInheritanceTests.test_openpty"><a class="viewcode-back" href="../../test.html#test.test_os.FDInheritanceTests.test_openpty">[docs]</a>    <span class="k">def</span> <span class="nf">test_openpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">master_fd</span><span class="p">,</span> <span class="n">slave_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">master_fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">slave_fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">master_fd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">slave_fd</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

</div></div>
<span class="nd">@support.reap_threads</span>
<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_os.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span>
        <span class="n">FileTests</span><span class="p">,</span>
        <span class="n">StatAttributeTests</span><span class="p">,</span>
        <span class="n">EnvironTests</span><span class="p">,</span>
        <span class="n">WalkTests</span><span class="p">,</span>
        <span class="n">FwalkTests</span><span class="p">,</span>
        <span class="n">MakedirTests</span><span class="p">,</span>
        <span class="n">DevNullTests</span><span class="p">,</span>
        <span class="n">URandomTests</span><span class="p">,</span>
        <span class="n">ExecTests</span><span class="p">,</span>
        <span class="n">Win32ErrorTests</span><span class="p">,</span>
        <span class="n">TestInvalidFD</span><span class="p">,</span>
        <span class="n">PosixUidGidTests</span><span class="p">,</span>
        <span class="n">Pep383Tests</span><span class="p">,</span>
        <span class="n">Win32KillTests</span><span class="p">,</span>
        <span class="n">Win32ListdirTests</span><span class="p">,</span>
        <span class="n">Win32SymlinkTests</span><span class="p">,</span>
        <span class="n">NonLocalSymlinkTests</span><span class="p">,</span>
        <span class="n">FSEncodingTests</span><span class="p">,</span>
        <span class="n">DeviceEncodingTests</span><span class="p">,</span>
        <span class="n">PidTests</span><span class="p">,</span>
        <span class="n">LoginTests</span><span class="p">,</span>
        <span class="n">LinkTests</span><span class="p">,</span>
        <span class="n">TestSendfile</span><span class="p">,</span>
        <span class="n">ProgramPriorityTests</span><span class="p">,</span>
        <span class="n">ExtendedAttributeTests</span><span class="p">,</span>
        <span class="n">Win32DeprecatedBytesAPI</span><span class="p">,</span>
        <span class="n">TermsizeTests</span><span class="p">,</span>
        <span class="n">OSErrorTests</span><span class="p">,</span>
        <span class="n">RemoveDirsTests</span><span class="p">,</span>
        <span class="n">CPUCountTests</span><span class="p">,</span>
        <span class="n">FDInheritanceTests</span><span class="p">,</span>
    <span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>