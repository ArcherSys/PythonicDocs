

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_peepholer &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_peepholer</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_peepholer</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">dis</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">copysign</span>

<span class="kn">from</span> <span class="nn">test.bytecode_helper</span> <span class="kn">import</span> <span class="n">BytecodeTestCase</span>

<div class="viewcode-block" id="TestTranforms"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms">[docs]</a><span class="k">class</span> <span class="nc">TestTranforms</span><span class="p">(</span><span class="n">BytecodeTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestTranforms.test_unot"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_unot">[docs]</a>    <span class="k">def</span> <span class="nf">test_unot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># UNARY_NOT POP_JUMP_IF_FALSE  --&gt;  POP_JUMP_IF_TRUE&#39;</span>
        <span class="k">def</span> <span class="nf">unot</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">unot</span><span class="p">,</span> <span class="s">&#39;UNARY_NOT&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">unot</span><span class="p">,</span> <span class="s">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">unot</span><span class="p">,</span> <span class="s">&#39;POP_JUMP_IF_TRUE&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_elim_inversion_of_is_or_in"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_elim_inversion_of_is_or_in">[docs]</a>    <span class="k">def</span> <span class="nf">test_elim_inversion_of_is_or_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">cmp_op</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;not a is b&#39;</span><span class="p">,</span> <span class="s">&#39;is not&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;not a in b&#39;</span><span class="p">,</span> <span class="s">&#39;not in&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;not a is not b&#39;</span><span class="p">,</span> <span class="s">&#39;is&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;not a not in b&#39;</span><span class="p">,</span> <span class="s">&#39;in&#39;</span><span class="p">,),</span>
            <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;COMPARE_OP&#39;</span><span class="p">,</span> <span class="n">cmp_op</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_global_as_constant"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_global_as_constant">[docs]</a>    <span class="k">def</span> <span class="nf">test_global_as_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># LOAD_GLOBAL None/True/False  --&gt;  LOAD_CONST None/True/False</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">None</span>
            <span class="bp">None</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">True</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="bp">False</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;LOAD_GLOBAL&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="s">&#39;Adding a docstring made this test fail in Py2.5.0&#39;</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;LOAD_GLOBAL&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_while_one"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_while_one">[docs]</a>    <span class="k">def</span> <span class="nf">test_while_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Skip over:  LOAD_CONST trueconst  POP_JUMP_IF_FALSE xx</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="nb">list</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="s">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_pack_unpack"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_pack_unpack">[docs]</a>    <span class="k">def</span> <span class="nf">test_pack_unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;a, = a,&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;a, b = a, b&#39;</span><span class="p">,</span> <span class="s">&#39;ROT_TWO&#39;</span><span class="p">,),</span>
            <span class="p">(</span><span class="s">&#39;a, b, c = a, b, c&#39;</span><span class="p">,</span> <span class="s">&#39;ROT_THREE&#39;</span><span class="p">,),</span>
            <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BUILD_TUPLE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;UNPACK_TUPLE&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_folding_of_tuples_of_constants"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_folding_of_tuples_of_constants">[docs]</a>    <span class="k">def</span> <span class="nf">test_folding_of_tuples_of_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;a = 1,2,3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;a,b,c = 1,2,3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;(None, 1, None)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;((1, 2), 3, 4)&#39;</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BUILD_TUPLE&#39;</span><span class="p">)</span>

        <span class="c"># Long tuples should be folded too.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">))),</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BUILD_TUPLE&#39;</span><span class="p">)</span>
        <span class="c"># One LOAD_CONST for the tuple, one for the None return value</span>
        <span class="n">load_consts</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                              <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opname</span> <span class="o">==</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">load_consts</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># Bug 1053819:  Tuple of constants misidentified when presented with:</span>
        <span class="c"># . . . opcode_with_arg 100   unary_opcode   BUILD_TUPLE 1  . . .</span>
        <span class="c"># The following would segfault upon compilation</span>
        <span class="k">def</span> <span class="nf">crater</span><span class="p">():</span>
            <span class="p">(</span><span class="o">~</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
            <span class="p">],)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_folding_of_lists_of_constants"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_folding_of_lists_of_constants">[docs]</a>    <span class="k">def</span> <span class="nf">test_folding_of_lists_of_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="c"># in/not in constants with BUILD_LIST should be folded to a tuple:</span>
            <span class="p">(</span><span class="s">&#39;a in [1,2,3]&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;a not in [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;]&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;a in [None, 1, None]&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">&#39;a not in [(1, 2), 3, 4]&#39;</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BUILD_LIST&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_folding_of_sets_of_constants"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_folding_of_sets_of_constants">[docs]</a>    <span class="k">def</span> <span class="nf">test_folding_of_sets_of_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="c"># in/not in constants with BUILD_SET should be folded to a frozenset:</span>
            <span class="p">(</span><span class="s">&#39;a in {1,2,3}&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">})),</span>
            <span class="p">(</span><span class="s">&#39;a not in {&quot;a&quot;,&quot;b&quot;,&quot;c&quot;}&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">})),</span>
            <span class="p">(</span><span class="s">&#39;a in {None, 1, None}&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">})),</span>
            <span class="p">(</span><span class="s">&#39;a not in {(1, 2), 3, 4}&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">({(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">})),</span>
            <span class="p">(</span><span class="s">&#39;a in {1, 2, 3, 3, 2, 1}&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">})),</span>
            <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BUILD_SET&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>

        <span class="c"># Ensure that the resulting code actually works:</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">f</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="TestTranforms.test_folding_of_binops_on_constants"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_folding_of_binops_on_constants">[docs]</a>    <span class="k">def</span> <span class="nf">test_folding_of_binops_on_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;a = 2+3+4&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>                   <span class="c"># chained fold</span>
            <span class="p">(</span><span class="s">&#39;&quot;@&quot;*4&#39;</span><span class="p">,</span> <span class="s">&#39;@@@@&#39;</span><span class="p">),</span>                  <span class="c"># check string ops</span>
            <span class="p">(</span><span class="s">&#39;a=&quot;abc&quot; + &quot;def&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;abcdef&#39;</span><span class="p">),</span>      <span class="c"># check string ops</span>
            <span class="p">(</span><span class="s">&#39;a = 3**4&#39;</span><span class="p">,</span> <span class="mi">81</span><span class="p">),</span>                   <span class="c"># binary power</span>
            <span class="p">(</span><span class="s">&#39;a = 3*4&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>                    <span class="c"># binary multiply</span>
            <span class="p">(</span><span class="s">&#39;a = 13//4&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>                   <span class="c"># binary floor divide</span>
            <span class="p">(</span><span class="s">&#39;a = 14%4&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>                    <span class="c"># binary modulo</span>
            <span class="p">(</span><span class="s">&#39;a = 2+3&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>                     <span class="c"># binary add</span>
            <span class="p">(</span><span class="s">&#39;a = 13-4&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>                    <span class="c"># binary subtract</span>
            <span class="p">(</span><span class="s">&#39;a = (12,13)[1]&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>             <span class="c"># binary subscr</span>
            <span class="p">(</span><span class="s">&#39;a = 13 &lt;&lt; 2&#39;</span><span class="p">,</span> <span class="mi">52</span><span class="p">),</span>                <span class="c"># binary lshift</span>
            <span class="p">(</span><span class="s">&#39;a = 13 &gt;&gt; 2&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>                 <span class="c"># binary rshift</span>
            <span class="p">(</span><span class="s">&#39;a = 13 &amp; 7&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>                  <span class="c"># binary and</span>
            <span class="p">(</span><span class="s">&#39;a = 13 ^ 7&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>                 <span class="c"># binary xor</span>
            <span class="p">(</span><span class="s">&#39;a = 13 | 7&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>                 <span class="c"># binary or</span>
            <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">opname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;BINARY_&#39;</span><span class="p">))</span>

        <span class="c"># Verify that unfoldables are skipped</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;a=2+&quot;b&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>

        <span class="c"># Verify that large sequences do not result from folding</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;a=&quot;x&quot;*1000&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_binary_subscr_on_unicode"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_binary_subscr_on_unicode">[docs]</a>    <span class="k">def</span> <span class="nf">test_binary_subscr_on_unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># valid code get optimized</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;&quot;foo&quot;[0]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BINARY_SUBSCR&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="se">\u0061\uffff</span><span class="s">&quot;[1]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\uffff</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="s">&#39;BINARY_SUBSCR&#39;</span><span class="p">)</span>

        <span class="c"># With PEP 393, non-BMP char get optimized</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="se">\U00012345</span><span class="s">&quot;[0]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\U00012345</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BINARY_SUBSCR&#39;</span><span class="p">)</span>

        <span class="c"># invalid code doesn&#39;t get optimized</span>
        <span class="c"># out of range</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;&quot;fuu&quot;[10]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;BINARY_SUBSCR&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_folding_of_unaryops_on_constants"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_folding_of_unaryops_on_constants">[docs]</a>    <span class="k">def</span> <span class="nf">test_folding_of_unaryops_on_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;-0.5&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span>                     <span class="c"># unary negative</span>
            <span class="p">(</span><span class="s">&#39;-0.0&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0</span><span class="p">),</span>                     <span class="c"># -0.0</span>
            <span class="p">(</span><span class="s">&#39;-(1.0-1.0)&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0</span><span class="p">),</span>               <span class="c"># -0.0 after folding</span>
            <span class="p">(</span><span class="s">&#39;-0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>                          <span class="c"># -0</span>
            <span class="p">(</span><span class="s">&#39;~-2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>                         <span class="c"># unary invert</span>
            <span class="p">(</span><span class="s">&#39;+1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>                          <span class="c"># unary positive</span>
        <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">opname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;UNARY_&#39;</span><span class="p">))</span>

        <span class="c"># Check that -0.0 works after marshaling</span>
        <span class="k">def</span> <span class="nf">negzero</span><span class="p">():</span>
            <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">opname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;UNARY_&#39;</span><span class="p">))</span>

        <span class="c"># Verify that unfoldables are skipped</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">opname</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;-&quot;abc&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;abc&#39;</span><span class="p">,</span> <span class="s">&#39;UNARY_NEGATIVE&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;~&quot;abc&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;abc&#39;</span><span class="p">,</span> <span class="s">&#39;UNARY_INVERT&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertInBytecode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">opname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_elim_extra_return"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_elim_extra_return">[docs]</a>    <span class="k">def</span> <span class="nf">test_elim_extra_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># RETURN LOAD_CONST None RETURN  --&gt;  RETURN</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opname</span> <span class="o">==</span> <span class="s">&#39;RETURN_VALUE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_elim_jump_to_return"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_elim_jump_to_return">[docs]</a>    <span class="k">def</span> <span class="nf">test_elim_jump_to_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># JUMP_FORWARD to RETURN --&gt;  RETURN</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">true_value</span><span class="p">,</span> <span class="n">false_value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">true_value</span> <span class="k">if</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">false_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;JUMP_FORWARD&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opname</span> <span class="o">==</span> <span class="s">&#39;RETURN_VALUE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_elim_jump_after_return1"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_elim_jump_after_return1">[docs]</a>    <span class="k">def</span> <span class="nf">test_elim_jump_after_return1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Eliminate dead code: jumps immediately after returns can&#39;t be reached</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">cond1</span><span class="p">,</span> <span class="n">cond2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cond2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">2</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">4</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">return</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;JUMP_FORWARD&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opname</span> <span class="o">==</span> <span class="s">&#39;RETURN_VALUE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_elim_jump_after_return2"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_elim_jump_after_return2">[docs]</a>    <span class="k">def</span> <span class="nf">test_elim_jump_after_return2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Eliminate dead code: jumps immediately after returns can&#39;t be reached</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">cond1</span><span class="p">,</span> <span class="n">cond2</span><span class="p">):</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;JUMP_FORWARD&#39;</span><span class="p">)</span>
        <span class="c"># There should be one jump for the while loop.</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opname</span> <span class="o">==</span> <span class="s">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span> <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">opname</span> <span class="o">==</span> <span class="s">&#39;RETURN_VALUE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_make_function_doesnt_bail"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_make_function_doesnt_bail">[docs]</a>    <span class="k">def</span> <span class="nf">test_make_function_doesnt_bail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">def</span> <span class="nf">g</span><span class="p">()</span><span class="o">-&gt;</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotInBytecode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;BINARY_ADD&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestTranforms.test_constant_folding"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestTranforms.test_constant_folding">[docs]</a>    <span class="k">def</span> <span class="nf">test_constant_folding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #11244: aggressive constant folding.</span>
        <span class="n">exprs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;3 * -5&#39;</span><span class="p">,</span>
            <span class="s">&#39;-3 * 5&#39;</span><span class="p">,</span>
            <span class="s">&#39;2 * (3 * 4)&#39;</span><span class="p">,</span>
            <span class="s">&#39;(2 * 3) * 4&#39;</span><span class="p">,</span>
            <span class="s">&#39;(-1, 2, 3)&#39;</span><span class="p">,</span>
            <span class="s">&#39;(1, -2, 3)&#39;</span><span class="p">,</span>
            <span class="s">&#39;(1, 2, -3)&#39;</span><span class="p">,</span>
            <span class="s">&#39;(1, 2, -3) * 6&#39;</span><span class="p">,</span>
            <span class="s">&#39;lambda x: x in {(3 * -5) + (-1 - 6), (1, -2, 3) * 2, None}&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;single&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">opname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;UNARY_&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">opname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;BINARY_&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">opname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;BUILD_&#39;</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="TestBuglets"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestBuglets">[docs]</a><span class="k">class</span> <span class="nc">TestBuglets</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestBuglets.test_bug_11510"><a class="viewcode-back" href="../../test.html#test.test_peepholer.TestBuglets.test_bug_11510">[docs]</a>    <span class="k">def</span> <span class="nf">test_bug_11510</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># folded constant set optimization was commingled with the tuple</span>
        <span class="c"># unpacking optimization which would fail if the set had duplicate</span>
        <span class="c"># elements so that the set length was unexpected</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">f</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_peepholer.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>
    <span class="n">test_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">TestTranforms</span><span class="p">,</span> <span class="n">TestBuglets</span><span class="p">)</span>
    <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">test_classes</span><span class="p">)</span>

    <span class="c"># verify reference counting</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&#39;gettotalrefcount&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">gc</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)):</span>
            <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">test_classes</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettotalrefcount</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_main</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>