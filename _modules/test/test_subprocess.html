

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_subprocess &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_subprocess</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_subprocess</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">script_helper</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">selectors</span>
<span class="kn">import</span> <span class="nn">sysconfig</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">mswindows</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Depends on the following external programs: Python</span>
<span class="c">#</span>

<span class="k">if</span> <span class="n">mswindows</span><span class="p">:</span>
    <span class="n">SETBINARY</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;import msvcrt; msvcrt.setmode(sys.stdout.fileno(), &#39;</span>
                                                <span class="s">&#39;os.O_BINARY);&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">SETBINARY</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">mkstemp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="c"># tempfile.mkstemp is not available</span>
    <span class="k">def</span> <span class="nf">mkstemp</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Replacement for mkstemp, calling mktemp.&quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">),</span> <span class="n">fname</span>


<div class="viewcode-block" id="BaseTestCase"><a class="viewcode-back" href="../../test.html#test.test_subprocess.BaseTestCase">[docs]</a><span class="k">class</span> <span class="nc">BaseTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="BaseTestCase.setUp"><a class="viewcode-back" href="../../test.html#test.test_subprocess.BaseTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try to minimize the number of children we have so this test</span>
        <span class="c"># doesn&#39;t crash on some buildbots (Alphas in particular).</span>
        <span class="n">support</span><span class="o">.</span><span class="n">reap_children</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseTestCase.tearDown"><a class="viewcode-back" href="../../test.html#test.test_subprocess.BaseTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">_active</span><span class="p">,</span> <span class="s">&quot;subprocess._active not empty&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseTestCase.assertStderrEqual"><a class="viewcode-back" href="../../test.html#test.test_subprocess.BaseTestCase.assertStderrEqual">[docs]</a>    <span class="k">def</span> <span class="nf">assertStderrEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># In a debug build, stuff like &quot;[6580 refs]&quot; is printed to stderr at</span>
        <span class="c"># shutdown time.  That frustrates tests trying to check stderr produced</span>
        <span class="c"># from a spawned Python process.</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">strip_python_stderr</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="c"># strip_python_stderr also strips whitespace, so we do too.</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PopenTestException"><a class="viewcode-back" href="../../test.html#test.test_subprocess.PopenTestException">[docs]</a><span class="k">class</span> <span class="nc">PopenTestException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="PopenExecuteChildRaises"><a class="viewcode-back" href="../../test.html#test.test_subprocess.PopenExecuteChildRaises">[docs]</a><span class="k">class</span> <span class="nc">PopenExecuteChildRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Popen subclass for testing cleanup of subprocess.PIPE filehandles when</span>
<span class="sd">    _execute_child fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_execute_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PopenTestException</span><span class="p">(</span><span class="s">&quot;Forced Exception for Test&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ProcessTestCase"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase">[docs]</a><span class="k">class</span> <span class="nc">ProcessTestCase</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ProcessTestCase.test_io_buffered_by_default"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_io_buffered_by_default">[docs]</a>    <span class="k">def</span> <span class="nf">test_io_buffered_by_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_io_unbuffered_works"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_io_unbuffered_works">[docs]</a>    <span class="k">def</span> <span class="nf">test_io_unbuffered_works</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_call_seq"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_call_seq">[docs]</a>    <span class="k">def</span> <span class="nf">test_call_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with sequence argument</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">47</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_call_timeout"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_call_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_call_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with timeout argument; we want to test that the child</span>
        <span class="c"># process gets killed when the timeout expires.  If the child isn&#39;t</span>
        <span class="c"># killed, this call will deadlock since subprocess.call waits for the</span>
        <span class="c"># child.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;while True: pass&quot;</span><span class="p">],</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_call_zero"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_call_zero">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_call_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_call() function with zero return code</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                                    <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_call_nonzero"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_call_nonzero">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_call_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_call() function with non-zero return code</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                                   <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">47</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() function with zero return code</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;print(&#39;BDFL&#39;)&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;BDFL&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_nonzero"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_nonzero">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_call() function with non-zero return code</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(5)&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_stderr"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() function stderr redirected to stdout</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.stderr.write(&#39;BDFL&#39;)&quot;</span><span class="p">],</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;BDFL&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_stdin_arg"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_stdin_arg">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_stdin_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() can be called with stdin set to a file</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;pear&#39;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                 <span class="s">&quot;import sys; sys.stdout.write(sys.stdin.read().upper())&quot;</span><span class="p">],</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">tf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;PEAR&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_input_arg"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_input_arg">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_input_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() can be called with input set to a string</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                 <span class="s">&quot;import sys; sys.stdout.write(sys.stdin.read().upper())&quot;</span><span class="p">],</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">b</span><span class="s">&#39;pear&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;PEAR&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_stdout_arg"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_stdout_arg">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_stdout_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() refuses to accept &#39;stdout&#39; argument</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;print(&#39;will not be run&#39;)&quot;</span><span class="p">],</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected ValueError when stdout arg supplied.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_stdin_with_input_arg"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_stdin_with_input_arg">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_stdin_with_input_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() refuses to accept &#39;stdin&#39; with &#39;input&#39;</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;pear&#39;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;print(&#39;will not be run&#39;)&quot;</span><span class="p">],</span>
                    <span class="n">stdin</span><span class="o">=</span><span class="n">tf</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">b</span><span class="s">&#39;hare&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected ValueError when stdin and input args supplied.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;stdin&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;input&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_check_output_timeout"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_check_output_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_output_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check_output() function with timeout arg</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                     <span class="s">&quot;import sys, time</span><span class="se">\n</span><span class="s">&quot;</span>
                     <span class="s">&quot;sys.stdout.write(&#39;BDFL&#39;)</span><span class="se">\n</span><span class="s">&quot;</span>
                     <span class="s">&quot;sys.stdout.flush()</span><span class="se">\n</span><span class="s">&quot;</span>
                     <span class="s">&quot;time.sleep(3600)&quot;</span><span class="p">],</span>
                    <span class="c"># Some heavily loaded buildbots (sparc Debian 3.x) require</span>
                    <span class="c"># this much time to start and print.</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected TimeoutExpired.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;BDFL&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_call_kwargs"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_call_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">test_call_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with keyword args</span>
        <span class="n">newenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newenv</span><span class="p">[</span><span class="s">&quot;FRUIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;banana&quot;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys, os;&#39;</span>
                              <span class="s">&#39;sys.exit(os.getenv(&quot;FRUIT&quot;)==&quot;banana&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">newenv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_invalid_args"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_invalid_args">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Popen() called with invalid arguments should raise TypeError</span>
        <span class="c"># but Popen.__del__ should not complain (issue #12085)</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">captured_stderr</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="n">invalid_arg_name</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">argcount</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="o">.</span><span class="n">__init__</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_argcount</span>
            <span class="n">too_many_args</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">argcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="o">*</span><span class="n">too_many_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdin_none"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdin_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdin_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># .stdin is None when not redirected</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&#39;print(&quot;banana&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_none"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># .stdout is None when not redirected, and the child&#39;s stdout will</span>
        <span class="c"># be inherited from the parent.  In order to test this we run a</span>
        <span class="c"># subprocess in a subprocess:</span>
        <span class="c"># this_test</span>
        <span class="c">#   \-- subprocess created by this test (parent)</span>
        <span class="c">#          \-- subprocess created by the parent subprocess (child)</span>
        <span class="c"># The parent doesn&#39;t specify stdout, so the child will use the</span>
        <span class="c"># parent&#39;s stdout.  This test checks that the message printed by the</span>
        <span class="c"># child goes to the parent stdout.  The parent also checks that the</span>
        <span class="c"># child&#39;s stdout is None.  See #11963.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;import sys; from subprocess import Popen, PIPE;&#39;</span>
                <span class="s">&#39;p = Popen([sys.executable, &quot;-c&quot;, &quot;print(</span><span class="se">\&#39;</span><span class="s">test_stdout_none</span><span class="se">\&#39;</span><span class="s">)&quot;],&#39;</span>
                <span class="s">&#39;          stdin=PIPE, stderr=PIPE);&#39;</span>
                <span class="s">&#39;p.wait(); assert p.stdout is None;&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;test_stdout_none&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stderr_none"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stderr_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_stderr_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># .stderr is None when not redirected</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&#39;print(&quot;banana&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_assert_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># We include sys.exit() to prevent the test runner from hanging</span>
        <span class="c"># whenever python is found.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">pre_args</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>

<div class="viewcode-block" id="ProcessTestCase.test_executable"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_executable">[docs]</a>    <span class="k">def</span> <span class="nf">test_executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that the executable argument works.</span>
        <span class="c">#</span>
        <span class="c"># On Unix (non-Mac and non-Windows), Python looks at args[0] to</span>
        <span class="c"># determine where its standard library is, so we need the directory</span>
        <span class="c"># of args[0] to be valid for the Popen() call to Python to succeed.</span>
        <span class="c"># See also issue #16170 and issue #7774.</span>
        <span class="n">doesnotexist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">),</span>
                                    <span class="s">&quot;doesnotexist&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_python</span><span class="p">([</span><span class="n">doesnotexist</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">],</span> <span class="n">executable</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_executable_takes_precedence"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_executable_takes_precedence">[docs]</a>    <span class="k">def</span> <span class="nf">test_executable_takes_precedence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that the executable argument takes precedence over args[0].</span>
        <span class="c">#</span>
        <span class="c"># Verify first that the call succeeds without the executable arg.</span>
        <span class="n">pre_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_python</span><span class="p">(</span><span class="n">pre_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_python</span><span class="p">,</span> <span class="n">pre_args</span><span class="p">,</span>
                          <span class="n">executable</span><span class="o">=</span><span class="s">&quot;doesnotexist&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;executable argument replaces shell&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_executable_replaces_shell"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_executable_replaces_shell">[docs]</a>    <span class="k">def</span> <span class="nf">test_executable_replaces_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that the executable argument replaces the default shell</span>
        <span class="c"># when shell=True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_python</span><span class="p">([],</span> <span class="n">executable</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># For use in the test_cwd* tests below.</span></div>
    <span class="k">def</span> <span class="nf">_normalize_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cwd</span><span class="p">):</span>
        <span class="c"># Normalize an expected cwd (for Tru64 support).</span>
        <span class="c"># We can&#39;t use os.path.realpath since it doesn&#39;t expand Tru64 {memb}</span>
        <span class="c"># strings.  See bug #1063571.</span>
        <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cwd</span>

    <span class="c"># For use in the test_cwd* tests below.</span>
    <span class="k">def</span> <span class="nf">_split_python_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Return normalized (python_dir, python_base).</span>
        <span class="n">python_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">python_path</span><span class="p">)</span>

    <span class="c"># For use in the test_cwd* tests below.</span>
    <span class="k">def</span> <span class="nf">_assert_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_cwd</span><span class="p">,</span> <span class="n">python_arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Invoke Python via Popen, and assert that (1) the call succeeds,</span>
        <span class="c"># and that (2) the current working directory of the child process</span>
        <span class="c"># matches *expected_cwd*.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">python_arg</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&quot;import os, sys; &quot;</span>
                              <span class="s">&quot;sys.stdout.write(os.getcwd()); &quot;</span>
                              <span class="s">&quot;sys.exit(47)&quot;</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
        <span class="n">normcase</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">normcase</span><span class="p">(</span><span class="n">expected_cwd</span><span class="p">),</span>
                         <span class="n">normcase</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)))</span>

<div class="viewcode-block" id="ProcessTestCase.test_cwd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_cwd">[docs]</a>    <span class="k">def</span> <span class="nf">test_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that cwd changes the cwd for the child process.</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_cwd</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_cwd</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">temp_dir</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;pending resolution of issue #15533&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_cwd_with_relative_arg"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_cwd_with_relative_arg">[docs]</a>    <span class="k">def</span> <span class="nf">test_cwd_with_relative_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that Popen looks for args[0] relative to cwd if args[0]</span>
        <span class="c"># is relative.</span>
        <span class="n">python_dir</span><span class="p">,</span> <span class="n">python_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_python_path</span><span class="p">()</span>
        <span class="n">rel_python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">python_base</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">temp_cwd</span><span class="p">()</span> <span class="k">as</span> <span class="n">wrong_dir</span><span class="p">:</span>
            <span class="c"># Before calling with the correct cwd, confirm that the call fails</span>
            <span class="c"># without cwd and with the wrong cwd.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">rel_python</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">rel_python</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">wrong_dir</span><span class="p">)</span>
            <span class="n">python_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_cwd</span><span class="p">(</span><span class="n">python_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_cwd</span><span class="p">(</span><span class="n">python_dir</span><span class="p">,</span> <span class="n">rel_python</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">python_dir</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;pending resolution of issue #15533&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_cwd_with_relative_executable"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_cwd_with_relative_executable">[docs]</a>    <span class="k">def</span> <span class="nf">test_cwd_with_relative_executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that Popen looks for executable relative to cwd if executable</span>
        <span class="c"># is relative (and that executable takes precedence over args[0]).</span>
        <span class="n">python_dir</span><span class="p">,</span> <span class="n">python_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_python_path</span><span class="p">()</span>
        <span class="n">rel_python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">python_base</span><span class="p">)</span>
        <span class="n">doesntexist</span> <span class="o">=</span> <span class="s">&quot;somethingyoudonthave&quot;</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">temp_cwd</span><span class="p">()</span> <span class="k">as</span> <span class="n">wrong_dir</span><span class="p">:</span>
            <span class="c"># Before calling with the correct cwd, confirm that the call fails</span>
            <span class="c"># without cwd and with the wrong cwd.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">doesntexist</span><span class="p">],</span> <span class="n">executable</span><span class="o">=</span><span class="n">rel_python</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">doesntexist</span><span class="p">],</span> <span class="n">executable</span><span class="o">=</span><span class="n">rel_python</span><span class="p">,</span>
                              <span class="n">cwd</span><span class="o">=</span><span class="n">wrong_dir</span><span class="p">)</span>
            <span class="n">python_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_cwd</span><span class="p">(</span><span class="n">python_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_cwd</span><span class="p">(</span><span class="n">python_dir</span><span class="p">,</span> <span class="n">doesntexist</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">rel_python</span><span class="p">,</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">python_dir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_cwd_with_absolute_arg"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_cwd_with_absolute_arg">[docs]</a>    <span class="k">def</span> <span class="nf">test_cwd_with_absolute_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that Popen can find the executable when the cwd is wrong</span>
        <span class="c"># if args[0] is an absolute path.</span>
        <span class="n">python_dir</span><span class="p">,</span> <span class="n">python_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_python_path</span><span class="p">()</span>
        <span class="n">abs_python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">python_dir</span><span class="p">,</span> <span class="n">python_base</span><span class="p">)</span>
        <span class="n">rel_python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">python_base</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">script_helper</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">()</span> <span class="k">as</span> <span class="n">wrong_dir</span><span class="p">:</span>
            <span class="c"># Before calling with an absolute path, confirm that using a</span>
            <span class="c"># relative path fails.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">rel_python</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">wrong_dir</span><span class="p">)</span>
            <span class="n">wrong_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_cwd</span><span class="p">(</span><span class="n">wrong_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_cwd</span><span class="p">(</span><span class="n">wrong_dir</span><span class="p">,</span> <span class="n">abs_python</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">wrong_dir</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">base_prefix</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                     <span class="s">&#39;Test is not venv-compatible&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_executable_with_cwd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_executable_with_cwd">[docs]</a>    <span class="k">def</span> <span class="nf">test_executable_with_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">python_dir</span><span class="p">,</span> <span class="n">python_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_python_path</span><span class="p">()</span>
        <span class="n">python_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_cwd</span><span class="p">(</span><span class="n">python_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_cwd</span><span class="p">(</span><span class="n">python_dir</span><span class="p">,</span> <span class="s">&quot;somethingyoudonthave&quot;</span><span class="p">,</span>
                         <span class="n">executable</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">python_dir</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">base_prefix</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                     <span class="s">&#39;Test is not venv-compatible&#39;</span><span class="p">)</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">is_python_build</span><span class="p">(),</span>
                     <span class="s">&quot;need an installed Python. See #7774&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_executable_without_cwd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_executable_without_cwd">[docs]</a>    <span class="k">def</span> <span class="nf">test_executable_without_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># For a normal installation, it should work without &#39;cwd&#39;</span>
        <span class="c"># argument.  For test runs in the build directory, see #7774.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_cwd</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">&quot;somethingyoudonthave&quot;</span><span class="p">,</span>
                         <span class="n">executable</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdin_pipe"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdin_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdin_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdin redirection</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                         <span class="s">&#39;import sys; sys.exit(sys.stdin.read() == &quot;pear&quot;)&#39;</span><span class="p">],</span>
                        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;pear&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdin_filedes"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdin_filedes">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdin_filedes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdin is set to open file descriptor</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;pear&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                         <span class="s">&#39;import sys; sys.exit(sys.stdin.read() == &quot;pear&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdin</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdin_fileobj"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdin_fileobj">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdin_fileobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdin is set to open file object</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;pear&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                         <span class="s">&#39;import sys; sys.exit(sys.stdin.read() == &quot;pear&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdin</span><span class="o">=</span><span class="n">tf</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_pipe"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdout redirection</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                          <span class="s">&#39;import sys; sys.stdout.write(&quot;orange&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;orange&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_filedes"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_filedes">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_filedes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdout is set to open file descriptor</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                          <span class="s">&#39;import sys; sys.stdout.write(&quot;orange&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;orange&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_fileobj"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_fileobj">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_fileobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdout is set to open file object</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                          <span class="s">&#39;import sys; sys.stdout.write(&quot;orange&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">tf</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;orange&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stderr_pipe"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stderr_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_stderr_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stderr redirection</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                          <span class="s">&#39;import sys; sys.stderr.write(&quot;strawberry&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;strawberry&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stderr_filedes"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stderr_filedes">[docs]</a>    <span class="k">def</span> <span class="nf">test_stderr_filedes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stderr is set to open file descriptor</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                          <span class="s">&#39;import sys; sys.stderr.write(&quot;strawberry&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;strawberry&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stderr_fileobj"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stderr_fileobj">[docs]</a>    <span class="k">def</span> <span class="nf">test_stderr_fileobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stderr is set to open file object</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                          <span class="s">&#39;import sys; sys.stderr.write(&quot;strawberry&quot;)&#39;</span><span class="p">],</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">tf</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;strawberry&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_stderr_pipe"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_stderr_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_stderr_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># capture stdout and stderr to the same pipe</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;apple&quot;);&#39;</span>
                              <span class="s">&#39;sys.stdout.flush();&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;orange&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;appleorange&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_stderr_file"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_stderr_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_stderr_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># capture stdout and stderr to the same open file</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;apple&quot;);&#39;</span>
                              <span class="s">&#39;sys.stdout.flush();&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;orange&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">tf</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">tf</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;appleorange&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_filedes_of_stdout"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_filedes_of_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_filedes_of_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdout is set to 1 (#1531862).</span>
        <span class="c"># To avoid printing the text on stdout, we do something similar to</span>
        <span class="c"># test_stdout_none (see above).  The parent subprocess calls the child</span>
        <span class="c"># subprocess passing stdout=1, and this test uses stdout=PIPE in</span>
        <span class="c"># order to capture and check the output of the parent. See #11963.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;import sys, subprocess; &#39;</span>
                <span class="s">&#39;rc = subprocess.call([sys.executable, &quot;-c&quot;, &#39;</span>
                <span class="s">&#39;    &quot;import os, sys; sys.exit(os.write(sys.stdout.fileno(), &#39;</span>
                     <span class="s">&#39;b</span><span class="se">\&#39;</span><span class="s">test with stdout=1</span><span class="se">\&#39;</span><span class="s">))&quot;], stdout=1); &#39;</span>
                <span class="s">&#39;assert rc == 18&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;test with stdout=1&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdout_devnull"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdout_devnull">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_devnull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;for i in range(10240):&#39;</span>
                              <span class="s">&#39;print(&quot;x&quot; * 1024)&#39;</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stderr_devnull"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stderr_devnull">[docs]</a>    <span class="k">def</span> <span class="nf">test_stderr_devnull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys</span><span class="se">\n</span><span class="s">&#39;</span>
                              <span class="s">&#39;for i in range(10240):&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;x&quot; * 1024)&#39;</span><span class="p">],</span>
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_stdin_devnull"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_stdin_devnull">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdin_devnull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys;&#39;</span>
                              <span class="s">&#39;sys.stdin.read(1)&#39;</span><span class="p">],</span>
                              <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_env"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_env">[docs]</a>    <span class="k">def</span> <span class="nf">test_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newenv</span><span class="p">[</span><span class="s">&quot;FRUIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;orange&quot;</span>
        <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                               <span class="s">&#39;import sys,os;&#39;</span>
                               <span class="s">&#39;sys.stdout.write(os.getenv(&quot;FRUIT&quot;))&#39;</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">env</span><span class="o">=</span><span class="n">newenv</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;orange&quot;</span><span class="p">)</span>

    <span class="c"># Windows requires at least the SYSTEMROOT environment variable to start</span>
    <span class="c"># Python</span></div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">,</span>
                     <span class="s">&#39;cannot test an empty env on Windows&#39;</span><span class="p">)</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s">&#39;Py_ENABLE_SHARED&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="s">&#39;the python library cannot be loaded &#39;</span>
                     <span class="s">&#39;with an empty environment&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_empty_env"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_empty_env">[docs]</a>    <span class="k">def</span> <span class="nf">test_empty_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                               <span class="s">&#39;import os; &#39;</span>
                               <span class="s">&#39;print(list(os.environ.keys()))&#39;</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">env</span><span class="o">=</span><span class="p">{})</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="p">(</span><span class="n">b</span><span class="s">&quot;[]&quot;</span><span class="p">,</span>
                 <span class="c"># Mac OS X adds __CF_USER_TEXT_ENCODING variable to an empty</span>
                 <span class="c"># environment</span>
                 <span class="n">b</span><span class="s">&quot;[&#39;__CF_USER_TEXT_ENCODING&#39;]&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_stdin"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys;&#39;</span>
                              <span class="s">&#39;sys.exit(sys.stdin.read() == &quot;pear&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;pear&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_stdout"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys; sys.stdout.write(&quot;pineapple&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;pineapple&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_stderr"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys; sys.stderr.write(&quot;pineapple&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;pineapple&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;pineapple&quot;);&#39;</span>
                              <span class="s">&#39;sys.stdout.write(sys.stdin.read())&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;banana&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;banana&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;pineapple&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_timeout"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os,time;&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;pineapple</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;time.sleep(1);&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;pear</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;sys.stdout.write(sys.stdin.read())&#39;</span><span class="p">],</span>
                             <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">,</span> <span class="s">&quot;banana&quot;</span><span class="p">,</span>
                          <span class="n">timeout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="c"># Make sure we can keep waiting for it, and that we get the whole output</span>
        <span class="c"># after it completes.</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;banana&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;pineapple</span><span class="se">\n</span><span class="s">pear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_timeout_large_ouput"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_timeout_large_ouput">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_timeout_large_ouput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test an expiring timeout while the child is outputting lots of data.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os,time;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;a&quot; * (64 * 1024));&#39;</span>
                              <span class="s">&#39;time.sleep(0.2);&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;a&quot; * (64 * 1024));&#39;</span>
                              <span class="s">&#39;time.sleep(0.2);&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;a&quot; * (64 * 1024));&#39;</span>
                              <span class="s">&#39;time.sleep(0.2);&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;a&quot; * (64 * 1024));&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stdout</span><span class="p">),</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>

    <span class="c"># Test for the fd leak reported in http://bugs.python.org/issue2791.</span></div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_pipe_fd_leak"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_pipe_fd_leak">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_pipe_fd_leak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">stdin_pipe</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">stdout_pipe</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">stderr_pipe</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
                    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">stdin_pipe</span><span class="p">:</span>
                        <span class="n">options</span><span class="p">[</span><span class="s">&#39;stdin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                    <span class="k">if</span> <span class="n">stdout_pipe</span><span class="p">:</span>
                        <span class="n">options</span><span class="p">[</span><span class="s">&#39;stdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                    <span class="k">if</span> <span class="n">stderr_pipe</span><span class="p">:</span>
                        <span class="n">options</span><span class="p">[</span><span class="s">&#39;stderr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">((</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_returns"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_returns">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># communicate() should return None if no redirection is active</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">])</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_pipe_buf"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_pipe_buf">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_pipe_buf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># communicate() with writes larger than pipe_buf</span>
        <span class="c"># This test will probably deadlock rather than fail, if</span>
        <span class="c"># communicate() does not work properly.</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(sys.stdin.read(47));&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;x&quot; * </span><span class="si">%d</span><span class="s">);&#39;</span>
                              <span class="s">&#39;sys.stdout.write(sys.stdin.read())&#39;</span> <span class="o">%</span>
                              <span class="n">support</span><span class="o">.</span><span class="n">PIPE_MAX_SIZE</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">string_to_write</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;a&quot;</span> <span class="o">*</span> <span class="n">support</span><span class="o">.</span><span class="n">PIPE_MAX_SIZE</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">string_to_write</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">string_to_write</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_writes_before_communicate"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_writes_before_communicate">[docs]</a>    <span class="k">def</span> <span class="nf">test_writes_before_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># stdin.write before communicate()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(sys.stdin.read())&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;banana&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;split&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;bananasplit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_universal_newlines"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_universal_newlines">[docs]</a>    <span class="k">def</span> <span class="nf">test_universal_newlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span> <span class="o">+</span> <span class="n">SETBINARY</span> <span class="o">+</span>
                              <span class="s">&#39;buf = sys.stdout.buffer;&#39;</span>
                              <span class="s">&#39;buf.write(sys.stdin.readline().encode());&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line2</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(sys.stdin.read().encode());&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line4</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line5</span><span class="se">\\</span><span class="s">r</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line6</span><span class="se">\\</span><span class="s">r&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;</span><span class="se">\\</span><span class="s">nline7&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;</span><span class="se">\\</span><span class="s">nline8&quot;);&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">universal_newlines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;line1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="s">&quot;line1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;line3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span>
                         <span class="s">&quot;line2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                         <span class="s">&quot;line3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                         <span class="s">&quot;line4</span><span class="se">\n</span><span class="s">line5</span><span class="se">\n</span><span class="s">line6</span><span class="se">\n</span><span class="s">line7</span><span class="se">\n</span><span class="s">line8&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_universal_newlines_communicate"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_universal_newlines_communicate">[docs]</a>    <span class="k">def</span> <span class="nf">test_universal_newlines_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># universal newlines through communicate()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span> <span class="o">+</span> <span class="n">SETBINARY</span> <span class="o">+</span>
                              <span class="s">&#39;buf = sys.stdout.buffer;&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line2</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line4</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line5</span><span class="se">\\</span><span class="s">r</span><span class="se">\\</span><span class="s">n&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;line6</span><span class="se">\\</span><span class="s">r&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;</span><span class="se">\\</span><span class="s">nline7&quot;);&#39;</span>
                              <span class="s">&#39;buf.flush();&#39;</span>
                              <span class="s">&#39;buf.write(b&quot;</span><span class="se">\\</span><span class="s">nline8&quot;);&#39;</span><span class="p">],</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">universal_newlines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span>
                         <span class="s">&quot;line2</span><span class="se">\n</span><span class="s">line4</span><span class="se">\n</span><span class="s">line5</span><span class="se">\n</span><span class="s">line6</span><span class="se">\n</span><span class="s">line7</span><span class="se">\n</span><span class="s">line8&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_universal_newlines_communicate_stdin"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_universal_newlines_communicate_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">test_universal_newlines_communicate_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># universal newlines through communicate(), with only stdin</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span> <span class="o">+</span> <span class="n">SETBINARY</span> <span class="o">+</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">                               s = sys.stdin.readline()</span>
<span class="s">                               assert s == &quot;line1</span><span class="se">\\</span><span class="s">n&quot;, repr(s)</span>
<span class="s">                               s = sys.stdin.read()</span>
<span class="s">                               assert s == &quot;line3</span><span class="se">\\</span><span class="s">n&quot;, repr(s)</span>
<span class="s">                              &#39;&#39;&#39;</span><span class="p">)],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">universal_newlines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&quot;line1</span><span class="se">\n</span><span class="s">line3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_universal_newlines_communicate_input_none"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_universal_newlines_communicate_input_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_universal_newlines_communicate_input_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test communicate(input=None) with universal newlines.</span>
        <span class="c">#</span>
        <span class="c"># We set stdout to PIPE because, as of this writing, a different</span>
        <span class="c"># code path is tested when the number of pipes is zero or one.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_universal_newlines_communicate_stdin_stdout_stderr"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_universal_newlines_communicate_stdin_stdout_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">test_universal_newlines_communicate_stdin_stdout_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># universal newlines through communicate(), with stdin, stdout, stderr</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span> <span class="o">+</span> <span class="n">SETBINARY</span> <span class="o">+</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">                               s = sys.stdin.buffer.readline()</span>
<span class="s">                               sys.stdout.buffer.write(s)</span>
<span class="s">                               sys.stdout.buffer.write(b&quot;line2</span><span class="se">\\</span><span class="s">r&quot;)</span>
<span class="s">                               sys.stderr.buffer.write(b&quot;eline2</span><span class="se">\\</span><span class="s">n&quot;)</span>
<span class="s">                               s = sys.stdin.buffer.read()</span>
<span class="s">                               sys.stdout.buffer.write(s)</span>
<span class="s">                               sys.stdout.buffer.write(b&quot;line4</span><span class="se">\\</span><span class="s">n&quot;)</span>
<span class="s">                               sys.stdout.buffer.write(b&quot;line5</span><span class="se">\\</span><span class="s">r</span><span class="se">\\</span><span class="s">n&quot;)</span>
<span class="s">                               sys.stderr.buffer.write(b&quot;eline6</span><span class="se">\\</span><span class="s">r&quot;)</span>
<span class="s">                               sys.stderr.buffer.write(b&quot;eline7</span><span class="se">\\</span><span class="s">r</span><span class="se">\\</span><span class="s">nz&quot;)</span>
<span class="s">                              &#39;&#39;&#39;</span><span class="p">)],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&quot;line1</span><span class="se">\n</span><span class="s">line3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;line1</span><span class="se">\n</span><span class="s">line2</span><span class="se">\n</span><span class="s">line3</span><span class="se">\n</span><span class="s">line4</span><span class="se">\n</span><span class="s">line5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
        <span class="c"># Python debug build push something like &quot;[42442 refs]\n&quot;</span>
        <span class="c"># to stderr at exit of subprocess.</span>
        <span class="c"># Don&#39;t use assertStderrEqual because it strips CR and LF from output.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;eline2</span><span class="se">\n</span><span class="s">eline6</span><span class="se">\n</span><span class="s">eline7</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_universal_newlines_communicate_encodings"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_universal_newlines_communicate_encodings">[docs]</a>    <span class="k">def</span> <span class="nf">test_universal_newlines_communicate_encodings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that universal newlines mode works for various encodings,</span>
        <span class="c"># in particular for encodings in the UTF-16 and UTF-32 families.</span>
        <span class="c"># See issue #15595.</span>
        <span class="c">#</span>
        <span class="c"># UTF-16 and UTF-32-BE are sufficient to check both with BOM and</span>
        <span class="c"># without, and UTF-16 and UTF-32.</span>
        <span class="kn">import</span> <span class="nn">_bootlocale</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;utf-16&#39;</span><span class="p">,</span> <span class="s">&#39;utf-32-be&#39;</span><span class="p">]:</span>
            <span class="n">old_getpreferredencoding</span> <span class="o">=</span> <span class="n">_bootlocale</span><span class="o">.</span><span class="n">getpreferredencoding</span>
            <span class="c"># Indirectly via io.TextIOWrapper, Popen() defaults to</span>
            <span class="c"># locale.getpreferredencoding(False) and earlier in Python 3.2 to</span>
            <span class="c"># locale.getpreferredencoding().</span>
            <span class="k">def</span> <span class="nf">getpreferredencoding</span><span class="p">(</span><span class="n">do_setlocale</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">encoding</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;import sys; &quot;</span>
                    <span class="s">r&quot;sys.stdout.buffer.write(&#39;1\r\n2\r3\n4&#39;.encode(&#39;</span><span class="si">%s</span><span class="s">&#39;))&quot;</span> <span class="o">%</span>
                    <span class="n">encoding</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_bootlocale</span><span class="o">.</span><span class="n">getpreferredencoding</span> <span class="o">=</span> <span class="n">getpreferredencoding</span>
                <span class="c"># We set stdin to be non-None because, as of this writing,</span>
                <span class="c"># a different code path is used when the number of pipes is</span>
                <span class="c"># zero or one.</span>
                <span class="n">popen</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                         <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">popen</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">_bootlocale</span><span class="o">.</span><span class="n">getpreferredencoding</span> <span class="o">=</span> <span class="n">old_getpreferredencoding</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;1</span><span class="se">\n</span><span class="s">2</span><span class="se">\n</span><span class="s">3</span><span class="se">\n</span><span class="s">4&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_no_leaking"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_no_leaking">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_leaking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Make sure we leak no resources</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mswindows</span><span class="p">:</span>
            <span class="n">max_handles</span> <span class="o">=</span> <span class="mi">1026</span> <span class="c"># too much for most UNIX systems</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_handles</span> <span class="o">=</span> <span class="mi">2050</span> <span class="c"># too much for (at least some) Windows setups</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_handles</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
                    <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EMFILE</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;failed to reach the file descriptor limit &quot;</span>
                    <span class="s">&quot;(tried </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">max_handles</span><span class="p">)</span>
            <span class="c"># Close a couple of them (should be enough for a subprocess)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">handles</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="c"># Loop creating some subprocesses. If one of them leaks some fds,</span>
            <span class="c"># the next loop iteration will fail by reaching the max fd limit.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;import sys;&quot;</span>
                                      <span class="s">&quot;sys.stdout.write(sys.stdin.read())&quot;</span><span class="p">],</span>
                                     <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;lime&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;lime&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_list2cmdline"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_list2cmdline">[docs]</a>    <span class="k">def</span> <span class="nf">test_list2cmdline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;a b c&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;&quot;a b c&quot; d e&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;ab&quot;c&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;ab</span><span class="se">\\</span><span class="s">&quot;c </span><span class="se">\\</span><span class="s"> d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;ab&quot;c&#39;</span><span class="p">,</span> <span class="s">&#39; </span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;ab</span><span class="se">\\</span><span class="s">&quot;c &quot; </span><span class="se">\\\\</span><span class="s">&quot; d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;a</span><span class="se">\\\\\\</span><span class="s">b&#39;</span><span class="p">,</span> <span class="s">&#39;de fg&#39;</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;a</span><span class="se">\\\\\\</span><span class="s">b &quot;de fg&quot; h&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;a</span><span class="se">\\</span><span class="s">&quot;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;a</span><span class="se">\\\\\\</span><span class="s">&quot;b c d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;a</span><span class="se">\\\\</span><span class="s">b c&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;&quot;a</span><span class="se">\\\\</span><span class="s">b c&quot; d e&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;a</span><span class="se">\\\\</span><span class="s">b</span><span class="se">\\</span><span class="s"> c&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;&quot;a</span><span class="se">\\\\</span><span class="s">b</span><span class="se">\\</span><span class="s"> c&quot; d e&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">]),</span>
                         <span class="s">&#39;ab &quot;&quot;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_poll"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_poll">[docs]</a>    <span class="k">def</span> <span class="nf">test_poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&quot;import os; os.read(0, 1)&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">())</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="c"># Subsequent invocations should just return the returncode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_wait"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_wait">[docs]</a>    <span class="k">def</span> <span class="nf">test_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># Subsequent invocations should just return the returncode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_wait_timeout"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_wait_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_wait_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
                              <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import time; time.sleep(0.3)&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;0.0001&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>  <span class="c"># For coverage of __str__.</span>
        <span class="c"># Some heavily loaded buildbots (sparc Debian 3.x) require this much</span>
        <span class="c"># time to start.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_invalid_bufsize"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_invalid_bufsize">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_bufsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># an invalid type of the bufsize argument should raise</span>
        <span class="c"># TypeError.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span> <span class="s">&quot;orange&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_bufsize_is_none"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_bufsize_is_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_bufsize_is_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># bufsize=None should be the same as bufsize=0.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># Again with keyword arg</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span> <span class="n">bufsize</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_leaking_fds_on_error"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_leaking_fds_on_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_leaking_fds_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># see bug #5179: Popen leaks file descriptors to PIPEs if</span>
        <span class="c"># the child fails to execute; this will eventually exhaust</span>
        <span class="c"># the maximum number of open fds. 1024 seems a very common</span>
        <span class="c"># value for that limit, but Windows has 2048, so we loop</span>
        <span class="c"># 1024 times (each call leaked two fds).</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;nonexisting_i_hope&#39;</span><span class="p">],</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="c"># ignore errors that indicate the command was not found</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">c</span><span class="o">.</span><span class="n">exception</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">threading</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;threading required&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_double_close_on_error"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_double_close_on_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_double_close_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #18851</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">open_fds</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
                <span class="n">fds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">open_fds</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">EnvironmentError</span><span class="p">):</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;nonexisting_i_hope&#39;</span><span class="p">],</span>
                                 <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">fds</span><span class="p">:</span>
                <span class="c"># If a double close occurred, some of those fds will</span>
                <span class="c"># already have been closed by mistake, and os.close()</span>
                <span class="c"># here will raise.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">threading</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;threading required&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_threadsafe_wait"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_threadsafe_wait">[docs]</a>    <span class="k">def</span> <span class="nf">test_threadsafe_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue21291: Popen.wait() needs to be threadsafe for returncode.&quot;&quot;&quot;</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;import time; time.sleep(12)&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">kill_proc_timer_thread</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;thread-start-poll-result&#39;</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()))</span>
            <span class="c"># terminate it from the thread and wait for the result.</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;thread-after-kill-and-wait&#39;</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
            <span class="c"># this wait should be a no-op given the above.</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;thread-after-second-wait&#39;</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>

        <span class="c"># This is a timing sensitive test, the failure mode is</span>
        <span class="c"># triggered when both the main thread and this thread are in</span>
        <span class="c"># the wait() call at once.  The delay here is to allow the</span>
        <span class="c"># main thread to most likely be blocked in its wait() call.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">kill_proc_timer_thread</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mswindows</span><span class="p">:</span>
            <span class="n">expected_errorcode</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Should be -9 because of the proc.kill() from the thread.</span>
            <span class="n">expected_errorcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>

        <span class="c"># Wait for the process to finish; the thread should kill it</span>
        <span class="c"># long before it finishes on its own.  Supplying a timeout</span>
        <span class="c"># triggers a different code path for better coverage.</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">expected_errorcode</span><span class="p">,</span>
                         <span class="n">msg</span><span class="o">=</span><span class="s">&quot;unexpected result in wait from main thread&quot;</span><span class="p">)</span>

        <span class="c"># This should be a no-op with no change in returncode.</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">expected_errorcode</span><span class="p">,</span>
                         <span class="n">msg</span><span class="o">=</span><span class="s">&quot;unexpected result in second main wait.&quot;</span><span class="p">)</span>

        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="c"># Ensure that all of the thread results are as expected.</span>
        <span class="c"># When a race condition occurs in wait(), the returncode could</span>
        <span class="c"># be set by the wrong thread that doesn&#39;t actually have it</span>
        <span class="c"># leading to an incorrect value.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([(</span><span class="s">&#39;thread-start-poll-result&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                          <span class="p">(</span><span class="s">&#39;thread-after-kill-and-wait&#39;</span><span class="p">,</span> <span class="n">expected_errorcode</span><span class="p">),</span>
                          <span class="p">(</span><span class="s">&#39;thread-after-second-wait&#39;</span><span class="p">,</span> <span class="n">expected_errorcode</span><span class="p">)],</span>
                         <span class="n">results</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_issue8780"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_issue8780">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue8780</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Ensure that stdout is inherited from the parent</span>
        <span class="c"># if stdout=PIPE is not used</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s">&#39;import subprocess, sys&#39;</span><span class="p">,</span>
            <span class="s">&#39;retcode = subprocess.call(&#39;</span>
                <span class="s">&quot;[sys.executable, &#39;-c&#39;, &#39;print(</span><span class="se">\&quot;</span><span class="s">Hello World!</span><span class="se">\&quot;</span><span class="s">)&#39;])&quot;</span><span class="p">,</span>
            <span class="s">&#39;assert retcode == 0&#39;</span><span class="p">))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Hello World!&#39;</span><span class="p">),</span> <span class="n">ascii</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_handles_closed_on_exception"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_handles_closed_on_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test_handles_closed_on_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># If CreateProcess exits with an error, ensure the</span>
        <span class="c"># duplicate output handles are released</span>
        <span class="n">ifhandle</span><span class="p">,</span> <span class="n">ifname</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">ofhandle</span><span class="p">,</span> <span class="n">ofname</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">efhandle</span><span class="p">,</span> <span class="n">efname</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span> <span class="p">([</span><span class="s">&quot;*&quot;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">ifhandle</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">ofhandle</span><span class="p">,</span>
              <span class="n">stderr</span><span class="o">=</span><span class="n">efhandle</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">ifhandle</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">ofhandle</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ofname</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">efhandle</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">efname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ifname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ofname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">efname</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_epipe"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_epipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_epipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 10963: communicate() should hide EPIPE</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&#39;pass&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_epipe_only_stdin"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_epipe_only_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_epipe_only_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 10963: communicate() should hide EPIPE</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&#39;pass&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;SIGUSR1&#39;</span><span class="p">),</span>
                         <span class="s">&quot;Requires signal.SIGUSR1&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;kill&#39;</span><span class="p">),</span>
                         <span class="s">&quot;Requires os.kill&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;getppid&#39;</span><span class="p">),</span>
                         <span class="s">&quot;Requires os.getppid&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_communicate_eintr"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_communicate_eintr">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_eintr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12493: communicate() should handle EINTR</span>
        <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">old_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">old_handler</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                <span class="s">&#39;import os, signal;&#39;</span>
                <span class="s">&#39;os.kill(os.getppid(), signal.SIGUSR1)&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">):</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="n">stream</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">}</span>
            <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">as</span> <span class="n">process</span><span class="p">:</span>
                <span class="c"># communicate() will be interrupted by SIGUSR1</span>
                <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>


    <span class="c"># This test is Linux-ish specific for simplicity to at least have</span>
    <span class="c"># some coverage.  It is not a platform specific bug.</span></div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;/proc/</span><span class="si">%d</span><span class="s">/fd&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()),</span>
                         <span class="s">&quot;Linux specific&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCase.test_failed_child_execute_fd_leak"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCase.test_failed_child_execute_fd_leak">[docs]</a>    <span class="k">def</span> <span class="nf">test_failed_child_execute_fd_leak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test for the fork() failure fd leak reported in issue16327.&quot;&quot;&quot;</span>
        <span class="n">fd_directory</span> <span class="o">=</span> <span class="s">&#39;/proc/</span><span class="si">%d</span><span class="s">/fd&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">fds_before_popen</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fd_directory</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">PopenTestException</span><span class="p">):</span>
            <span class="n">PopenExecuteChildRaises</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;pass&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="c"># NOTE: This test doesn&#39;t verify that the real _execute_child</span>
        <span class="c"># does not close the file descriptors itself on the way out</span>
        <span class="c"># during an exception.  Code inspection has confirmed that.</span>

        <span class="n">fds_after_exception</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fd_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fds_before_popen</span><span class="p">,</span> <span class="n">fds_after_exception</span><span class="p">)</span>
</div></div>
<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;POSIX specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="POSIXProcessTestCase"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase">[docs]</a><span class="k">class</span> <span class="nc">POSIXProcessTestCase</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="POSIXProcessTestCase.setUp"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span> <span class="o">=</span> <span class="s">&quot;/_this/pa.th/does/not/exist&quot;</span>
</div>
    <span class="k">def</span> <span class="nf">_get_chdir_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># This avoids hard coding the errno value or the OS perror()</span>
            <span class="c"># string and instead capture the exception that we want to see</span>
            <span class="c"># below for comparison.</span>
            <span class="n">desired_exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">desired_exception</span><span class="o">.</span><span class="n">strerror</span> <span class="o">+=</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;chdir to nonexistant directory </span><span class="si">%s</span><span class="s"> succeeded.&quot;</span> <span class="o">%</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">desired_exception</span>

<div class="viewcode-block" id="POSIXProcessTestCase.test_exception_cwd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_exception_cwd">[docs]</a>    <span class="k">def</span> <span class="nf">test_exception_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test error in the child raised in the parent for a bad cwd.&quot;&quot;&quot;</span>
        <span class="n">desired_exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_chdir_exception</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">],</span>
                                 <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Test that the child process chdir failure actually makes</span>
            <span class="c"># it up to the parent process as the correct exception.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">desired_exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">desired_exception</span><span class="o">.</span><span class="n">strerror</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected OSError: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">desired_exception</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_exception_bad_executable"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_exception_bad_executable">[docs]</a>    <span class="k">def</span> <span class="nf">test_exception_bad_executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test error in the child raised in the parent for a bad executable.&quot;&quot;&quot;</span>
        <span class="n">desired_exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_chdir_exception</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">],</span>
                                 <span class="n">executable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Test that the child process exec failure actually makes</span>
            <span class="c"># it up to the parent process as the correct exception.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">desired_exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">desired_exception</span><span class="o">.</span><span class="n">strerror</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected OSError: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">desired_exception</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_exception_bad_args_0"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_exception_bad_args_0">[docs]</a>    <span class="k">def</span> <span class="nf">test_exception_bad_args_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test error in the child raised in the parent for a bad args[0].&quot;&quot;&quot;</span>
        <span class="n">desired_exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_chdir_exception</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_nonexistent_dir</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Test that the child process exec failure actually makes</span>
            <span class="c"># it up to the parent process as the correct exception.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">desired_exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">desired_exception</span><span class="o">.</span><span class="n">strerror</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected OSError: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">desired_exception</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_restore_signals"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_restore_signals">[docs]</a>    <span class="k">def</span> <span class="nf">test_restore_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Code coverage for both values of restore_signals to make sure it</span>
        <span class="c"># at least does not blow up.</span>
        <span class="c"># A test for behavior would be complex.  Contributions welcome.</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">],</span> <span class="n">restore_signals</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">],</span> <span class="n">restore_signals</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_start_new_session"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_start_new_session">[docs]</a>    <span class="k">def</span> <span class="nf">test_start_new_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># For code coverage of calling setsid().  We don&#39;t care if we get an</span>
        <span class="c"># EPERM error from it depending on the test execution environment, that</span>
        <span class="c"># still indicates that it was called.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                     <span class="s">&quot;import os; print(os.getpgid(os.getpid()))&quot;</span><span class="p">],</span>
                    <span class="n">start_new_session</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_pgid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpgid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">child_pgid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">parent_pgid</span><span class="p">,</span> <span class="n">child_pgid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_run_abort"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_run_abort">[docs]</a>    <span class="k">def</span> <span class="nf">test_run_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># returncode handles signal termination</span>
        <span class="k">with</span> <span class="n">support</span><span class="o">.</span><span class="n">SuppressCrashReport</span><span class="p">():</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                                  <span class="s">&#39;import os; os.abort()&#39;</span><span class="p">])</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_preexec"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_preexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_preexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># DISCLAIMER: Setting environment variables is *not* a good use</span>
        <span class="c"># of a preexec_fn.  This is merely a test.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys,os;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(os.getenv(&quot;FRUIT&quot;))&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">putenv</span><span class="p">(</span><span class="s">&quot;FRUIT&quot;</span><span class="p">,</span> <span class="s">&quot;apple&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_preexec_exception"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_preexec_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test_preexec_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">raise_it</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;What if two swallows carried a coconut?&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">],</span>
                                 <span class="n">preexec_fn</span><span class="o">=</span><span class="n">raise_it</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">SubprocessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">_posixsubprocess</span><span class="p">,</span>
                    <span class="s">&quot;Expected a ValueError from the preexec_fn&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;coconut&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Exception raised by preexec_fn did not make it &quot;</span>
                      <span class="s">&quot;to the parent process.&quot;</span><span class="p">)</span>
</div>
    <span class="k">class</span> <span class="nc">_TestExecuteChildPopen</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used to test behavior at the end of _execute_child.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_testcase</span> <span class="o">=</span> <span class="n">testcase</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_execute_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="o">.</span><span class="n">_execute_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c"># Open a bunch of file descriptors and verify that</span>
                <span class="c"># none of them are the same as the ones the Popen</span>
                <span class="c"># instance is using for stdin/stdout/stderr.</span>
                <span class="n">devzero_fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/zero&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">devzero_fds</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_testcase</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
                                <span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span>
                                <span class="n">msg</span><span class="o">=</span><span class="s">&quot;At least one fd was closed early.&quot;</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">devzero_fds</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&quot;/dev/zero&quot;</span><span class="p">),</span> <span class="s">&quot;/dev/zero required.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="POSIXProcessTestCase.test_preexec_errpipe_does_not_double_close_pipes"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_preexec_errpipe_does_not_double_close_pipes">[docs]</a>    <span class="k">def</span> <span class="nf">test_preexec_errpipe_does_not_double_close_pipes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue16140: Don&#39;t double close pipes on preexec error.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">raise_it</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">SubprocessError</span><span class="p">(</span>
                    <span class="s">&quot;force the _execute_child() errpipe_data path.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">SubprocessError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TestExecuteChildPopen</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span>
                        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="n">raise_it</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_preexec_gc_module_failure"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_preexec_gc_module_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test_preexec_gc_module_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This tests the code that disables garbage collection if the child</span>
        <span class="c"># process will execute any Python.</span>
        <span class="k">def</span> <span class="nf">raise_runtime_error</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;this shouldn&#39;t escape&quot;</span><span class="p">)</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">()</span>
        <span class="n">orig_gc_disable</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">disable</span>
        <span class="n">orig_gc_isenabled</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">())</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span>
                            <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">(),</span>
                             <span class="s">&quot;Popen enabled gc when it shouldn&#39;t.&quot;</span><span class="p">)</span>

            <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">())</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span>
                            <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">(),</span> <span class="s">&quot;Popen left gc disabled.&quot;</span><span class="p">)</span>

            <span class="n">gc</span><span class="o">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">raise_runtime_error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span>
                              <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

            <span class="k">del</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span>  <span class="c"># force an AttributeError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span>
                              <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">orig_gc_disable</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span> <span class="o">=</span> <span class="n">orig_gc_isenabled</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">:</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_args_string"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_args_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_args_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># args is a string</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">()</span>
        <span class="c"># reopen in text mode</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;surrogateescape&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="n">fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;#!/bin/sh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;exec &#39;</span><span class="si">%s</span><span class="s">&#39; -c &#39;import sys; sys.exit(47)&#39;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                       <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">47</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_invalid_args"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_invalid_args">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># invalid arguments should raise ValueError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                           <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">],</span>
                          <span class="n">startupinfo</span><span class="o">=</span><span class="mi">47</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                           <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">],</span>
                          <span class="n">creationflags</span><span class="o">=</span><span class="mi">47</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_shell_sequence"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_shell_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">test_shell_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Run command through the shell (sequence)</span>
        <span class="n">newenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newenv</span><span class="p">[</span><span class="s">&quot;FRUIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;apple&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&quot;echo $FRUIT&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">newenv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">b</span><span class="s">&quot; </span><span class="se">\t\r\n\f</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_shell_string"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_shell_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_shell_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Run command through the shell (string)</span>
        <span class="n">newenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newenv</span><span class="p">[</span><span class="s">&quot;FRUIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;apple&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;echo $FRUIT&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">newenv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">b</span><span class="s">&quot; </span><span class="se">\t\r\n\f</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_call_string"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_call_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_call_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with string argument on UNIX</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">()</span>
        <span class="c"># reopen in text mode</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&quot;surrogateescape&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="n">fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;#!/bin/sh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;exec &#39;</span><span class="si">%s</span><span class="s">&#39; -c &#39;import sys; sys.exit(47)&#39;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                       <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">47</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_specific_shell"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_specific_shell">[docs]</a>    <span class="k">def</span> <span class="nf">test_specific_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #9265: Incorrect name passed as arg[0].</span>
        <span class="n">shells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;/bin&#39;</span><span class="p">,</span> <span class="s">&#39;/usr/bin/&#39;</span><span class="p">,</span> <span class="s">&#39;/usr/local/bin&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;bash&#39;</span><span class="p">,</span> <span class="s">&#39;ksh&#39;</span><span class="p">]:</span>
                <span class="n">sh</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sh</span><span class="p">):</span>
                    <span class="n">shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shells</span><span class="p">:</span> <span class="c"># Will probably work for any shell but csh.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;bash or ksh required for this test&quot;</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="s">&#39;/bin/sh&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">sh</span><span class="p">):</span>
            <span class="c"># Test will fail if /bin/sh is a symlink to csh.</span>
            <span class="n">shells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="n">shells</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;echo $0&quot;</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">sh</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_kill_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># Do not inherit file handles from the parent.</span>
        <span class="c"># It should fix failures on some platforms.</span>
        <span class="c"># Also set the SIGINT handler to the default to make sure it&#39;s not</span>
        <span class="c"># being ignored (some tests rely on that.)</span>
        <span class="n">old_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">default_int_handler</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">                                 import sys, time</span>
<span class="s">                                 sys.stdout.write(&#39;x</span><span class="se">\\</span><span class="s">n&#39;)</span>
<span class="s">                                 sys.stdout.flush()</span>
<span class="s">                                 time.sleep(30)</span>
<span class="s">                                 &quot;&quot;&quot;</span><span class="p">],</span>
                                 <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">old_handler</span><span class="p">)</span>
        <span class="c"># Wait for the interpreter to be completely initialized before</span>
        <span class="c"># sending any signal.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s">&#39;netbsd&#39;</span><span class="p">,</span> <span class="s">&#39;openbsd&#39;</span><span class="p">)),</span>
                     <span class="s">&quot;Due to known OS bug (issue #16762)&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_kill_dead_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># Do not inherit file handles from the parent.</span>
        <span class="c"># It should fix failures on some platforms.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">                             import sys, time</span>
<span class="s">                             sys.stdout.write(&#39;x</span><span class="se">\\</span><span class="s">n&#39;)</span>
<span class="s">                             sys.stdout.flush()</span>
<span class="s">                             &quot;&quot;&quot;</span><span class="p">],</span>
                             <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="c"># Wait for the interpreter to be completely initialized before</span>
        <span class="c"># sending any signal.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># The process should end after this</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># This shouldn&#39;t raise even though the child is now dead</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

<div class="viewcode-block" id="POSIXProcessTestCase.test_send_signal"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_send_signal">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_process</span><span class="p">(</span><span class="s">&#39;send_signal&#39;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;KeyboardInterrupt&#39;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_kill"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_kill">[docs]</a>    <span class="k">def</span> <span class="nf">test_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_process</span><span class="p">(</span><span class="s">&#39;kill&#39;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="o">-</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_terminate"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_terminate">[docs]</a>    <span class="k">def</span> <span class="nf">test_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill_process</span><span class="p">(</span><span class="s">&#39;terminate&#39;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="o">-</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_send_signal_dead"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_send_signal_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_signal_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Sending a signal to a dead process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_dead_process</span><span class="p">(</span><span class="s">&#39;send_signal&#39;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_kill_dead"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_kill_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_kill_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Killing a dead process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_dead_process</span><span class="p">(</span><span class="s">&#39;kill&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_terminate_dead"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_terminate_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_terminate_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Terminating a dead process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_dead_process</span><span class="p">(</span><span class="s">&#39;terminate&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_save_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_fds</span><span class="p">):</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">save_fds</span><span class="p">:</span>
            <span class="n">inheritable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">fds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fd</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">inheritable</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fds</span>

    <span class="k">def</span> <span class="nf">_restore_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">inheritable</span> <span class="ow">in</span> <span class="n">fds</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">saved</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">inheritable</span><span class="o">=</span><span class="n">inheritable</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">saved</span><span class="p">)</span>

<div class="viewcode-block" id="POSIXProcessTestCase.check_close_std_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.check_close_std_fds">[docs]</a>    <span class="k">def</span> <span class="nf">check_close_std_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fds</span><span class="p">):</span>
        <span class="c"># Issue #9905: test that subprocess pipes still work properly with</span>
        <span class="c"># some standard fds closed</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">saved_fds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_fds</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">inheritable</span> <span class="ow">in</span> <span class="n">saved_fds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stdin</span> <span class="o">=</span> <span class="n">saved</span>
                <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">fds</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;apple&quot;);&#39;</span>
                              <span class="s">&#39;sys.stdout.flush();&#39;</span>
                              <span class="s">&#39;sys.stderr.write(&quot;orange&quot;)&#39;</span><span class="p">],</span>
                       <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
                       <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                       <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">strip_python_stderr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;apple&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;orange&#39;</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_fds</span><span class="p">(</span><span class="n">saved_fds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fd_0"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fd_0">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fd_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fd_1"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fd_1">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fd_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fd_2"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fd_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fd_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds_0_1"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds_0_1">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds_0_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds_0_2"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds_0_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds_0_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds_1_2"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds_1_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds_1_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds_0_1_2"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds_0_1_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds_0_1_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #10806: test that subprocess pipes still work properly with</span>
        <span class="c"># all standard fds closed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_close_std_fds</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_small_errpipe_write_fd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_small_errpipe_write_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_small_errpipe_write_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue #15798: Popen should work when stdio fds are available.&quot;&quot;&quot;</span>
        <span class="n">new_stdin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Side test: if errpipe_write fails to have its CLOEXEC</span>
            <span class="c"># flag set this should cause the parent to think the exec</span>
            <span class="c"># failed.  Extremely unlikely: everyone supports CLOEXEC.</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                    <span class="s">&quot;print(&#39;AssertionError:0:CLOEXEC failure.&#39;)&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c"># Restore original stdin and stdout</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">new_stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">new_stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">new_stdin</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">new_stdout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_remapping_std_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_remapping_std_fds">[docs]</a>    <span class="k">def</span> <span class="nf">test_remapping_std_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># open up some temporary files</span>
        <span class="n">temps</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkstemp</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temp_fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span> <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">]</span>

            <span class="c"># unlink the files -- we won&#39;t need to reopen them</span>
            <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="c"># write some data to what will become stdin, and rewind</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="s">&quot;STDIN&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c"># move the standard file descriptors out of the way</span>
            <span class="n">saved_fds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_fds</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># duplicate the file objects over the standard fd&#39;s</span>
                <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">temp_fd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temp_fds</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">temp_fd</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

                <span class="c"># now use those files in the &quot;wrong&quot; order, so that subprocess</span>
                <span class="c"># has to rearrange them in the child</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                    <span class="s">&#39;import sys; got = sys.stdin.read();&#39;</span>
                    <span class="s">&#39;sys.stdout.write(&quot;got </span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%g</span><span class="s">ot); sys.stderr.write(&quot;err&quot;)&#39;</span><span class="p">],</span>
                    <span class="n">stdin</span><span class="o">=</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_restore_fds</span><span class="p">(</span><span class="n">saved_fds</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">temp_fds</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">strip_python_stderr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">temp_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1024</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;got STDIN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;err&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">temp_fds</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.check_swap_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.check_swap_fds">[docs]</a>    <span class="k">def</span> <span class="nf">check_swap_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdin_no</span><span class="p">,</span> <span class="n">stdout_no</span><span class="p">,</span> <span class="n">stderr_no</span><span class="p">):</span>
        <span class="c"># open up some temporary files</span>
        <span class="n">temps</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkstemp</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">temp_fds</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span> <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># unlink the files -- we won&#39;t need to reopen them</span>
            <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temps</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="c"># save a copy of the standard file descriptors</span>
            <span class="n">saved_fds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_fds</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># duplicate the temp files over the standard fd&#39;s 0, 1, 2</span>
                <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">temp_fd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temp_fds</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">temp_fd</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

                <span class="c"># write some data to what will become stdin, and rewind</span>
                <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stdin_no</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;STDIN&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">stdin_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c"># now use those files in the given order, so that subprocess</span>
                <span class="c"># has to rearrange them in the child</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                    <span class="s">&#39;import sys; got = sys.stdin.read();&#39;</span>
                    <span class="s">&#39;sys.stdout.write(&quot;got </span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%g</span><span class="s">ot); sys.stderr.write(&quot;err&quot;)&#39;</span><span class="p">],</span>
                    <span class="n">stdin</span><span class="o">=</span><span class="n">stdin_no</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_no</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_no</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">temp_fds</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stdout_no</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">strip_python_stderr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">stderr_no</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_restore_fds</span><span class="p">(</span><span class="n">saved_fds</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;got STDIN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;err&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">temp_fds</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c"># When duping fds, if there arises a situation where one of the fds is</span>
    <span class="c"># either 0, 1 or 2, it is possible that it is overwritten (#12607).</span>
    <span class="c"># This tests all combinations of this.</span></div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_swap_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_swap_fds">[docs]</a>    <span class="k">def</span> <span class="nf">test_swap_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_swap_fds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_swap_fds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_swap_fds</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_swap_fds</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_swap_fds</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_swap_fds</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_surrogates_error_message"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_surrogates_error_message">[docs]</a>    <span class="k">def</span> <span class="nf">test_surrogates_error_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">prepare</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;surrogate:</span><span class="se">\uDCff</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span>
                <span class="n">preexec_fn</span><span class="o">=</span><span class="n">prepare</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c"># Pure Python implementations keeps the message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">_posixsubprocess</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="s">&quot;surrogate:</span><span class="se">\uDCff</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">SubprocessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c"># _posixsubprocess uses a default message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">_posixsubprocess</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="s">&quot;Exception occurred in preexec_fn.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected ValueError or subprocess.SubprocessError&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_undecodable_env"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_undecodable_env">[docs]</a>    <span class="k">def</span> <span class="nf">test_undecodable_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">((</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;abc</span><span class="se">\uDCFF</span><span class="s">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;test</span><span class="se">\uDCFF</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;42&#39;</span><span class="p">)):</span>
            <span class="n">encoded_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="s">&quot;surrogateescape&quot;</span><span class="p">)</span>

            <span class="c"># test str with surrogates</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;import os; print(ascii(os.getenv(</span><span class="si">%s</span><span class="s">)))&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c"># Use C locale to get ASCII for the locale encoding to force</span>
            <span class="c"># surrogate-escaping of \xFF in the child process; otherwise it can</span>
            <span class="c"># be decoded as-is if the default locale is latin-1.</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&#39;LC_ALL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;aix&quot;</span><span class="p">):</span>
                <span class="c"># On AIX, the C locale uses the Latin1 encoding</span>
                <span class="n">decoded_value</span> <span class="o">=</span> <span class="n">encoded_value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;latin1&quot;</span><span class="p">,</span> <span class="s">&quot;surrogateescape&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># On other UNIXes, the C locale uses the ASCII encoding</span>
                <span class="n">decoded_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">],</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n\r</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">ascii</span><span class="p">(</span><span class="n">decoded_value</span><span class="p">))</span>

            <span class="c"># test bytes</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="s">&quot;surrogateescape&quot;</span><span class="p">)</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;import os; print(ascii(os.getenvb(</span><span class="si">%s</span><span class="s">)))&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded_value</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">],</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n\r</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">ascii</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_bytes_program"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_bytes_program">[docs]</a>    <span class="k">def</span> <span class="nf">test_bytes_program</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">abs_program</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">program</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">program</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>

        <span class="c"># absolute bytes path</span>
        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">abs_program</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># absolute bytes path as a string</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">abs_program</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;&#39; -c pass&quot;</span>
        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># bytes program, unicode PATH</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># bytes program, bytes PATH</span>
        <span class="n">envb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">envb</span><span class="p">[</span><span class="n">b</span><span class="s">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">program</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;pass&quot;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">envb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_pipe_cloexec"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_pipe_cloexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_pipe_cloexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sleeper</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;input_reader.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>
        <span class="n">fd_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;fd_status.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">sleeper</span><span class="p">],</span>
                              <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">communicate</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="n">p2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fd_status</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">result_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>
        <span class="n">unwanted_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">p1</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
                            <span class="n">p1</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">()])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result_fds</span> <span class="o">&amp;</span> <span class="n">unwanted_fds</span><span class="p">,</span>
                         <span class="s">&quot;Expected no fds from </span><span class="si">%r</span><span class="s"> to be open in child, &quot;</span>
                         <span class="s">&quot;found </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">unwanted_fds</span><span class="p">,</span> <span class="n">result_fds</span> <span class="o">&amp;</span> <span class="n">unwanted_fds</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_pipe_cloexec_real_tools"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_pipe_cloexec_real_tools">[docs]</a>    <span class="k">def</span> <span class="nf">test_pipe_cloexec_real_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qcat</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;qcat.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>
        <span class="n">qgrep</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;qgrep.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="n">subdata</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;zxcvbn&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">subdata</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">qcat</span><span class="p">],</span>
                              <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">p2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">qgrep</span><span class="p">,</span> <span class="n">subdata</span><span class="p">],</span>
                              <span class="n">stdin</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">kill_p1</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p1</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">kill_p2</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p2</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">kill_p1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">kill_p2</span><span class="p">)</span>

        <span class="n">p1</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">readfiles</span><span class="p">,</span> <span class="n">ignored1</span><span class="p">,</span> <span class="n">ignored2</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">p2</span><span class="o">.</span><span class="n">stdout</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">readfiles</span><span class="p">,</span> <span class="s">&quot;The child hung&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">p1</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;fd_status.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="n">fds</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">open_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span>
        <span class="c"># add a bunch more fds</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
            <span class="n">open_fds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">open_fds</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fd_status</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">ignored</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">remaining_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">remaining_fds</span> <span class="o">&amp;</span> <span class="n">open_fds</span><span class="p">,</span> <span class="n">open_fds</span><span class="p">,</span>
                         <span class="s">&quot;Some fds were closed&quot;</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fd_status</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">ignored</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">remaining_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">remaining_fds</span> <span class="o">&amp;</span> <span class="n">open_fds</span><span class="p">,</span>
                         <span class="s">&quot;Some fds were left open&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">remaining_fds</span><span class="p">,</span> <span class="s">&quot;Subprocess failed&quot;</span><span class="p">)</span>

        <span class="c"># Keep some of the fd&#39;s we opened open in the subprocess.</span>
        <span class="c"># This tests _posixsubprocess.c&#39;s proper handling of fds_to_keep.</span>
        <span class="n">fds_to_keep</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">open_fds</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fd_status</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">pass_fds</span><span class="o">=</span><span class="p">())</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">ignored</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">remaining_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">remaining_fds</span> <span class="o">&amp;</span> <span class="n">fds_to_keep</span> <span class="o">&amp;</span> <span class="n">open_fds</span><span class="p">,</span>
                         <span class="s">&quot;Some fds not in pass_fds were left open&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">remaining_fds</span><span class="p">,</span> <span class="s">&quot;Subprocess failed&quot;</span><span class="p">)</span>

</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;freebsd&quot;</span><span class="p">)</span> <span class="ow">and</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&quot;/dev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">st_dev</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&quot;/dev/fd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">st_dev</span><span class="p">,</span>
                     <span class="s">&quot;Requires fdescfs mounted on /dev/fd on FreeBSD.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds_when_max_fd_is_lowered"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds_when_max_fd_is_lowered">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds_when_max_fd_is_lowered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Confirm that issue21618 is fixed (may fail under valgrind).&quot;&quot;&quot;</span>
        <span class="n">fd_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;fd_status.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="c"># This launches the meat of the test in a child process to</span>
        <span class="c"># avoid messing with the larger unittest processes maximum</span>
        <span class="c"># number of file descriptors.</span>
        <span class="c">#  This process launches:</span>
        <span class="c">#  +--&gt; Process that lowers its RLIMIT_NOFILE aftr setting up</span>
        <span class="c">#    a bunch of high open fds above the new lower rlimit.</span>
        <span class="c">#    Those are reported via stdout before launching a new</span>
        <span class="c">#    process with close_fds=False to run the actual test:</span>
        <span class="c">#    +--&gt; The TEST: This one launches a fd_status.py</span>
        <span class="c">#      subprocess with close_fds=True so we can find out if</span>
        <span class="c">#      any of the fds above the lowered rlimit are still open.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        import os, resource, subprocess, sys, textwrap</span>
<span class="sd">        open_fds = set()</span>
<span class="sd">        # Add a bunch more fds to pass down.</span>
<span class="sd">        for _ in range(40):</span>
<span class="sd">            fd = os.open(&quot;/dev/null&quot;, os.O_RDONLY)</span>
<span class="sd">            open_fds.add(fd)</span>

<span class="sd">        # Leave a two pairs of low ones available for use by the</span>
<span class="sd">        # internal child error pipe and the stdout pipe.</span>
<span class="sd">        # We also leave 10 more open as some Python buildbots run into</span>
<span class="sd">        # &quot;too many open files&quot; errors during the test if we do not.</span>
<span class="sd">        for fd in sorted(open_fds)[:14]:</span>
<span class="sd">            os.close(fd)</span>
<span class="sd">            open_fds.remove(fd)</span>

<span class="sd">        for fd in open_fds:</span>
<span class="sd">            #self.addCleanup(os.close, fd)</span>
<span class="sd">            os.set_inheritable(fd, True)</span>

<span class="sd">        max_fd_open = max(open_fds)</span>

<span class="sd">        # Communicate the open_fds to the parent unittest.TestCase process.</span>
<span class="sd">        print(&#39;,&#39;.join(map(str, sorted(open_fds))))</span>
<span class="sd">        sys.stdout.flush()</span>

<span class="sd">        rlim_cur, rlim_max = resource.getrlimit(resource.RLIMIT_NOFILE)</span>
<span class="sd">        try:</span>
<span class="sd">            # 29 is lower than the highest fds we are leaving open.</span>
<span class="sd">            resource.setrlimit(resource.RLIMIT_NOFILE, (29, rlim_max))</span>
<span class="sd">            # Launch a new Python interpreter with our low fd rlim_cur that</span>
<span class="sd">            # inherits open fds above that limit.  It then uses subprocess</span>
<span class="sd">            # with close_fds=True to get a report of open fds in the child.</span>
<span class="sd">            # An explicit list of fds to check is passed to fd_status.py as</span>
<span class="sd">            # letting fd_status rely on its default logic would miss the</span>
<span class="sd">            # fds above rlim_cur as it normally only checks up to that limit.</span>
<span class="sd">            subprocess.Popen(</span>
<span class="sd">                [sys.executable, &#39;-c&#39;,</span>
<span class="sd">                 textwrap.dedent(&quot;&quot;&quot;</span>
<span class="sd">                     import subprocess, sys</span>
<span class="sd">                     subprocess.Popen([sys.executable, %r] +</span>
<span class="sd">                                      [str(x) for x in range({max_fd})],</span>
<span class="sd">                                      close_fds=True).wait()</span>
<span class="sd">                     &quot;&quot;&quot;.format(max_fd=max_fd_open+1))],</span>
<span class="sd">                close_fds=False).wait()</span>
<span class="sd">        finally:</span>
<span class="sd">            resource.setrlimit(resource.RLIMIT_NOFILE, (rlim_cur, rlim_max))</span>
<span class="sd">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">fd_status</span><span class="p">)],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="n">output</span><span class="p">,</span> <span class="n">unused_stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">output_lines</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_lines</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">msg</span><span class="o">=</span><span class="s">&quot;expected exactly two lines of output:</span><span class="se">\n</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">opened_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>
        <span class="n">remaining_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">remaining_fds</span> <span class="o">&amp;</span> <span class="n">opened_fds</span><span class="p">,</span>
                         <span class="n">msg</span><span class="o">=</span><span class="s">&quot;Some fds were left open.&quot;</span><span class="p">)</span>


    <span class="c"># Mac OS X Tiger (10.4) has a kernel bug: sometimes, the file</span>
    <span class="c"># descriptor of a pipe closed in the parent process is valid in the</span>
    <span class="c"># child process according to fstat(), but the mode of the file</span>
    <span class="c"># descriptor is invalid, and read or write raise an error.</span></div>
    <span class="nd">@support.requires_mac_ver</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<div class="viewcode-block" id="POSIXProcessTestCase.test_pass_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_pass_fds">[docs]</a>    <span class="k">def</span> <span class="nf">test_pass_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;fd_status.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="n">open_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">fds</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">open_fds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">open_fds</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fd_status</span><span class="p">],</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">pass_fds</span><span class="o">=</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">ignored</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

            <span class="n">remaining_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>
            <span class="n">to_be_closed</span> <span class="o">=</span> <span class="n">open_fds</span> <span class="o">-</span> <span class="p">{</span><span class="n">fd</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">remaining_fds</span><span class="p">,</span> <span class="s">&quot;fd to be passed not passed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">remaining_fds</span> <span class="o">&amp;</span> <span class="n">to_be_closed</span><span class="p">,</span>
                             <span class="s">&quot;fd to be closed passed&quot;</span><span class="p">)</span>

            <span class="c"># pass_fds overrides close_fds with a warning.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">RuntimeWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                        <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pass_fds</span><span class="o">=</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;overriding close_fds&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">warning</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_pass_fds_inheritable"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_pass_fds_inheritable">[docs]</a>    <span class="k">def</span> <span class="nf">test_pass_fds_inheritable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;fd_status.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="n">inheritable</span><span class="p">,</span> <span class="n">non_inheritable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">inheritable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">non_inheritable</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">inheritable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="n">non_inheritable</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">pass_fds</span> <span class="o">=</span> <span class="p">(</span><span class="n">inheritable</span><span class="p">,</span> <span class="n">non_inheritable</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">script</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pass_fds</span><span class="p">))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">pass_fds</span><span class="o">=</span><span class="n">pass_fds</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">ignored</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>

        <span class="c"># the inheritable file descriptor must be inherited, so its inheritable</span>
        <span class="c"># flag must be set in the child process after fork() and before exec()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">pass_fds</span><span class="p">),</span> <span class="s">&quot;output=%a&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>

        <span class="c"># inheritable flag must not be changed in the parent process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">inheritable</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(</span><span class="n">non_inheritable</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_stdout_stdin_are_single_inout_fd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_stdout_stdin_are_single_inout_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_stdin_are_single_inout_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inout</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">inout</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">inout</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_stdout_stderr_are_single_inout_fd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_stdout_stderr_are_single_inout_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_stdout_stderr_are_single_inout_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inout</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                                 <span class="n">stdout</span><span class="o">=</span><span class="n">inout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">inout</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_stderr_stdin_are_single_inout_fd"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_stderr_stdin_are_single_inout_fd">[docs]</a>    <span class="k">def</span> <span class="nf">test_stderr_stdin_are_single_inout_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inout</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">inout</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">inout</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_wait_when_sigchild_ignored"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_wait_when_sigchild_ignored">[docs]</a>    <span class="k">def</span> <span class="nf">test_wait_when_sigchild_ignored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># NOTE: sigchild_ignore.py may not be an effective test on all OSes.</span>
        <span class="n">sigchild_ignore</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;sigchild_ignore.py&quot;</span><span class="p">,</span>
                                           <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">sigchild_ignore</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="s">&quot;sigchild_ignore.py exited&quot;</span>
                         <span class="s">&quot; non-zero with this error:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                         <span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_select_unbuffered"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_select_unbuffered">[docs]</a>    <span class="k">def</span> <span class="nf">test_select_unbuffered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #11459: bufsize=0 should really set the pipes as</span>
        <span class="c"># unbuffered (and therefore let select() work properly).</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s">&quot;select&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys;&#39;</span>
                              <span class="s">&#39;sys.stdout.write(&quot;apple&quot;)&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;appl&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_zombie_fast_process_del"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_zombie_fast_process_del">[docs]</a>    <span class="k">def</span> <span class="nf">test_zombie_fast_process_del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12650: on Unix, if Popen.__del__() was called before the</span>
        <span class="c"># process exited, it wouldn&#39;t be added to subprocess._active, and would</span>
        <span class="c"># remain a zombie.</span>
        <span class="c"># spawn a Popen, and delete its reference before it exits</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import sys, time;&#39;</span>
                              <span class="s">&#39;time.sleep(0.2)&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span>
        <span class="k">del</span> <span class="n">p</span>
        <span class="c"># check that p is in the active processes list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_active</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_leak_fast_process_del_killed"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_leak_fast_process_del_killed">[docs]</a>    <span class="k">def</span> <span class="nf">test_leak_fast_process_del_killed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #12650: on Unix, if Popen.__del__() was called before the</span>
        <span class="c"># process exited, and the process got killed by a signal, it would never</span>
        <span class="c"># be removed from subprocess._active, which triggered a FD and memory</span>
        <span class="c"># leak.</span>
        <span class="c"># spawn a Popen, delete its reference and kill it</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&#39;import time;&#39;</span>
                              <span class="s">&#39;time.sleep(3)&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span>
        <span class="k">del</span> <span class="n">p</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
        <span class="c"># check that p is in the active processes list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_active</span><span class="p">])</span>

        <span class="c"># let some time for the process to exit, and create a new Popen: this</span>
        <span class="c"># should trigger the wait() of p</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;nonexisting_i_hope&#39;</span><span class="p">],</span>
                                  <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                  <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c"># p should have been wait()ed on, and removed from the _active list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_active</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="POSIXProcessTestCase.test_close_fds_after_preexec"><a class="viewcode-back" href="../../test.html#test.test_subprocess.POSIXProcessTestCase.test_close_fds_after_preexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds_after_preexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">findfile</span><span class="p">(</span><span class="s">&quot;fd_status.py&quot;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s">&quot;subprocessdata&quot;</span><span class="p">)</span>

        <span class="c"># this FD is used as dup2() target by preexec_fn, and should be closed</span>
        <span class="c"># in the child process</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fd_status</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fd</span><span class="p">))</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">ignored</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="n">remaining_fds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">remaining_fds</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;Windows specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Win32ProcessTestCase"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase">[docs]</a><span class="k">class</span> <span class="nc">Win32ProcessTestCase</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="Win32ProcessTestCase.test_startupinfo"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_startupinfo">[docs]</a>    <span class="k">def</span> <span class="nf">test_startupinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># startupinfo argument</span>
        <span class="c"># We uses hardcoded constants, because we do not want to</span>
        <span class="c"># depend on win32all.</span>
        <span class="n">STARTF_USESHOWWINDOW</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">SW_MAXIMIZE</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">startupinfo</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
        <span class="n">startupinfo</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span>
        <span class="n">startupinfo</span><span class="o">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_MAXIMIZE</span>
        <span class="c"># Since Python is a console process, it won&#39;t be affected</span>
        <span class="c"># by wShowWindow, but the argument should be silently</span>
        <span class="c"># ignored</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;import sys; sys.exit(0)&quot;</span><span class="p">],</span>
                        <span class="n">startupinfo</span><span class="o">=</span><span class="n">startupinfo</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_creationflags"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_creationflags">[docs]</a>    <span class="k">def</span> <span class="nf">test_creationflags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># creationflags argument</span>
        <span class="n">CREATE_NEW_CONSOLE</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;    a DOS box should flash briefly ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span> <span class="o">+</span>
                        <span class="s">&#39; -c &quot;import time; time.sleep(0.25)&quot;&#39;</span><span class="p">,</span>
                        <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NEW_CONSOLE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_invalid_args"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_invalid_args">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># invalid arguments should raise ValueError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                           <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">],</span>
                          <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                           <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">],</span>
                          <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                          <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_close_fds"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_close_fds">[docs]</a>    <span class="k">def</span> <span class="nf">test_close_fds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># close file descriptors</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&quot;import sys; sys.exit(47)&quot;</span><span class="p">],</span>
                              <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">47</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_shell_sequence"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_shell_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">test_shell_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Run command through the shell (sequence)</span>
        <span class="n">newenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newenv</span><span class="p">[</span><span class="s">&quot;FRUIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;physalis&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&quot;set&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">newenv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;physalis&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_shell_string"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_shell_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_shell_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Run command through the shell (string)</span>
        <span class="n">newenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newenv</span><span class="p">[</span><span class="s">&quot;FRUIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;physalis&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">newenv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;physalis&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_call_string"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_call_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_call_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with string argument on Windows</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span> <span class="o">+</span>
                             <span class="s">&#39; -c &quot;import sys; sys.exit(47)&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">47</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_kill_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># Some win32 buildbot raises EOFError if stdin is inherited</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">                             import sys, time</span>
<span class="s">                             sys.stdout.write(&#39;x</span><span class="se">\\</span><span class="s">n&#39;)</span>
<span class="s">                             sys.stdout.flush()</span>
<span class="s">                             time.sleep(30)</span>
<span class="s">                             &quot;&quot;&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="c"># Wait for the interpreter to be completely initialized before</span>
        <span class="c"># sending any signal.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">returncode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_kill_dead_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;if 1:</span>
<span class="s">                             import sys, time</span>
<span class="s">                             sys.stdout.write(&#39;x</span><span class="se">\\</span><span class="s">n&#39;)</span>
<span class="s">                             sys.stdout.flush()</span>
<span class="s">                             sys.exit(42)</span>
<span class="s">                             &quot;&quot;&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="c"># Wait for the interpreter to be completely initialized before</span>
        <span class="c"># sending any signal.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># The process should end after this</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># This shouldn&#39;t raise even though the child is now dead</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>

<div class="viewcode-block" id="Win32ProcessTestCase.test_send_signal"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_send_signal">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_process</span><span class="p">(</span><span class="s">&#39;send_signal&#39;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_kill"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_kill">[docs]</a>    <span class="k">def</span> <span class="nf">test_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_process</span><span class="p">(</span><span class="s">&#39;kill&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_terminate"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_terminate">[docs]</a>    <span class="k">def</span> <span class="nf">test_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_process</span><span class="p">(</span><span class="s">&#39;terminate&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_send_signal_dead"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_send_signal_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_signal_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_dead_process</span><span class="p">(</span><span class="s">&#39;send_signal&#39;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_kill_dead"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_kill_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_kill_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_dead_process</span><span class="p">(</span><span class="s">&#39;kill&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Win32ProcessTestCase.test_terminate_dead"><a class="viewcode-back" href="../../test.html#test.test_subprocess.Win32ProcessTestCase.test_terminate_dead">[docs]</a>    <span class="k">def</span> <span class="nf">test_terminate_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill_dead_process</span><span class="p">(</span><span class="s">&#39;terminate&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="CommandTests"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandTests">[docs]</a><span class="k">class</span> <span class="nc">CommandTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="CommandTests.test_getoutput"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandTests.test_getoutput">[docs]</a>    <span class="k">def</span> <span class="nf">test_getoutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">&#39;echo xyzzy&#39;</span><span class="p">),</span> <span class="s">&#39;xyzzy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span><span class="s">&#39;echo xyzzy&#39;</span><span class="p">),</span>
                         <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;xyzzy&#39;</span><span class="p">))</span>

        <span class="c"># we use mkdtemp in the next line to create an empty directory</span>
        <span class="c"># under our exclusive control; from that, we can invent a pathname</span>
        <span class="c"># that we _know_ won&#39;t exist.  This is guaranteed to fail.</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&quot;type &quot;</span> <span class="k">if</span> <span class="n">mswindows</span> <span class="k">else</span> <span class="s">&quot;cat &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">selectors</span><span class="p">,</span> <span class="s">&#39;PollSelector&#39;</span><span class="p">),</span>
                     <span class="s">&quot;Test needs selectors.PollSelector&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProcessTestCaseNoPoll"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCaseNoPoll">[docs]</a><span class="k">class</span> <span class="nc">ProcessTestCaseNoPoll</span><span class="p">(</span><span class="n">ProcessTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ProcessTestCaseNoPoll.setUp"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCaseNoPoll.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_selector</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_PopenSelector</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">_PopenSelector</span> <span class="o">=</span> <span class="n">selectors</span><span class="o">.</span><span class="n">SelectSelector</span>
        <span class="n">ProcessTestCase</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProcessTestCaseNoPoll.tearDown"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ProcessTestCaseNoPoll.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">_PopenSelector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_selector</span>
        <span class="n">ProcessTestCase</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="HelperFunctionTests"><a class="viewcode-back" href="../../test.html#test.test_subprocess.HelperFunctionTests">[docs]</a><span class="k">class</span> <span class="nc">HelperFunctionTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;errno and EINTR make no sense on windows&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="HelperFunctionTests.test_eintr_retry_call"><a class="viewcode-back" href="../../test.html#test.test_subprocess.HelperFunctionTests.test_eintr_retry_call">[docs]</a>    <span class="k">def</span> <span class="nf">test_eintr_retry_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">fake_os_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">record_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">,</span> <span class="s">&quot;fake interrupted system call&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">999</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
                         <span class="n">subprocess</span><span class="o">.</span><span class="n">_eintr_retry_call</span><span class="p">(</span><span class="n">fake_os_func</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">999</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">999</span><span class="p">)],</span> <span class="n">record_calls</span><span class="p">)</span>
        <span class="c"># This time there will be an EINTR so it will loop once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">666</span><span class="p">,),</span>
                         <span class="n">subprocess</span><span class="o">.</span><span class="n">_eintr_retry_call</span><span class="p">(</span><span class="n">fake_os_func</span><span class="p">,</span> <span class="mi">666</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">999</span><span class="p">),</span> <span class="p">(</span><span class="mi">666</span><span class="p">,),</span> <span class="p">(</span><span class="mi">666</span><span class="p">,)],</span> <span class="n">record_calls</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">mswindows</span><span class="p">,</span> <span class="s">&quot;Windows-specific tests&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CommandsWithSpaces"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces">[docs]</a><span class="k">class</span> <span class="nc">CommandsWithSpaces</span> <span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="CommandsWithSpaces.setUp"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">mkstemp</span><span class="p">(</span><span class="s">&quot;.py&quot;</span><span class="p">,</span> <span class="s">&quot;te st&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span> <span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;import sys;&quot;</span>
                    <span class="n">b</span><span class="s">&quot;sys.stdout.write(&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39; % (len(sys.argv), [a.lower () for a in sys.argv]))&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommandsWithSpaces.tearDown"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CommandsWithSpaces.with_spaces"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.with_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">with_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;stdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
          <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span> <span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;mbcs&quot;</span><span class="p">),</span>
          <span class="s">&quot;2 [</span><span class="si">%r</span><span class="s">, &#39;ab cd&#39;]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="CommandsWithSpaces.test_shell_string_with_spaces"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.test_shell_string_with_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">test_shell_string_with_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with string argument with spaces on Windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_spaces</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                                             <span class="s">&quot;ab cd&quot;</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommandsWithSpaces.test_shell_sequence_with_spaces"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.test_shell_sequence_with_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">test_shell_sequence_with_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with sequence argument with spaces on Windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_spaces</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;ab cd&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CommandsWithSpaces.test_noshell_string_with_spaces"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.test_noshell_string_with_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">test_noshell_string_with_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with string argument with spaces on Windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_spaces</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                             <span class="s">&quot;ab cd&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CommandsWithSpaces.test_noshell_sequence_with_spaces"><a class="viewcode-back" href="../../test.html#test.test_subprocess.CommandsWithSpaces.test_noshell_sequence_with_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">test_noshell_sequence_with_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># call() function with sequence argument with spaces on Windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_spaces</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;ab cd&quot;</span><span class="p">])</span>

</div></div>
<div class="viewcode-block" id="ContextManagerTests"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ContextManagerTests">[docs]</a><span class="k">class</span> <span class="nc">ContextManagerTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ContextManagerTests.test_pipe"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ContextManagerTests.test_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">test_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                               <span class="s">&quot;import sys;&quot;</span>
                               <span class="s">&quot;sys.stdout.write(&#39;stdout&#39;);&quot;</span>
                               <span class="s">&quot;sys.stderr.write(&#39;stderr&#39;);&quot;</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                              <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;stdout&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertStderrEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;stderr&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextManagerTests.test_returncode"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ContextManagerTests.test_returncode">[docs]</a>    <span class="k">def</span> <span class="nf">test_returncode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                               <span class="s">&quot;import sys; sys.exit(100)&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c"># __exit__ calls wait(), so the returncode should be set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextManagerTests.test_communicate_stdin"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ContextManagerTests.test_communicate_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">test_communicate_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span>
                              <span class="s">&quot;import sys;&quot;</span>
                              <span class="s">&quot;sys.exit(sys.stdin.read() == &#39;context&#39;)&quot;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;context&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContextManagerTests.test_invalid_args"><a class="viewcode-back" href="../../test.html#test.test_subprocess.ContextManagerTests.test_invalid_args">[docs]</a>    <span class="k">def</span> <span class="nf">test_invalid_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;nonexisting_i_hope&#39;</span><span class="p">],</span>
                                  <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                  <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
                <span class="k">pass</span>

</div></div>
<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_subprocess.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="n">unit_tests</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessTestCase</span><span class="p">,</span>
                  <span class="n">POSIXProcessTestCase</span><span class="p">,</span>
                  <span class="n">Win32ProcessTestCase</span><span class="p">,</span>
                  <span class="n">CommandTests</span><span class="p">,</span>
                  <span class="n">ProcessTestCaseNoPoll</span><span class="p">,</span>
                  <span class="n">HelperFunctionTests</span><span class="p">,</span>
                  <span class="n">CommandsWithSpaces</span><span class="p">,</span>
                  <span class="n">ContextManagerTests</span><span class="p">,</span>
                  <span class="p">)</span>

    <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">unit_tests</span><span class="p">)</span>
    <span class="n">support</span><span class="o">.</span><span class="n">reap_children</span><span class="p">()</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>