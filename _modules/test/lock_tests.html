

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.lock_tests &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.lock_tests</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.lock_tests</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Various tests for synchronization primitives.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">_thread</span> <span class="kn">import</span> <span class="n">start_new_thread</span><span class="p">,</span> <span class="n">TIMEOUT_MAX</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>


<span class="k">def</span> <span class="nf">_wait</span><span class="p">():</span>
    <span class="c"># A crude wait/yield function not relying on synchronization primitives.</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<div class="viewcode-block" id="Bunch"><a class="viewcode-back" href="../../test.html#test.lock_tests.Bunch">[docs]</a><span class="k">class</span> <span class="nc">Bunch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A bunch of threads.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">wait_before_exit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a bunch of `n` threads running the same function `f`.</span>
<span class="sd">        If `wait_before_exit` is True, the threads won&#39;t terminate until</span>
<span class="sd">        do_finish() is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_can_exit</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">wait_before_exit</span>
        <span class="k">def</span> <span class="nf">task</span><span class="p">():</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_exit</span><span class="p">:</span>
                    <span class="n">_wait</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">start_new_thread</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="p">())</span>

<div class="viewcode-block" id="Bunch.wait_for_started"><a class="viewcode-back" href="../../test.html#test.lock_tests.Bunch.wait_for_started">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Bunch.wait_for_finished"><a class="viewcode-back" href="../../test.html#test.lock_tests.Bunch.wait_for_finished">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Bunch.do_finish"><a class="viewcode-back" href="../../test.html#test.lock_tests.Bunch.do_finish">[docs]</a>    <span class="k">def</span> <span class="nf">do_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_can_exit</span> <span class="o">=</span> <span class="bp">True</span>

</div></div>
<div class="viewcode-block" id="BaseTestCase"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseTestCase">[docs]</a><span class="k">class</span> <span class="nc">BaseTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="BaseTestCase.setUp"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">threading_setup</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseTestCase.tearDown"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">)</span>
        <span class="n">support</span><span class="o">.</span><span class="n">reap_children</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseTestCase.assertTimeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseTestCase.assertTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">assertTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="c"># The waiting and/or time.time() can be imprecise, which</span>
        <span class="c"># is why comparing to the expected value would sometimes fail</span>
        <span class="c"># (especially under Windows).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="c"># Test nothing insane happened</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="BaseLockTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests">[docs]</a><span class="k">class</span> <span class="nc">BaseLockTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for both recursive and non-recursive locks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseLockTests.test_constructor"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">lock</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_repr"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="nb">repr</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">lock</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_acquire_destroy"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_acquire_destroy">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">lock</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_acquire_release"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_acquire_release">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">lock</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_try_acquire"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_try_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_try_acquire_contended"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_try_acquire_contended">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_acquire_contended</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_acquire_contended"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_acquire_contended">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_contended</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">finished</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">finished</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_with"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_with">[docs]</a>    <span class="k">def</span> <span class="nf">test_with</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">_with</span><span class="p">(</span><span class="n">err</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
        <span class="n">_with</span><span class="p">()</span>
        <span class="c"># Check the lock is unacquired</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">_with</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span>
        <span class="c"># Check the lock is unacquired</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_thread_leak"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_thread_leak">[docs]</a>    <span class="k">def</span> <span class="nf">test_thread_leak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The lock shouldn&#39;t leak a Thread instance when used from a foreign</span>
        <span class="c"># (non-threading) thread.</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">())</span>
        <span class="c"># We run many threads in the hope that existing threads ids won&#39;t</span>
        <span class="c"># be recycled.</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">())</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
            <span class="c"># There is a small window during which a Thread instance&#39;s</span>
            <span class="c"># target function has finished running, but the Thread is still</span>
            <span class="c"># alive and registered.  Avoid spurious failures by waiting a</span>
            <span class="c"># bit more (seen on a buildbot).</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="BaseLockTests.test_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseLockTests.test_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="c"># Can&#39;t set timeout if not blocking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># Invalid timeout values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1e100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># TIMEOUT_MAX is ok</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT_MAX</span><span class="p">)</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c"># Just a sanity test that it didn&#39;t actually wait for the timeout.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTimeout</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.5</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="LockTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.LockTests">[docs]</a><span class="k">class</span> <span class="nc">LockTests</span><span class="p">(</span><span class="n">BaseLockTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for non-recursive, weak locks</span>
<span class="sd">    (which can be acquired and released from different threads).</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LockTests.test_reacquire"><a class="viewcode-back" href="../../test.html#test.lock_tests.LockTests.test_reacquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_reacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Lock needs to be released before re-acquiring.</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">start_new_thread</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LockTests.test_different_thread"><a class="viewcode-back" href="../../test.html#test.lock_tests.LockTests.test_different_thread">[docs]</a>    <span class="k">def</span> <span class="nf">test_different_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Lock can be released from a different thread.</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="LockTests.test_state_after_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.LockTests.test_state_after_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_after_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #11618: check that lock is in a proper state after a</span>
        <span class="c"># (non-zero) timeout.</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">locked</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="RLockTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.RLockTests">[docs]</a><span class="k">class</span> <span class="nc">RLockTests</span><span class="p">(</span><span class="n">BaseLockTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for recursive locks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RLockTests.test_reacquire"><a class="viewcode-back" href="../../test.html#test.lock_tests.RLockTests.test_reacquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_reacquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RLockTests.test_release_unacquired"><a class="viewcode-back" href="../../test.html#test.lock_tests.RLockTests.test_release_unacquired">[docs]</a>    <span class="k">def</span> <span class="nf">test_release_unacquired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Cannot release an unacquired lock</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RLockTests.test_release_save_unacquired"><a class="viewcode-back" href="../../test.html#test.lock_tests.RLockTests.test_release_save_unacquired">[docs]</a>    <span class="k">def</span> <span class="nf">test_release_save_unacquired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Cannot _release_save an unacquired lock</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">_release_save</span><span class="p">)</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">_release_save</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RLockTests.test_different_thread"><a class="viewcode-back" href="../../test.html#test.lock_tests.RLockTests.test_different_thread">[docs]</a>    <span class="k">def</span> <span class="nf">test_different_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Cannot release from a different thread</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">do_finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RLockTests.test__is_owned"><a class="viewcode-back" href="../../test.html#test.lock_tests.RLockTests.test__is_owned">[docs]</a>    <span class="k">def</span> <span class="nf">test__is_owned</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locktype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">())</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">())</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">())</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">())</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">())</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">_is_owned</span><span class="p">())</span>

</div></div>
<div class="viewcode-block" id="EventTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.EventTests">[docs]</a><span class="k">class</span> <span class="nc">EventTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for Event objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EventTests.test_is_set"><a class="viewcode-back" href="../../test.html#test.lock_tests.EventTests.test_is_set">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">_check_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="c"># All threads get notified</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
            <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results2</span><span class="p">,</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>

<div class="viewcode-block" id="EventTests.test_notify"><a class="viewcode-back" href="../../test.html#test.lock_tests.EventTests.test_notify">[docs]</a>    <span class="k">def</span> <span class="nf">test_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_notify</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="c"># Another time, after an explicit clear()</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_notify</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EventTests.test_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.EventTests.test_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventtype</span><span class="p">()</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">results2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTimeout</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="c"># The event is set</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">results2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EventTests.test_set_and_clear"><a class="viewcode-back" href="../../test.html#test.lock_tests.EventTests.test_set_and_clear">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_and_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #13502: check that wait() returns true even when the event is</span>
        <span class="c"># cleared before the waiting thread is woken up.</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventtype</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ConditionTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests">[docs]</a><span class="k">class</span> <span class="nc">ConditionTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for condition variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConditionTests.test_acquire"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="c"># Be default we have an RLock: the condition can be acquired multiple</span>
        <span class="c"># times.</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ConditionTests.test_unacquired_wait"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_unacquired_wait">[docs]</a>    <span class="k">def</span> <span class="nf">test_unacquired_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConditionTests.test_unacquired_notify"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_unacquired_notify">[docs]</a>    <span class="k">def</span> <span class="nf">test_unacquired_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
        <span class="c"># Note that this test is sensitive to timing.  If the worker threads</span>
        <span class="c"># don&#39;t execute in a timely fashion, the main thread may think they</span>
        <span class="c"># are further along then they are.  The main thread therefore issues</span>
        <span class="c"># _wait() statements to try to make sure that it doesn&#39;t race ahead</span>
        <span class="c"># of the workers.</span>
        <span class="c"># Secondly, this test assumes that condition variables are not subject</span>
        <span class="c"># to spurious wakeups.  The absence of spurious wakeups is an implementation</span>
        <span class="c"># detail of Condition Cariables in current CPython, but in general, not</span>
        <span class="c"># a guaranteed property of condition variables as a programming</span>
        <span class="c"># construct.  In particular, it is possible that this can no longer</span>
        <span class="c"># be conveniently guaranteed should their implementation ever change.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">phase_num</span><span class="p">))</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">phase_num</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c"># Notify 3 threads at first</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results2</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c"># first wait, to ensure all workers settle into cond.wait() before</span>
        <span class="c"># we continue. See issue #8799</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="c"># Notify 5 threads: they might be in their first or second wait</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results2</span><span class="p">,</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">_wait</span><span class="p">()</span> <span class="c"># make sure all workers settle into cond.wait()</span>
        <span class="c"># Notify all threads: they are all in their second wait</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span><span class="p">,</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results2</span><span class="p">,</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>

<div class="viewcode-block" id="ConditionTests.test_notify"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_notify">[docs]</a>    <span class="k">def</span> <span class="nf">test_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_notify</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
        <span class="c"># A second time, to check internal state is still ok.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_notify</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConditionTests.test_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTimeout</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="c"># Note that conceptually (that&quot;s the condition variable protocol)</span>
            <span class="c"># a wait() may succeed even if no one notifies us and before any</span>
            <span class="c"># timeout occurs.  Spurious wakeups can occur.</span>
            <span class="c"># This makes it hard to verify the result value.</span>
            <span class="c"># In practice, this implementation has no spurious wakeups.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConditionTests.test_waitfor"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_waitfor">[docs]</a>    <span class="k">def</span> <span class="nf">test_waitfor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">state</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ConditionTests.test_waitfor_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.ConditionTests.test_waitfor_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_waitfor_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condtype</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">success</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">state</span><span class="o">==</span><span class="mi">4</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTimeout</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="n">success</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="c"># Only increment 3 times, so state == 4 is never reached.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">success</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="BaseSemaphoreTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests">[docs]</a><span class="k">class</span> <span class="nc">BaseSemaphoreTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common tests for {bounded, unbounded} semaphore objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseSemaphoreTests.test_constructor"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_constructor">[docs]</a>    <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_acquire"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_acquire_destroy"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_acquire_destroy">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">sem</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_acquire_contended"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_acquire_contended">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_contended</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_num</span><span class="p">)</span>
            <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_num</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results1</span> <span class="o">+</span> <span class="n">results2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">results1</span> <span class="o">+</span> <span class="n">results2</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">phase_num</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">19</span><span class="p">:</span>
            <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">results1</span> <span class="o">+</span> <span class="n">results2</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c"># The semaphore is still locked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="c"># Final release, to let the last thread finish</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_try_acquire"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_try_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_try_acquire_contended"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_try_acquire_contended">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_acquire_contended</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
        <span class="c"># There can be a thread switch between acquiring the semaphore and</span>
        <span class="c"># appending the result, therefore results will not necessarily be</span>
        <span class="c"># ordered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span>  <span class="mi">3</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_acquire_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_acquire_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.005</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.005</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.005</span><span class="p">))</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.005</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTimeout</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_default_value"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_default_value">[docs]</a>    <span class="k">def</span> <span class="nf">test_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The default initial value is 1.</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_started</span><span class="p">()</span>
        <span class="n">_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseSemaphoreTests.test_with"><a class="viewcode-back" href="../../test.html#test.lock_tests.BaseSemaphoreTests.test_with">[docs]</a>    <span class="k">def</span> <span class="nf">test_with</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_with</span><span class="p">(</span><span class="n">err</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
                <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">err</span>
        <span class="n">_with</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">_with</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="SemaphoreTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.SemaphoreTests">[docs]</a><span class="k">class</span> <span class="nc">SemaphoreTests</span><span class="p">(</span><span class="n">BaseSemaphoreTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for unbounded semaphores.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SemaphoreTests.test_release_unacquired"><a class="viewcode-back" href="../../test.html#test.lock_tests.SemaphoreTests.test_release_unacquired">[docs]</a>    <span class="k">def</span> <span class="nf">test_release_unacquired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Unbounded releases are allowed and increment the semaphore&#39;s value</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="BoundedSemaphoreTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.BoundedSemaphoreTests">[docs]</a><span class="k">class</span> <span class="nc">BoundedSemaphoreTests</span><span class="p">(</span><span class="n">BaseSemaphoreTests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for bounded semaphores.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BoundedSemaphoreTests.test_release_unacquired"><a class="viewcode-back" href="../../test.html#test.lock_tests.BoundedSemaphoreTests.test_release_unacquired">[docs]</a>    <span class="k">def</span> <span class="nf">test_release_unacquired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Cannot go past the initial value</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">sem</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="BarrierTests"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests">[docs]</a><span class="k">class</span> <span class="nc">BarrierTests</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for Barrier objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">defaultTimeout</span> <span class="o">=</span> <span class="mf">2.0</span>

<div class="viewcode-block" id="BarrierTests.setUp"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultTimeout</span><span class="p">)</span></div>
<div class="viewcode-block" id="BarrierTests.tearDown"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BarrierTests.run_threads"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.run_threads">[docs]</a>    <span class="k">def</span> <span class="nf">run_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait_for_finished</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BarrierTests.multipass"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.multipass">[docs]</a>    <span class="k">def</span> <span class="nf">multipass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">parties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">n_waiting</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">broken</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_barrier"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_barrier">[docs]</a>    <span class="k">def</span> <span class="nf">test_barrier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that a barrier is passed in lockstep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[[],[]]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multipass</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">passes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_barrier_10"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_barrier_10">[docs]</a>    <span class="k">def</span> <span class="nf">test_barrier_10</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that a barrier works for 10 consecutive runs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_barrier</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_wait_return"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_wait_return">[docs]</a>    <span class="k">def</span> <span class="nf">test_wait_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test the return value from barrier.wait</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_action"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_action">[docs]</a>    <span class="k">def</span> <span class="nf">test_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the &#39;action&#39; callback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">action</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">barrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_abort"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_abort">[docs]</a>    <span class="k">def</span> <span class="nf">test_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that an abort will put the barrier in a broken state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">threading</span><span class="o">.</span><span class="n">BrokenBarrierError</span><span class="p">:</span>
                <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">broken</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_reset"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_reset">[docs]</a>    <span class="k">def</span> <span class="nf">test_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that a &#39;reset&#39; on a barrier frees the waiting threads</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                <span class="c"># Wait until the other threads are all in the barrier.</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">n_waiting</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                    <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">threading</span><span class="o">.</span><span class="n">BrokenBarrierError</span><span class="p">:</span>
                    <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Now, pass the barrier again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">results3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="BarrierTests.test_abort_and_reset"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_abort_and_reset">[docs]</a>    <span class="k">def</span> <span class="nf">test_abort_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that a barrier can be reset after being broken.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results3</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">barrier2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">results1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">threading</span><span class="o">.</span><span class="n">BrokenBarrierError</span><span class="p">:</span>
                <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">pass</span>
            <span class="c"># Synchronize and reset the barrier.  Must synchronize first so</span>
            <span class="c"># that everyone has left it when we reset, and after so that no</span>
            <span class="c"># one enters it before the reset.</span>
            <span class="k">if</span> <span class="n">barrier2</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">barrier2</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">results3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test wait(timeout)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c"># One thread is late!</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="c"># Default timeout is 2.0, so this is shorter.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">BrokenBarrierError</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_default_timeout"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_default_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_default_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the barrier&#39;s default timeout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># create a barrier with a low default timeout</span>
        <span class="n">barrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c"># One thread is later than the default timeout of 0.3s.</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">BrokenBarrierError</span><span class="p">,</span> <span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_threads</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BarrierTests.test_single_thread"><a class="viewcode-back" href="../../test.html#test.lock_tests.BarrierTests.test_single_thread">[docs]</a>    <span class="k">def</span> <span class="nf">test_single_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertype</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>