

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.test_socket &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.test_socket</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.test_socket</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">test</span> <span class="kn">import</span> <span class="n">support</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">proxy</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">multiprocessing</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">HOST</span>
<span class="n">MSG</span> <span class="o">=</span> <span class="s">&#39;Michael Gilfix was here</span><span class="se">\u1234\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c">## test unicode string and carriage return</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_thread</span> <span class="kn">as</span> <span class="nn">thread</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_socket</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_socket</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">_have_socket_can</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check whether CAN sockets are supported on this host.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">_have_socket_rds</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check whether RDS sockets are supported on this host.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_RDS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="n">HAVE_SOCKET_CAN</span> <span class="o">=</span> <span class="n">_have_socket_can</span><span class="p">()</span>

<span class="n">HAVE_SOCKET_RDS</span> <span class="o">=</span> <span class="n">_have_socket_rds</span><span class="p">()</span>

<span class="c"># Size in bytes of the int type</span>
<span class="n">SIZEOF_INT</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>

<div class="viewcode-block" id="SocketTCPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTCPTest">[docs]</a><span class="k">class</span> <span class="nc">SocketTCPTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="SocketTCPTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTCPTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SocketTCPTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTCPTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="bp">None</span>
</div></div>
<div class="viewcode-block" id="SocketUDPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketUDPTest">[docs]</a><span class="k">class</span> <span class="nc">SocketUDPTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="SocketUDPTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketUDPTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SocketUDPTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketUDPTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="bp">None</span>
</div></div>
<div class="viewcode-block" id="ThreadSafeCleanupTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadSafeCleanupTestCase">[docs]</a><span class="k">class</span> <span class="nc">ThreadSafeCleanupTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass of unittest.TestCase with thread-safe cleanup methods.</span>

<span class="sd">    This subclass protects the addCleanup() and doCleanups() methods</span>
<span class="sd">    with a recursive lock.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">threading</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

<div class="viewcode-block" id="ThreadSafeCleanupTestCase.addCleanup"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadSafeCleanupTestCase.addCleanup">[docs]</a>        <span class="k">def</span> <span class="nf">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_lock</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadSafeCleanupTestCase.doCleanups"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadSafeCleanupTestCase.doCleanups">[docs]</a>        <span class="k">def</span> <span class="nf">doCleanups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_lock</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">doCleanups</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="SocketCANTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketCANTest">[docs]</a><span class="k">class</span> <span class="nc">SocketCANTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;To be able to run this test, a `vcan0` CAN interface can be created with</span>
<span class="sd">    the following commands:</span>
<span class="sd">    # modprobe vcan</span>
<span class="sd">    # ip link add dev vcan0 type vcan</span>
<span class="sd">    # ifconfig vcan0 up</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="s">&#39;vcan0&#39;</span>
    <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span>

    <span class="sd">&quot;&quot;&quot;The CAN frame structure is defined in &lt;linux/can.h&gt;:</span>

<span class="sd">    struct can_frame {</span>
<span class="sd">        canid_t can_id;  /* 32 bit CAN_ID + EFF/RTR/ERR flags */</span>
<span class="sd">        __u8    can_dlc; /* data length code: 0 .. 8 */</span>
<span class="sd">        __u8    data[8] __attribute__((aligned(8)));</span>
<span class="sd">    };</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">can_frame_fmt</span> <span class="o">=</span> <span class="s">&quot;=IB3x8s&quot;</span>
    <span class="n">can_frame_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">can_frame_fmt</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;The Broadcast Management Command frame structure is defined</span>
<span class="sd">    in &lt;linux/can/bcm.h&gt;:</span>

<span class="sd">    struct bcm_msg_head {</span>
<span class="sd">        __u32 opcode;</span>
<span class="sd">        __u32 flags;</span>
<span class="sd">        __u32 count;</span>
<span class="sd">        struct timeval ival1, ival2;</span>
<span class="sd">        canid_t can_id;</span>
<span class="sd">        __u32 nframes;</span>
<span class="sd">        struct can_frame frames[0];</span>
<span class="sd">    }</span>

<span class="sd">    `bcm_msg_head` must be 8 bytes aligned because of the `frames` member (see</span>
<span class="sd">    `struct can_frame` definition). Must use native not standard types for packing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bcm_cmd_msg_fmt</span> <span class="o">=</span> <span class="s">&quot;@3I4l2I&quot;</span>
    <span class="n">bcm_cmd_msg_fmt</span> <span class="o">+=</span> <span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">bcm_cmd_msg_fmt</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>

<div class="viewcode-block" id="SocketCANTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketCANTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;network interface `</span><span class="si">%s</span><span class="s">` does not exist&#39;</span> <span class="o">%</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SocketRDSTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketRDSTest">[docs]</a><span class="k">class</span> <span class="nc">SocketRDSTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;To be able to run this test, the `rds` kernel module must be loaded:</span>
<span class="sd">    # modprobe rds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">8192</span>

<div class="viewcode-block" id="SocketRDSTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketRDSTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_RDS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;unable to bind RDS socket&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ThreadableTest"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadableTest">[docs]</a><span class="k">class</span> <span class="nc">ThreadableTest</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Threadable Test class</span>

<span class="sd">    The ThreadableTest class makes it easy to create a threaded</span>
<span class="sd">    client/server pair from an existing unit test. To create a</span>
<span class="sd">    new threaded class from an existing unit test, use multiple</span>
<span class="sd">    inheritance:</span>

<span class="sd">        class NewClass (OldClass, ThreadableTest):</span>
<span class="sd">            pass</span>

<span class="sd">    This class defines two new fixture functions with obvious</span>
<span class="sd">    purposes for overriding:</span>

<span class="sd">        clientSetUp ()</span>
<span class="sd">        clientTearDown ()</span>

<span class="sd">    Any new test functions within the class must then define</span>
<span class="sd">    tests in pairs, where the test name is preceeded with a</span>
<span class="sd">    &#39;_&#39; to indicate the client portion of the test. Ex:</span>

<span class="sd">        def testFoo(self):</span>
<span class="sd">            # Server portion</span>

<span class="sd">        def _testFoo(self):</span>
<span class="sd">            # Client portion</span>

<span class="sd">    Any exceptions raised by the clients during their tests</span>
<span class="sd">    are caught and transferred to the main thread to alert</span>
<span class="sd">    the testing framework.</span>

<span class="sd">    Note, the server setup function cannot call any blocking</span>
<span class="sd">    functions that rely on the client thread during setup,</span>
<span class="sd">    unless serverExplicitReady() is called just before</span>
<span class="sd">    the blocking call (such as in setting up a client/server</span>
<span class="sd">    connection and performing the accept() in setUp().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Swap the true setup function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setUp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setUp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tearDown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tearDown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setUp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tearDown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tearDown</span>

<div class="viewcode-block" id="ThreadableTest.serverExplicitReady"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadableTest.serverExplicitReady">[docs]</a>    <span class="k">def</span> <span class="nf">serverExplicitReady</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method allows the server to explicitly indicate that</span>
<span class="sd">        it wants the client thread to proceed. This is useful if the</span>
<span class="sd">        server is about to execute a blocking routine that is</span>
<span class="sd">        dependent upon the client thread during its setup routine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_ready</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_ready</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_crashed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Do some munging to start the client test.</span>
        <span class="n">methodname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">methodname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">methodname</span> <span class="o">=</span> <span class="n">methodname</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">test_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">methodname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_thread</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clientRun</span><span class="p">,</span> <span class="p">(</span><span class="n">test_method</span><span class="p">,))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__setUp</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_crashed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">():</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">exc</span>

<div class="viewcode-block" id="ThreadableTest.clientRun"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadableTest.clientRun">[docs]</a>    <span class="k">def</span> <span class="nf">clientRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clientSetUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_crashed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;test_func must be a callable function&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_func</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadableTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadableTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;clientSetUp must be implemented.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadableTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadableTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="ThreadedTCPSocketTest"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedTCPSocketTest">[docs]</a><span class="k">class</span> <span class="nc">ThreadedTCPSocketTest</span><span class="p">(</span><span class="n">SocketTCPTest</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketTCPTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedTCPSocketTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedTCPSocketTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedTCPSocketTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedTCPSocketTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ThreadedUDPSocketTest"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedUDPSocketTest">[docs]</a><span class="k">class</span> <span class="nc">ThreadedUDPSocketTest</span><span class="p">(</span><span class="n">SocketUDPTest</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketUDPTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedUDPSocketTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedUDPSocketTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadedUDPSocketTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedUDPSocketTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ThreadedCANSocketTest"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedCANSocketTest">[docs]</a><span class="k">class</span> <span class="nc">ThreadedCANSocketTest</span><span class="p">(</span><span class="n">SocketCANTest</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketCANTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedCANSocketTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedCANSocketTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># skipTest should not be called here, and will be called in the</span>
            <span class="c"># server instead</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ThreadedCANSocketTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedCANSocketTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ThreadedRDSSocketTest"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedRDSSocketTest">[docs]</a><span class="k">class</span> <span class="nc">ThreadedRDSSocketTest</span><span class="p">(</span><span class="n">SocketRDSTest</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketRDSTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedRDSSocketTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedRDSSocketTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_RDS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># RDS sockets must be bound explicitly to send or receive data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># skipTest should not be called here, and will be called in the</span>
            <span class="c"># server instead</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ThreadedRDSSocketTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedRDSSocketTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="SocketConnectedTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketConnectedTest">[docs]</a><span class="k">class</span> <span class="nc">SocketConnectedTest</span><span class="p">(</span><span class="n">ThreadedTCPSocketTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Socket tests for client-server connection.</span>

<span class="sd">    self.cli_conn is a client socket connected to the server.  The</span>
<span class="sd">    setUp() method guarantees that it is connected to the server.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">ThreadedTCPSocketTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="SocketConnectedTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketConnectedTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ThreadedTCPSocketTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c"># Indicate explicitly we&#39;re ready for the client thread to</span>
        <span class="c"># proceed and then perform the blocking call to accept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverExplicitReady</span><span class="p">()</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span> <span class="o">=</span> <span class="n">conn</span>
</div>
<div class="viewcode-block" id="SocketConnectedTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketConnectedTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadedTCPSocketTest</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SocketConnectedTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketConnectedTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ThreadedTCPSocketTest</span><span class="o">.</span><span class="n">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span>
</div>
<div class="viewcode-block" id="SocketConnectedTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketConnectedTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadedTCPSocketTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="SocketPairTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketPairTest">[docs]</a><span class="k">class</span> <span class="nc">SocketPairTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="SocketPairTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketPairTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socketpair</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SocketPairTest.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketPairTest.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="SocketPairTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketPairTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SocketPairTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketPairTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="c"># The following classes are used by the sendmsg()/recvmsg() tests.</span>
<span class="c"># Combining, for instance, ConnectedStreamTestMixin and TCPTestBase</span>
<span class="c"># gives a drop-in replacement for SocketConnectedTest, but different</span>
<span class="c"># address families can be used, and the attributes serv_addr and</span>
<span class="c"># cli_addr will be set to the addresses of the endpoints.</span>
</div></div>
<div class="viewcode-block" id="SocketTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTestBase">[docs]</a><span class="k">class</span> <span class="nc">SocketTestBase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class for socket tests.</span>

<span class="sd">    Subclasses must provide methods newSocket() to return a new socket</span>
<span class="sd">    and bindSock(sock) to bind it to an unused address.</span>

<span class="sd">    Creates a socket self.serv and sets self.serv_addr to its address.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SocketTestBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTestBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newSocket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindServer</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SocketTestBase.bindServer"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTestBase.bindServer">[docs]</a>    <span class="k">def</span> <span class="nf">bindServer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bind server socket and set self.serv_addr to its address.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindSock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SocketTestBase.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketTestBase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="bp">None</span>

</div></div>
<div class="viewcode-block" id="SocketListeningTestMixin"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketListeningTestMixin">[docs]</a><span class="k">class</span> <span class="nc">SocketListeningTestMixin</span><span class="p">(</span><span class="n">SocketTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin to listen on the server socket.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SocketListeningTestMixin.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SocketListeningTestMixin.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ThreadedSocketTestMixin"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedSocketTestMixin">[docs]</a><span class="k">class</span> <span class="nc">ThreadedSocketTestMixin</span><span class="p">(</span><span class="n">ThreadSafeCleanupTestCase</span><span class="p">,</span> <span class="n">SocketTestBase</span><span class="p">,</span>
                              <span class="n">ThreadableTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin to add client socket and allow client/server tests.</span>

<span class="sd">    Client socket is self.cli and its address is self.cli_addr.  See</span>
<span class="sd">    ThreadableTest for usage information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedSocketTestMixin.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedSocketTestMixin.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newClientSocket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindClient</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedSocketTestMixin.newClientSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedSocketTestMixin.newClientSocket">[docs]</a>    <span class="k">def</span> <span class="nf">newClientSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new socket for use as client.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">newSocket</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedSocketTestMixin.bindClient"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedSocketTestMixin.bindClient">[docs]</a>    <span class="k">def</span> <span class="nf">bindClient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bind client socket and set self.cli_addr to its address.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindSock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadedSocketTestMixin.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ThreadedSocketTestMixin.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ConnectedStreamTestMixin"><a class="viewcode-back" href="../../test.html#test.test_socket.ConnectedStreamTestMixin">[docs]</a><span class="k">class</span> <span class="nc">ConnectedStreamTestMixin</span><span class="p">(</span><span class="n">SocketListeningTestMixin</span><span class="p">,</span>
                               <span class="n">ThreadedSocketTestMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin to allow client/server stream tests with connected client.</span>

<span class="sd">    Server&#39;s socket representing connection to client is self.cli_conn</span>
<span class="sd">    and client&#39;s connection to server is self.serv_conn.  (Based on</span>
<span class="sd">    SocketConnectedTest.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConnectedStreamTestMixin.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ConnectedStreamTestMixin.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="c"># Indicate explicitly we&#39;re ready for the client thread to</span>
        <span class="c"># proceed and then perform the blocking call to accept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverExplicitReady</span><span class="p">()</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span> <span class="o">=</span> <span class="n">conn</span>
</div>
<div class="viewcode-block" id="ConnectedStreamTestMixin.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ConnectedStreamTestMixin.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ConnectedStreamTestMixin.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.ConnectedStreamTestMixin.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clientSetUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span>
</div>
<div class="viewcode-block" id="ConnectedStreamTestMixin.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.ConnectedStreamTestMixin.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="UnixSocketTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.UnixSocketTestBase">[docs]</a><span class="k">class</span> <span class="nc">UnixSocketTestBase</span><span class="p">(</span><span class="n">SocketTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for Unix-domain socket tests.&quot;&quot;&quot;</span>

    <span class="c"># This class is used for file descriptor passing tests, so we</span>
    <span class="c"># create the sockets in a private directory so that other users</span>
    <span class="c"># can&#39;t send anything that might be problematic for a privileged</span>
    <span class="c"># user running the tests.</span>

<div class="viewcode-block" id="UnixSocketTestBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.UnixSocketTestBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="UnixSocketTestBase.bindSock"><a class="viewcode-back" href="../../test.html#test.test_socket.UnixSocketTestBase.bindSock">[docs]</a>    <span class="k">def</span> <span class="nf">bindSock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="UnixStreamBase"><a class="viewcode-back" href="../../test.html#test.test_socket.UnixStreamBase">[docs]</a><span class="k">class</span> <span class="nc">UnixStreamBase</span><span class="p">(</span><span class="n">UnixSocketTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for Unix-domain SOCK_STREAM tests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="UnixStreamBase.newSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.UnixStreamBase.newSocket">[docs]</a>    <span class="k">def</span> <span class="nf">newSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="InetTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.InetTestBase">[docs]</a><span class="k">class</span> <span class="nc">InetTestBase</span><span class="p">(</span><span class="n">SocketTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for IPv4 socket tests.&quot;&quot;&quot;</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">HOST</span>

<div class="viewcode-block" id="InetTestBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.InetTestBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="InetTestBase.bindSock"><a class="viewcode-back" href="../../test.html#test.test_socket.InetTestBase.bindSock">[docs]</a>    <span class="k">def</span> <span class="nf">bindSock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TCPTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPTestBase">[docs]</a><span class="k">class</span> <span class="nc">TCPTestBase</span><span class="p">(</span><span class="n">InetTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for TCP-over-IPv4 tests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TCPTestBase.newSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPTestBase.newSocket">[docs]</a>    <span class="k">def</span> <span class="nf">newSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="UDPTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.UDPTestBase">[docs]</a><span class="k">class</span> <span class="nc">UDPTestBase</span><span class="p">(</span><span class="n">InetTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for UDP-over-IPv4 tests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="UDPTestBase.newSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.UDPTestBase.newSocket">[docs]</a>    <span class="k">def</span> <span class="nf">newSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="SCTPStreamBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SCTPStreamBase">[docs]</a><span class="k">class</span> <span class="nc">SCTPStreamBase</span><span class="p">(</span><span class="n">InetTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for SCTP tests in one-to-one (SOCK_STREAM) mode.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SCTPStreamBase.newSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.SCTPStreamBase.newSocket">[docs]</a>    <span class="k">def</span> <span class="nf">newSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span>
                             <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_SCTP</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Inet6TestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.Inet6TestBase">[docs]</a><span class="k">class</span> <span class="nc">Inet6TestBase</span><span class="p">(</span><span class="n">InetTestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for IPv6 socket tests.&quot;&quot;&quot;</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">HOSTv6</span>
</div>
<div class="viewcode-block" id="UDP6TestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.UDP6TestBase">[docs]</a><span class="k">class</span> <span class="nc">UDP6TestBase</span><span class="p">(</span><span class="n">Inet6TestBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for UDP-over-IPv6 tests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="UDP6TestBase.newSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.UDP6TestBase.newSocket">[docs]</a>    <span class="k">def</span> <span class="nf">newSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>


<span class="c"># Test-skipping decorators for use with ThreadableTest.</span>
</div></div>
<div class="viewcode-block" id="skipWithClientIf"><a class="viewcode-back" href="../../test.html#test.test_socket.skipWithClientIf">[docs]</a><span class="k">def</span> <span class="nf">skipWithClientIf</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip decorated test if condition is true, add client_skip decorator.</span>

<span class="sd">    If the decorated object is not a class, sets its attribute</span>
<span class="sd">    &quot;client_skip&quot; to a decorator which will return an empty function</span>
<span class="sd">    if the test is to be skipped, or the original function if it is</span>
<span class="sd">    not.  This can be used to avoid running the client part of a</span>
<span class="sd">    skipped test when using ThreadableTest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">client_pass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">skipdec</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">reason</span><span class="p">)(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">retval</span><span class="o">.</span><span class="n">client_skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">client_pass</span>
        <span class="k">return</span> <span class="n">retval</span>
    <span class="k">def</span> <span class="nf">noskipdec</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;client_skip&quot;</span><span class="p">)):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">client_skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="n">skipdec</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="n">noskipdec</span>

</div>
<div class="viewcode-block" id="requireAttrs"><a class="viewcode-back" href="../../test.html#test.test_socket.requireAttrs">[docs]</a><span class="k">def</span> <span class="nf">requireAttrs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip decorated test if obj is missing any of the given attributes.</span>

<span class="sd">    Sets client_skip attribute as skipWithClientIf() does.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">skipWithClientIf</span><span class="p">(</span>
        <span class="n">missing</span><span class="p">,</span> <span class="s">&quot;don&#39;t have &quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="requireSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.requireSocket">[docs]</a><span class="k">def</span> <span class="nf">requireSocket</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip decorated test if a socket cannot be created with given arguments.</span>

<span class="sd">    When an argument is given as a string, will use the value of that</span>
<span class="sd">    attribute of the socket module, or skip the test if it doesn&#39;t</span>
<span class="sd">    exist.  Sets client_skip attribute as skipWithClientIf() does.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span>
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">obj</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s">&quot;don&#39;t have &quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">callargs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="o">*</span><span class="n">callargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># XXX: check errno?</span>
            <span class="n">err</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">skipWithClientIf</span><span class="p">(</span>
        <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&quot;can&#39;t create socket({0}): {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">args</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>


<span class="c">#######################################################################</span>
<span class="c">## Begin Tests</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests">[docs]</a><span class="k">class</span> <span class="nc">GeneralModuleTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="GeneralModuleTests.test_repr"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fd=</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;family=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;type=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;proto=0&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s">&#39;raddr&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;laddr&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;[closed]&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s">&#39;laddr&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">_socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;need _socket module&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.test_csocket_repr"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_csocket_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_csocket_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">_socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">_socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&lt;socket object, fd=</span><span class="si">%s</span><span class="s">, family=</span><span class="si">%s</span><span class="s">, type=</span><span class="si">%s</span><span class="s">, proto=</span><span class="si">%s</span><span class="s">&gt;&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">proto</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&lt;socket object, fd=-1, family=</span><span class="si">%s</span><span class="s">, type=</span><span class="si">%s</span><span class="s">, proto=</span><span class="si">%s</span><span class="s">&gt;&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">proto</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_weakref"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_weakref">[docs]</a>    <span class="k">def</span> <span class="nf">test_weakref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Socket proxy still exists&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testSocketError"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testSocketError">[docs]</a>    <span class="k">def</span> <span class="nf">testSocketError</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing socket module exceptions</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Error raising socket exception (</span><span class="si">%s</span><span class="s">).&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span> <span class="o">%</span> <span class="s">&#39;OSError&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span> <span class="o">%</span> <span class="s">&#39;socket.herror&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">herror</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span> <span class="o">%</span> <span class="s">&#39;socket.gaierror&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testSendtoErrors"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testSendtoErrors">[docs]</a>    <span class="k">def</span> <span class="nf">testSendtoErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing that sendto doens&#39;t masks failures. See #10169.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">sockname</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="c"># 2 args</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\u2620</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">sockname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span>
                         <span class="s">&quot;&#39;str&#39; does not support the buffer interface&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="mi">5j</span><span class="p">,</span> <span class="n">sockname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span>
                         <span class="s">&quot;&#39;complex&#39; does not support the buffer interface&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;not NoneType&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="c"># 3 args</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\u2620</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span>
                         <span class="s">&quot;&#39;str&#39; does not support the buffer interface&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="mi">5j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">),</span>
                         <span class="s">&quot;&#39;complex&#39; does not support the buffer interface&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;not NoneType&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="n">sockname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;an integer is required&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;an integer is required&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="c"># wrong number of args</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;(1 given)&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockname</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;(4 given)&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testCrucialConstants"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testCrucialConstants">[docs]</a>    <span class="k">def</span> <span class="nf">testCrucialConstants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing for mission critical constants</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RDM</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testHostnameRes"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testHostnameRes">[docs]</a>    <span class="k">def</span> <span class="nf">testHostnameRes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing hostname resolution mechanisms</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># Probably name lookup wasn&#39;t set up right; skip this test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;name lookup failure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Error resolving host to ip.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hname</span><span class="p">,</span> <span class="n">aliases</span><span class="p">,</span> <span class="n">ipaddrs</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># Probably a similar problem as above; skip this test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;name lookup failure&#39;</span><span class="p">)</span>
        <span class="n">all_host_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hname</span><span class="p">]</span> <span class="o">+</span> <span class="n">aliases</span>
        <span class="n">fqhn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fqhn</span> <span class="ow">in</span> <span class="n">all_host_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error testing host resolution mechanisms. (fqdn: </span><span class="si">%s</span><span class="s">, all: </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fqhn</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_host_names</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_host_resolution"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_host_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">test_host_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;0.1.1.~1&#39;</span><span class="p">,</span> <span class="s">&#39;1+.1.1.1&#39;</span><span class="p">,</span> <span class="s">&#39;::1q&#39;</span><span class="p">,</span> <span class="s">&#39;::1::2&#39;</span><span class="p">,</span>
                     <span class="s">&#39;1:1:1:1:1:1:1:1:1&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">support</span><span class="o">.</span><span class="n">HOST</span><span class="p">,</span> <span class="s">&#39;10.0.0.1&#39;</span><span class="p">,</span> <span class="s">&#39;255.255.255.255&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">addr</span><span class="p">)</span>

        <span class="c"># we don&#39;t test support.HOSTv6 because there&#39;s a chance it doesn&#39;t have</span>
        <span class="c"># a matching name entry (e.g. &#39;ip6-localhost&#39;)</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="p">[</span><span class="n">support</span><span class="o">.</span><span class="n">HOST</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="n">host</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;sethostname&#39;</span><span class="p">),</span> <span class="s">&quot;test needs socket.sethostname()&quot;</span><span class="p">)</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;gethostname&#39;</span><span class="p">),</span> <span class="s">&quot;test needs socket.gethostname()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.test_sethostname"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_sethostname">[docs]</a>    <span class="k">def</span> <span class="nf">test_sethostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">oldhn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">sethostname</span><span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;test should be run as root&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># running test as root!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="s">&#39;new&#39;</span><span class="p">)</span>
            <span class="c"># Should work with bytes objects too</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">sethostname</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="s">&#39;bar&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">sethostname</span><span class="p">(</span><span class="n">oldhn</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;if_nameindex&#39;</span><span class="p">),</span>
                         <span class="s">&#39;socket.if_nameindex() not available.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testInterfaceNameIndex"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testInterfaceNameIndex">[docs]</a>    <span class="k">def</span> <span class="nf">testInterfaceNameIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_nameindex</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="c"># interface indices are non-zero integers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">_index</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_nametoindex</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">_index</span><span class="p">)</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_indextoname</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_name</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;if_nameindex&#39;</span><span class="p">),</span>
                         <span class="s">&#39;socket.if_nameindex() not available.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testInvalidInterfaceNameIndex"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testInvalidInterfaceNameIndex">[docs]</a>    <span class="k">def</span> <span class="nf">testInvalidInterfaceNameIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># test nonexistent interface index/name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_indextoname</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_nametoindex</span><span class="p">,</span> <span class="s">&#39;_DEADBEEF&#39;</span><span class="p">)</span>
        <span class="c"># test with invalid values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_nametoindex</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">if_indextoname</span><span class="p">,</span> <span class="s">&#39;_DEADBEEF&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&#39;getrefcount&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs sys.getrefcount()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testRefCountGetNameInfo"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testRefCountGetNameInfo">[docs]</a>    <span class="k">def</span> <span class="nf">testRefCountGetNameInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing reference count for getnameinfo</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># On some versions, this loses a reference</span>
            <span class="n">orig</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">getnameinfo</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span> <span class="o">!=</span> <span class="n">orig</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;socket.getnameinfo loses a reference&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testInterpreterCrash"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testInterpreterCrash">[docs]</a>    <span class="k">def</span> <span class="nf">testInterpreterCrash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Making sure getnameinfo doesn&#39;t crash the interpreter</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># On some versions, this crashes the interpreter.</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">getnameinfo</span><span class="p">((</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testNtoH"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testNtoH">[docs]</a>    <span class="k">def</span> <span class="nf">testNtoH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This just checks that htons etc. are their own inverse,</span>
        <span class="c"># when looking at the lower 16 or 32 bits.</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span><span class="n">socket</span><span class="o">.</span><span class="n">htonl</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">ntohl</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
                 <span class="n">socket</span><span class="o">.</span><span class="n">htons</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">ntohs</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x01234567</span><span class="p">,</span> <span class="mh">0x76543210</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">i</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>

            <span class="n">swapped</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">swapped</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">34</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testNtoHErrors"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testNtoHErrors">[docs]</a>    <span class="k">def</span> <span class="nf">testNtoHErrors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">good_values</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
        <span class="n">bad_values</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">good_values</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">ntohl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">ntohs</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">htonl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">htons</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bad_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">ntohl</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">ntohs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">htonl</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">htons</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testGetServBy"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testGetServBy">[docs]</a>    <span class="k">def</span> <span class="nf">testGetServBy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span>
        <span class="c"># Find one service that exists, then check all the related interfaces.</span>
        <span class="c"># I&#39;ve ordered this by protocols that have both a tcp and udp</span>
        <span class="c"># protocol, at least for modern Linuxes.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s">&#39;freebsd&#39;</span><span class="p">,</span> <span class="s">&#39;netbsd&#39;</span><span class="p">,</span> <span class="s">&#39;gnukfreebsd&#39;</span><span class="p">))</span>
            <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;linux&#39;</span><span class="p">,</span> <span class="s">&#39;darwin&#39;</span><span class="p">)):</span>
            <span class="c"># avoid the &#39;echo&#39; service on this platform, as there is an</span>
            <span class="c"># assumption breaking non-standard port/protocol entry</span>
            <span class="n">services</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;daytime&#39;</span><span class="p">,</span> <span class="s">&#39;qotd&#39;</span><span class="p">,</span> <span class="s">&#39;domain&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">services</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;echo&#39;</span><span class="p">,</span> <span class="s">&#39;daytime&#39;</span><span class="p">,</span> <span class="s">&#39;domain&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getservbyname</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="s">&#39;tcp&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span>
        <span class="c"># Try same call with optional protocol omitted</span>
        <span class="n">port2</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getservbyname</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="n">eq</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port2</span><span class="p">)</span>
        <span class="c"># Try udp, but don&#39;t barf if it doesn&#39;t exist</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">udpport</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getservbyname</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="s">&#39;udp&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">udpport</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eq</span><span class="p">(</span><span class="n">udpport</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="c"># Now make sure the lookup by port returns the same service name</span>
        <span class="n">eq</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">port2</span><span class="p">),</span> <span class="n">service</span><span class="p">)</span>
        <span class="n">eq</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&#39;tcp&#39;</span><span class="p">),</span> <span class="n">service</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">udpport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">eq</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">udpport</span><span class="p">,</span> <span class="s">&#39;udp&#39;</span><span class="p">),</span> <span class="n">service</span><span class="p">)</span>
        <span class="c"># Make sure getservbyport does not accept out of range ports.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">getservbyport</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">getservbyport</span><span class="p">,</span> <span class="mi">65536</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testDefaultTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testDefaultTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testDefaultTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing default timeout</span>
        <span class="c"># The default timeout should initially be None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Set the default timeout to 10, and see if it propagates</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Reset the default timeout to None, and see if it propagates</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Check that setting it to an invalid value raises ValueError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># Check that setting it to an invalid type raises TypeError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">,</span> <span class="s">&quot;spam&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;inet_aton&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs socket.inet_aton()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testIPv4_inet_aton_fourbytes"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testIPv4_inet_aton_fourbytes">[docs]</a>    <span class="k">def</span> <span class="nf">testIPv4_inet_aton_fourbytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test that issue1008086 and issue767150 are fixed.</span>
        <span class="c"># It must return 4 bytes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="s">&#39;255.255.255.255&#39;</span><span class="p">))</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;inet_pton&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs socket.inet_pton()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testIPv4toString"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testIPv4toString">[docs]</a>    <span class="k">def</span> <span class="nf">testIPv4toString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">inet_aton</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">inet_pton</span><span class="p">,</span> <span class="n">AF_INET</span>
        <span class="n">g</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

        <span class="n">assertInvalid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">func</span><span class="p">,</span> <span class="n">a</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff\x00\xff\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;255.0.255.0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xaa\xaa\xaa\xaa</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;170.170.170.170&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x01\x02\x03\x04</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;1.2.3.4&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff\xff\xff\xff</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;255.255.255.255&#39;</span><span class="p">))</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;0.0.0.&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;300.0.0.0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;a.0.0.0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;1.2.3.4.5&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;::1&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff\x00\xff\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;255.0.255.0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xaa\xaa\xaa\xaa</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;170.170.170.170&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff\xff\xff\xff</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="s">&#39;255.255.255.255&#39;</span><span class="p">))</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;0.0.0.&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;300.0.0.0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;a.0.0.0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;1.2.3.4.5&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">&#39;::1&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;inet_pton&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs socket.inet_pton()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testIPv6toString"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testIPv6toString">[docs]</a>    <span class="k">def</span> <span class="nf">testIPv6toString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">inet_pton</span><span class="p">,</span> <span class="n">AF_INET6</span><span class="p">,</span> <span class="n">has_ipv6</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_ipv6</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;IPv6 not available&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;could not import needed symbols from socket&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="s">&#39;::&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">winerror</span> <span class="o">==</span> <span class="mi">10022</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;IPv6 might not be supported&#39;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">assertInvalid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;0::0&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x01</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">14</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;1::&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">b</span><span class="s">&#39;</span><span class="se">\x45\xef\x76\xcb\x00\x1a\x56\xef\xaf\xeb\x0b\xac\x19\x24\xae\xae</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;45ef:76cb:1a:56ef:afeb:bac:1924:aeae&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">b</span><span class="s">&#39;</span><span class="se">\xad\x42\x0a\xbc</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01\x27\x00\x00\x02\x54\x00\x02</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;ad42:abc::127:0:254:2&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x12\x00\x0a</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">12</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="s">&#39;12:a::&#39;</span><span class="p">))</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;0x20::&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;:::&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;::0::&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1::abc::&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1::abc::def&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1:2:3:4:5:6:&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1:2:3:4:5:6&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1:2:3:4:5:6:7:8:&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1:2:3:4:5:6:7:8:0&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xfe\x2a\x17\x40</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;::254.42.23.64&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x42</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xa2\x9b\xfe\x2a\x17\x40</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;42::a29b:254.42.23.64&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x42\xa8\xb9\x00\x00\x00\x02\xff\xff\xa2\x9b\xfe\x2a\x17\x40</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;42:a8b9:0:2:ffff:a29b:254.42.23.64&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;255.254.253.252&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1::260.2.3.0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1::0.be.e.0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;1:2:3:4:5:6:7:1.2.3.4&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;::1.2.3.4:0&#39;</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="s">&#39;0.100.200.0:3:4:5:6:7:8&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;inet_ntop&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs socket.inet_ntop()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testStringToIPv4"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testStringToIPv4">[docs]</a>    <span class="k">def</span> <span class="nf">testStringToIPv4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">inet_ntoa</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">inet_ntop</span><span class="p">,</span> <span class="n">AF_INET</span>
        <span class="n">g</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">assertInvalid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">func</span><span class="p">,</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">func</span><span class="p">,</span> <span class="n">a</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;1.0.1.0&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x01\x00\x01\x00</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;170.85.170.85&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xaa\x55\xaa\x55</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff\xff\xff\xff</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;1.2.3.4&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x01\x02\x03\x04</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;1.0.1.0&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x01\x00\x01\x00</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;170.85.170.85&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xaa\x55\xaa\x55</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\xff\xff\xff\xff</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;inet_ntop&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs socket.inet_ntop()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.testStringToIPv6"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testStringToIPv6">[docs]</a>    <span class="k">def</span> <span class="nf">testStringToIPv6</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">inet_ntop</span><span class="p">,</span> <span class="n">AF_INET6</span><span class="p">,</span> <span class="n">has_ipv6</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_ipv6</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;IPv6 not available&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;could not import needed symbols from socket&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">winerror</span> <span class="o">==</span> <span class="mi">10022</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;IPv6 might not be supported&#39;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">assertInvalid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;::1&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01</span><span class="s">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="s">&#39;aef:b01:506:1001:ffff:9997:55:170&#39;</span><span class="p">,</span>
            <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x0a\xef\x0b\x01\x05\x06\x10\x01\xff\xff\x99\x97\x00\x55\x01\x70</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x12</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x12</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">17</span><span class="p">)</span>
        <span class="n">assertInvalid</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x12</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c"># XXX The following don&#39;t test module-level functionality...</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testSockName"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testSockName">[docs]</a>    <span class="k">def</span> <span class="nf">testSockName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing getsockname()</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">find_unused_port</span><span class="p">()</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="c"># XXX(nnorwitz): http://tinyurl.com/os5jz seems to indicate</span>
        <span class="c"># it reasonable to get the host&#39;s addr in addition to 0.0.0.0.</span>
        <span class="c"># At least for eCos.  This is required for the S/390 to pass.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">my_ip_addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># Probably name lookup wasn&#39;t set up right; skip this test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;name lookup failure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">my_ip_addr</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> invalid&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">port</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testGetSockOpt"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testGetSockOpt">[docs]</a>    <span class="k">def</span> <span class="nf">testGetSockOpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing getsockopt()</span>
        <span class="c"># We know a socket should start without reuse==0</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">reuse</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">reuse</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;initial mode is reuse&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testSetSockOpt"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testSetSockOpt">[docs]</a>    <span class="k">def</span> <span class="nf">testSetSockOpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing setsockopt()</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">reuse</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">reuse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;failed to set reuse mode&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testSendAfterClose"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testSendAfterClose">[docs]</a>    <span class="k">def</span> <span class="nf">testSendAfterClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># testing send() after close() with timeout</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;spam&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testNewAttributes"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testNewAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">testNewAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># testing .family, .type and .protocol</span>

        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SOCK_CLOEXEC&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_CLOEXEC</span><span class="p">,</span>
                           <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_getsockaddrarg"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_getsockaddrarg">[docs]</a>    <span class="k">def</span> <span class="nf">test_getsockaddrarg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">find_unused_port</span><span class="p">()</span>
        <span class="n">big_port</span> <span class="o">=</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">65536</span>
        <span class="n">neg_port</span> <span class="o">=</span> <span class="n">port</span> <span class="o">-</span> <span class="mi">65536</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">big_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">neg_port</span><span class="p">))</span>
        <span class="c"># Since find_unused_port() is inherently subject to race conditions, we</span>
        <span class="c"># call it a couple times if necessary.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">find_unused_port</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EADDRINUSE</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;nt&quot;</span><span class="p">,</span> <span class="s">&quot;Windows specific&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.test_sock_ioctl"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_sock_ioctl">[docs]</a>    <span class="k">def</span> <span class="nf">test_sock_ioctl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;ioctl&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SIO_RCVALL&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;RCVALL_ON&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;RCVALL_OFF&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SIO_KEEPALIVE_VALS&#39;</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">ioctl</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SIO_KEEPALIVE_VALS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.testGetaddrinfo"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.testGetaddrinfo">[docs]</a>    <span class="k">def</span> <span class="nf">testGetaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">EAI_SERVICE</span><span class="p">:</span>
                <span class="c"># see http://bugs.python.org/issue1282647</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;buggy libc version&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="c"># len of every sequence is supposed to be == 5</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c"># host can be a domain name, a string representation of an</span>
        <span class="c"># IPv4/v6 address or None</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">&#39;::1&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="c"># port can be a string service name such as &quot;http&quot;, a numeric</span>
        <span class="c"># port number or None</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># test family and socktype filters</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">family</span><span class="p">),</span> <span class="s">&#39;AddressFamily.AF_INET&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">),</span> <span class="s">&#39;SocketType.SOCK_STREAM&#39;</span><span class="p">)</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">socktype</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c"># test proto and flags arguments</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_TCP</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
        <span class="c"># a server willing to support both IPv4 and IPv6 will</span>
        <span class="c"># usually do this</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
        <span class="c"># test keyword arguments</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_TCP</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_TCP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">flags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="c"># Issue #6697.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\uD800</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># Issue 17269: test workaround for OS X platform bug segfault</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;AI_NUMERICSERV&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># The arguments here are undefined and the call may succeed</span>
                <span class="c"># or fail.  All we care here is that it doesn&#39;t segfault.</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">socket</span><span class="o">.</span><span class="n">AI_NUMERICSERV</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
                <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_getnameinfo"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_getnameinfo">[docs]</a>    <span class="k">def</span> <span class="nf">test_getnameinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># only IP addresses are allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">getnameinfo</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;mail.python.org&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">is_resource_enabled</span><span class="p">(</span><span class="s">&#39;network&#39;</span><span class="p">),</span>
                         <span class="s">&#39;network is not enabled&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.test_idna"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_idna">[docs]</a>    <span class="k">def</span> <span class="nf">test_idna</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check for internet access before running test (issue #12804).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s">&#39;python.org&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">EAI_NODATA</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;internet access required for this test&#39;</span><span class="p">)</span>
        <span class="c"># these should all be successful</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s">&#39;испытание.python.org&#39;</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="s">&#39;испытание.python.org&#39;</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s">&#39;испытание.python.org&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c"># this may not work if the forward lookup choses the IPv6 address, as that doesn&#39;t</span>
        <span class="c"># have a reverse entry yet</span>
        <span class="c"># socket.gethostbyaddr(&#39;испытание.python.org&#39;)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.check_sendall_interrupted"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.check_sendall_interrupted">[docs]</a>    <span class="k">def</span> <span class="nf">check_sendall_interrupted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_timeout</span><span class="p">):</span>
        <span class="c"># socketpair() is not stricly required, but it makes things easier.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;alarm&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;socketpair&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;signal.alarm and socket.socketpair required for this test&quot;</span><span class="p">)</span>
        <span class="c"># Our signal handlers clobber the C errno by calling a math function</span>
        <span class="c"># with an invalid domain value.</span>
        <span class="k">def</span> <span class="nf">ok_handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">acosh</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">raising_handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">acosh</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="mi">1</span> <span class="o">//</span> <span class="mi">0</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socketpair</span><span class="p">()</span>
        <span class="n">old_alarm</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">raising_handler</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">with_timeout</span><span class="p">:</span>
                <span class="c"># Just above the one second minimum for signal.alarm</span>
                <span class="n">c</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">):</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="n">support</span><span class="o">.</span><span class="n">SOCK_MAX_SIZE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">with_timeout</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">ok_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">sendall</span><span class="p">,</span>
                                  <span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="n">support</span><span class="o">.</span><span class="n">SOCK_MAX_SIZE</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">old_alarm</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_sendall_interrupted"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_sendall_interrupted">[docs]</a>    <span class="k">def</span> <span class="nf">test_sendall_interrupted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sendall_interrupted</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_sendall_interrupted_with_timeout"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_sendall_interrupted_with_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_sendall_interrupted_with_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sendall_interrupted</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_dealloc_warn"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_dealloc_warn">[docs]</a>    <span class="k">def</span> <span class="nf">test_dealloc_warn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="n">ResourceWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c"># An open socket file object gets dereferenced after the socket</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="n">ResourceWarning</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">support</span><span class="o">.</span><span class="n">gc_collect</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_name_closed_socketio"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_name_closed_socketio">[docs]</a>    <span class="k">def</span> <span class="nf">test_name_closed_socketio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="s">&quot;&lt;_io.BufferedReader name=-1&gt;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_unusable_closed_socketio"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_unusable_closed_socketio">[docs]</a>    <span class="k">def</span> <span class="nf">test_unusable_closed_socketio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">readable</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">writable</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">seekable</span><span class="p">())</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">readable</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">writable</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">seekable</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_pickle"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">test_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_listen_backlog"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_listen_backlog">[docs]</a>    <span class="k">def</span> <span class="nf">test_listen_backlog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">backlog</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">srv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">srv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
            <span class="n">srv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="GeneralModuleTests.test_listen_backlog_overflow"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_listen_backlog_overflow">[docs]</a>    <span class="k">def</span> <span class="nf">test_listen_backlog_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 15989</span>
        <span class="kn">import</span> <span class="nn">_testcapi</span>
        <span class="n">srv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">srv</span><span class="o">.</span><span class="n">listen</span><span class="p">,</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">INT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">srv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">,</span> <span class="s">&#39;IPv6 required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.test_flowinfo"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_flowinfo">[docs]</a>    <span class="k">def</span> <span class="nf">test_flowinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">getnameinfo</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">HOSTv6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">HOSTv6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="GeneralModuleTests.test_str_for_enums"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_str_for_enums">[docs]</a>    <span class="k">def</span> <span class="nf">test_str_for_enums</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Make sure that the AF_* and SOCK_* constants have enum-like string</span>
        <span class="c"># reprs.</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">family</span><span class="p">),</span> <span class="s">&#39;AddressFamily.AF_INET&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="s">&#39;SocketType.SOCK_STREAM&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">,</span> <span class="s">&#39;Will not work on Windows&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="GeneralModuleTests.test_uknown_socket_family_repr"><a class="viewcode-back" href="../../test.html#test.test_socket.GeneralModuleTests.test_uknown_socket_family_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_uknown_socket_family_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test that when created with a family that&#39;s not one of the known</span>
        <span class="c"># AF_*/SOCK_* constants, socket.family just returns the number.</span>
        <span class="c">#</span>
        <span class="c"># To do this we fool socket.socket into believing it already has an</span>
        <span class="c"># open fd because on this path it doesn&#39;t actually verify the family and</span>
        <span class="c"># type and populates the socket object.</span>
        <span class="c">#</span>
        <span class="c"># On Windows this trick won&#39;t work, so the test is skipped.</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="mi">42424</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">13331</span><span class="p">,</span> <span class="n">fileno</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="mi">42424</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="mi">13331</span><span class="p">)</span>
</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">HAVE_SOCKET_CAN</span><span class="p">,</span> <span class="s">&#39;SocketCan required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicCANTest"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest">[docs]</a><span class="k">class</span> <span class="nc">BasicCANTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="BasicCANTest.testCrucialConstants"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testCrucialConstants">[docs]</a>    <span class="k">def</span> <span class="nf">testCrucialConstants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">AF_CAN</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CAN_BCM&quot;</span><span class="p">),</span>
                         <span class="s">&#39;socket.CAN_BCM required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicCANTest.testBCMConstants"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testBCMConstants">[docs]</a>    <span class="k">def</span> <span class="nf">testBCMConstants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM</span>

        <span class="c"># opcodes</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_SETUP</span>     <span class="c"># create (cyclic) transmission task</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_DELETE</span>    <span class="c"># remove (cyclic) transmission task</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_READ</span>      <span class="c"># read properties of (cyclic) transmission task</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_SEND</span>      <span class="c"># send one CAN frame</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_RX_SETUP</span>     <span class="c"># create RX content filter subscription</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_RX_DELETE</span>    <span class="c"># remove RX content filter subscription</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_RX_READ</span>      <span class="c"># read properties of RX content filter subscription</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_STATUS</span>    <span class="c"># reply to TX_READ request</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_EXPIRED</span>   <span class="c"># notification on performed transmissions (count=0)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_RX_STATUS</span>    <span class="c"># reply to RX_READ request</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_RX_TIMEOUT</span>   <span class="c"># cyclic message is absent</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_RX_CHANGED</span>   <span class="c"># updated CAN frame (detected content change)</span>
</div>
<div class="viewcode-block" id="BasicCANTest.testCreateSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testCreateSocket">[docs]</a>    <span class="k">def</span> <span class="nf">testCreateSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CAN_BCM&quot;</span><span class="p">),</span>
                         <span class="s">&#39;socket.CAN_BCM required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicCANTest.testCreateBCMSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testCreateBCMSocket">[docs]</a>    <span class="k">def</span> <span class="nf">testCreateBCMSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="BasicCANTest.testBindAny"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testBindAny">[docs]</a>    <span class="k">def</span> <span class="nf">testBindAny</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">))</span>
</div>
<div class="viewcode-block" id="BasicCANTest.testTooLongInterfaceName"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testTooLongInterfaceName">[docs]</a>    <span class="k">def</span> <span class="nf">testTooLongInterfaceName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># most systems limit IFNAMSIZ to 16, take 1024 to be sure</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="s">&#39;interface name too long&#39;</span><span class="p">,</span>
                                   <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;x&#39;</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,))</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CAN_RAW_LOOPBACK&quot;</span><span class="p">),</span>
                         <span class="s">&#39;socket.CAN_RAW_LOOPBACK required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicCANTest.testLoopback"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testLoopback">[docs]</a>    <span class="k">def</span> <span class="nf">testLoopback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">loopback</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_CAN_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW_LOOPBACK</span><span class="p">,</span>
                             <span class="n">loopback</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">loopback</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_CAN_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW_LOOPBACK</span><span class="p">))</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CAN_RAW_FILTER&quot;</span><span class="p">),</span>
                         <span class="s">&#39;socket.CAN_RAW_FILTER required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicCANTest.testFilter"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicCANTest.testFilter">[docs]</a>    <span class="k">def</span> <span class="nf">testFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">can_id</span><span class="p">,</span> <span class="n">can_mask</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x700</span>
        <span class="n">can_filter</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;=II&quot;</span><span class="p">,</span> <span class="n">can_id</span><span class="p">,</span> <span class="n">can_mask</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_CAN_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW_FILTER</span><span class="p">,</span> <span class="n">can_filter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">can_filter</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_CAN_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_RAW_FILTER</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">HAVE_SOCKET_CAN</span><span class="p">,</span> <span class="s">&#39;SocketCan required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="CANTest"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest">[docs]</a><span class="k">class</span> <span class="nc">CANTest</span><span class="p">(</span><span class="n">ThreadedCANSocketTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">ThreadedCANSocketTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="CANTest.build_can_frame"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest.build_can_frame">[docs]</a>    <span class="k">def</span> <span class="nf">build_can_frame</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">can_id</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a CAN frame.&quot;&quot;&quot;</span>
        <span class="n">can_dlc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">can_frame_fmt</span><span class="p">,</span> <span class="n">can_id</span><span class="p">,</span> <span class="n">can_dlc</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="CANTest.dissect_can_frame"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest.dissect_can_frame">[docs]</a>    <span class="k">def</span> <span class="nf">dissect_can_frame</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dissect a CAN frame.&quot;&quot;&quot;</span>
        <span class="n">can_id</span><span class="p">,</span> <span class="n">can_dlc</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">can_frame_fmt</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">can_id</span><span class="p">,</span> <span class="n">can_dlc</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="n">can_dlc</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="CANTest.testSendFrame"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest.testSendFrame">[docs]</a>    <span class="k">def</span> <span class="nf">testSendFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_CAN</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_can_frame</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x01\x02\x03\x04\x05</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">)</span>

<div class="viewcode-block" id="CANTest.testSendMaxFrame"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest.testSendMaxFrame">[docs]</a>    <span class="k">def</span> <span class="nf">testSendMaxFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendMaxFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_can_frame</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x07</span><span class="s">&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">)</span>

<div class="viewcode-block" id="CANTest.testSendMultiFrames"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest.testSendMultiFrames">[docs]</a>    <span class="k">def</span> <span class="nf">testSendMultiFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf1</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>

        <span class="n">cf</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf2</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendMultiFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_can_frame</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x44\x33\x22\x11</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_can_frame</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x99\x22\x33</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf2</span><span class="p">)</span>

    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CAN_BCM&quot;</span><span class="p">),</span>
                         <span class="s">&#39;socket.CAN_BCM required for this test.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_testBCM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">,</span> <span class="n">cf</span><span class="p">)</span>
        <span class="n">can_id</span><span class="p">,</span> <span class="n">can_dlc</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dissect_can_frame</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">can_id</span><span class="p">,</span> <span class="n">can_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CAN_BCM&quot;</span><span class="p">),</span>
                         <span class="s">&#39;socket.CAN_BCM required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="CANTest.testBCM"><a class="viewcode-back" href="../../test.html#test.test_socket.CANTest.testBCM">[docs]</a>    <span class="k">def</span> <span class="nf">testBCM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bcm</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_CAN</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">bcm</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">bcm</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can_id</span> <span class="o">=</span> <span class="mh">0x123</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_can_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">can_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">opcode</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">CAN_BCM_TX_SEND</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ival1_seconds</span> <span class="o">=</span> <span class="n">ival1_usec</span> <span class="o">=</span> <span class="n">ival2_seconds</span> <span class="o">=</span> <span class="n">ival2_usec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bcm_can_id</span> <span class="o">=</span> <span class="mh">0x0222</span>
        <span class="n">nframes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcm_cmd_msg_fmt</span><span class="p">,</span>
                    <span class="n">opcode</span><span class="p">,</span>
                    <span class="n">flags</span><span class="p">,</span>
                    <span class="n">count</span><span class="p">,</span>
                    <span class="n">ival1_seconds</span><span class="p">,</span>
                    <span class="n">ival1_usec</span><span class="p">,</span>
                    <span class="n">ival2_seconds</span><span class="p">,</span>
                    <span class="n">ival2_usec</span><span class="p">,</span>
                    <span class="n">bcm_can_id</span><span class="p">,</span>
                    <span class="n">nframes</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="n">header_plus_frame</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span>
        <span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">bcm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">header_plus_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bytes_sent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_plus_frame</span><span class="p">))</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">HAVE_SOCKET_RDS</span><span class="p">,</span> <span class="s">&#39;RDS sockets required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicRDSTest"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicRDSTest">[docs]</a><span class="k">class</span> <span class="nc">BasicRDSTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="BasicRDSTest.testCrucialConstants"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicRDSTest.testCrucialConstants">[docs]</a>    <span class="k">def</span> <span class="nf">testCrucialConstants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">AF_RDS</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">PF_RDS</span>
</div>
<div class="viewcode-block" id="BasicRDSTest.testCreateSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicRDSTest.testCreateSocket">[docs]</a>    <span class="k">def</span> <span class="nf">testCreateSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_RDS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="BasicRDSTest.testSocketBufferSize"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicRDSTest.testSocketBufferSize">[docs]</a>    <span class="k">def</span> <span class="nf">testSocketBufferSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">16384</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">PF_RDS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_SNDBUF</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">HAVE_SOCKET_RDS</span><span class="p">,</span> <span class="s">&#39;RDS sockets required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RDSTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest">[docs]</a><span class="k">class</span> <span class="nc">RDSTest</span><span class="p">(</span><span class="n">ThreadedRDSSocketTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">ThreadedRDSSocketTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="RDSTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RDSTest.testSendAndRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.testSendAndRecv">[docs]</a>    <span class="k">def</span> <span class="nf">testSendAndRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendAndRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;spam&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="RDSTest.testPeek"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.testPeek">[docs]</a>    <span class="k">def</span> <span class="nf">testPeek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">MSG_PEEK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testPeek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;spam&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;recvmsg&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RDSTest.testSendAndRecvMsg"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.testSendAndRecvMsg">[docs]</a>    <span class="k">def</span> <span class="nf">testSendAndRecvMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">msg_flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;sendmsg&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_testSendAndRecvMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;hello &#39;</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="RDSTest.testSendAndRecvMulti"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.testSendAndRecvMulti">[docs]</a>    <span class="k">def</span> <span class="nf">testSendAndRecvMulti</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data2</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendAndRecvMulti</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data1</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;bacon&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data2</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;egg&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="RDSTest.testSelect"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.testSelect">[docs]</a>    <span class="k">def</span> <span class="nf">testSelect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSelect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;select&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="RDSTest.testCongestion"><a class="viewcode-back" href="../../test.html#test.test_socket.RDSTest.testCongestion">[docs]</a>    <span class="k">def</span> <span class="nf">testCongestion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># wait until the sender is done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_testCongestion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># test the behavior in case of congestion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;fill&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># try to lower the receiver&#39;s socket buffer size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">,</span> <span class="mi">16384</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># fill the receiver&#39;s socket buffer</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c"># signal the receiver we&#39;re done</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="c"># sendto() should have failed with ENOBUFS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOBUFS</span><span class="p">)</span>
        <span class="c"># and we should have received a congestion notification through poll</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicTCPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest">[docs]</a><span class="k">class</span> <span class="nc">BasicTCPTest</span><span class="p">(</span><span class="n">SocketConnectedTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testRecv">[docs]</a>    <span class="k">def</span> <span class="nf">testRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing large receive over TCP</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testOverFlowRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testOverFlowRecv">[docs]</a>    <span class="k">def</span> <span class="nf">testOverFlowRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing receive in chunks over TCP</span>
        <span class="n">seg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">seg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">seg1</span> <span class="o">+</span> <span class="n">seg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testOverFlowRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testRecvFrom"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testRecvFrom">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing large recvfrom() over TCP</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testOverFlowRecvFrom"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testOverFlowRecvFrom">[docs]</a>    <span class="k">def</span> <span class="nf">testOverFlowRecvFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing recvfrom() in chunks over TCP</span>
        <span class="n">seg1</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">seg2</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">seg1</span> <span class="o">+</span> <span class="n">seg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testOverFlowRecvFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testSendAll"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testSendAll">[docs]</a>    <span class="k">def</span> <span class="nf">testSendAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing sendall() with a 2048 byte string over TCP</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">read</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;f&#39;</span> <span class="o">*</span> <span class="mi">2048</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">big_chunk</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;f&#39;</span> <span class="o">*</span> <span class="mi">2048</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">big_chunk</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testFromFd"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testFromFd">[docs]</a>    <span class="k">def</span> <span class="nf">testFromFd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing fromfd()</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">fromfd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testFromFd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testDup"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testDup">[docs]</a>    <span class="k">def</span> <span class="nf">testDup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing dup()</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">dup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testDup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testShutdown"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testShutdown">[docs]</a>    <span class="k">def</span> <span class="nf">testShutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing shutdown()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="c"># wait for _testShutdown to finish: on OS X, when the server</span>
        <span class="c"># closes the connection the client also becomes disconnected,</span>
        <span class="c"># and the client&#39;s shutdown call will fail. (Issue #4397.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_testShutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">testShutdown_overflow</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">cpython_only</span><span class="p">(</span><span class="n">testShutdown</span><span class="p">)</span>

    <span class="nd">@support.cpython_only</span>
    <span class="k">def</span> <span class="nf">_testShutdown_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">_testcapi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
        <span class="c"># Issue 15989</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">shutdown</span><span class="p">,</span>
                          <span class="n">_testcapi</span><span class="o">.</span><span class="n">INT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">shutdown</span><span class="p">,</span>
                          <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">_testcapi</span><span class="o">.</span><span class="n">UINT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="BasicTCPTest.testDetach"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest.testDetach">[docs]</a>    <span class="k">def</span> <span class="nf">testDetach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing detach()</span>
        <span class="n">fileno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fileno</span><span class="p">)</span>
        <span class="c"># cli_conn cannot be used anymore...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># ...but we can create another socket using the (still open)</span>
        <span class="c"># file descriptor</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">fileno</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testDetach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicUDPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicUDPTest">[docs]</a><span class="k">class</span> <span class="nc">BasicUDPTest</span><span class="p">(</span><span class="n">ThreadedUDPSocketTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">ThreadedUDPSocketTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="BasicUDPTest.testSendtoAndRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicUDPTest.testSendtoAndRecv">[docs]</a>    <span class="k">def</span> <span class="nf">testSendtoAndRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing sendto() and Recv() over UDP</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendtoAndRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="BasicUDPTest.testRecvFrom"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicUDPTest.testRecvFrom">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing recvfrom() over UDP</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="BasicUDPTest.testRecvFromNegative"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicUDPTest.testRecvFromNegative">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFromNegative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Negative lengths passed to recvfrom should give ValueError.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvFromNegative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<span class="c"># Tests for the sendmsg()/recvmsg() interface.  Where possible, the</span>
<span class="c"># same test code is used with different families and types of socket</span>
<span class="c"># (e.g. stream, datagram), and tests using recvmsg() are repeated</span>
<span class="c"># using recvmsg_into().</span>
<span class="c">#</span>
<span class="c"># The generic test classes such as SendmsgTests and</span>
<span class="c"># RecvmsgGenericTests inherit from SendrecvmsgBase and expect to be</span>
<span class="c"># supplied with sockets cli_sock and serv_sock representing the</span>
<span class="c"># client&#39;s and the server&#39;s end of the connection respectively, and</span>
<span class="c"># attributes cli_addr and serv_addr holding their (numeric where</span>
<span class="c"># appropriate) addresses.</span>
<span class="c">#</span>
<span class="c"># The final concrete test classes combine these with subclasses of</span>
<span class="c"># SocketTestBase which set up client and server sockets of a specific</span>
<span class="c"># type, and with subclasses of SendrecvmsgBase such as</span>
<span class="c"># SendrecvmsgDgramBase and SendrecvmsgConnectedBase which map these</span>
<span class="c"># sockets to cli_sock and serv_sock and override the methods and</span>
<span class="c"># attributes of SendrecvmsgBase to fill in destination addresses if</span>
<span class="c"># needed when sending, check for specific flags in msg_flags, etc.</span>
<span class="c">#</span>
<span class="c"># RecvmsgIntoMixin provides a version of doRecvmsg() implemented using</span>
<span class="c"># recvmsg_into().</span>

<span class="c"># XXX: like the other datagram (UDP) tests in this module, the code</span>
<span class="c"># here assumes that datagram delivery on the local machine will be</span>
<span class="c"># reliable.</span>
</div>
<div class="viewcode-block" id="SendrecvmsgBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgBase</span><span class="p">(</span><span class="n">ThreadSafeCleanupTestCase</span><span class="p">):</span>
    <span class="c"># Base class for sendmsg()/recvmsg() tests.</span>

    <span class="c"># Time in seconds to wait before considering a test failed, or</span>
    <span class="c"># None for no timeout.  Not all tests actually set a timeout.</span>
    <span class="n">fail_timeout</span> <span class="o">=</span> <span class="mf">3.0</span>

<div class="viewcode-block" id="SendrecvmsgBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SendrecvmsgBase.sendToServer"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.sendToServer">[docs]</a>    <span class="k">def</span> <span class="nf">sendToServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># Send msg to the server.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c"># Tuple of alternative default arguments for sendmsg() when called</span>
    <span class="c"># via sendmsgToServer() (e.g. to include a destination address).</span></div>
    <span class="n">sendmsg_to_server_defaults</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="SendrecvmsgBase.sendmsgToServer"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.sendmsgToServer">[docs]</a>    <span class="k">def</span> <span class="nf">sendmsgToServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># Call sendmsg() on self.cli_sock with the given arguments,</span>
        <span class="c"># filling in any arguments which are not supplied with the</span>
        <span class="c"># corresponding items of self.sendmsg_to_server_defaults, if</span>
        <span class="c"># any.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">(</span>
            <span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsg_to_server_defaults</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):]))</span>
</div>
<div class="viewcode-block" id="SendrecvmsgBase.doRecvmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.doRecvmsg">[docs]</a>    <span class="k">def</span> <span class="nf">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># Call recvmsg() on sock with given arguments and return its</span>
        <span class="c"># result.  Should be used for tests which can use either</span>
        <span class="c"># recvmsg() or recvmsg_into() - RecvmsgIntoMixin overrides</span>
        <span class="c"># this method with one which emulates it using recvmsg_into(),</span>
        <span class="c"># thus allowing the same test to be used for both methods.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">(</span><span class="n">bufsize</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerRecvmsgResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="SendrecvmsgBase.registerRecvmsgResult"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.registerRecvmsgResult">[docs]</a>    <span class="k">def</span> <span class="nf">registerRecvmsgResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c"># Called by doRecvmsg() with the return value of recvmsg() or</span>
        <span class="c"># recvmsg_into().  Can be overridden to arrange cleanup based</span>
        <span class="c"># on the returned ancillary data, for instance.</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SendrecvmsgBase.checkRecvmsgAddress"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.checkRecvmsgAddress">[docs]</a>    <span class="k">def</span> <span class="nf">checkRecvmsgAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">):</span>
        <span class="c"># Called to compare the received address with the address of</span>
        <span class="c"># the peer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">)</span>

    <span class="c"># Flags that are normally unset in msg_flags</span></div>
    <span class="n">msg_flags_common_unset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;MSG_CTRUNC&quot;</span><span class="p">,</span> <span class="s">&quot;MSG_OOB&quot;</span><span class="p">):</span>
        <span class="n">msg_flags_common_unset</span> <span class="o">|=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c"># Flags that are normally set</span>
    <span class="n">msg_flags_common_set</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># Flags set when a complete record has been received (e.g. MSG_EOR</span>
    <span class="c"># for SCTP)</span>
    <span class="n">msg_flags_eor_indicator</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># Flags set when a complete record has not been received</span>
    <span class="c"># (e.g. MSG_TRUNC for datagram sockets)</span>
    <span class="n">msg_flags_non_eor_indicator</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="SendrecvmsgBase.checkFlags"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgBase.checkFlags">[docs]</a>    <span class="k">def</span> <span class="nf">checkFlags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">checkunset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Method to check the value of msg_flags returned by recvmsg[_into]().</span>
        <span class="c">#</span>
        <span class="c"># Checks that all bits in msg_flags_common_set attribute are</span>
        <span class="c"># set in &quot;flags&quot; and all bits in msg_flags_common_unset are</span>
        <span class="c"># unset.</span>
        <span class="c">#</span>
        <span class="c"># The &quot;eor&quot; argument specifies whether the flags should</span>
        <span class="c"># indicate that a full record (or datagram) has been received.</span>
        <span class="c"># If &quot;eor&quot; is None, no checks are done; otherwise, checks</span>
        <span class="c"># that:</span>
        <span class="c">#</span>
        <span class="c">#  * if &quot;eor&quot; is true, all bits in msg_flags_eor_indicator are</span>
        <span class="c">#    set and all bits in msg_flags_non_eor_indicator are unset</span>
        <span class="c">#</span>
        <span class="c">#  * if &quot;eor&quot; is false, all bits in msg_flags_non_eor_indicator</span>
        <span class="c">#    are set and all bits in msg_flags_eor_indicator are unset</span>
        <span class="c">#</span>
        <span class="c"># If &quot;checkset&quot; and/or &quot;checkunset&quot; are supplied, they require</span>
        <span class="c"># the given bits to be set or unset respectively, overriding</span>
        <span class="c"># what the attributes require for those bits.</span>
        <span class="c">#</span>
        <span class="c"># If any bits are set in &quot;ignore&quot;, they will not be checked,</span>
        <span class="c"># regardless of the other inputs.</span>
        <span class="c">#</span>
        <span class="c"># Will raise Exception if the inputs require a bit to be both</span>
        <span class="c"># set and unset, and it is not ignored.</span>

        <span class="n">defaultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_flags_common_set</span>
        <span class="n">defaultunset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_flags_common_unset</span>

        <span class="k">if</span> <span class="n">eor</span><span class="p">:</span>
            <span class="n">defaultset</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_flags_eor_indicator</span>
            <span class="n">defaultunset</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_flags_non_eor_indicator</span>
        <span class="k">elif</span> <span class="n">eor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">defaultset</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_flags_non_eor_indicator</span>
            <span class="n">defaultunset</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_flags_eor_indicator</span>

        <span class="c"># Function arguments override defaults</span>
        <span class="n">defaultset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">checkunset</span>
        <span class="n">defaultunset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">checkset</span>

        <span class="c"># Merge arguments with remaining defaults, and check for conflicts</span>
        <span class="n">checkset</span> <span class="o">|=</span> <span class="n">defaultset</span>
        <span class="n">checkunset</span> <span class="o">|=</span> <span class="n">defaultunset</span>
        <span class="n">inboth</span> <span class="o">=</span> <span class="n">checkset</span> <span class="o">&amp;</span> <span class="n">checkunset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ignore</span>
        <span class="k">if</span> <span class="n">inboth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;contradictory set, unset requirements for flags &quot;</span>
                            <span class="s">&quot;{0:#x}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inboth</span><span class="p">))</span>

        <span class="c"># Compare with given msg_flags value</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">checkset</span> <span class="o">|</span> <span class="n">checkunset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">,</span> <span class="n">checkset</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="RecvmsgIntoMixin"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoMixin">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoMixin</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Mixin to implement doRecvmsg() using recvmsg_into().</span>

<div class="viewcode-block" id="RecvmsgIntoMixin.doRecvmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoMixin.doRecvmsg">[docs]</a>    <span class="k">def</span> <span class="nf">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">([</span><span class="n">buf</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerRecvmsgResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bufsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),)</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

</div></div>
<div class="viewcode-block" id="SendrecvmsgDgramFlagsBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgDgramFlagsBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgDgramFlagsBase</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Defines flags to be checked in msg_flags for datagram sockets.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msg_flags_non_eor_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">msg_flags_non_eor_indicator</span> <span class="o">|</span> <span class="n">socket</span><span class="o">.</span><span class="n">MSG_TRUNC</span>

</div>
<div class="viewcode-block" id="SendrecvmsgSCTPFlagsBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgSCTPFlagsBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgSCTPFlagsBase</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Defines flags to be checked in msg_flags for SCTP sockets.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msg_flags_eor_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">msg_flags_eor_indicator</span> <span class="o">|</span> <span class="n">socket</span><span class="o">.</span><span class="n">MSG_EOR</span>

</div>
<div class="viewcode-block" id="SendrecvmsgConnectionlessBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgConnectionlessBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgConnectionlessBase</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Base class for tests on connectionless-mode sockets.  Users must</span>
    <span class="c"># supply sockets on attributes cli and serv to be mapped to</span>
    <span class="c"># cli_sock and serv_sock respectively.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serv_sock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cli_sock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sendmsg_to_server_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">([],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span><span class="p">)</span>

<div class="viewcode-block" id="SendrecvmsgConnectionlessBase.sendToServer"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgConnectionlessBase.sendToServer">[docs]</a>    <span class="k">def</span> <span class="nf">sendToServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SendrecvmsgConnectedBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgConnectedBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgConnectedBase</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Base class for tests on connected sockets.  Users must supply</span>
    <span class="c"># sockets on attributes serv_conn and cli_conn (representing the</span>
    <span class="c"># connections *to* the server and the client), to be mapped to</span>
    <span class="c"># cli_sock and serv_sock respectively.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serv_sock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cli_sock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span>

<div class="viewcode-block" id="SendrecvmsgConnectedBase.checkRecvmsgAddress"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgConnectedBase.checkRecvmsgAddress">[docs]</a>    <span class="k">def</span> <span class="nf">checkRecvmsgAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">):</span>
        <span class="c"># Address is currently &quot;unspecified&quot; for a connected socket,</span>
        <span class="c"># so we don&#39;t examine it</span>
        <span class="k">pass</span>

</div></div>
<div class="viewcode-block" id="SendrecvmsgServerTimeoutBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgServerTimeoutBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgServerTimeoutBase</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Base class to set a timeout on server&#39;s socket.</span>

<div class="viewcode-block" id="SendrecvmsgServerTimeoutBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgServerTimeoutBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SendmsgTests"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests">[docs]</a><span class="k">class</span> <span class="nc">SendmsgTests</span><span class="p">(</span><span class="n">SendrecvmsgServerTimeoutBase</span><span class="p">):</span>
    <span class="c"># Tests for sendmsg() which can use any socket type and do not</span>
    <span class="c"># involve recvmsg() or recvmsg_into().</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsg">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Send a simple message with sendmsg().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgDataGenerator"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgDataGenerator">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgDataGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Send from buffer obtained from a generator (not a sequence).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgDataGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">((</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MSG</span><span class="p">])),</span>
                         <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgAncillaryGenerator"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgAncillaryGenerator">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgAncillaryGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Gather (empty) ancillary data from a generator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgAncillaryGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span> <span class="p">(</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[])),</span>
                         <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgArray"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgArray">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Send data from an array instead of the usual bytes object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)]),</span>
                         <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgGather"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgGather">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgGather</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Send message data from more than one buffer (gather write).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgGather</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">MSG</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgBadArgs"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgBadArgs">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgBadArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that sendmsg() rejects invalid arguments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgBadArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="n">b</span><span class="s">&quot;not in an iterable&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="nb">object</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="nb">object</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">,</span> <span class="nb">object</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="nb">object</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[],</span> <span class="nb">object</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">object</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgBadCmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgBadCmsg">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgBadCmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that invalid ancillary data items are rejected.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgBadCmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[</span><span class="nb">object</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="nb">object</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;data&quot;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">object</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;data&quot;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">object</span><span class="p">())])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgTests.testSendmsgBadMultiCmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgBadMultiCmsg">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgBadMultiCmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that invalid ancillary data items are rejected when</span>
        <span class="c"># more than one item is present.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@testSendmsgBadMultiCmsg.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSendmsgBadMultiCmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="nb">object</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgExcessCmsgReject"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgExcessCmsgReject">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgExcessCmsgReject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that sendmsg() rejects excess ancillary data items</span>
        <span class="c"># when the number that can be sent is limited.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgExcessCmsgReject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">):</span>
            <span class="c"># Can only send one item</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SendmsgTests.testSendmsgAfterClose"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTests.testSendmsgAfterClose">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgAfterClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that sendmsg() fails on a closed socket.</span>
        <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgAfterClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">,</span> <span class="p">[</span><span class="n">MSG</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="SendmsgStreamTests"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgStreamTests">[docs]</a><span class="k">class</span> <span class="nc">SendmsgStreamTests</span><span class="p">(</span><span class="n">SendmsgTests</span><span class="p">):</span>
    <span class="c"># Tests for sendmsg() which require a stream socket and do not</span>
    <span class="c"># involve recvmsg() or recvmsg_into().</span>

<div class="viewcode-block" id="SendmsgStreamTests.testSendmsgExplicitNoneAddr"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgStreamTests.testSendmsgExplicitNoneAddr">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgExplicitNoneAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that peer address can be specified as None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgExplicitNoneAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SendmsgStreamTests.testSendmsgTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgStreamTests.testSendmsgTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that timeout works with sendmsg().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="c"># XXX: would be nice to have more tests for sendmsg flags argument.</span>

    <span class="c"># Linux supports MSG_DONTWAIT when sending, but in general, it</span>
    <span class="c"># only works when receiving.  Could add other platforms if they</span>
    <span class="c"># support it too.</span>
    <span class="nd">@skipWithClientIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;linux2&quot;</span><span class="p">},</span>
                      <span class="s">&quot;MSG_DONTWAIT not known to work on this platform when &quot;</span>
                      <span class="s">&quot;sending&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgStreamTests.testSendmsgDontWait"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgStreamTests.testSendmsgDontWait">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgDontWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that MSG_DONTWAIT in flags causes non-blocking behaviour.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
</div>
    <span class="nd">@testSendmsgDontWait.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSendmsgDontWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">],</span> <span class="p">[],</span> <span class="n">socket</span><span class="o">.</span><span class="n">MSG_DONTWAIT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EWOULDBLOCK</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="SendmsgConnectionlessTests"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgConnectionlessTests">[docs]</a><span class="k">class</span> <span class="nc">SendmsgConnectionlessTests</span><span class="p">(</span><span class="n">SendmsgTests</span><span class="p">):</span>
    <span class="c"># Tests for sendmsg() which require a connectionless-mode</span>
    <span class="c"># (e.g. datagram) socket, and do not involve recvmsg() or</span>
    <span class="c"># recvmsg_into().</span>

<div class="viewcode-block" id="SendmsgConnectionlessTests.testSendmsgNoDestAddr"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgConnectionlessTests.testSendmsgNoDestAddr">[docs]</a>    <span class="k">def</span> <span class="nf">testSendmsgNoDestAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that sendmsg() fails when no destination address is</span>
        <span class="c"># given for unconnected socket.</span>
        <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">_testSendmsgNoDestAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RecvmsgGenericTests"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgGenericTests</span><span class="p">(</span><span class="n">SendrecvmsgBase</span><span class="p">):</span>
    <span class="c"># Tests for recvmsg() which can also be emulated using</span>
    <span class="c"># recvmsg_into(), and can use any socket type.</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsg">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive a simple message with recvmsg[_into]().</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgExplicitDefaults"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgExplicitDefaults">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgExplicitDefaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test recvmsg[_into]() with default arguments provided explicitly.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgExplicitDefaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgShorter"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgShorter">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgShorter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive a message smaller than buffer.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgShorter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="c"># FreeBSD &lt; 8 doesn&#39;t always set the MSG_TRUNC flag when a truncated</span>
    <span class="c"># datagram is received (issue #13001).</span>
    <span class="nd">@support.requires_freebsd_version</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgTrunc"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgTrunc">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgTrunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive part of message, check for truncation indicators.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@support.requires_freebsd_version</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_testRecvmsgTrunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgShortAncillaryBuf"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgShortAncillaryBuf">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgShortAncillaryBuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test ancillary data buffer too small to hold any ancillary data.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgShortAncillaryBuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgLongAncillaryBuf"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgLongAncillaryBuf">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgLongAncillaryBuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test large ancillary data buffer.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgLongAncillaryBuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgAfterClose"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgAfterClose">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgAfterClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that recvmsg[_into]() fails on a closed socket.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgAfterClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that timeout works.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;MSG_PEEK&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgPeek"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgPeek">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgPeek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that MSG_PEEK in flags enables examination of pending</span>
        <span class="c"># data without consuming it.</span>

        <span class="c"># Receive part of data with MSG_PEEK.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">socket</span><span class="o">.</span><span class="n">MSG_PEEK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c"># Ignoring MSG_TRUNC here (so this test is the same for stream</span>
        <span class="c"># and datagram sockets).  Some wording in POSIX seems to</span>
        <span class="c"># suggest that it needn&#39;t be set when peeking, but that may</span>
        <span class="c"># just be a slip.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;MSG_TRUNC&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c"># Receive all data with MSG_PEEK.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">socket</span><span class="o">.</span><span class="n">MSG_PEEK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Check that the same data can still be received normally.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@testRecvmsgPeek.client_skip</span>
    <span class="k">def</span> <span class="nf">_testRecvmsgPeek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgGenericTests.testRecvmsgFromSendmsg"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericTests.testRecvmsgFromSendmsg">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgFromSendmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test receiving with recvmsg[_into]() when message is sent</span>
        <span class="c"># using sendmsg().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@testRecvmsgFromSendmsg.client_skip</span>
    <span class="k">def</span> <span class="nf">_testRecvmsgFromSendmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">MSG</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="RecvmsgGenericStreamTests"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericStreamTests">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgGenericStreamTests</span><span class="p">(</span><span class="n">RecvmsgGenericTests</span><span class="p">):</span>
    <span class="c"># Tests which require a stream socket and can use either recvmsg()</span>
    <span class="c"># or recvmsg_into().</span>

<div class="viewcode-block" id="RecvmsgGenericStreamTests.testRecvmsgEOF"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericStreamTests.testRecvmsgEOF">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgEOF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive end-of-stream indicator (b&quot;&quot;, peer socket closed).</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c"># Might not have end-of-record marker</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgEOF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="RecvmsgGenericStreamTests.testRecvmsgOverflow"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgGenericStreamTests.testRecvmsgOverflow">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgOverflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive a message in more than one chunk.</span>
        <span class="n">seg1</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">seg2</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">seg1</span> <span class="o">+</span> <span class="n">seg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgOverflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RecvmsgTests"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgTests">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgTests</span><span class="p">(</span><span class="n">RecvmsgGenericTests</span><span class="p">):</span>
    <span class="c"># Tests for recvmsg() which can use any socket type.</span>

<div class="viewcode-block" id="RecvmsgTests.testRecvmsgBadArgs"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgTests.testRecvmsgBadArgs">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgBadArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that recvmsg() rejects invalid arguments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span>
                          <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span>
                          <span class="p">[</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">10</span><span class="p">)],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span>
                          <span class="nb">object</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="nb">object</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">object</span><span class="p">())</span>

        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgBadArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RecvmsgIntoTests"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoTests">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoTests</span><span class="p">(</span><span class="n">RecvmsgIntoMixin</span><span class="p">,</span> <span class="n">RecvmsgGenericTests</span><span class="p">):</span>
    <span class="c"># Tests for recvmsg_into() which can use any socket type.</span>

<div class="viewcode-block" id="RecvmsgIntoTests.testRecvmsgIntoBadArgs"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoTests.testRecvmsgIntoBadArgs">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgIntoBadArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that recvmsg_into() rejects invalid arguments.</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="p">[</span><span class="nb">object</span><span class="p">()],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">b</span><span class="s">&quot;I&#39;m not writable&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">buf</span><span class="p">,</span> <span class="nb">object</span><span class="p">()],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">buf</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">buf</span><span class="p">],</span> <span class="nb">object</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">buf</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">object</span><span class="p">())</span>

        <span class="n">nbytes</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">([</span><span class="n">buf</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgIntoBadArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgIntoTests.testRecvmsgIntoGenerator"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoTests.testRecvmsgIntoGenerator">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgIntoGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive into buffer obtained from a generator (not a sequence).</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">nbytes</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">(</span>
            <span class="p">(</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="n">buf</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgIntoGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgIntoTests.testRecvmsgIntoArray"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoTests.testRecvmsgIntoArray">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgIntoArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive into an array rather than the usual bytearray.</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">nbytes</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">([</span><span class="n">buf</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgIntoArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RecvmsgIntoTests.testRecvmsgIntoScatter"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoTests.testRecvmsgIntoScatter">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgIntoScatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Receive into multiple buffers (scatter write).</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;----&quot;</span><span class="p">)</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;0123456789&quot;</span><span class="p">)</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;--------------&quot;</span><span class="p">)</span>
        <span class="n">nbytes</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">(</span>
            <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">memoryview</span><span class="p">(</span><span class="n">b2</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">b3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;Mary had a little lamb&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;Mary&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;01 had a 9&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b3</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;little lamb---&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvmsgIntoScatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;Mary had a little lamb&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="CmsgMacroTests"><a class="viewcode-back" href="../../test.html#test.test_socket.CmsgMacroTests">[docs]</a><span class="k">class</span> <span class="nc">CmsgMacroTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c"># Test the functions CMSG_LEN() and CMSG_SPACE().  Tests</span>
    <span class="c"># assumptions used by sendmsg() and recvmsg[_into](), which share</span>
    <span class="c"># code with these functions.</span>

    <span class="c"># Match the definition in socketmodule.c</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">_testcapi</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">socklen_t_limit</span> <span class="o">=</span> <span class="mh">0x7fffffff</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">socklen_t_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mh">0x7fffffff</span><span class="p">,</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">INT_MAX</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_LEN&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CmsgMacroTests.testCMSG_LEN"><a class="viewcode-back" href="../../test.html#test.test_socket.CmsgMacroTests.testCMSG_LEN">[docs]</a>    <span class="k">def</span> <span class="nf">testCMSG_LEN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test CMSG_LEN() with various valid and invalid values,</span>
        <span class="c"># checking the assumptions used by recvmsg() and sendmsg().</span>
        <span class="n">toobig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socklen_t_limit</span> <span class="o">-</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">257</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">toobig</span> <span class="o">-</span> <span class="mi">257</span><span class="p">,</span> <span class="n">toobig</span><span class="p">))</span>

        <span class="c"># struct cmsghdr has at least three members, two of which are ints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="c"># This is how recvmsg() calculates the data size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ret</span> <span class="o">-</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socklen_t_limit</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># sendmsg() shares code with these functions, and requires</span>
        <span class="c"># that it reject values over the limit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">,</span> <span class="n">toobig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CmsgMacroTests.testCMSG_SPACE"><a class="viewcode-back" href="../../test.html#test.test_socket.CmsgMacroTests.testCMSG_SPACE">[docs]</a>    <span class="k">def</span> <span class="nf">testCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test CMSG_SPACE() with various valid and invalid values,</span>
        <span class="c"># checking the assumptions used by sendmsg().</span>
        <span class="n">toobig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socklen_t_limit</span> <span class="o">-</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">257</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">toobig</span> <span class="o">-</span> <span class="mi">257</span><span class="p">,</span> <span class="n">toobig</span><span class="p">))</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># struct cmsghdr has at least three members, two of which are ints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socklen_t_limit</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">ret</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># sendmsg() shares code with these functions, and requires</span>
        <span class="c"># that it reject values over the limit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">,</span> <span class="n">toobig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SCMRightsTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest">[docs]</a><span class="k">class</span> <span class="nc">SCMRightsTest</span><span class="p">(</span><span class="n">SendrecvmsgServerTimeoutBase</span><span class="p">):</span>
    <span class="c"># Tests for file descriptor passing on Unix-domain sockets.</span>

    <span class="c"># Invalid file descriptor value that&#39;s unlikely to evaluate to a</span>
    <span class="c"># real FD even if one of its bytes is replaced with a different</span>
    <span class="c"># value (which shouldn&#39;t actually happen).</span>
    <span class="n">badfd</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x5555</span>

<div class="viewcode-block" id="SCMRightsTest.newFDs"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.newFDs">[docs]</a>    <span class="k">def</span> <span class="nf">newFDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c"># Return a list of n file descriptors for newly-created files</span>
        <span class="c"># containing their list indices as ASCII numbers.</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fds</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.checkFDs"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.checkFDs">[docs]</a>    <span class="k">def</span> <span class="nf">checkFDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fds</span><span class="p">):</span>
        <span class="c"># Check that the file descriptors in the given list contain</span>
        <span class="c"># their correct list indices as ASCII numbers.</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">fd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fds</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.registerRecvmsgResult"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.registerRecvmsgResult">[docs]</a>    <span class="k">def</span> <span class="nf">registerRecvmsgResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closeRecvmsgFDs</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.closeRecvmsgFDs"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.closeRecvmsgFDs">[docs]</a>    <span class="k">def</span> <span class="nf">closeRecvmsgFDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recvmsg_result</span><span class="p">):</span>
        <span class="c"># Close all file descriptors specified in the ancillary data</span>
        <span class="c"># of the given return value from recvmsg() or recvmsg_into().</span>
        <span class="k">for</span> <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="ow">in</span> <span class="n">recvmsg_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmsg_level</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span> <span class="ow">and</span>
                    <span class="n">cmsg_type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">):</span>
                <span class="n">fds</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
                <span class="n">fds</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">[:</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">%</span> <span class="n">fds</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">fds</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.createAndSendFDs"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.createAndSendFDs">[docs]</a>    <span class="k">def</span> <span class="nf">createAndSendFDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c"># Send n new file descriptors created by newFDs() to the</span>
        <span class="c"># server, with the constant MSG as the non-ancillary data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span>
                                 <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                                   <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                                   <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFDs</span><span class="p">(</span><span class="n">n</span><span class="p">)))]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.checkRecvmsgFDs"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.checkRecvmsgFDs">[docs]</a>    <span class="k">def</span> <span class="nf">checkRecvmsgFDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numfds</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">maxcmsgs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignoreflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Check that constant MSG was received with numfds file</span>
        <span class="c"># descriptors in a maximum of maxcmsgs control messages (which</span>
        <span class="c"># must contain only complete integers).  By default, check</span>
        <span class="c"># that MSG_CTRUNC is unset, but ignore any flags in</span>
        <span class="c"># ignoreflags.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkunset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignoreflags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="n">maxcmsgs</span><span class="p">)</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ancdata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">%</span> <span class="n">SIZEOF_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fds</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fds</span><span class="p">),</span> <span class="n">numfds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFDs</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.testFDPassSimple"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassSimple">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassSimple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Pass a single FD (array read from bytes object).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                               <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testFDPassSimple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">(</span>
                <span class="p">[</span><span class="n">MSG</span><span class="p">],</span>
                <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                  <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                  <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SCMRightsTest.testMultipleFDPass"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testMultipleFDPass">[docs]</a>    <span class="k">def</span> <span class="nf">testMultipleFDPass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Pass multiple FDs in a single array.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                               <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testMultipleFDPass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SCMRightsTest.testFDPassCMSG_SPACE"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassCMSG_SPACE">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test using CMSG_SPACE() to calculate ancillary buffer size.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span>
            <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span>
                              <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">SIZEOF_INT</span><span class="p">)))</span>
</div>
    <span class="nd">@testFDPassCMSG_SPACE.client_skip</span>
    <span class="k">def</span> <span class="nf">_testFDPassCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testFDPassCMSG_LEN"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassCMSG_LEN">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassCMSG_LEN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test using CMSG_LEN() to calculate ancillary buffer size.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span>
                                            <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">SIZEOF_INT</span><span class="p">)),</span>
                             <span class="c"># RFC 3542 says implementations may set</span>
                             <span class="c"># MSG_CTRUNC if there isn&#39;t enough space</span>
                             <span class="c"># for trailing padding.</span>
                             <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testFDPassCMSG_LEN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;darwin&quot;</span><span class="p">,</span> <span class="s">&quot;skipping, see issue #12958&quot;</span><span class="p">)</span>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SCMRightsTest.testFDPassSeparate"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassSeparate">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassSeparate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Pass two FDs in two separate arrays.  Arrays may be combined</span>
        <span class="c"># into a single control message by the OS.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">),</span>
                             <span class="n">maxcmsgs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</div>
    <span class="nd">@testFDPassSeparate.client_skip</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;darwin&quot;</span><span class="p">,</span> <span class="s">&quot;skipping, see issue #12958&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_testFDPassSeparate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd0</span><span class="p">,</span> <span class="n">fd1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                                          <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">fd0</span><span class="p">])),</span>
                                         <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                                          <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">fd1</span><span class="p">]))]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;darwin&quot;</span><span class="p">,</span> <span class="s">&quot;skipping, see issue #12958&quot;</span><span class="p">)</span>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SCMRightsTest.testFDPassSeparateMinSpace"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassSeparateMinSpace">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassSeparateMinSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Pass two FDs in two separate arrays, receiving them into the</span>
        <span class="c"># minimum space for two arrays.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span>
                                            <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">+</span>
                                            <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)),</span>
                             <span class="n">maxcmsgs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="nd">@testFDPassSeparateMinSpace.client_skip</span>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;darwin&quot;</span><span class="p">,</span> <span class="s">&quot;skipping, see issue #12958&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_testFDPassSeparateMinSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd0</span><span class="p">,</span> <span class="n">fd1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                                          <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">fd0</span><span class="p">])),</span>
                                         <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                                          <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">fd1</span><span class="p">]))]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="SCMRightsTest.sendAncillaryIfPossible"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.sendAncillaryIfPossible">[docs]</a>    <span class="k">def</span> <span class="nf">sendAncillaryIfPossible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">):</span>
        <span class="c"># Try to send msg and ancdata to server, but if the system</span>
        <span class="c"># call fails, just send msg with no ancillary data.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">msg</span><span class="p">],</span> <span class="n">ancdata</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Check that it was the system call that failed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.testFDPassEmpty"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassEmpty">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassEmpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try to pass an empty FD array.  Can receive either no array</span>
        <span class="c"># or an empty array.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgFDs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                               <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">),</span>
                             <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testFDPassEmpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendAncillaryIfPossible</span><span class="p">(</span><span class="n">MSG</span><span class="p">,</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
                                            <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
                                            <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)])</span>

<div class="viewcode-block" id="SCMRightsTest.testFDPassPartialInt"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassPartialInt">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassPartialInt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try to pass a truncated FD array.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="ow">in</span> <span class="n">ancdata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testFDPassPartialInt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendAncillaryIfPossible</span><span class="p">(</span>
            <span class="n">MSG</span><span class="p">,</span>
            <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
              <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
              <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">badfd</span><span class="p">])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SCMRightsTest.testFDPassPartialIntInMiddle"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testFDPassPartialIntInMiddle">[docs]</a>    <span class="k">def</span> <span class="nf">testFDPassPartialIntInMiddle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try to pass two FD arrays, the first of which is truncated.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">10240</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="c"># Arrays may have been combined in a single control message</span>
        <span class="k">for</span> <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="ow">in</span> <span class="n">ancdata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">)</span>
            <span class="n">fds</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">[:</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">%</span> <span class="n">fds</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fds</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFDs</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span>
</div>
    <span class="nd">@testFDPassPartialIntInMiddle.client_skip</span>
    <span class="k">def</span> <span class="nf">_testFDPassPartialIntInMiddle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd0</span><span class="p">,</span> <span class="n">fd1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendAncillaryIfPossible</span><span class="p">(</span>
            <span class="n">MSG</span><span class="p">,</span>
            <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
              <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
              <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">fd0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">badfd</span><span class="p">])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span>
              <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">,</span>
              <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">fd1</span><span class="p">]))])</span>

<div class="viewcode-block" id="SCMRightsTest.checkTruncatedHeader"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.checkTruncatedHeader">[docs]</a>    <span class="k">def</span> <span class="nf">checkTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ignoreflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Check that no ancillary data items are returned when data is</span>
        <span class="c"># truncated inside the cmsghdr structure.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignoreflags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.testCmsgTruncNoBufSize"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTruncNoBufSize">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncNoBufSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that no ancillary data is received when no buffer size</span>
        <span class="c"># is specified.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)),</span>
                                  <span class="c"># BSD seems to set MSG_CTRUNC only</span>
                                  <span class="c"># if an item has been partially</span>
                                  <span class="c"># received.</span>
                                  <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTruncNoBufSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTrunc0"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTrunc0">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTrunc0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that no ancillary data is received when buffer size is 0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
                                  <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTrunc0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Check that no ancillary data is returned for various non-zero</span>
    <span class="c"># (but still too small) buffer sizes.</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTrunc1"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTrunc1">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTrunc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTrunc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTrunc2Int"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTrunc2Int">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTrunc2Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The cmsghdr structure has at least three members, two of</span>
        <span class="c"># which are ints, so we still shouldn&#39;t see any ancillary</span>
        <span class="c"># data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span>
                                                 <span class="n">SIZEOF_INT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTrunc2Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTruncLen0Minus1"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTruncLen0Minus1">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncLen0Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span>
                                                 <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTruncLen0Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># The following tests try to truncate the control message in the</span>
    <span class="c"># middle of the FD array.</span>

<div class="viewcode-block" id="SCMRightsTest.checkTruncatedArray"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.checkTruncatedArray">[docs]</a>    <span class="k">def</span> <span class="nf">checkTruncatedArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancbuf</span><span class="p">,</span> <span class="n">maxdata</span><span class="p">,</span> <span class="n">mindata</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Check that file descriptor data is truncated to between</span>
        <span class="c"># mindata and maxdata bytes when received with buffer size</span>
        <span class="c"># ancbuf, and that any complete file descriptor numbers are</span>
        <span class="c"># valid.</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="n">ancbuf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mindata</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ancdata</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">ancdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SCM_RIGHTS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">mindata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">maxdata</span><span class="p">)</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">fds</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">[:</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span> <span class="o">%</span> <span class="n">fds</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFDs</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SCMRightsTest.testCmsgTruncLen0"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTruncLen0">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncLen0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedArray</span><span class="p">(</span><span class="n">ancbuf</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">maxdata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTruncLen0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTruncLen0Plus1"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTruncLen0Plus1">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncLen0Plus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedArray</span><span class="p">(</span><span class="n">ancbuf</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxdata</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTruncLen0Plus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTruncLen1"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTruncLen1">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncLen1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedArray</span><span class="p">(</span><span class="n">ancbuf</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">),</span>
                                 <span class="n">maxdata</span><span class="o">=</span><span class="n">SIZEOF_INT</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTruncLen1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="SCMRightsTest.testCmsgTruncLen2Minus1"><a class="viewcode-back" href="../../test.html#test.test_socket.SCMRightsTest.testCmsgTruncLen2Minus1">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncLen2Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedArray</span><span class="p">(</span><span class="n">ancbuf</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="n">maxdata</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCmsgTruncLen2Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createAndSendFDs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RFC3542AncillaryTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest">[docs]</a><span class="k">class</span> <span class="nc">RFC3542AncillaryTest</span><span class="p">(</span><span class="n">SendrecvmsgServerTimeoutBase</span><span class="p">):</span>
    <span class="c"># Test sendmsg() and recvmsg[_into]() using the ancillary data</span>
    <span class="c"># features of the RFC 3542 Advanced Sockets API for IPv6.</span>
    <span class="c"># Currently we can only handle certain data items (e.g. traffic</span>
    <span class="c"># class, hop limit, MTU discovery and fragmentation settings)</span>
    <span class="c"># without resorting to unportable means such as the struct module,</span>
    <span class="c"># but the tests here are aimed at testing the ancillary data</span>
    <span class="c"># handling in sendmsg() and recvmsg() rather than the IPv6 API</span>
    <span class="c"># itself.</span>

    <span class="c"># Test value to use when setting hop limit of packet</span>
    <span class="n">hop_limit</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c"># Test value to use when setting traffic class of packet.</span>
    <span class="c"># -1 means &quot;use kernel default&quot;.</span>
    <span class="n">traffic_class</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="RFC3542AncillaryTest.ancillaryMapping"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.ancillaryMapping">[docs]</a>    <span class="k">def</span> <span class="nf">ancillaryMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">):</span>
        <span class="c"># Given ancillary data list ancdata, return a mapping from</span>
        <span class="c"># pairs (cmsg_level, cmsg_type) to corresponding cmsg_data.</span>
        <span class="c"># Check that no (level, type) pair appears more than once.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="ow">in</span> <span class="n">ancdata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">((</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cmsg_data</span>
        <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="RFC3542AncillaryTest.checkHopLimit"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.checkHopLimit">[docs]</a>    <span class="k">def</span> <span class="nf">checkHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancbufsize</span><span class="p">,</span> <span class="n">maxhop</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">ignoreflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Receive hop limit into ancbufsize bytes of ancillary data</span>
        <span class="c"># space.  Check that data is MSG, ancillary data is not</span>
        <span class="c"># truncated (but ignore any flags in ignoreflags), and hop</span>
        <span class="c"># limit is between 0 and maxhop inclusive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVHOPLIMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="n">ancbufsize</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkunset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignoreflags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">ancdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">ancdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxhop</span><span class="p">)</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testRecvHopLimit"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testRecvHopLimit">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test receiving the packet hop limit as ancillary data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimit</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">10240</span><span class="p">)</span>
</div>
    <span class="nd">@testRecvHopLimit.client_skip</span>
    <span class="k">def</span> <span class="nf">_testRecvHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Need to wait until server has asked to receive ancillary</span>
        <span class="c"># data, as implementations are not required to buffer it</span>
        <span class="c"># otherwise.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testRecvHopLimitCMSG_SPACE"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testRecvHopLimitCMSG_SPACE">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvHopLimitCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test receiving hop limit, using CMSG_SPACE to calculate buffer size.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimit</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">))</span>
</div>
    <span class="nd">@testRecvHopLimitCMSG_SPACE.client_skip</span>
    <span class="k">def</span> <span class="nf">_testRecvHopLimitCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="c"># Could test receiving into buffer sized using CMSG_LEN, but RFC</span>
    <span class="c"># 3542 says portable applications must provide space for trailing</span>
    <span class="c"># padding.  Implementations may set MSG_CTRUNC if there isn&#39;t</span>
    <span class="c"># enough space for the padding.</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSetHopLimit"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSetHopLimit">[docs]</a>    <span class="k">def</span> <span class="nf">testSetHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test setting hop limit on outgoing packet and receiving it</span>
        <span class="c"># at the other end.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimit</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">10240</span><span class="p">,</span> <span class="n">maxhop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">)</span>
</div>
    <span class="nd">@testSetHopLimit.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSetHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span>
                                 <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">,</span>
                                   <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">]))]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

<div class="viewcode-block" id="RFC3542AncillaryTest.checkTrafficClassAndHopLimit"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.checkTrafficClassAndHopLimit">[docs]</a>    <span class="k">def</span> <span class="nf">checkTrafficClassAndHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancbufsize</span><span class="p">,</span> <span class="n">maxhop</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                                     <span class="n">ignoreflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Receive traffic class and hop limit into ancbufsize bytes of</span>
        <span class="c"># ancillary data space.  Check that data is MSG, ancillary</span>
        <span class="c"># data is not truncated (but ignore any flags in ignoreflags),</span>
        <span class="c"># and traffic class and hop limit are in range (hop limit no</span>
        <span class="c"># more than maxhop).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVHOPLIMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVTCLASS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="n">ancbufsize</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkunset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignoreflags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ancmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancillaryMapping</span><span class="p">(</span><span class="n">ancdata</span><span class="p">)</span>

        <span class="n">tcdata</span> <span class="o">=</span> <span class="n">ancmap</span><span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_TCLASS</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tcdata</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">tcdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">255</span><span class="p">)</span>

        <span class="n">hldata</span> <span class="o">=</span> <span class="n">ancmap</span><span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hldata</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">hldata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxhop</span><span class="p">)</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testRecvTrafficClassAndHopLimit"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testRecvTrafficClassAndHopLimit">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvTrafficClassAndHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test receiving traffic class and hop limit as ancillary data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTrafficClassAndHopLimit</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">10240</span><span class="p">)</span>
</div>
    <span class="nd">@testRecvTrafficClassAndHopLimit.client_skip</span>
    <span class="k">def</span> <span class="nf">_testRecvTrafficClassAndHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testRecvTrafficClassAndHopLimitCMSG_SPACE"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testRecvTrafficClassAndHopLimitCMSG_SPACE">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvTrafficClassAndHopLimitCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test receiving traffic class and hop limit, using</span>
        <span class="c"># CMSG_SPACE() to calculate buffer size.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTrafficClassAndHopLimit</span><span class="p">(</span>
            <span class="n">ancbufsize</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</div>
    <span class="nd">@testRecvTrafficClassAndHopLimitCMSG_SPACE.client_skip</span>
    <span class="k">def</span> <span class="nf">_testRecvTrafficClassAndHopLimitCMSG_SPACE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSetTrafficClassAndHopLimit"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSetTrafficClassAndHopLimit">[docs]</a>    <span class="k">def</span> <span class="nf">testSetTrafficClassAndHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test setting traffic class and hop limit on outgoing packet,</span>
        <span class="c"># and receiving them at the other end.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTrafficClassAndHopLimit</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">10240</span><span class="p">,</span>
                                          <span class="n">maxhop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">)</span>
</div>
    <span class="nd">@testSetTrafficClassAndHopLimit.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSetTrafficClassAndHopLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">([</span><span class="n">MSG</span><span class="p">],</span>
                                 <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_TCLASS</span><span class="p">,</span>
                                   <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">traffic_class</span><span class="p">])),</span>
                                  <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">,</span>
                                   <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">]))]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testOddCmsgSize"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testOddCmsgSize">[docs]</a>    <span class="k">def</span> <span class="nf">testOddCmsgSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Try to send ancillary data with first item one byte too</span>
        <span class="c"># long.  Fall back to sending with correct size if this fails,</span>
        <span class="c"># and check that second item was handled correctly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTrafficClassAndHopLimit</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">10240</span><span class="p">,</span>
                                          <span class="n">maxhop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">)</span>
</div>
    <span class="nd">@testOddCmsgSize.client_skip</span>
    <span class="k">def</span> <span class="nf">_testOddCmsgSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">(</span>
                <span class="p">[</span><span class="n">MSG</span><span class="p">],</span>
                <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_TCLASS</span><span class="p">,</span>
                  <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">traffic_class</span><span class="p">])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">),</span>
                 <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">,</span>
                  <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">]))])</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendmsgToServer</span><span class="p">(</span>
                <span class="p">[</span><span class="n">MSG</span><span class="p">],</span>
                <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_TCLASS</span><span class="p">,</span>
                  <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">traffic_class</span><span class="p">])),</span>
                 <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">,</span>
                  <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_limit</span><span class="p">]))])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>

    <span class="c"># Tests for proper handling of truncated ancillary data</span>

<div class="viewcode-block" id="RFC3542AncillaryTest.checkHopLimitTruncatedHeader"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.checkHopLimitTruncatedHeader">[docs]</a>    <span class="k">def</span> <span class="nf">checkHopLimitTruncatedHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancbufsize</span><span class="p">,</span> <span class="n">ignoreflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Receive hop limit into ancbufsize bytes of ancillary data</span>
        <span class="c"># space, which should be too small to contain the ancillary</span>
        <span class="c"># data header (if ancbufsize is None, pass no second argument</span>
        <span class="c"># to recvmsg()).  Check that data is MSG, MSG_CTRUNC is set</span>
        <span class="c"># (unless included in ignoreflags), and no ancillary data is</span>
        <span class="c"># returned.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVHOPLIMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">ancbufsize</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">ancbufsize</span><span class="p">,)</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignoreflags</span><span class="p">)</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testCmsgTruncNoBufSize"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testCmsgTruncNoBufSize">[docs]</a>    <span class="k">def</span> <span class="nf">testCmsgTruncNoBufSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that no ancillary data is received when no ancillary</span>
        <span class="c"># buffer size is provided.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimitTruncatedHeader</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="c"># BSD seems to set</span>
                                          <span class="c"># MSG_CTRUNC only if an item</span>
                                          <span class="c"># has been partially</span>
                                          <span class="c"># received.</span>
                                          <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="nd">@testCmsgTruncNoBufSize.client_skip</span>
    <span class="k">def</span> <span class="nf">_testCmsgTruncNoBufSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSingleCmsgTrunc0"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSingleCmsgTrunc0">[docs]</a>    <span class="k">def</span> <span class="nf">testSingleCmsgTrunc0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that no ancillary data is received when ancillary</span>
        <span class="c"># buffer size is zero.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimitTruncatedHeader</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="nd">@testSingleCmsgTrunc0.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSingleCmsgTrunc0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="c"># Check that no ancillary data is returned for various non-zero</span>
    <span class="c"># (but still too small) buffer sizes.</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSingleCmsgTrunc1"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSingleCmsgTrunc1">[docs]</a>    <span class="k">def</span> <span class="nf">testSingleCmsgTrunc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimitTruncatedHeader</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@testSingleCmsgTrunc1.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSingleCmsgTrunc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSingleCmsgTrunc2Int"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSingleCmsgTrunc2Int">[docs]</a>    <span class="k">def</span> <span class="nf">testSingleCmsgTrunc2Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimitTruncatedHeader</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
</div>
    <span class="nd">@testSingleCmsgTrunc2Int.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSingleCmsgTrunc2Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSingleCmsgTruncLen0Minus1"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSingleCmsgTruncLen0Minus1">[docs]</a>    <span class="k">def</span> <span class="nf">testSingleCmsgTruncLen0Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkHopLimitTruncatedHeader</span><span class="p">(</span><span class="n">ancbufsize</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@testSingleCmsgTruncLen0Minus1.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSingleCmsgTruncLen0Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSingleCmsgTruncInData"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSingleCmsgTruncInData">[docs]</a>    <span class="k">def</span> <span class="nf">testSingleCmsgTruncInData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test truncation of a control message inside its associated</span>
        <span class="c"># data.  The message may be returned with its data truncated,</span>
        <span class="c"># or not returned at all.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVHOPLIMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ancdata</span><span class="p">:</span>
            <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">ancdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
</div>
    <span class="nd">@testSingleCmsgTruncInData.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSingleCmsgTruncInData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="RFC3542AncillaryTest.checkTruncatedSecondHeader"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.checkTruncatedSecondHeader">[docs]</a>    <span class="k">def</span> <span class="nf">checkTruncatedSecondHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancbufsize</span><span class="p">,</span> <span class="n">ignoreflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Receive traffic class and hop limit into ancbufsize bytes of</span>
        <span class="c"># ancillary data space, which should be large enough to</span>
        <span class="c"># contain the first item, but too small to contain the header</span>
        <span class="c"># of the second.  Check that data is MSG, MSG_CTRUNC is set</span>
        <span class="c"># (unless included in ignoreflags), and only one ancillary</span>
        <span class="c"># data item is returned.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVHOPLIMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVTCLASS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span> <span class="n">ancbufsize</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">,</span>
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignoreflags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ancdata</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">ancdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">,</span> <span class="p">{</span><span class="n">socket</span><span class="o">.</span><span class="n">IPV6_TCLASS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">255</span><span class="p">)</span>

    <span class="c"># Try the above test with various buffer sizes.</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSecondCmsgTrunc0"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSecondCmsgTrunc0">[docs]</a>    <span class="k">def</span> <span class="nf">testSecondCmsgTrunc0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedSecondHeader</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">),</span>
                                        <span class="n">ignoreflags</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>
</div>
    <span class="nd">@testSecondCmsgTrunc0.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSecondCmsgTrunc0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSecondCmsgTrunc1"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSecondCmsgTrunc1">[docs]</a>    <span class="k">def</span> <span class="nf">testSecondCmsgTrunc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedSecondHeader</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@testSecondCmsgTrunc1.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSecondCmsgTrunc1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSecondCmsgTrunc2Int"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSecondCmsgTrunc2Int">[docs]</a>    <span class="k">def</span> <span class="nf">testSecondCmsgTrunc2Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedSecondHeader</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="mi">2</span> <span class="o">*</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
</div>
    <span class="nd">@testSecondCmsgTrunc2Int.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSecondCmsgTrunc2Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSecondCmsgTruncLen0Minus1"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSecondCmsgTruncLen0Minus1">[docs]</a>    <span class="k">def</span> <span class="nf">testSecondCmsgTruncLen0Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTruncatedSecondHeader</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@testSecondCmsgTruncLen0Minus1.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSecondCmsgTruncLen0Minus1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;CMSG_SPACE&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_RECVHOPLIMIT&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_HOPLIMIT&quot;</span><span class="p">,</span>
                  <span class="s">&quot;IPV6_RECVTCLASS&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_TCLASS&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RFC3542AncillaryTest.testSecomdCmsgTruncInData"><a class="viewcode-back" href="../../test.html#test.test_socket.RFC3542AncillaryTest.testSecomdCmsgTruncInData">[docs]</a>    <span class="k">def</span> <span class="nf">testSecomdCmsgTruncInData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test truncation of the second of two control messages inside</span>
        <span class="c"># its associated data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVHOPLIMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span>
                                  <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_RECVTCLASS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">,</span> <span class="n">ancdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doRecvmsg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv_sock</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">),</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">SIZEOF_INT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRecvmsgAddress</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">eor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">checkset</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">MSG_CTRUNC</span><span class="p">)</span>

        <span class="n">cmsg_types</span> <span class="o">=</span> <span class="p">{</span><span class="n">socket</span><span class="o">.</span><span class="n">IPV6_TCLASS</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_HOPLIMIT</span><span class="p">}</span>

        <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">ancdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">)</span>
        <span class="n">cmsg_types</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">255</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ancdata</span><span class="p">:</span>
            <span class="n">cmsg_level</span><span class="p">,</span> <span class="n">cmsg_type</span><span class="p">,</span> <span class="n">cmsg_data</span> <span class="o">=</span> <span class="n">ancdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cmsg_level</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">)</span>
            <span class="n">cmsg_types</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cmsg_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmsg_data</span><span class="p">),</span> <span class="n">SIZEOF_INT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ancdata</span><span class="p">,</span> <span class="p">[])</span>
</div>
    <span class="nd">@testSecomdCmsgTruncInData.client_skip</span>
    <span class="k">def</span> <span class="nf">_testSecomdCmsgTruncInData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misc_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToServer</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>


<span class="c"># Derive concrete test classes for different socket types.</span>
</div>
<div class="viewcode-block" id="SendrecvmsgUDPTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgUDPTestBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgUDPTestBase</span><span class="p">(</span><span class="n">SendrecvmsgDgramFlagsBase</span><span class="p">,</span>
                             <span class="n">SendrecvmsgConnectionlessBase</span><span class="p">,</span>
                             <span class="n">ThreadedSocketTestMixin</span><span class="p">,</span> <span class="n">UDPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgUDPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgUDPTest">[docs]</a><span class="k">class</span> <span class="nc">SendmsgUDPTest</span><span class="p">(</span><span class="n">SendmsgConnectionlessTests</span><span class="p">,</span> <span class="n">SendrecvmsgUDPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgUDPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgUDPTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgUDPTest</span><span class="p">(</span><span class="n">RecvmsgTests</span><span class="p">,</span> <span class="n">SendrecvmsgUDPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoUDPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoUDPTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoUDPTest</span><span class="p">(</span><span class="n">RecvmsgIntoTests</span><span class="p">,</span> <span class="n">SendrecvmsgUDPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="SendrecvmsgUDP6TestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgUDP6TestBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgUDP6TestBase</span><span class="p">(</span><span class="n">SendrecvmsgDgramFlagsBase</span><span class="p">,</span>
                              <span class="n">SendrecvmsgConnectionlessBase</span><span class="p">,</span>
                              <span class="n">ThreadedSocketTestMixin</span><span class="p">,</span> <span class="n">UDP6TestBase</span><span class="p">):</span>

<div class="viewcode-block" id="SendrecvmsgUDP6TestBase.checkRecvmsgAddress"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgUDP6TestBase.checkRecvmsgAddress">[docs]</a>    <span class="k">def</span> <span class="nf">checkRecvmsgAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">):</span>
        <span class="c"># Called to compare the received address with the address of</span>
        <span class="c"># the peer, ignoring scope ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">addr1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</div></div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">,</span> <span class="s">&#39;IPv6 required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET6&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_DGRAM&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgUDP6Test"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgUDP6Test">[docs]</a><span class="k">class</span> <span class="nc">SendmsgUDP6Test</span><span class="p">(</span><span class="n">SendmsgConnectionlessTests</span><span class="p">,</span> <span class="n">SendrecvmsgUDP6TestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">,</span> <span class="s">&#39;IPv6 required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET6&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_DGRAM&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgUDP6Test"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgUDP6Test">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgUDP6Test</span><span class="p">(</span><span class="n">RecvmsgTests</span><span class="p">,</span> <span class="n">SendrecvmsgUDP6TestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">,</span> <span class="s">&#39;IPv6 required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET6&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_DGRAM&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoUDP6Test"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoUDP6Test">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoUDP6Test</span><span class="p">(</span><span class="n">RecvmsgIntoTests</span><span class="p">,</span> <span class="n">SendrecvmsgUDP6TestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">,</span> <span class="s">&#39;IPv6 required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPPROTO_IPV6&quot;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET6&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_DGRAM&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgRFC3542AncillaryUDP6Test"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgRFC3542AncillaryUDP6Test">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgRFC3542AncillaryUDP6Test</span><span class="p">(</span><span class="n">RFC3542AncillaryTest</span><span class="p">,</span>
                                      <span class="n">SendrecvmsgUDP6TestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">IPV6_ENABLED</span><span class="p">,</span> <span class="s">&#39;IPv6 required for this test.&#39;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;IPPROTO_IPV6&quot;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET6&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_DGRAM&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoRFC3542AncillaryUDP6Test"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoRFC3542AncillaryUDP6Test">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoRFC3542AncillaryUDP6Test</span><span class="p">(</span><span class="n">RecvmsgIntoMixin</span><span class="p">,</span>
                                          <span class="n">RFC3542AncillaryTest</span><span class="p">,</span>
                                          <span class="n">SendrecvmsgUDP6TestBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="SendrecvmsgTCPTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgTCPTestBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgTCPTestBase</span><span class="p">(</span><span class="n">SendrecvmsgConnectedBase</span><span class="p">,</span>
                             <span class="n">ConnectedStreamTestMixin</span><span class="p">,</span> <span class="n">TCPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgTCPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgTCPTest">[docs]</a><span class="k">class</span> <span class="nc">SendmsgTCPTest</span><span class="p">(</span><span class="n">SendmsgStreamTests</span><span class="p">,</span> <span class="n">SendrecvmsgTCPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgTCPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgTCPTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgTCPTest</span><span class="p">(</span><span class="n">RecvmsgTests</span><span class="p">,</span> <span class="n">RecvmsgGenericStreamTests</span><span class="p">,</span>
                     <span class="n">SendrecvmsgTCPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoTCPTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoTCPTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoTCPTest</span><span class="p">(</span><span class="n">RecvmsgIntoTests</span><span class="p">,</span> <span class="n">RecvmsgGenericStreamTests</span><span class="p">,</span>
                         <span class="n">SendrecvmsgTCPTestBase</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="SendrecvmsgSCTPStreamTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgSCTPStreamTestBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgSCTPStreamTestBase</span><span class="p">(</span><span class="n">SendrecvmsgSCTPFlagsBase</span><span class="p">,</span>
                                    <span class="n">SendrecvmsgConnectedBase</span><span class="p">,</span>
                                    <span class="n">ConnectedStreamTestMixin</span><span class="p">,</span> <span class="n">SCTPStreamBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_STREAM&quot;</span><span class="p">,</span> <span class="s">&quot;IPPROTO_SCTP&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgSCTPStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgSCTPStreamTest">[docs]</a><span class="k">class</span> <span class="nc">SendmsgSCTPStreamTest</span><span class="p">(</span><span class="n">SendmsgStreamTests</span><span class="p">,</span> <span class="n">SendrecvmsgSCTPStreamTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_STREAM&quot;</span><span class="p">,</span> <span class="s">&quot;IPPROTO_SCTP&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgSCTPStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgSCTPStreamTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgSCTPStreamTest</span><span class="p">(</span><span class="n">RecvmsgTests</span><span class="p">,</span> <span class="n">RecvmsgGenericStreamTests</span><span class="p">,</span>
                            <span class="n">SendrecvmsgSCTPStreamTestBase</span><span class="p">):</span>

<div class="viewcode-block" id="RecvmsgSCTPStreamTest.testRecvmsgEOF"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgSCTPStreamTest.testRecvmsgEOF">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgEOF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RecvmsgSCTPStreamTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">testRecvmsgEOF</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTCONN</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;sporadic ENOTCONN (kernel issue?) - see issue #13876&quot;</span><span class="p">)</span>
</div></div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@requireSocket</span><span class="p">(</span><span class="s">&quot;AF_INET&quot;</span><span class="p">,</span> <span class="s">&quot;SOCK_STREAM&quot;</span><span class="p">,</span> <span class="s">&quot;IPPROTO_SCTP&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoSCTPStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoSCTPStreamTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoSCTPStreamTest</span><span class="p">(</span><span class="n">RecvmsgIntoTests</span><span class="p">,</span> <span class="n">RecvmsgGenericStreamTests</span><span class="p">,</span>
                                <span class="n">SendrecvmsgSCTPStreamTestBase</span><span class="p">):</span>

<div class="viewcode-block" id="RecvmsgIntoSCTPStreamTest.testRecvmsgEOF"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoSCTPStreamTest.testRecvmsgEOF">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvmsgEOF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RecvmsgIntoSCTPStreamTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">testRecvmsgEOF</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOTCONN</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;sporadic ENOTCONN (kernel issue?) - see issue #13876&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SendrecvmsgUnixStreamTestBase"><a class="viewcode-back" href="../../test.html#test.test_socket.SendrecvmsgUnixStreamTestBase">[docs]</a><span class="k">class</span> <span class="nc">SendrecvmsgUnixStreamTestBase</span><span class="p">(</span><span class="n">SendrecvmsgConnectedBase</span><span class="p">,</span>
                                    <span class="n">ConnectedStreamTestMixin</span><span class="p">,</span> <span class="n">UnixStreamBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;AF_UNIX&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="SendmsgUnixStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.SendmsgUnixStreamTest">[docs]</a><span class="k">class</span> <span class="nc">SendmsgUnixStreamTest</span><span class="p">(</span><span class="n">SendmsgStreamTests</span><span class="p">,</span> <span class="n">SendrecvmsgUnixStreamTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;AF_UNIX&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgUnixStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgUnixStreamTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgUnixStreamTest</span><span class="p">(</span><span class="n">RecvmsgTests</span><span class="p">,</span> <span class="n">RecvmsgGenericStreamTests</span><span class="p">,</span>
                            <span class="n">SendrecvmsgUnixStreamTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;AF_UNIX&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoUnixStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoUnixStreamTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoUnixStreamTest</span><span class="p">(</span><span class="n">RecvmsgIntoTests</span><span class="p">,</span> <span class="n">RecvmsgGenericStreamTests</span><span class="p">,</span>
                                <span class="n">SendrecvmsgUnixStreamTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;AF_UNIX&quot;</span><span class="p">,</span> <span class="s">&quot;SOL_SOCKET&quot;</span><span class="p">,</span> <span class="s">&quot;SCM_RIGHTS&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgSCMRightsStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgSCMRightsStreamTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgSCMRightsStreamTest</span><span class="p">(</span><span class="n">SCMRightsTest</span><span class="p">,</span> <span class="n">SendrecvmsgUnixStreamTestBase</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;AF_UNIX&quot;</span><span class="p">,</span> <span class="s">&quot;SOL_SOCKET&quot;</span><span class="p">,</span> <span class="s">&quot;SCM_RIGHTS&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RecvmsgIntoSCMRightsStreamTest"><a class="viewcode-back" href="../../test.html#test.test_socket.RecvmsgIntoSCMRightsStreamTest">[docs]</a><span class="k">class</span> <span class="nc">RecvmsgIntoSCMRightsStreamTest</span><span class="p">(</span><span class="n">RecvmsgIntoMixin</span><span class="p">,</span> <span class="n">SCMRightsTest</span><span class="p">,</span>
                                     <span class="n">SendrecvmsgUnixStreamTestBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c"># Test interrupting the interruptible send/receive methods with a</span>
<span class="c"># signal when a timeout is set.  These tests avoid having multiple</span>
<span class="c"># threads alive during the test so that the OS cannot deliver the</span>
<span class="c"># signal to the wrong one.</span>
</div>
<div class="viewcode-block" id="InterruptedTimeoutBase"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedTimeoutBase">[docs]</a><span class="k">class</span> <span class="nc">InterruptedTimeoutBase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c"># Base class for interrupted send/receive tests.  Installs an</span>
    <span class="c"># empty handler for SIGALRM and removes it on teardown, along with</span>
    <span class="c"># any scheduled alarms.</span>

<div class="viewcode-block" id="InterruptedTimeoutBase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedTimeoutBase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">orig_alrm_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span>
                                          <span class="k">lambda</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">orig_alrm_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setAlarm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c"># Timeout for socket operations</span></div>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mf">4.0</span>

    <span class="c"># Provide setAlarm() method to schedule delivery of SIGALRM after</span>
    <span class="c"># given number of seconds, or cancel it if zero, and an</span>
    <span class="c"># appropriate time value to use.  Use setitimer() if available.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;setitimer&quot;</span><span class="p">):</span>
        <span class="n">alarm_time</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="k">def</span> <span class="nf">setAlarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Old systems may deliver the alarm up to one second early</span>
        <span class="n">alarm_time</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="InterruptedTimeoutBase.setAlarm"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedTimeoutBase.setAlarm">[docs]</a>        <span class="k">def</span> <span class="nf">setAlarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>


<span class="c"># Require siginterrupt() in order to ensure that system calls are</span>
<span class="c"># interrupted by default.</span></div></div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;siginterrupt&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;alarm&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;setitimer&quot;</span><span class="p">),</span>
                     <span class="s">&quot;Don&#39;t have signal.alarm or signal.setitimer&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest">[docs]</a><span class="k">class</span> <span class="nc">InterruptedRecvTimeoutTest</span><span class="p">(</span><span class="n">InterruptedTimeoutBase</span><span class="p">,</span> <span class="n">UDPTestBase</span><span class="p">):</span>
    <span class="c"># Test interrupting the recv*() methods with signals when a</span>
    <span class="c"># timeout is set.</span>

<div class="viewcode-block" id="InterruptedRecvTimeoutTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.checkInterruptedRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.checkInterruptedRecv">[docs]</a>    <span class="k">def</span> <span class="nf">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Check that func(*args, **kwargs) raises OSError with an</span>
        <span class="c"># errno of EINTR when interrupted by a signal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAlarm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alarm_time</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.testInterruptedRecvTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.testInterruptedRecvTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedRecvTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recv</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.testInterruptedRecvIntoTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.testInterruptedRecvIntoTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedRecvIntoTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recv_into</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.testInterruptedRecvfromTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.testInterruptedRecvfromTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedRecvfromTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.testInterruptedRecvfromIntoTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.testInterruptedRecvfromIntoTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedRecvfromIntoTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.testInterruptedRecvmsgTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.testInterruptedRecvmsgTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedRecvmsgTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvmsg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;recvmsg_into&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedRecvTimeoutTest.testInterruptedRecvmsgIntoTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedRecvTimeoutTest.testInterruptedRecvmsgIntoTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedRecvmsgIntoTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedRecv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recvmsg_into</span><span class="p">,</span> <span class="p">[</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)])</span>


<span class="c"># Require siginterrupt() in order to ensure that system calls are</span>
<span class="c"># interrupted by default.</span></div></div>
<span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;siginterrupt&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;alarm&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&quot;setitimer&quot;</span><span class="p">),</span>
                     <span class="s">&quot;Don&#39;t have signal.alarm or signal.setitimer&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedSendTimeoutTest"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest">[docs]</a><span class="k">class</span> <span class="nc">InterruptedSendTimeoutTest</span><span class="p">(</span><span class="n">InterruptedTimeoutBase</span><span class="p">,</span>
                                 <span class="n">ThreadSafeCleanupTestCase</span><span class="p">,</span>
                                 <span class="n">SocketListeningTestMixin</span><span class="p">,</span> <span class="n">TCPTestBase</span><span class="p">):</span>
    <span class="c"># Test interrupting the interruptible send*() methods with signals</span>
    <span class="c"># when a timeout is set.</span>

<div class="viewcode-block" id="InterruptedSendTimeoutTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newSocket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="c"># Use a thread to complete the connection, but wait for it to</span>
        <span class="c"># terminate before running the test, so that there is only one</span>
        <span class="c"># thread to accept the signal.</span>
        <span class="n">cli_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doConnect</span><span class="p">)</span>
        <span class="n">cli_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">cli_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InterruptedSendTimeoutTest.doConnect"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest.doConnect">[docs]</a>    <span class="k">def</span> <span class="nf">doConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InterruptedSendTimeoutTest.checkInterruptedSend"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest.checkInterruptedSend">[docs]</a>    <span class="k">def</span> <span class="nf">checkInterruptedSend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># Check that func(*args, **kwargs), run in a loop, raises</span>
        <span class="c"># OSError with an errno of EINTR when interrupted by a</span>
        <span class="c"># signal.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setAlarm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alarm_time</span><span class="p">)</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIsInstance</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">)</span>

    <span class="c"># Issue #12958: The following tests have problems on OS X prior to 10.7</span></div>
    <span class="nd">@support.requires_mac_ver</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedSendTimeoutTest.testInterruptedSendTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest.testInterruptedSendTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedSendTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedSend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">)</span>
</div>
    <span class="nd">@support.requires_mac_ver</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedSendTimeoutTest.testInterruptedSendtoTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest.testInterruptedSendtoTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedSendtoTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Passing an actual address here as Python&#39;s wrapper for</span>
        <span class="c"># sendto() doesn&#39;t allow passing a zero-length one; POSIX</span>
        <span class="c"># requires that the address is ignored since the socket is</span>
        <span class="c"># connection-mode, however.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedSend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">sendto</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">serv_addr</span><span class="p">)</span>
</div>
    <span class="nd">@support.requires_mac_ver</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="nd">@requireAttrs</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;sendmsg&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InterruptedSendTimeoutTest.testInterruptedSendmsgTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.InterruptedSendTimeoutTest.testInterruptedSendmsgTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedSendmsgTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkInterruptedSend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">sendmsg</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="s">&quot;a&quot;</span><span class="o">*</span><span class="mi">512</span><span class="p">])</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TCPCloserTest"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPCloserTest">[docs]</a><span class="k">class</span> <span class="nc">TCPCloserTest</span><span class="p">(</span><span class="n">ThreadedTCPSocketTest</span><span class="p">):</span>

<div class="viewcode-block" id="TCPCloserTest.testClose"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPCloserTest.testClose">[docs]</a>    <span class="k">def</span> <span class="nf">testClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span>
        <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">sd</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="p">[</span><span class="n">sd</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># Calling close() many times should be safe.</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_testClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;socketpair&#39;</span><span class="p">),</span>
                     <span class="s">&#39;test needs socket.socketpair()&#39;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BasicSocketPairTest"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicSocketPairTest">[docs]</a><span class="k">class</span> <span class="nc">BasicSocketPairTest</span><span class="p">(</span><span class="n">SocketPairTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketPairTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;AF_UNIX&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_testDefaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_defaults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="p">)</span>

<div class="viewcode-block" id="BasicSocketPairTest.testDefaults"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicSocketPairTest.testDefaults">[docs]</a>    <span class="k">def</span> <span class="nf">testDefaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_defaults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BasicSocketPairTest.testRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicSocketPairTest.testRecv">[docs]</a>    <span class="k">def</span> <span class="nf">testRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BasicSocketPairTest.testSend"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicSocketPairTest.testSend">[docs]</a>    <span class="k">def</span> <span class="nf">testSend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NonBlockingTCPTests"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests">[docs]</a><span class="k">class</span> <span class="nc">NonBlockingTCPTests</span><span class="p">(</span><span class="n">ThreadedTCPSocketTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">ThreadedTCPSocketTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="NonBlockingTCPTests.testSetBlocking"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testSetBlocking">[docs]</a>    <span class="k">def</span> <span class="nf">testSetBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing whether set blocking works</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s">&quot;Error setting non-blocking mode.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSetBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@support.cpython_only</span>
<div class="viewcode-block" id="NonBlockingTCPTests.testSetBlocking_overflow"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testSetBlocking_overflow">[docs]</a>    <span class="k">def</span> <span class="nf">testSetBlocking_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue 15989</span>
        <span class="kn">import</span> <span class="nn">_testcapi</span>
        <span class="k">if</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">UINT_MAX</span> <span class="o">&gt;=</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">ULONG_MAX</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&#39;needs UINT_MAX &lt; ULONG_MAX&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="n">_testcapi</span><span class="o">.</span><span class="n">UINT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">())</span>
</div>
    <span class="n">_testSetBlocking_overflow</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">cpython_only</span><span class="p">(</span><span class="n">_testSetBlocking</span><span class="p">)</span>

    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SOCK_NONBLOCK&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs socket.SOCK_NONBLOCK&#39;</span><span class="p">)</span>
    <span class="nd">@support.requires_linux_version</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<div class="viewcode-block" id="NonBlockingTCPTests.testInitNonBlocking"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testInitNonBlocking">[docs]</a>    <span class="k">def</span> <span class="nf">testInitNonBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># reinit server socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="o">|</span>
                                                  <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">bind_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># actual testing</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s">&quot;Error creating with non-blocking mode.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testInitNonBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="NonBlockingTCPTests.testInheritFlags"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testInheritFlags">[docs]</a>    <span class="k">def</span> <span class="nf">testInheritFlags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #7995: when calling accept() on a listening socket with a</span>
        <span class="c"># timeout, the resulting socket should not be non-blocking.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testInheritFlags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="NonBlockingTCPTests.testAccept"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testAccept">[docs]</a>    <span class="k">def</span> <span class="nf">testAccept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing non-blocking accept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error trying to do non-blocking accept.&quot;</span><span class="p">)</span>
        <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span> <span class="ow">in</span> <span class="n">read</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error trying to do accept after select.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testAccept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="NonBlockingTCPTests.testConnect"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testConnect">[docs]</a>    <span class="k">def</span> <span class="nf">testConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing non-blocking connect</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_testConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<div class="viewcode-block" id="NonBlockingTCPTests.testRecv"><a class="viewcode-back" href="../../test.html#test.test_socket.NonBlockingTCPTests.testRecv">[docs]</a>    <span class="k">def</span> <span class="nf">testRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Testing non-blocking recv</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error trying to do non-blocking recv.&quot;</span><span class="p">)</span>
        <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">conn</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">read</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Error during select call to non-blocking socket.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="FileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">FileObjectClassTestCase</span><span class="p">(</span><span class="n">SocketConnectedTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unit tests for the object returned by socket.makefile()</span>

<span class="sd">    self.read_file is the io object returned by makefile() on</span>
<span class="sd">    the client connection.  You can read from this file to</span>
<span class="sd">    get output from the server.</span>

<span class="sd">    self.write_file is the io object returned by makefile() on the</span>
<span class="sd">    server connection.  You can write to this file to send output</span>
<span class="sd">    to the client.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bufsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># Use default buffer size</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;strict&#39;</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">read_mode</span> <span class="o">=</span> <span class="s">&#39;rb&#39;</span>
    <span class="n">read_msg</span> <span class="o">=</span> <span class="n">MSG</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s">&#39;wb&#39;</span>
    <span class="n">write_msg</span> <span class="o">=</span> <span class="n">MSG</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="FileObjectClassTestCase.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evt2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_finished</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_finished</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">,</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileObjectClassTestCase.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_finished</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileObjectClassTestCase.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">,</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileObjectClassTestCase.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_finished</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileObjectClassTestCase.testReadAfterTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testReadAfterTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testReadAfterTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #7322: A file object must disallow further reads</span>
        <span class="c"># after a timeout has occurred.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c"># First read raises a timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># Second read is disallowed</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&quot;cannot read from timed out object&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_testReadAfterTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_finished</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testSmallRead"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testSmallRead">[docs]</a>    <span class="k">def</span> <span class="nf">testSmallRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Performing small file read test</span>
        <span class="n">first_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">second_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">first_seg</span> <span class="o">+</span> <span class="n">second_seg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSmallRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testFullRead"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testFullRead">[docs]</a>    <span class="k">def</span> <span class="nf">testFullRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># read until EOF</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testFullRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testUnbufferedRead"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testUnbufferedRead">[docs]</a>    <span class="k">def</span> <span class="nf">testUnbufferedRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Performing unbuffered file read test</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)()</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">char</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="n">char</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testUnbufferedRead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testReadline"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testReadline">[docs]</a>    <span class="k">def</span> <span class="nf">testReadline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Performing file readline test</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testReadline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testCloseAfterMakefile"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testCloseAfterMakefile">[docs]</a>    <span class="k">def</span> <span class="nf">testCloseAfterMakefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The file returned by makefile should keep the socket open.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># read until EOF</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCloseAfterMakefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testMakefileAfterMakefileClose"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testMakefileAfterMakefileClose">[docs]</a>    <span class="k">def</span> <span class="nf">testMakefileAfterMakefileClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testMakefileAfterMakefileClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testClosedAttr"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testClosedAttr">[docs]</a>    <span class="k">def</span> <span class="nf">testClosedAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testClosedAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testAttributes"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">testAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">_testAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>

<div class="viewcode-block" id="FileObjectClassTestCase.testRealClose"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectClassTestCase.testRealClose">[docs]</a>    <span class="k">def</span> <span class="nf">testRealClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">getsockname</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRealClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

</div>
<div class="viewcode-block" id="FileObjectInterruptedTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectInterruptedTestCase">[docs]</a><span class="k">class</span> <span class="nc">FileObjectInterruptedTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that the file object correctly handles EINTR internally.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FileObjectInterruptedTestCase.MockSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectInterruptedTestCase.MockSocket">[docs]</a>    <span class="k">class</span> <span class="nc">MockSocket</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recv_funcs</span><span class="o">=</span><span class="p">()):</span>
            <span class="c"># A generator that returns callables that we&#39;ll call for each</span>
            <span class="c"># call to recv().</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recv_step</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">recv_funcs</span><span class="p">)</span>

<div class="viewcode-block" id="FileObjectInterruptedTestCase.MockSocket.recv_into"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectInterruptedTestCase.MockSocket.recv_into">[docs]</a>        <span class="k">def</span> <span class="nf">recv_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">buffer</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv_step</span><span class="p">)()</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="nb">buffer</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
        <span class="k">def</span> <span class="nf">_decref_socketios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">_textiowrap_for_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">SocketIO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">buffering</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buffering</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">DEFAULT_BUFFER_SIZE</span>
            <span class="k">if</span> <span class="n">buffering</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">raw</span>
            <span class="nb">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">buffering</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;rb&quot;</span>
            <span class="k">return</span> <span class="n">text</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_raise_eintr</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">,</span> <span class="s">&quot;interrupted&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_textiowrap_mock_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">SocketIO</span><span class="p">(</span><span class="n">mock</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buffering</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffering</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">DEFAULT_BUFFER_SIZE</span>
        <span class="k">if</span> <span class="n">buffering</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">raw</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">buffering</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;rb&quot;</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">_test_readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">mock_sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockSocket</span><span class="p">(</span><span class="n">recv_funcs</span><span class="o">=</span><span class="p">[</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;This is the first line</span><span class="se">\n</span><span class="s">And the sec&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_eintr</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;ond line is here</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="c"># XXX(gps): io library does an extra EOF read</span>
            <span class="p">])</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">mock_sock</span><span class="o">.</span><span class="n">_textiowrap_for_test</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="n">buffering</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="s">&quot;This is the first line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="s">&quot;And the second line is here</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">mock_sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockSocket</span><span class="p">(</span><span class="n">recv_funcs</span><span class="o">=</span><span class="p">[</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;This is the first line</span><span class="se">\n</span><span class="s">And the sec&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_eintr</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;ond line is here</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="c"># XXX(gps): io library does an extra EOF read</span>
            <span class="p">])</span>
        <span class="n">expecting</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="s">&quot;This is the first line</span><span class="se">\n</span><span class="s">&quot;</span>
                     <span class="n">b</span><span class="s">&quot;And the second line is here</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">mock_sock</span><span class="o">.</span><span class="n">_textiowrap_for_test</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="n">buffering</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buffering</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">expecting</span> <span class="o">=</span> <span class="n">expecting</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expecting</span><span class="p">):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">expecting</span><span class="p">)</span>

<div class="viewcode-block" id="FileObjectInterruptedTestCase.test_default"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectInterruptedTestCase.test_default">[docs]</a>    <span class="k">def</span> <span class="nf">test_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_readline</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_read</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileObjectInterruptedTestCase.test_with_1k_buffer"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectInterruptedTestCase.test_with_1k_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">test_with_1k_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_readline</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_readline</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_read</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_read</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_test_readline_no_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">mock_sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockSocket</span><span class="p">(</span><span class="n">recv_funcs</span><span class="o">=</span><span class="p">[</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;a&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;B&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_eintr</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;b&quot;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="p">:</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span>
            <span class="p">])</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">mock_sock</span><span class="o">.</span><span class="n">_textiowrap_for_test</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">b</span><span class="s">&quot;Bb&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FileObjectInterruptedTestCase.test_no_buffer"><a class="viewcode-back" href="../../test.html#test.test_socket.FileObjectInterruptedTestCase.test_no_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_readline_no_buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_readline_no_buffer</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_read</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_read</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="UnbufferedFileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.UnbufferedFileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">UnbufferedFileObjectClassTestCase</span><span class="p">(</span><span class="n">FileObjectClassTestCase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Repeat the tests from FileObjectClassTestCase with bufsize==0.</span>

<span class="sd">    In this case (and in this case only), it should be possible to</span>
<span class="sd">    create a file object, read a line from it, create another file</span>
<span class="sd">    object, read another line from it, without loss of data in the</span>
<span class="sd">    first file object&#39;s buffer.  Note that http.client relies on this</span>
<span class="sd">    when reading multiple requests from the same socket.&quot;&quot;&quot;</span>

    <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Use unbuffered mode</span>

<div class="viewcode-block" id="UnbufferedFileObjectClassTestCase.testUnbufferedReadline"><a class="viewcode-back" href="../../test.html#test.test_socket.UnbufferedFileObjectClassTestCase.testUnbufferedReadline">[docs]</a>    <span class="k">def</span> <span class="nf">testUnbufferedReadline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Read a line, create a new file object, read another line with it</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c"># first line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;A. &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span> <span class="c"># first line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c"># second line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;B. &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span> <span class="c"># second line</span>
</div>
    <span class="k">def</span> <span class="nf">_testUnbufferedReadline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;A. &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;B. &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="UnbufferedFileObjectClassTestCase.testMakefileClose"><a class="viewcode-back" href="../../test.html#test.test_socket.UnbufferedFileObjectClassTestCase.testMakefileClose">[docs]</a>    <span class="k">def</span> <span class="nf">testMakefileClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The file returned by makefile should keep the socket open...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
        <span class="c"># ...until the file is itself closed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testMakefileClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="UnbufferedFileObjectClassTestCase.testMakefileCloseSocketDestroy"><a class="viewcode-back" href="../../test.html#test.test_socket.UnbufferedFileObjectClassTestCase.testMakefileCloseSocketDestroy">[docs]</a>    <span class="k">def</span> <span class="nf">testMakefileCloseSocketDestroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">refcount_before</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">refcount_after</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">refcount_before</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refcount_after</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testMakefileCloseSocketDestroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c"># Non-blocking ops</span>
    <span class="c"># NOTE: to set `read_file` as non-blocking, we must call</span>
    <span class="c"># `cli_conn.setblocking` and vice-versa (see setUp / clientSetUp).</span>

<div class="viewcode-block" id="UnbufferedFileObjectClassTestCase.testSmallReadNonBlocking"><a class="viewcode-back" href="../../test.html#test.test_socket.UnbufferedFileObjectClassTestCase.testSmallReadNonBlocking">[docs]</a>    <span class="k">def</span> <span class="nf">testSmallReadNonBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt1</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt2</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">first_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_seg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Data not arrived (can happen under Windows), wait a bit</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">first_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">first_seg</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="mi">16</span><span class="p">)),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testSmallReadNonBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt1</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evt2</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="c"># Avoid cloding the socket before the server test has finished,</span>
        <span class="c"># otherwise system recv() will return 0 instead of EWOULDBLOCK.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_finished</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>

<div class="viewcode-block" id="UnbufferedFileObjectClassTestCase.testWriteNonBlocking"><a class="viewcode-back" href="../../test.html#test.test_socket.UnbufferedFileObjectClassTestCase.testWriteNonBlocking">[docs]</a>    <span class="k">def</span> <span class="nf">testWriteNonBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_finished</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="c"># The client thread can&#39;t skip directly - the SkipTest exception</span>
        <span class="c"># would appear as a failure.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv_skipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv_skipped</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testWriteNonBlocking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_skipped</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># Try to saturate the socket buffer pipe with repeated large writes.</span>
        <span class="n">BIG</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;x&quot;</span> <span class="o">*</span> <span class="n">support</span><span class="o">.</span><span class="n">SOCK_MAX_SIZE</span>
        <span class="n">LIMIT</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c"># The first write() succeeds since a chunk of data can be buffered</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BIG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LIMIT</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BIG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Succeeded</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Let us know that this test didn&#39;t manage to establish</span>
            <span class="c"># the expected conditions. This is not a failure in itself but,</span>
            <span class="c"># if it happens repeatedly, the test should be fixed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv_skipped</span> <span class="o">=</span> <span class="s">&quot;failed to saturate the socket buffer&quot;</span>

</div>
<div class="viewcode-block" id="LineBufferedFileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.LineBufferedFileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">LineBufferedFileObjectClassTestCase</span><span class="p">(</span><span class="n">FileObjectClassTestCase</span><span class="p">):</span>

    <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Default-buffered for reading; line-buffered for writing</span>

</div>
<div class="viewcode-block" id="SmallBufferedFileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.SmallBufferedFileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">SmallBufferedFileObjectClassTestCase</span><span class="p">(</span><span class="n">FileObjectClassTestCase</span><span class="p">):</span>

    <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">2</span> <span class="c"># Exercise the buffering code</span>

</div>
<div class="viewcode-block" id="UnicodeReadFileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.UnicodeReadFileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">UnicodeReadFileObjectClassTestCase</span><span class="p">(</span><span class="n">FileObjectClassTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for socket.makefile() in text mode (rather than binary)&quot;&quot;&quot;</span>

    <span class="n">read_mode</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span>
    <span class="n">read_msg</span> <span class="o">=</span> <span class="n">MSG</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s">&#39;wb&#39;</span>
    <span class="n">write_msg</span> <span class="o">=</span> <span class="n">MSG</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

</div>
<div class="viewcode-block" id="UnicodeWriteFileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.UnicodeWriteFileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">UnicodeWriteFileObjectClassTestCase</span><span class="p">(</span><span class="n">FileObjectClassTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for socket.makefile() in text mode (rather than binary)&quot;&quot;&quot;</span>

    <span class="n">read_mode</span> <span class="o">=</span> <span class="s">&#39;rb&#39;</span>
    <span class="n">read_msg</span> <span class="o">=</span> <span class="n">MSG</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s">&#39;w&#39;</span>
    <span class="n">write_msg</span> <span class="o">=</span> <span class="n">MSG</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

</div>
<div class="viewcode-block" id="UnicodeReadWriteFileObjectClassTestCase"><a class="viewcode-back" href="../../test.html#test.test_socket.UnicodeReadWriteFileObjectClassTestCase">[docs]</a><span class="k">class</span> <span class="nc">UnicodeReadWriteFileObjectClassTestCase</span><span class="p">(</span><span class="n">FileObjectClassTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests for socket.makefile() in text mode (rather than binary)&quot;&quot;&quot;</span>

    <span class="n">read_mode</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span>
    <span class="n">read_msg</span> <span class="o">=</span> <span class="n">MSG</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s">&#39;w&#39;</span>
    <span class="n">write_msg</span> <span class="o">=</span> <span class="n">MSG</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

</div>
<div class="viewcode-block" id="NetworkConnectionTest"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionTest">[docs]</a><span class="k">class</span> <span class="nc">NetworkConnectionTest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prove network connection.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetworkConnectionTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># We&#39;re inherited below by BasicTCPTest2, which also inherits</span>
        <span class="c"># BasicTCPTest, which defines self.port referenced below.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span>
</div></div>
<div class="viewcode-block" id="BasicTCPTest2"><a class="viewcode-back" href="../../test.html#test.test_socket.BasicTCPTest2">[docs]</a><span class="k">class</span> <span class="nc">BasicTCPTest2</span><span class="p">(</span><span class="n">NetworkConnectionTest</span><span class="p">,</span> <span class="n">BasicTCPTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests that NetworkConnection does not break existing TCP functionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="NetworkConnectionNoServer"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer">[docs]</a><span class="k">class</span> <span class="nc">NetworkConnectionNoServer</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="NetworkConnectionNoServer.MockSocket"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer.MockSocket">[docs]</a>    <span class="k">class</span> <span class="nc">MockSocket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">):</span>
<div class="viewcode-block" id="NetworkConnectionNoServer.MockSocket.connect"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer.MockSocket.connect">[docs]</a>        <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="s">&#39;timed out&#39;</span><span class="p">)</span>
</div></div>
    <span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="NetworkConnectionNoServer.mocked_socket_module"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer.mocked_socket_module">[docs]</a>    <span class="k">def</span> <span class="nf">mocked_socket_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a socket which times out on connect&quot;&quot;&quot;</span>
        <span class="n">old_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MockSocket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">old_socket</span>
</div>
<div class="viewcode-block" id="NetworkConnectionNoServer.test_connect"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer.test_connect">[docs]</a>    <span class="k">def</span> <span class="nf">test_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">find_unused_port</span><span class="p">()</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkConnectionNoServer.test_create_connection"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer.test_create_connection">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #9792: errors raised by create_connection() should have</span>
        <span class="c"># a proper errno attribute.</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">find_unused_port</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

        <span class="c"># Issue #16257: create_connection() calls getaddrinfo() against</span>
        <span class="c"># &#39;localhost&#39;.  This may result in an IPV6 addr being returned</span>
        <span class="c"># as well as an IPV4 one:</span>
        <span class="c">#   &gt;&gt;&gt; socket.getaddrinfo(&#39;localhost&#39;, port, 0, SOCK_STREAM)</span>
        <span class="c">#   &gt;&gt;&gt; [(2,  2, 0, &#39;&#39;, (&#39;127.0.0.1&#39;, 41230)),</span>
        <span class="c">#        (26, 2, 0, &#39;&#39;, (&#39;::1&#39;, 41230, 0, 0))]</span>
        <span class="c">#</span>
        <span class="c"># create_connection() enumerates through all the addresses returned</span>
        <span class="c"># and if it doesn&#39;t successfully bind to any of them, it propagates</span>
        <span class="c"># the last exception it encountered.</span>
        <span class="c">#</span>
        <span class="c"># On Solaris, ENETUNREACH is returned in this circumstance instead</span>
        <span class="c"># of ECONNREFUSED.  So, if that errno exists, add it to our list of</span>
        <span class="c"># expected errnos.</span>
        <span class="n">expected_errnos</span> <span class="o">=</span> <span class="p">[</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">,</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s">&#39;ENETUNREACH&#39;</span><span class="p">):</span>
            <span class="n">expected_errnos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENETUNREACH</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">expected_errnos</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkConnectionNoServer.test_create_connection_timeout"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionNoServer.test_create_connection_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_connection_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Issue #9792: create_connection() should not recast timeout errors</span>
        <span class="c"># as generic socket errors.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mocked_socket_module</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="mi">1234</span><span class="p">))</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NetworkConnectionAttributesTest"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionAttributesTest">[docs]</a><span class="k">class</span> <span class="nc">NetworkConnectionAttributesTest</span><span class="p">(</span><span class="n">SocketTCPTest</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketTCPTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="NetworkConnectionAttributesTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionAttributesTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_port</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">find_unused_port</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="NetworkConnectionAttributesTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionAttributesTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_justAccept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">testFamily</span> <span class="o">=</span> <span class="n">_justAccept</span>
    <span class="k">def</span> <span class="nf">_testFamily</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">testSourceAddress</span> <span class="o">=</span> <span class="n">_justAccept</span>
    <span class="k">def</span> <span class="nf">_testSourceAddress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                <span class="n">source_address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_port</span><span class="p">)</span>
        <span class="c"># The port number being used is sufficient to show that the bind()</span>
        <span class="c"># call happened.</span>

    <span class="n">testTimeoutDefault</span> <span class="o">=</span> <span class="n">_justAccept</span>
    <span class="k">def</span> <span class="nf">_testTimeoutDefault</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># passing no explicit timeout uses socket&#39;s global default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="mi">42</span><span class="p">)</span>

    <span class="n">testTimeoutNone</span> <span class="o">=</span> <span class="n">_justAccept</span>
    <span class="k">def</span> <span class="nf">_testTimeoutNone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># None timeout means the same as sock.settimeout(None)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">testTimeoutValueNamed</span> <span class="o">=</span> <span class="n">_justAccept</span>
    <span class="k">def</span> <span class="nf">_testTimeoutValueNamed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>

    <span class="n">testTimeoutValueNonamed</span> <span class="o">=</span> <span class="n">_justAccept</span>
    <span class="k">def</span> <span class="nf">_testTimeoutValueNonamed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>
</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NetworkConnectionBehaviourTest"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionBehaviourTest">[docs]</a><span class="k">class</span> <span class="nc">NetworkConnectionBehaviourTest</span><span class="p">(</span><span class="n">SocketTCPTest</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketTCPTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="NetworkConnectionBehaviourTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionBehaviourTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NetworkConnectionBehaviourTest.clientTearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionBehaviourTest.clientTearDown">[docs]</a>    <span class="k">def</span> <span class="nf">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">clientTearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NetworkConnectionBehaviourTest.testInsideTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.NetworkConnectionBehaviourTest.testInsideTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInsideTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;done!&quot;</span><span class="p">)</span></div>
    <span class="n">testOutsideTimeout</span> <span class="o">=</span> <span class="n">testInsideTimeout</span>

    <span class="k">def</span> <span class="nf">_testInsideTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;done!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_testOutsideTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="TCPTimeoutTest"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPTimeoutTest">[docs]</a><span class="k">class</span> <span class="nc">TCPTimeoutTest</span><span class="p">(</span><span class="n">SocketTCPTest</span><span class="p">):</span>

<div class="viewcode-block" id="TCPTimeoutTest.testTCPTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPTimeoutTest.testTCPTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testTCPTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">raise_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">raise_timeout</span><span class="p">,</span>
                              <span class="s">&quot;Error generating a timeout exception (TCP)&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TCPTimeoutTest.testTimeoutZero"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPTimeoutTest.testTimeoutZero">[docs]</a>    <span class="k">def</span> <span class="nf">testTimeoutZero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;caught timeout instead of error (TCP)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;caught unexpected exception (TCP)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;accept() returned success when we did not expect it&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;alarm&#39;</span><span class="p">),</span>
                         <span class="s">&#39;test needs signal.alarm()&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TCPTimeoutTest.testInterruptedTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.TCPTimeoutTest.testInterruptedTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testInterruptedTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># XXX I don&#39;t know how to do this test on MSWindows or any other</span>
        <span class="c"># plaform that doesn&#39;t support signal.alarm() or os.kill(), though</span>
        <span class="c"># the bug should have existed on all platforms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>   <span class="c"># must be longer than alarm</span>
        <span class="k">class</span> <span class="nc">Alarm</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">alarm_handler</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Alarm</span>
        <span class="n">old_alarm</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">alarm_handler</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c"># POSIX allows alarm to be up to 1 second early</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;caught timeout instead of Alarm&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Alarm</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;caught other exception instead of Alarm:&quot;</span>
                          <span class="s">&quot; </span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;nothing caught&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>         <span class="c"># shut off alarm</span>
        <span class="k">except</span> <span class="n">Alarm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;got Alarm in wrong place&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c"># no alarm can be pending.  Safe to restore old handler.</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">old_alarm</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="UDPTimeoutTest"><a class="viewcode-back" href="../../test.html#test.test_socket.UDPTimeoutTest">[docs]</a><span class="k">class</span> <span class="nc">UDPTimeoutTest</span><span class="p">(</span><span class="n">SocketUDPTest</span><span class="p">):</span>

<div class="viewcode-block" id="UDPTimeoutTest.testUDPTimeout"><a class="viewcode-back" href="../../test.html#test.test_socket.UDPTimeoutTest.testUDPTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">testUDPTimeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">raise_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">raise_timeout</span><span class="p">,</span>
                              <span class="s">&quot;Error generating a timeout exception (UDP)&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="UDPTimeoutTest.testTimeoutZero"><a class="viewcode-back" href="../../test.html#test.test_socket.UDPTimeoutTest.testTimeoutZero">[docs]</a>    <span class="k">def</span> <span class="nf">testTimeoutZero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;caught timeout instead of error (UDP)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;caught unexpected exception (UDP)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;recv() returned success when we did not expect it&quot;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TestExceptions"><a class="viewcode-back" href="../../test.html#test.test_socket.TestExceptions">[docs]</a><span class="k">class</span> <span class="nc">TestExceptions</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestExceptions.testExceptionTree"><a class="viewcode-back" href="../../test.html#test.test_socket.TestExceptions.testExceptionTree">[docs]</a>    <span class="k">def</span> <span class="nf">testExceptionTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">))</span>
</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;linux&#39;</span><span class="p">,</span> <span class="s">&#39;Linux specific test&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestLinuxAbstractNamespace"><a class="viewcode-back" href="../../test.html#test.test_socket.TestLinuxAbstractNamespace">[docs]</a><span class="k">class</span> <span class="nc">TestLinuxAbstractNamespace</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="n">UNIX_PATH_MAX</span> <span class="o">=</span> <span class="mi">108</span>

<div class="viewcode-block" id="TestLinuxAbstractNamespace.testLinuxAbstractNamespace"><a class="viewcode-back" href="../../test.html#test.test_socket.TestLinuxAbstractNamespace.testLinuxAbstractNamespace">[docs]</a>    <span class="k">def</span> <span class="nf">testLinuxAbstractNamespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">python-test-hello</span><span class="se">\x00\xff</span><span class="s">&quot;</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s1</span><span class="p">:</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s2</span><span class="p">:</span>
                <span class="n">s2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span>
                <span class="k">with</span> <span class="n">s1</span><span class="o">.</span><span class="n">accept</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="n">s3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">address</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s2</span><span class="o">.</span><span class="n">getpeername</span><span class="p">(),</span> <span class="n">address</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestLinuxAbstractNamespace.testMaxName"><a class="viewcode-back" href="../../test.html#test.test_socket.TestLinuxAbstractNamespace.testMaxName">[docs]</a>    <span class="k">def</span> <span class="nf">testMaxName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;h&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UNIX_PATH_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">address</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestLinuxAbstractNamespace.testNameOverflow"><a class="viewcode-back" href="../../test.html#test.test_socket.TestLinuxAbstractNamespace.testNameOverflow">[docs]</a>    <span class="k">def</span> <span class="nf">testNameOverflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;h&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNIX_PATH_MAX</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestLinuxAbstractNamespace.testStrName"><a class="viewcode-back" href="../../test.html#test.test_socket.TestLinuxAbstractNamespace.testStrName">[docs]</a>    <span class="k">def</span> <span class="nf">testStrName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Check that an abstract name can be passed as a string.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">python</span><span class="se">\x00</span><span class="s">test</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x00</span><span class="s">python</span><span class="se">\x00</span><span class="s">test</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;AF_UNIX&#39;</span><span class="p">),</span> <span class="s">&#39;test needs socket.AF_UNIX&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TestUnixDomain"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain">[docs]</a><span class="k">class</span> <span class="nc">TestUnixDomain</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestUnixDomain.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.tearDown"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.encoded"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.encoded">[docs]</a>    <span class="k">def</span> <span class="nf">encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c"># Return the given path encoded in the file system encoding,</span>
        <span class="c"># or skip the test if this is not possible.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span>
                <span class="s">&quot;Pathname {0!a} cannot be represented in file &quot;</span>
                <span class="s">&quot;system encoding {1!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.bind"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.bind">[docs]</a>    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c"># Bind the socket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;AF_UNIX path too long&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span>
                    <span class="s">&quot;Pathname {0!a} is too long to serve as a AF_UNIX path&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.testStrAddr"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.testStrAddr">[docs]</a>    <span class="k">def</span> <span class="nf">testStrAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test binding to and retrieving a normal string pathname.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.testBytesAddr"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.testBytesAddr">[docs]</a>    <span class="k">def</span> <span class="nf">testBytesAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test binding to a bytes pathname.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.testSurrogateescapeBind"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.testSurrogateescapeBind">[docs]</a>    <span class="k">def</span> <span class="nf">testSurrogateescapeBind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test binding to a valid non-ASCII pathname, with the</span>
        <span class="c"># non-ASCII bytes supplied using surrogateescape encoding.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNICODE</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="s">&quot;surrogateescape&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestUnixDomain.testUnencodableAddr"><a class="viewcode-back" href="../../test.html#test.test_socket.TestUnixDomain.testUnencodableAddr">[docs]</a>    <span class="k">def</span> <span class="nf">testUnencodableAddr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Test binding to a pathname that cannot be encoded in the</span>
        <span class="c"># file system encoding.</span>
        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">&quot;No unencodable filename available&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">TESTFN_UNENCODABLE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="BufferIOTest"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest">[docs]</a><span class="k">class</span> <span class="nc">BufferIOTest</span><span class="p">(</span><span class="n">SocketConnectedTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the buffer versions of socket.recv() and socket.send().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">SocketConnectedTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="n">methodName</span><span class="p">)</span>

<div class="viewcode-block" id="BufferIOTest.testRecvIntoArray"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvIntoArray">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvIntoArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvIntoArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<div class="viewcode-block" id="BufferIOTest.testRecvIntoBytearray"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvIntoBytearray">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvIntoBytearray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="n">_testRecvIntoBytearray</span> <span class="o">=</span> <span class="n">_testRecvIntoArray</span>

<div class="viewcode-block" id="BufferIOTest.testRecvIntoMemoryview"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvIntoMemoryview">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvIntoMemoryview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">nbytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">memoryview</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="n">_testRecvIntoMemoryview</span> <span class="o">=</span> <span class="n">_testRecvIntoArray</span>

<div class="viewcode-block" id="BufferIOTest.testRecvFromIntoArray"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvFromIntoArray">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFromIntoArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">nbytes</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvFromIntoArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<div class="viewcode-block" id="BufferIOTest.testRecvFromIntoBytearray"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvFromIntoBytearray">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFromIntoBytearray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">nbytes</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="n">_testRecvFromIntoBytearray</span> <span class="o">=</span> <span class="n">_testRecvFromIntoArray</span>

<div class="viewcode-block" id="BufferIOTest.testRecvFromIntoMemoryview"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvFromIntoMemoryview">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFromIntoMemoryview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">nbytes</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">(</span><span class="n">memoryview</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">MSG</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
</div>
    <span class="n">_testRecvFromIntoMemoryview</span> <span class="o">=</span> <span class="n">_testRecvFromIntoArray</span>

<div class="viewcode-block" id="BufferIOTest.testRecvFromIntoSmallBuffer"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvFromIntoSmallBuffer">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFromIntoSmallBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># See issue #20246.</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testRecvFromIntoSmallBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>

<div class="viewcode-block" id="BufferIOTest.testRecvFromIntoEmptyBuffer"><a class="viewcode-back" href="../../test.html#test.test_socket.BufferIOTest.testRecvFromIntoEmptyBuffer">[docs]</a>    <span class="k">def</span> <span class="nf">testRecvFromIntoEmptyBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli_conn</span><span class="o">.</span><span class="n">recvfrom_into</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="n">_testRecvFromIntoEmptyBuffer</span> <span class="o">=</span> <span class="n">_testRecvFromIntoArray</span>

</div>
<span class="n">TIPC_STYPE</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">TIPC_LOWER</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">TIPC_UPPER</span> <span class="o">=</span> <span class="mi">210</span>

<div class="viewcode-block" id="isTipcAvailable"><a class="viewcode-back" href="../../test.html#test.test_socket.isTipcAvailable">[docs]</a><span class="k">def</span> <span class="nf">isTipcAvailable</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check if the TIPC module is loaded</span>

<span class="sd">    The TIPC module is not loaded automatically on Ubuntu and probably</span>
<span class="sd">    other Linux distros.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;AF_TIPC&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&quot;/proc/modules&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/proc/modules&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;tipc &quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">isTipcAvailable</span><span class="p">(),</span>
                     <span class="s">&quot;TIPC module is not loaded, please &#39;sudo modprobe tipc&#39;&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="TIPCTest"><a class="viewcode-back" href="../../test.html#test.test_socket.TIPCTest">[docs]</a><span class="k">class</span> <span class="nc">TIPCTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TIPCTest.testRDM"><a class="viewcode-back" href="../../test.html#test.test_socket.TIPCTest.testRDM">[docs]</a>    <span class="k">def</span> <span class="nf">testRDM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">srv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_TIPC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RDM</span><span class="p">)</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_TIPC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RDM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">srv</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

        <span class="n">srv</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">srvaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">TIPC_ADDR_NAMESEQ</span><span class="p">,</span> <span class="n">TIPC_STYPE</span><span class="p">,</span>
                <span class="n">TIPC_LOWER</span><span class="p">,</span> <span class="n">TIPC_UPPER</span><span class="p">)</span>
        <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">srvaddr</span><span class="p">)</span>

        <span class="n">sendaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">TIPC_ADDR_NAME</span><span class="p">,</span> <span class="n">TIPC_STYPE</span><span class="p">,</span>
                <span class="n">TIPC_LOWER</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">TIPC_UPPER</span> <span class="o">-</span> <span class="n">TIPC_LOWER</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cli</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">MSG</span><span class="p">,</span> <span class="n">sendaddr</span><span class="p">)</span>

        <span class="n">msg</span><span class="p">,</span> <span class="n">recvaddr</span> <span class="o">=</span> <span class="n">srv</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">getsockname</span><span class="p">(),</span> <span class="n">recvaddr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">isTipcAvailable</span><span class="p">(),</span>
                     <span class="s">&quot;TIPC module is not loaded, please &#39;sudo modprobe tipc&#39;&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="TIPCThreadableTest"><a class="viewcode-back" href="../../test.html#test.test_socket.TIPCThreadableTest">[docs]</a><span class="k">class</span> <span class="nc">TIPCThreadableTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">ThreadableTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span> <span class="o">=</span> <span class="s">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">methodName</span><span class="p">)</span>
        <span class="n">ThreadableTest</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="TIPCThreadableTest.setUp"><a class="viewcode-back" href="../../test.html#test.test_socket.TIPCThreadableTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srv</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_TIPC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">srvaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">TIPC_ADDR_NAMESEQ</span><span class="p">,</span> <span class="n">TIPC_STYPE</span><span class="p">,</span>
                <span class="n">TIPC_LOWER</span><span class="p">,</span> <span class="n">TIPC_UPPER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">srvaddr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverExplicitReady</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TIPCThreadableTest.clientSetUp"><a class="viewcode-back" href="../../test.html#test.test_socket.TIPCThreadableTest.clientSetUp">[docs]</a>    <span class="k">def</span> <span class="nf">clientSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The is a hittable race between serverExplicitReady() and the</span>
        <span class="c"># accept() call; sleep a little while to avoid it, otherwise</span>
        <span class="c"># we could get an exception</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_TIPC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">TIPC_ADDR_NAME</span><span class="p">,</span> <span class="n">TIPC_STYPE</span><span class="p">,</span>
                <span class="n">TIPC_LOWER</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">TIPC_UPPER</span> <span class="o">-</span> <span class="n">TIPC_LOWER</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cliaddr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TIPCThreadableTest.testStream"><a class="viewcode-back" href="../../test.html#test.test_socket.TIPCThreadableTest.testStream">[docs]</a>    <span class="k">def</span> <span class="nf">testStream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cliaddr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connaddr</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testStream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s">&#39;Threading required for this test.&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ContextManagersTest"><a class="viewcode-back" href="../../test.html#test.test_socket.ContextManagersTest">[docs]</a><span class="k">class</span> <span class="nc">ContextManagersTest</span><span class="p">(</span><span class="n">ThreadedTCPSocketTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_testSocketClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># base test</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>
        <span class="c"># close inside with block</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>
        <span class="c"># exception inside with block</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>

<div class="viewcode-block" id="ContextManagersTest.testCreateConnectionBase"><a class="viewcode-back" href="../../test.html#test.test_socket.ContextManagersTest.testCreateConnectionBase">[docs]</a>    <span class="k">def</span> <span class="nf">testCreateConnectionBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCreateConnectionBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span> <span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>

<div class="viewcode-block" id="ContextManagersTest.testCreateConnectionClose"><a class="viewcode-back" href="../../test.html#test.test_socket.ContextManagersTest.testCreateConnectionClose">[docs]</a>    <span class="k">def</span> <span class="nf">testCreateConnectionClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_testCreateConnectionClose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="InheritanceTest"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest">[docs]</a><span class="k">class</span> <span class="nc">InheritanceTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;SOCK_CLOEXEC&quot;</span><span class="p">),</span>
                         <span class="s">&quot;SOCK_CLOEXEC not defined&quot;</span><span class="p">)</span>
    <span class="nd">@support.requires_linux_version</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<div class="viewcode-block" id="InheritanceTest.test_SOCK_CLOEXEC"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_SOCK_CLOEXEC">[docs]</a>    <span class="k">def</span> <span class="nf">test_SOCK_CLOEXEC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span>
                           <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_CLOEXEC</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_CLOEXEC</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="InheritanceTest.test_default_inheritable"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_default_inheritable">[docs]</a>    <span class="k">def</span> <span class="nf">test_default_inheritable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InheritanceTest.test_dup"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_dup">[docs]</a>    <span class="k">def</span> <span class="nf">test_dup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">newsock</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">dup</span><span class="p">()</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">newsock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">newsock</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InheritanceTest.test_set_inheritable"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_set_inheritable">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_inheritable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>

            <span class="n">sock</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">fcntl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;need fcntl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InheritanceTest.test_get_inheritable_cloexec"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_get_inheritable_cloexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_inheritable_cloexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>

            <span class="c"># clear FD_CLOEXEC flag</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">fcntl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;need fcntl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InheritanceTest.test_set_inheritable_cloexec"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_set_inheritable_cloexec">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_inheritable_cloexec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">sock</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">,</span>
                             <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">)</span>

            <span class="n">sock</span><span class="o">.</span><span class="n">set_inheritable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">)</span>

</div>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;socketpair&quot;</span><span class="p">),</span>
                         <span class="s">&quot;need socket.socketpair()&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="InheritanceTest.test_socketpair"><a class="viewcode-back" href="../../test.html#test.test_socket.InheritanceTest.test_socketpair">[docs]</a>    <span class="k">def</span> <span class="nf">test_socketpair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socketpair</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">s2</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s2</span><span class="o">.</span><span class="n">get_inheritable</span><span class="p">(),</span> <span class="bp">False</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;SOCK_NONBLOCK&quot;</span><span class="p">),</span>
                     <span class="s">&quot;SOCK_NONBLOCK not defined&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="NonblockConstantTest"><a class="viewcode-back" href="../../test.html#test.test_socket.NonblockConstantTest">[docs]</a><span class="k">class</span> <span class="nc">NonblockConstantTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="NonblockConstantTest.checkNonblock"><a class="viewcode-back" href="../../test.html#test.test_socket.NonblockConstantTest.checkNonblock">[docs]</a>    <span class="k">def</span> <span class="nf">checkNonblock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nonblock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
</div>
    <span class="nd">@support.requires_linux_version</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<div class="viewcode-block" id="NonblockConstantTest.test_SOCK_NONBLOCK"><a class="viewcode-back" href="../../test.html#test.test_socket.NonblockConstantTest.test_SOCK_NONBLOCK">[docs]</a>    <span class="k">def</span> <span class="nf">test_SOCK_NONBLOCK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># a lot of it seems silly and redundant, but I wanted to test that</span>
        <span class="c"># changing back and forth worked ok</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span>
                           <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="c"># defaulttimeout</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">()</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkNonblock</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

</div></div>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;nt&quot;</span><span class="p">,</span> <span class="s">&quot;Windows specific&quot;</span><span class="p">)</span>
<span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">,</span> <span class="s">&quot;need multiprocessing&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="TestSocketSharing"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing">[docs]</a><span class="k">class</span> <span class="nc">TestSocketSharing</span><span class="p">(</span><span class="n">SocketTCPTest</span><span class="p">):</span>
    <span class="c"># This must be classmethod and not staticmethod or multiprocessing</span>
    <span class="c"># won&#39;t be able to bootstrap it.</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestSocketSharing.remoteProcessServer"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing.remoteProcessServer">[docs]</a>    <span class="k">def</span> <span class="nf">remoteProcessServer</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="c"># Recreate socket from shared data</span>
        <span class="n">sdata</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">fromshare</span><span class="p">(</span><span class="n">sdata</span><span class="p">)</span>
        <span class="n">s2</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

        <span class="c"># Send the message</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TestSocketSharing.testShare"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing.testShare">[docs]</a>    <span class="k">def</span> <span class="nf">testShare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Transfer the listening server socket to another process</span>
        <span class="c"># and service it from there.</span>

        <span class="c"># Create process:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteProcessServer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c"># Get the shared socket data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

        <span class="c"># Pass the shared socket to the other process</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c"># The data that the server will send us</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;slapmahfro&quot;</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c"># Connect</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="c">#  listen for the data</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">received</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TestSocketSharing.testShareLength"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing.testShareLength">[docs]</a>    <span class="k">def</span> <span class="nf">testShareLength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">fromshare</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">fromshare</span><span class="p">,</span> <span class="n">data</span><span class="o">+</span><span class="n">b</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestSocketSharing.compareSockets"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing.compareSockets">[docs]</a>    <span class="k">def</span> <span class="nf">compareSockets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">org</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c"># socket sharing is expected to work only for blocking socket</span>
        <span class="c"># since the internal python timout value isn&#39;t transfered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="c"># If the user specified &quot;0&quot; for proto, then</span>
        <span class="c"># internally windows will have picked the correct value.</span>
        <span class="c"># Python introspection on the socket however will still return</span>
        <span class="c"># 0.  For the shared socket, the python value is recreated</span>
        <span class="c"># from the actual value, so it may not compare correctly.</span>
        <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">proto</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">proto</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">proto</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestSocketSharing.testShareLocal"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing.testShareLocal">[docs]</a>    <span class="k">def</span> <span class="nf">testShareLocal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">fromshare</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compareSockets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serv</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TestSocketSharing.testTypes"><a class="viewcode-back" href="../../test.html#test.test_socket.TestSocketSharing.testTypes">[docs]</a>    <span class="k">def</span> <span class="nf">testTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">families</span> <span class="o">=</span> <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">]</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">families</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c"># This combination is not supported</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
                    <span class="n">shared</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">fromshare</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compareSockets</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">shared</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">shared</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">source</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="test_main"><a class="viewcode-back" href="../../test.html#test.test_socket.test_main">[docs]</a><span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">GeneralModuleTests</span><span class="p">,</span> <span class="n">BasicTCPTest</span><span class="p">,</span> <span class="n">TCPCloserTest</span><span class="p">,</span> <span class="n">TCPTimeoutTest</span><span class="p">,</span>
             <span class="n">TestExceptions</span><span class="p">,</span> <span class="n">BufferIOTest</span><span class="p">,</span> <span class="n">BasicTCPTest2</span><span class="p">,</span> <span class="n">BasicUDPTest</span><span class="p">,</span> <span class="n">UDPTimeoutTest</span> <span class="p">]</span>

    <span class="n">tests</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="n">NonBlockingTCPTests</span><span class="p">,</span>
        <span class="n">FileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">FileObjectInterruptedTestCase</span><span class="p">,</span>
        <span class="n">UnbufferedFileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">LineBufferedFileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">SmallBufferedFileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">UnicodeReadFileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">UnicodeWriteFileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">UnicodeReadWriteFileObjectClassTestCase</span><span class="p">,</span>
        <span class="n">NetworkConnectionNoServer</span><span class="p">,</span>
        <span class="n">NetworkConnectionAttributesTest</span><span class="p">,</span>
        <span class="n">NetworkConnectionBehaviourTest</span><span class="p">,</span>
        <span class="n">ContextManagersTest</span><span class="p">,</span>
        <span class="n">InheritanceTest</span><span class="p">,</span>
        <span class="n">NonblockConstantTest</span>
    <span class="p">])</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasicSocketPairTest</span><span class="p">)</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestUnixDomain</span><span class="p">)</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TestLinuxAbstractNamespace</span><span class="p">)</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">TIPCTest</span><span class="p">,</span> <span class="n">TIPCThreadableTest</span><span class="p">])</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">BasicCANTest</span><span class="p">,</span> <span class="n">CANTest</span><span class="p">])</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">BasicRDSTest</span><span class="p">,</span> <span class="n">RDSTest</span><span class="p">])</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="n">CmsgMacroTests</span><span class="p">,</span>
        <span class="n">SendmsgUDPTest</span><span class="p">,</span>
        <span class="n">RecvmsgUDPTest</span><span class="p">,</span>
        <span class="n">RecvmsgIntoUDPTest</span><span class="p">,</span>
        <span class="n">SendmsgUDP6Test</span><span class="p">,</span>
        <span class="n">RecvmsgUDP6Test</span><span class="p">,</span>
        <span class="n">RecvmsgRFC3542AncillaryUDP6Test</span><span class="p">,</span>
        <span class="n">RecvmsgIntoRFC3542AncillaryUDP6Test</span><span class="p">,</span>
        <span class="n">RecvmsgIntoUDP6Test</span><span class="p">,</span>
        <span class="n">SendmsgTCPTest</span><span class="p">,</span>
        <span class="n">RecvmsgTCPTest</span><span class="p">,</span>
        <span class="n">RecvmsgIntoTCPTest</span><span class="p">,</span>
        <span class="n">SendmsgSCTPStreamTest</span><span class="p">,</span>
        <span class="n">RecvmsgSCTPStreamTest</span><span class="p">,</span>
        <span class="n">RecvmsgIntoSCTPStreamTest</span><span class="p">,</span>
        <span class="n">SendmsgUnixStreamTest</span><span class="p">,</span>
        <span class="n">RecvmsgUnixStreamTest</span><span class="p">,</span>
        <span class="n">RecvmsgIntoUnixStreamTest</span><span class="p">,</span>
        <span class="n">RecvmsgSCMRightsStreamTest</span><span class="p">,</span>
        <span class="n">RecvmsgIntoSCMRightsStreamTest</span><span class="p">,</span>
        <span class="c"># These are slow when setitimer() is not available</span>
        <span class="n">InterruptedRecvTimeoutTest</span><span class="p">,</span>
        <span class="n">InterruptedSendTimeoutTest</span><span class="p">,</span>
        <span class="n">TestSocketSharing</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="n">thread_info</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">threading_setup</span><span class="p">()</span>
    <span class="n">support</span><span class="o">.</span><span class="n">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">tests</span><span class="p">)</span>
    <span class="n">support</span><span class="o">.</span><span class="n">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">thread_info</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>