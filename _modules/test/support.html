

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>test.support &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>test.support</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for test.support</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Supporting definitions for the Python regression tests.&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;test.support&#39;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;support must be imported from the test package&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sysconfig</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_thread</span><span class="o">,</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_thread</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">threading</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">multiprocessing.process</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">multiprocessing</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">zlib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">zlib</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gzip</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">gzip</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">bz2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">bz2</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">lzma</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">lzma</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">resource</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># globals</span>
    <span class="s">&quot;PIPE_MAX_SIZE&quot;</span><span class="p">,</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="s">&quot;max_memuse&quot;</span><span class="p">,</span> <span class="s">&quot;use_resources&quot;</span><span class="p">,</span> <span class="s">&quot;failfast&quot;</span><span class="p">,</span>
    <span class="c"># exceptions</span>
    <span class="s">&quot;Error&quot;</span><span class="p">,</span> <span class="s">&quot;TestFailed&quot;</span><span class="p">,</span> <span class="s">&quot;ResourceDenied&quot;</span><span class="p">,</span>
    <span class="c"># imports</span>
    <span class="s">&quot;import_module&quot;</span><span class="p">,</span> <span class="s">&quot;import_fresh_module&quot;</span><span class="p">,</span> <span class="s">&quot;CleanImport&quot;</span><span class="p">,</span>
    <span class="c"># modules</span>
    <span class="s">&quot;unload&quot;</span><span class="p">,</span> <span class="s">&quot;forget&quot;</span><span class="p">,</span>
    <span class="c"># io</span>
    <span class="s">&quot;record_original_stdout&quot;</span><span class="p">,</span> <span class="s">&quot;get_original_stdout&quot;</span><span class="p">,</span> <span class="s">&quot;captured_stdout&quot;</span><span class="p">,</span>
    <span class="s">&quot;captured_stdin&quot;</span><span class="p">,</span> <span class="s">&quot;captured_stderr&quot;</span><span class="p">,</span>
    <span class="c"># filesystem</span>
    <span class="s">&quot;TESTFN&quot;</span><span class="p">,</span> <span class="s">&quot;SAVEDCWD&quot;</span><span class="p">,</span> <span class="s">&quot;unlink&quot;</span><span class="p">,</span> <span class="s">&quot;rmtree&quot;</span><span class="p">,</span> <span class="s">&quot;temp_cwd&quot;</span><span class="p">,</span> <span class="s">&quot;findfile&quot;</span><span class="p">,</span>
    <span class="s">&quot;create_empty_file&quot;</span><span class="p">,</span> <span class="s">&quot;can_symlink&quot;</span><span class="p">,</span> <span class="s">&quot;fs_is_case_insensitive&quot;</span><span class="p">,</span>
    <span class="c"># unittest</span>
    <span class="s">&quot;is_resource_enabled&quot;</span><span class="p">,</span> <span class="s">&quot;requires&quot;</span><span class="p">,</span> <span class="s">&quot;requires_freebsd_version&quot;</span><span class="p">,</span>
    <span class="s">&quot;requires_linux_version&quot;</span><span class="p">,</span> <span class="s">&quot;requires_mac_ver&quot;</span><span class="p">,</span> <span class="s">&quot;check_syntax_error&quot;</span><span class="p">,</span>
    <span class="s">&quot;TransientResource&quot;</span><span class="p">,</span> <span class="s">&quot;time_out&quot;</span><span class="p">,</span> <span class="s">&quot;socket_peer_reset&quot;</span><span class="p">,</span> <span class="s">&quot;ioerror_peer_reset&quot;</span><span class="p">,</span>
    <span class="s">&quot;transient_internet&quot;</span><span class="p">,</span> <span class="s">&quot;BasicTestRunner&quot;</span><span class="p">,</span> <span class="s">&quot;run_unittest&quot;</span><span class="p">,</span> <span class="s">&quot;run_doctest&quot;</span><span class="p">,</span>
    <span class="s">&quot;skip_unless_symlink&quot;</span><span class="p">,</span> <span class="s">&quot;requires_gzip&quot;</span><span class="p">,</span> <span class="s">&quot;requires_bz2&quot;</span><span class="p">,</span> <span class="s">&quot;requires_lzma&quot;</span><span class="p">,</span>
    <span class="s">&quot;bigmemtest&quot;</span><span class="p">,</span> <span class="s">&quot;bigaddrspacetest&quot;</span><span class="p">,</span> <span class="s">&quot;cpython_only&quot;</span><span class="p">,</span> <span class="s">&quot;get_attribute&quot;</span><span class="p">,</span>
    <span class="s">&quot;requires_IEEE_754&quot;</span><span class="p">,</span> <span class="s">&quot;skip_unless_xattr&quot;</span><span class="p">,</span> <span class="s">&quot;requires_zlib&quot;</span><span class="p">,</span>
    <span class="s">&quot;anticipate_failure&quot;</span><span class="p">,</span> <span class="s">&quot;load_package_tests&quot;</span><span class="p">,</span>
    <span class="c"># sys</span>
    <span class="s">&quot;is_jython&quot;</span><span class="p">,</span> <span class="s">&quot;check_impl_detail&quot;</span><span class="p">,</span>
    <span class="c"># network</span>
    <span class="s">&quot;HOST&quot;</span><span class="p">,</span> <span class="s">&quot;IPV6_ENABLED&quot;</span><span class="p">,</span> <span class="s">&quot;find_unused_port&quot;</span><span class="p">,</span> <span class="s">&quot;bind_port&quot;</span><span class="p">,</span> <span class="s">&quot;open_urlresource&quot;</span><span class="p">,</span>
    <span class="c"># processes</span>
    <span class="s">&#39;temp_umask&#39;</span><span class="p">,</span> <span class="s">&quot;reap_children&quot;</span><span class="p">,</span>
    <span class="c"># logging</span>
    <span class="s">&quot;TestHandler&quot;</span><span class="p">,</span>
    <span class="c"># threads</span>
    <span class="s">&quot;threading_setup&quot;</span><span class="p">,</span> <span class="s">&quot;threading_cleanup&quot;</span><span class="p">,</span>
    <span class="c"># miscellaneous</span>
    <span class="s">&quot;check_warnings&quot;</span><span class="p">,</span> <span class="s">&quot;EnvironmentVarGuard&quot;</span><span class="p">,</span> <span class="s">&quot;run_with_locale&quot;</span><span class="p">,</span> <span class="s">&quot;swap_item&quot;</span><span class="p">,</span>
    <span class="s">&quot;swap_attr&quot;</span><span class="p">,</span> <span class="s">&quot;Matcher&quot;</span><span class="p">,</span> <span class="s">&quot;set_memlimit&quot;</span><span class="p">,</span> <span class="s">&quot;SuppressCrashReport&quot;</span><span class="p">,</span> <span class="s">&quot;sortdict&quot;</span><span class="p">,</span>
    <span class="s">&quot;run_with_tz&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for regression test exceptions.&quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="TestFailed"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.TestFailed">[docs]</a><span class="k">class</span> <span class="nc">TestFailed</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test failed.&quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="ResourceDenied"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.ResourceDenied">[docs]</a><span class="k">class</span> <span class="nc">ResourceDenied</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test skipped because it requested a disallowed resource.</span>

<span class="sd">    This is raised when a test calls requires() for a resource that</span>
<span class="sd">    has not be enabled.  It is used to distinguish between expected</span>
<span class="sd">    and unexpected skips.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">ignore</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager to suppress package and module deprecation</span>
<span class="sd">    warnings when importing them.</span>

<span class="sd">    If ignore is False, this context manager has no effect.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">,</span> <span class="s">&quot;.+ (module|package)&quot;</span><span class="p">,</span>
                                    <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">yield</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span>


<div class="viewcode-block" id="import_module"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.import_module">[docs]</a><span class="k">def</span> <span class="nf">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">deprecated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">required_on</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Import and return the module to be tested, raising SkipTest if</span>
<span class="sd">    it is not available.</span>

<span class="sd">    If deprecated is True, any module or package deprecation messages</span>
<span class="sd">    will be suppressed. If a module is required on a platform but optional for</span>
<span class="sd">    others, set required_on to an iterable of platform prefixes which will be</span>
<span class="sd">    compared against sys.platform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">required_on</span><span class="p">)):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<span class="k">def</span> <span class="nf">_save_and_remove_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to save and remove a module from sys.modules</span>

<span class="sd">    Raise ImportError if the module can&#39;t be imported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># try to import the module and raise an error if it can&#39;t be imported</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">modname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">orig_modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_save_and_block_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to save and block a module in sys.modules</span>

<span class="sd">    Return True if the module was in sys.modules, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">orig_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">saved</span>


<div class="viewcode-block" id="anticipate_failure"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.anticipate_failure">[docs]</a><span class="k">def</span> <span class="nf">anticipate_failure</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to mark a test that is known to be broken in some cases</span>

<span class="sd">       Any use of this decorator should have a comment identifying the</span>
<span class="sd">       associated tracker issue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">expectedFailure</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="load_package_tests"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.load_package_tests">[docs]</a><span class="k">def</span> <span class="nf">load_package_tests</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">standard_tests</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic load_tests implementation for simple test packages.</span>

<span class="sd">    Most packages can implement load_tests using this function as follows:</span>

<span class="sd">       def load_tests(*args):</span>
<span class="sd">           return load_package_tests(os.path.dirname(__file__), *args)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;test*&quot;</span>
    <span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>              <span class="c"># Lib</span>
                  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>              <span class="c"># test</span>
                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span>   <span class="c"># support</span>
    <span class="n">package_tests</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="n">start_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span>
                                    <span class="n">top_level_dir</span><span class="o">=</span><span class="n">top_dir</span><span class="p">,</span>
                                    <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">standard_tests</span><span class="o">.</span><span class="n">addTests</span><span class="p">(</span><span class="n">package_tests</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">standard_tests</span>

</div>
<div class="viewcode-block" id="import_fresh_module"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.import_fresh_module">[docs]</a><span class="k">def</span> <span class="nf">import_fresh_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="p">(),</span> <span class="n">blocked</span><span class="o">=</span><span class="p">(),</span> <span class="n">deprecated</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import and return a module, deliberately bypassing sys.modules.</span>

<span class="sd">    This function imports and returns a fresh copy of the named Python module</span>
<span class="sd">    by removing the named module from sys.modules before doing the import.</span>
<span class="sd">    Note that unlike reload, the original module is not affected by</span>
<span class="sd">    this operation.</span>

<span class="sd">    *fresh* is an iterable of additional module names that are also removed</span>
<span class="sd">    from the sys.modules cache before doing the import.</span>

<span class="sd">    *blocked* is an iterable of module names that are replaced with None</span>
<span class="sd">    in the module cache during the import to ensure that attempts to import</span>
<span class="sd">    them raise ImportError.</span>

<span class="sd">    The named module and any modules named in the *fresh* and *blocked*</span>
<span class="sd">    parameters are saved before starting the import and then reinserted into</span>
<span class="sd">    sys.modules when the fresh import is complete.</span>

<span class="sd">    Module and package deprecation messages are suppressed during this import</span>
<span class="sd">    if *deprecated* is True.</span>

<span class="sd">    This function will raise ImportError if the named module cannot be</span>
<span class="sd">    imported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE: test_heapq, test_json and test_warnings include extra sanity checks</span>
    <span class="c"># to make sure that this utility function is working as expected</span>
    <span class="k">with</span> <span class="n">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
        <span class="c"># Keep track of modules saved for later restoration as well</span>
        <span class="c"># as those which just need a blocking entry removed</span>
        <span class="n">orig_modules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">names_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_save_and_remove_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fresh_name</span> <span class="ow">in</span> <span class="n">fresh</span><span class="p">:</span>
                <span class="n">_save_and_remove_module</span><span class="p">(</span><span class="n">fresh_name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">blocked_name</span> <span class="ow">in</span> <span class="n">blocked</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_save_and_block_module</span><span class="p">(</span><span class="n">blocked_name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
                    <span class="n">names_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blocked_name</span><span class="p">)</span>
            <span class="n">fresh_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">fresh_module</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">orig_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">orig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
            <span class="k">for</span> <span class="n">name_to_remove</span> <span class="ow">in</span> <span class="n">names_to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name_to_remove</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fresh_module</span>

</div>
<div class="viewcode-block" id="get_attribute"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.get_attribute">[docs]</a><span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an attribute, raising SkipTest if AttributeError is raised.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attribute</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&quot;object </span><span class="si">%r</span><span class="s"> has no attribute </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">attribute</span>
</div>
<span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c"># Flag set to 0 by regrtest.py</span>
<span class="n">use_resources</span> <span class="o">=</span> <span class="bp">None</span>     <span class="c"># Flag set to [] by regrtest.py</span>
<span class="n">max_memuse</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c"># Disable bigmem tests (they will still be run with</span>
                         <span class="c"># small sizes, to make sure they work.)</span>
<span class="n">real_max_memuse</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">failfast</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">match_tests</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># _original_stdout is meant to hold stdout at the time regrtest began.</span>
<span class="c"># This may be &quot;the real&quot; stdout, or IDLE&#39;s emulation of stdout, or whatever.</span>
<span class="c"># The point is to have some flavor of stdout the user can actually see.</span>
<span class="n">_original_stdout</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="record_original_stdout"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.record_original_stdout">[docs]</a><span class="k">def</span> <span class="nf">record_original_stdout</span><span class="p">(</span><span class="n">stdout</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_original_stdout</span>
    <span class="n">_original_stdout</span> <span class="o">=</span> <span class="n">stdout</span>
</div>
<div class="viewcode-block" id="get_original_stdout"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.get_original_stdout">[docs]</a><span class="k">def</span> <span class="nf">get_original_stdout</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_original_stdout</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
</div>
<div class="viewcode-block" id="unload"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.unload">[docs]</a><span class="k">def</span> <span class="nf">unload</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
</div>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;win&quot;</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_waitfor</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">waitall</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c"># Perform the operation</span>
        <span class="n">func</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
        <span class="c"># Now setup the wait loop</span>
        <span class="k">if</span> <span class="n">waitall</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">pathname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirname</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">dirname</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span>
        <span class="c"># Check for `pathname` to be removed from the filesystem.</span>
        <span class="c"># The exponential backoff of the timeout amounts to a total</span>
        <span class="c"># of ~1 second after which the deletion is probably an error</span>
        <span class="c"># anyway.</span>
        <span class="c"># Testing on a i7@4.3GHz shows that usually only 1 iteration is</span>
        <span class="c"># required when contention occurs.</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="k">while</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="c"># Note we are only testing for the existence of the file(s) in</span>
            <span class="c"># the contents of the directory regardless of any security or</span>
            <span class="c"># access rights.  If we have made it this far, we have sufficient</span>
            <span class="c"># permissions to do that much using Python&#39;s equivalent of the</span>
            <span class="c"># Windows API FindFirstFile.</span>
            <span class="c"># Other Windows APIs can fail or give incorrect results when</span>
            <span class="c"># dealing with files that are pending deletion.</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">L</span> <span class="k">if</span> <span class="n">waitall</span> <span class="k">else</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">L</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="c"># Increase the timeout and try again</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">timeout</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;tests may fail, delete still pending for &#39;</span> <span class="o">+</span> <span class="n">pathname</span><span class="p">,</span>
                      <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">_waitfor</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="n">_waitfor</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_rmtree_inner</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">fullname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;support.rmtree(): os.lstat(</span><span class="si">%r</span><span class="s">) failed with </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
                          <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">)</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
                    <span class="n">_waitfor</span><span class="p">(</span><span class="n">_rmtree_inner</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">waitall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="n">_waitfor</span><span class="p">(</span><span class="n">_rmtree_inner</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">waitall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_waitfor</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_unlink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span>
    <span class="n">_rmdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span>
    <span class="n">_rmtree</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span>

<div class="viewcode-block" id="unlink"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.unlink">[docs]</a><span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">NotADirectoryError</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<span class="k">def</span> <span class="nf">rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="rmtree"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.rmtree">[docs]</a><span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
</div>
<span class="k">def</span> <span class="nf">make_legacy_pyc</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move a PEP 3147 pyc/pyo file to its legacy pyc/pyo location.</span>

<span class="sd">    The choice of .pyc or .pyo extension is done based on the __debug__ flag</span>
<span class="sd">    value.</span>

<span class="sd">    :param source: The file system path to the source file.  The source file</span>
<span class="sd">        does not need to exist, however the PEP 3147 pyc file must exist.</span>
<span class="sd">    :return: The file system path to the legacy pyc file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pyc_file</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cache_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">up_one</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="n">legacy_pyc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">up_one</span><span class="p">,</span> <span class="n">source</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39;c&#39;</span> <span class="k">if</span> <span class="n">__debug__</span> <span class="k">else</span> <span class="s">&#39;o&#39;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">pyc_file</span><span class="p">,</span> <span class="n">legacy_pyc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">legacy_pyc</span>

<div class="viewcode-block" id="forget"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.forget">[docs]</a><span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">modname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&#39;Forget&#39; a module was ever imported.</span>

<span class="sd">    This removes the module from sys.modules and deletes any PEP 3147 or</span>
<span class="sd">    legacy .pyc and .pyo files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unload</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">modname</span> <span class="o">+</span> <span class="s">&#39;.py&#39;</span><span class="p">)</span>
        <span class="c"># It doesn&#39;t matter if they exist or not, unlink all possible</span>
        <span class="c"># combinations of PEP 3147 and legacy pyc and pyo files.</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s">&#39;c&#39;</span><span class="p">)</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cache_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">debug_override</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cache_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">debug_override</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c"># Check whether a gui is actually available</span></div>
<span class="k">def</span> <span class="nf">_is_gui_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">result</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
        <span class="c"># if Python is running as a service (such as the buildbot service),</span>
        <span class="c"># gui interaction may be disallowed</span>
        <span class="kn">import</span> <span class="nn">ctypes</span>
        <span class="kn">import</span> <span class="nn">ctypes.wintypes</span>
        <span class="n">UOI_FLAGS</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">WSF_VISIBLE</span> <span class="o">=</span> <span class="mh">0x0001</span>
        <span class="k">class</span> <span class="nc">USEROBJECTFLAGS</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;fInherit&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&quot;fReserved&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&quot;dwFlags&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">)]</span>
        <span class="n">dll</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">dll</span><span class="o">.</span><span class="n">GetProcessWindowStation</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">()</span>
        <span class="n">uof</span> <span class="o">=</span> <span class="n">USEROBJECTFLAGS</span><span class="p">()</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dll</span><span class="o">.</span><span class="n">GetUserObjectInformationW</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
            <span class="n">UOI_FLAGS</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">uof</span><span class="p">),</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">uof</span><span class="p">),</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">needed</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">uof</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">&amp;</span> <span class="n">WSF_VISIBLE</span><span class="p">):</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;gui not available (WSF_VISIBLE flag not set)&quot;</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
        <span class="c"># The Aqua Tk implementations on OS X can abort the process if</span>
        <span class="c"># being called in an environment where a window server connection</span>
        <span class="c"># cannot be made, for instance when invoked by a buildbot or ssh</span>
        <span class="c"># process not running under the same user id as the current console</span>
        <span class="c"># user.  To avoid that, raise an exception if the window manager</span>
        <span class="c"># connection is not available.</span>
        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">cdll</span><span class="p">,</span> <span class="n">c_int</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">Structure</span>
        <span class="kn">from</span> <span class="nn">ctypes.util</span> <span class="kn">import</span> <span class="n">find_library</span>

        <span class="n">app_services</span> <span class="o">=</span> <span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">find_library</span><span class="p">(</span><span class="s">&quot;ApplicationServices&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">app_services</span><span class="o">.</span><span class="n">CGMainDisplayID</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;gui tests cannot run without OS X window manager&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">ProcessSerialNumber</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
                <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;highLongOfPSN&quot;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
                            <span class="p">(</span><span class="s">&quot;lowLongOfPSN&quot;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">)]</span>
            <span class="n">psn</span> <span class="o">=</span> <span class="n">ProcessSerialNumber</span><span class="p">()</span>
            <span class="n">psn_p</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">psn</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>  <span class="p">(</span><span class="n">app_services</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">(</span><span class="n">psn_p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="p">(</span><span class="n">app_services</span><span class="o">.</span><span class="n">SetFrontProcess</span><span class="p">(</span><span class="n">psn_p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;cannot run without OS X gui process&quot;</span>

    <span class="c"># check on every platform whether tkinter can actually do anything</span>
    <span class="c"># but skip the test on OS X because it can cause segfaults in Cocoa Tk</span>
    <span class="c"># when running regrtest with the -j option (multiple threads/subprocesses)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">reason</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;darwin&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">Tk</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">err_string</span> <span class="o">=</span> <span class="n">err_string</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; [...]&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Tk unavailable due to {}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                                           <span class="n">err_string</span><span class="p">)</span>

    <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
    <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">reason</span>

    <span class="k">return</span> <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">result</span>

<div class="viewcode-block" id="is_resource_enabled"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.is_resource_enabled">[docs]</a><span class="k">def</span> <span class="nf">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test whether a resource is enabled.</span>

<span class="sd">    Known resources are set by regrtest.py.  If not running under regrtest.py,</span>
<span class="sd">    all resources are assumed enabled unless use_resources has been set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">use_resources</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">use_resources</span>
</div>
<div class="viewcode-block" id="requires"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.requires">[docs]</a><span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise ResourceDenied if the specified resource is not available.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s">&#39;gui&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_gui_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Use of the </span><span class="si">%r</span><span class="s"> resource not enabled&quot;</span> <span class="o">%</span> <span class="n">resource</span>
        <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">_requires_unix_version</span><span class="p">(</span><span class="n">sysname</span><span class="p">,</span> <span class="n">min_version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is `sysname` and the version is less</span>
<span class="sd">    than `min_version`.</span>

<span class="sd">    For example, @_requires_unix_version(&#39;FreeBSD&#39;, (7, 2)) raises SkipTest if</span>
<span class="sd">    the FreeBSD version is less than 7.2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="n">sysname</span><span class="p">:</span>
                <span class="n">version_txt</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version_txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">min_version</span><span class="p">:</span>
                        <span class="n">min_version_txt</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_version</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
                            <span class="s">&quot;</span><span class="si">%s</span><span class="s"> version </span><span class="si">%s</span><span class="s"> or higher required, not </span><span class="si">%s</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">sysname</span><span class="p">,</span> <span class="n">min_version_txt</span><span class="p">,</span> <span class="n">version_txt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">min_version</span> <span class="o">=</span> <span class="n">min_version</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<div class="viewcode-block" id="requires_freebsd_version"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.requires_freebsd_version">[docs]</a><span class="k">def</span> <span class="nf">requires_freebsd_version</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is FreeBSD and the FreeBSD version is</span>
<span class="sd">    less than `min_version`.</span>

<span class="sd">    For example, @requires_freebsd_version(7, 2) raises SkipTest if the FreeBSD</span>
<span class="sd">    version is less than 7.2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_requires_unix_version</span><span class="p">(</span><span class="s">&#39;FreeBSD&#39;</span><span class="p">,</span> <span class="n">min_version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="requires_linux_version"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.requires_linux_version">[docs]</a><span class="k">def</span> <span class="nf">requires_linux_version</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is Linux and the Linux version is</span>
<span class="sd">    less than `min_version`.</span>

<span class="sd">    For example, @requires_linux_version(2, 6, 32) raises SkipTest if the Linux</span>
<span class="sd">    version is less than 2.6.32.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_requires_unix_version</span><span class="p">(</span><span class="s">&#39;Linux&#39;</span><span class="p">,</span> <span class="n">min_version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="requires_mac_ver"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.requires_mac_ver">[docs]</a><span class="k">def</span> <span class="nf">requires_mac_ver</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is Mac OS X and the OS X</span>
<span class="sd">    version if less than min_version.</span>

<span class="sd">    For example, @requires_mac_ver(10, 5) raises SkipTest if the OS X version</span>
<span class="sd">    is lesser than 10.5.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
                <span class="n">version_txt</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">mac_ver</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version_txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">min_version</span><span class="p">:</span>
                        <span class="n">min_version_txt</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_version</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
                            <span class="s">&quot;Mac OS X </span><span class="si">%s</span><span class="s"> or higher required, not </span><span class="si">%s</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">min_version_txt</span><span class="p">,</span> <span class="n">version_txt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">min_version</span> <span class="o">=</span> <span class="n">min_version</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c"># Don&#39;t use &quot;localhost&quot;, since resolving it uses the DNS under recent</span>
<span class="c"># Windows versions (see issue #18792).</span></div>
<span class="n">HOST</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
<span class="n">HOSTv6</span> <span class="o">=</span> <span class="s">&quot;::1&quot;</span>


<div class="viewcode-block" id="find_unused_port"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.find_unused_port">[docs]</a><span class="k">def</span> <span class="nf">find_unused_port</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socktype</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an unused port that should be suitable for binding.  This is</span>
<span class="sd">    achieved by creating a temporary socket with the same family and type as</span>
<span class="sd">    the &#39;sock&#39; parameter (default is AF_INET, SOCK_STREAM), and binding it to</span>
<span class="sd">    the specified host address (defaults to 0.0.0.0) with the port set to 0,</span>
<span class="sd">    eliciting an unused ephemeral port from the OS.  The temporary socket is</span>
<span class="sd">    then closed and deleted, and the ephemeral port is returned.</span>

<span class="sd">    Either this method or bind_port() should be used for any tests where a</span>
<span class="sd">    server socket needs to be bound to a particular port for the duration of</span>
<span class="sd">    the test.  Which one to use depends on whether the calling code is creating</span>
<span class="sd">    a python socket, or if an unused port needs to be provided in a constructor</span>
<span class="sd">    or passed to an external program (i.e. the -accept argument to openssl&#39;s</span>
<span class="sd">    s_server mode).  Always prefer bind_port() over find_unused_port() where</span>
<span class="sd">    possible.  Hard coded ports should *NEVER* be used.  As soon as a server</span>
<span class="sd">    socket is bound to a hard coded port, the ability to run multiple instances</span>
<span class="sd">    of the test simultaneously on the same host is compromised, which makes the</span>
<span class="sd">    test a ticking time bomb in a buildbot environment. On Unix buildbots, this</span>
<span class="sd">    may simply manifest as a failed test, which can be recovered from without</span>
<span class="sd">    intervention in most cases, but on Windows, the entire python process can</span>
<span class="sd">    completely and utterly wedge, requiring someone to log in to the buildbot</span>
<span class="sd">    and manually kill the affected process.</span>

<span class="sd">    (This is easy to reproduce on Windows, unfortunately, and can be traced to</span>
<span class="sd">    the SO_REUSEADDR socket option having different semantics on Windows versus</span>
<span class="sd">    Unix/Linux.  On Unix, you can&#39;t have two AF_INET SOCK_STREAM sockets bind,</span>
<span class="sd">    listen and then accept connections on identical host/ports.  An EADDRINUSE</span>
<span class="sd">    OSError will be raised at some point (depending on the platform and</span>
<span class="sd">    the order bind and listen were called on each socket).</span>

<span class="sd">    However, on Windows, if SO_REUSEADDR is set on the sockets, no EADDRINUSE</span>
<span class="sd">    will ever be raised when attempting to bind two identical host/ports. When</span>
<span class="sd">    accept() is called on each socket, the second caller&#39;s process will steal</span>
<span class="sd">    the port from the first caller, leaving them both in an awkwardly wedged</span>
<span class="sd">    state where they&#39;ll no longer respond to any signals or graceful kills, and</span>
<span class="sd">    must be forcibly killed via OpenProcess()/TerminateProcess().</span>

<span class="sd">    The solution on Windows is to use the SO_EXCLUSIVEADDRUSE socket option</span>
<span class="sd">    instead of SO_REUSEADDR, which effectively affords the same semantics as</span>
<span class="sd">    SO_REUSEADDR on Unix.  Given the propensity of Unix developers in the Open</span>
<span class="sd">    Source world compared to Windows ones, this is a common mistake.  A quick</span>
<span class="sd">    look over OpenSSL&#39;s 0.9.8g source shows that they use SO_REUSEADDR when</span>
<span class="sd">    openssl.exe is called with the &#39;s_server&#39; option, for example. See</span>
<span class="sd">    http://bugs.python.org/issue2550 for more info.  The following site also</span>
<span class="sd">    has a very thorough description about the implications of both REUSEADDR</span>
<span class="sd">    and EXCLUSIVEADDRUSE on Windows:</span>
<span class="sd">    http://msdn2.microsoft.com/en-us/library/ms740621(VS.85).aspx)</span>

<span class="sd">    XXX: although this approach is a vast improvement on previous attempts to</span>
<span class="sd">    elicit unused ports, it rests heavily on the assumption that the ephemeral</span>
<span class="sd">    port returned to us by the OS won&#39;t immediately be dished back out to some</span>
<span class="sd">    other process when we close and delete our temporary socket but before our</span>
<span class="sd">    calling code has a chance to bind the returned port.  We can deal with this</span>
<span class="sd">    issue if/when we come across it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tempsock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">bind_port</span><span class="p">(</span><span class="n">tempsock</span><span class="p">)</span>
    <span class="n">tempsock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">tempsock</span>
    <span class="k">return</span> <span class="n">port</span>
</div>
<div class="viewcode-block" id="bind_port"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.bind_port">[docs]</a><span class="k">def</span> <span class="nf">bind_port</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bind the socket to a free port and return the port number.  Relies on</span>
<span class="sd">    ephemeral ports in order to ensure we are using an unbound port.  This is</span>
<span class="sd">    important as many tests may be running simultaneously, especially in a</span>
<span class="sd">    buildbot environment.  This method raises an exception if the sock.family</span>
<span class="sd">    is AF_INET and sock.type is SOCK_STREAM, *and* the socket has SO_REUSEADDR</span>
<span class="sd">    or SO_REUSEPORT set on it.  Tests should *never* set these socket options</span>
<span class="sd">    for TCP/IP sockets.  The only case for setting these options is testing</span>
<span class="sd">    multicasting via multiple UDP sockets.</span>

<span class="sd">    Additionally, if the SO_EXCLUSIVEADDRUSE socket option is available (i.e.</span>
<span class="sd">    on Windows), it will be set on the socket.  This will prevent anyone else</span>
<span class="sd">    from bind()&#39;ing to our host/port for the duration of the test.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span> <span class="ow">and</span> <span class="n">sock</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SO_REUSEADDR&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s">&quot;tests should never set the SO_REUSEADDR &quot;</span>   \
                                 <span class="s">&quot;socket option on TCP/IP sockets!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SO_REUSEPORT&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s">&quot;tests should never set the SO_REUSEPORT &quot;</span>   \
                                     <span class="s">&quot;socket option on TCP/IP sockets!&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="c"># Python&#39;s socket module was compiled using modern headers</span>
                <span class="c"># thus defining SO_REUSEPORT but this process is running</span>
                <span class="c"># under an older kernel that does not support SO_REUSEPORT.</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;SO_EXCLUSIVEADDRUSE&#39;</span><span class="p">):</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_EXCLUSIVEADDRUSE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">port</span>
</div>
<span class="k">def</span> <span class="nf">_is_ipv6_enabled</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check whether IPv6 is enabled on this host.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">has_ipv6</span><span class="p">:</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOSTv6</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="n">IPV6_ENABLED</span> <span class="o">=</span> <span class="n">_is_ipv6_enabled</span><span class="p">()</span>


<span class="c"># A constant likely larger than the underlying OS pipe buffer size, to</span>
<span class="c"># make writes blocking.</span>
<span class="c"># Windows limit seems to be around 512 B, and many Unix kernels have a</span>
<span class="c"># 64 KiB pipe buffer size or 16 * PAGE_SIZE: take a few megs to be sure.</span>
<span class="c"># (see issue #17835 for a discussion of this number).</span>
<span class="n">PIPE_MAX_SIZE</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c"># A constant likely larger than the underlying OS socket buffer size, to make</span>
<span class="c"># writes blocking.</span>
<span class="c"># The socket buffer sizes can usually be tuned system-wide (e.g. through sysctl</span>
<span class="c"># on Linux), or on a per-socket basis (SO_SNDBUF/SO_RCVBUF). See issue #18643</span>
<span class="c"># for a discussion of this number).</span>
<span class="n">SOCK_MAX_SIZE</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c"># decorator for skipping tests on non-IEEE 754 platforms</span>
<span class="n">requires_IEEE_754</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span>
    <span class="nb">float</span><span class="o">.</span><span class="n">__getformat__</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;IEEE&quot;</span><span class="p">),</span>
    <span class="s">&quot;test requires IEEE 754 doubles&quot;</span><span class="p">)</span>

<span class="n">requires_zlib</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">zlib</span><span class="p">,</span> <span class="s">&#39;requires zlib&#39;</span><span class="p">)</span>

<span class="n">requires_gzip</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">gzip</span><span class="p">,</span> <span class="s">&#39;requires gzip&#39;</span><span class="p">)</span>

<span class="n">requires_bz2</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">bz2</span><span class="p">,</span> <span class="s">&#39;requires bz2&#39;</span><span class="p">)</span>

<span class="n">requires_lzma</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">lzma</span><span class="p">,</span> <span class="s">&#39;requires lzma&#39;</span><span class="p">)</span>

<span class="n">is_jython</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;java&#39;</span><span class="p">)</span>

<span class="c"># Filename used for testing</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;java&#39;</span><span class="p">:</span>
    <span class="c"># Jython disallows @ in module names</span>
    <span class="n">TESTFN</span> <span class="o">=</span> <span class="s">&#39;$test&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">TESTFN</span> <span class="o">=</span> <span class="s">&#39;@test&#39;</span>

<span class="c"># Disambiguate TESTFN for parallel testing, while letting it remain a valid</span>
<span class="c"># module name.</span>
<span class="n">TESTFN</span> <span class="o">=</span> <span class="s">&quot;{}_{}_tmp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

<span class="c"># FS_NONASCII: non-ASCII character encodable by os.fsencode(),</span>
<span class="c"># or None if there is no such character.</span>
<span class="n">FS_NONASCII</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="p">(</span>
    <span class="c"># First try printable and common characters to have a readable filename.</span>
    <span class="c"># For each character, the encoding list are just example of encodings able</span>
    <span class="c"># to encode the character (the list is not exhaustive).</span>

    <span class="c"># U+00E6 (Latin Small Letter Ae): cp1252, iso-8859-1</span>
    <span class="s">&#39;</span><span class="se">\u00E6</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+0130 (Latin Capital Letter I With Dot Above): cp1254, iso8859_3</span>
    <span class="s">&#39;</span><span class="se">\u0130</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+0141 (Latin Capital Letter L With Stroke): cp1250, cp1257</span>
    <span class="s">&#39;</span><span class="se">\u0141</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+03C6 (Greek Small Letter Phi): cp1253</span>
    <span class="s">&#39;</span><span class="se">\u03C6</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+041A (Cyrillic Capital Letter Ka): cp1251</span>
    <span class="s">&#39;</span><span class="se">\u041A</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+05D0 (Hebrew Letter Alef): Encodable to cp424</span>
    <span class="s">&#39;</span><span class="se">\u05D0</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+060C (Arabic Comma): cp864, cp1006, iso8859_6, mac_arabic</span>
    <span class="s">&#39;</span><span class="se">\u060C</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+062A (Arabic Letter Teh): cp720</span>
    <span class="s">&#39;</span><span class="se">\u062A</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+0E01 (Thai Character Ko Kai): cp874</span>
    <span class="s">&#39;</span><span class="se">\u0E01</span><span class="s">&#39;</span><span class="p">,</span>

    <span class="c"># Then try more &quot;special&quot; characters. &quot;special&quot; because they may be</span>
    <span class="c"># interpreted or displayed differently depending on the exact locale</span>
    <span class="c"># encoding and the font.</span>

    <span class="c"># U+00A0 (No-Break Space)</span>
    <span class="s">&#39;</span><span class="se">\u00A0</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># U+20AC (Euro Sign)</span>
    <span class="s">&#39;</span><span class="se">\u20AC</span><span class="s">&#39;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fsdecode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">character</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FS_NONASCII</span> <span class="o">=</span> <span class="n">character</span>
        <span class="k">break</span>

<span class="c"># TESTFN_UNICODE is a non-ascii filename</span>
<span class="n">TESTFN_UNICODE</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&quot;-</span><span class="se">\xe0\xf2\u0258\u0141\u011f</span><span class="s">&quot;</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
    <span class="c"># In Mac OS X&#39;s VFS API file names are, by definition, canonically</span>
    <span class="c"># decomposed Unicode, encoded using UTF-8. See QA1173:</span>
    <span class="c"># http://developer.apple.com/mac/library/qa/qa2001/qa1173.html</span>
    <span class="kn">import</span> <span class="nn">unicodedata</span>
    <span class="n">TESTFN_UNICODE</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s">&#39;NFD&#39;</span><span class="p">,</span> <span class="n">TESTFN_UNICODE</span><span class="p">)</span>
<span class="n">TESTFN_ENCODING</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>

<span class="c"># TESTFN_UNENCODABLE is a filename (str type) that should *not* be able to be</span>
<span class="c"># encoded by the filesystem encoding (in strict mode). It can be None if we</span>
<span class="c"># cannot generate such filename.</span>
<span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;nt&#39;</span><span class="p">,</span> <span class="s">&#39;ce&#39;</span><span class="p">):</span>
    <span class="c"># skip win32s (0) or Windows 9x/ME (1)</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getwindowsversion</span><span class="p">()</span><span class="o">.</span><span class="n">platform</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c"># Different kinds of characters from various languages to minimize the</span>
        <span class="c"># probability that the whole name is encodable to MBCS (issue #9819)</span>
        <span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&quot;-</span><span class="se">\u5171\u0141\u2661\u0363\uDC80</span><span class="s">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">TESTFN_UNENCODABLE</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;WARNING: The filename </span><span class="si">%r</span><span class="s"> CAN be encoded by the filesystem encoding (</span><span class="si">%s</span><span class="s">). &#39;</span>
                  <span class="s">&#39;Unicode filename tests may not be effective&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">TESTFN_UNENCODABLE</span><span class="p">,</span> <span class="n">TESTFN_ENCODING</span><span class="p">))</span>
            <span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c"># Mac OS X denies unencodable filenames (invalid utf-8)</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># ascii and utf-8 cannot encode the byte 0xff</span>
        <span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c"># 0xff will be encoded using the surrogate character u+DCFF</span>
        <span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="n">TESTFN</span> \
            <span class="o">+</span> <span class="n">b</span><span class="s">&#39;-</span><span class="se">\xff</span><span class="s">&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">,</span> <span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># File system encoding (eg. ISO-8859-* encodings) can encode</span>
        <span class="c"># the byte 0xff. Skip some unicode filename tests.</span>
        <span class="k">pass</span>

<span class="c"># TESTFN_UNDECODABLE is a filename (bytes type) that should *not* be able to be</span>
<span class="c"># decoded from the filesystem encoding (in strict mode). It can be None if we</span>
<span class="c"># cannot generate such filename (ex: the latin1 encoding can decode any byte</span>
<span class="c"># sequence). On UNIX, TESTFN_UNDECODABLE can be decoded by os.fsdecode() thanks</span>
<span class="c"># to the surrogateescape error handler (PEP 383), but not from the filesystem</span>
<span class="c"># encoding in strict mode.</span>
<span class="n">TESTFN_UNDECODABLE</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
    <span class="c"># b&#39;\xff&#39; is not decodable by os.fsdecode() with code page 932. Windows</span>
    <span class="c"># accepts it to create a file or a directory, or don&#39;t accept to enter to</span>
    <span class="c"># such directory (when the bytes name is used). So test b&#39;\xe7&#39; first: it is</span>
    <span class="c"># not decodable from cp932.</span>
    <span class="n">b</span><span class="s">&#39;</span><span class="se">\xe7</span><span class="s">w</span><span class="se">\xf0</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># undecodable from ASCII, UTF-8</span>
    <span class="n">b</span><span class="s">&#39;</span><span class="se">\xff</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># undecodable from iso8859-3, iso8859-6, iso8859-7, cp424, iso8859-8, cp856</span>
    <span class="c"># and cp857</span>
    <span class="n">b</span><span class="s">&#39;</span><span class="se">\xae\xd5</span><span class="s">&#39;</span>
    <span class="c"># undecodable from UTF-8 (UNIX and Mac OS X)</span>
    <span class="n">b</span><span class="s">&#39;</span><span class="se">\xed\xb2\x80</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xed\xb4\x80</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="c"># undecodable from shift_jis, cp869, cp874, cp932, cp1250, cp1251, cp1252,</span>
    <span class="c"># cp1253, cp1254, cp1255, cp1257, cp1258</span>
    <span class="n">b</span><span class="s">&#39;</span><span class="se">\x81\x98</span><span class="s">&#39;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">TESTFN_UNDECODABLE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">break</span>

<span class="k">if</span> <span class="n">FS_NONASCII</span><span class="p">:</span>
    <span class="n">TESTFN_NONASCII</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">FS_NONASCII</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">TESTFN_NONASCII</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># Save the initial cwd</span>
<span class="n">SAVEDCWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">temp_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a context manager that creates a temporary directory.</span>

<span class="sd">    Arguments:</span>

<span class="sd">      path: the directory to create temporarily.  If omitted or None,</span>
<span class="sd">        defaults to creating a temporary directory using tempfile.mkdtemp.</span>

<span class="sd">      quiet: if False (the default), the context manager raises an exception</span>
<span class="sd">        on error.  Otherwise, if the path is specified and cannot be</span>
<span class="sd">        created, only a warning is issued.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dir_created</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">dir_created</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dir_created</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;tests may fail, unable to create temp dir: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
                          <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">path</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dir_created</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">change_cwd</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a context manager that changes the current working directory.</span>

<span class="sd">    Arguments:</span>

<span class="sd">      path: the directory to use as the temporary current working directory.</span>

<span class="sd">      quiet: if False (the default), the context manager raises an exception</span>
<span class="sd">        on error.  Otherwise, it issues only a warning and keeps the current</span>
<span class="sd">        working directory the same.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saved_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;tests may fail, unable to change CWD to: &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
                      <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">saved_dir</span><span class="p">)</span>


<span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="temp_cwd"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.temp_cwd">[docs]</a><span class="k">def</span> <span class="nf">temp_cwd</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;tempcwd&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that temporarily creates and changes the CWD.</span>

<span class="sd">    The function temporarily changes the current working directory</span>
<span class="sd">    after creating a temporary directory in the current directory with</span>
<span class="sd">    name *name*.  If *name* is None, the temporary directory is</span>
<span class="sd">    created using tempfile.mkdtemp.</span>

<span class="sd">    If *quiet* is False (default) and it is not possible to</span>
<span class="sd">    create or change the CWD, an error is raised.  If *quiet* is True,</span>
<span class="sd">    only a warning is raised and the original CWD is used.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">temp_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_path</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">change_cwd</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">cwd_dir</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cwd_dir</span>
</div>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;umask&quot;</span><span class="p">):</span>
    <span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="temp_umask"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.temp_umask">[docs]</a>    <span class="k">def</span> <span class="nf">temp_umask</span><span class="p">(</span><span class="n">umask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context manager that temporarily sets the process umask.&quot;&quot;&quot;</span>
        <span class="n">oldmask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">umask</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">)</span>

<span class="c"># TEST_HOME_DIR refers to the top level directory of the &quot;test&quot; package</span>
<span class="c"># that contains Python&#39;s regression test suite</span></div>
<span class="n">TEST_SUPPORT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">TEST_HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">TEST_SUPPORT_DIR</span><span class="p">)</span>

<span class="c"># TEST_DATA_DIR is used as a target download location for remote resources</span>
<span class="n">TEST_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_HOME_DIR</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="findfile"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.findfile">[docs]</a><span class="k">def</span> <span class="nf">findfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to find a file on sys.path or in the test directory.  If it is not</span>
<span class="sd">    found the argument passed to the function is returned (this does not</span>
<span class="sd">    necessarily signal failure; could still be the legitimate path).</span>

<span class="sd">    Setting *subdir* indicates a relative path to use to find the file</span>
<span class="sd">    rather than looking directly in the path directories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="n">subdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">TEST_HOME_DIR</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
    <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="k">return</span> <span class="n">fn</span>
    <span class="k">return</span> <span class="n">filename</span>
</div>
<div class="viewcode-block" id="create_empty_file"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.create_empty_file">[docs]</a><span class="k">def</span> <span class="nf">create_empty_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an empty file. If the file already exists, truncate it.&quot;&quot;&quot;</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="sortdict"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.sortdict">[docs]</a><span class="k">def</span> <span class="nf">sortdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="s">&quot;Like repr(dict), but in sorted order.&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">reprpairs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pair</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
    <span class="n">withcommas</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reprpairs</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;{</span><span class="si">%s</span><span class="s">}&quot;</span> <span class="o">%</span> <span class="n">withcommas</span>
</div>
<span class="k">def</span> <span class="nf">make_bad_fd</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an invalid file descriptor by opening and closing a file and return</span>
<span class="sd">    its fd.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">file</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span>

<div class="viewcode-block" id="check_syntax_error"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.check_syntax_error">[docs]</a><span class="k">def</span> <span class="nf">check_syntax_error</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
    <span class="n">testcase</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span>
                          <span class="s">&#39;&lt;test string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="open_urlresource"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.open_urlresource">[docs]</a><span class="k">def</span> <span class="nf">open_urlresource</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">urllib.parse</span>

    <span class="n">check</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># &#39;/&#39;: it&#39;s URL!</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_DATA_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">elif</span> <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="c"># Verify the requirement before downloading the file</span>
    <span class="n">requires</span><span class="p">(</span><span class="s">&#39;urlfetch&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">fetching </span><span class="si">%s</span><span class="s"> ...&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">get_original_stdout</span><span class="p">())</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s">&#39;invalid resource </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">WarningsRecorder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience wrapper for the warnings list returned on</span>
<span class="sd">       entry to the warnings.catch_warnings() context manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warnings_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span> <span class="o">=</span> <span class="n">warnings_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">warnings</span><span class="o">.</span><span class="n">WarningMessage</span><span class="o">.</span><span class="n">_WARNING_DETAILS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> has no attribute </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_filterwarnings</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Catch the warnings, then check if all the expected</span>
<span class="sd">    warnings have been raised and re-raise unexpected warnings.</span>
<span class="sd">    If &#39;quiet&#39; is True, only re-raise the unexpected warnings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Clear the warning registry of the calling module</span>
    <span class="c"># in order to re-raise the warnings.</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;__warningregistry__&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">registry</span><span class="p">:</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
        <span class="c"># Set filter &quot;always&quot; to record all warnings.  Because</span>
        <span class="c"># test_warnings swap the module, we need to look up in</span>
        <span class="c"># the sys.modules dictionary.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;always&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">WarningsRecorder</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="c"># Filter the recorded warnings</span>
    <span class="n">reraise</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">msg</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">reraise</span><span class="p">[:]:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">message</span>
            <span class="c"># Filter out the matching messages</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">issubclass</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">cat</span><span class="p">)):</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">reraise</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="c"># This filter caught nothing</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">msg</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">reraise</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;unhandled warning </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">reraise</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;filter (</span><span class="si">%r</span><span class="s">, </span><span class="si">%s</span><span class="s">) did not catch any warning&quot;</span> <span class="o">%</span>
                             <span class="n">missing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="check_warnings"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.check_warnings">[docs]</a><span class="k">def</span> <span class="nf">check_warnings</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager to silence warnings.</span>

<span class="sd">    Accept 2-tuples as positional arguments:</span>
<span class="sd">        (&quot;message regexp&quot;, WarningCategory)</span>

<span class="sd">    Optional argument:</span>
<span class="sd">     - if &#39;quiet&#39; is True, it does not fail if a filter catches nothing</span>
<span class="sd">        (default True without argument,</span>
<span class="sd">         default False if some filters are defined)</span>

<span class="sd">    Without argument, it defaults to:</span>
<span class="sd">        check_warnings((&quot;&quot;, Warning), quiet=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quiet</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;quiet&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">((</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">),)</span>
        <span class="c"># Preserve backward compatibility</span>
        <span class="k">if</span> <span class="n">quiet</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">quiet</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">_filterwarnings</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="CleanImport"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.CleanImport">[docs]</a><span class="k">class</span> <span class="nc">CleanImport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager to force import to return a new module reference.</span>

<span class="sd">    This is useful for testing module-level behaviours, such as</span>
<span class="sd">    the emission of a DeprecationWarning on import.</span>

<span class="sd">    Use like this:</span>

<span class="sd">        with CleanImport(&quot;foo&quot;):</span>
<span class="sd">            importlib.import_module(&quot;foo&quot;) # new reference</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">module_names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">module_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
                <span class="c"># It is possible that module_name is just an alias for</span>
                <span class="c"># another module (e.g. stub for modules renamed in 3.x).</span>
                <span class="c"># In that case, we also need delete the real module to clear</span>
                <span class="c"># the import cache.</span>
                <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="n">module_name</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="EnvironmentVarGuard"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.EnvironmentVarGuard">[docs]</a><span class="k">class</span> <span class="nc">EnvironmentVarGuard</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Class to help protect the environment variable properly.  Can be used as</span>
<span class="sd">    a context manager.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># Remember the initial value on the first access</span>
        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
        <span class="c"># Remember the initial value on the first access</span>
        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>

<div class="viewcode-block" id="EnvironmentVarGuard.keys"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.EnvironmentVarGuard.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">)</span>

<div class="viewcode-block" id="EnvironmentVarGuard.set"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.EnvironmentVarGuard.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</div>
<div class="viewcode-block" id="EnvironmentVarGuard.unset"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.EnvironmentVarGuard.unset">[docs]</a>    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span>

</div>
<span class="k">class</span> <span class="nc">DirsOnSysPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager to temporarily add directories to sys.path.</span>

<span class="sd">    This makes a copy of sys.path, appends any directories given</span>
<span class="sd">    as positional arguments, then reverts sys.path to the copied</span>
<span class="sd">    settings when the context ends.</span>

<span class="sd">    Note that *all* sys.path modifications in the body of the</span>
<span class="sd">    context manager, including replacement of the object,</span>
<span class="sd">    will be reverted at the end of the block.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_object</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_object</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_value</span>


<div class="viewcode-block" id="TransientResource"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.TransientResource">[docs]</a><span class="k">class</span> <span class="nc">TransientResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Raise ResourceDenied if an exception is raised while the context manager</span>
<span class="sd">    is in effect that matches the specified exception and attributes.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If type_ is a subclass of self.exc and value has attributes matching</span>
<span class="sd">        self.attrs, raise ResourceDenied.  Otherwise let the exception</span>
<span class="sd">        propagate (if any).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">attr_value</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="s">&quot;an optional resource is not available&quot;</span><span class="p">)</span>

<span class="c"># Context managers that raise ResourceDenied when various issues</span>
<span class="c"># with the Internet connection manifest themselves as exceptions.</span>
<span class="c"># XXX deprecate these and use transient_internet() instead</span></div>
<span class="n">time_out</span> <span class="o">=</span> <span class="n">TransientResource</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="n">errno</span><span class="o">.</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
<span class="n">socket_peer_reset</span> <span class="o">=</span> <span class="n">TransientResource</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">)</span>
<span class="n">ioerror_peer_reset</span> <span class="o">=</span> <span class="n">TransientResource</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">)</span>


<span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="transient_internet"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.transient_internet">[docs]</a><span class="k">def</span> <span class="nf">transient_internet</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">errnos</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Return a context manager that raises ResourceDenied when various issues</span>
<span class="sd">    with the Internet connection manifest themselves as exceptions.&quot;&quot;&quot;</span>
    <span class="n">default_errnos</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;ECONNREFUSED&#39;</span><span class="p">,</span> <span class="mi">111</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;ECONNRESET&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;EHOSTUNREACH&#39;</span><span class="p">,</span> <span class="mi">113</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;ENETUNREACH&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;ETIMEDOUT&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">default_gai_errnos</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;EAI_AGAIN&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;EAI_FAIL&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;EAI_NONAME&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;EAI_NODATA&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span>
        <span class="c"># Encountered when trying to resolve IPv6-only hostnames</span>
        <span class="p">(</span><span class="s">&#39;WSANO_DATA&#39;</span><span class="p">,</span> <span class="mi">11004</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">denied</span> <span class="o">=</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="s">&quot;Resource </span><span class="si">%r</span><span class="s"> is not available&quot;</span> <span class="o">%</span> <span class="n">resource_name</span><span class="p">)</span>
    <span class="n">captured_errnos</span> <span class="o">=</span> <span class="n">errnos</span>
    <span class="n">gai_errnos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">captured_errnos</span><span class="p">:</span>
        <span class="n">captured_errnos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
                           <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">default_errnos</span><span class="p">]</span>
        <span class="n">gai_errnos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
                      <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">default_gai_errnos</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">filter_error</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">&#39;errno&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">gai_errnos</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">n</span> <span class="ow">in</span> <span class="n">captured_errnos</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">denied</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">denied</span> <span class="kn">from</span> <span class="nn">err</span>

    <span class="n">old_timeout</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="c"># urllib can wrap original socket errors multiple times (!), we must</span>
        <span class="c"># unwrap to get at the original error.</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># The error can also be wrapped as args[1]:</span>
            <span class="c">#    except socket.error as msg:</span>
            <span class="c">#        raise OSError(&#39;socket error&#39;, msg).with_traceback(sys.exc_info()[2])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">filter_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="c"># XXX should we catch generic exceptions and look for their</span>
    <span class="c"># __cause__ or __context__?</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">old_timeout</span><span class="p">)</span>

</div>
<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">captured_output</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a context manager used by captured_stdout/stdin/stderr</span>
<span class="sd">    that temporarily replaces the sys stream *stream_name* with a StringIO.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">orig_stdout</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">orig_stdout</span><span class="p">)</span>

<div class="viewcode-block" id="captured_stdout"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.captured_stdout">[docs]</a><span class="k">def</span> <span class="nf">captured_stdout</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Capture the output of sys.stdout:</span>

<span class="sd">       with captured_stdout() as stdout:</span>
<span class="sd">           print(&quot;hello&quot;)</span>
<span class="sd">       self.assertEqual(stdout.getvalue(), &quot;hello\n&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s">&quot;stdout&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="captured_stderr"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.captured_stderr">[docs]</a><span class="k">def</span> <span class="nf">captured_stderr</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Capture the output of sys.stderr:</span>

<span class="sd">       with captured_stderr() as stderr:</span>
<span class="sd">           print(&quot;hello&quot;, file=sys.stderr)</span>
<span class="sd">       self.assertEqual(stderr.getvalue(), &quot;hello\n&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s">&quot;stderr&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="captured_stdin"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.captured_stdin">[docs]</a><span class="k">def</span> <span class="nf">captured_stdin</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Capture the input to sys.stdin:</span>

<span class="sd">       with captured_stdin() as stdin:</span>
<span class="sd">           stdin.write(&#39;hello\n&#39;)</span>
<span class="sd">           stdin.seek(0)</span>
<span class="sd">           # call test code that consumes from sys.stdin</span>
<span class="sd">           captured = input()</span>
<span class="sd">       self.assertEqual(captured, &quot;hello&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s">&quot;stdin&quot;</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">gc_collect</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Force as many objects as possible to be collected.</span>

<span class="sd">    In non-CPython implementations of Python, this is needed because timely</span>
<span class="sd">    deallocation is not guaranteed by the garbage collector.  (Even in CPython</span>
<span class="sd">    this can be the case in case of reference cycles.)  This means that __del__</span>
<span class="sd">    methods may be called later than expected and weakrefs may remain alive for</span>
<span class="sd">    longer than expected.  This function tries its best to force all garbage</span>
<span class="sd">    objects to disappear.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_jython</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">disable_gc</span><span class="p">():</span>
    <span class="n">have_gc</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">()</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">have_gc</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">python_is_optimized</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Find if Python was built with optimizations.&quot;&quot;&quot;</span>
    <span class="n">cflags</span> <span class="o">=</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s">&#39;PY_CFLAGS&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="n">final_opt</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">cflags</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-O&#39;</span><span class="p">):</span>
            <span class="n">final_opt</span> <span class="o">=</span> <span class="n">opt</span>
    <span class="k">return</span> <span class="n">final_opt</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="n">final_opt</span> <span class="o">!=</span> <span class="s">&#39;-O0&#39;</span>


<span class="n">_header</span> <span class="o">=</span> <span class="s">&#39;nP&#39;</span>
<span class="n">_align</span> <span class="o">=</span> <span class="s">&#39;0n&#39;</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&quot;gettotalrefcount&quot;</span><span class="p">):</span>
    <span class="n">_header</span> <span class="o">=</span> <span class="s">&#39;2P&#39;</span> <span class="o">+</span> <span class="n">_header</span>
    <span class="n">_align</span> <span class="o">=</span> <span class="s">&#39;0P&#39;</span>
<span class="n">_vheader</span> <span class="o">=</span> <span class="n">_header</span> <span class="o">+</span> <span class="s">&#39;n&#39;</span>

<span class="k">def</span> <span class="nf">calcobjsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">_header</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">+</span> <span class="n">_align</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calcvobjsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">_vheader</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">+</span> <span class="n">_align</span><span class="p">)</span>


<span class="n">_TPFLAGS_HAVE_GC</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span>
<span class="n">_TPFLAGS_HEAPTYPE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span>

<span class="k">def</span> <span class="nf">check_sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">_testcapi</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="c"># add GC header size</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">__flags__</span> <span class="o">&amp;</span> <span class="n">_TPFLAGS_HEAPTYPE</span><span class="p">)</span> <span class="ow">or</span>\
        <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">__flags__</span> <span class="o">&amp;</span> <span class="n">_TPFLAGS_HAVE_GC</span><span class="p">))):</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">SIZEOF_PYGC_HEAD</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;wrong size for </span><span class="si">%s</span><span class="s">: got </span><span class="si">%d</span><span class="s">, expected </span><span class="si">%d</span><span class="s">&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">test</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="c">#=======================================================================</span>
<span class="c"># Decorator for running a function in a different locale, correctly resetting</span>
<span class="c"># it afterwards.</span>

<div class="viewcode-block" id="run_with_locale"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.run_with_locale">[docs]</a><span class="k">def</span> <span class="nf">run_with_locale</span><span class="p">(</span><span class="n">catstr</span><span class="p">,</span> <span class="o">*</span><span class="n">locales</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">locale</span>
                <span class="n">category</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">catstr</span><span class="p">)</span>
                <span class="n">orig_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c"># if the test author gives us an invalid category string</span>
                <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># cannot retrieve original locale, so do nothing</span>
                <span class="n">locale</span> <span class="o">=</span> <span class="n">orig_locale</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locales</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c"># now run the function, resetting the locale on exceptions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">locale</span> <span class="ow">and</span> <span class="n">orig_locale</span><span class="p">:</span>
                    <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">orig_locale</span><span class="p">)</span>
        <span class="n">inner</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">inner</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="c">#=======================================================================</span>
<span class="c"># Decorator for running a function in a specific timezone, correctly</span>
<span class="c"># resetting it afterwards.</span>
</div>
<div class="viewcode-block" id="run_with_tz"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.run_with_tz">[docs]</a><span class="k">def</span> <span class="nf">run_with_tz</span><span class="p">(</span><span class="n">tz</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tzset</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tzset</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&quot;tzset required&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;TZ&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">orig_tz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;TZ&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_tz</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;TZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tz</span>
            <span class="n">tzset</span><span class="p">()</span>

            <span class="c"># now run the function, resetting the tz on exceptions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orig_tz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;TZ&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;TZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_tz</span>
                <span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>

        <span class="n">inner</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">inner</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="c">#=======================================================================</span>
<span class="c"># Big-memory-test support. Separate from &#39;resources&#39; because memory use</span>
<span class="c"># should be configurable.</span>

<span class="c"># Some handy shorthands. Note that these are used for byte-limits as well</span>
<span class="c"># as size-limits, in the various bigmem tests</span></div>
<span class="n">_1M</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span>
<span class="n">_1G</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">_1M</span>
<span class="n">_2G</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_1G</span>
<span class="n">_4G</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">_1G</span>

<span class="n">MAX_Py_ssize_t</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>

<div class="viewcode-block" id="set_memlimit"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.set_memlimit">[docs]</a><span class="k">def</span> <span class="nf">set_memlimit</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">max_memuse</span>
    <span class="k">global</span> <span class="n">real_max_memuse</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;k&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="n">_1M</span><span class="p">,</span>
        <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">_1G</span><span class="p">,</span>
        <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">*</span><span class="n">_1G</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;(\d+(\.\d+)?) (K|M|G|T)b?$&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
                 <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid memory limit </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>
    <span class="n">memlimit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">sizes</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
    <span class="n">real_max_memuse</span> <span class="o">=</span> <span class="n">memlimit</span>
    <span class="k">if</span> <span class="n">memlimit</span> <span class="o">&gt;</span> <span class="n">MAX_Py_ssize_t</span><span class="p">:</span>
        <span class="n">memlimit</span> <span class="o">=</span> <span class="n">MAX_Py_ssize_t</span>
    <span class="k">if</span> <span class="n">memlimit</span> <span class="o">&lt;</span> <span class="n">_2G</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Memory limit </span><span class="si">%r</span><span class="s"> too low to be useful&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>
    <span class="n">max_memuse</span> <span class="o">=</span> <span class="n">memlimit</span>
</div>
<span class="k">class</span> <span class="nc">_MemoryWatchdog</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An object which periodically watches the process&#39; memory consumption</span>
<span class="sd">    and prints it out.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">procfile</span> <span class="o">=</span> <span class="s">&#39;/proc/{pid}/statm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procfile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;/proc not available for stats: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                          <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">watchdog_script</span> <span class="o">=</span> <span class="n">findfile</span><span class="p">(</span><span class="s">&quot;memory_watchdog.py&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_watchdog</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">watchdog_script</span><span class="p">],</span>
                                             <span class="n">stdin</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem_watchdog</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem_watchdog</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<div class="viewcode-block" id="bigmemtest"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.bigmemtest">[docs]</a><span class="k">def</span> <span class="nf">bigmemtest</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">memuse</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for bigmem tests.</span>

<span class="sd">    &#39;minsize&#39; is the minimum useful size for the test (in arbitrary,</span>
<span class="sd">    test-interpreted units.) &#39;memuse&#39; is the number of &#39;bytes per size&#39; for</span>
<span class="sd">    the test, or a good estimate of it.</span>

<span class="sd">    if &#39;dry_run&#39; is False, it means the test doesn&#39;t support dummy runs</span>
<span class="sd">    when -M is not specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">size</span>
            <span class="n">memuse</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">memuse</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">real_max_memuse</span><span class="p">:</span>
                <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">5147</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxsize</span> <span class="o">=</span> <span class="n">size</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">real_max_memuse</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">real_max_memuse</span> <span class="o">&lt;</span> <span class="n">maxsize</span> <span class="o">*</span> <span class="n">memuse</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
                    <span class="s">&quot;not enough memory: </span><span class="si">%.1f</span><span class="s">G minimum needed&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">memuse</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">real_max_memuse</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot; ... expected peak memory use: {peak:.1f}G&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak</span><span class="o">=</span><span class="n">size</span> <span class="o">*</span> <span class="n">memuse</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
                <span class="n">watchdog</span> <span class="o">=</span> <span class="n">_MemoryWatchdog</span><span class="p">()</span>
                <span class="n">watchdog</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">watchdog</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">watchdog</span><span class="p">:</span>
                    <span class="n">watchdog</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="n">wrapper</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">memuse</span> <span class="o">=</span> <span class="n">memuse</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>
</div>
<div class="viewcode-block" id="bigaddrspacetest"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.bigaddrspacetest">[docs]</a><span class="k">def</span> <span class="nf">bigaddrspacetest</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for tests that fill the address space.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_memuse</span> <span class="o">&lt;</span> <span class="n">MAX_Py_ssize_t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MAX_Py_ssize_t</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">max_memuse</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
                    <span class="s">&quot;not enough memory: try a 32-bit build instead&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
                    <span class="s">&quot;not enough memory: </span><span class="si">%.1f</span><span class="s">G minimum needed&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">MAX_Py_ssize_t</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="c">#=======================================================================</span>
<span class="c"># unittest integration.</span>
</div>
<div class="viewcode-block" id="BasicTestRunner"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.BasicTestRunner">[docs]</a><span class="k">class</span> <span class="nc">BasicTestRunner</span><span class="p">:</span>
<div class="viewcode-block" id="BasicTestRunner.run"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.BasicTestRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestResult</span><span class="p">()</span>
        <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div></div>
<span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">def</span> <span class="nf">requires_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s">&#39;gui&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_gui_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s">&quot;resource {0!r} is not enabled&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource</span><span class="p">))</span>

<div class="viewcode-block" id="cpython_only"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.cpython_only">[docs]</a><span class="k">def</span> <span class="nf">cpython_only</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for tests only applicable on CPython.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">impl_detail</span><span class="p">(</span><span class="n">cpython</span><span class="o">=</span><span class="bp">True</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">impl_detail</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">guards</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">check_impl_detail</span><span class="p">(</span><span class="o">**</span><span class="n">guards</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_id</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">guardnames</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;implementation detail not available on {0}&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;implementation detail specific to {0}&quot;</span>
        <span class="n">guardnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">guardnames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">guardnames</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">):</span>
    <span class="c"># Returns a tuple ({platform_name: run_me}, default_value)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">guards</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">({</span><span class="s">&#39;cpython&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">is_true</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">guards</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">guards</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="n">is_true</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>   <span class="c"># all True or all False</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">guards</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_true</span><span class="p">)</span>

<span class="c"># Use the following check to guard CPython&#39;s implementation-specific tests --</span>
<span class="c"># or to run them only on the implementation(s) guarded by the arguments.</span>
<div class="viewcode-block" id="check_impl_detail"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.check_impl_detail">[docs]</a><span class="k">def</span> <span class="nf">check_impl_detail</span><span class="p">(</span><span class="o">**</span><span class="n">guards</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns True or False depending on the host platform.</span>
<span class="sd">       Examples:</span>
<span class="sd">          if check_impl_detail():               # only on CPython (default)</span>
<span class="sd">          if check_impl_detail(jython=True):    # only on Jython</span>
<span class="sd">          if check_impl_detail(cpython=False):  # everywhere except on CPython</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">guards</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">guards</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">no_tracing</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to temporarily turn off tracing for the duration of a test.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&#39;gettrace&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">original_trace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">original_trace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">refcount_test</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for tests which involve reference counting.</span>

<span class="sd">    To start, the decorator does not run the test if is not run by CPython.</span>
<span class="sd">    After that, any trace function is unset during the test to prevent</span>
<span class="sd">    unexpected refcounts caused by the trace function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">no_tracing</span><span class="p">(</span><span class="n">cpython_only</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_filter_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively filter test cases in a suite based on a predicate.&quot;&quot;&quot;</span>
    <span class="n">newtests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">suite</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
            <span class="n">_filter_suite</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="n">newtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
                <span class="n">newtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">suite</span><span class="o">.</span><span class="n">_tests</span> <span class="o">=</span> <span class="n">newtests</span>

<span class="k">def</span> <span class="nf">_run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run tests from a unittest.TestSuite-derived class.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                         <span class="n">failfast</span><span class="o">=</span><span class="n">failfast</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">BasicTestRunner</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s">&quot;multiple errors occurred&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">err</span> <span class="o">+=</span> <span class="s">&quot;; run in verbose mode for details&quot;</span>
        <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>


<div class="viewcode-block" id="run_unittest"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.run_unittest">[docs]</a><span class="k">def</span> <span class="nf">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">classes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run tests from unittest.TestCase-derived classes.&quot;&quot;&quot;</span>
    <span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">findTestCases</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">cls</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;str arguments must be keys in sys.modules&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">):</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="n">cls</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">case_pred</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">match_tests</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">match_tests</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">_filter_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">case_pred</span><span class="p">)</span>
    <span class="n">_run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>

<span class="c">#=======================================================================</span>
<span class="c"># Check for the presence of docstrings.</span>

<span class="c"># Rather than trying to enumerate all the cases where docstrings may be</span>
<span class="c"># disabled, we just check for that directly</span>
</div>
<span class="k">def</span> <span class="nf">_check_docstrings</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Just used to check if docstrings are enabled&quot;&quot;&quot;</span>

<span class="n">MISSING_C_DOCSTRINGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">check_impl_detail</span><span class="p">()</span> <span class="ow">and</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;win32&#39;</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s">&#39;WITH_DOC_STRINGS&#39;</span><span class="p">))</span>

<span class="n">HAVE_DOCSTRINGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">_check_docstrings</span><span class="o">.</span><span class="n">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                   <span class="ow">not</span> <span class="n">MISSING_C_DOCSTRINGS</span><span class="p">)</span>

<span class="n">requires_docstrings</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">HAVE_DOCSTRINGS</span><span class="p">,</span>
                                          <span class="s">&quot;test requires docstrings&quot;</span><span class="p">)</span>


<span class="c">#=======================================================================</span>
<span class="c"># doctest driver.</span>

<div class="viewcode-block" id="run_doctest"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.run_doctest">[docs]</a><span class="k">def</span> <span class="nf">run_doctest</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run doctest on the given module.  Return (#failures, #tests).</span>

<span class="sd">    If optional argument verbosity is not specified (or is None), pass</span>
<span class="sd">    support&#39;s belief about verbosity on to doctest.  Else doctest&#39;s</span>
<span class="sd">    usual behavior is used (it searches sys.argv for -v).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">optionflags</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> of </span><span class="si">%d</span><span class="s"> doctests failed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;doctest (</span><span class="si">%s</span><span class="s">) ... </span><span class="si">%d</span><span class="s"> tests with zero failures&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span>


<span class="c">#=======================================================================</span>
<span class="c"># Support for saving and restoring the imported modules.</span>
</div>
<span class="k">def</span> <span class="nf">modules_setup</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>

<span class="k">def</span> <span class="nf">modules_cleanup</span><span class="p">(</span><span class="n">oldmodules</span><span class="p">):</span>
    <span class="c"># Encoders/decoders are registered permanently within the internal</span>
    <span class="c"># codec cache. If we destroy the corresponding modules their</span>
    <span class="c"># globals will be set to None which will trip up the cached functions.</span>
    <span class="n">encodings</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                 <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;encodings.&#39;</span><span class="p">)]</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">encodings</span><span class="p">)</span>
    <span class="c"># XXX: This kind of problem can affect more than just encodings. In particular</span>
    <span class="c"># extension modules (such as _ssl) don&#39;t cope with reloading properly.</span>
    <span class="c"># Really, test modules should be cleaning out the test specific modules they</span>
    <span class="c"># know they added (ala test_runpy) rather than relying on this function (as</span>
    <span class="c"># test_importhooks and test_pkg do currently).</span>
    <span class="c"># Implicitly imported *real* modules should be left alone (see issue 10556).</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">oldmodules</span><span class="p">)</span>

<span class="c">#=======================================================================</span>
<span class="c"># Threading support to prevent reporting refleaks when running regrtest.py -R</span>

<span class="c"># NOTE: we use thread._count() rather than threading.enumerate() (or the</span>
<span class="c"># moral equivalent thereof) because a threading.Thread object is still alive</span>
<span class="c"># until its __bootstrap() method has returned, even after it has been</span>
<span class="c"># unregistered from the threading module.</span>
<span class="c"># thread._count(), on the other hand, only gets decremented *after* the</span>
<span class="c"># __bootstrap() method has returned, which gives us reliable reference counts</span>
<span class="c"># at the end of a test run.</span>

<div class="viewcode-block" id="threading_setup"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.threading_setup">[docs]</a><span class="k">def</span> <span class="nf">threading_setup</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">_thread</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="p">()</span>
</div>
<div class="viewcode-block" id="threading_cleanup"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.threading_cleanup">[docs]</a><span class="k">def</span> <span class="nf">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">original_values</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_thread</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">_MAX_COUNT</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_MAX_COUNT</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span>
        <span class="k">if</span> <span class="n">values</span> <span class="o">==</span> <span class="n">original_values</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">gc_collect</span><span class="p">()</span>
    <span class="c"># XXX print a warning in case of failure?</span>
</div>
<span class="k">def</span> <span class="nf">reap_threads</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use this function when threads are being used.  This will</span>
<span class="sd">    ensure that the threads are cleaned up even when the test fails.</span>
<span class="sd">    If threading is unavailable this function does nothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_thread</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">threading_setup</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorator</span>

<div class="viewcode-block" id="reap_children"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.reap_children">[docs]</a><span class="k">def</span> <span class="nf">reap_children</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Use this function at the end of test_main() whenever sub-processes</span>
<span class="sd">    are started.  This will help ensure that no extra children (zombies)</span>
<span class="sd">    stick around to hog resources and create problems when looking</span>
<span class="sd">    for refleaks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Reap all our dead child processes so we don&#39;t leave zombies around.</span>
    <span class="c"># These hog resources and might be causing some of the buildbots to die.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;waitpid&#39;</span><span class="p">):</span>
        <span class="n">any_process</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># This will raise an exception on Windows.  That&#39;s ok.</span>
                <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">any_process</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">break</span>
</div>
<span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="swap_attr"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.swap_attr">[docs]</a><span class="k">def</span> <span class="nf">swap_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Temporary swap out an attribute with a new object.</span>

<span class="sd">    Usage:</span>
<span class="sd">        with swap_attr(obj, &quot;attr&quot;, 5):</span>
<span class="sd">            ...</span>

<span class="sd">        This will set obj.attr to 5 for the duration of the with: block,</span>
<span class="sd">        restoring the old value at the end of the block. If `attr` doesn&#39;t</span>
<span class="sd">        exist on `obj`, it will be created and then deleted at the end of the</span>
<span class="sd">        block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">real_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">real_val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</div>
<span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="swap_item"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.swap_item">[docs]</a><span class="k">def</span> <span class="nf">swap_item</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Temporary swap out an item with a new object.</span>

<span class="sd">    Usage:</span>
<span class="sd">        with swap_item(obj, &quot;item&quot;, 5):</span>
<span class="sd">            ...</span>

<span class="sd">        This will set obj[&quot;item&quot;] to 5 for the duration of the with: block,</span>
<span class="sd">        restoring the old value at the end of the block. If `item` doesn&#39;t</span>
<span class="sd">        exist on `obj`, it will be created and then deleted at the end of the</span>
<span class="sd">        block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
        <span class="n">real_val</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</div>
<span class="k">def</span> <span class="nf">strip_python_stderr</span><span class="p">(</span><span class="n">stderr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Strip the stderr of a Python process from potential debug output</span>
<span class="sd">    emitted by the interpreter.</span>

<span class="sd">    This will typically be run on the result of the communicate() method</span>
<span class="sd">    of a subprocess.Popen object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">br</span><span class="s">&quot;\[\d+ refs, \d+ blocks\]</span><span class="se">\r</span><span class="s">?</span><span class="se">\n</span><span class="s">?&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stderr</span>

<span class="k">def</span> <span class="nf">args_from_interpreter_flags</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a list of command-line arguments reproducing the current</span>
<span class="sd">    settings in sys.flags and sys.warnoptions.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_args_from_interpreter_flags</span><span class="p">()</span>

<span class="c">#============================================================</span>
<span class="c"># Support for assertions about logging.</span>
<span class="c">#============================================================</span>

<div class="viewcode-block" id="TestHandler"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.TestHandler">[docs]</a><span class="k">class</span> <span class="nc">TestHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matcher</span><span class="p">):</span>
        <span class="c"># BufferingHandler takes a &quot;capacity&quot; argument</span>
        <span class="c"># so as to know when to flush. As we&#39;re overriding</span>
        <span class="c"># shouldFlush anyway, we can set a capacity of zero.</span>
        <span class="c"># You can call flush() manually to clear out the</span>
        <span class="c"># buffer.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">matcher</span>

<div class="viewcode-block" id="TestHandler.shouldFlush"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.TestHandler.shouldFlush">[docs]</a>    <span class="k">def</span> <span class="nf">shouldFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="TestHandler.emit"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.TestHandler.emit">[docs]</a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TestHandler.matches"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.TestHandler.matches">[docs]</a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look for a saved dict whose keys/values match the supplied arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span>
</div></div>
<div class="viewcode-block" id="Matcher"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.Matcher">[docs]</a><span class="k">class</span> <span class="nc">Matcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">_partial_matches</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;msg&#39;</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Matcher.matches"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.Matcher.matches">[docs]</a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to match a single dict with the supplied arguments.</span>

<span class="sd">        Keys whose values are strings and which are in self._partial_matches</span>
<span class="sd">        will be checked for partial (i.e. substring) matches. You can extend</span>
<span class="sd">        this scheme to (for example) do regular expression matching, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Matcher.match_value"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.Matcher.match_value">[docs]</a>    <span class="k">def</span> <span class="nf">match_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to match a single stored value (dv) with a supplied value (v).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_matches</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">dv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">result</span>

</div></div>
<span class="n">_can_symlink</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="can_symlink"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.can_symlink">[docs]</a><span class="k">def</span> <span class="nf">can_symlink</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_can_symlink</span>
    <span class="k">if</span> <span class="n">_can_symlink</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_can_symlink</span>
    <span class="n">symlink_path</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s">&quot;can_symlink&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">symlink_path</span><span class="p">)</span>
        <span class="n">can</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="n">can</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symlink_path</span><span class="p">)</span>
    <span class="n">_can_symlink</span> <span class="o">=</span> <span class="n">can</span>
    <span class="k">return</span> <span class="n">can</span>
</div>
<div class="viewcode-block" id="skip_unless_symlink"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.skip_unless_symlink">[docs]</a><span class="k">def</span> <span class="nf">skip_unless_symlink</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip decorator for tests that require functional symlink&quot;&quot;&quot;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">can_symlink</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Requires functional symlink implementation&quot;</span>
    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</div>
<span class="n">_can_xattr</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">def</span> <span class="nf">can_xattr</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_can_xattr</span>
    <span class="k">if</span> <span class="n">_can_xattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_can_xattr</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;setxattr&quot;</span><span class="p">):</span>
        <span class="n">can</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp_fp</span><span class="p">,</span> <span class="n">tmp_name</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># TESTFN &amp; tempfile may use different file systems with</span>
                    <span class="c"># different capabilities</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">tmp_fp</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;user.test&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">b</span><span class="s">&quot;user.test&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="c"># Kernels &lt; 2.6.39 don&#39;t respect setxattr flags.</span>
                    <span class="n">kernel_version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;2.6.(\d{1,2})&quot;</span><span class="p">,</span> <span class="n">kernel_version</span><span class="p">)</span>
                    <span class="n">can</span> <span class="o">=</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">39</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">can</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">unlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span>
            <span class="n">unlink</span><span class="p">(</span><span class="n">tmp_name</span><span class="p">)</span>
    <span class="n">_can_xattr</span> <span class="o">=</span> <span class="n">can</span>
    <span class="k">return</span> <span class="n">can</span>

<div class="viewcode-block" id="skip_unless_xattr"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.skip_unless_xattr">[docs]</a><span class="k">def</span> <span class="nf">skip_unless_xattr</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Skip decorator for tests that require functional extended attributes&quot;&quot;&quot;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">can_xattr</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;no non-broken extended attribute support&quot;</span>
    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="fs_is_case_insensitive"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.fs_is_case_insensitive">[docs]</a><span class="k">def</span> <span class="nf">fs_is_case_insensitive</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Detects if the file system for the specified directory is case-insensitive.&quot;&quot;&quot;</span>
    <span class="n">base_fp</span><span class="p">,</span> <span class="n">base_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">case_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">case_path</span> <span class="o">==</span> <span class="n">base_path</span><span class="p">:</span>
        <span class="n">case_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">case_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SuppressCrashReport"><a class="viewcode-back" href="../../test.support.html#test.datetimetester.SuppressCrashReport">[docs]</a><span class="k">class</span> <span class="nc">SuppressCrashReport</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Try to prevent a crash report from popping up.</span>

<span class="sd">    On Windows, don&#39;t display the Windows Error Reporting dialog.  On UNIX,</span>
<span class="sd">    disable the creation of coredump file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_value</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;On Windows, disable Windows Error Reporting dialogs using</span>
<span class="sd">        SetErrorMode.</span>

<span class="sd">        On UNIX, try to save the previous core file size limit, then set</span>
<span class="sd">        soft limit to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
            <span class="c"># see http://msdn.microsoft.com/en-us/library/windows/desktop/ms680621.aspx</span>
            <span class="c"># GetErrorMode is not available on Windows XP and Windows Server 2003,</span>
            <span class="c"># but SetErrorMode returns the previous value, so we can use that</span>
            <span class="kn">import</span> <span class="nn">ctypes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_k32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>
            <span class="n">SEM_NOGPFAULTERRORBOX</span> <span class="o">=</span> <span class="mh">0x02</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k32</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="n">SEM_NOGPFAULTERRORBOX</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_k32</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">|</span> <span class="n">SEM_NOGPFAULTERRORBOX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">)</span>
                    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span>
                                       <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
                <span class="c"># Check if the &#39;Crash Reporter&#39; on OSX was configured</span>
                <span class="c"># in &#39;Developer&#39; mode and warn that it will get triggered</span>
                <span class="c"># when it is.</span>
                <span class="c">#</span>
                <span class="c"># This assumes that this context manager is used in tests</span>
                <span class="c"># that might trigger the next manager.</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;/usr/bin/defaults&#39;</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span>
                        <span class="s">&#39;com.apple.CrashReporter&#39;</span><span class="p">,</span> <span class="s">&#39;DialogType&#39;</span><span class="p">],</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;developer&#39;</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;this test triggers the Crash Reporter, &quot;</span>
                          <span class="s">&quot;that is intentional&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore Windows ErrorMode or core file behavior to initial value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_k32</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                    <span class="k">pass</span>

</div>
<span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="n">test_instance</span><span class="p">,</span> <span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Override &#39;object_to_patch&#39;.&#39;attr_name&#39; with &#39;new_value&#39;.</span>

<span class="sd">    Also, add a cleanup procedure to &#39;test_instance&#39; to restore</span>
<span class="sd">    &#39;object_to_patch&#39; value for &#39;attr_name&#39;.</span>
<span class="sd">    The &#39;attr_name&#39; should be a valid attribute for &#39;object_to_patch&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># check that &#39;attr_name&#39; is a real attribute for &#39;object_to_patch&#39;</span>
    <span class="c"># will raise AttributeError if it does not exist</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

    <span class="c"># keep a copy of the old value</span>
    <span class="n">attr_is_local</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="n">object_to_patch</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attr_is_local</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># restore the value when the test is done</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">attr_is_local</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

    <span class="n">test_instance</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>

    <span class="c"># actually override the attribute</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_in_subinterp</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run code in a subinterpreter. Raise unittest.SkipTest if the tracemalloc</span>
<span class="sd">    module is enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Issue #10915, #15751: PyGILState_*() functions don&#39;t work with</span>
    <span class="c"># sub-interpreters, the tracemalloc module uses these functions internally</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tracemalloc</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">is_tracing</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s">&quot;run_in_subinterp() cannot be used &quot;</span>
                                     <span class="s">&quot;if tracemalloc module is tracing &quot;</span>
                                     <span class="s">&quot;memory allocations&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">_testcapi</span>
    <span class="k">return</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">run_in_subinterp</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>