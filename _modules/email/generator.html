

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>email.generator &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="email" href="../email.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../email.html">email</a> &raquo;</li>
      
    <li>email.generator</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for email.generator</h1><div class="highlight"><pre>
<span class="c"># Copyright (C) 2001-2010 Python Software Foundation</span>
<span class="c"># Author: Barry Warsaw</span>
<span class="c"># Contact: email-sig@python.org</span>

<span class="sd">&quot;&quot;&quot;Classes to generate plain text from a message object tree.&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Generator&#39;</span><span class="p">,</span> <span class="s">&#39;DecodedGenerator&#39;</span><span class="p">,</span> <span class="s">&#39;BytesGenerator&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">email.utils</span> <span class="kn">import</span> <span class="n">_has_surrogates</span>

<span class="n">UNDERSCORE</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>
<span class="n">NL</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>  <span class="c"># XXX: no longer used by the code below.</span>

<span class="n">fcre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^From &#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>



<div class="viewcode-block" id="Generator"><a class="viewcode-back" href="../../email.html#email.generator.Generator">[docs]</a>
<span class="k">class</span> <span class="nc">Generator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generates output from a Message object tree.</span>

<span class="sd">    This basic generator writes the message to the given file object as plain</span>
<span class="sd">    text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c"># Public interface</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfp</span><span class="p">,</span> <span class="n">mangle_from_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">maxheaderlen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">policy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the generator for message flattening.</span>

<span class="sd">        outfp is the output file-like object for writing the message to.  It</span>
<span class="sd">        must have a write() method.</span>

<span class="sd">        Optional mangle_from_ is a flag that, when True (the default), escapes</span>
<span class="sd">        From_ lines in the body of the message by putting a `&gt;&#39; in front of</span>
<span class="sd">        them.</span>

<span class="sd">        Optional maxheaderlen specifies the longest length for a non-continued</span>
<span class="sd">        header.  When a header line is longer (in characters, with tabs</span>
<span class="sd">        expanded to 8 spaces) than maxheaderlen, the header will split as</span>
<span class="sd">        defined in the Header class.  Set maxheaderlen to zero to disable</span>
<span class="sd">        header wrapping.  The default is 78, as recommended (but not required)</span>
<span class="sd">        by RFC 2822.</span>

<span class="sd">        The policy keyword specifies a policy object that controls a number of</span>
<span class="sd">        aspects of the generator&#39;s operation.  If no policy is specified,</span>
<span class="sd">        the policy associated with the Message object passed to the</span>
<span class="sd">        flatten method is used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">outfp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span> <span class="o">=</span> <span class="n">mangle_from_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxheaderlen</span> <span class="o">=</span> <span class="n">maxheaderlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
<div class="viewcode-block" id="Generator.write"><a class="viewcode-back" href="../../email.html#email.generator.Generator.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="c"># Just delegate to the file object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
<div class="viewcode-block" id="Generator.flatten"><a class="viewcode-back" href="../../email.html#email.generator.Generator.flatten">[docs]</a>
    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">unixfrom</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">linesep</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Print the message object tree rooted at msg to the output file</span>
<span class="sd">        specified when the Generator instance was created.</span>

<span class="sd">        unixfrom is a flag that forces the printing of a Unix From_ delimiter</span>
<span class="sd">        before the first object in the message tree.  If the original message</span>
<span class="sd">        has no From_ delimiter, a `standard&#39; one is crafted.  By default, this</span>
<span class="sd">        is False to inhibit the printing of any From_ delimiter.</span>

<span class="sd">        Note that for subobjects, no From_ line is printed.</span>

<span class="sd">        linesep specifies the characters used to indicate a new line in</span>
<span class="sd">        the output.  The default value is determined by the policy specified</span>
<span class="sd">        when the Generator instance was created or, if none was specified,</span>
<span class="sd">        from the policy associated with the msg.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># We use the _XXX constants for operating on data that comes directly</span>
        <span class="c"># from the msg, and _encoded_XXX constants for operating on data that</span>
        <span class="c"># has already been converted (to bytes in the BytesGenerator) and</span>
        <span class="c"># inserted into a temporary buffer.</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">policy</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span>
        <span class="k">if</span> <span class="n">linesep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">linesep</span><span class="o">=</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxheaderlen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">max_line_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxheaderlen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NL</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">linesep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_NL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_EMPTY</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_EMTPY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c"># Because we use clone (below) when we recursively process message</span>
        <span class="c"># subparts, and because clone uses the computed policy (not None),</span>
        <span class="c"># submessages will automatically get set to the computed policy when</span>
        <span class="c"># they are processed by this code.</span>
        <span class="n">old_gen_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span>
        <span class="n">old_msg_policy</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">policy</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
            <span class="k">if</span> <span class="n">unixfrom</span><span class="p">:</span>
                <span class="n">ufrom</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_unixfrom</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ufrom</span><span class="p">:</span>
                    <span class="n">ufrom</span> <span class="o">=</span> <span class="s">&#39;From nobody &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ufrom</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">old_gen_policy</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">old_msg_policy</span></div>
<div class="viewcode-block" id="Generator.clone"><a class="viewcode-back" href="../../email.html#email.generator.Generator.clone">[docs]</a>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clone this generator with the exact same options.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span><span class="p">,</span>
                              <span class="bp">None</span><span class="p">,</span> <span class="c"># Use policy setting, which we&#39;ve adjusted</span>
                              <span class="n">policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Protected interface - undocumented ;/</span>
    <span class="c">#</span>

    <span class="c"># Note that we use &#39;self.write&#39; when what we are writing is coming from</span>
    <span class="c"># the source, and self._fp.write when what we are writing is coming from a</span>
    <span class="c"># buffer (because the Bytes subclass has already had a chance to transform</span>
    <span class="c"># the data in its write method in that case).  This is an entirely</span>
    <span class="c"># pragmatic split determined by experiment; we could be more general by</span>
    <span class="c"># always using write and having the Bytes subclass write method detect when</span>
    <span class="c"># it has already transformed the input; but, since this whole thing is a</span>
    <span class="c"># hack anyway this seems good enough.</span>

    <span class="c"># Similarly, we have _XXX and _encoded_XXX attributes that are used on</span></div>
    <span class="c"># source and buffer data, respectively.</span>
    <span class="n">_encoded_EMPTY</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_new_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># BytesGenerator overrides this to return BytesIO.</span>
        <span class="k">return</span> <span class="n">StringIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="c"># BytesGenerator overrides this to encode strings to bytes.</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_write_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="c"># We have to transform the line endings.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
        <span class="n">laststripped</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">laststripped</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">laststripped</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># We can&#39;t write the headers yet because of the following scenario:</span>
        <span class="c"># say a multipart message includes the boundary string somewhere in</span>
        <span class="c"># its body.  We&#39;d have to calculate the new boundary /before/ we write</span>
        <span class="c"># the headers so that we can write the correct Content-Type:</span>
        <span class="c"># parameter.</span>
        <span class="c">#</span>
        <span class="c"># The way we do this, so as to make the _handle_*() methods simpler,</span>
        <span class="c"># is to cache any subpart writes into a buffer.  The we write the</span>
        <span class="c"># headers and the buffer contents.  That way, subpart handlers can</span>
        <span class="c"># Do The Right Thing, and can still modify the Content-Type: header if</span>
        <span class="c"># necessary.</span>
        <span class="n">oldfp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_munge_cte</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">sfp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_buffer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">oldfp</span>
            <span class="n">munge_cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_munge_cte</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_munge_cte</span>
        <span class="c"># If we munged the cte, copy the message again and re-fix the CTE.</span>
        <span class="k">if</span> <span class="n">munge_cte</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="s">&#39;content-transfer-encoding&#39;</span><span class="p">,</span> <span class="n">munge_cte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">replace_header</span><span class="p">(</span><span class="s">&#39;content-type&#39;</span><span class="p">,</span> <span class="n">munge_cte</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c"># Write the headers.  First we see if the message object wants to</span>
        <span class="c"># handle that itself.  If not, we&#39;ll do it generically.</span>
        <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&#39;_write_headers&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_headers</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sfp</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># Get the Content-Type: for the message, then try to dispatch to</span>
        <span class="c"># self._handle_&lt;maintype&gt;_&lt;subtype&gt;().  If there&#39;s no handler for the</span>
        <span class="c"># full MIME type, then dispatch to self._handle_&lt;maintype&gt;().  If</span>
        <span class="c"># that&#39;s missing too, then dispatch to self._writeBody().</span>
        <span class="n">main</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_content_subtype</span><span class="p">()</span>
        <span class="n">specific</span> <span class="o">=</span> <span class="n">UNDERSCORE</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">main</span><span class="p">,</span> <span class="n">sub</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_handle_&#39;</span> <span class="o">+</span> <span class="n">specific</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">generic</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_handle_&#39;</span> <span class="o">+</span> <span class="n">generic</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">meth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writeBody</span>
        <span class="n">meth</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Default handlers</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">_write_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">raw_items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">fold</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="c"># A blank line always separates headers from body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Handlers for writing types and subtypes</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">_handle_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;string payload expected: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_has_surrogates</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">_payload</span><span class="p">):</span>
            <span class="n">charset</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&#39;charset&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">charset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># XXX: This copy stuff is an ugly hack to avoid modifying the</span>
                <span class="c"># existing message.</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">msg</span><span class="p">[</span><span class="s">&#39;content-transfer-encoding&#39;</span><span class="p">]</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_munge_cte</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s">&#39;content-transfer-encoding&#39;</span><span class="p">],</span>
                                   <span class="n">msg</span><span class="p">[</span><span class="s">&#39;content-type&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">fcre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&gt;From &#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_lines</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c"># Default body handler</span>
    <span class="n">_writeBody</span> <span class="o">=</span> <span class="n">_handle_text</span>

    <span class="k">def</span> <span class="nf">_handle_multipart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># The trick here is to write out each part separately, merge them all</span>
        <span class="c"># together, and then make sure that the boundary we&#39;ve chosen isn&#39;t</span>
        <span class="c"># present in the payload.</span>
        <span class="n">msgtexts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">subparts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subparts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">subparts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subparts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c"># e.g. a non-strict parse of a message with no starting boundary.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">subparts</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subparts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c"># Scalar payload</span>
            <span class="n">subparts</span> <span class="o">=</span> <span class="p">[</span><span class="n">subparts</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">subparts</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_buffer</span><span class="p">()</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">unixfrom</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">linesep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
            <span class="n">msgtexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="c"># BAW: What about boundaries that are wrapped in double-quotes?</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_boundary</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">boundary</span><span class="p">:</span>
            <span class="c"># Create a boundary that doesn&#39;t appear in any of the</span>
            <span class="c"># message texts.</span>
            <span class="n">alltext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_NL</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgtexts</span><span class="p">)</span>
            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_boundary</span><span class="p">(</span><span class="n">alltext</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">set_boundary</span><span class="p">(</span><span class="n">boundary</span><span class="p">)</span>
        <span class="c"># If there&#39;s a preamble, write it out, with a trailing CRLF</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">preamble</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span><span class="p">:</span>
                <span class="n">preamble</span> <span class="o">=</span> <span class="n">fcre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&gt;From &#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">preamble</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preamble</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">preamble</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_lines</span><span class="p">(</span><span class="n">preamble</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
        <span class="c"># dash-boundary transport-padding CRLF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
        <span class="c"># body-part</span>
        <span class="k">if</span> <span class="n">msgtexts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msgtexts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="c"># *encapsulation</span>
        <span class="c"># --&gt; delimiter transport-padding</span>
        <span class="c"># --&gt; CRLF body-part</span>
        <span class="k">for</span> <span class="n">body_part</span> <span class="ow">in</span> <span class="n">msgtexts</span><span class="p">:</span>
            <span class="c"># delimiter transport-padding CRLF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span> <span class="o">+</span> <span class="s">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
            <span class="c"># body-part</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span>
        <span class="c"># close-delimiter transport-padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span> <span class="o">+</span> <span class="s">&#39;--&#39;</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="s">&#39;--&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">epilogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span><span class="p">:</span>
                <span class="n">epilogue</span> <span class="o">=</span> <span class="n">fcre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&gt;From &#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">epilogue</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epilogue</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">epilogue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_lines</span><span class="p">(</span><span class="n">epilogue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_multipart_signed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># The contents of signed parts has to stay unmodified in order to keep</span>
        <span class="c"># the signature intact per RFC1847 2.1, so we disable header wrapping.</span>
        <span class="c"># RDM: This isn&#39;t enough to completely preserve the part, but it helps.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">max_line_length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_multipart</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_handle_message_delivery_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># We can&#39;t just write the headers directly to self&#39;s file object</span>
        <span class="c"># because this will leave an extra newline between the last header</span>
        <span class="c"># block and the boundary.  Sigh.</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_buffer</span><span class="p">()</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">unixfrom</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">linesep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoded_NL</span><span class="p">)</span>
            <span class="c"># Strip off the unnecessary trailing empty line</span>
            <span class="k">if</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoded_EMPTY</span><span class="p">:</span>
                <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoded_NL</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="c"># Now join all the blocks with an empty line.  This has the lovely</span>
        <span class="c"># effect of separating each block with an empty line, but not adding</span>
        <span class="c"># an extra one after the last one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoded_NL</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_buffer</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c"># The payload of a message/rfc822 part should be a multipart sequence</span>
        <span class="c"># of length 1.  The zeroth element of the list should be the Message</span>
        <span class="c"># object for the subpart.  Extract that object, stringify it, and</span>
        <span class="c"># write it out.</span>
        <span class="c"># Except, it turns out, when it&#39;s a string instead, which happens when</span>
        <span class="c"># and only when HeaderParser is used on a message of mime type</span>
        <span class="c"># message/rfc822.  Such messages are generated by, for example,</span>
        <span class="c"># Groupwise when forwarding unadorned messages.  (Issue 7970.)  So</span>
        <span class="c"># in that case we just emit the string body.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">_payload</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">unixfrom</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">linesep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c"># This used to be a module level function; we use a classmethod for this</span>
    <span class="c"># and _compile_re so we can continue to provide the module level function</span>
    <span class="c"># for backward compatibility by doing</span>
    <span class="c">#   _make_boundary = Generator._make_boundary</span>
    <span class="c"># at the end of the module.  It *is* internal, so we could drop that...</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_boundary</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># Craft a random boundary.  If text is given, ensure that the chosen</span>
        <span class="c"># boundary doesn&#39;t appear in the text.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">_fmt</span> <span class="o">%</span> <span class="n">token</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;==&#39;</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">boundary</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">boundary</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cre</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_compile_re</span><span class="p">(</span><span class="s">&#39;^--&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;(--)?$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cre</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">boundary</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">b</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_compile_re</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BytesGenerator"><a class="viewcode-back" href="../../email.html#email.generator.BytesGenerator">[docs]</a>

<span class="k">class</span> <span class="nc">BytesGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a bytes version of a Message object tree.</span>

<span class="sd">    Functionally identical to the base Generator except that the output is</span>
<span class="sd">    bytes and not string.  When surrogates were used in the input to encode</span>
<span class="sd">    bytes, these are decoded back to bytes for output.  If the policy has</span>
<span class="sd">    cte_type set to 7bit, then the message is transformed such that the</span>
<span class="sd">    non-ASCII bytes are properly content transfer encoded, using the charset</span>
<span class="sd">    unknown-8bit.</span>

<span class="sd">    The outfp object must accept bytes in its write method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Bytes versions of this constant for use in manipulating data from</span>
    <span class="c"># the BytesIO buffer.</span>
<div class="viewcode-block" id="BytesGenerator.write"><a class="viewcode-back" href="../../email.html#email.generator.BytesGenerator.write">[docs]</a>    <span class="n">_encoded_EMPTY</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;surrogateescape&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_new_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># This is almost the same as the string version, except for handling</span>
        <span class="c"># strings with 8bit bytes.</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">raw_items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">fold_binary</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="c"># A blank line always separates headers from body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c"># If the string has surrogates the original source was bytes, so</span>
        <span class="c"># just write it back out.</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">_payload</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">_has_surrogates</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">_payload</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">cte_type</span><span class="o">==</span><span class="s">&#39;7bit&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangle_from_</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">_payload</span> <span class="o">=</span> <span class="n">fcre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;&gt;From &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">_payload</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_lines</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">_payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">BytesGenerator</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_handle_text</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c"># Default body handler</span>
    <span class="n">_writeBody</span> <span class="o">=</span> <span class="n">_handle_text</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_compile_re</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">flags</span><span class="p">)</span>
</div>


<div class="viewcode-block" id="DecodedGenerator"><a class="viewcode-back" href="../../email.html#email.generator.DecodedGenerator">[docs]</a>
<span class="n">_FMT</span> <span class="o">=</span> <span class="s">&#39;[Non-text (</span><span class="si">%(type)s</span><span class="s">) part of message omitted, filename </span><span class="si">%(filename)s</span><span class="s">]&#39;</span>

<span class="k">class</span> <span class="nc">DecodedGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a text representation of a message.</span>

<span class="sd">    Like the Generator base class, except that non-text parts are substituted</span>
<span class="sd">    with a format string representing the part.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfp</span><span class="p">,</span> <span class="n">mangle_from_</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">maxheaderlen</span><span class="o">=</span><span class="mi">78</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like Generator.__init__() except that an additional optional</span>
<span class="sd">        argument is allowed.</span>

<span class="sd">        Walks through all subparts of a message.  If the subpart is of main</span>
<span class="sd">        type `text&#39;, then it prints the decoded payload of the subpart.</span>

<span class="sd">        Otherwise, fmt is a format string that is used instead of the message</span>
<span class="sd">        payload.  fmt is expanded with the following keywords (in</span>
<span class="sd">        %(keyword)s format):</span>

<span class="sd">        type       : Full MIME type of the non-text part</span>
<span class="sd">        maintype   : Main MIME type of the non-text part</span>
<span class="sd">        subtype    : Sub-MIME type of the non-text part</span>
<span class="sd">        filename   : Filename of the non-text part</span>
<span class="sd">        description: Description associated with the non-text part</span>
<span class="sd">        encoding   : Content transfer encoding of the non-text part</span>

<span class="sd">        The default value for fmt is None, meaning</span>

<span class="sd">        [Non-text (%(type)s) part of message omitted, filename %(filename)s]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Generator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfp</span><span class="p">,</span> <span class="n">mangle_from_</span><span class="p">,</span> <span class="n">maxheaderlen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">=</span> <span class="n">_FMT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">=</span> <span class="n">fmt</span>

    <span class="k">def</span> <span class="nf">_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
            <span class="n">maintype</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maintype</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">maintype</span> <span class="o">==</span> <span class="s">&#39;multipart&#39;</span><span class="p">:</span>
                <span class="c"># Just skip this</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s">&#39;type&#39;</span>       <span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span>
                    <span class="s">&#39;maintype&#39;</span>   <span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">(),</span>
                    <span class="s">&#39;subtype&#39;</span>    <span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_subtype</span><span class="p">(),</span>
                    <span class="s">&#39;filename&#39;</span>   <span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s">&#39;[no filename]&#39;</span><span class="p">),</span>
                    <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Content-Description&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;[no description]&#39;</span><span class="p">),</span>
                    <span class="s">&#39;encoding&#39;</span>   <span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Content-Transfer-Encoding&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;[no encoding]&#39;</span><span class="p">),</span>
                    <span class="p">},</span> <span class="nb">file</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</div>



<span class="c"># Helper used by Generator._make_boundary</span>
<span class="n">_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">_fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%%</span><span class="s">0</span><span class="si">%d</span><span class="s">d&#39;</span> <span class="o">%</span> <span class="n">_width</span>

<span class="c"># Backward compatibility</span>
<span class="n">_make_boundary</span> <span class="o">=</span> <span class="n">Generator</span><span class="o">.</span><span class="n">_make_boundary</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>