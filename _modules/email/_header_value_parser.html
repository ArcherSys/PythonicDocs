

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>email._header_value_parser &mdash; ArcherBashPYDocs 1.0.0. documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ArcherBashPYDocs 1.0.0. documentation" href="../../index.html"/>
        <link rel="up" title="email" href="../email.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> ArcherBashPYDocs</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">ArcherBashPYDocs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../email.html">email</a> &raquo;</li>
      
    <li>email._header_value_parser</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for email._header_value_parser</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Header value parser implementing various email-related RFC parsing rules.</span>

<span class="sd">The parsing methods defined in this module implement various email related</span>
<span class="sd">parsing rules.  Principal among them is RFC 5322, which is the followon</span>
<span class="sd">to RFC 2822 and primarily a clarification of the former.  It also implements</span>
<span class="sd">RFC 2047 encoded word decoding.</span>

<span class="sd">RFC 5322 goes to considerable trouble to maintain backward compatibility with</span>
<span class="sd">RFC 822 in the parse phase, while cleaning up the structure on the generation</span>
<span class="sd">phase.  This parser supports correct RFC 5322 generation by tagging white space</span>
<span class="sd">as folding white space only when folding is allowed in the non-obsolete rule</span>
<span class="sd">sets.  Actually, the parser is even more generous when accepting input than RFC</span>
<span class="sd">5322 mandates, following the spirit of Postel&#39;s Law, which RFC 5322 encourages.</span>
<span class="sd">Where possible deviations from the standard are annotated on the &#39;defects&#39;</span>
<span class="sd">attribute of tokens that deviate.</span>

<span class="sd">The general structure of the parser follows RFC 5322, and uses its terminology</span>
<span class="sd">where there is a direct correspondence.  Where the implementation requires a</span>
<span class="sd">somewhat different structure than that used by the formal grammar, new terms</span>
<span class="sd">that mimic the closest existing terms are used.  Thus, it really helps to have</span>
<span class="sd">a copy of RFC 5322 handy when studying this code.</span>

<span class="sd">Input to the parser is a string that has already been unfolded according to</span>
<span class="sd">RFC 5322 rules.  According to the RFC this unfolding is the very first step, and</span>
<span class="sd">this parser leaves the unfolding step to a higher level message parser, which</span>
<span class="sd">will have already detected the line breaks that need unfolding while</span>
<span class="sd">determining the beginning and end of each header.</span>

<span class="sd">The output of the parser is a TokenList object, which is a list subclass.  A</span>
<span class="sd">TokenList is a recursive data structure.  The terminal nodes of the structure</span>
<span class="sd">are Terminal objects, which are subclasses of str.  These do not correspond</span>
<span class="sd">directly to terminal objects in the formal grammar, but are instead more</span>
<span class="sd">practical higher level combinations of true terminals.</span>

<span class="sd">All TokenList and Terminal objects have a &#39;value&#39; attribute, which produces the</span>
<span class="sd">semantically meaningful value of that part of the parse subtree.  The value of</span>
<span class="sd">all whitespace tokens (no matter how many sub-tokens they may contain) is a</span>
<span class="sd">single space, as per the RFC rules.  This includes &#39;CFWS&#39;, which is herein</span>
<span class="sd">included in the general class of whitespace tokens.  There is one exception to</span>
<span class="sd">the rule that whitespace tokens are collapsed into single spaces in values: in</span>
<span class="sd">the value of a &#39;bare-quoted-string&#39; (a quoted-string with no leading or</span>
<span class="sd">trailing whitespace), any whitespace that appeared between the quotation marks</span>
<span class="sd">is preserved in the returned value.  Note that in all Terminal strings quoted</span>
<span class="sd">pairs are turned into their unquoted values.</span>

<span class="sd">All TokenList and Terminal objects also have a string value, which attempts to</span>
<span class="sd">be a &quot;canonical&quot; representation of the RFC-compliant form of the substring that</span>
<span class="sd">produced the parsed subtree, including minimal use of quoted pair quoting.</span>
<span class="sd">Whitespace runs are not collapsed.</span>

<span class="sd">Comment tokens also have a &#39;content&#39; attribute providing the string found</span>
<span class="sd">between the parens (including any nested comments) with whitespace preserved.</span>

<span class="sd">All TokenList and Terminal objects have a &#39;defects&#39; attribute which is a</span>
<span class="sd">possibly empty list all of the defects found while creating the token.  Defects</span>
<span class="sd">may appear on any token in the tree, and a composite list of all defects in the</span>
<span class="sd">subtree is available through the &#39;all_defects&#39; attribute of any node.  (For</span>
<span class="sd">Terminal notes x.defects == x.all_defects.)</span>

<span class="sd">Each object in a parse tree is called a &#39;token&#39;, and each has a &#39;token_type&#39;</span>
<span class="sd">attribute that gives the name from the RFC 5322 grammar that it represents.</span>
<span class="sd">Not all RFC 5322 nodes are produced, and there is one non-RFC 5322 node that</span>
<span class="sd">may be produced: &#39;ptext&#39;.  A &#39;ptext&#39; is a string of printable ascii characters.</span>
<span class="sd">It is returned in place of lists of (ctext/quoted-pair) and</span>
<span class="sd">(qtext/quoted-pair).</span>

<span class="sd">XXX: provide complete list of token types.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>   <span class="c"># For urllib.parse.unquote</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">hexdigits</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">_encoded_words</span> <span class="k">as</span> <span class="n">_ew</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="c">#</span>
<span class="c"># Useful constants and functions</span>
<span class="c">#</span>

<span class="n">WSP</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">CFWS_LEADER</span> <span class="o">=</span> <span class="n">WSP</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
<span class="n">SPECIALS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s">r&#39;()&lt;&gt;@,:;.\&quot;[]&#39;</span><span class="p">)</span>
<span class="n">ATOM_ENDS</span> <span class="o">=</span> <span class="n">SPECIALS</span> <span class="o">|</span> <span class="n">WSP</span>
<span class="n">DOT_ATOM_ENDS</span> <span class="o">=</span> <span class="n">ATOM_ENDS</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
<span class="c"># &#39;.&#39;, &#39;&quot;&#39;, and &#39;(&#39; do not end phrases in order to support obs-phrase</span>
<span class="n">PHRASE_ENDS</span> <span class="o">=</span> <span class="n">SPECIALS</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;.&quot;(&#39;</span><span class="p">)</span>
<span class="n">TSPECIALS</span> <span class="o">=</span> <span class="p">(</span><span class="n">SPECIALS</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;/?=&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
<span class="n">TOKEN_ENDS</span> <span class="o">=</span> <span class="n">TSPECIALS</span> <span class="o">|</span> <span class="n">WSP</span>
<span class="n">ASPECIALS</span> <span class="o">=</span> <span class="n">TSPECIALS</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="s">&quot;*&#39;%&quot;</span><span class="p">)</span>
<span class="n">ATTRIBUTE_ENDS</span> <span class="o">=</span> <span class="n">ASPECIALS</span> <span class="o">|</span> <span class="n">WSP</span>
<span class="n">EXTENDED_ATTRIBUTE_ENDS</span> <span class="o">=</span> <span class="n">ATTRIBUTE_ENDS</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">quote_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&quot;&#39;</span>

<span class="c">#</span>
<span class="c"># Accumulator for header folding</span>
<span class="c">#</span>

<span class="k">class</span> <span class="nc">_Folded</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstline</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stoken</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_if_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">stoken</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stoken</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stoken</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stickyspace_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">+</span> <span class="n">stickyspace_len</span> <span class="o">+</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">+=</span> <span class="n">stickyspace_len</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">+=</span> <span class="n">l</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstline</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">has_fws</span><span class="p">:</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">pop_leading_fws</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                    <span class="n">stickyspace_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                <span class="n">token</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">stickyspace_len</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
                <span class="n">margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">-</span> <span class="n">l</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="n">stickyspace_len</span><span class="p">:</span>
                    <span class="n">trim</span> <span class="o">=</span> <span class="n">stickyspace_len</span> <span class="o">-</span> <span class="n">margin</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span><span class="p">[:</span><span class="n">trim</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span><span class="p">[</span><span class="n">trim</span><span class="p">:]</span>
                    <span class="n">stickyspace_len</span> <span class="o">=</span> <span class="n">trim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">stickyspace_len</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstline</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstline</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firstline</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">+</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">+=</span> <span class="n">l</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stoken</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="n">l</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c">#</span>
<span class="c"># TokenList and its subclasses</span>
<span class="c">#</span>

<span class="k">class</span> <span class="nc">TokenList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defects</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;{}({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                             <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__repr__</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_defects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">all_defects</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">defects</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Folding API</span>
    <span class="c">#</span>
    <span class="c"># parts():</span>
    <span class="c">#</span>
    <span class="c"># return a list of objects that constitute the &quot;higher level syntactic</span>
    <span class="c"># objects&quot; specified by the RFC as the best places to fold a header line.</span>
    <span class="c"># The returned objects must include leading folding white space, even if</span>
    <span class="c"># this means mutating the underlying parse tree of the object.  Each object</span>
    <span class="c"># is only responsible for returning *its* parts, and should not drill down</span>
    <span class="c"># to any lower level except as required to meet the leading folding white</span>
    <span class="c"># space constraint.</span>
    <span class="c">#</span>
    <span class="c"># _fold(folded):</span>
    <span class="c">#</span>
    <span class="c">#   folded: the result accumulator.  This is an instance of _Folded.</span>
    <span class="c">#       (XXX: I haven&#39;t finished factoring this out yet, the folding code</span>
    <span class="c">#       pretty much uses this as a state object.) When the folded.current</span>
    <span class="c">#       contains as much text as will fit, the _fold method should call</span>
    <span class="c">#       folded.newline.</span>
    <span class="c">#  folded.lastlen: the current length of the test stored in folded.current.</span>
    <span class="c">#  folded.maxlen: The maximum number of characters that may appear on a</span>
    <span class="c">#       folded line.  Differs from the policy setting in that &quot;no limit&quot; is</span>
    <span class="c">#       represented by +inf, which means it can be used in the trivially</span>
    <span class="c">#       logical fashion in comparisons.</span>
    <span class="c">#</span>
    <span class="c"># Currently no subclasses implement parts, and I think this will remain</span>
    <span class="c"># true.  A subclass only needs to implement _fold when the generic version</span>
    <span class="c"># isn&#39;t sufficient.  _fold will need to be implemented primarily when it is</span>
    <span class="c"># possible for encoded words to appear in the specialized token-list, since</span>
    <span class="c"># there is no generic algorithm that can know where exactly the encoded</span>
    <span class="c"># words are allowed.  A _fold implementation is responsible for filling</span>
    <span class="c"># lines in the same general way that the top level _fold does. It may, and</span>
    <span class="c"># should, call the _fold method of sub-objects in a similar fashion to that</span>
    <span class="c"># of the top level _fold.</span>
    <span class="c">#</span>
    <span class="c"># XXX: I&#39;m hoping it will be possible to factor the existing code further</span>
    <span class="c"># to reduce redundancy and make the logic clearer.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
        <span class="n">this</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith_fws</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">this</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">klass</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
                    <span class="n">this</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">end_ws</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">pop_trailing_ws</span><span class="p">()</span>
            <span class="n">this</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_ws</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">klass</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
                <span class="n">this</span> <span class="o">=</span> <span class="p">[</span><span class="n">end_ws</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">this</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">klass</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">startswith_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith_fws</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pop_leading_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;fws&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop_leading_fws</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pop_trailing_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop_trailing_ws</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">has_fws</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">has_leading_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has_leading_comment</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">comments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comments</span>

    <span class="k">def</span> <span class="nf">fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="c"># max_line_length 0/None means no limit, ie: infinitely long.</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">max_line_length</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;+inf&quot;</span><span class="p">)</span>
        <span class="n">folded</span> <span class="o">=</span> <span class="n">_Folded</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>
        <span class="n">folded</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_encoded_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">):</span>
        <span class="c"># This works only for things returned by &#39;parts&#39;, which include</span>
        <span class="c"># the leading fws, if any, that should be used.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_leading_fws</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ws</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
        <span class="n">trailer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;fws&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ew</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">charset</span><span class="p">))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trailer</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cte_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">cte_encode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folded</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">tlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">UndecodableBytesDefect</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">all_defects</span><span class="p">):</span>
                    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;unknown-8bit&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># XXX: this should be a policy setting</span>
                    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
                <span class="n">tstr</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">cte_encode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">folded</span><span class="o">.</span><span class="n">policy</span><span class="p">)</span>
                <span class="n">tlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">folded</span><span class="o">.</span><span class="n">append_if_fits</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c"># Peel off the leading whitespace if any and make it sticky, to</span>
            <span class="c"># avoid infinite recursion.</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">pop_leading_fws</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Peel off the leading whitespace and make it sticky, to</span>
                <span class="c"># avoid infinite recursion.</span>
                <span class="n">folded</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">folded</span><span class="o">.</span><span class="n">append_if_fits</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">has_fws</span><span class="p">:</span>
                <span class="n">part</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c"># There are no fold points in this one; it is too long for a single</span>
            <span class="c"># line and can&#39;t be split...we just have to put it on its own line.</span>
            <span class="n">folded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
            <span class="n">folded</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pp</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">ppstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pp</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="s">&#39;{}{}/{}(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">indent</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&#39;_pp&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;    !! invalid element in token &#39;</span>
                                        <span class="s">&#39;list: {!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">token</span><span class="o">.</span><span class="n">_pp</span><span class="p">(</span><span class="n">indent</span><span class="o">+</span><span class="s">&#39;    &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defects</span><span class="p">:</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s">&#39; Defects: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defects</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">yield</span> <span class="s">&#39;{}){}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WhiteSpaceTokenList</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;comment&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">UnstructuredTokenList</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;unstructured&#39;</span>

    <span class="k">def</span> <span class="nf">_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folded</span><span class="p">):</span>
        <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">is_ew</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">UndecodableBytesDefect</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">all_defects</span><span class="p">):</span>
                    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;unknown-8bit&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
                <span class="k">if</span> <span class="n">last_ew</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># We&#39;ve already done an EW, combine this one with it</span>
                    <span class="c"># if there&#39;s room.</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">get_unstructured</span><span class="p">(</span>
                        <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span><span class="o">+</span><span class="p">[</span><span class="n">tstr</span><span class="p">]))</span><span class="o">.</span><span class="n">as_encoded_word</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
                    <span class="n">oldlastlen</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">[:</span><span class="n">last_ew</span><span class="p">])</span>
                    <span class="n">schunk</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">lchunk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">schunk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">oldlastlen</span> <span class="o">+</span> <span class="n">lchunk</span> <span class="o">&lt;=</span> <span class="n">folded</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span>
                        <span class="n">folded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schunk</span><span class="p">)</span>
                        <span class="n">folded</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="n">oldlastlen</span> <span class="o">+</span> <span class="n">lchunk</span>
                        <span class="k">continue</span>
                <span class="n">tstr</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">as_encoded_word</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
                <span class="n">is_ew</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">folded</span><span class="o">.</span><span class="n">append_if_fits</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_ew</span><span class="p">:</span>
                    <span class="n">last_ew</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">is_ew</span> <span class="ow">or</span> <span class="n">last_ew</span><span class="p">:</span>
                <span class="c"># It&#39;s too big to fit on the line, but since we&#39;ve</span>
                <span class="c"># got encoded words we can use encoded word folding.</span>
                <span class="n">part</span><span class="o">.</span><span class="n">_fold_as_ew</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c"># Peel off the leading whitespace if any and make it sticky, to</span>
            <span class="c"># avoid infinite recursion.</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">pop_leading_fws</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">folded</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">folded</span><span class="o">.</span><span class="n">append_if_fits</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">has_fws</span><span class="p">:</span>
                <span class="n">part</span><span class="o">.</span><span class="n">fold</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c"># It can&#39;t be split...we just have to put it on its own line.</span>
            <span class="n">folded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
            <span class="n">folded</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
            <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">cte_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">spart</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spart</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spart</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_ew</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">cte_encode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>
                    <span class="n">last_ew</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tl</span> <span class="o">=</span> <span class="n">get_unstructured</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">spart</span><span class="p">]))</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">as_encoded_word</span><span class="p">())</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Phrase</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;phrase&#39;</span>

    <span class="k">def</span> <span class="nf">_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folded</span><span class="p">):</span>
        <span class="c"># As with Unstructured, we can have pure ASCII with or without</span>
        <span class="c"># surrogateescape encoded bytes, or we could have unicode.  But this</span>
        <span class="c"># case is more complicated, since we have to deal with the various</span>
        <span class="c"># sub-token types and how they can be composed in the face of</span>
        <span class="c"># unicode-that-needs-CTE-encoding, and the fact that if a token a</span>
        <span class="c"># comment that becomes a barrier across which we can&#39;t compose encoded</span>
        <span class="c"># words.</span>
        <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">tlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
            <span class="n">has_ew</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">UndecodableBytesDefect</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">all_defects</span><span class="p">):</span>
                    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;unknown-8bit&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
                <span class="k">if</span> <span class="n">last_ew</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">part</span><span class="o">.</span><span class="n">has_leading_comment</span><span class="p">():</span>
                    <span class="c"># We&#39;ve already done an EW, let&#39;s see if we can combine</span>
                    <span class="c"># this one with it.  The last_ew logic ensures that all we</span>
                    <span class="c"># have at this point is atoms, no comments or quoted</span>
                    <span class="c"># strings.  So we can treat the text between the last</span>
                    <span class="c"># encoded word and the content of this token as</span>
                    <span class="c"># unstructured text, and things will work correctly.  But</span>
                    <span class="c"># we have to strip off any trailing comment on this token</span>
                    <span class="c"># first, and if it is a quoted string we have to pull out</span>
                    <span class="c"># the content (we&#39;re encoding it, so it no longer needs to</span>
                    <span class="c"># be quoted).</span>
                    <span class="k">if</span> <span class="n">part</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span> <span class="ow">and</span> <span class="n">part</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                        <span class="n">remainder</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remainder</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                            <span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnstructuredTokenList</span><span class="p">(</span><span class="n">token</span><span class="p">[:])</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">get_unstructured</span><span class="p">(</span>
                        <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span><span class="o">+</span><span class="p">[</span><span class="n">tstr</span><span class="p">]))</span><span class="o">.</span><span class="n">as_encoded_word</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
                    <span class="n">schunk</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">lchunk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">schunk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_ew</span> <span class="o">+</span> <span class="n">lchunk</span> <span class="o">&lt;=</span> <span class="n">folded</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span>
                        <span class="n">folded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schunk</span><span class="p">)</span>
                        <span class="n">folded</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="n">tstr</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">as_encoded_word</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
                <span class="n">tlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
                <span class="n">has_ew</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">folded</span><span class="o">.</span><span class="n">append_if_fits</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">has_ew</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">part</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                    <span class="n">last_ew</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">part</span><span class="o">.</span><span class="n">comments</span> <span class="ow">or</span> <span class="n">part</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;quoted-string&#39;</span><span class="p">:</span>
                    <span class="c"># If a comment is involved we can&#39;t combine EWs.  And if a</span>
                    <span class="c"># quoted string is involved, it&#39;s not worth the effort to</span>
                    <span class="c"># try to combine them.</span>
                    <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">continue</span>
            <span class="n">part</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cte_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">is_ew</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">spart</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spart</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spart</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="n">is_ew</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">last_ew</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                        <span class="n">last_ew</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">cte_encode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">))</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">part</span><span class="o">.</span><span class="n">has_leading_comment</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">part</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span> <span class="ow">and</span> <span class="n">part</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                        <span class="n">remainder</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remainder</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                            <span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">UnstructuredTokenList</span><span class="p">(</span><span class="n">token</span><span class="p">[:])</span>
                    <span class="n">tl</span> <span class="o">=</span> <span class="n">get_unstructured</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">spart</span><span class="p">]))</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">last_ew</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">as_encoded_word</span><span class="p">(</span><span class="n">charset</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">comments</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_ew</span> <span class="ow">and</span> <span class="n">part</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;quoted-string&#39;</span><span class="p">):</span>
                <span class="n">last_ew</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Word</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;word&#39;</span>


<span class="k">class</span> <span class="nc">CFWSList</span><span class="p">(</span><span class="n">WhiteSpaceTokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;cfws&#39;</span>

    <span class="k">def</span> <span class="nf">has_leading_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Atom</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;atom&#39;</span>


<span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;token&#39;</span>


<span class="k">class</span> <span class="nc">EncodedWord</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;encoded-word&#39;</span>
    <span class="n">cte</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span>
        <span class="n">_ew</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">QuotedString</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;quoted-string&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quoted_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stripped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span>


<span class="k">class</span> <span class="nc">BareQuotedString</span><span class="p">(</span><span class="n">QuotedString</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;bare-quoted-string&#39;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">quote_string</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">WhiteSpaceTokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;comment&#39;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span>
                            <span class="p">[</span><span class="s">&quot;(&quot;</span><span class="p">],</span>
                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span>
                            <span class="p">[</span><span class="s">&quot;)&quot;</span><span class="p">],</span>
                            <span class="p">],</span> <span class="p">[]))</span>

    <span class="k">def</span> <span class="nf">quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;comment&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                  <span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;\(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                  <span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="s">&#39;\)&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">AddressList</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;address-list&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;address&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">mailboxes</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;address&#39;</span><span class="p">),</span> <span class="p">[])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">all_mailboxes</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;address&#39;</span><span class="p">),</span> <span class="p">[])</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;address&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;group&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;mailbox&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;invalid-mailbox&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mailboxes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;mailbox&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;invalid-mailbox&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all_mailboxes</span>

<span class="k">class</span> <span class="nc">MailboxList</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;mailbox-list&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;mailbox&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;mailbox&#39;</span><span class="p">,</span> <span class="s">&#39;invalid-mailbox&#39;</span><span class="p">)]</span>


<span class="k">class</span> <span class="nc">GroupList</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;group-list&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;mailbox-list&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mailboxes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;mailbox-list&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all_mailboxes</span>


<span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&quot;group&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;group-list&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mailboxes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_mailboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;group-list&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">all_mailboxes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>


<span class="k">class</span> <span class="nc">NameAddr</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;name-addr&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">local_part</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">route</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addr_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addr_spec</span>


<span class="k">class</span> <span class="nc">AngleAddr</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;angle-addr&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;addr-spec&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">local_part</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;addr-spec&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;obs-route&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">domains</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addr_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;addr-spec&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">addr_spec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&lt;&gt;&#39;</span>


<span class="k">class</span> <span class="nc">ObsRoute</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;obs-route&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">domain</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;domain&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Mailbox</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;mailbox&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;name-addr&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">local_part</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;name-addr&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">route</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addr_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr_spec</span>


<span class="k">class</span> <span class="nc">InvalidMailbox</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-mailbox&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">local_part</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">route</span> <span class="o">=</span> <span class="n">addr_spec</span> <span class="o">=</span> <span class="n">display_name</span>


<span class="k">class</span> <span class="nc">Domain</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;domain&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">DotAtom</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;dot-atom&#39;</span>


<span class="k">class</span> <span class="nc">DotAtomText</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;dot-atom-text&#39;</span>


<span class="k">class</span> <span class="nc">AddrSpec</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;addr-spec&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">local_part</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addr_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nameset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_part</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nameset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nameset</span><span class="o">-</span><span class="n">DOT_ATOM_ENDS</span><span class="p">):</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="n">quote_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_part</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_part</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lp</span> <span class="o">+</span> <span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
        <span class="k">return</span> <span class="n">lp</span>


<span class="k">class</span> <span class="nc">ObsLocalPart</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;obs-local-part&#39;</span>


<span class="k">class</span> <span class="nc">DisplayName</span><span class="p">(</span><span class="n">Phrase</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;display-name&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">TokenList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenList</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenList</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defects</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;quoted-string&#39;</span><span class="p">:</span>
                    <span class="n">quote</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="n">post</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;cfws&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;cfws&#39;</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;cfws&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;cfws&#39;</span><span class="p">:</span>
                <span class="n">post</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
            <span class="k">return</span> <span class="n">pre</span><span class="o">+</span><span class="n">quote_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span><span class="o">+</span><span class="n">post</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>


<span class="k">class</span> <span class="nc">LocalPart</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;local-part&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&quot;quoted-string&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">quoted_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Strip whitespace from front, back, and around dots.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">DOT</span><span class="p">]</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">DOT</span>
        <span class="n">last_is_tl</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">DOT</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">last_is_tl</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;dot&#39;</span> <span class="ow">and</span>
                    <span class="n">last</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TokenList</span><span class="p">(</span><span class="n">last</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">is_tl</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">TokenList</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">is_tl</span> <span class="ow">and</span> <span class="n">last</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;dot&#39;</span> <span class="ow">and</span>
                    <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenList</span><span class="p">(</span><span class="n">tok</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">last_is_tl</span> <span class="o">=</span> <span class="n">is_tl</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">TokenList</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span>


<span class="k">class</span> <span class="nc">DomainLiteral</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;domain-literal&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;ptext&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>


<span class="k">class</span> <span class="nc">MIMEVersion</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;mime-version&#39;</span>
    <span class="n">major</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">minor</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;parameter&#39;</span>
    <span class="n">sectioned</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">extended</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;us-ascii&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">section_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Because the first token, the attribute (name) eats CFWS, the second</span>
        <span class="c"># token is always the section if there is one.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">number</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sectioned</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This is part of the &quot;handle quoted extended parameters&quot; hack.</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;value&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">stripped_value</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;quoted-string&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;value&#39;</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">stripped_value</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>


<span class="k">class</span> <span class="nc">InvalidParameter</span><span class="p">(</span><span class="n">Parameter</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-parameter&#39;</span>


<span class="k">class</span> <span class="nc">Attribute</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;attribute&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stripped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;attrtext&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span> <span class="nc">Section</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;section&#39;</span>
    <span class="n">number</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">Value</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;value&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stripped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;quoted-string&#39;</span><span class="p">,</span> <span class="s">&#39;attribute&#39;</span><span class="p">,</span> <span class="s">&#39;extended-attribute&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">stripped_value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="k">class</span> <span class="nc">MimeParameters</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;mime-parameters&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># The RFC specifically states that the ordering of parameters is not</span>
        <span class="c"># guaranteed and may be reordered by the transport layer.  So we have</span>
        <span class="c"># to assume the RFC 2231 pieces can come in any order.  However, we</span>
        <span class="c"># output them in the order that we first see a given name, which gives</span>
        <span class="c"># us a stable __str__.</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;parameter&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;attribute&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="o">.</span><span class="n">section_number</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
            <span class="c"># XXX: there might be more recovery we could do here if, for</span>
            <span class="c"># example, this is really a case of a duplicate attribute name.</span>
            <span class="n">value_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">charset</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">charset</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">section_number</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">section_number</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                        <span class="s">&quot;inconsistent multipart parameter numbering&quot;</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">param_value</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">extended</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote_to_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                        <span class="c"># source had surrogate escaped bytes.  What we do now</span>
                        <span class="c"># is a bit of an open question.  I&#39;m not sure this is</span>
                        <span class="c"># the best choice, but it is what the old algorithm did</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;latin-1&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                            <span class="c"># XXX: there should really be a custom defect for</span>
                            <span class="c"># unknown character set to make it easy to find,</span>
                            <span class="c"># because otherwise unknown charset is a silent</span>
                            <span class="c"># failure.</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">,</span> <span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">_has_surrogates</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                            <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">UndecodableBytesDefect</span><span class="p">())</span>
                <span class="n">value_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value_parts</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;{}={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">quote_string</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">params</span> <span class="k">if</span> <span class="n">params</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>


<span class="k">class</span> <span class="nc">ParameterizedHeaderValue</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;mime-parameters&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;mime-parameters&#39;</span><span class="p">:</span>
            <span class="c"># We don&#39;t want to start a new line if all of the params don&#39;t fit</span>
            <span class="c"># after the value, so unwrap the parameter list.</span>
            <span class="k">return</span> <span class="n">TokenList</span><span class="p">(</span><span class="bp">self</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">TokenList</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span>


<span class="k">class</span> <span class="nc">ContentType</span><span class="p">(</span><span class="n">ParameterizedHeaderValue</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;content-type&#39;</span>
    <span class="n">maintype</span> <span class="o">=</span> <span class="s">&#39;text&#39;</span>
    <span class="n">subtype</span> <span class="o">=</span> <span class="s">&#39;plain&#39;</span>


<span class="k">class</span> <span class="nc">ContentDisposition</span><span class="p">(</span><span class="n">ParameterizedHeaderValue</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;content-disposition&#39;</span>
    <span class="n">content_disposition</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">ContentTransferEncoding</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;content-transfer-encoding&#39;</span>
    <span class="n">cte</span> <span class="o">=</span> <span class="s">&#39;7bit&#39;</span>


<span class="k">class</span> <span class="nc">HeaderLabel</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;header-label&#39;</span>


<span class="k">class</span> <span class="nc">Header</span><span class="p">(</span><span class="n">TokenList</span><span class="p">):</span>

    <span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;header&#39;</span>

    <span class="k">def</span> <span class="nf">_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folded</span><span class="p">):</span>
        <span class="n">folded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">folded</span><span class="o">.</span><span class="n">lastlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">folded</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c"># The first line of the header is different from all others: we don&#39;t</span>
        <span class="c"># want to start a new object on a new line if it has any fold points in</span>
        <span class="c"># it that would allow part of it to be on the first header line.</span>
        <span class="c"># Further, if the first fold point would fit on the new line, we want</span>
        <span class="c"># to do that, but if it doesn&#39;t we want to put it on the first line.</span>
        <span class="c"># Folded supports this via the stickyspace attribute.  If this</span>
        <span class="c"># attribute is not None, it does the special handling.</span>
        <span class="n">folded</span><span class="o">.</span><span class="n">stickyspace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;cfws&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Malformed Header token list&quot;</span><span class="p">)</span>
        <span class="n">rest</span><span class="o">.</span><span class="n">_fold</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>


<span class="c">#</span>
<span class="c"># Terminal classes and instances</span>
<span class="c">#</span>

<span class="k">class</span> <span class="nc">Terminal</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">token_type</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="n">token_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;{}({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__repr__</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_defects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defects</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&quot;{}{}/{}({}){}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">indent</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_type</span><span class="p">,</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__repr__</span><span class="p">(),</span>
            <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">defects</span> <span class="k">else</span> <span class="s">&#39; {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defects</span><span class="p">),</span>
            <span class="p">)]</span>

    <span class="k">def</span> <span class="nf">cte_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;us-ascii&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_ew</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop_trailing_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This terminates the recursion.</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">pop_leading_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># This terminates the recursion.</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">has_leading_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__getnewargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_type</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WhiteSpaceTerminal</span><span class="p">(</span><span class="n">Terminal</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span>

    <span class="k">def</span> <span class="nf">startswith_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="n">has_fws</span> <span class="o">=</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">ValueTerminal</span><span class="p">(</span><span class="n">Terminal</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">startswith_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">has_fws</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">as_encoded_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ew</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">charset</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EWWhiteSpaceTerminal</span><span class="p">(</span><span class="n">WhiteSpaceTerminal</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="n">has_fws</span> <span class="o">=</span> <span class="bp">True</span>


<span class="c"># XXX these need to become classes and used as instances so</span>
<span class="c"># that a program can&#39;t change them in a parse tree and screw</span>
<span class="c"># up other parse trees.  Maybe should have  tests for that, too.</span>
<span class="n">DOT</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;dot&#39;</span><span class="p">)</span>
<span class="n">ListSeparator</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;list-separator&#39;</span><span class="p">)</span>
<span class="n">RouteComponentMarker</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span> <span class="s">&#39;route-component-marker&#39;</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Parser</span>
<span class="c">#</span>

<span class="c"># Parse strings according to RFC822/2047/2822/5322 rules.</span>
<span class="c">#</span>
<span class="c"># This is a stateless parser.  Each get_XXX function accepts a string and</span>
<span class="c"># returns either a Terminal or a TokenList representing the RFC object named</span>
<span class="c"># by the method and a string containing the remaining unparsed characters</span>
<span class="c"># from the input.  Thus a parser method consumes the next syntactic construct</span>
<span class="c"># of a given type and returns a token representing the construct plus the</span>
<span class="c"># unparsed remainder of the input string.</span>
<span class="c">#</span>
<span class="c"># For example, if the first element of a structured header is a &#39;phrase&#39;,</span>
<span class="c"># then:</span>
<span class="c">#</span>
<span class="c">#     phrase, value = get_phrase(value)</span>
<span class="c">#</span>
<span class="c"># returns the complete phrase from the start of the string value, plus any</span>
<span class="c"># characters left in the string after the phrase is removed.</span>

<span class="n">_wsp_splitter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;([{}]+)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WSP</span><span class="p">)))</span><span class="o">.</span><span class="n">split</span>
<span class="n">_non_atom_end_matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[^{}]+&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ATOM_ENDS</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;\]&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">match</span>
<span class="n">_non_printable_finder</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[\x00-\x20\x7F]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span>
<span class="n">_non_token_end_matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[^{}]+&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TOKEN_ENDS</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;\]&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">match</span>
<span class="n">_non_attribute_end_matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[^{}]+&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ATTRIBUTE_ENDS</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;\]&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">match</span>
<span class="n">_non_extended_attribute_end_matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[^{}]+&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">EXTENDED_ATTRIBUTE_ENDS</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                    <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;\]&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">match</span>

<span class="k">def</span> <span class="nf">_validate_xtext</span><span class="p">(</span><span class="n">xtext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If input token contains ASCII non-printables, register a defect.&quot;&quot;&quot;</span>

    <span class="n">non_printables</span> <span class="o">=</span> <span class="n">_non_printable_finder</span><span class="p">(</span><span class="n">xtext</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">non_printables</span><span class="p">:</span>
        <span class="n">xtext</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">NonPrintableDefect</span><span class="p">(</span><span class="n">non_printables</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">_has_surrogates</span><span class="p">(</span><span class="n">xtext</span><span class="p">):</span>
        <span class="n">xtext</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">UndecodableBytesDefect</span><span class="p">(</span>
            <span class="s">&quot;Non-ASCII characters found in header token&quot;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_ptext_to_endchars</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">endchars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scan printables/quoted-pairs until endchars and return unquoted ptext.</span>

<span class="sd">    This function turns a run of qcontent, ccontent-without-comments, or</span>
<span class="sd">    dtext-with-quoted-printables into a single string by unquoting any</span>
<span class="sd">    quoted printables.  It returns the string, the remaining value, and</span>
<span class="sd">    a flag that is True iff there were any quoted printables decoded.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fragment</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">_wsp_splitter</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vchars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">escape</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">had_qp</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fragment</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fragment</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">escape</span><span class="p">:</span>
                <span class="n">escape</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">had_qp</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">escape</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">escape</span><span class="p">:</span>
            <span class="n">escape</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">fragment</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">endchars</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">vchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vchars</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fragment</span><span class="p">[</span><span class="n">pos</span><span class="p">:]]</span> <span class="o">+</span> <span class="n">remainder</span><span class="p">),</span> <span class="n">had_qp</span>

<span class="k">def</span> <span class="nf">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FWS = 1*WSP</span>

<span class="sd">    This isn&#39;t the RFC definition.  We&#39;re using fws to represent tokens where</span>
<span class="sd">    folding can be done, but when we are parsing the *un*folding has already</span>
<span class="sd">    been done so we don&#39;t need to watch out for CRLF.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newvalue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
    <span class="n">fws</span> <span class="o">=</span> <span class="n">WhiteSpaceTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">newvalue</span><span class="p">)],</span> <span class="s">&#39;fws&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fws</span><span class="p">,</span> <span class="n">newvalue</span>

<span class="k">def</span> <span class="nf">get_encoded_word</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; encoded-word = &quot;=?&quot; charset &quot;?&quot; encoding &quot;?&quot; encoded-text &quot;?=&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ew</span> <span class="o">=</span> <span class="n">EncodedWord</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;=?&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected encoded word but found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">tok</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;?=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tok</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected encoded word but found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">remstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">remstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hexdigits</span> <span class="ow">and</span> <span class="n">remstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hexdigits</span><span class="p">:</span>
        <span class="c"># The ? after the CTE was followed by an encoded word escape (=XX).</span>
        <span class="n">rest</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">remstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;?=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">tok</span> <span class="o">+</span> <span class="s">&#39;?=&#39;</span> <span class="o">+</span> <span class="n">rest</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ew</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;whitespace inside encoded word&quot;</span><span class="p">))</span>
    <span class="n">ew</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">defects</span> <span class="o">=</span> <span class="n">_ew</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;=?&#39;</span> <span class="o">+</span> <span class="n">tok</span> <span class="o">+</span> <span class="s">&#39;?=&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;encoded word format invalid: &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ew</span><span class="o">.</span><span class="n">cte</span><span class="p">))</span>
    <span class="n">ew</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span>
    <span class="n">ew</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>
    <span class="n">ew</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">defects</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">ew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">chars</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">_wsp_splitter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">vtext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="s">&#39;vtext&#39;</span><span class="p">)</span>
        <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">vtext</span><span class="p">)</span>
        <span class="n">ew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtext</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ew</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_unstructured</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;unstructured = (*([FWS] vchar) *WSP) / obs-unstruct</span>
<span class="sd">       obs-unstruct = *((*LF *CR *(obs-utext) *LF *CR)) / FWS)</span>
<span class="sd">       obs-utext = %d0 / obs-NO-WS-CTL / LF / CR</span>

<span class="sd">       obs-NO-WS-CTL is control characters except WSP/CR/LF.</span>

<span class="sd">    So, basically, we have printable runs, plus control characters or nulls in</span>
<span class="sd">    the obsolete syntax, separated by whitespace.  Since RFC 2047 uses the</span>
<span class="sd">    obsolete syntax in its specification, but requires whitespace on either</span>
<span class="sd">    side of the encoded words, I can see no reason to need to separate the</span>
<span class="sd">    non-printable-non-whitespace from the printable runs if they occur, so we</span>
<span class="sd">    parse this into xtext tokens separated by WSP tokens.</span>

<span class="sd">    Because an &#39;unstructured&#39; value must by definition constitute the entire</span>
<span class="sd">    value, this &#39;get&#39; routine does not return a remaining value, only the</span>
<span class="sd">    parsed TokenList.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># XXX: but what about bare CR and LF?  They might signal the start or</span>
    <span class="c"># end of an encoded word.  YAGNI for now, since our current parsers</span>
    <span class="c"># will never send us strings with bare CR or LF.</span>

    <span class="n">unstructured</span> <span class="o">=</span> <span class="n">UnstructuredTokenList</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">unstructured</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;=?&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_encoded_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
                <span class="c"># XXX: Need to figure out how to register defects when</span>
                <span class="c"># appropriate here.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">have_ws</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unstructured</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unstructured</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;fws&#39;</span><span class="p">:</span>
                        <span class="n">unstructured</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                            <span class="s">&quot;missing whitespace before encoded word&quot;</span><span class="p">))</span>
                        <span class="n">have_ws</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">have_ws</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">unstructured</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unstructured</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;encoded-word&#39;</span><span class="p">:</span>
                        <span class="n">unstructured</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EWWhiteSpaceTerminal</span><span class="p">(</span>
                            <span class="n">unstructured</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;fws&#39;</span><span class="p">)</span>
                <span class="n">unstructured</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">tok</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">_wsp_splitter</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">vtext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="s">&#39;vtext&#39;</span><span class="p">)</span>
        <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">vtext</span><span class="p">)</span>
        <span class="n">unstructured</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vtext</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unstructured</span>

<span class="k">def</span> <span class="nf">get_qp_ctext</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ctext = &lt;printable ascii except \ ( )&gt;</span>

<span class="sd">    This is not the RFC ctext, since we are handling nested comments in comment</span>
<span class="sd">    and unquoting quoted-pairs here.  We allow anything except the &#39;()&#39;</span>
<span class="sd">    characters, but if we find any ASCII other than the RFC defined printable</span>
<span class="sd">    ASCII an NonPrintableDefect is added to the token&#39;s defects list.  Since</span>
<span class="sd">    quoted pairs are converted to their unquoted values, what is returned is</span>
<span class="sd">    a &#39;ptext&#39; token.  In this case it is a WhiteSpaceTerminal, so it&#39;s value</span>
<span class="sd">    is &#39; &#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ptext</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_ptext_to_endchars</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;()&#39;</span><span class="p">)</span>
    <span class="n">ptext</span> <span class="o">=</span> <span class="n">WhiteSpaceTerminal</span><span class="p">(</span><span class="n">ptext</span><span class="p">,</span> <span class="s">&#39;ptext&#39;</span><span class="p">)</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">ptext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ptext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_qcontent</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;qcontent = qtext / quoted-pair</span>

<span class="sd">    We allow anything except the DQUOTE character, but if we find any ASCII</span>
<span class="sd">    other than the RFC defined printable ASCII an NonPrintableDefect is</span>
<span class="sd">    added to the token&#39;s defects list.  Any quoted pairs are converted to their</span>
<span class="sd">    unquoted values, so what is returned is a &#39;ptext&#39; token.  In this case it</span>
<span class="sd">    is a ValueTerminal.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ptext</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_ptext_to_endchars</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="n">ptext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">ptext</span><span class="p">,</span> <span class="s">&#39;ptext&#39;</span><span class="p">)</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">ptext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ptext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_atext</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;atext = &lt;matches _atext_matcher&gt;</span>

<span class="sd">    We allow any non-ATOM_ENDS in atext, but add an InvalidATextDefect to</span>
<span class="sd">    the token&#39;s defects list if we find non-atext characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_non_atom_end_matcher</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected atext but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">atext</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">atext</span><span class="p">):]</span>
    <span class="n">atext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">atext</span><span class="p">,</span> <span class="s">&#39;atext&#39;</span><span class="p">)</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">atext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_bare_quoted_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;bare-quoted-string = DQUOTE *([FWS] qcontent) [FWS] DQUOTE</span>

<span class="sd">    A quoted-string without the leading or trailing white space.  Its</span>
<span class="sd">    value is the text between the quote marks, with whitespace</span>
<span class="sd">    preserved and quoted pairs decoded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected &#39;</span><span class="se">\&quot;</span><span class="s">&#39; but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">bare_quoted_string</span> <span class="o">=</span> <span class="n">BareQuotedString</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;=?&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_encoded_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">bare_quoted_string</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;encoded word inside quoted string&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_qcontent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_qcontent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">bare_quoted_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">bare_quoted_string</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;end of header inside quoted string&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bare_quoted_string</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">bare_quoted_string</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">get_comment</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;comment = &quot;(&quot; *([FWS] ccontent) [FWS] &quot;)&quot;</span>
<span class="sd">       ccontent = ctext / quoted-pair / comment</span>

<span class="sd">    We handle nested comments here, and quoted-pair in our qp-ctext routine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected &#39;(&#39; but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;)&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_comment</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_qp_ctext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;end of header inside comment&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">comment</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">comment</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CFWS = (1*([FWS] comment) [FWS]) / FWS</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfws</span> <span class="o">=</span> <span class="n">CFWSList</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_comment</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">cfws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cfws</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_quoted_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;quoted-string = [CFWS] &lt;bare-quoted-string&gt; [CFWS]</span>

<span class="sd">    &#39;bare-quoted-string&#39; is an intermediate class defined by this</span>
<span class="sd">    parser and not by the RFC grammar.  It is the quoted string</span>
<span class="sd">    without any attached CFWS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quoted_string</span> <span class="o">=</span> <span class="n">QuotedString</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">quoted_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_bare_quoted_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">quoted_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">quoted_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quoted_string</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_atom</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;atom = [CFWS] 1*atext [CFWS]</span>

<span class="sd">    An atom could be an rfc2047 encoded word.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ATOM_ENDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected atom but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;=?&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_encoded_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="c"># XXX: need to figure out how to register defects when</span>
            <span class="c"># appropriate here.</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_atext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_atext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atom</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_dot_atom_text</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; dot-text = 1*atext *(&quot;.&quot; 1*atext)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dot_atom_text</span> <span class="o">=</span> <span class="n">DotAtomText</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ATOM_ENDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;expected atom at a start of &quot;</span>
            <span class="s">&quot;dot-atom-text but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ATOM_ENDS</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_atext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">dot_atom_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="n">dot_atom_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DOT</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">dot_atom_text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="n">DOT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;expected atom at end of dot-atom-text &quot;</span>
            <span class="s">&quot;but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dot_atom_text</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_dot_atom</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; dot-atom = [CFWS] dot-atom-text [CFWS]</span>

<span class="sd">    Any place we can have a dot atom, we could instead have an rfc2047 encoded</span>
<span class="sd">    word.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dot_atom</span> <span class="o">=</span> <span class="n">DotAtom</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">dot_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;=?&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_encoded_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="c"># XXX: need to figure out how to register defects when</span>
            <span class="c"># appropriate here.</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_dot_atom_text</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_dot_atom_text</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">dot_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">dot_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dot_atom</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_word</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;word = atom / quoted-string</span>

<span class="sd">    Either atom or quoted-string may start with CFWS.  We have to peel off this</span>
<span class="sd">    CFWS first to determine which type of word to parse.  Afterward we splice</span>
<span class="sd">    the leading CFWS, if any, into the parsed sub-token.</span>

<span class="sd">    If neither an atom or a quoted-string is found before the next special, a</span>
<span class="sd">    HeaderParseError is raised.</span>

<span class="sd">    The token returned is either an Atom or a QuotedString, as appropriate.</span>
<span class="sd">    This means the &#39;word&#39; level of the formal grammar is not represented in the</span>
<span class="sd">    parse tree; this is because having that extra layer when manipulating the</span>
<span class="sd">    parse tree is more confusing than it is helpful.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_quoted_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">SPECIALS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected &#39;atom&#39; or &#39;quoted-string&#39; &quot;</span>
                                      <span class="s">&quot;but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_atom</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_phrase</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; phrase = 1*word / obs-phrase</span>
<span class="sd">        obs-phrase = word *(word / &quot;.&quot; / CFWS)</span>

<span class="sd">    This means a phrase can be a sequence of words, periods, and CFWS in any</span>
<span class="sd">    order as long as it starts with at least one word.  If anything other than</span>
<span class="sd">    words is detected, an ObsoleteHeaderDefect is added to the token&#39;s defect</span>
<span class="sd">    list.  We also accept a phrase that starts with CFWS followed by a dot;</span>
<span class="sd">    this is registered as an InvalidHeaderDefect, since it is not supported by</span>
<span class="sd">    even the obsolete grammar.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="n">Phrase</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">phrase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="n">phrase</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;phrase does not start with word&quot;</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="n">phrase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DOT</span><span class="p">)</span>
            <span class="n">phrase</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;period in &#39;phrase&#39;&quot;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
                    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">phrase</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                        <span class="s">&quot;comment found without atom&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">phrase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_local_part</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; local-part = dot-atom / quoted-string / obs-local-part</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_part</span> <span class="o">=</span> <span class="n">LocalPart</span><span class="p">()</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected local-part but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_dot_atom</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">TokenList</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
    <span class="n">local_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">):</span>
        <span class="n">obs_local_part</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_obs_local_part</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_part</span><span class="p">)</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs_local_part</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;invalid-obs-local-part&#39;</span><span class="p">:</span>
            <span class="n">local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;local-part is not dot-atom, quoted-string, or obs-local-part&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;local-part is not a dot-atom (contains CFWS)&quot;</span><span class="p">))</span>
        <span class="n">local_part</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_local_part</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">local_part</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
        <span class="n">local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">NonASCIILocalPartDefect</span><span class="p">(</span>
                <span class="s">&quot;local-part contains non-ASCII characters)&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">local_part</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_obs_local_part</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; obs-local-part = word *(&quot;.&quot; word)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obs_local_part</span> <span class="o">=</span> <span class="n">ObsLocalPart</span><span class="p">()</span>
    <span class="n">last_non_ws_was_dot</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_non_ws_was_dot</span><span class="p">:</span>
                <span class="n">obs_local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;invalid repeated &#39;.&#39;&quot;</span><span class="p">))</span>
            <span class="n">obs_local_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DOT</span><span class="p">)</span>
            <span class="n">last_non_ws_was_dot</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">obs_local_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="s">&#39;misplaced-special&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">obs_local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;&#39;</span><span class="se">\\</span><span class="s">&#39; character outside of quoted-string/ccontent&quot;</span><span class="p">))</span>
            <span class="n">last_non_ws_was_dot</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">obs_local_part</span> <span class="ow">and</span> <span class="n">obs_local_part</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">!=</span> <span class="s">&#39;dot&#39;</span><span class="p">:</span>
            <span class="n">obs_local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;missing &#39;.&#39; between words&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">last_non_ws_was_dot</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">obs_local_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obs_local_part</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;dot&#39;</span> <span class="ow">or</span>
            <span class="n">obs_local_part</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;cfws&#39;</span> <span class="ow">and</span>
            <span class="n">obs_local_part</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;dot&#39;</span><span class="p">):</span>
        <span class="n">obs_local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Invalid leading &#39;.&#39; in local part&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obs_local_part</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;dot&#39;</span> <span class="ow">or</span>
            <span class="n">obs_local_part</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;cfws&#39;</span> <span class="ow">and</span>
            <span class="n">obs_local_part</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span><span class="o">==</span><span class="s">&#39;dot&#39;</span><span class="p">):</span>
        <span class="n">obs_local_part</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Invalid trailing &#39;.&#39; in local part&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">obs_local_part</span><span class="o">.</span><span class="n">defects</span><span class="p">:</span>
        <span class="n">obs_local_part</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-obs-local-part&#39;</span>
    <span class="k">return</span> <span class="n">obs_local_part</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_dtext</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; dtext = &lt;printable ascii except \ [ ]&gt; / obs-dtext</span>
<span class="sd">        obs-dtext = obs-NO-WS-CTL / quoted-pair</span>

<span class="sd">    We allow anything except the excluded characters, but if we find any</span>
<span class="sd">    ASCII other than the RFC defined printable ASCII an NonPrintableDefect is</span>
<span class="sd">    added to the token&#39;s defects list.  Quoted pairs are converted to their</span>
<span class="sd">    unquoted values, so what is returned is a ptext token, in this case a</span>
<span class="sd">    ValueTerminal.  If there were quoted-printables, an ObsoleteHeaderDefect is</span>
<span class="sd">    added to the returned token&#39;s defect list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ptext</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">had_qp</span> <span class="o">=</span> <span class="n">_get_ptext_to_endchars</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;[]&#39;</span><span class="p">)</span>
    <span class="n">ptext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">ptext</span><span class="p">,</span> <span class="s">&#39;ptext&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">had_qp</span><span class="p">:</span>
        <span class="n">ptext</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;quoted printable found in domain-literal&quot;</span><span class="p">))</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">ptext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ptext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_check_for_early_dl_end</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">domain_literal</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
        <span class="s">&quot;end of input inside domain-literal&quot;</span><span class="p">))</span>
    <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span> <span class="s">&#39;domain-literal-end&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">get_domain_literal</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; domain-literal = [CFWS] &quot;[&quot; *([FWS] dtext) [FWS] &quot;]&quot; [CFWS]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">domain_literal</span> <span class="o">=</span> <span class="n">DomainLiteral</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;expected domain-literal&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;expected &#39;[&#39; at start of domain-literal &quot;</span>
                <span class="s">&quot;but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">_check_for_early_dl_end</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">domain_literal</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">domain_literal</span><span class="p">,</span> <span class="n">value</span>
    <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span> <span class="s">&#39;domain-literal-start&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_dtext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_check_for_early_dl_end</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">domain_literal</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">domain_literal</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_check_for_early_dl_end</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">domain_literal</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">domain_literal</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;]&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;expected &#39;]&#39; at end of domain-literal &quot;</span>
                <span class="s">&quot;but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span> <span class="s">&#39;domain-literal-end&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">domain_literal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">domain_literal</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_domain</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; domain = dot-atom / domain-literal / obs-domain</span>
<span class="sd">        obs-domain = atom *(&quot;.&quot; atom))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">Domain</span><span class="p">()</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected domain but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_domain_literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
        <span class="n">domain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">domain</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_dot_atom</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_atom</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
    <span class="n">domain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">domain</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;domain is not a dot-atom (contains CFWS)&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;dot-atom&#39;</span><span class="p">:</span>
            <span class="n">domain</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="n">domain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DOT</span><span class="p">)</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_atom</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">domain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">domain</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_addr_spec</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; addr-spec = local-part &quot;@&quot; domain</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">addr_spec</span> <span class="o">=</span> <span class="n">AddrSpec</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_local_part</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">addr_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
        <span class="n">addr_spec</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;add-spec local part with no domain&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">addr_spec</span><span class="p">,</span> <span class="n">value</span>
    <span class="n">addr_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span> <span class="s">&#39;address-at-symbol&#39;</span><span class="p">))</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">addr_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">addr_spec</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_obs_route</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; obs-route = obs-domain-list &quot;:&quot;</span>
<span class="sd">        obs-domain-list = *(CFWS / &quot;,&quot;) &quot;@&quot; domain *(&quot;,&quot; [CFWS] [&quot;@&quot; domain])</span>

<span class="sd">        Returns an obs-route token with the appropriate sub-tokens (that is,</span>
<span class="sd">        there is no obs-domain-list in the parse tree).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obs_route</span> <span class="o">=</span> <span class="n">ObsRoute</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;,&#39;</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
            <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ListSeparator</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected obs-route domain but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RouteComponentMarker</span><span class="p">)</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;,&#39;</span><span class="p">:</span>
        <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ListSeparator</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RouteComponentMarker</span><span class="p">)</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;end of header while parsing obs-route&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;:&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span> <span class="s">&quot;expected &#39;:&#39; marking end of &quot;</span>
            <span class="s">&quot;obs-route but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">obs_route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="s">&#39;end-of-obs-route-marker&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">obs_route</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">get_angle_addr</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; angle-addr = [CFWS] &quot;&lt;&quot; addr-spec &quot;&gt;&quot; [CFWS] / obs-angle-addr</span>
<span class="sd">        obs-angle-addr = [CFWS] &quot;&lt;&quot; obs-route addr-spec &quot;&gt;&quot; [CFWS]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle_addr</span> <span class="o">=</span> <span class="n">AngleAddr</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected angle-addr but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;angle-addr-start&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c"># Although it is not legal per RFC5322, SMTP uses &#39;&lt;&gt;&#39; in certain</span>
    <span class="c"># circumstances.</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
        <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;angle-addr-end&#39;</span><span class="p">))</span>
        <span class="n">angle_addr</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;null addr-spec in angle-addr&quot;</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">angle_addr</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_addr_spec</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_obs_route</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">angle_addr</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;obsolete route specification in angle-addr&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
                <span class="s">&quot;expected addr-spec or obs-route but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_addr_spec</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">angle_addr</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;missing trailing &#39;&gt;&#39; on angle-addr&quot;</span><span class="p">))</span>
    <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;angle-addr-end&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">angle_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle_addr</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_display_name</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; display-name = phrase</span>

<span class="sd">    Because this is simply a name-rule, we don&#39;t return a display-name</span>
<span class="sd">    token containing a phrase, but rather a display-name token with</span>
<span class="sd">    the content of the phrase.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">DisplayName</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_phrase</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">display_name</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="p">[:])</span>
    <span class="n">display_name</span><span class="o">.</span><span class="n">defects</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">defects</span><span class="p">[:]</span>
    <span class="k">return</span> <span class="n">display_name</span><span class="p">,</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">get_name_addr</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; name-addr = [display-name] angle-addr</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name_addr</span> <span class="o">=</span> <span class="n">NameAddr</span><span class="p">()</span>
    <span class="c"># Both the optional display name and the angle-addr can start with cfws.</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
                <span class="s">&quot;expected name-addr but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">leader</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
                <span class="s">&quot;expected name-addr but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_display_name</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
                <span class="s">&quot;expected name-addr but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
            <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">name_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_angle_addr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
    <span class="n">name_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name_addr</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; mailbox = name-addr / addr-spec</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># The only way to figure out if we are dealing with a name-addr or an</span>
    <span class="c"># addr-spec is to try parsing each one.</span>
    <span class="n">mailbox</span> <span class="o">=</span> <span class="n">Mailbox</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_name_addr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_addr_spec</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
                <span class="s">&quot;expected mailbox but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">all_defects</span><span class="p">):</span>
        <span class="n">mailbox</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-mailbox&#39;</span>
    <span class="n">mailbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">endchars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read everything up to one of the chars in endchars.</span>

<span class="sd">    This is outside the formal grammar.  The InvalidMailbox TokenList that is</span>
<span class="sd">    returned acts like a Mailbox, but the data attributes are None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invalid_mailbox</span> <span class="o">=</span> <span class="n">InvalidMailbox</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">endchars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
            <span class="n">invalid_mailbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="s">&#39;misplaced-special&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_phrase</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">invalid_mailbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">invalid_mailbox</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_mailbox_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; mailbox-list = (mailbox *(&quot;,&quot; mailbox)) / obs-mbox-list</span>
<span class="sd">        obs-mbox-list = *([CFWS] &quot;,&quot;) mailbox *(&quot;,&quot; [mailbox / CFWS])</span>

<span class="sd">    For this routine we go outside the formal grammar in order to improve error</span>
<span class="sd">    handling.  We recognize the end of the mailbox list only at the end of the</span>
<span class="sd">    value or at a &#39;;&#39; (the group terminator).  This is so that we can turn</span>
<span class="sd">    invalid mailboxes into InvalidMailbox tokens and continue parsing any</span>
<span class="sd">    remaining valid mailboxes.  We also allow all mailbox entries to be null,</span>
<span class="sd">    and this condition is handled appropriately at a higher level.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mailbox_list</span> <span class="o">=</span> <span class="n">MailboxList</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">mailbox_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
                <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;,;&#39;</span><span class="p">:</span>
                    <span class="n">mailbox_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
                    <span class="n">mailbox_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                        <span class="s">&quot;empty element in mailbox-list&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;,;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
                    <span class="n">mailbox_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="n">mailbox_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                        <span class="s">&quot;invalid mailbox in mailbox-list&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
                <span class="n">mailbox_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;empty element in mailbox-list&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;,;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
                <span class="n">mailbox_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">mailbox_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;invalid mailbox in mailbox-list&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;,;&#39;</span><span class="p">:</span>
            <span class="c"># Crap after mailbox; treat it as an invalid mailbox.</span>
            <span class="c"># The mailbox info will still be available.</span>
            <span class="n">mailbox</span> <span class="o">=</span> <span class="n">mailbox_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mailbox</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-mailbox&#39;</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;,;&#39;</span><span class="p">)</span>
            <span class="n">mailbox</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">mailbox_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;invalid mailbox in mailbox-list&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
            <span class="n">mailbox_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ListSeparator</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">mailbox_list</span><span class="p">,</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">get_group_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; group-list = mailbox-list / CFWS / obs-group-list</span>
<span class="sd">        obs-group-list = 1*([CFWS] &quot;,&quot;) [CFWS]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group_list</span> <span class="o">=</span> <span class="n">GroupList</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">group_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;end of header before group-list&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="c"># This should never happen in email parsing, since CFWS-only is a</span>
            <span class="c"># legal alternative to group-list in a group, which is the only</span>
            <span class="c"># place group-list appears.</span>
            <span class="n">group_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;end of header in group-list&quot;</span><span class="p">))</span>
            <span class="n">group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
            <span class="n">group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_mailbox_list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">all_mailboxes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
        <span class="n">group_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">group_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;group-list with empty entries&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
    <span class="n">group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">group_list</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_group</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; group = display-name &quot;:&quot; [group-list] &quot;;&quot; [CFWS]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_display_name</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;:&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;expected &#39;:&#39; at end of group &quot;</span>
            <span class="s">&quot;display name but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="s">&#39;group-display-name-terminator&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;group-terminator&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">group</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_group_list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">group</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;end of header in group&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected &#39;;&#39; at end of group but found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;group-terminator&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">group</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; address = mailbox / group</span>

<span class="sd">    Note that counter-intuitively, an address can be either a single address or</span>
<span class="sd">    a list of addresses (a group).  This is why the returned Address object has</span>
<span class="sd">    a &#39;mailboxes&#39; attribute which treats a single address as a list of length</span>
<span class="sd">    one.  When you need to differentiate between to two cases, extract the single</span>
<span class="sd">    element, which is either a mailbox or a group token.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># The formal grammar isn&#39;t very helpful when parsing an address.  mailbox</span>
    <span class="c"># and group, especially when allowing for obsolete forms, start off very</span>
    <span class="c"># similarly.  It is only when you reach one of @, &lt;, or : that you know</span>
    <span class="c"># what you&#39;ve got.  So, we try each one in turn, starting with the more</span>
    <span class="c"># likely of the two.  We could perhaps make this more efficient by looking</span>
    <span class="c"># for a phrase and then branching based on the next character, but that</span>
    <span class="c"># would be a premature optimization.</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_group</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
                <span class="s">&quot;expected address but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">address</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_address_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; address_list = (address *(&quot;,&quot; address)) / obs-addr-list</span>
<span class="sd">        obs-addr-list = *([CFWS] &quot;,&quot;) address *(&quot;,&quot; [address / CFWS])</span>

<span class="sd">    We depart from the formal grammar here by continuing to parse until the end</span>
<span class="sd">    of the input, assuming the input to be entirely composed of an</span>
<span class="sd">    address-list.  This is always true in email parsing, and allows us</span>
<span class="sd">    to skip invalid addresses to parse additional valid ones.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">address_list</span> <span class="o">=</span> <span class="n">AddressList</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
                <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
                    <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
                    <span class="n">address_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                        <span class="s">&quot;address-list entry with no content&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
                    <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Address</span><span class="p">([</span><span class="n">token</span><span class="p">]))</span>
                    <span class="n">address_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                        <span class="s">&quot;invalid address in address-list&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
                <span class="n">address_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">ObsoleteHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;empty element in address-list&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
                <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Address</span><span class="p">([</span><span class="n">token</span><span class="p">]))</span>
                <span class="n">address_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;invalid address in address-list&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
            <span class="c"># Crap after address; treat it as an invalid mailbox.</span>
            <span class="c"># The mailbox info will still be available.</span>
            <span class="n">mailbox</span> <span class="o">=</span> <span class="n">address_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mailbox</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-mailbox&#39;</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_mailbox</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">mailbox</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">address_list</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;invalid address in address-list&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>  <span class="c"># Must be a , at this point.</span>
            <span class="n">address_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;list-separator&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">address_list</span><span class="p">,</span> <span class="n">value</span>

<span class="c">#</span>
<span class="c"># XXX: As I begin to add additional header parsers, I&#39;m realizing we probably</span>
<span class="c"># have two level of parser routines: the get_XXX methods that get a token in</span>
<span class="c"># the grammar, and parse_XXX methods that parse an entire field value.  So</span>
<span class="c"># get_address_list above should really be a parse_ method, as probably should</span>
<span class="c"># be get_unstructured.</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">parse_mime_version</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; mime-version = [CFWS] 1*digit [CFWS] &quot;.&quot; [CFWS] 1*digit [CFWS]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># The [CFWS] is implicit in the RFC 2045 BNF.</span>
    <span class="c"># XXX: This routine is a bit verbose, should factor out a get_int method.</span>
    <span class="n">mime_version</span> <span class="o">=</span> <span class="n">MIMEVersion</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">HeaderMissingRequiredValue</span><span class="p">(</span>
            <span class="s">&quot;Missing MIME version number (eg: 1.0)&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mime_version</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">HeaderMissingRequiredValue</span><span class="p">(</span>
                <span class="s">&quot;Expected MIME version number but found only CFWS&quot;</span><span class="p">))</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;.&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">digits</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">digits</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Expected MIME major version number but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digits</span><span class="p">)))</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="s">&#39;xtext&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="s">&#39;digits&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mime_version</span><span class="o">.</span><span class="n">major</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;Incomplete MIME version; found only major number&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;xtext&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mime_version</span>
    <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;version-separator&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mime_version</span><span class="o">.</span><span class="n">major</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;Incomplete MIME version; found only major number&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mime_version</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">digits</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">digits</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Expected MIME minor version number but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digits</span><span class="p">)))</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="s">&#39;xtext&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">minor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="s">&#39;digits&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Excess non-CFWS text after MIME version&quot;</span><span class="p">))</span>
        <span class="n">mime_version</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;xtext&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mime_version</span>

<span class="k">def</span> <span class="nf">get_invalid_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read everything up to the next &#39;;&#39;.</span>

<span class="sd">    This is outside the formal grammar.  The InvalidParameter TokenList that is</span>
<span class="sd">    returned acts like a Parameter, but the data attributes are None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invalid_parameter</span> <span class="o">=</span> <span class="n">InvalidParameter</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
            <span class="n">invalid_parameter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="s">&#39;misplaced-special&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_phrase</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">invalid_parameter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">invalid_parameter</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_ttext</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ttext = &lt;matches _ttext_matcher&gt;</span>

<span class="sd">    We allow any non-TOKEN_ENDS in ttext, but add defects to the token&#39;s</span>
<span class="sd">    defects list if we find non-ttext characters.  We also register defects for</span>
<span class="sd">    *any* non-printables even though the RFC doesn&#39;t exclude all of them,</span>
<span class="sd">    because we follow the spirit of RFC 5322.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_non_token_end_matcher</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected ttext but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">ttext</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ttext</span><span class="p">):]</span>
    <span class="n">ttext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">ttext</span><span class="p">,</span> <span class="s">&#39;ttext&#39;</span><span class="p">)</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">ttext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ttext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;token = [CFWS] 1*ttext [CFWS]</span>

<span class="sd">    The RFC equivalent of ttext is any US-ASCII chars except space, ctls, or</span>
<span class="sd">    tspecials.  We also exclude tabs even though the RFC doesn&#39;t.</span>

<span class="sd">    The RFC implies the CFWS but is not explicit about it in the BNF.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mtoken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">TOKEN_ENDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected token but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_ttext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">mtoken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mtoken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mtoken</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_attrtext</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;attrtext = 1*(any non-ATTRIBUTE_ENDS character)</span>

<span class="sd">    We allow any non-ATTRIBUTE_ENDS in attrtext, but add defects to the</span>
<span class="sd">    token&#39;s defects list if we find non-attrtext characters.  We also register</span>
<span class="sd">    defects for *any* non-printables even though the RFC doesn&#39;t exclude all of</span>
<span class="sd">    them, because we follow the spirit of RFC 5322.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_non_attribute_end_matcher</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected attrtext but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">attrtext</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">attrtext</span><span class="p">):]</span>
    <span class="n">attrtext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">attrtext</span><span class="p">,</span> <span class="s">&#39;attrtext&#39;</span><span class="p">)</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">attrtext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attrtext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; [CFWS] 1*attrtext [CFWS]</span>

<span class="sd">    This version of the BNF makes the CFWS explicit, and as usual we use a</span>
<span class="sd">    value terminal for the actual run of characters.  The RFC equivalent of</span>
<span class="sd">    attrtext is the token characters, with the subtraction of &#39;*&#39;, &quot;&#39;&quot;, and &#39;%&#39;.</span>
<span class="sd">    We include tab in the excluded set just as we do for token.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ATTRIBUTE_ENDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected token but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_attrtext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_extended_attrtext</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;attrtext = 1*(any non-ATTRIBUTE_ENDS character plus &#39;%&#39;)</span>

<span class="sd">    This is a special parsing routine so that we get a value that</span>
<span class="sd">    includes % escapes as a single string (which we decode as a single</span>
<span class="sd">    string later).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_non_extended_attribute_end_matcher</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected extended attrtext but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">attrtext</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">attrtext</span><span class="p">):]</span>
    <span class="n">attrtext</span> <span class="o">=</span> <span class="n">ValueTerminal</span><span class="p">(</span><span class="n">attrtext</span><span class="p">,</span> <span class="s">&#39;extended-attrtext&#39;</span><span class="p">)</span>
    <span class="n">_validate_xtext</span><span class="p">(</span><span class="n">attrtext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attrtext</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_extended_attribute</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; [CFWS] 1*extended_attrtext [CFWS]</span>

<span class="sd">    This is like the non-extended version except we allow % characters, so that</span>
<span class="sd">    we can pick up an encoded value as a single string.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># XXX: should we have an ExtendedAttribute TokenList?</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">EXTENDED_ATTRIBUTE_ENDS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span>
            <span class="s">&quot;expected token but found &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_extended_attrtext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; &#39;*&#39; digits</span>

<span class="sd">    The formal BNF is more complicated because leading 0s are not allowed.  We</span>
<span class="sd">    check for that and add a defect.  We also assume no CFWS is allowed between</span>
<span class="sd">    the &#39;*&#39; and the digits, though the RFC is not crystal clear on that.</span>
<span class="sd">    The caller should already have dealt with leading CFWS.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">Section</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected section but found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">value</span><span class="p">))</span>
    <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;section-marker&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected section number but &quot;</span>
                                      <span class="s">&quot;found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">digits</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span> <span class="ow">and</span> <span class="n">digits</span> <span class="o">!=</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
        <span class="n">section</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderError</span><span class="p">(</span><span class="s">&quot;section number&quot;</span>
            <span class="s">&quot;has an invalid leading 0&quot;</span><span class="p">))</span>
    <span class="n">section</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="s">&#39;digits&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">section</span><span class="p">,</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; quoted-string / attribute</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Value</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected value but found end of string&quot;</span><span class="p">)</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected value but found &quot;</span>
                                      <span class="s">&quot;only {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">leader</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_quoted_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_extended_attribute</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
    <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">get_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; attribute [section] [&quot;*&quot;] [CFWS] &quot;=&quot; value</span>

<span class="sd">    The CFWS is implied by the RFC but not made explicit in the BNF.  This</span>
<span class="sd">    simplified form of the BNF from the RFC is made to conform with the RFC BNF</span>
<span class="sd">    through some extra checks.  We do it this way because it makes both error</span>
<span class="sd">    recovery and working with the resulting parse tree easier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># It is possible CFWS would also be implicitly allowed between the section</span>
    <span class="c"># and the &#39;extended-attribute&#39; marker (the &#39;*&#39;) , but we&#39;ve never seen that</span>
    <span class="c"># in the wild and we will therefore ignore the possibility.</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span><span class="s">&quot;Parameter contains &quot;</span>
            <span class="s">&quot;name ({}) but no value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_section</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">param</span><span class="o">.</span><span class="n">sectioned</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Incomplete parameter&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;extended-parameter-marker&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">param</span><span class="o">.</span><span class="n">extended</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;=&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Parameter not followed by &#39;=&#39;&quot;</span><span class="p">)</span>
    <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="s">&#39;parameter-separator&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">appendto</span> <span class="o">=</span> <span class="n">param</span>
    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">extended</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="c"># Now for some serious hackery to handle the common invalid case of</span>
        <span class="c"># double quotes around an extended value.  We also accept (with defect)</span>
        <span class="c"># a value marked as encoded that isn&#39;t really.</span>
        <span class="n">qstring</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">get_quoted_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">inner_value</span> <span class="o">=</span> <span class="n">qstring</span><span class="o">.</span><span class="n">stripped_value</span>
        <span class="n">semi_valid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">section_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inner_value</span> <span class="ow">and</span> <span class="n">inner_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">semi_valid</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">get_attrtext</span><span class="p">(</span><span class="n">inner_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rest</span> <span class="ow">and</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
                    <span class="n">semi_valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">get_extended_attrtext</span><span class="p">(</span><span class="n">inner_value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
                    <span class="n">semi_valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">semi_valid</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;Quoted string value for extended parameter is invalid&quot;</span><span class="p">))</span>
            <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qstring</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">qstring</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;bare-quoted-string&#39;</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">appendto</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">break</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">inner_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;Parameter marked as extended but appears to have a &quot;</span>
                <span class="s">&quot;quoted string value that is non-encoded&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">extended</span> <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">section_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remainder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">remainder</span>
            <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span>
        <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Apparent initial-extended-value but attribute &quot;</span>
            <span class="s">&quot;was not marked as extended or was not initial section&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="c"># Assume the charset/lang is missing and the token is the value.</span>
        <span class="n">param</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Missing required charset/lang delimiters&quot;</span><span class="p">))</span>
        <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remainder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;extended-attrtext&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">t</span><span class="o">.</span><span class="n">token_type</span> <span class="o">==</span> <span class="s">&#39;attrtext&#39;</span>
            <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">param</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected RFC2231 char/lang encoding &quot;</span>
                                          <span class="s">&quot;delimiter, but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;RFC2231 delimiter&#39;</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_attrtext</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">param</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">(</span><span class="s">&quot;Expected RFC2231 char/lang encoding &quot;</span>
                                  <span class="s">&quot;delimiter, but found {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;RFC2231 delimiter&#39;</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">remainder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Treat the rest of value as bare quoted string content.</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Value</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">WSP</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_fws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_qcontent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">appendto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remainder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">remainder</span>
    <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">parse_mime_parameters</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; parameter *( &quot;;&quot; parameter )</span>

<span class="sd">    That BNF is meant to indicate this routine should only be called after</span>
<span class="sd">    finding and handling the leading &#39;;&#39;.  There is no corresponding rule in</span>
<span class="sd">    the formal RFC grammar, but it is more convenient for us for the set of</span>
<span class="sd">    parameters to be treated as its own TokenList.</span>

<span class="sd">    This is &#39;parse&#39; routine because it consumes the reminaing value, but it</span>
<span class="sd">    would never be called to parse a full header.  Instead it is called to</span>
<span class="sd">    parse everything after the non-parameter value of a specific MIME header.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mime_parameters</span> <span class="o">=</span> <span class="n">MimeParameters</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">mime_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">leader</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CFWS_LEADER</span><span class="p">:</span>
                <span class="n">leader</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_cfws</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">mime_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">mime_parameters</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mime_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leader</span><span class="p">)</span>
                <span class="n">mime_parameters</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;parameter entry with no content&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">leader</span><span class="p">:</span>
                    <span class="n">token</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">leader</span><span class="p">]</span>
                <span class="n">mime_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">mime_parameters</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                    <span class="s">&quot;invalid parameter {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
            <span class="c"># Junk after the otherwise valid parameter.  Mark it as</span>
            <span class="c"># invalid, but it will have a value.</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">mime_parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">param</span><span class="o">.</span><span class="n">token_type</span> <span class="o">=</span> <span class="s">&#39;invalid-parameter&#39;</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_invalid_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">param</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">mime_parameters</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
                <span class="s">&quot;parameter with invalid trailing text {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="c"># Must be a &#39;;&#39; at this point.</span>
            <span class="n">mime_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;parameter-separator&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">mime_parameters</span>

<span class="k">def</span> <span class="nf">_find_mime_parameters</span><span class="p">(</span><span class="n">tokenlist</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do our best to find the parameters in an invalid MIME header</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
            <span class="n">tokenlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;misplaced-special&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_phrase</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">tokenlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">tokenlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;parameter-separator&#39;</span><span class="p">))</span>
    <span class="n">tokenlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_mime_parameters</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

<span class="k">def</span> <span class="nf">parse_content_type_header</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; maintype &quot;/&quot; subtype *( &quot;;&quot; parameter )</span>

<span class="sd">    The maintype and substype are tokens.  Theoretically they could</span>
<span class="sd">    be checked against the official IANA list + x-token, but we</span>
<span class="sd">    don&#39;t do that.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctype</span> <span class="o">=</span> <span class="n">ContentType</span><span class="p">()</span>
    <span class="n">recover</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">ctype</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">HeaderMissingRequiredValue</span><span class="p">(</span>
            <span class="s">&quot;Missing content type specification&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctype</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="n">ctype</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Expected content maintype but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">_find_mime_parameters</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctype</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="c"># XXX: If we really want to follow the formal grammer we should make</span>
    <span class="c"># mantype and subtype specialized TokenLists here.  Probably not worth it.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">ctype</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Invalid content type&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">_find_mime_parameters</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctype</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">maintype</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;content-type-separator&#39;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="n">ctype</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Expected content subtype but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">_find_mime_parameters</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctype</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ctype</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="n">ctype</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Only parameters are valid after content type, but &quot;</span>
            <span class="s">&quot;found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="c"># The RFC requires that a syntactically invalid content-type be treated</span>
        <span class="c"># as text/plain.  Perhaps we should postel this, but we should probably</span>
        <span class="c"># only do that if we were checking the subtype value against IANA.</span>
        <span class="k">del</span> <span class="n">ctype</span><span class="o">.</span><span class="n">maintype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">.</span><span class="n">subtype</span>
        <span class="n">_find_mime_parameters</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctype</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;parameter-separator&#39;</span><span class="p">))</span>
    <span class="n">ctype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_mime_parameters</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">return</span> <span class="n">ctype</span>

<span class="k">def</span> <span class="nf">parse_content_disposition_header</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; disposition-type *( &quot;;&quot; parameter )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">disp_header</span> <span class="o">=</span> <span class="n">ContentDisposition</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">disp_header</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">HeaderMissingRequiredValue</span><span class="p">(</span>
            <span class="s">&quot;Missing content disposition&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">disp_header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="n">disp_header</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Expected content disposition but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">_find_mime_parameters</span><span class="p">(</span><span class="n">disp_header</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">disp_header</span>
    <span class="n">disp_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">disp_header</span><span class="o">.</span><span class="n">content_disposition</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">disp_header</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;;&#39;</span><span class="p">:</span>
        <span class="n">disp_header</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Only parameters are valid after content disposition, but &quot;</span>
            <span class="s">&quot;found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">_find_mime_parameters</span><span class="p">(</span><span class="n">disp_header</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">disp_header</span>
    <span class="n">disp_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;parameter-separator&#39;</span><span class="p">))</span>
    <span class="n">disp_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_mime_parameters</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="k">return</span> <span class="n">disp_header</span>

<span class="k">def</span> <span class="nf">parse_content_transfer_encoding_header</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; mechanism</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># We should probably validate the values, since the list is fixed.</span>
    <span class="n">cte_header</span> <span class="o">=</span> <span class="n">ContentTransferEncoding</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">cte_header</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">HeaderMissingRequiredValue</span><span class="p">(</span>
            <span class="s">&quot;Missing content transfer encoding&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cte_header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">HeaderParseError</span><span class="p">:</span>
        <span class="n">cte_header</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Expected content transfer encoding but found {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cte_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">cte_header</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cte_header</span>
    <span class="k">while</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">cte_header</span><span class="o">.</span><span class="n">defects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidHeaderDefect</span><span class="p">(</span>
            <span class="s">&quot;Extra text after content transfer encoding&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">PHRASE_ENDS</span><span class="p">:</span>
            <span class="n">cte_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueTerminal</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;misplaced-special&#39;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">get_phrase</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">cte_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cte_header</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Weldon Henson.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0.',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>